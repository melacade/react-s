var version="2022-9-14-17-54",Glodon$1=window.Glodon=window.Glodon||{};Glodon$1.Version=version,function(){function t(t,e){let i=e.split("."),n=t,o=i.length;for(let t=0;t<o;t++)void 0===n[i[t]]&&(n[i[t]]={}),n=n[i[t]];return n}t(Glodon$1,"Web.Lang.Utility.Namespace").ensureNamespace=t}(),function(){let t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Common"),e=function(t){"string"==typeof t&&(t=JSON.parse(res)),this.code=t.code,this.message=t.message};e.prototype={getErrorCode:function(){return this.code},getErrorMessage:function(){return this.message}},t.Error=e}();class Vector3{constructor(t,e,i){this.x=t||0,this.y=e||0,this.z=i||0}clone(){return new this.constructor(this.x,this.y,this.z)}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this}clone(){return new this.constructor(this.x,this.y,this.z)}multiplyScalar(t){return this.x*=t,this.y*=t,this.z*=t,this}min(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this.z=Math.min(this.z,t.z),this}max(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this.z=Math.max(this.z,t.z),this}add(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this}sub(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}distanceTo(t){return Math.sqrt(this.distanceToSquared(t))}addScalar(t){return this.x+=t,this.y+=t,this.z+=t,this}distanceToSquared(t){var e=this.x-t.x,i=this.y-t.y,n=this.z-t.z;return e*e+i*i+n*n}subVectors(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this}}class Box3{constructor(t,e){this.min=t||new Vector3(1/0,1/0,1/0),this.max=e||new Vector3(-1/0,-1/0,-1/0)}getSize(){return new Vector3(this.max.x-this.min.x,this.max.y-this.min.y,this.max.z-this.min.z)}setFromCenterAndSize(t,e){let i=new Vector3(e.x,e.y).multiplyScalar(.5);return this.min.copy(t).sub(i),this.max.copy(t).add(i),this}getCenter(){return new Vector3(this.min.x+this.max.x,this.min.y+this.max.y,this.min.z+this.max.z).multiplyScalar(.5)}intersectsBox(t){return!(t.max.x<this.min.x||t.min.x>this.max.x||t.max.y<this.min.y||t.min.y>this.max.y||t.max.z<this.min.z||t.min.z>this.max.z)}union(t){return this.min.min(t.min),this.max.max(t.max),this}makeEmpty(){return this.min.x=this.min.y=this.min.z=1/0,this.max.x=this.max.y=this.max.z=-1/0,this}expandByPoint(t){return this.min.min(t),this.max.max(t),this}setFromPoints(t){this.makeEmpty();for(var e=0,i=t.length;e<i;e++)this.expandByPoint(t[e]);return this}}!function(){let t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Algorithm");t.MeanShift=class{constructor(t,e){this.points=t,this.searchRangeSquared=e**2,this.EPSILON_SQR=.1,this.clusters=[]}setSearchRange(t){this.searchRangeSquared=t**2}setPoints(t){this.points=t}meanShift(t){let e=t.clone(),i=[];for(;;){let t=this.rangeSearch(e);i=this.connect(i,t);let n=this.mean(t);if(e.distanceToSquared(n)<=this.EPSILON_SQR)break;e=n}return i}mean(t){let e=new Vector3;for(const i of t)e.add(i);return e.multiplyScalar(1/t.length),e}rangeSearch(t){let e=[];for(const i of this.points)t.distanceToSquared(i)<=this.searchRangeSquared&&e.push(i);return e}clustering(t,e){0===this.clusters.length?this.clusteringPrepare():this.clusteringAfter(t,e),this.clusters.forEach((t=>{this.resetPointStatus(t.points)}))}clusteringPrepare(){for(const t of this.points){if(t.stopMoving)continue;const e=this.meanShift(t),i=e.length,n=`${e[0].index}_${i}`;this.mergeClusters({points:e,center:this.mean(e),id:n,parent:null,children:[]})}}clusteringAfter(t,e){this.tmpPoints=this.points,this.points=[];let i=[...this.clusters];if(this.clusters=[],!1!==t){for(let t=0;t<i.length;t++){const n=i[t];let o=[];e||this.resetClusterPoints(n.points),this.points=n.points,this.clusteringZoomIn(n,o),this.clusters.push.apply(this.clusters,o)}this.clusters.forEach((t=>{this.resetPointStatus(t.points)}))}else this.clusteringZoomOut(i,e)}clusteringZoomIn(t,e){for(const i of t.points){if(i.stopMoving)continue;const n=this.meanShift(i),o=n.length,s=`${n[0].index}_${o}`;this.mergeClustersInTarget({points:n,center:this.mean(n),id:s,parent:t.id,children:[]},e)}}clusteringZoomOut(t,e){for(let i=0;i<t.length;i++){const n=t[i];e||this.resetClusterPoints(n.points),n.center=this.mean(n.points),this.updateClusterBbox(n),n.children=[],n.parent=null,n.isMerged=!1}for(let e=0;e<t.length;e++){const i=Object.assign({},t[e]);if(!0===i.isMerged)continue;let n=[i.id];for(let o=e+1;o<t.length;o++){const e=t[o];if(!0===e.isMerged)continue;i.center.distanceToSquared(e.center)<=4*this.searchRangeSquared&&(e.isMerged=!0,i.points=this.connect(i.points,e.points,!0),n.push(e.id))}if(i.isMerged=!0,n.length>1){i.center=this.mean(i.points),this.updateClusterBbox(i);const t=i.points.length,e=`${i.points[0].index}_${t}`;i.id=e,i.children=n}this.clusters.push(i)}this.clusters.forEach((t=>{delete t.isMerged,this.resetPointStatus(t.points)}))}mergeClusters(t){let e=!1;for(const i of this.clusters){const n=t.center.distanceToSquared(i.center)<=4*this.searchRangeSquared,o=i.parent==i.parent;if(n&&o){i.points=this.connect(i.points,t.points,!0),i.center=this.mean(i.points),this.updateClusterBbox(i);const n=i.points.length,o=`${i.points[0].index}_${n}`;i.id=o,i.children=[],e=!0;break}}!1===e&&(this.updateClusterBbox(t),this.clusters.push(t))}mergeClustersInTarget(t,e){let i=!1;for(const n of e){if(t.center.distanceToSquared(n.center)<=4*this.searchRangeSquared){n.points=this.connect(n.points,t.points,!0),n.center=this.mean(n.points),this.updateClusterBbox(n);const e=n.points.length,o=`${n.points[0].index}_${e}`;n.id=o,n.children=[],i=!0;break}}!1===i&&(this.updateClusterBbox(t),e.push(t))}removeNodeFromParents(t,e){let i=e.indexOf(t);i>=0&&e.splice(i,1)}updateClusterBbox(t){let e=(new Box3).setFromPoints(t.points);t.bbox=e}connect(t,e,i){let n=[...t];for(const t of e)t.stopMoving&&!i||n.push(t),t.stopMoving=!0;return n}resetPointStatus(t){for(const e of t)e.stopMoving=!1}resetClusterPoints(t){for(let e=0;e<t.length;e++)for(let i=0;i<this.tmpPoints.length;i++)if(t[e].index===this.tmpPoints[i].index){t[e]=this.tmpPoints[i];break}}}}();class Vector2{constructor(t,e){this.x=t||0,this.y=e||0}clone(){return new this.constructor(this.x,this.y)}copy(t){return this.x=t.x,this.y=t.y,this}multiplyScalar(t){return this.x*=t,this.y*=t,this}normalize(){return this.multiplyScalar(1/this.length())}min(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this}max(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this}add(t){return this.x+=t.x,this.y+=t.y,this}sub(t){return this.x-=t.x,this.y-=t.y,this}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}addScalar(t){return this.x+=t,this.y+=t,this}rotateAround(t,e){var i=Math.cos(e),n=Math.sin(e),o=this.x-t.x,s=this.y-t.y;return this.x=o*i-s*n+t.x,this.y=o*n+s*i+t.y,this}setLength(t){return this.multiplyScalar(t/this.length())}angle(){var t=Math.atan2(this.y,this.x);return t<0&&(t+=2*Math.PI),t}distanceToSquared(t){var e=this.x-t.x,i=this.y-t.y;return e*e+i*i}distanceTo(t){return Math.sqrt(this.distanceToSquared(t))}}class Box2{constructor(t,e){this.min=t||new Vector2(1/0,1/0),this.max=e||new Vector2(-1/0,-1/0)}getSize(){return new Vector2(this.max.x-this.min.x,this.max.y-this.min.y)}setFromCenterAndSize(t,e){let i=new Vector2(e.x,e.y).multiplyScalar(.5);return this.min.copy(t).sub(i),this.max.copy(t).add(i),this}getCenter(){return new Vector2(this.min.x+this.max.x,this.min.y+this.max.y).multiplyScalar(.5)}intersectsBox(t){return!(t.max.x<this.min.x||t.min.x>this.max.x||t.max.y<this.min.y||t.min.y>this.max.y)}union(t){return this.min.min(t.min),this.max.max(t.max),this}expandByPoint(t){return this.min.min(t),this.max.max(t),this}}!function(){let t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Algorithm");class e{constructor(){}}e.toThreeJsBox2=function(t,e=0){let i=[];for(const n of t){let t=Math.min(e,100)/100,o=Math.max(n[1][1]-n[0][1],n[1][0]-n[0][0])*t,s=new Vector2(n[0][0],n[0][1]),r=new Vector2(n[1][0],n[1][1]),a=new Box2(s,r),l=a.getSize();i.push((new Box2).setFromCenterAndSize(a.getCenter(),l.addScalar(2*o)))}let n=0;for(const t of i)t.indices=[n++];return i},e.toDrawingBox2=function(t){let e=[];for(const i of t){let t=[];t.push([i.min.x,i.min.y]),t.push([i.max.x,i.max.y]),e.push(t)}return e},e.merge=function(t,e){let i=t.length;for(let n=0;n<=i;n++){if(n===i){t.push(e);break}let o=t[n];if(o.intersectsBox(e)){o.union(e),o.indices=o.indices.concat(e.indices);break}}},e.mergeBoundingBox=function(t){let i=t,n=[];for(;;){for(let t=0;t<i.length;t++)e.merge(n,i[t]);if(n.length===i.length)break;i=n.slice(0,n.length),n=[]}return n},t.BoundingBoxUtil=e}(),Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.Type").inheritPrototype=function(t,e){var i=function(t){function e(){}return e.prototype=t,new e}(e.prototype);i.constructor=t,t.prototype=i},function(){let t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.HttpRequest"),e=function(t,e){var i=Object.assign({type:"get",cache:!0,headers:{"Content-type":"application/x-www-form-urlencoded"},data:null,async:!0,success:null,failure:null},t);const n=t=>{i.success&&i.success(t.responseText,t.responseXML)},o=t=>{i.failure&&i.failure(t)},s=(t,e)=>{var n;(n=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP")).onreadystatechange=function(){if(4==n.readyState){var i=n.status;if(i>=200&&i<300||304==i||0===i&&"file:"===window.location.protocol){let{responseText:e,responseXML:i}=n;t({responseText:e,responseXML:i})}else e(i)}},n.open(i.type,i.url,i.async);for(let t in i.headers)n.setRequestHeader(t,i.headers[t]);n.send(i.data)};e?CLOUD.Storage.IndexedDBHelper.loadWithStorage("InfoData",i.url,(()=>new Promise(s)),n,o):s(n,o)},i=function(t,e,i){let n={};if(n[t])e&&e();else{let o=document.createElement("script");o.type="text/javascript",o.src=t,document.head.appendChild(o),n[t]=!0,o.readyState?o.onreadystatechange=function(){"loaded"==o.readyState||"complete"==o.readyState?(o.onreadystatechange=null,e&&e()):"uninitialized"==o.readyState&&(o.onreadystatechange=null,i&&i())}:(o.onload=function(){e&&e()},o.onerror=function(){i&&i()})}},n=function(t,e){t.length>1?i(t.shift(),(()=>{n(t,e)})):i(t.shift(),e)};t.ajax=e,t.promiseJSONRequest=function(t,i,n){let o;return o="string"==typeof t?{url:t,status:i}:t,new Promise((function(t,s){e(Object.assign({},o,{success:function(e){try{var n=JSON.parse(e)}catch(i){return t(e)}"success"==n.code||"noCode"==o.status||"bimfaceservice-0000"==n.code?t("noCode"==i?n:n.data):s(`requestError，dataCode:${n.code}, dataMessage:${n.message}`)},failure:t=>{s(t)}}),n)}))},t.getScript=i,t.getScripts=n}(),function(){let t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.FullScreen");t.fullScreen=function(t){if(!t)return!1;t.requestFullscreen?t.requestFullscreen():t.mozRequestFullScreen?t.mozRequestFullScreen():t.webkitRequestFullScreen?t.webkitRequestFullScreen():t.msRequestFullscreen&&t.msRequestFullscreen()},t.exitFullScreen=function(){document.exitFullscreen?document.exitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitCancelFullScreen?document.webkitCancelFullScreen():document.msExitFullscreen&&document.msExitFullscreen()},t.onFullScreenChanged=function(t){var e=function(){t&&t()};document.onfullscreenchange=e,document.onwebkitfullscreenchange=e,document.documentElement.onwebkitfullscreenchange=e,document.onmozfullscreenchange=e,document.onmsfullscreenchange=e},t.isFullScreen=function(){return document.webkitIsFullScreen||!!document.mozFullScreenElement||!!document.msFullScreenElement||!1}}(),function(){let t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.ClientHelper"),e=null;if(t.getIsDesktop)return;var i=function(t,e,i){i=i||"asc";var n=!1;return e?e.indexOf(".")>-1&&(n=!0):e="name",t=t.sort((function(t,o){if(n){var r=s(t,e),a=s(o,e);return"asc"==i?r.localeCompare(a):a.localeCompare(r)}return"asc"==i?t[e].localeCompare(o[e]):o[e].localeCompare(t[e])})),o(t,e,n)};var n=function(t,e){return function(i,n){var o,r;e?(o=s(i,t),r=s(n,t)):(o=i[t],r=n[t]);var a,l,h=1,c=0,d=0,u=String.alphabet;function p(t,e,i){if(i){for(a=e;(i=p(t,a))<76&&i>65;)++a;return+t.slice(e-1,a)}return(i=u&&u.indexOf(t.charAt(e)))>-1?i+76:(i=t.charCodeAt(e)||0)<45||i>127?i:i<46?65:i<48?i-1:i<58?i+18:i<65?i-11:i<91?i+11:i<97?i-37:i<123?i+5:i-63}if((o+="")!=(r+=""))for(;h;)if(l=p(o,c++),h=p(r,d++),l<76&&h<76&&l>66&&h>66&&(l=p(o,c,c),h=p(r,d,c=a),d=a),l!=h)return l<h?-1:1;return 0}},o=function(t,e,i){let n=[],o=[],r=[],a=[];return t.map((function(t,l){var h;h=i?s(t,e):t[e],/^[a-zA-Z]*$/.test(h.slice(0,1))?n.push(t):/^[\u4e00-\u9fa5]*$/.test(h.slice(0,1))?o.push(t):/^\d+(\.\d+)?$/.test(h.slice(0,1))?r.push(t):a.push(t)})),a.concat(r,n,o)},s=function(t,e){var i=e.split("."),n=t;return i.map((function(t,e){n=n[t]})),n};t.getIsDesktop=function(){if("Mobile"===e)return!1;if("Web"===e)return!0;var t=navigator.userAgent,i=/(?:Windows Phone)/.test(t),n=/(?:SymbianOS)/.test(t)||i,o=/(?:Android)/.test(t),s=/(?:Firefox)/.test(t),r=(/(?:Chrome|CriOS)/.test(t),/(?:iPad|PlayBook)/.test(t)||o&&!/(?:Mobile)/.test(t)||s&&/(?:Tablet)/.test(t)),a=/Macintosh/i.test(navigator.userAgent)&&navigator.maxTouchPoints&&navigator.maxTouchPoints>1;return!(/(?:iPhone)/.test(t)&&!r||o||n||r||a)},t.getIsMac=()=>/macintosh|mac os x/i.test(navigator.userAgent),t.getIsChrome=()=>/(?:Chrome|CriOS)/.test(navigator.userAgent),t.setNavigatorType=function(t){e=t},t.getIsIphone=function(){var t=navigator.userAgent;return/(?:iPhone)/.test(t)},t.getIsIE=function(){return!(!window.ActiveXObject&&!("ActiveXObject"in window))},t.formatURL=function(t){var e=function(t){return t.replace("viewToken.json","").replace(/\.\//g,"/").replace(/\/\//g,"/")};if(t.indexOf("://")>-1){var i=t.split("://");t=i[0]+"://"+e(i[1])}else t="//"===t.slice(0,2)?"//"+e(t.slice(2)):"./"!=t.slice(0,2)?e(t):"."+e(t.slice(1));return t},t.sortByName=i,t.sortByRules=function(t,e,i){i=i||"asc";var s=!1;return e?e.indexOf(".")>-1&&(s=!0):e="name",t=t.sort(n(e,s)),o(t,e,s)},t.PointToLineDistance=function(t,e,i,n,o,s){let r,a,l,h,c=0;const d=Math.sqrt((i-t)*(i-t)+(n-e)*(n-e));if(0===d)return[0,{x:i,y:n}];const u=Math.sqrt((o-t)*(o-t)+(s-e)*(s-e));if(0===u)return[0,{x:o,y:s}];const p=Math.sqrt((i-o)*(i-o)+(n-s)*(n-s));if(0===p)return c=d,[c,{x:i,y:n}];if(d<u){if(n===s?r=i<o?0:Math.PI:(h=(o-i)/p,h-1>1e-5&&(h=1),r=Math.acos(h),n>s&&(r=2*Math.PI-r)),h=(t-i)/d,h-1>1e-5&&(h=1),a=Math.acos(h),n>e&&(a=2*Math.PI-a),l=a-r,l<0&&(l=-l),l>Math.PI&&(l=2*Math.PI-l),l>Math.PI/2)return[d,{x:i,y:n}];if(i===o)return[u*Math.sin(l),{x:i,y:e}];if(n===s)return[u*Math.sin(l),{x:t,y:n}];let c=0,g=0;const m=(s-n)/o-i,f=-1/m,w=e-t*f;return c=(s-o*m-w)/(f-m),g=f*c+w,[d*Math.sin(l),{x:c,y:g}]}if(n===s?r=i<o?Math.PI:0:(h=(i-o)/p,h-1>1e-5&&(h=1),r=Math.acos(h),s>n&&(r=2*Math.PI-r)),h=(t-o)/u,h-1>1e-5&&(h=1),a=Math.acos(h),s>e&&(a=2*Math.PI-a),l=a-r,l<0&&(l=-l),l>Math.PI&&(l=2*Math.PI-l),l>Math.PI/2)return[u,{x:o,y:s}];if(i===o)return[u*Math.sin(l),{x:i,y:e}];if(n===s)return[u*Math.sin(l),{x:t,y:n}];let g=0,m=0;const f=(s-n)/o-i,w=-1/f,v=e-t*w;return g=(s-o*f-v)/(w-f),m=w*g+v,[u*Math.sin(l),{x:g,y:m}]},t.isWebGLAvailable=function(){try{var t=document.createElement("canvas");return!(!window.WebGLRenderingContext||!t.getContext("webgl")&&!t.getContext("experimental-webgl"))}catch(t){return!1}},t.isWebGL2Available=function(){try{var t=document.createElement("canvas");return!(!window.WebGL2RenderingContext||!t.getContext("webgl2"))}catch(t){return!1}},t.sortByGroupName=function(t,e,n,o){let s=((t,e)=>t.reduce(((t,i)=>({...t,[i[e]]:[...t[i[e]]||[],i]})),{}))(t,e),r=[];for(let t in s)r=[...r,...i(s[t],n,o)];return r}}();var Cursor={pan:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAABGdBTUEAALGPC/xhBQAABjRJREFUWAnFlstvU1cQxu/1fcR2HMd52DV5kVABUZ4tkIqIx6KRKBKbCqJukKjURbtghSr4S1gg0U2zQqjbthISYkElVCoEIZAQkiYpCXm/4zh+u7+xcoxDbCe0UjvS6B7fO2fmOzPfzLGm/c+i/4v4uXvT/9RPrpNiPpSdY9tIfovKbwmeylGW+xfluNgOsTFQEy1B1R55JyoSQyNoElWA5LlnZpQzbHeJ+iZBJHAZWurz+by2bSfD4XDK7/d/YllWgPWTqampYb7HUQEhgERVZljmFzlVPlHB5buNusvKysrr6uouezyer3UklUrFq6qq3IZhOBYXF58C5Ifl5eUxPqVXV1cX2bOGhtGimVApxG6HCAAJ7kQ9LpfLGQgEWg8ePHj+2rVrrZcuXXItLCykL1686Llx44YvFovVjo2NnaysrLxcXV39LeqLx+PDW1tbm+xXZWG5W4plwMLcS+DGAwcOfEPaewmUxrHW1dXlGR4ettfX1/XS0lK9ubk51tTU5Ozt7fU2NjYat2/f/hzbUTLShw9Virx8yJcBOb2w24WWE7znzJkzX1y/fj1ACSycagQ00un01uvXr9fcbrfe2trqXllZMQFjnjt3zkVJyvr7+xcTicQQ/FjFT8EsqLbCZpcIEAlkojplSJ89e1bDafjx48fh48ePl0HIyhcvXlhwwWhoaNCmp6ejb9++TbS3tyf53klJTuJDyigHVbxi+U4KZUAspDyukpISN+lsOnz48McAcFFrg/o72traTE4XHhkZCQHEcejQIWtoaChO3TXs3PPz85XPnj2bZ+8A79bxJR2xqwz5AGCXQSuI7Wg0Gie19cFgsAUQFt2QJNAGWUmfOHFCuGDCBcfp06ftN2/epMmCduTIEclchNbUKNkc+ie+pEUFxA4pBEAZGbSbTRYkSFVtbW2NnG50dNSizuaxY8eMpaWlyPj4+BYzwQSk/vLlyzCg06dOnfKQhcDAwMBcJBJ5yjtpyV1ZKARA1SuTBRxE6ILG+vr6jpaWFpPej7569WrdNE2ts7PTRUa0jY0NHXBO6Yry8nIDW3NtbS08MTERB/wMJJ0AgOoIdcDsKM2+YKGCqyHkJAslkNCi5BU1NTV+0u2h9hanN7q7u03mgwMSGl6v10EWLDTT3pDTJlPBwcHBWUA8gcBR/EtHZCVfBgSAOHCj3m21IdMqJ68j0KcdHR0G7ZkisF5RUZEJLMGx3SFOp1OHsFF4EmZ+TJOFKQwSaJYL7wOQ4OJIWqeCIdQCu78jnd9zmnaItQSjY2Shivq7JTijF9PCQocIT4JkbGZubu4JlpKFogAEVClaSeDenp6er65evVrNpPsIVjfMzs7WcPpysqAz/zErLtwdDpkNz58/n8dyFF7IU7KQacl8GZB3mSlIBj5jCnZduHChRGbA0aNHTUhlAiRGKRIAlItqT4GgMVo0DJARWnKUDdKSBQEoDrioYenMzEyAU/hhv0XNbSacRurj2223dwqIFAqFUnTKJu3bDykHtwFkypBhKy9yRT5Iu2xMTk7+To2dt27dsql925UrV5yc3BbN3bDXWuYCJIzBoezJ1Z73S6DeS3oESJqaLfCcg0R+xoFfLiJasjjzlJftJyM58uDBgyFK95D/CuO8FiLmLYHaqgBkyEINl0E/wz1QRTqDcEEXcinjYk9mh3b//n0H+hst+QuZXMa+IAlzfeWCSBF4NZlMUpVJH/1cS3sKFwplMOvn3r17oTt37gzRgr+SgT/4ICM5O4z2ciAgxFgQy//AENNsnAvHA5BaukBXU4/vO4SMaY8ePQr39fVtMrZ/JvhdhtkKRjsupb0AiFMFQoAkSWF4c3NzhFrq1LYGcunyR0X+mIixCExPS+CbN2+uwZ2fCP4jo3iaT1uoHCYr2U3ZN/kXYic1F/bLv2MfF5Hcjt1Mui8J3ow6uIgSZMkiWArm9/O8S+8/5ORC5BC66zLaLwD2vvuPwFoGlQCRu8LNPVANKYNMRjcl2qBz/oIzKqj8GZG6Z8rIc4d8CADZKPaiUjoZQnJniMpazRQplbSZUjm1vMvOf9ZZ+VAAslHtkaeURcCIym9RFUw9hUOieUU5y/txHy9z9+euiwbdh9//zuRvyW3yFM73IK0AAAAASUVORK5CYII=",orbit:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAABGdBTUEAALGPC/xhBQAAB55JREFUWAntlltM1PkVx2eG28ww3EdA5CKgSBXEKO6Klxq3dsFbDTZa120Tre1ufdjY1sRoNqm1aaPxYetjEy/RxLrbpGiiVWQbUPfBW8CqRHe1UapVizCIIMMwwMz0852d34RycdOnvvSXnPld/7/zPed8z/mNxfI/btb/Qr/OjhbzeYjBaDF7b+y/CcBIhTHcNFJszM33QcYBZDjSazwSENPxm7lgvF3tSYmUxiHxiB1JiIxj6bUvRVI8iAwg/ogM0QuIwOnMuG0iALpYIiVSmoi4CgsLv52YmPhOfHx8ZUxMTGYoFEq0Wq2DwWCw3e/33+7v7//86dOnFwcHB19zvh8RIAERCMmYNh4AY7msdiIpRUVFNampqb9IS0vLqKmpCVRXV2fk5ubakpOTLT6fz/LkyZPQ+fPnXzU0NIRe0l69evXJo0ePPufbXsSLyDvjgpgIgNzuSElJmVRQUPA7FK3Ys2dP/Jw5cxzHjh3zXL58OeTxeBKHh4cT4uLifADzLV++3Lpp0yZ3S0uLd//+/UPd3d0NDx48+A3e8HBXXwSE4QbTr9tIABobkeuds2fP3mO323926tSphMOHD3vOnTvnwOK/9vX1Xezt7f2KcY/D4UgDYInL5VrG+LsrVqzwbd++3b1t27ZOADy4d+/eB4Do5D4DYkJOmJiLZC4kIyEhoRgQdZWVlYP0lzIyMr7D+gwkH8lBsiO95jPS09Ory8vLL61atcrT2dkZ2rBhQ0dZWdln7BUjaYiILD1jmhZNzNPz8vLKmE9GpiBTp02b9j59ISKlbkSXpY4QzbWeh5TNnDnzjwLR1dUVWrJkSTcc2sa67hKZFd5o00RuFwChc+Xk5JRkZ2efY9yIq3voffDqPr1YLTIppQTWpKTCpaZUFOOHsb6F0FX29PS4Nm7caL969WoZYOoCgYBSVOcUhnATAGO90KWB9iCuLiC9Sl+8eNHAmlJJIgLpvAtXT83Pz38PoGsYl5KOHvjgYy8MgN4CQb9C6fs7duxIrK+vt6C8DWI+ipzRXWpWXSiRNSnFxcXrsrKyNpw5cybl9OnTqeT6Cz76O3u6WEBd7H+rpKTkL4sXL160evXq+awtGBoa+pBaUO/1epV2utwKniDZUUiWuDHKdvfu3Tg88wV78qIBwPBr5Zkw+S3I5rly5coAFoXUa87625yZguRgbdW8efNCR48e1ZFo03zhwoW9KFzEuVxEpKzAS7tXrlzZifLg3Llz/8Ga7hKXxBkZHaP4hasd+f5zFAaqqqqUBRb18+fP76HCbW9tbf01S8FJkyatgtX+LVu2hM/onBpzy82bN2OoDSvx2LHS0tIavDcbhFnwxwkQq81my2H9o9jY2D7WWwD1KZ8G5FYbLiqnvP4gKSnJtm/fvm5deuDAgW5y26Z1wJWzFMelOQsWLBABx7RZs2bZuVyZE4v7n0PCH5MJVbW1tX7usaxbt65vzZo11aT2T7XPOekO/wQpIJOx9NDZs2cbKDou2G+BAwkUnqsDAwNHtc9ZeDX8L5CLyWPatWvXhrTPxtDjx49bKT5/ev36dXDnzp1yt2X37t1pmmudMt3KkjIh/EgpFjqk2LxNrNoUM9B3KoasVSCKaa5irFiPxwFxQxzhnGrFFHFnAk69xX4mIr02ZYCaQWPjknJevCwywgIQC8xtYl+vmx9vePFU0/37938ESf3t7e2248ePD+CpAaxeDQceck6PzxDnAnjuZXNzc9X69evtW7du7SOt9/HNjch9yoagipApREKUCh++h/z2xIkTacSs/+HDh9+HSF9GPqKzOAGZJ0IS82zy+3lHR0c9Z/7JnpTrYt0ZrisVFRV/4Ow8Fafbt29/wPpLRO+CUjtoPMA43GzkcidkrIWxdizwPXv2bAYKGtlVBZMMQqIeisxN5TVWNzPXi6diJU/qTmWWSBaC/X+jFtRi/YdwQBxRRZXycPxHA7BikU2uu3PnzrKDBw+mNzU1JXHBZFkQ+UhKVEh0iaw1l0mpA0ni7XgHj7QzDkDoLjz1ZwxpY26Um5D/x8Mgt6lZyeXnkKjgxo0b2YcOHXLz/ueotqu8Yq2UyjqBl+gNkeJkSvi06dOnfwKHPnK73VP5Y3IRg7w83V3sy0PmHRCAcBvtAS3KNSE+bsZ9i65fv+44cuSIWw8Lbv8h8S9yOp129mRxAkDzKc9L+If0k8zMzI/Xrl2bRg1JqqurK+JfVAyuv8Q5pa6Uh++mjzZjtVnQ3Fjlogi5qfu/Iv2qd+3aFUeqOU+ePNnV2Niov14O3gAH7vVjrXfp0qXWzZs3u2/duuXbu3fvIFbXkxkfA1x/RnyIwhaOO320jQagjXB1pJdrxeRksuJdrPkl1qfzf9BKfU9VeYUrFhRZ+CMa5P9g14ULF2IIXxfe+z3F5gLf6jkfE3fWom08ANo0IMy778QbSbh5Ge5/l3JaQQiyqenxPNte4txBhWsmg5ra2tq+4HulmVJy3LizHm0TAdAB7RmyCYgeIInqhbwjDuiMCBVOT3rFWkpNdsjtUcYzHtPeBECHtW/EsF6KNRY4NcVVSqRspBjCjYk756LtmwBEDzIwQEb2Zn+kMjM2e//v3+iBfwN/OI2ZyYaa1QAAAABJRU5ErkJggg==",measure:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB0AAAAbCAYAAAH3zbSEAAAAAXNSR0IArs4c6QAAAn5JREFUSA29lr9uGkEQxu8A47MTKSf5j2RbjnDhAAUVVKbhBeiiNHmLPIxbt64i+QF4A3iBpEiUIkWUCEVBcSz/uXy/1S1aH3fxcoKM9LG7szv77c7MzhEEQRAKFWEutXkvCKoMqkmS3Foly+vCa6ugjdwBm907imoo+8QqwjCMavp5axVqzWTUarWuNKg6E/MurJvCS2F+lHR2Q+0XFkSiuU6VjxrRbaHg3OyyIJVut3sj7cHCjBTWOZ+zkzJKrLMa2UnGISvyJtAZy/F4vDDf6/VMUAaaOVyYDYKv6OpsPZ1Ok06nc6Hxs5yFharNfr9/qdmGkOvuIksTBjH/KVpQpJ9MJhF+fCha8ITe2EXcOU/+pdfGhrmQIC8E7mLuDEgzmwrufFGfI99iiIcJNv27FGqeliPuOhwOyekTwZu9KSPSeSAslRg8r7NljbhXLNBOBR/ZZhFOiRW7Tz4Wdo0y6QSmhrArfBd8xKzFcE+M33ws7Box7mN4qmh8sEqfVmXnFTHzjpuzaaWMkbEvbUg4ZjrzG7Uku49Qi2c4x01yH0PK4p013FJIfmWt4jg+H41G76SHpWzlyG5rxnwETqkaVFAeS7vdfi8duX8k8D0r7UfZ5gqbGtKUbKBxQ+CFLlWFtd5LcC+BfCHwQCkJPFDqifuB1rC0wAHwFiFK6KCoyb0fUQgIB8EDqwAeO9D+5MWesEHqQmyLXUv9mUC5XZXA8TzdjPYnt+QfxU6K3yiFVZMSPurljxSG9JjsdWUdYxEeC3VcC0zVVrtugQc+kyzN7M3cW6+iz/7iasJnWGH+n0JmcQJT4vj3t2Yx75Tsperwx9hm2DpuD5l9Gdd/AVIlXMI9fgkPAAAAAElFTkSuQmCC",section:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAABGdBTUEAALGPC/xhBQAABBpJREFUWAntVUtLG1EUniRjEo2amKjVxBiFqlAXRUVFEBFKF6KLgii47kIKXVX36rra0lXRnd1IFftYqFAoBFyJ2AdUixqoMU18a3ylSZwk/b6pCRmfP6AZuJlz7znfd8797rkTQUg9KQVSCqQUSClwgwKxWEzV0NBgrq6u/tbf36/m/IZw2cUYxhJD7G0Y9XWEJGlsbKw5Ozv7qlKp7h8eHuoGBgZuLYAxjCWGWHKQ67o8VxISMDMz8yASiUyUlZUZV1ZWhNra2jvRaPTAarVGpqamHsF+AVLHObFbrVY/a21t/eDz+TSwc+bn57fKy8uF1dXVQ41G09HS0vIZvNGLhVyqjMmR4LEkSZ/a2tqMw8PDMgZzQzgc1kxPT7cj+WRzc7ODPg7aXKOPMYwliD5ykIucVymhKKCjo4MJXoFspKurS+jr6xOysrLkAtLS0rSwtfANIaEwODgo1NTUyIM21+hjDGMJIpYc5CInuZlDJjz/kQtgo9TV1VnW1tZGIftTVCr09PQkxwk4U7Xb7S5ErJ2EFx+u0RcKhQyMTfaTi5zkZg7mijenHNjZ2aluamoK4ux0ycBkGzvQYGeyHNzZdQ+SZzL2Oj9zMBdzMkb+qaysVB0dHaVXVVU9B/l7Vjs0NKTg4K4sFksIBDsjIyMKHydjY2MCfUjOY1I0N7nISW7mYC7mJE4hFSSKVVRUvMvPz39LQlwp4fj4mHGJJzc3943T6RR6e3uFhYUFgTeENtfgG00EwiCWHOQiJ7mZIzlGPJ/wegS0Wu02Agx2u33GYDD40LlPlpeX9YzBmUUxwkVFRU7s1DQ7O9uOpCb6cM38BQUFkzabzQmlwhjyUXZ3dwsulytYWlr62mw2f8f6b+bA9yEAmHwlE1KxOx0Ohx7yWJDADhkdfr+/en19vQsAa319/T1cJz9IbPDdxTsfI50FoLA/GNvAufD2iqJompubW0LP+IqLi8dMJtMX+NzAebKzs/fQzMGJiYkIsYlmWVpaimEHUcgYCgQCQZBIOp3uBIAf+/v7FbA/Go3GDRTBZpWADeN9iiL8SLoF28PkiDvd3d214mv4EB+ilzj3n/D9wvdhHfaex+MJxZOzgIQCnPBBs6hxVbR6vT4bUxtIefUkyOzC2sbBwUEMdgZGJpLLUsMfwtGdYARycnJUwWCwEDZVEjE2wOPF2lFJSUkY/Iqv4aUC4kXgLe7s7GShcgtsqJm2h/k+uldaXFwkToNzl/Gbm5tsrAh8MfjEvLw8M46NuDOc+R7m7GTpYnKsXVaAi3ywKxWaCCch6kAi4ljC2L1Cvn+Ryl/2ElTQZWRkaFE8TkwK4ZMsQQlF98dRimsYX+SbAAJxfQJer/cYf0LB8fFxhXzJ8XGbMYwlhtibkscxqXdKgf9bgb8e4D98kWiZrgAAAABJRU5ErkJggg==",rotate:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAABGdBTUEAALGPC/xhBQAABUhJREFUWAntVmssZGcY/s6YGYPBYC3WfRsqS2tTiawUcUuUSFRdE3GtS2ormuxqJEK1iR9t0jaSjVtRIUII5U9VdhsjVSl1DSK2a+LaDcZl3OZiZk6fz8ZkzVKxPzZp6kuO855z3u99nu95L4OQ63WtwLUC/3cFmNcRIDMz03Rra0skEAiER0dHips3b8rq6up2GIZhrxrvUgIsy3KioqLeR/APARimUChcNRoNTIHa0NBQe3x8zCiVSgO1Ws2YmJisarXaYfh0ubq6/lJZWXlwGaELCZSVlXFHR0fvczicInNzc7PAwECBj48Px9nZmQCYQAGyvb1NhEIhsbKyInw+n6yurpLZ2Vl2YGBAvrCwwPB4vEYjI6MvW1tb1y8ici6B6OjoOzhxN8CcsrKyDHEqIhaLWRBiKKiBgQExNjYmUIHFycnh4SEjl8uJqakp8fT0ZAMCAhh3d3fS1dWlefLkiRyHyOru7m4/L0WvEEhMTPRCXoeys7OFLi4uTEVFBQVg7ezsjmxsbGQikUiFQMc4kQx3KrEAlzlSZQQ/7vr6unBzc9Nsd3eXk5aWRtzc3EhxcTHdc7+zs7Nen8QZAjU1NbzHjx9PJycnvw1H0tzcTLy8vKT29vbzAOjFyf/AXQK5VVBFg2ct8s/A5oAED8+2qA8f7P1AJpO9NzMzc8vJyYmTnp5OCgoKlI6Ojneqqqok8NUtrs6CMT4+7ge53vL29iYPHz5kkfdZSP0Nl8sVA3gXEivj4+OP9U9xGqO/v//vlZWVWZDqsrCw8PLz8/tseHg4fGxsjBcSEsIfGhr6tL29vTAhIUFzukdHAJu5TU1N9yA7B8yJtbX1HgroE+R5IiUl5egi0NNA9B4cHKzGjV6HANpBGlZsbW2tRkZG7gUFBTGTk5OB6BCaskNcJ4tKd7JQRAaQ6HBpaYnx8PAgGxsbgsXFRem/gUNaUWRk5HdQ50wqaUCcUgXya8vLy3ykkSAuLVo1UsR7gfjir44ATqtB1Y/jpGq0EImJieHPzc39FhsbG3QeAN67geQo/JMaGhqELweldlJS0q2enh6aCu/Q0FCmr6+PxWwQY1ZQhXRLR4DKh7V49+7dP6urqwmKh3nw4MEN5P9ngI2iNSMpEXrBDkOeJ8LDw28joAj9bkQj5ufnm2FoJcfFxfXu7+8v4HtYYWEht6ioiHbDhqWl5U9IrUKHDuOMdMgbH3kLRK8/Qs+7gwyDjiD19fWap0+ftkdERGSinz/Gvm9LSkoM6QDKy8tjUagSTEQrlUolxCnVyLcAs4BgIJG2tjaCmSAFga9B/ofc3FzZhQToB7SiMWQNQLAvnj179g7qQAibBZnK+fn55wcHB1+hlTgAIrDJ1NQULViCaUnoUKLpGxwcJKh+ggJUA3gJs+MRWrQlIyNDql/MZxSgBKjEvb29/LW1tduwY1E0CSBhgUD5GFDWExMT30N2k/LycoJnUlpaSjB4TsjQsQyZtbgOHBwctqGMGG39I2JM5eTk7OmDU7xXCNCXdAGc09LSQn/tbPHoiUADeGcOu2x6evojgAoxLQl+cFhfX99NFDH9cdqBz1/w6Yf/7xhQS7BlkJ1OznPXhQROvSmRxsZGPlpO2dHRwdnZ2bFH8ByJRJID+a0BrESxxaFYJZBZhj5X4p0cLad4eeCcxtO/X0pAfwMlhBF9A3MjRiqVfg41RCjOd1NTU59DYq2+/2XPukl4mePpdwoCEpu1tbVt+Edkxd/fPxwdIH8dcBrzygToJlpMWHso1l9RrGNmZmZnWov6vLEFIldO4xsjdw30n1DgH4y0hp8mM/gUAAAAAElFTkSuQmCC",translate:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAABGdBTUEAALGPC/xhBQAABLxJREFUWAntVllIZEcUvd1jOxrbNW7jihoRxQWhjaKixiUS42DEBZn8iCGifghxIWAQhsjgR0JIPiL4pRkTFDU/CsK4oOJCUHFBUVEEcUSNg6Ktjt3a7cupgtdp5fXrkTDkx4LuV6+We86799xbRfTQHjzwP3tAcR/8oqIij/Pz8xfY461Wq+svLy81RqPxCfq/9fT0vLmPLXGtUuxYe1ZVValPT0836urqvi4sLHx6cnKyEBQU9HtmZuYPZ2dnf7W1tdlZsyE1b9UDgiAo8vPz47C5VK/XV/b19XE7JSUl1NjYSDExMVRTU0MHBwcVIPgYk64RERE/ol1IAd4ds+qB4uLiGGyazMvLq3RwcKCZmRmysbGhtLQ0WllZ4faysrLo6Ojo19jY2F/S09Ofr66u9nR3dz+6Cyb1LktgdHTUxtbW9llSUpKqtLSUysrKaGhoyAQq9lNSUugRWkVFBdXW1pK/v/9nS0tLPlKAd8dkCWxsbNgGBgbqxC9lQAsLCwQhUlhYGCkUClpbWyPmmcTERAKoidzOzk4hwidrny22tuA6ODh4XKvVGkQgjUZD4+PjHAgCpOHhYROo2EcYCCL9tqOjw55PyvzJEigvLzeoVKp1X1/f16Jxc1DWZ2QMBgMxYru7u7S/v0+urq4UGRnptbi4+JEMNp+SJQAXCzCuBYHesbExDhQXF2cC8vLyooCAAC5MSIALc2RkhBtm5EColOlIjoQsAbYRIbh0c3P7E57QswxgQKmpqSQCsQyYnp7mGNnZ2TQ/P8/7TBPX19eV0JEDH7DwJ5kqLPchqE8hwJdTU1NPUe0mXVxcPt7b23vCwJ2dnQmVj3JzcykkJITXAmQLgShlZGSQUqnkqQoh2kA7r+bm5rYt4EsPI4ft8TVabBT6+/uFnJycNw0NDT8D8AZVD/wE4fj4mD/l/iYmJoSCgoKXra2tKmkkC1mAiucCl9v7+fnxr0TFc0cqfoWvNIgZwIRmrYWHh5NOp/scaWoxGyQ1AOEJUPVmfX09F1xCQgI1NTWpMa4Ss8EaOJt3cnKim5sbR/wsnhOSBLD3xMfH5zkq2t+szq+vr1N0dDShvrOaTzgF3wWfLi4uuBawXlJrzIgkAZRdPWL7Cqfdd1FRUbuIP0+10NBQ6uzsJHt7ix69RWxra4twVL9F6IRbE2YvkgRY/qMIaeG6Xm9v79r4+PjN5uZmQaz9Zvtlu4ODg+Tp6bmJrLi2tFCSAFsskkD6Dbi7u1cnJycvtbS0CF1dXZZs3RpHBtHs7KwRafoHbOluTZq9vNN9ADlvh7Neg1i+mJycxOGYpGQnH8t9qXZ4eMhPRWTBLLT0JUK6BRI3UmstekBczDyBO8ElyvEMYv8N7gEDy8vLV9XV1bwCokiJS+nq6ooGBgaIzaFE73t4eHyPydeWwNlGqx4wWUeHFRRcRoKRjlU4dJ5BZG4oTEoA8WXsIIJQdXD7NrzzE4TczbTEPsLcjnn/XgTYRnbTQXH5EMXqEwB8AaEmIDQfgJjRzs7uAEt6AdiHGrCNS+yFHDizd28CbBOAFe3t7Y/hcjUU7oifE7yiBwktps8cHR3fImz/xoZtel+NkWFewdOqnt4Xhwe7/8kD/wDeTzMCbKkf6QAAAABJRU5ErkJggg==",zoom:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAABGdBTUEAALGPC/xhBQAAA6pJREFUWAntVltIk2EY/rZ/bO7gNCx1aswrYzSGkKAYIUE3mg6TlPBwIcEoJnRVkCFOJAblTeAo5lUIEi5spLCbBCUSBIOh1KAbldIxSZdzOZ079L6jf/yb23/q0n7Yvu89Ps/3fkdC/n9nvQLUvxSgp6enqqKiwt3Q0DC/trYWEpNLKiYIY/r7+y/s7e3NG43G69iiLCaXKAI2m00TCAQ8bW1tNWNjYwRblFEvhoSgGACRt7S0zNvt9iTzQxn1aBeUUIgzAEpbW1tdg4ODyVgsxsRPyahHO/rxzSvh64hJodSOo6Oje3TMxMQEqa6uJuvr68RisdBqUlBQ8Gp2dtYqkUgSaWWejiyP/pTa5XKpzGbzVzB4gUzZzMyMrry8POWn0+kIRVGko6PDD6ABUH5Ff2jDKQeWP96l6uzsPFSpVK8B6ObW1tZdrVaLI02lxhZl1KMd/dCfBTdt4k0Ay9nb2xsqLCwM+P3+Mhw180MZ9WhHPz7lx3jeBBhgVDweN+YigHrwE3S4CSYQDAZlJycnNbkIoB7tDLKcXcEE1Go1EtDnIaBHOycqw0EwAZhbKhqNlsEdwEhDCBJCPdozDByCYALHx8cy+BVnVwAJoR7tHJgZZsEEYKtpEomEoqSkJCMRyqhHe4aBQxBEAA4gCWy1S9mjpzFQj3b0o3VcrSACCwsLFJTYxEYA7ejHBUzbWZniSOByeQBJn0NAem7b29uJ1Wqlc6Rbh8NB3G53WoZOTKFQPJybm3sBizPJNNB9VgLT09PK/f19M8zrk5WVlctw4eCFRMfmbeEiIk6nM1FXV/elsrLyaVFR0fuurq5IrgBWAliBqamp4nA4fOPg4MC2tLRkaGpqkgwMDBCp9PTswSIk4+PjZHFxMdnY2OiDY9mm0Wg+dHd3/xJVAWSMJCYnJ1Wwx6/AVWxbXl6+VlpaKhseHiYAkB4UECQjIyNkZ2cnVl9f/xEuKJtcLv/c19d3mA8cg1krkM4OHZgOeSgUqoHz/tHq6upt6CtHR0eJXq8nm5ubZGhoCG/EiMlkegs34jPof4OyR5k5cvV5E8BgIEEBcBWQsGxsbNz3+Xzn4A1A4G1ADAZDEB4nLwHcCeA/ADyeCzBbJ4gABsOUSGFKzkcikVu7u7uPvV7vxdra2u9wENmVSuU7KPlPKDnnS4gmIpjAXxISWOVaWIhXgdAdAHwDC/AT7BJ8B+TcbjRgdiuKAE3C4/HIt7e31XAP/G5ubo4KBc8mczblP8eTrmVjlSb0AAAAAElFTkSuQmCC",add:"data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPHN2ZyB3aWR0aD0iMjFweCIgaGVpZ2h0PSIyMXB4IiB2aWV3Qm94PSIwIDAgMjEgMjEiIHZlcnNpb249IjEuMSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayI+CiAgICA8dGl0bGU+5b2i54q257uT5ZCIPC90aXRsZT4KICAgIDxkZWZzPgogICAgICAgIDxwYXRoIGQ9Ik0xMSw1IEwxMSwxMCBMMTYsMTAgTDE2LDExIEwxMSwxMSBMMTEsMTYgTDEwLDE2IEwxMCwxMSBMNSwxMSBMNSwxMCBMMTAsMTAgTDEwLDUgTDExLDUgWiIgaWQ9InBhdGgtMSI+PC9wYXRoPgogICAgICAgIDxmaWx0ZXIgeD0iLTYzLjYlIiB5PSItNjMuNiUiIHdpZHRoPSIyMjcuMyUiIGhlaWdodD0iMjI3LjMlIiBmaWx0ZXJVbml0cz0ib2JqZWN0Qm91bmRpbmdCb3giIGlkPSJmaWx0ZXItMiI+CiAgICAgICAgICAgIDxmZU1vcnBob2xvZ3kgcmFkaXVzPSIxIiBvcGVyYXRvcj0iZGlsYXRlIiBpbj0iU291cmNlQWxwaGEiIHJlc3VsdD0ic2hhZG93U3ByZWFkT3V0ZXIxIj48L2ZlTW9ycGhvbG9neT4KICAgICAgICAgICAgPGZlT2Zmc2V0IGR4PSIwIiBkeT0iMCIgaW49InNoYWRvd1NwcmVhZE91dGVyMSIgcmVzdWx0PSJzaGFkb3dPZmZzZXRPdXRlcjEiPjwvZmVPZmZzZXQ+CiAgICAgICAgICAgIDxmZUdhdXNzaWFuQmx1ciBzdGREZXZpYXRpb249IjIiIGluPSJzaGFkb3dPZmZzZXRPdXRlcjEiIHJlc3VsdD0ic2hhZG93Qmx1ck91dGVyMSI+PC9mZUdhdXNzaWFuQmx1cj4KICAgICAgICAgICAgPGZlQ29tcG9zaXRlIGluPSJzaGFkb3dCbHVyT3V0ZXIxIiBpbjI9IlNvdXJjZUFscGhhIiBvcGVyYXRvcj0ib3V0IiByZXN1bHQ9InNoYWRvd0JsdXJPdXRlcjEiPjwvZmVDb21wb3NpdGU+CiAgICAgICAgICAgIDxmZUNvbG9yTWF0cml4IHZhbHVlcz0iMCAwIDAgMCAwICAgMCAwIDAgMCAwICAgMCAwIDAgMCAwICAwIDAgMCAwLjUgMCIgdHlwZT0ibWF0cml4IiBpbj0ic2hhZG93Qmx1ck91dGVyMSI+PC9mZUNvbG9yTWF0cml4PgogICAgICAgIDwvZmlsdGVyPgogICAgPC9kZWZzPgogICAgPGcgaWQ9IuWFtuS7luWKn+iDvSIgc3Ryb2tlPSJub25lIiBzdHJva2Utd2lkdGg9IjEiIGZpbGw9Im5vbmUiIGZpbGwtcnVsZT0iZXZlbm9kZCI+CiAgICAgICAgPGcgaWQ9IuW9oueKtue7k+WQiCI+CiAgICAgICAgICAgIDx1c2UgZmlsbD0iYmxhY2siIGZpbGwtb3BhY2l0eT0iMSIgZmlsdGVyPSJ1cmwoI2ZpbHRlci0yKSIgeGxpbms6aHJlZj0iI3BhdGgtMSI+PC91c2U+CiAgICAgICAgICAgIDxwYXRoIHN0cm9rZT0iIzAwMDAwMCIgc3Ryb2tlLXdpZHRoPSIxIiBkPSJNMTEuNSw0LjUgTDExLjUsOS41IEwxNi41LDkuNSBMMTYuNSwxMS41IEwxMS41LDExLjUgTDExLjUsMTYuNSBMOS41LDE2LjUgTDkuNSwxMS41IEw0LjUsMTEuNSBMNC41LDkuNSBMOS41LDkuNSBMOS41LDQuNSBMMTEuNSw0LjUgWiIgZmlsbD0iI0ZGRkZGRiIgZmlsbC1ydWxlPSJldmVub2RkIj48L3BhdGg+CiAgICAgICAgPC9nPgogICAgPC9nPgo8L3N2Zz4=",occlusion:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB0AAAAbCAYAAAH3zbSEAAAAAXNSR0IArs4c6QAAAERlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAA6ABAAMAAAABAAEAAKACAAQAAAABAAAAHaADAAQAAAABAAAAGwAAAABRO+PxAAADA0lEQVRIDbWWzW5SQRTHuQUpYhNbPwpipLcYaNPEBFrcdGP6AG7rW/AMvoE7l76AMXHhyoUvUEi61hhxVRottYmmfhb/v8kMXO7l41LtSQ5zvs/MmXOGm0iMgEsB2cOUGK8ncEIjqNfrjh+9LlhxVuvckL/nefOpkL+H9fzu7i5ZMjAWlm3mFBYoqsLfVukWdrRvDGR96qTBVTkvB/kovbW1Re7toObw8LC3ubn5GdndoMLSGJc8PFut1v2wgeR7RhlWOJ5tJ5rNpuP7K8WZ6MlZk4rfL4Tyz0v2sx9iQCRrtdoTnf9Rt9tda7fbX1Bl7HF3RF8Z2EaolUaj0aMMGxsbz6VNY5G2zlwxVzIJCb5k7dNsmwgV4YGwv33R44Ai3RK+xcBsm44gYtwVvyFn4xnjx247Y6qtCHmha2sCToOvMuhMMxqrT0qzoC38KBQKj3O5XLbT6byRrD+HztP3/cVSqfQxn88XZfMaefn4+LhXqVReiC4I5xCGIEVrUwbuV7pl9GXr5ItmB6MgTTPgRHPIYIUCXRcyYtzrH+EoYBd3hPeEtKGZWarKJZsp0zoOSILdNeF3CFprVWgaWus0WJTBB6LQTmz1SBgHONopGVMq1vs4Hs5GY1fk0DyCs0J21J3FCnJuR854FnqZ42Q8o6pMBpWNm/1Mtgc4gjjRbo4XmcAgiMjiAvEc4hOJwzN0270iDAv/PerrZ5L7Qpor7kmwy1ar1afusXSzgQydi8UztEZSkmnQXorfEfpCEo4bOKkiwAFW9LQfkcwBNDJ0QmwS/C8U7cm2RfvCWZPJxQANspzJZB6sr6+/UqITEBoZOiE25mfRvp9L4oNfFOhnBSpDGUnAyVZZbXwaL0lWjBjyhBRd1guEG4p9YI7qkthPgBPxv5zsP6xU7qoOtOdikZR2/oYgqIC/ACAP+Uwjlal5EC6CV64y+ZgrTxiZw/A3U5iXzxCE9WHeGpt8kWRDkSYwY4JO8Biozp10EGJ2itLyQtwUUm/Wf51ThYgA0/BJ+I71L+HkiMry77z4AAAAAElFTkSuQmCC"};Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.MouseMotion").setCursor=function(t){let e,i=!1,n=t.getDomElement(),o=!1,s=!1,r=!1,a=null;function l(){i&&"walk"==t.getViewer().getEditorManager().editor.name||(n.addClass("motion-zoom"),e=Date.now(),setTimeout((()=>{Date.now()-e>180&&n.removeClass("motion-zoom")}),200))}Glodon$1.Bimface.Viewer.Viewer3D&&"Viewer3D"===t.viewerType&&(i=!0),document.addEventListener("keydown",(function(t){const e=t.keyCode||t.which||t.charCode;17==e?o=!0:18==e&&(s=!0)})),document.addEventListener("keyup",(function(t){const e=t.keyCode||t.which||t.charCode;17==e?o=!1:18==e&&(s=!1)})),n.addEventListener("mousedown",(function(e){t._opt.enableZoomRect||o||s||(a={x:e.clientX,y:e.clientY})})),n.addEventListener("mousemove",(function(e){if(a&&!r&&!o&&!s&&!(Math.abs(a.x-e.clientX)<2&&Math.abs(a.y-e.clientY)<2)){if(i){let i=t.getUseLeftHandedInput();if("walk"==t.getViewer().getEditorManager().editor.name)1==e.buttons&&n.addClass("motion-rotate");else{let o=t._getIsCursorEnabled();1==e.buttons?o&&n.addClass(i?"motion-rotate":"motion-translate"):n.addClass(i?"motion-translate":"motion-rotate")}}else 1==e.buttons&&n.addClass("motion-translate");r=!0}})),n.addEventListener("mousewheel",l,!1),n.addEventListener("DOMMouseScroll",l,!1),n.addEventListener("mouseup",(function(t){a=!1,r=!1,n.removeClass("motion-translate"),n.removeClass("motion-rotate")}))},Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.Dom").create=function(t,e){var i=document.createElement(t);return i.setAttribute("class",e),i},Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.Dom").createNS=function(t,e){var i=document.createElementNS("http://www.w3.org/2000/svg",t);return i.setAttribute("class",e),i},Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.Dom").select=function(t){return t.indexof("#")?document.getElementById(t.replace("#","")):t.indexof(".")?document.getElementsByClassName(t.replace(".","")):document.getElementsByTagName(t)},Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.Dom").drag=function(t){let e=Glodon$1.Web.Lang.Utility.ClientHelper.getIsDesktop(),i=Object.assign({element:null,handle:null,axis:"all",cursor:"move",distance:0,start:null,move:null,stop:null,bBoxDetection:!1},t),n=i.element;if(!n)return!1;let o,s=i.handle||n,r=!1,a=this;this.resize=function(t,e,n){e=e||{x:0,y:0};let o=t.getBoundingClientRect(),s=t.parentElement.getBoundingClientRect(),r=o.left-s.left,a=o.top-s.top;var l=t.offsetWidth,h=t.offsetHeight,c=t.parentElement.offsetWidth,d=t.parentElement.offsetHeight,u=Math.min(r+e.x,c-l),p=Math.min(a+e.y,d-h),g=r+e.x<0?0:u>0&&u||0,m=a+e.y<0?0:p>0&&p||0;n&&0!=g&&0!=m||(t.style.left=`${g}px`,t.style.top=`${m}px`,t.style.transform="none",i.record&&i.record(g,m))};let l=function(t){var n,r,a=t;if(e){if(n=a.button,!((r=navigator.userAgent).indexOf("compatible")>-1&&r.indexOf("MSIE")>-1&&!isOpera?1==n:0==n))return;o={x:a.clientX,y:a.clientY},document.addEventListener("mousemove",h)}else o={x:a.touches[0].clientX,y:a.touches[0].clientY},s.addEventListener("touchmove",h);i.start&&i.start(o)},h=function(t){var s=t;if(e)var l={x:s.clientX,y:s.clientY};else l={x:s.touches[0].clientX,y:s.touches[0].clientY};var h={x:l.x-o.x,y:l.y-o.y};r?(i.move&&i.move(o,l,h),o=l,function(t){let e=n.getBoundingClientRect(),o=n.parentElement.getBoundingClientRect(),s=e.left-o.left,r=e.top-o.top;if(i.bBoxDetection)a.resize(n,t);else{let e=s+t.x,o=r+t.y;switch(i.axis){case"x":n.style.left=`${e}px`;break;case"y":n.style.top=`${o}px`;break;default:n.style.left=`${e}px`,n.style.top=`${o}px`}}}(h)):r=function(t){return Math.pow(t.x,2)+Math.pow(t.y,2)>Math.pow(i.distance,2)&&(i.start&&i.start(o),!0)}(h),t.preventDefault(),t.stopPropagation()},c=function(){r&&i.end&&i.end(o),r=!1,document.removeEventListener("mousemove",h),s.removeEventListener("touchmove",h)};e?(s.style.cursor=i.cursor,s.style.userSelect="none",s.addEventListener("mousedown",l),document.addEventListener("mouseup",c)):(s.addEventListener("touchend",c),s.addEventListener("touchstart",l))},function(){let t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.Dom");t.sizable=function(e){let i=Object.assign({element:null,axis:"all",minWidth:100,minHeight:100,distance:0,start:null,sizable:null,stop:null},e),n=i.element;if(!n)return!1;let o,s=!1,r=t.create("div","bf-resize");var a,l;let h=function(t){a=n.clientWidth,l=n.clientHeight;var e,i,s=t;(e=s.button,(i=navigator.userAgent).indexOf("compatible")>-1&&i.indexOf("MSIE")>-1&&!isOpera?1==e:0==e)&&(o={x:s.clientX,y:s.clientY},document.addEventListener("mousemove",c),document.addEventListener("touchmove",c))},c=function(t){var e=t,r={x:e.clientX,y:e.clientY},h={x:r.x-o.x,y:r.y-o.y};s?(i.sizable&&i.sizable(o,r,h),function(t){var e=n.offsetLeft,o=n.offsetTop,s=a+t.x<i.minWidth?i.minWidth:a+t.x,r=l+t.y<i.minHeight?i.minHeight:l+t.y;switch(i.resize&&i.resize(s,r),n.style.left=`${e}px`,n.style.top=`${o}px`,i.axis){case"x":n.style.width=`${s}px`;break;case"y":n.style.height=`${r}px`;break;default:n.style.width=`${s}px`,n.style.height=`${r}px`}}(h)):s=function(t){return Math.pow(t.x,2)+Math.pow(t.y,2)>Math.pow(i.distance,2)&&(i.start&&i.start(o),!0)}(h)},d=function(){s&&i.end&&i.end(o),s=!1,document.removeEventListener("mousemove",c),document.removeEventListener("touchmove",c)};n.addClass("bf-sizable"),n.appendChild(r),r.addEventListener("mousedown",h),r.addEventListener("touchstart",h),document.addEventListener("mouseup",d),document.addEventListener("touchend",d)}}(),function(){let t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.Dom"),e=function(e){let i=this,n=Object.assign({element:null,min:0,max:100,cur:50,step:1,isShowProgress:!0,input:null,change:null,currentColor:"#11dab7",defaultColor:"#999"},e);this._opt=n;let o=t.create("div","bf-range"),s=t.create("input","bf-input-range");i.input=s,s.setAttribute("type","range"),s.setAttribute("step",n.step),s.setAttribute("min",n.min),s.setAttribute("max",n.max),s.setAttribute("value",n.cur);let r=t.create("span","bf-range-min");r.innerText=n.min;let a=t.create("span","bf-range-cur");i.cur=a,a.innerText=n.cur;let l=t.create("span","bf-range-max");l.innerText=n.max;let h=t.create("span","bf-range-progress");o.appendChild(s),n.isShowProgress&&(o.appendChild(r),o.appendChild(a),o.appendChild(l)),o.appendChild(h),n.element.appendChild(o),i.setProgress(n.cur),s.addEventListener("input",(function(){i.setProgress(this.value),n.input&&n.input(this.value)})),s.addEventListener("change",(function(){i.setProgress(this.value),n.change&&n.change(this.value)}))};e.prototype.setProgress=function(t){var e=this._opt,i=e.max-e.min,n=this.input,o=this.cur,s=(t-e.min)/i*100;n.value=t,n.style.background=`linear-gradient(to right,${e.currentColor} 0%,${e.currentColor}  ${s}%,${e.defaultColor} ${s}%, ${e.defaultColor} 100%)`,o.innerText=t},e.prototype.reset=function(){this.setProgress(this._opt.cur)},t.range=e}(),function(){let t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.Dom"),e=function(t){this._opt=Object.assign({element:null,min:0,max:100,from:null,to:null,step:1,currentColor:"#11dab7",defaultColor:"#999",change:null},t),this._opt.from=this._opt.from||this._opt.min,this._opt.to=this._opt.to||this._opt.max,this.init()};e.prototype={init:function(){var e=t.create("div","bf-multiple-range"),i=t.create("div","bf-range-track"),n=t.create("span","bf-slider bf-slider-min");n.id="minSlider",n.type="minimum";var o=t.create("span","bf-slider bf-slider-max");o.id="maxSlider",o.type="maximum",this._state={from:this._opt.from,to:this._opt.to},i.style.backgroundColor=this._opt.currentColor,e.style.backgroundColor=this._opt.defaultColor,e.appendChild(i),e.appendChild(n),e.appendChild(o),this._opt.element.appendChild(e),this._track=i,this._sliders={min:n,max:o},this._element=e,this.bindEvent(),this.update(!1)},bindEvent:function(){var t,e,i=this,n=!1,o=function(i){i=i||event;e=i.screenX,t=this,n=!0};this._sliders.min.addEventListener("mousedown",o),this._sliders.max.addEventListener("mousedown",o),document.addEventListener("mousemove",(function(o){if(n){var s=(o=o||event).screenX-e,r=Math.round(s/i._pix/i._opt.step)*i._opt.step;0!=r&&(e=r*i._pix+e,"minimum"==t.type?i._state.from+=r:i._state.to+=r,i.recalculate(t),i.update(!0))}})),document.addEventListener("mouseup",(function(){t=null,n=!1}))},update:function(t){var e=this._sliders.min.offsetWidth,i=this._sliders.max.offsetWidth;if(!this._pix){var n=(this._element.offsetWidth-e-i)/(this._opt.max-this._opt.min);this._pix=n}var o=(this._state.from-this._opt.min)*this._pix,s=(this._state.to-this._opt.min)*this._pix+e+i;this._track.style.left=`${o+e/2}px`,this._track.style.width=s-o-e/2-i/2+"px",this._sliders.min.style.left=`${o}px`,this._sliders.max.style.left=`${s}px`,this._opt.change&&t&&this._opt.change(this._state)},recalculate:function(t){this._state.to>=this._opt.max&&(this._state.to=this._opt.max),this._state.from<=this._opt.min&&(this._state.from=this._opt.min),t&&("maximum"==t.type&&this._state.to<=this._state.from&&(this._state.to=this._state.from),"minimum"==t.type&&this._state.from>=this._state.to&&(this._state.from=this._state.to))},getProgress:function(){return this._state},setProgress:function(t){this._state=t,this.recalculate(),this.update(!1)}},t.multipleRange=e}(),HTMLElement.prototype.tap=function(t){var e;this.addEventListener("touchstart",(function(t){e=Date.now()})),this.addEventListener("touchend",(function(i){Date.now()-e<200&&t(i)}))},function(){var t;(window.ActiveXObject||"ActiveXObject"in window)&&(HTMLElement.prototype.remove=function(){this.parentNode&&this.parentNode.removeChild(this)},window.Element&&((t=Element.prototype).matches=t.matches||t.matchesSelector||t.webkitMatchesSelector||t.msMatchesSelector||function(t){for(var e=this,i=(e.parentNode||e.document).querySelectorAll(t),n=-1;i[++n]&&i[n]!=e;);return!!i[n]}),window.Element&&function(t){t.closest=t.closest||function(t){for(var e=this;e.matches&&!e.matches(t);)e=e.parentNode;return e.matches?e:null}}(Element.prototype))}(),Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.UUID").createUUID=function(){let t=[],e="0123456789abcdef";for(let i=0;i<36;i++)t[i]=e.substr(Math.floor(16*Math.random()),1);return t[14]="4",t[19]=e.substr(3&t[19]|8,1),t[8]=t[13]=t[18]=t[23]="-",t.join("")},Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility").throttle=function(t,e){let i=null,n=Date.now();return null==e&&(e=30),function(){let o=Date.now(),s=e-(o-n);const r=this,a=arguments;clearTimeout(i),s<=0?(t.apply(r,a),n=Date.now()):i=setTimeout(t,s)}};const UtilityNS=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility");UtilityNS.DataUtil={assertType(t,e){const i=e=>Object.prototype.toString.call(t)===`[object ${e}]`;switch(e){case"obj":case"Obj":case"object":case"Object":return i("Object");case"arr":case"Arr":case"array":case"Array":return i("Array");case"num":case"Num":case"number":case"Number":return i("Number");case"func":case"Func":case"function":case"Function":return i("Function");case"str":case"Str":case"string":case"String":return i("String");default:return i(e)}},assertParamsType(...t){if(t.length>1){const[e]=t.splice(t.length-1,1);let i=!0;return t.every((t=>(i=this.assertType(t,e),i))),i}},hasProperty(t,e){return!!this.assertType(t,"obj")&&t.hasOwnProperty(e)},hasProperties(t,...e){if(!e)return!1;let i=!0;return e.every((e=>i=this.hasProperty(t,e))),i},hasChildProperty(t,...e){if(!e||0===e.length)return!1;let i=t;for(let t=0;t<e.length;t++){let n=e[t];if(!this.hasProperty(i,n))return!1;i=i[n]}return!0},getChildProperty(t,...e){if(this.hasChildProperty(t,...e)){let i=t;return e.forEach((t=>i=i[t])),i}}};var DataUtil=UtilityNS.DataUtil;Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Utils").Transformation={getTranslation(t){const e=this._getDecompose(t);return{x:e.position.x,y:e.position.y,z:e.position.z}},getQuaternion(t){const e=this._getDecompose(t);return{x:e.quaternion._x,y:e.quaternion._y,z:e.quaternion._z,w:e.quaternion._w}},getScaling(t){const e=this._getDecompose(t);return{x:e.scale.x,y:e.scale.y,z:e.scale.z}},quaternionToEulerAngles(t,e){const i=new THREE.Euler,n=new THREE.Quaternion(t.x,t.y,t.z,t.w),o=i.setFromQuaternion(n,e||"XYZ");return{x:o._x,y:o._y,z:o._z,order:o._order}},eulerAnglesToQuaternion(t){const e=new THREE.Quaternion,i=new THREE.Euler(t.x,t.y,t.z,t.order),n=e.setFromEuler(i);return{x:n._x,y:n._y,z:n._z,w:n._w}},_getDecompose(t){const e=new THREE.Matrix4,i=new THREE.Vector3,n=new THREE.Quaternion,o=new THREE.Vector3;return e.fromArray(t),e.decompose(i,n,o),{position:i,quaternion:n,scale:o}}},function(){var t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang");let e=function(){this.container={}};e.prototype.addEvent=function(t,e,i){return"string"==typeof t&&"function"==typeof e&&(void 0===this.container[t]?this.container[t]=[e]:!0===i?this.container[t].unshift(e):this.container[t].push(e)),this},e.prototype.fireEvent=function(t){if(t&&this.container[t]){var e=Array.prototype.slice.call(arguments);e.shift();for(var i=[...this.container[t]],n=i.length,o=0;o<n;o++){var s=i[o];if(!0===s.apply(null,e))return this}}return this},e.prototype.removeEvent=function(t,e){if("function"==typeof e&&"string"==typeof t){var i=this.container[t];if(i instanceof Array){for(var n=0,o=i.length;n<o;n+=1)if(i[n]===e){i.splice(n,1);break}0==i.length&&delete this.container[t]}return this}},t.EventManager=e}(),function(){let t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Geometry"),e=function(t,e,i){this.x=t,this.y=e,this.z=i};e.prototype={get:function(){return{x:this.x,y:this.y,z:this.z}},set:function(t,e,i){this.x=t,this.y=e,this.z=i}},t.Point3d=e}(),function(){let t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Geometry");t.BoundingBox=function(e,i){var n={},o=new t.Point3d,s=new t.Point3d;return o.set(e.x,e.y,e.z),s.set(i.x,i.y,i.z),n.min=o,n.max=s,n}}(),Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Graphics.Utility").RGBToHex=function(t){var e=t.toString(16);return 1==e.length&&(e="0"+e),e};var hostConfig=window.hostConfig||{APIHost:"https://api.bimface.com",resourceHost:"https://m.bimface.com",staticHost:"https://static.bimface.com",dataEnvType:"BIMFACE",securityApi:!0};!function(){let t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Graphics.Utility.Relation");t.getViews=function(t,e,i){Glodon$1.Web.Lang.Utility.HttpRequest.ajax({url:`${hostConfig.resourceHost}/${t}/metadata/views.json`,success:function(n){var o=JSON.parse(n).viewList;n=[];for(var s in o){var r=o[s];r.viewType==e&&(r.preview.path=`${hostConfig.resourceHost}/${t}/${r.preview.path}`,n.push(r))}i&&i(n)}})},t.getDrawingSheets=function(t,e,i,n=null){Glodon$1.Web.Lang.Utility.HttpRequest.ajax({url:`${hostConfig.resourceHost}/${t}/metadata/drawings.json`,success:function(t){for(var o=JSON.parse(t).drawingList,s=0;s<o.length;s++){var r=o[s];if(n){if(r.fileId==n&&r.viewInfo.id==e){i&&i(r);break}}else if(r.viewInfo.id==e){i&&i(r);break}}}})},t.point2DToPoint3D=function(t,e){if("DrawingSheet"==e.viewType)return function(t,e){if("DrawingSheet"!=e.viewType)return null;var i=e.viewInfo;let n=i.preview.width,o=i.preview.height,s=i.outline[0],r=i.outline[2],a=i.outline[1],l=i.outline[3],h=r-s,c=l-a;function d(t){return"FloorPlan"==t||"CeilingPlan"==t}function u(e,i,r,l,d){let u=t.x/n,p=(o-t.y)/o;if("Elevation"==d.viewType){p=(n-t.x)/n,u=t.y/o;var g=d.viewPoint.viewDirection;1!=Math.round(g[0])&&-1!=Math.round(g[1])||(u=(o-t.y)/o)}let m=(e-s)/h,f=(i-s)/h;if(u<m||u>f)return null;let w=(r-a)/c,v=(l-a)/c;if(p<w||p>v)return null;let y=(u-m)/(f-m),b=(p-w)/(v-w),E=((d.outline[2]-d.outline[0])*y+d.outline[0])*d.viewPoint.scale,C=((d.outline[3]-d.outline[1])*b+d.outline[1])*d.viewPoint.scale;return new THREE.Vector3(E,C,0)}let p=(i=e).portsAndViews;for(var g=0;g<p.length;g++){let t=p[g];if(!d(t.viewType))continue;let e=u(t.viewport[0],t.viewport[3],t.viewport[1],t.viewport[4],t);if(null!=e){if(d(t.viewType))null!==e&&(e.z=t.elevation);else if("Elevation"==t.viewType){var m=t.viewPoint.viewDirection,f=t.cropBox;0!=Math.round(m[0])?null!==e&&(e.z=e.y,e.y=e.x,e.x=m[0]<0?f[3]:f[0]):0!=Math.round(m[1])&&null!==e&&(e.z=e.y,e.y=m[1]<0?f[4]:f[1])}return e}}return null}(t,e);if("FloorPlan"!=e.viewType)return console.warn("Not support yet!"),null;var i=e.preview.width,n=e.preview.height,o=e.outline[0],s=e.outline[2],r=e.outline[1],a=e.outline[3],l=s-o,h=a-r,c=(0-o)/l,d=a/h,u=(t.x-i*c)/i,p=(n*d-t.y)/n;return u=u*l*e.viewPoint.scale,p=p*h*e.viewPoint.scale,new Glodon$1.Web.Geometry.Point3d(u,p,e.elevation)},t.point3DToPoint2D=function(t,e){let i=[];if(function(t,e,i){if("DrawingSheet"!=e.viewType)return!1;var n=e.preview.width,o=e.preview.height,s=e.outline[0],r=e.outline[2],a=e.outline[1],l=e.outline[3];let h=e.portsAndViews;for(let e in h){let c=h[e];if("FloorPlan"!==c.viewType)continue;let d=c.viewPoint.scale,u=c.outline[0]*d,p=c.outline[2]*d,g=c.outline[1]*d,m=c.outline[3]*d;if(t.x<u||t.x>p)continue;if(t.y<g||t.y>m)continue;let f=(t.x-u)/(p-u),w=(t.y-g)/(m-g),v=c.viewport[3]-c.viewport[0],y=c.viewport[4]-c.viewport[1];i(n*((c.viewport[0]+v*f-s)/(r-s)),o-o*((c.viewport[1]+y*w-a)/(l-a)),c)}return!0}(t,e,(function(t,e,n){i.append({x:t,y:e})})))return 0==i.length?null:i;if("FloorPlan"!=e.viewType)return console.warn("Not support yet!"),null;var n=e.preview.width,o=e.preview.height,s=e.outline[0],r=e.outline[2],a=e.outline[1],l=e.outline[3],h=r-s,c=l-a,d=(0-s)/(r-s),u=l/(l-a),p=t.x/(h*e.viewPoint.scale),g=t.y/(c*e.viewPoint.scale);return{x:p=p*n+n*d,y:g=o*u-g*o,z:0}}}(),Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Graphics.Utility").ImageContainer=function(t){var e=new Image;return new Promise((function(i,n){e.onload=function(){i(e)},e.onerror=function(t){n(t)},e.crossOrigin="anonymous",e.src=t,!0===e.complete&&i(e)}))},function(){let t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Graphics"),e=Glodon$1.Web.Graphics.Utility.RGBToHex,i=function(t,e,i,n){this.red=t,this.green=e,this.blue=i,this.alpha=n},n=function(t,e){/^#[0-9a-fA-F]{6}$/.test(t)&&(this.red=parseInt(t.slice(1,3),16),this.green=parseInt(t.slice(3,5),16),this.blue=parseInt(t.slice(5),16)),"number"==typeof e?(e>1&&(e=1),e<0&&(e=0),this.alpha=e):this.alpha=1},o=function(){arguments.length<4?n.apply(this,arguments):i.apply(this,arguments)};o.prototype={getRGB:function(){return`rgba(${this.red},${this.green},${this.blue})`},getRGBA:function(){return`rgba(${this.red},${this.green},${this.blue},${this.alpha})`},getHEX:function(){return`${e(this.red)}${e(this.green)}${e(this.blue)}`},getAlpha:function(){return this.alpha},fromObject:function(t){return this.red=t.red,this.green=t.green,this.blue=t.blue,this.alpha=t.alpha,this}},t.Color=o}(),SVGElement.prototype.getClass=HTMLElement.prototype.getClass=function(t){return this.getAttribute("class")},SVGElement.prototype.hasClass=HTMLElement.prototype.hasClass=function(t){let e=this.getClass();return!!e&&(e&&e.split(" ")).indexOf(t)>-1},SVGElement.prototype.addClass=HTMLElement.prototype.addClass=function(t){let e=this.getClass();var i=e&&e.split(" ");return e?-1==i.indexOf(t)&&(i.push(t),e=i.join(" "),this.setAttribute("class",`${e}`)):this.setAttribute("class",`${t}`),this},SVGElement.prototype.removeClass=HTMLElement.prototype.removeClass=function(t){if(!this.hasClass(t))return this;let e=this.getClass().replace(t,"").trim();return e?this.setAttribute("class",`${e}`):this.removeAttribute("class"),this},SVGElement.prototype.toggleClass=HTMLElement.prototype.toggleClass=function(t,e){this.getClass();var i=this.hasClass(t);return null!=e?(e&&!i&&this.addClass(t),e||this.removeClass(t)):i?this.removeClass(t):this.addClass(t),!i},Array.prototype.getObjectByAttribute=function(t,e){for(var i=this,n=i.length,o=0;o<n;o++)if(i[o][t]==e)return i[o];return!1},Array.prototype.removeObjectByAttribute=function(t,e){for(var i=this,n=i.length,o=0;o<n;o++)if(i[o][t]==e)return i=i.splice(o,1);return!1},Array.prototype.getAllObjectByAttribute=function(t,e){for(var i=this,n=i.length,o=0,s=[];o<n;o++)i[o][t]==e&&s.push(i[o]);return s},Array.prototype.removeByValue=function(t){for(var e=this,i=e.length-1;i>=0;i--)e[i]==t&&e.splice(i,1);return e},Array.prototype.insert=function(t,e){return this.splice(t,0,e),this},Array.prototype.insertAfter=function(t,e){let i=t.length;for(;i>0&&-1==this.indexOf(t[i-1]);)i--;return i<1?this.splice(t.length,0,e):this.splice(i,0,e),{res:this,index:i}},Array.prototype.unique=function(t){for(var e=[],i=0;i<t.length;i++)e.indexOf(-1===t[i])&&e.push(t[i]);return e},SVGElement.prototype.setCss=HTMLElement.prototype.setCss=function(t){if(t)for(var e in t)this.style[e]=t[e]},SVGElement.prototype.getCss=HTMLElement.prototype.getCss=function(){return this.style},Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Authentication").AuthenticationConfig=function(){return{APIHost:hostConfig.APIHost,viewToken:null,enableStorage:!1}};class IndexedDBHelper{constructor(t){this.indexedDB=window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB||window.msIndexedDB,this.indexedDB||console.log("IndexedDB not supported"),this._db=null,this._opt=t}open(t,e){const i=t||this._opt.name,n=e||this._opt.version||1,o=this.indexedDB.open(i,n);return new Promise(((t,e)=>{o.onsuccess=e=>{this._db=o.result,t(this._db)},o.onupgradeneeded=t=>{let e=this._db=t.target.result;(this._opt.storeList||[]).forEach((t=>!e.objectStoreNames.contains(t)&&e.createObjectStore(t)))},o.onerror=t=>{e(t)}}))}getDB(){return new Promise(((t,e)=>{this._db?t(this._db):this.open().then(t).catch(e)}))}addObject(t,e,i){return new Promise(((n,o)=>{this.getDB().then((s=>{const r=s.transaction(t,"readwrite");r.objectStore(t).put(e,i).onsuccess=t=>{n(t.target.result)},r.onerror=t=>{o(t)}})).catch(o)}))}getObject(t,e){return new Promise(((i,n)=>{this.getDB().then((o=>{const s=o.transaction(t,"readonly");s.objectStore(t).get(e).onsuccess=t=>{let e=t.target.result;e?i(e):n(t)},s.onerror=t=>{n(t)}})).catch(n)}))}deleteObject(t,e){return new Promise(((i,n)=>{this.getDB().then((o=>{const s=o.transaction(t,"readwrite");s.objectStore(t).delete(e).onsuccess=t=>{i(t.target.result)},s.onerror=t=>{n(t)}})).catch(n)}))}clearStore(t){return new Promise(((e,i)=>{this.getDB().then((n=>{const o=n.transaction(t,"readwrite");o.objectStore(t).clear().onsuccess=t=>{e(t.target.result)},o.onerror=t=>{i(t)}})).catch(i)}))}deleteDB(t){return new Promise((e=>{this.indexedDB.deleteDatabase(t),e()}))}getAllKeys(t){return new Promise(((e,i)=>{this.getDB().then((n=>{const o=n.transaction(t,"readonly");o.objectStore(t).getAllKeys().onsuccess=t=>e(t.target.result),o.onerror=i})).catch(i)}))}getAll(t){return new Promise(((e,i)=>{this.getDB().then((n=>{const o=n.transaction(t,"readonly");o.objectStore(t).getAll().onsuccess=t=>e(t.target.result),o.onerror=i})).catch(i)}))}}class LoaderStorageManager extends IndexedDBHelper{constructor(){super({name:"Bf_Loader",version:1,storeList:["d","t"]})}getDatabagInfo(t,e){return new Promise(((i,n)=>{e?this.getObject("d",t).then((t=>this.addTemp(t,e).then((()=>i(t))).catch(n))).catch(n):this.getObject("d",t).then(i).catch(n)}))}addDatabagInfo(t,e){return new Promise(((i,n)=>{const o=t.modelId,s=()=>Promise.all([this.addObject("d",t,o),this.addTemp(t,e)]).then(i).catch(n);this.getDatabagInfo(o).then((e=>{e.databagId!==t.databagId&&this.deleteDB(`Bf_${data.databagId}`),s()})).catch((()=>{s()}))}))}deleteDatabagInfo(t){return new Promise(((e,i)=>{this.deleteObject("d",t).then(e).catch(i)}))}addTemp(t,e){return new Promise(((i,n)=>{this.clearStore("t").then((()=>{this.addObject("t",t,e).then(i).catch(n)})).catch(n)}))}getTemp(t){return new Promise(((e,i)=>{this.getObject("t",t).then(e).catch(i)}))}deleteStorageByModelId(t){return new Promise((e=>{this.getDatabagInfo(t).then((i=>{let n="gisView"===i.renderType?`Bg_${i.modelId}`:`Bf_${i.databagId}`;Promise.allSettled([this.deleteDB(n),this.deleteDatabagInfo(t)]).then(e)})).catch(e)}))}getStoredModelIds(){return this.getAllKeys("d")}getStoredModelInfo(){return new Promise(((t,e)=>{this.getAll("d").then((e=>{let i=e.map((t=>{let{modelId:e,name:i,renderType:n}=t;return{modelId:e,name:i,type:n}}));t(i)})).catch(e)}))}}!function(){let t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Authentication");Glodon$1.Web;let e=Glodon$1.Web.Lang.Utility.HttpRequest;var i=function(t){this.config=t};i.prototype.authenticate=function(t,i){let n=this,o=n.config;const s=()=>{const s=n.config.securityApi;let r=`${o.APIHost}/inside/databag`,a="post",l=o.viewToken;s||(r=`${r}?viewToken=${o.viewToken}`,a="get",l=void 0),e.ajax({url:r,type:a,data:l,headers:{"Content-type":"text/plain;charset=UTF-8"},async:!0,success:function(e){var s=JSON.parse(e);"success"==s.code?(s.data.viewToken=o.viewToken,n.data=s.data,t&&t(s.data)):i&&i(s)},failure:t=>{var e=JSON.parse(t);i&&i(e)}})};o.enableStorage?(new LoaderStorageManager).getTemp(o.viewToken).then((e=>{e.viewToken=o.viewToken,n.data=e,t&&t(e)})).catch(s):s()},t.AuthenticationManager=i}(),Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Data").MetaDataManagerConfig=function(){return{APIHost:hostConfig.APIHost,resourceHost:hostConfig.resourceHost,viewToken:null,modelId:null,modelType:"singleModel",dataEnvType:hostConfig.dataEnvType||"BIMFACE"}};var CLOUD$1=window.CLOUD=window.CLOUD||{};const adaptMiniMapGridData=function(t){return t.map((t=>{const e={positions:[]},i=t.end.x-t.start.x,n=t.end.y-t.start.y,o=t.end.z-t.start.z,s=Math.sqrt(Math.pow(i,2)+Math.pow(n,2)+Math.pow(o,2)),r=i/s,a=n/s,l=o/s,h={x:t.start.x-r,y:t.start.y-a,z:t.start.z-l},c={x:t.end.x+r,y:t.end.y+a,z:t.end.z+l};e.positions.push(h,c);const d=[{startPoint:t.start,endPoint:t.end,lineType:"Line"}];return{id:t.id,name:t.name,label:e,geometry:d}}))};!function(){let t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Data");var e=Glodon$1.Web.Lang.Utility.HttpRequest.promiseJSONRequest,i=Glodon$1.Web.Lang.Utility.HttpRequest.ajax,n={getFamilyTypes:function(t){const i=`${t.resourcePath}${t.databagId}/metadata/familyInfo.json`;return e(i)},getFamilyData:function(t){const i=`${t.relativeUrl}/metadata/assetProperties.json`;return e(i)},getAreas:function(t){var i=`${t.relativeUrl}/data/spaces.json`;return e(i)},getMepSystem:function(t,i){if("integrateModel"==i.modelType)var n=`${i.relativeUrl}/metadata/${t}/mepsystem.json`;else n=`${i.relativeUrl}/metadata/mepsystem.json`;return e(n,"noCode")},getTreeOldData:function(t){if("singleModel"==t.modelType)var i=`${t.relativeUrl}/data/tree.json`;else i=`${t.relativeUrl}/data/specialtyTree.json`;return e(i)},getTreeNewData:function(t){var i=`${t.relativeUrl}/data/tree.json`;return e(i)},getObjectData:function(t,e){return new Promise((function(i,n){if(e._objectData)i(e._objectData);else{let n=new Glodon$1.Bimface.Data.ObjectPropertyManager(`${t.relativeUrl}/property`);n.load((function(){e._objectData=n,i(e._objectData)}))}}))},getMaterialProperty:function(t,i){var n=i.split(".");if("singleModel"==t.modelType)var o=`${t.relativeUrl}/metadata/materialmap.json`;else o=`${t.relativeUrl}/metadata/${n[0]}/materialmap.json`;return e(o,"noCode")},getMaterialPropertyItem:function(t,i,n){var o=i.split("."),s="singleModel"==t.modelType?`${t.relativeUrl}/metadata/materials/${n}.json`:`${t.relativeUrl}/metadata/${o[0]}/materials/${n}.json`;return e(s,"noCode")},getAreaProperty:function(t,i){var n=t.split("_");if("singleModel"==i.modelType)var o=`${i.relativeUrl}/metadata/areas.json`;else o=`${i.relativeUrl}/metadata/${n[0]}/areas.json`;return e(o,"noCode")},getRoomProperty:function(t,i){var n=t.split("_");if("singleModel"==i.modelType)var o=`${i.relativeUrl}/metadata/rooms.json`;else o=`${i.relativeUrl}/metadata/${n[0]}/rooms.json`;return e(o,"noCode")},getFiles:function(t){var i=`${t.relativeUrl}/data/files.json`;return e(i)},getDrawingsheets:function(t,i){var n=`${t.relativeUrl}/metadata/drawings.json`;return e(n,"noCode")},getMapInfo:function(t,e){this._opt;var n={},o=[];this._helper;2===e||"integrateModel"!==t.modelType?i({url:`${t.relativeUrl}/metadata/axisgrids/grids.json.gz`,async:!1,success:function(t){var e=CLOUD$1.AxisGridManager.adaptGridData(JSON.parse(t));n.Grids=e.grids}}):i({url:`${t.relativeUrl}/metadata/grids.json`,async:!1,success:function(t){var e=JSON.parse(t);n.Grids=adaptMiniMapGridData(e.grids)}}),i({async:!1,url:`${t.relativeUrl}/metadata/levels.json`,success:function(t){n.Levels=JSON.parse(t).levels}}),i({async:!1,url:`${t.relativeUrl}/resource/v3/maps/output.json`,dataType:"text",success:function(e){var i=JSON.parse(e);for(var n in i){var s=i[n];null==s.id&&(s.id=n),s.path=`${t.relativeUrl}/resource/v3/maps/${s.id}.png`,s.name=n,o.push(s)}}});let s=n.Levels;if(s){let t=t=>{let e=!1;return o.some((i=>(e=i.id.toString()===t.toString(),e))),e};for(let e=0;e<s.length;e++)t(s[e].id)||(s.splice(e,1),e--)}return{axisGrid:n,floors:o}},getMapInfoAsync:function(t,i){return new Promise(((n,o)=>{let s={Grids:[]},r=[];const a="integrateModel"===t.modelType&&2!==i,l=`${t.relativeUrl}/metadata/${a?"grids.json":"axisgrids/grids.json.gz"}`;Promise.allSettled([e(l,"noCode"),e(`${t.relativeUrl}/metadata/levels.json`,"noCode"),e(`${t.relativeUrl}/resource/v3/maps/output.json`,"noCode")]).then((e=>{let[i,o,l]=e;if(i.value)if(a)s.Grids=adaptMiniMapGridData(i.value.grids);else{var h=CLOUD$1.AxisGridManager.adaptGridData(i.value);s.Grids=h.grids}s.Levels=o.value.levels,(e=>{for(var i in e){var o=e[i];null==o.id&&(o.id=i),o.path=`${t.relativeUrl}/resource/v3/maps/${o.id}.png`,o.name=i,r.push(o)}let a=s.Levels;if(a){let t=t=>{let e=!1;return r.some((i=>(e=i.id.toString()===t.toString(),e))),e};for(let e=0;e<a.length;e++)t(a[e].id)||(a.splice(e,1),e--)}n({axisGrid:s,floors:r})})(l.value)})).catch(o)}))},getLevels:function(t,i){let n=`${i.relativeUrl}/metadata/levels.json`;return t&&(n=`${i.relativeUrl}/metadata/${t}/levels.json`),e(n,"noCode")},getFloors:function(t){let i=`${t.relativeUrl}/data/spaces.json`;return e(i,"noCode")},getViews:function(t){var e={data:null,resourceHost:"./"};return i({url:`${t.relativeUrl}/metadata/views.json`,async:!1,success:function(t){e.data=t}}),e},getViewsById:function(t){var e={data:null,resourceHost:"./"};return i({url:`${t.relativeUrl}/metadata/${t.fileId}/views.json`,async:!1,success:function(t){e.data=t}}),e},getViewData:function(t){let i=`${t.relativeUrl}/metadata/viewStates/${t.viewId}.json`;return e(i,"noCode")},getRooms:function(t){let i=`${t.resourceHost}/${t.databagId}/metadata/rooms.json`;return e(i,"noCode")},getRoomBoundary:function(t,i){let n=`${i.resourceHost}/${i.databagId}/metadata/roomsboundary/${t}.json`;return e(n,"noCode")},getAllDrawingsheets:function(t){var i=`${t.relativeUrl}/metadata/drawings.json`;return e(i,"noCode")},decodeElementId:function(t,e){if(/^[0-9]*\.*[0-9]*$/.test(e))return Promise.resolve(e);var i=e.split("."),n=i[0];return this.getFiles(t).then((function(t){for(let e of t)for(let t of e.linkedBy)if(t==n)return e.fileId+"."+i[1]})).then((function(t){return t}))},getCategoryVisibility:function(t){var i=`${t.relativeUrl}/metadata/categoryVisibility.json`;return e(i,"noCode")},getText:function(t){var i=`${t.relativeUrl}/metadata/text.json`;return e(i,"noCode")},getSegmentGroups:function(t){var i=`${t.APIHost}/data/v2/integrations/${t.modelId}/segmentGroups?view_token=${t.viewToken}`;return e(i,"noCode")},getSegmentFromGroups:function(t,i){var n=`${t.APIHost}/data/v2/integrations/${t.modelId}/segmentGroups/${i}/segments?view_token=${t.viewToken}`;return e(n,"noCode")},getSegmentTree:function(t){var i=`${t.APIHost}/data/v2/integrations/${t.modelId}/segmentTree?view_token=${t.viewToken}`;return e(i,"noCode")},getSegmentById:function(t,i){var n=`${t.APIHost}/data/v2/integrations/${t.modelId}/segments/${i}?view_token=${t.viewToken}`;return e(n,"noCode")},getSegmentElementIds:function(t,i){var n=`${t.APIHost}/data/v2/integrations/${t.modelId}/segments/${i}/elementIds?view_token=${t.viewToken}`;return e(n,"noCode")},getPartialElementsMetadata:function(t,i){var n=`${t.relativeUrlWithoutDatabagId}/${i}/metadata/partial_elements_metadata.json`;return e(n,"noCode")},getPartialElementsMetadataFile:function(t,e){return`${t.relativeUrlWithoutDatabagId}/${e}/metadata/partial_elements_metadata.json`},getDatabagResource:function(t,e){return`${t.relativeUrlWithoutDatabagId}/${e}/resource/v3/model`},getModelGroup:function(t,i){var n=`${t.relativeUrl}/metadata/modelSetsTree.json`;return e(n,"noCode")},getManifest:function(t){var i=`${t.relativeUrl}/manifest.json`;return e(i,"noCode")},getNestedComponents:function(t){var i=`${t.relativeUrl}/metadata/nestedComponents.json`;return e(i,"noCode")},getObjectMap:function(t){var i=`${t.relativeUrl}/metadata/objectMap.json.gz`;return e(i,"noCode")},getWalkthrough:function(t){var i=`${t.relativeUrl}/data_ext/walkthrough.json`;return e(i,"noCode")},getProjectInfo:function(t){var i=`${t.relativeUrl}/metadata/project.json`;return e(i,"noCode")},getModelInfo:function(t){var i=`${t.relativeUrl}/resource/v3/model/config.json`;return e(i,"noCode")},getBimtileInfo:function(t,i){return e(`${t}/resource/v3/model/${i}`,"noCode")},getFeatureStyle:function(t){var i=`${t.relativeUrl}/resource/v3/model/featureStyle.json`;return e(i,"noCode")},getDimensions:function(t,i){let n=`${i.relativeUrl}/metadata/ModelDimensions.json`;return"integrateModel"==i.modelType&&(n=`${i.relativeUrl}/metadata/${t}/ModelDimensions.json`),e(n,"noCode")}};t.OfflineDataProdiver=n}(),function(){var t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Data"),e=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Data.OfflineDataProdiver");function i(t){this._config=t}i.prototype={getFamilyTypes:function(t,i){e.getFamilyTypes(this._config).then((function(e){var i=JSON.parse(e),n=i.Types||i.types;for(let t=0,e=n.length;t<e;t++)n[t].id=n[t].Id||n[t].id,n[t].name=n[t].Name||n[t].name,delete n[t].Id,delete n[t].Name;t&&t(n)})).catch((function(t){i&&i(t)}))},getFamilyProperty:function(t,i,n){if(!t)return console.warn("familyTypeId must not be empty!."),void(n&&n());e.getFamilyData(this._config,t).then((function(t){i&&i(t)})).catch((function(t){n&&n(t)}))},getComponentProperty:function(t,i,n){var o=this;if(!t)return console.warn("elementId must not be empty!."),void(n&&n());var s=null;e.getObjectData(this._config,this).then((function(i){return s=i,e.decodeElementId(o._config,t)})).then((function(t){var e=s.getBoundingBox(t),n=s.getElementProperties(t);let o={};for(var r of n[0].items)o[r.key]=r.value;i({boundingBox:e,elementId:o.ID,familyGuid:"",guid:o.GUID,name:o.familyType,properties:n})}))},getMaterialProperty:function(t,i,n){var o=this;e.decodeElementId(o._config,t).then((function(t){e.getMaterialProperty(o._config,t).then((function(s){var r=t.split("."),a=[];if(s[r="singleModel"==o._config.modelType?r[0]:r[1]]){for(var l of s[r])a.push(e.getMaterialPropertyItem(o._config,t,l));Promise.all(a).then((t=>{i&&i(t)}))}else n&&n(s)}))}))},getAreas:function(t,i){e.getAreas(this._config).then((function(e){t&&t(e)})).catch((function(t){i&&i(t)}))},getMepSystem:function(t,i,n){var o=this;e.getMepSystem(t,o._config).then((function(t){i&&i(t,o._config.modelType)})).catch((function(t){n&&n(t)}))},getTreeOldData:function(t,i){var n=this;e.getTreeOldData(n._config).then((function(e){t&&t(e,n._config.modelType,"old")})).catch((function(t){i&&i(t)}))},getTreeNewData:function(t,i){var n=this;e.getTreeNewData(n._config).then((function(e){var i=!0,o=t=>{"familyType"===t.type?t.items&&0!==t.items.length||(i=!1):t.items&&t.items.length>0&&o(t.items[0])};e&&e.length>0&&o(e[0]),t&&t(e,n._config.modelType,i?void 0:"old")})).catch((function(t){i&&i(t)}))},getRoomProperty:function(t,i,n){var o=this;e.getRoomProperty(t,this._config).then((function(n){var s="singleModel"==o._config.modelType?t:t.split("_")[1];for(var r of n)if(r.id==s)return void e.getObjectData(o._config,o).then((function(e){t="singleModel"==o._config.modelType?t:`${t.split("_")[0]}.${t.split("_")[1]}`;var n=e.getElementProperties(t);n.splice(0,1),r.properties=n,i&&i(r)}))}))},getAreaProperty:function(t,i,n){var o=this;e.getAreaProperty(t,this._config).then((function(n){var s="singleModel"==o._config.modelType?t:t.split("_")[1];for(var r of n.areas)r.id==s&&e.getObjectData(o._config,o).then((function(e){t="singleModel"==o._config.modelType?t:`${t.split("_")[0]}.${t.split("_")[1]}`;var n=e.getElementProperties(t);n.splice(0,1),r.properties=n,i&&i(r)}))}))},getModelGroup:function(t,i){e.getModelGroup(this._config).then((function(e){t&&t(e)})).catch((function(t){i&&i(t)}))},getFiles:function(t,i){e.getFiles(this._config).then((function(e){t&&t(e)})).catch((function(t){i&&i(t)}))},getLinkGraph:function(t,i){e.getFiles(this._config).then((function(e){t&&t(e)})).catch((function(t){i&&i(t)}))},getDrawingsheets(t,i,n,o){var s=this;e.getDrawingsheets(this._config,t).then((function(t){n&&n(t,s._config.modelType,s._config.dataEnvType)}))},getFloors:function(t,i){var n=this;e.getFloors(this._config).then((function(e){for(let t of e.data)t.miniMap=`${n._config.databagId}/resource/v3/maps/${t.name}.png`;t&&t(e.data)}))},getElementByConditions:function(t,i,n){var o=this;e.getObjectData(this._config,o).then((function(e){n&&n(e.getElementByConditions(t,i,o._config))}))},getMapInfo:function(t,i){var n=e.getMapInfo(this._config,i);t&&t(n)},getMapInfoAsync:function(t,i,n){e.getMapInfoAsync(this._config,n).then((function(e){t&&t(e)})).catch((function(t){i&&i(t)}))},getLevels:function(t,i,n){e.getLevels(t,this._config).then((function(t){i&&i(t)})).catch((function(t){n&&n(t)}))},getViews:function(t){var i=e.getViews(this._config);t&&t(i)},getViewsById:function(t,i){var n=this._config;n.fileId=t;var o=e.getViewsById(n);i&&i(o)},getViewData:function(t,i){var n=Object.assign({},this._config);n.viewId=t,e.getViewData(n).then((function(t){"[object Function]"===Object.prototype.toString.call(i)&&i(t)})).catch((function(t){"[object Function]"===Object.prototype.toString.call(failure)&&failure(t)}))},getRooms:function(t,i){e.getRooms(this._config).then((function(e){t&&t(e)})).catch((function(t){i&&i(t)}))},getRoomBoundary:function(t,i,n){e.getRoomBoundary(t,this._config).then((function(t){i&&i(t)})).catch((function(t){n&&n(t)}))},getAllDrawingsheets:function(t,i,n,o){var s=this;e.getAllDrawingsheets(this._config).then((function(t){n&&n(t,s._config.modelType)})).catch((function(t){n&&n({drawingList:[]},s._config.modelType)}))},getCategoryVisibility:function(t,i){e.getCategoryVisibility(this._config).then((function(e){t&&t(e)})).catch((function(t){i&&i(t)}))},getText:function(t,i){e.getText(this._config).then((function(e){t&&t(e)})).catch((function(t){i&&i(t)}))},getSegmentGroups:function(t,i){e.getSegmentGroups(this._config).then((function(e){t&&t(e)})).catch((function(t){i&&i(t)}))},getSegmentFromGroups:function(t,i,n){e.getSegmentFromGroups(this._config,t).then((function(t){i&&i(t)})).catch((function(t){n&&n(t)}))},getSegmentTree:function(t,i){e.getSegmentTree(this._config).then((function(e){t&&t(e)})).catch((function(t){i&&i(t)}))},getSegmentById:function(t,i,n){e.getSegmentById(this._config,t).then((function(t){i&&i(t)})).catch((function(t){n&&n(t)}))},getSegmentElementIds:function(t,i,n){e.getSegmentElementIds(this._config,t).then((function(t){i&&i(t)})).catch((function(t){n&&n(t)}))},getPartialElementsMetadata:function(t,i,n){e.getPartialElementsMetadata(this._config,t).then((function(t){i&&i(t)})).catch((function(t){n&&n(t)}))},getPartialElementsMetadataFile:function(t){return e.getPartialElementsMetadataFile(this._config,t)},getDatabagResource:function(t){return e.getDatabagResource(this._config,t)},getManifest:function(t,i){e.getManifest(this._config).then((function(e){t&&t(e)})).catch((function(t){i&&i(t)}))},getNestedComponents:function(t,i){e.getNestedComponents(this._config).then((function(e){t&&t(e)})).catch((function(t){i&&i(t)}))},getObjectMap:function(t,i){e.getObjectMap(this._config).then((function(e){t&&t(e)})).catch((function(t){i&&i(t)}))},getWalkthrough:function(t,i){e.getWalkthrough(this._config).then((function(e){t&&t(e)})).catch((function(t){i&&i(t)}))},getProjectInfo:function(t,i){var n=this;e.getProjectInfo(n._config).then((function(e){t&&t(e,n._config.modelType)})).catch((function(t){i&&i(t)}))},getModelInfo:function(t,i){e.getModelInfo(this._config).then((function(e){t&&t(e)})).catch((function(t){i&&i(t)}))},getBimtileInfo:function(t,i,n,o){const s=`${this._config.relativeUrlWithoutDatabagId}/${t}`;e.getBimtileInfo(s,i).then((function(t){n&&n(t)})).catch((function(t){o&&o(t)}))},getFeatureStyle:function(t,i){e.getFeatureStyle(this._config).then((function(e){t&&t(e)})).catch((function(t){i&&i(t)}))},getDimensions:function(t,i,n){e.getDimensions(t,this._config).then((function(t){i&&i(t)})).catch((function(t){n&&n(t)}))}},t.OfflineDataManager=i}(),function(){var t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Data"),e=(t,e)=>Glodon$1.Web.Lang.Utility.HttpRequest.promiseJSONRequest(t,e,CLOUD$1.EnableStorage),i=Glodon$1.Web.Lang.Utility.HttpRequest.ajax,n={getMepSystem:function(t,i){if("integrateModel"==i.modelType)var n=`${i.resourceHost}/${i.databagId}/metadata/${t}/mepsystem.json`;else n=`${i.resourceHost}/${i.databagId}/metadata/mepsystem.json`;return e(n,"noCode")},getTreeNewData:function(t){var i=`${t.resourceHost}/${t.databagId}/data/tree.json`;return e(i,"noCode")},getTreeOldData:function(t){if("singleModel"==t.modelType)var i=`${t.APIHost}/data/v2/files/${t.modelId}/tree?v=2.0&view_token=${t.viewToken}`;else i=`${t.APIHost}/data/v2/integrations/${t.modelId}/tree?view_token=${t.viewToken}&treeType=specialty`;return e(i)},getDrawingList:function(t){t=t;return{fromSingleModel:function(i,n){var o=`${t.APIHost}/data/v2/files/${i}/drawingsheets?elementId=${n}&view_token=${t.viewToken}`;return e(o)},fromIntegrateModel:function(i,n,o){var s=`${t.APIHost}/data/v2/integrations/${i}/drawingsheets?fileIdHash=${n}&elementId=${o}&view_token=${t.viewToken}`;return e(s)}}},getAreas:function(t){if("singleModel"==t.modelType)var i=`${t.APIHost}/data/v2/files/${t.modelId}/floors?includeRoom=true&includeArea=true&view_token=${t.viewToken}`;else i=`${t.APIHost}/data/v2/integrations/${t.modelId}/floors?includeRoom=true&includeArea=true&view_token=${t.viewToken}`;return e(i)},getRoomProperty:function(t,i){if("singleModel"==i.modelType)var n=`${i.APIHost}/data/v2/files/${i.modelId}/rooms/${t}?view_token=${i.viewToken}`;else n=`${i.APIHost}/data/v2/integrations/${i.modelId}/rooms/${t}?view_token=${i.viewToken}`;return e(n)},getAreaProperty:function(t,i){if("singleModel"==i.modelType)var n=`${i.APIHost}/data/v2/files/${i.modelId}/areas/${t}?view_token=${i.viewToken}`;else n=`${i.APIHost}/data/v2/integrations/${i.modelId}/areas/${t}?view_token=${i.viewToken}`;return e(n)},getObjectData:function(t,i){if("singleModel"==t.modelType)var n=`${t.APIHost}/data/v2/files/${t.modelId}/elements/${i}?view_token=${t.viewToken}`;else if("integrateModel"==t.modelType){var o=i.split(".");if(1==o.length)n=`${t.APIHost}/data/v2/integrations/${t.modelId}/elements/${i}?view_token=${t.viewToken}`;else n=`${t.APIHost}/data/v2/integrations/${t.modelId}/files/${o[0]}/elements/${o[1]}?view_token=${t.viewToken}`}else n=`${t.APIHost}/data/v2/sections/${t.modelId}/elements/${i}?view_token=${t.viewToken}`;return e(n)},getFamilyData:function(t,i){let n=`${t.APIHost}/data/v2/rfaFiles/${t.modelId}/familyTypes/${i}?view_token=${t.viewToken}`;return e(n)},getEditedObjectData:function(t,i){if("singleModel"==t.modelType)var n=`${t.APIHost}/data/v2/files/${t.modelId}/elements/${i}?includeOverrides=true&view_token=${t.viewToken}`;else{var o=i.split(".");if(1==o.length)n=`${t.APIHost}/data/v2/integrations/${t.modelId}/elements/${i}?includeOverrides=true&view_token=${t.viewToken}`;else n=`${t.APIHost}/data/v2/integrations/${t.modelId}/files/${o[0]}/elements/${o[1]}?includeOverrides=true&view_token=${t.viewToken}`}return e(n)},getFiles:function(t){var i=`${t.APIHost}/data/v2/integrations/${t.modelId}/files?includeDrawingSheet=true&view_token=${t.viewToken}`;return e(i)},getMaterialOverride:function(t,i,n){i=null==i?n.viewToken:i,t=null==t?n.modelId:t;var o=`${n.APIHost}/data/v2/materialoverridesets/${t}?materialFormat=FULL_INSTANCE_JSON&sort=true&view_token=${i}&compact=true`;return e(o)},getLinkGraph:function(t){var i=`${t.APIHost}/data/v2/integrations/${t.modelId}/linkGraph?view_token=${t.viewToken}`;return e(i)},getMaterialProperty:function(t,i){if(i){var n=i.split(".");if("singleModel"==t.modelType)var o=`${t.APIHost}/data/v2/files/${t.modelId}/elements/${n[0]}/materials?view_token=${t.viewToken}`;else if("integrateModel"==t.modelType)o=`${t.APIHost}/data/v2/integrations/${t.modelId}/files/${n[0]}/elements/${n[1]}/materials?view_token=${t.viewToken}`;else o=`${t.APIHost}/data/v2/sections/${t.modelId}/elements/${i}/materials?view_token=${t.viewToken}`;return e(o)}failure&&failure({})},getDrawingsheets:function(t,i){var n=`${t.APIHost}/data/v2/files/${i}/drawingsheets?fileId=${i}&view_token=${t.viewToken}`;return e(n)},getAllDrawingsheets:function(t,i){var n=`${t.resourceHost}/${t.integrateDrawings&&t.integrateDrawings.databagId||t.databagId}/metadata/drawings.json`;return e(n,"noCode")},getLinksJson:function(t,i){var n=`${t.resourceHost}/${t.databagId}/metadata/links.json`;return e(n,"noCode")},getFloors:function(t){if("singleModel"==t.modelType)var i=`${t.APIHost}/data/v2/files/${t.modelId}/floors?view_token=${t.viewToken}`;else i=`${t.APIHost}/data/v2/integrations/${t.modelId}/floors?view_token=${t.viewToken}`;return e(i)},getElementByConditions:function(t,i,n){var o="";for(let t in n)o+=`&${t}=${n[t]}`;if("singleModel"==t.modelType)var s=`${t.APIHost}/data/element/id?fileId=${i}${o}&view_token=${t.viewToken}`;else s=`${t.APIHost}/data/v2/integrations/${i}/elementIds?view_token=${t.viewToken}${o}`;return e(s)},getComponentsByConditions:function(t,i,n,o,s){var r={targetIds:[String(i)],targetType:"integrateModel"===t.modelType?"integration":"file",query:{boolOr:[]}};for(let t=0;t<n.length;t++){let e=n[t],i={boolAnd:[]};for(let t in e)i.boolAnd.push({match:{["levelName"===t?"floor":t]:e[t]}});1==i.boolAnd.length&&i.boolAnd.push(i.boolAnd[0]),r.query.boolOr.push(i)}1==r.query.boolOr.length&&r.query.boolOr.push(r.query.boolOr[0]);var a=`${t.APIHost}/data/v2/query/elementIds?view_token=${t.viewToken}`;return e({url:a,type:"post",data:JSON.stringify(r),headers:{"Content-Type":"application/json"}})},getMaterialJson:function(t,i,n){return e({url:`https://apigate.glodon.com/ggpassets/materiallibrary/libraries/${i}/materials?materialIds=${n}&instance=true`,type:"get",data:null,headers:{Authorization:"Bearer "+t,"Content-Type":"application/json",engine:"COMMON"}})},getTextureJson:function(t,i,n){return e({url:`https://apigate.glodon.com/ggpassets/materiallibrary/libraries/${i}/resources/${n}`,type:"get",data:null,headers:{Authorization:"Bearer "+t,"Content-Type":"application/json",engine:"GGP"}})},getMapInfo:function(t,e){this._opt;var n={},o=[];this._helper;2===e||"integrateModel"!==t.modelType?i({url:`${t.resourceHost}/${t.databagId}/metadata/axisgrids/grids.json.gz`,async:!1,success:function(t){var e=CLOUD$1.AxisGridManager.adaptGridData(JSON.parse(t));n.Grids=e.grids}}):i({url:`${t.resourceHost}/${t.databagId}/metadata/grids.json`,async:!1,success:function(t){var e=JSON.parse(t);n.Grids=adaptMiniMapGridData(e.grids)}}),i({async:!1,url:`${t.resourceHost}/${t.databagId}/metadata/levels.json`,success:function(t){n.Levels=JSON.parse(t).levels}}),i({async:!1,url:`${t.resourceHost}/${t.databagId}/resource/model/maps/output.json`,dataType:"text",success:function(e){var i=JSON.parse(e);for(var n in i){var s=i[n];null==s.id&&(s.id=n),s.path=`${t.resourceHost}/${t.databagId}/resource/model/maps/${s.id}.png`,s.name=n,o.push(s)}}});let s=n.Levels;if(s){let t=t=>{let e=!1;return o.some((i=>(e=i.id.toString()===t.toString(),e))),e};for(let e=0;e<s.length;e++)t(s[e].id)||(s.splice(e,1),e--)}return{axisGrid:n,floors:o}},getMapInfoAsync:function(t,i){return new Promise(((n,o)=>{let s={Grids:[]},r=[];const a="integrateModel"===t.modelType&&2!==i,l=`${t.resourceHost}/${t.databagId}/metadata/${a?"grids.json":"axisgrids/grids.json.gz"}`;Promise.allSettled([e(l,"noCode"),e(`${t.resourceHost}/${t.databagId}/metadata/levels.json`,"noCode"),e(`${t.resourceHost}/${t.databagId}/resource/model/maps/output.json`,"noCode")]).then((e=>{let[i,o,l]=e;if(i.value)if(a)s.Grids=adaptMiniMapGridData(i.value.grids);else{var h=CLOUD$1.AxisGridManager.adaptGridData(i.value);s.Grids=h.grids}s.Levels=o.value.levels,(e=>{for(var i in e){var o=e[i];null==o.id&&(o.id=i),o.path=`${t.resourceHost}/${t.databagId}/resource/model/maps/${o.id}.png`,o.name=i,r.push(o)}let a=s.Levels;if(a){let t=t=>{let e=!1;return r.some((i=>(e=i.id.toString()===t.toString(),e))),e};for(let e=0;e<a.length;e++)t(a[e].id)||(a.splice(e,1),e--)}n({axisGrid:s,floors:r})})(l.value)})).catch(o)}))},getLevels:function(t,i){let n=`${i.resourceHost}/${i.databagId}/metadata/levels.json`;return t&&(n=`${i.resourceHost}/${i.databagId}/metadata/${t}/levels.json`),e(n,"noCode")},getViews:function(t){var e={data:null,resourceHost:t.resourceHost};return i({url:`${t.resourceHost}/${t.databagId}/metadata/views.json`,async:!1,success:function(t){e.data=t}}),e},getViewsById:function(t){var e={data:null,resourceHost:t.resourceHost};return i({url:`${t.resourceHost}/${t.databagId}/metadata/${t.fileId}/views.json`,async:!1,success:function(t){e.data=t}}),e},getViewData:function(t){let i=`${t.resourceHost}/${t.databagId}/metadata/viewStates/${t.viewId}.json`;return e(i,"noCode")},getRooms:function(t){let i=`${t.resourceHost}/${t.databagId}/metadata/rooms.json`;return e(i,"noCode")},getRoomBoundary:function(t,i){let n=`${i.resourceHost}/${i.databagId}/metadata/roomsboundary/${t}.json`;return e(n,"noCode")},getCategoryVisibility:function(t){var i=`${t.resourceHost}/${t.databagId}/metadata/categoryVisibility.json`;return e(i,"noCode")},getText:function(t){var i=`${t.resourceHost}/${t.databagId}/metadata/text.json`;return e(i,"noCode")},getScheduleList:function(t){var i=`${t.resourceHost}/${t.databagId}/metadata/schedule.json`;return e(i,"noCode")},getScheduleById:function(t,i){var n=`${i.resourceHost}/${i.databagId}/metadata/schedule/${t}.txt`;return e(n,"noCode")},getSegmentGroups:function(t){var i=`${t.APIHost}/data/v2/integrations/${t.modelId}/segmentGroups?view_token=${t.viewToken}`;return e(i,"noCode")},getSegmentFromGroups:function(t,i){var n=`${t.APIHost}/data/v2/integrations/${t.modelId}/segmentGroups/${i}/segments?view_token=${t.viewToken}`;return e(n,"noCode")},getSegmentTree:function(t){var i=`${t.APIHost}/data/v2/integrations/${t.modelId}/segmentTree?view_token=${t.viewToken}`;return e(i,"noCode")},getSegmentById:function(t,i){var n=`${t.APIHost}/data/v2/integrations/${t.modelId}/segments/${i}?view_token=${t.viewToken}`;return e(n,"noCode")},getSegmentElementIds:function(t,i){var n=`${t.APIHost}/data/v2/integrations/${t.modelId}/segments/${i}/elementIds?view_token=${t.viewToken}`;return e(n,"noCode")},getPartialElementsMetadata:function(t,i){var n=`${t.resourceHost}/${i}/metadata/partial_elements_metadata.json`;return e(n,"noCode")},getPartialElementsMetadataFile:function(t,e){return`${t.resourceHost}/${e}/metadata/partial_elements_metadata.json`},getDatabagResource:function(t,e){return`${t.resourceHost}/${e}/resource/v3/model`},getModelGroup:function(t,i){var n=`${t.resourceHost}/${t.databagId}/metadata/modelSetsTree.json`;return e(n,"noCode")},getManifest:function(t){var i=`${t.resourceHost}/${t.databagId}/manifest.json`;return e(i,"noCode")},getNestedComponents:function(t){var i=`${t.relativeUrl}/metadata/nestedComponents.json`;return e(i,"noCode")},getObjectMap:function(t){var i=`${t.relativeUrl}/metadata/objectMap.json.gz`;return e(i,"noCode")},getWalkthrough:function(t){var i=`${t.relativeUrl}/data_ext/walkthrough.json`;return e(i,"noCode")},getProjectInfo:function(t){var i=`${t.resourceHost}/${t.databagId}/metadata/project.json`;return e(i,"noCode")},getModelInfo:function(t){var i=`${t.relativeUrl}/resource/v3/model/config.json`;return e(i,"noCode")},getBimtileInfo:function(t,i){return e(`${t}/resource/v3/model/${i}`,"noCode")},getFeatureStyle:function(t){var i=`${t.relativeUrl}/resource/v3/model/featureStyle.json`;return e(i,"noCode")},getDimensions:function(t,i){let n=`${i.relativeUrl}/metadata/ModelDimensions.json`;return"integrateModel"==i.modelType&&(n=`${i.relativeUrl}/metadata/${t}/ModelDimensions.json`),e(n,"noCode")}};t.OnlineDataProdiver=n}(),function(){var t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Data"),e=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Data.OnlineDataProdiver");function i(t){this._config=t}i.prototype={getOfflineDataManager(){return this._offlineDatamanager=this._offlineDatamanager||new t.OfflineDataManager(this._config),this._offlineDatamanager},getComponentProperty:function(t,i,n){const o=this;if(!t)return console.warn("elementId must not be empty!."),void(n&&n());e.getObjectData(this._config,t).then((function(t){i&&i(t)})).catch((function(e){CLOUD$1.EnableStorage?o.getOfflineDataManager().getComponentProperty(t,i,n):n&&n(e)}))},getFamilyProperty:function(t,i,n){if(!t)return console.warn("familyTypeId must not be empty!."),void(n&&n());e.getFamilyData(this._config,t).then((function(t){i&&i(t)})).catch((function(t){n&&n(t)}))},getComponentOverriddenProperty:function(t,i,n){if(!t)return console.warn("elementId must not be empty!."),void(n&&n());e.getEditedObjectData(this._config,t).then((function(t){i&&i(t)})).catch((function(t){n&&n(t)}))},getMaterialProperty:function(t,i,n){var o=this;e.getMaterialProperty(this._config,t).then((function(t){i&&i(t)})).catch((function(e){CLOUD$1.EnableStorage?o.getOfflineDataManager().getMaterialProperty(t,i,n):n&&n(e)}))},getTreeOldData:function(t,i){var n=this;e.getTreeOldData(n._config).then((function(e){t&&t(e,n._config.modelType,"old")})).catch((function(t){i&&i(t)}))},getTreeNewData:function(t,i,n=!0){var o=this;e.getTreeNewData(o._config).then((function(e){t&&(!n&&t(e,o._config.modelType),n&&t(e.data,o._config.modelType))})).catch((function(t){i&&i(t)}))},getMepSystem:function(t,i,n){var o=this;e.getMepSystem(t,o._config).then((function(t){i&&i(t,o._config.modelType)})).catch((function(t){n&&n(t)}))},getAreas:function(t,i){e.getAreas(this._config).then((function(e){t&&t(e)})).catch((function(t){i&&i(t)}))},getRoomProperty:function(t,i,n){e.getRoomProperty(t,this._config).then((function(t){i&&i(t)})).catch((function(t){n&&n(t)}))},getDrawingList:function(t,i,n,o){var s=this._config.modelType;if("integrateModel"==s){var r=i.split(".")[0],a=i.split(".")[1];e.getDrawingList(this._config).fromIntegrateModel(t,r,a).then((function(t){n&&n(t)})).catch((function(t){o&&o(t)}))}else"singleModel"==s&&e.getDrawingList(this._config).fromSingleModel(t,i).then((function(t){n&&n(t)})).catch((function(t){o&&o(t)}))},getModelGroup:function(t,i){e.getModelGroup(this._config).then((function(e){t&&t(e)})).catch((function(t){i&&i(t)}))},getAreaProperty:function(t,i,n){e.getAreaProperty(t,this._config).then((function(t){i&&i(t)})).catch((function(t){n&&n(t)}))},getFiles:function(t,i){e.getFiles(this._config).then((function(e){t&&t(e)})).catch((function(t){i&&i(t)}))},getMaterialOverride:function(t,i,n,o){e.getMaterialOverride(t,i,this._config).then((function(t){n&&n(t)})).catch((function(t){o&&o(t)}))},getLinkGraph:function(t,i){e.getLinkGraph(this._config).then((function(e){t&&t(e)})).catch((function(t){i&&i(t)}))},getDrawingsheets(t,i,n,o){var s=this;t=t||s._config.modelId,e.getDrawingsheets(this._config,t).then((function(t){n&&n(t,s._config.modelType)})).catch((function(t){o&&o(t)}))},getAllDrawingsheets(t,i,n,o){var s=this;t=t||s._config.modelId,e.getAllDrawingsheets(this._config,t).then((function(t){n&&n(t,s._config.modelType)})).catch((function(t){o&&o(t)}))},getLinksJson(t,i,n,o){var s=this;t=t||s._config.modelId,e.getLinksJson(this._config,t).then((function(t){n&&n(t,s._config.modelType)})).catch((function(t){o&&o(t)}))},getFloors(t,i){e.getFloors(this._config).then((function(e){t&&t(e)})).catch((function(t){i&&i(t)}))},getElementByConditions(t,i,n,o){e.getElementByConditions(this._config,t,i).then((function(t){n&&n(t)})).catch((function(t){o&&o(t)}))},getComponentsByConditions(t,i,n,o){e.getComponentsByConditions(this._config,t,i).then((function(t){n&&n(t&&t[0].elementIds)})).catch((function(t){o&&o(t)}))},getMaterialJson(t,i,n,o,s){e.getMaterialJson(t,i,n).then((function(t){o&&o(t)})).catch((function(t){s&&s(t)}))},getTextureJson:function(t,i,n,o,s){e.getTextureJson(t,i,n).then((function(t){o&&o(t)})).catch((function(t){s&&s(t)}))},getMapInfo:function(t,i){var n=e.getMapInfo(this._config,i);t&&t(n)},getMapInfoAsync:function(t,i,n){e.getMapInfoAsync(this._config,n).then((function(e){t&&t(e)})).catch((function(t){i&&i(t)}))},getLevels:function(t,i,n){e.getLevels(t,this._config).then((function(t){i&&i(t)})).catch((function(t){n&&n(t)}))},getViews:function(t){var i=e.getViews(this._config);t&&t(i)},getViewsById:function(t,i){var n=this._config;n.fileId=t;var o=e.getViewsById(n);i&&i(o)},getViewData:function(t,i,n){var o=Object.assign({},this._config);o.viewId=t,e.getViewData(o).then((function(t){"[object Function]"===Object.prototype.toString.call(i)&&i(t)})).catch((function(t){"[object Function]"===Object.prototype.toString.call(n)&&n(t)}))},getRooms:function(t,i){e.getRooms(this._config).then((function(e){t&&t(e)})).catch((function(t){i&&i(t)}))},getRoomBoundary:function(t,i,n){e.getRoomBoundary(t,this._config).then((function(t){i&&i(t)})).catch((function(t){n&&n(t)}))},getCategoryVisibility:function(t,i){e.getCategoryVisibility(this._config).then((function(e){t&&t(e)})).catch((function(t){i&&i(t)}))},getText:function(t,i){e.getText(this._config).then((function(e){t&&t(e)})).catch((function(t){i&&i(t)}))},getScheduleList:function(t,i){e.getScheduleList(this._config).then((function(e){t&&t(e.scheduleList)})).catch((function(t){i&&i(t)}))},getScheduleById:function(t,i,n){e.getScheduleById(t,this._config).then((function(t){i&&i(t)})).catch((function(t){n&&n(t)}))},getSegmentGroups:function(t,i){e.getSegmentGroups(this._config).then((function(e){t&&t(e)})).catch((function(t){i&&i(t)}))},getSegmentFromGroups:function(t,i,n){e.getSegmentFromGroups(this._config,t).then((function(t){i&&i(t)})).catch((function(t){n&&n(t)}))},getSegmentTree:function(t,i){e.getSegmentTree(this._config).then((function(e){t&&t(e)})).catch((function(t){i&&i(t)}))},getSegmentById:function(t,i,n){e.getSegmentById(this._config,t).then((function(t){i&&i(t)})).catch((function(t){n&&n(t)}))},getSegmentElementIds:function(t,i,n){e.getSegmentElementIds(this._config,t).then((function(t){i&&i(t)})).catch((function(t){n&&n(t)}))},getPartialElementsMetadata:function(t,i,n){e.getPartialElementsMetadata(this._config,t).then((function(t){i&&i(t)})).catch((function(t){n&&n(t)}))},getPartialElementsMetadataFile:function(t){return e.getPartialElementsMetadataFile(this._config,t)},getDatabagResource:function(t){return e.getDatabagResource(this._config,t)},getDatabagResource:function(t){return e.getDatabagResource(this._config,t)},getManifest:function(t,i){e.getManifest(this._config).then((function(e){t&&t(e)})).catch((function(t){i&&i(t)}))},getNestedComponents:function(t,i){e.getNestedComponents(this._config).then((function(e){t&&t(e)})).catch((function(t){i&&i(t)}))},getObjectMap:function(t,i){e.getObjectMap(this._config).then((function(e){t&&t(e)})).catch((function(t){i&&i(t)}))},getWalkthrough:function(t,i){e.getWalkthrough(this._config).then((function(e){t&&t(e)})).catch((function(t){i&&i(t)}))},getProjectInfo:function(t,i){var n=this;e.getProjectInfo(n._config).then((function(e){t&&t(e,n._config.modelType)})).catch((function(t){i&&i(t)}))},getModelInfo:function(t,i){e.getModelInfo(this._config).then((function(e){t&&t(e)})).catch((function(t){i&&i(t)}))},getBimtileInfo:function(t,i,n,o){const s=`${this._config.relativeUrlWithoutDatabagId}/${t}`;e.getBimtileInfo(s,i).then((function(t){n&&n(t)})).catch((function(t){o&&o(t)}))},getFeatureStyle:function(t,i){e.getFeatureStyle(this._config).then((function(e){t&&t(e)})).catch((function(t){i&&i(t)}))},getDimensions:function(t,i,n){e.getDimensions(t,this._config).then((function(t){i&&i(t)})).catch((function(t){n&&n(t)}))}},t.OnlineDataManager=i}(),function(){let t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Data"),e=(Glodon$1.Web.Lang.Utility.HttpRequest,function(e){if(this._config=e,this._objectData=null,this._cache={},"Local"==e.dataEnvType?this.dataManager=new t.OfflineDataManager(e):this.dataManager=new t.OnlineDataManager(e),!e.viewToken)return!1});e.prototype={getFamilyTypes:function(t,e){this.dataManager.getFamilyTypes(t,e)},getComponentProperty:function(t,e,i){this.dataManager.getComponentProperty(t,e,i)},getFamilyProperty:function(t,e,i){this.dataManager.getFamilyProperty(t,e,i)},getComponentOverriddenProperty:function(t,e,i){this.dataManager.getComponentOverriddenProperty(t,e,i)},getDrawingList:function(t,e,i,n){this.dataManager.getDrawingList(t,e,i,n)},getTreeOldData:function(t,e){this.dataManager.getTreeOldData(t,e)},getTreeNewData:function(t,e,i=!1){this.dataManager.getTreeNewData(t,e,i)},getMepSystem:function(t,e,i){this.dataManager.getMepSystem(t,e,i)},getModeTree:function(t,e){console.warn("This function is deprecated. Please use getTreeOldData instead."),this.getTreeOldData(t,e)},getFloors:function(t,e){this.dataManager.getFloors(t,e)},getAreas:function(t,e){this.dataManager.getAreas(t,e)},getAreaProperty:function(t,e,i){this.dataManager.getAreaProperty(t,e,i)},getModelGroup:function(t,e){this.dataManager.getModelGroup(t,e)},getMaterialProperty:function(t,e,i){this.dataManager.getMaterialProperty(t,e,i)},getRoomProperty:function(t,e,i){this.dataManager.getRoomProperty(t,e,i)},getFiles:function(t,e){this.dataManager.getFiles(t,e)},getMaterialOverride:function(t,e,i,n){this.dataManager.getMaterialOverride(t,e,i,n)},getLinkGraph:function(t,e){this.dataManager.getLinkGraph(t,e)},getDrawingsheets:function(t,e,i,n){this.dataManager.getDrawingsheets(t,e,i,n)},getElementByConditions:function(t,e,i,n){this.dataManager.getElementByConditions(t,e,i,n)},getComponentsByConditions:function(t,e,i,n){this.dataManager.getComponentsByConditions(t,e,i,n)},getMaterialJson(t,e,i,n,o){this.dataManager.getMaterialJson(t,e,i,n,o)},getTextureJson:function(t,e,i,n,o){this.dataManager.getTextureJson(t,e,i,n,o)},getAllDrawingsheets:function(t,e,i,n){this.dataManager.getAllDrawingsheets(t,e,i,n)},getLinksJson:function(t,e,i,n){this.dataManager.getLinksJson(t,e,i,n)},getMapInfo:function(t,e){this.dataManager.getMapInfo(t,e)},getMapInfoAsync:function(t,e,i){this.dataManager.getMapInfoAsync(t,e,i)},getCategoryVisibility:function(t,e){this.dataManager.getCategoryVisibility(t,e)},getText:function(t,e){this.dataManager.getText(t,e)},getScheduleList:function(t,e){this.dataManager.getScheduleList(t,e)},getScheduleById:function(t,e,i){this.dataManager.getScheduleById(t,e,i)},getSegmentGroups:function(t,e){this.dataManager.getSegmentGroups(t,e)},getSegmentFromGroups:function(t,e,i){this.dataManager.getSegmentFromGroups(t,e,i)},getSegmentTree:function(t,e){this.dataManager.getSegmentTree(t,e)},getSegmentById:function(t,e,i){this.dataManager.getSegmentById(t,e,i)},getSegmentElementIds:function(t,e,i){this.dataManager.getSegmentElementIds(t,e,i)},getPartialElementsMetadata:function(t,e,i){this.dataManager.getPartialElementsMetadata(t,e,i)},getPartialElementsMetadataFile:function(t){return this.dataManager.getPartialElementsMetadataFile(t)},getDatabagResource:function(t){return this.dataManager.getDatabagResource(t)},getManifest:function(t,e){return this.dataManager.getManifest(t,e)},getNestedComponents:function(t){return this.dataManager.getNestedComponents(t)},getObjectMap:function(t){return this.dataManager.getObjectMap(t)},getWalkthrough:function(t){return this.dataManager.getWalkthrough(t)},getViews:function(t){return this.dataManager.getViews(t)},getViewData:function(t,e,i){return this.dataManager.getViewData(t,e,i)},getProjectInfo:function(t,e){this.dataManager.getProjectInfo(t,e)},getModelInfo:function(t,e){return this.dataManager.getModelInfo(t,e)},getBimtileInfo:function(t,e,i,n){return this.dataManager.getBimtileInfo(t,e,i,n)},getFeatureStyle:function(t,e){return this.dataManager.getFeatureStyle(t,e)},getDimensions:function(t,e,i){return this.dataManager.getDimensions(t,e,i)}},t.MetaDataManager=e}(),Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Data").FamilyDataManagerConfig=function(){return{resourceHost:hostConfig.resourceHost,databagId:null}},function(){let t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Data"),e=Glodon$1.Web.Lang.Utility.HttpRequest,i=function(t){if(!t.databagId)return!1;this.__config=t};i.prototype.getFamilyTypes=function(t,i){let n,o=this.__config;"Local"==o.dataEnvType?(n=`./${o.databagId}/metadata/familyInfo.json`,o.resourcePath&&(n=`${o.resourcePath}/${o.databagId}/metadata/familyInfo.json`)):n=`${o.resourceHost}/${o.databagId}/metadata/familyInfo.json`,e.ajax({url:n,success:function(e){var i=(e=JSON.parse(e)).Types||e.types;for(let t=0,e=i.length;t<e;t++)i[t].id=i[t].Id||i[t].id,i[t].name=i[t].Name||i[t].name,delete i[t].Id,delete i[t].Name;t&&t(i)},failure:t=>{var e=JSON.parse(t);i&&i(e)}})},t.FamilyDataManager=i}(),Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Data").IBLManagerConfig=function(){return{resourceHost:hostConfig.staticHost}},function(){let t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Data"),e=Glodon$1.Web.Lang.Utility.HttpRequest,i=function(t){this.__config=t};i.prototype.getIBLConfig=function(t,i){let n,o=this.__config;if("Local"==o.dataEnvType)return!1;n=`${o.resourceHost}/resources/IBL/IBLConfig.json`,e.ajax({url:n,success:function(e){var i=JSON.parse(e);t&&t(i)},failure:t=>{var e=JSON.parse(t);i&&i(e)}})},t.IBLManager=i}(),function(){let t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Data"),e=(Glodon$1.Web.Lang.Utility.HttpRequest,{version:1,EnumObjectTableIndex:{OTI_OBJECTS_VALUES:0,OTI_PROPERTY_SCHEMAS:1,OTI_ELEMENT_PROPERTIES:2,OTI_FAMILY_PROPERTIES:3,OTI_FAMILIES:4,OTI_ELEMENTS:5,OTI_BOUNDING_BOX:6,OTI_ELEMENTS_CLASS:7}}),i=function(t){this.url=t,this.objectsDB=[]};i.prototype={load:function(t){var e=this,i=["Values.json","Schemas.json","ElementProperties.json","FamilyTypeProperties.json","Families.json","Elements.json","BoundingBox.json"],n=i.length;i.forEach(((i,o)=>{const s=e.url+"/"+i+CLOUD.GlobalData.ZipResourcePostfix;CLOUD.Storage.IndexedDBHelper.loadWithStorage("InfoData",s,(()=>new Promise(((t,e)=>{(new THREE.FileLoader).load(s,t,void 0,e)}))),(e=>{this.objectsDB[o]=JSON.parse(e),0==(n-=1)&&t()}))}))},getFamilyTypeProperties:function(t){var i=this.objectsDB[e.EnumObjectTableIndex.OTI_FAMILIES][t];if(void 0===i)return null;for(var n=this.objectsDB[e.EnumObjectTableIndex.OTI_OBJECTS_VALUES],o=this.objectsDB[e.EnumObjectTableIndex.OTI_FAMILY_PROPERTIES],s=this.objectsDB[e.EnumObjectTableIndex.OTI_PROPERTY_SCHEMAS],r=0,a=0,l=0,h={},c=[],d=0,u=0,p=i[2],g=i[1];u<p;++u){a=4*o[r=2*(g+u)],l=o[r+1];var m=h[d=s[a]];void 0===m&&(m=[],h[d]=m,c.push(d)),m.push({key:n[s[a+1]],unit:n[s[a+3]],valueType:s[a+2],value:n[l]})}for(var f=[],w=(u=0,c.length);u<w;++u)d=c[u],f.push({group:n[d],items:h[d]});return f},getElementProperties:function(t){if(null==t)return null;var i=this.objectsDB[e.EnumObjectTableIndex.OTI_ELEMENTS][t];if(void 0===i)return null;for(var n=this.objectsDB[e.EnumObjectTableIndex.OTI_OBJECTS_VALUES],o=this.objectsDB[e.EnumObjectTableIndex.OTI_ELEMENT_PROPERTIES],s=this.objectsDB[e.EnumObjectTableIndex.OTI_PROPERTY_SCHEMAS],r=0,a=0,l=0,h={},c=[],d=0,u=0,p=i[2],g=i[1];u<p;++u){a=4*o[r=2*(g+u)],l=o[r+1];var m=h[d=s[a]];void 0===m&&(m=[],h[d]=m,c.push(d)),m.push({key:n[s[a+1]],unit:n[s[a+3]],valueType:s[a+2],value:n[l]})}for(var f=[],w=(u=0,c.length);u<w;++u)d=c[u],f.push({group:n[d],items:h[d]});var v=this.getFamilyTypeProperties(i[3]);if(!v)return f;var y={},b=[];for(var E of f=v.concat(f))if(y[E.group]){var C=[].concat.apply(y[E.group].items,E.items),x=[];for(var M of C){var P=!0;for(var I of x)M.key==I.key&&(P=!1);P&&x.push(M)}y[E.group]={group:y[E.group].group,items:x}}else y[E.group]=E;for(var E in y)"基本属性"==y[E].group?b.unshift(y[E]):b.push(y[E]);return b},getElementByConditions:function(t,i,n){var o=this.objectsDB[e.EnumObjectTableIndex.OTI_ELEMENTS_CLASS],s=Object.keys(i),r=[],a=[],l={},h={min:{x:null,y:null,z:null},max:{x:null,y:null,z:null}},c=[];for(let t of s)c.push({typeIndex:this._getGroupsKey(t,i[t],o),typeValue:i[t]});for(let t=0;t<o.groups.length;t+=3){let e=!0;for(let i of c){let n=o.groups[t][i.typeIndex];if(o.values[n]!=i.typeValue){e=!1;break}}if(e)if("singleModel"==n.modelType)r=r.concat(o.groups[t+1][""]);else{var d=o.groups[t+1],u=o.groups[t+2];for(var p in d)for(var g of d[p])a.push({fileId:p,elementId:g});(h.min.x>u[0]||null==h.min.x)&&(h.min.x=u[0]),(h.min.y>u[1]||null==h.min.y)&&(h.min.y=u[1]),(h.min.z>u[2]||null==h.min.z)&&(h.min.z=u[2]),(h.max.x<u[3]||null==h.max.x)&&(h.max.x=u[3]),(h.max.y<u[4]||null==h.max.y)&&(h.max.y=u[4]),(h.max.z<u[5]||null==h.max.z)&&(h.max.z=u[5])}}return"singleModel"==n.modelType?r:0==a.length?[]:(l.elements=a,l.boundingBox=h,l)},_getGroupsKey:function(t,e,i){var n=0;for(let e=0;e<i.keys.length;e++)if(i.keys[e]==t){n=e;break}return n},getBoundingBox:function(t){if(null==t)return null;var i=this.objectsDB[e.EnumObjectTableIndex.OTI_BOUNDING_BOX],n="";try{n={min:{x:i[t][0],y:i[t][1],z:i[t][2]},max:{x:i[t][3],y:i[t][4],z:i[t][5]}}}catch(t){console.log("no boundingBox Data"),n=""}return n}},t.ObjectPropertyManager=i}(),Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Data").FileManagerConfig=function(){return{APIHost:hostConfig.APIHost,resourceHost:hostConfig.resourceHost,viewToken:null,modelId:null,modelType:"singleModel",dataEnvType:hostConfig.dataEnvType||"BIMFACE"}},function(){let t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Data"),e=Glodon$1.Web.Lang.Utility.HttpRequest,i=function(t){this.__config=t};i.prototype.getViewToken=function(t,i,n){let o,s=this.__config;if("singleModel"==s.modelType)return!1;"Local"!=s.dataEnvType?(o=`${s.APIHost}/data/v2/integrations/${s.modelId}/files/${t}/viewToken?view_token=${s.viewToken}`,e.ajax({url:o,type:"post",success:function(t){var e=JSON.parse(t);i&&i(e.data)},failure:t=>{var e=JSON.parse(t);n&&n(e)}})):i&&i()},t.FileManager=i}(),function(){var t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Viewer");t.ViewerPDFConfig=class{constructor(){const t={domElement:null,resourceHost:hostConfig.resourceHost,staticHost:hostConfig.staticHost+"/api/Glodon",APIHost:hostConfig.APIHost,securityApi:hostConfig.securityApi,sdkUrl:null,staticPath:"/api/Glodon"};for(let e in t)this[e]=t[e]}}}(),function(){let t=Object.freeze({ViewLoaded:"ViewLoaded",ViewLoading:"ViewLoading",ViewMoved:"ViewMoved",ViewZoomed:"ViewZoomed"});Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Viewer").ViewerPDFEvent=t}(),function(){let t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Viewer"),e=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.Dom"),i=Glodon$1.Web.Lang.Utility.ClientHelper.isWebGLAvailable(),n=(Object.freeze({TranslucentOthers:"",HideOthers:""}),function(){let t=new Glodon$1.Web.Lang.EventManager;this.viewerType="Viewer",this.isFullScreen=!1,this._defaultUnit=void 0,this.getEventManager=function(){return t}});n.prototype.destroy=function(){this.getEventManager=null},n.prototype.init=function(){},n.prototype.getViewerType=function(t){return this.viewerType},n.prototype.addView=function(t,e,n){if(!i)return;let o=this,s=Glodon$1.Bimface.Authentication.AuthenticationManager,r=(o._opt,new Glodon$1.Bimface.Authentication.AuthenticationConfig);r.viewToken=t,r.APIHost=this._opt.APIHost,r.enableStorage=this.enableStorage,r.securityApi=this._opt.securityApi,(this.authenticate=new s(r)).authenticate((function(t){"bimView"==t.renderType&&("pdf-transfer"!==t.workerType?t.renderType="3DView":t.renderType="pdfView"),o.loadViewCore(t,e,n)}),(function(t){var e=Glodon$1.Bimface.Viewer.Viewer3DEvent;o.getEventManager().fireEvent(e.Error,t)}))},n.prototype.loadViewCore=function(){},n.prototype.addEventListener=function(t,e,i){this.getEventManager().addEvent(t,e,i)},n.prototype.removeEventListener=function(t,e){this.getEventManager().removeEvent(t,e)},n.prototype.enableFullScreen=function(t){var e=this._opt.domElement,i=this;this.isFullScreen=t,t?Glodon$1.Web.Lang.Utility.FullScreen.fullScreen(e):Glodon$1.Web.Lang.Utility.FullScreen.exitFullScreen(),setTimeout((function(){i.resize()}),200)},n.prototype._loadNotSuportPromptPage=function(t){let i=e.create("div","bf-waring-container"),n=e.create("div","bf-waring"),o=e.create("span","bf-waring-icon"),s=e.create("span","bf-waring-text");s.innerText=BimfaceLanguage.bf_browser_notSupported,n.appendChild(o),n.appendChild(s),i.appendChild(n);let r=e.create("div","bf-suggestion");r.innerText=BimfaceLanguage.bf_browser_suggestion,i.appendChild(r);let a=e.create("div","bf-logo");i.appendChild(a),t.appendChild(i)},n.prototype.getUnit=function(){return"m"===this._defaultUnit?Glodon$1.Bimface.Common.Units.LengthUnits.Meter:Glodon$1.Bimface.Common.Units.LengthUnits.Millimeter},n.prototype.getNetwork=function(){const t=window.performance;if(!t)return function(){console.log("您的浏览器不支持performance属性")};const e=[];function i(t,e){const i=t.timing,n={timing:t.timing};return n.redirectTime=i.redirectEnd-i.redirectStart,n.lookupDomainTime=i.domainLookupEnd-i.domainLookupStart,n.connectTime=i.connectEnd-i.connectStart,n.requestTime=i.responseEnd-i.responseStart,n.domReadyTime=i.domComplete-i.domInteractive,n.whiteTime=i.responseStart-i.navigationStart,n.domLoadTime=i.domContentLoadedEventEnd-i.navigationStart,n.loadTime=i.loadEventEnd-i.navigationStart,n.resourceTiming=function(t){const e={entries:t.length,transferSize:0,encodedBodySize:0,decodedBodySize:0};let i=1/0,n=-1/0;return t.forEach((t=>{void 0!==t.duration&&void 0!==t.startTime&&(i=Math.min(i,t.startTime),n=Math.max(n,t.startTime+t.duration)),t.transferSize&&(e.transferSize+=t.transferSize),t.encodedBodySize&&(e.encodedBodySize+=t.encodedBodySize),t.decodedBodySize&&(e.decodedBodySize+=t.decodedBodySize)})),e.transferSize&&(e.transferSize=e.transferSize/1048576),e.encodedBodySize&&(e.encodedBodySize=e.encodedBodySize/1048576),e.decodedBodySize&&(e.decodedBodySize=e.decodedBodySize/1048576),e.finishTime=8*Math.ceil((n-i)/8),e}(e),n.requests=n.resourceTiming.entries,n.transferred=n.resourceTiming.transferSize,n.resourcesSize=n.resourceTiming.decodedBodySize,n.finishTime=n.resourceTiming.finishTime,n}return new PerformanceObserver((t=>{for(let i of t.getEntries())e.push(i)})).observe({entryTypes:["resource","navigation","longtask"]}),function(){return i(t,e)}}(),t.Viewer=n}(),function(){const t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Viewer"),e=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.Dom");class i extends t.Viewer{constructor(t){super(),this._cloudViewer=CLOUD$1.PdfCore,this._opt=t,this._domElement=t.domElement,this._views={},this.setWorkerUrl(),this.setCMapUrl()}setWorkerUrl(){this._cloudViewer.setWorkerUrl(window.BimfaceLoaderConfig.fullStaticHost+"/bimface.pdf.worker.js")}setCMapUrl(){this._cloudViewer.setCMapUrl(window.BimfaceLoaderConfig.fullStaticHost+"/cmaps/")}loadViewCore(t,e,i){this._data=t,this._pdfName=t.name,this._loadPdf()}_loadPdf(){this._getManifest((i=>{this._pdfFileName=i.Metadata.Name;var n=new CLOUD$1.PdfCore.ViewConfig;n.domElement=this._domElement,n.pdfUrl=this._getPdfUrl();const o=CLOUD$1.PdfCore.addView(n);this._views[o]=CLOUD$1.PdfCore.views[o];let s=e.create("div","bf-loading");s.style.zIndex=100;let r=e.create("div","bf-loading-gif"),a=e.create("div","bf-loading-progress");a.innerText="0%",s.appendChild(r),s.appendChild(a);let l=this._domElement.querySelector(".bf-pdf-outer");l.appendChild(s),this._views[o].eventBus.on(CLOUD$1.PdfCore.ViewEvent.ViewLoading,(e=>{this.getEventManager().fireEvent(t.ViewerPDFEvent.ViewLoading),a.innerText=e})),this._views[o].eventBus.on(CLOUD$1.PdfCore.ViewEvent.ViewLoaded,(()=>{this.getEventManager().fireEvent(t.ViewerPDFEvent.ViewLoaded),l.removeChild(s)})),this._views[o].eventBus.on(CLOUD$1.PdfCore.ViewEvent.ViewMoved,(e=>{this.getEventManager().fireEvent(t.ViewerPDFEvent.ViewMoved,e)})),this._views[o].eventBus.on(CLOUD$1.PdfCore.ViewEvent.ViewZoomed,(e=>{this.getEventManager().fireEvent(t.ViewerPDFEvent.ViewZoomed,e)})),void 0===this._defaultViewId&&(this._defaultViewId=o),void 0===this._view&&(this._view=this._views[this._defaultViewId])}))}_getPdfUrl(){const t=this._getMetaDataManager()._config.resourceHost,e=this._data.databagId;return this._pdfUrl=`${t}/${e}/${this._manifest.Metadata.Path}/${this._pdfFileName}`,this._pdfUrl}_getManifest(t){if(this._manifest)return void("[object Function]"===Object.prototype.toString.call(t)&&t(this._manifest));this._getMetaDataManager().getManifest((e=>{this._manifest=e,"[object Function]"===Object.prototype.toString.call(t)&&t(this._manifest)}))}_getMetaDataManager(){if(this._metaDataManager)return this._metaDataManager;const t=new Glodon$1.Bimface.Data.MetaDataManagerConfig;t.viewToken=this._data.viewToken,t.databagId=this._data.databagId,t.resourceHost=this._opt.resourceHost,t.APIHost=this._opt.APIHost;const e=new Glodon$1.Bimface.Data.MetaDataManager(t);return this._metaDataManager=e,e}getViewer(){return this._cloudViewer}getView(t){return void 0===t&&(t=this._defaultViewId),this._views[t]}getDomElement(){return this._domElement}getPageCount(){return this._view.numPages}getCurrentPageNo(){return this._view.currentPageNo}destroy(){for(let t in this._views)this._cloudViewer.removeView(t);this._views={},delete this._data,delete this._pdfName,delete this._pdfFileName,delete this._view,delete this._defaultViewId,delete this._pdfUrl,delete this._metaDataManager,delete this._manifest}load(t){this.addView(t)}setDragMode(t){this.getView(t).setDragMode()}setTextMode(t){this.getView(t).setTextMode()}zoomIn(t){this.getView(t).viewZoom.zoomIn()}zoomOut(t){this.getView(t).viewZoom.zoomOut()}setZoom(t,e){t=t||1,this.getView(e).viewZoom.setZoom(t)}nextPage(t){this.getView(t).viewPageTurning.nextPage()}previousPage(t){this.getView(t).viewPageTurning.previousPage()}turnToPage(t,e){t=t||1,this.getView(e).viewPageTurning.turnTo(t)}fullScreen(t){this.getView(t).viewFullScreen.fullScreen()}exitFullScreen(t){this.getView(t).viewFullScreen.exit()}worldToClient(t){var e=this.getView().toScreenPoint([t.x,t.y]);return{x:e[0],y:e[1]}}clientToWorld(t){var e=this.getView().toWorldPoint([t.x,t.y]);return{x:e[0],y:e[1]}}resize(){}getCurrentState(){var t={viewId:this._defaultViewId,currentPageNo:this.getView(this._defaultViewId).currentPageNo,zoom:this.getView(this._defaultViewId).viewZoom.zoom,marginTop:this.getView(this._defaultViewId).viewDrag.getMarginTop(),marginLeft:this.getView(this._defaultViewId).viewDrag.getMarginLeft()};return JSON.stringify(t)}setState(t){let{viewId:e,currentPageNo:i,zoom:n,marginTop:o,marginLeft:s}=JSON.parse(t);this.turnToPage(i),this.getView(e).viewZoom.setZoom(n),this.getView(e).viewDrag.setMarginTop(o),this.getView(e).viewDrag.setMarginLeft(s)}}t.ViewerPDF=i}(),Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins").MiniMapConfig=function(){return{name:"defaultMap",domElement:null,width:240,height:240,viewer:null,axis:!1,host:hostConfig.resourceHost,onCameraChanged:null,inMoveOnAxisGrid:null}},function(){var t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins"),e=(Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.Dom"),Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.HttpRequest")),i=function(t){var e=this,i=t;if(e._opt=i,!i.domElement)return console.log("domElement must not be empty."),!1;if(!i.viewer)return console.log("viewer is not defined."),!1;var n=i.viewer.getViewer();e._helper=new CLOUD$1.Extensions.MiniMapHelper(i.viewer.getViewer());n.addCallbacks("render",(function(){e._helper.renderMiniMap()})),e.init()};i.prototype={init:function(){var t=this,i=t._opt,n={},o=[];t._helper;e.ajax({url:`${i.host}/${i.viewer._data.databagId}/metadata/grids.json`,async:!1,success:function(t){for(var e=JSON.parse(t),i=[],o=0,s=e.grids.length;o<s;o++){var r=e.grids[o];r.start.X=r.start.x,r.start.Y=r.start.y,r.start.Z=r.start.z,r.end.X=r.end.x,r.end.Y=r.end.y,r.end.Z=r.end.z,i.push(r)}n.Grids=i}}),e.ajax({async:!1,url:`${i.host}/${i.viewer._data.databagId}/metadata/levels.json`,success:function(t){n.Levels=JSON.parse(t).levels}}),e.ajax({async:!1,url:`${i.host}/${i.viewer._data.databagId}/resource/model/maps/output.json`,dataType:"text",success:function(t){var e=JSON.parse(t);for(var n in e){var s=e[n];null==s.id&&(s.id=n),s.path=`${i.host}/${i.viewer._data.databagId}/resource/model/maps/${s.id}.png`,s.name=n,o.push(s)}}}),t._floors=o,t.createMap(n,o)},createMap:function(t,e){var i=this._helper,n=this._opt;i.createMiniMap(n.name,n.domElement,n.width,n.height,{left:0,bottom:0,outling:"none",position:"relative"},n.onCameraChanged,n.inMoveOnAxisGrid),t.Grids&&t.Levels&&i.setAxisGridData(n.name,t),e.length>0&&(i.setAllFloorPlaneData(n.name,e),i.setFloorPlaneId(n.name,e[0].name)),i.generateAxisGrid(n.name),i.generateFloorPlane(n.name,!1),i.showAxisGrid(n.name,n.axis),i.getMiniMap(n.name).setMapClickCallback((function(){}))},getFloors:function(){return this._floors},showAxisGrid:function(){this._helper.showAxisGrid(this._opt.name,!0)},hideAxisGrid:function(){this._helper.showAxisGrid(this._opt.name,!1)},showFloorById:function(t){var e=this,i=e._opt.name;e._helper.setFloorPlaneData(i,t),e._helper.generateFloorPlane(i,!0)},resize:function(t,e){this._helper.resize(this._opt.name,t,e)},onClick:function(t,e){var i=this._opt,n=(t=t||"default",this._helper.getMiniMap(i.name));n.setMapClickMode(t),n.setMapClickCallback((function(t){e&&"function"==typeof e&&e(t)}))},toLocation:function(t,e){var i=this._opt;this._helper.getMiniMap(i.name).toLocation(t,e)},imageCoord2WordCoord:function(t,e){var i=this._opt;return this._helper.getMiniMap(i.name).imageCoord2WordCoord({x:t,x:e})}},t.MiniMap=i}(),Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Map").MapConfig=function(){return{id:"defaultMap",name:"defaultMap",domElement:null,viewer:null,width:240,height:240,isShowGrid:!1,navigationMode:"Default",resourceHost:hostConfig.resourceHost,loadAsync:!1}},function(){let t=Object.freeze({ViewerCameraChanged:"ViewerCameraChanged",MouseClicked:"MouseClicked",MouseHoveredGrid:"MouseHoveredGrid",SelectionChanged:"SelectionChanged",SelectionMoved:"SelectionMoved",SelectionEditor:"SelectionEditor",FloorPlaneChanged:"FloorPlaneChanged",Zoom:"Zoom"});Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Map").MapEvents=t}(),function(){let t=Object.freeze({Default:"Default",Static:"Static"});Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Map").MapNavigationMode=t}();
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */
var extendStatics=function(t,e){return extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])},extendStatics(t,e)};function __extends(t,e){function i(){this.constructor=t}extendStatics(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}var EditorName,DrawableItem=function(){function t(){this.xmlns="http://www.w3.org/2000/svg",this.material=null,this.svgNode=null,this.children=[],this.glodonColor="#11DAB7",this.position=new THREE.Vector2}return t.prototype.add=function(t){this.children.push(t)},t.prototype.getSvgNode=function(){return this.svgNode},t.prototype.abtainRenderables=function(t){t.appendChild(this.svgNode)},t.prototype.isMatch=function(t){return this.name==t},t.prototype.highlight=function(){this.svgNode.setAttribute("style","stroke:"+this.glodonColor)},t.prototype.cancelHighlight=function(){this.svgNode.setAttribute("style","stroke:"+this.material.color.getStyle())},t.prototype.locate=function(t,e){this.position.set(t,e),this.move(0,0)},t.prototype.move=function(t,e){var i=this.position.x+t,n=this.position.y+e;this.svgNode.setAttribute("transform","translate("+i+","+n+")")},t}(),Algorithm=function(){function t(){this._boxSize=new THREE.Vector2,this._boxCenter=new THREE.Vector2,this._intersect=new THREE.Vector3}return t.prototype.cross=function(t,e,i,n){return(e.x-t.x)*(n.y-i.y)-(e.y-t.y)*(n.x-i.x)},t.prototype.getArea=function(t,e,i){return this.cross(t,e,t,i)},t.prototype.getAbsArea=function(t,e,i){return Math.abs(this.getArea(t,e,i))},t.prototype.getInterPoint=function(t,e,i,n){var o=this.getAbsArea(t,e,i),s=this.getAbsArea(t,e,n);return new THREE.Vector2((n.x*o+i.x*s)/(o+s),(n.y*o+i.y*s)/(o+s))},t.prototype.isAngleGreaterThanPi=function(t,e,i){var n=new THREE.Vector3;return n.crossVectors(t,e),!(n.dot(i)>=0)},t.prototype.normalizedPointToScreen=function(t,e){t.x=t.x*e.width,t.y=-t.y*e.height},t.prototype.screenToNormalizedPoint=function(t,e){t.x=t.x/e.width,t.y=-t.y/e.height},t.prototype.normalizedPointToWorld=function(t,e){e.getSize(this._boxSize),t.x=.5*(t.x+1)*this._boxSize.x+e.min.x,t.y=.5*(t.y+1)*this._boxSize.y+e.min.y},t.prototype.worldToNormalizedPoint=function(t,e){e.getSize(this._boxSize),t.x=(t.x-e.min.x)/this._boxSize.x*2-1,t.y=(t.y-e.min.y)/this._boxSize.y*2-1},t.prototype.toWorldPoint=function(t,e,i,n){t.x<0&&(t.x=0),t.x>e&&(t.x=e),t.y<0&&(t.y=0),t.y>i&&(t.y=i),t.x=t.x/e*2-1,t.y=-t.y/i*2+1,this.normalizedPointToWorld(t,n)},t.prototype.getCuttingBoxOnCanvas=function(t,e,i,n){var o=new THREE.Box3,s=new THREE.Vector2(t.x,t.y),r=new THREE.Vector2(e.x,e.y);this.toWorldPoint(s,i[0],i[1],n),this.toWorldPoint(r,i[0],i[1],n);var a=[];return a.push(new THREE.Vector3(s.x,s.y)),a.push(new THREE.Vector3(s.x,s.y)),a.push(new THREE.Vector3(s.x,r.y)),a.push(new THREE.Vector3(s.x,r.y)),a.push(new THREE.Vector3(r.x,r.y)),a.push(new THREE.Vector3(r.x,r.y)),a.push(new THREE.Vector3(r.x,s.y)),a.push(new THREE.Vector3(r.x,s.y)),o.setFromPoints(a),{min:{x:o.min.x,y:o.min.y,z:0},max:{x:o.max.x,y:o.max.y,z:0}}},t.prototype.canvasPointToClient=function(t,e){var i=e.mapContainer;if(!i||!e.floorPlaneBox)return null;var n=this.getContainerOffsetToClient(i);if(0===n.width||0===n.height)return null;var o=new THREE.Vector2;return o.x=t.x+n.left,o.y=t.y+n.top,o},t.prototype.getMainSceneMatrix=function(t){return t.getScene().getMatrixGlobal()},t.prototype.transformWorldPoint=function(t,e){var i=this.getMainSceneMatrix(t);e.applyMatrix4(i)},t.prototype.expandBbox=function(t,e){var i=t.getCenter(this._boxCenter);t.getSize(this._boxSize);var n=new THREE.Vector2,o=e,s=this._boxSize.x/this._boxSize.y,r=this._boxSize.x,a=this._boxSize.y;s>o?a=r/o:s<o&&(r=a*o),n.set(r,a),t.setFromCenterAndSize(i,n)},t.prototype.containsPointInMainScene=function(t,e){var i=t.getScene().getBoundingBoxWorld();return!!i&&i.containsPoint(e)},t.prototype.isMouseOverCanvas=function(t,e,i){if(t){var n=this.getContainerOffsetToClient(t),o=new THREE.Vector2;if(o.x=i.x-n.left,o.y=i.y-n.top,0===n.width||0===n.height)return!1;var s={width:e[0],height:e[0]};if(o.x>0&&o.x<s.width&&o.y>0&&o.y<s.height)return!0}return!1},t.prototype.normalizePoint=function(t,e,i){var n=new THREE.Vector2;if(t){var o=this.getContainerOffsetToClient(t),s=new THREE.Vector2;s.x=i.x-o.left,s.y=i.y-o.top;var r={width:e[0],height:e[1]};if(s.x>0&&s.x<r.width&&s.y>0&&s.y<r.height)return n.x=s.x/r.width*2-1,n.y=-s.y/r.height*2+1,new THREE.Vector2(n.x,n.y)}return null},t.getIntersectionByPoint=function(t,e,i){void 0===i&&(i=3);for(var n=null,o=i*i,s=0,r=t.length;s<r;s++){var a=t[s].intersectionPoint;if(a)if(a.distanceToSquared(e)<o){n=t[s];break}}return n},t.prototype.flyToPointWithParallelEye=function(t,e){t.cameraControl.flyToPointWithParallelEye(e)},t.prototype.getIntersectionToMinDistance=function(t,e){if(t.length<1)return null;for(var i=0,n=0,o=0,s=t.length;o<s;o++){var r=t[o];if(r.intersectionPoint){var a=new THREE.Vector2(r.intersectionPoint.x,r.intersectionPoint.y).distanceToSquared(e);0==i?i=a:i>a&&(i=a,n=o)}}return t[n]},t.prototype.getAxisGridInfoByNormalizedPoint=function(t,e){var i=e.clone(),n=t.naviData.getAxisGridBox2D();this.normalizedPointToWorld(i,n);var o=e.clone(),s={width:t.svgHalfWidth,height:t.svgHalfHeight};this.normalizedPointToScreen(o,s);var r=this.getIntersectionToMinDistance(t.naviData.getAxisGridIntersectionPoints(),o);if(r&&r.intersectionPoint){var a=new THREE.Vector2(r.intersectionPoint.x,r.intersectionPoint.y);this.screenToNormalizedPoint(a,s),this.normalizedPointToWorld(a,n);var l=Math.round(i.x-a.x),h=Math.round(i.y-a.y);return{position:i,abcName:r.abcName,numeralName:r.numeralName,offsetX:l,offsetY:h}}return{position:new THREE.Vector3,abcName:"",numeralName:"",offsetX:"",offsetY:""}},t.prototype.getAxisGridInfoByPoint=function(t,e){var i=this.getMainSceneMatrix(t.viewer),n=new THREE.Matrix4;n.copy(i).invert();var o=e.clone();o.applyMatrix4(n);var s=o.clone(),r={width:t.svgHalfWidth,height:t.svgHalfHeight},a=t.naviData.getAxisGridBox2D();this.worldToNormalizedPoint(s,a),this.normalizedPointToScreen(s,r);var l=this.getIntersectionToMinDistance(t.naviData.getAxisGridIntersectionPoints(),s);if(l&&l.intersectionPoint){var h=new THREE.Vector2(l.intersectionPoint.x,l.intersectionPoint.y);this.screenToNormalizedPoint(h,r),this.normalizedPointToWorld(h,a);var c=Math.round(o.x-h.x),d=Math.round(o.y-h.y);return{position:o,abcName:l.abcName,numeralName:l.numeralName,offsetX:c,offsetY:d}}return{position:new THREE.Vector3,abcName:"",numeralName:"",offsetX:"",offsetY:""}},t.prototype.calculateEdgePositionCameraOutBounds=function(t,e,i){var n=function(t,e){for(var i=!1,n=0,o=t.length;n<o;n++)if(this.isEqualBetweenPoints(e,t[n],this.epsilon)){i=!0;break}return i},o=i.clone();if(o.min.x-=.5,o.min.y-=.5,o.max.x+=.5,o.max.y+=.5,!o.containsPoint(t)){var s=[],r=new THREE.Vector3(t.x,t.y,0),a=new THREE.Ray(r,e),l=new THREE.Vector3(i.min.x,i.min.y,0),h=new THREE.Vector3(-1,0,0),c=new THREE.Plane;if(c.setFromNormalAndCoplanarPoint(h,l),a.intersectPlane(c,this._intersect),this._intersect&&o.containsPoint(this._intersect)&&s.push(this._intersect),l.set(i.max.x,i.max.y,0),h.set(-1,0,0),c.setFromNormalAndCoplanarPoint(h,l),a.intersectPlane(c,this._intersect),this._intersect&&o.containsPoint(this._intersect)&&s.push(this._intersect),l.set(i.min.x,i.min.y,0),h.set(0,1,0),c.setFromNormalAndCoplanarPoint(h,l),a.intersectPlane(c,this._intersect),this._intersect&&o.containsPoint(this._intersect)&&(n(this._intersect,s)||s.push(this._intersect)),l.set(i.max.x,i.max.y,0),h.set(0,1,0),c.setFromNormalAndCoplanarPoint(h,l),a.intersectPlane(c,this._intersect),this._intersect&&o.containsPoint(this._intersect)&&(n(this._intersect,s)||s.push(this._intersect)),2!=s.length)return null;var d=s[0],u=s[1].clone().sub(d).normalize();return this.isEqualBetweenPoints(u,e,1e-5)?s[0]:s[1]}return null},t.prototype.getContainerOffsetToClient=function(t){var e,i;if(t!=document){var n=(i=t).getBoundingClientRect?function(t){var e=t.getBoundingClientRect(),i=document.body,n=document.documentElement,o=n.clientTop||i.clientTop,s=n.clientLeft||i.clientLeft,r=e.top-o,a=e.left-s;return{top:Math.round(r),left:Math.round(a)}}(i):function(t){for(var e=0,i=0;t;)e+=t.offsetTop,i+=t.offsetLeft,t=t.offsetParent;var n=document.body,o=document.documentElement;return{top:e-=window.pageYOffset||o.scrollTop||n.scrollTop,left:i-=window.pageXOffset||o.scrollLeft||n.scrollLeft}}(i);e={width:t.offsetWidth,height:t.offsetHeight,left:n.left,top:n.top}}else e={width:window.innerWidth,height:window.innerHeight,left:0,top:0};return e},t.prototype.isEqualBetweenPoints=function(t,e,i){i=i||1e-4;var n=t.x-e.x,o=t.y-e.y;return!(Math.sqrt(n*n+o*o)>i)},t}(),GridLine=function(t){function e(e,i,n,o){var s=t.call(this)||this;return s.start=e,s.end=i,s.material=n,s.name=o,s.build(),s}return __extends(e,t),e.prototype.build=function(){var t=document.createElementNS(this.xmlns,"line");t.setAttribute("x1",this.start.x),t.setAttribute("y1",this.start.y),t.setAttribute("x2",this.end.x),t.setAttribute("y2",this.end.y);var e=this.material;e instanceof THREE.LineBasicMaterial&&t.setAttribute("style","fill: none; stroke: "+e.color.getStyle()+"; stroke-width: "+e.linewidth+"; stroke-opacity: "+e.opacity+"; stroke-linecap: "+e.linecap+"; stroke-linejoin: "+e.linejoin),this.svgNode=t},e}(DrawableItem),GridLineArc=function(t){function e(e,i,n){var o=t.call(this)||this;return o.arcPoints=e,o.material=i,o.name=n,o.build(),o}return __extends(e,t),e.prototype.build=function(){var t=document.createElementNS(this.xmlns,"polyline");t.setAttribute("points",this.arcPoints.map((function(t){return t.x+","+t.y})).join(" "));var e=this.material;e instanceof THREE.LineBasicMaterial&&t.setAttribute("style","fill: none; stroke: "+e.color.getStyle()+"; stroke-width: "+e.linewidth+"; stroke-opacity: "+e.opacity+"; stroke-linecap: "+e.linecap+"; stroke-linejoin: "+e.linejoin),this.svgNode=t},e}(DrawableItem),TipText=function(t){function e(e,i){var n=t.call(this)||this;return n.center=e,n.literal=i,n.fontSize=8,n.textColor=new THREE.Color(.6,.6,.6),n.build(),n}return __extends(e,t),e.prototype.build=function(){var t=this.center.x,e=this.center.y;if("NaN"!=t.toString()&&"NaN"!=e.toString()){var i=document.createElementNS(this.xmlns,"text");i.setAttribute("style","font-size:"+this.fontSize+"px; fill: none; stroke: "+this.textColor.getStyle()+"; stroke-width: 1"),i.innerHTML=this.literal,i.textContent=this.literal;i.getBoundingClientRect();var n=t-3.5,o=e+2.8;this.svgNode=i,this.locate(n,o)}},e}(DrawableItem),AxisNotation=function(t){function e(e,i){var n=t.call(this)||this;return n.name=i,n.labelPoints=e,n.build(),n}return __extends(e,t),e.prototype.build=function(){var t=this;this.labelPoints.forEach((function(e){t.add(new TipText(e,t.name))}))},e.prototype.abtainRenderables=function(t){for(var e=0;e<this.children.length;e++){this.children[e].abtainRenderables(t)}},e.prototype.move=function(t,e){this.children.forEach((function(i){i.move(t,e)}))},e}(DrawableItem),AxisGrid=function(t){function e(e,i,n,o){var s=t.call(this)||this;return s.intersections=[],s.lineElements=[],s.horizLineElements=[],s.verticalLineElements=[],s.width=i[0],s.height=i[1],s.bIsShowAxisGrid=n,s.multiplyZoomFactor=o,s.algorithm=new Algorithm,s.materialGrid=new THREE.LineBasicMaterial({color:10066329,linewidth:.5}),s.children=[],s.resourceGrids=e,s.boundingBox=new THREE.Box2,s.realBoundingBox=new THREE.Box2,s.clipBox2D=new THREE.Box2(new THREE.Vector2(-s.width/2,-s.height/2),new THREE.Vector2(s.width/2,s.height/2)),s.axisGridNumberInterval=3,s.scratchVector=new THREE.Vector3,s.boxSize=new THREE.Vector2,s.isValid()&&s.build(),s}return __extends(e,t),e.prototype.build=function(){var t=this,e=this.getAxisGridBox(),i={width:this.width/2,height:this.height/2},n=function(n){var o=new THREE.Vector2(n.x,n.y);return t.algorithm.worldToNormalizedPoint(o,e),t.algorithm.normalizedPointToScreen(o,i),o},o=this.materialGrid;this.resourceGrids.forEach((function(e){var i=e.name,s=e.geometry,r=e.label;s.forEach((function(e){if("Line"===e.lineType){var s=e.startPoint,r=e.endPoint,a=n(s),l=n(r),h=l.clone().sub(a).normalize();t.add(new GridLine(a,l,o,i)),Math.abs(h.x)>=Math.abs(h.y)?t.horizLineElements.push({name:i,v1:a,v2:l,material:o}):t.verticalLineElements.push({name:i,v1:a,v2:l,material:o})}else if("Arc"===e.lineType){var c=e.points.map(n);t.add(new GridLineArc(c,o,i))}}));var a=r.positions.map(n);t.add(new AxisNotation(a,i))})),this.lineElements.push(this.horizLineElements),this.lineElements.push(this.verticalLineElements),this.calculateIntersections()},e.prototype.calculateAxisGridBox=function(t,e,i){var n=this;this.boundingBox.makeEmpty(),this.resourceGrids.forEach((function(t){t.geometry.forEach((function(t){if("Line"===t.lineType){var e=t.startPoint,i=t.endPoint,o=new THREE.Vector2(e.x,e.y),s=new THREE.Vector2(i.x,i.y);t.points=[o,s]}else if("Arc"===t.lineType){var r=window.CLOUD.AxisGridManager.getArcGridPoints(t);t.points=r}t.points.forEach((function(t){return n.boundingBox.expandByPoint(t)}))}))})),this.realBoundingBox=this.boundingBox.clone();var o=this.boundingBox.getCenter(this.scratchVector);this.boundingBox.getSize(this.boxSize);var s=new THREE.Vector2,r=t/e,a=this.boxSize.x/this.boxSize.y,l=this.boxSize.x,h=this.boxSize.y,c=4*(i+4)*this.multiplyZoomFactor;a>r?(this.bIsShowAxisGrid&&(l=this.boxSize.x*t/(t-c)),h=l/r):a<r&&(this.bIsShowAxisGrid&&(h=this.boxSize.y*e/(e-c)),l=h*r),s.set(l,h),this.boundingBox.setFromCenterAndSize(o,s)},e.prototype.getAxisGridBox=function(t){return this.isValid()&&this.calculateAxisGridBox(this.width,this.height,10),t?this.realBoundingBox:this.boundingBox},e.prototype.isEmpty=function(){return this.boundingBox.getSize(this.boxSize),0==this.boxSize.length()},e.prototype.isValid=function(){return!!this.resourceGrids},e.prototype.calculateIntersections=function(){for(var t,e,i,n,o,s,r,a,l=this.horizLineElements.length,h=this.verticalLineElements.length,c=0;c<l;c++){n=(t=this.horizLineElements[c]).name,o=t.v1.clone(),s=t.v2.clone();for(var d=0;d<h;d++){i=(e=this.verticalLineElements[d]).name,r=e.v1.clone(),a=e.v2.clone();var u=!1;r.x<=Math.max(o.x,s.x)&&r.x>=Math.min(o.x,s.x)&&o.y<=Math.max(r.y,a.y)&&o.y>=Math.min(r.y,a.y)&&(u=!0);var p=null;u&&(p=this.algorithm.getInterPoint(o,s,r,a)),this.intersections.push({intersectionPoint:p,horizLine:[o.clone(),s.clone()],verticalLine:[r.clone(),a.clone()],abcName:n,numeralName:i})}}},e.prototype.getIntersections=function(){return this.intersections},e.prototype.abtainRenderables=function(t){for(var e=0;e<this.children.length;e++){this.children[e].abtainRenderables(t)}},e.prototype.getGridLineByName=function(t){for(var e=this.children,i=0;i<e.length;i++){var n=e[i];if(n instanceof GridLine&&n.isMatch(t))return n}},e.prototype.move=function(t,e){this.children.forEach((function(i){i.move(t,e)}))},e}(DrawableItem),FloorPlane=function(t){function e(e,i,n){var o=t.call(this)||this;return o.imageUrl=e,o.width=i[0],o.height=i[1],o.offsetX=i[2],o.offsetY=i[3],o.isFlip=n,o.build(),o}return __extends(e,t),e.prototype.build=function(){var t=document.createElementNS(this.xmlns,"image");t.href.baseVal=this.imageUrl,t.setAttribute("herf",this.imageUrl),t.setAttribute("preserveAspectRatio","none"),t.setAttribute("width",this.width+""),t.setAttribute("height",this.height+""),t.setAttribute("x",-.5*this.width+""),t.setAttribute("y",-.5*this.height+""),this.isFlip&&t.setAttribute("transform","scale(-1,1)"),this.svgNode=t,this.locate(this.offsetX,this.offsetY)},e.prototype.move=function(t,e){var i=this.position.x+t,n=this.position.y+e;return this.isFlip?this.svgNode.setAttribute("transform","translate("+i+", "+n+")\n            scale("+"-1,1)"):this.svgNode.setAttribute("transform","translate("+i+","+n+")"),{x:i,y:n}},e}(DrawableItem);!function(t){t.Default="Editor",t.PICK_Editor="Pick",t.RECTPICK_Editor="RectPick",t.PAN_Editor="Pan",t.Zoom_Editor="Zoom"}(EditorName||(EditorName={}));var EventType,MouseEventType,Editor=function(){function t(){this.bIsMouseDown=!1,this.name=EditorName.Default}return t.prototype.onMouseDown=function(t){},t.prototype.onMouseMove=function(t){},t.prototype.onMouseUp=function(t){},t.prototype.onMouseWheel=function(t){},t.prototype.getName=function(){return this.name},t}();!function(t){t[t.RECTPICK_MOUSE_DOWN=1e3]="RECTPICK_MOUSE_DOWN",t[t.RECTPICK_MOUSE_MOVE=1001]="RECTPICK_MOUSE_MOVE",t[t.RECTPICK_MOUSE_UP=1002]="RECTPICK_MOUSE_UP",t[t.PICK_MOUSE_DOWN=2e3]="PICK_MOUSE_DOWN",t[t.PICK_MOUSE_MOVE=2001]="PICK_MOUSE_MOVE",t[t.PICK_MOUSE_UP=2002]="PICK_MOUSE_UP",t[t.Floor_Plane_Changed=3e3]="Floor_Plane_Changed",t[t.Floor_Plane_Changed_For_Panel=3001]="Floor_Plane_Changed_For_Panel",t[t.Resize=4e3]="Resize",t[t.Camera_Height_Changed=5e3]="Camera_Height_Changed",t[t.ZOOM_MOUSE_WHEEL=6e3]="ZOOM_MOUSE_WHEEL",t[t.PAN_MOUSE_MOVE=7e3]="PAN_MOUSE_MOVE",t[t.Minimap_Rect_Changed=8e3]="Minimap_Rect_Changed",t[t.Minimap_Rect_Destroyed=8001]="Minimap_Rect_Destroyed"}(EventType||(EventType={})),function(t){t[t.Left=0]="Left",t[t.Middle=1]="Middle",t[t.Right=2]="Right"}(MouseEventType||(MouseEventType={}));var VFSizeMode,EventManager=function(){function t(){this.eventDispatcher=new THREE.EventDispatcher}return t.prototype.addEventListener=function(t,e){this.eventDispatcher.addEventListener(t,e)},t.prototype.hasEventListener=function(t){this.eventDispatcher.hasEventListener(t)},t.prototype.removeEventListener=function(t,e){this.eventDispatcher.removeEventListener(t,e)},t.prototype.dispatchEvent=function(t){this.eventDispatcher.dispatchEvent(t)},t}();!function(t){t.Min="Min",t.Max="Max"}(VFSizeMode||(VFSizeMode={}));var ZoomEditor=function(t){function e(e,i){var n=t.call(this)||this;return n.totalZoomFactors=[],n.zoomFactors=[],n.lastZoomFactor=1,n.currentIdx=0,n.name=EditorName.Zoom_Editor,n.eventManager=i,n.vfData=e.getData(),n.vfViewer=e,n}return __extends(e,t),e.prototype.onMouseWheel=function(t){var e=(t.deltaY||-t.wheelDelta||t.detail)<0,i=-1;if(e?this.currentIdx<this.zoomFactors.length-1&&(this.currentIdx++,i=this.zoomFactors[this.currentIdx]):this.currentIdx>0&&(this.currentIdx--,i=this.zoomFactors[this.currentIdx]),!(i<0||this.lastZoomFactor==i)){this.lastZoomFactor=i,1==i&&PanEditor.clear();var n=this.vfData.getOriginSize(),o=new THREE.Vector2(t.offsetX-n[0]/2,t.offsetY-n[1]/2),s=this.zoomFactors[this.currentIdx],r=0,a=0;if(e){var l=s/(u=this.zoomFactors[this.currentIdx-1]),h=[],c=this.vfData.getCorner("Virtual","LB");c[0]-=o.x,c[1]-=o.y,h.push(c[0]*l+o.x),h.push(c[1]*l+o.y),this.vfData.setZoomFactor(s);var d=this.vfData.getCorner("Virtual","LB");this.vfData.setZoomFactor(u),r=h[0]-d[0],a=h[1]-d[1]}else{var u=this.zoomFactors[this.currentIdx+1],p=this.boundsChecking(s,u,o);r=p[0],a+=p[1]}PanEditor.panOffsetX+=r,PanEditor.panOffsetY+=a,PanEditor.panOffsetXForCamera+=r,PanEditor.panOffsetYForCamera+=a,this.vfData.setZoomFactor(i),this.vfViewer.destroy(),this.vfData.destroy(),this.vfData.build(),this.vfViewer.update(),this.vfData.updateMovement(),this.updateZoomAndPan(),this.eventManager.dispatchEvent({type:EventType.ZOOM_MOUSE_WHEEL,data:{offsetX:PanEditor.panOffsetX,offsetY:PanEditor.panOffsetY,zoomFactor:i}})}},e.prototype.boundsChecking=function(t,e,i){var n=t/e,o=this.vfData.getCorner("Virtual","LB"),s=this.vfData.getCorner("Virtual","LT"),r=this.vfData.getCorner("Virtual","RT"),a=this.vfData.getCorner("Virtual","RB"),l=[0,0],h=(o[0]-i.x)*n+i.x,c=(o[1]-i.y)*n+i.y;this.vfData.setZoomFactor(t);var d=this.vfData.getCorner("Virtual","LB");this.vfData.setZoomFactor(e),l[0]=h-d[0],l[1]=c-d[1];var u=0,p=0,g=this.vfData.getCorner("Origin","LB");h>g[0]&&(l[0]+=g[0]-h,u++),c<g[1]&&(l[1]+=g[1]-c,p++),h=(s[0]-i.x)*n+i.x,c=(s[1]-i.y)*n+i.y;var m=this.vfData.getCorner("Origin","LT");h>m[0]&&0==u&&(l[0]+=m[0]-h,u++),c>m[1]&&0==p&&(l[1]+=m[1]-c,p++),h=(r[0]-i.x)*n+i.x,c=(r[1]-i.y)*n+i.y;var f=this.vfData.getCorner("Origin","RT");h<f[0]&&0==u&&(l[0]+=f[0]-h,u++),c>f[1]&&0==p&&(l[1]+=f[1]-c,p++),h=(a[0]-i.x)*n+i.x,c=(a[1]-i.y)*n+i.y;var w=this.vfData.getCorner("Origin","RB");return h<w[0]&&0==u&&(l[0]+=w[0]-h,u++),c<w[1]&&0==p&&(l[1]+=w[1]-c,p++),l},e.prototype.enableMode=function(t){if(t==VFSizeMode.Min)this.zoomFactors=this.totalZoomFactors;else if(t==VFSizeMode.Max){this.zoomFactors=this.totalZoomFactors.slice(1,this.totalZoomFactors.length);for(var e=1;e<this.zoomFactors.length;e++)this.zoomFactors[e]/=this.zoomFactors[0];this.zoomFactors[0]=1}this.currentIdx=0},e.prototype.setZoomFactors=function(t){this.totalZoomFactors=t,this.zoomFactors=t},e.prototype.setZoonIndex=function(t){this.currentIdx=t},e.prototype.getZoonIndex=function(){return this.currentIdx},e.prototype.updateZoomAndPan=function(){var t=this.vfData.getCorner("Origin","LT"),i=this.vfData.getCorner("Virtual","LT");e.offsetXForZoomAndPan=t[0]-i[0],e.offsetYForZoomAndPan=t[1]-i[1]},e.clear=function(){e.offsetXForZoomAndPan=0,e.offsetYForZoomAndPan=0},e.offsetXForZoomAndPan=0,e.offsetYForZoomAndPan=0,e}(Editor),PanEditor=function(t){function e(i,n){var o=t.call(this)||this;return o.name=EditorName.PAN_Editor,o.eventManager=n,o.vfData=i.getData(),o.bIsMouseDown=!1,o.mouseDownPos=new THREE.Vector2,e.panOffsetX=0,e.panOffsetY=0,o}return __extends(e,t),e.prototype.onMouseDown=function(t){this.bIsMouseDown=!0,this.mouseDownPos.setX(t.clientX),this.mouseDownPos.setY(t.clientY)},e.prototype.onMouseMove=function(t){if(0!=this.bIsMouseDown&&1!=this.vfData.getZoomFactor()){var i=t.clientX-this.mouseDownPos.x,n=t.clientY-this.mouseDownPos.y,o=this.boundsChecking(i,n);i=o[0],n=o[1],e.panOffsetX+=i,e.panOffsetY+=n,e.panOffsetXForCamera+=i,e.panOffsetYForCamera+=n,this.vfData.updateMovement(),this.updateZoomAndPan(),this.mouseDownPos.setX(t.clientX),this.mouseDownPos.setY(t.clientY)}},e.prototype.onMouseUp=function(t){if(0!=this.bIsMouseDown&&1!=this.vfData.getZoomFactor()){var i=t.clientX-this.mouseDownPos.x,n=t.clientY-this.mouseDownPos.y,o=this.boundsChecking(i,n);i=o[0],n=o[1],e.panOffsetX+=i,e.panOffsetY+=n,e.panOffsetXForCamera+=i,e.panOffsetYForCamera+=n,this.vfData.updateMovement(),this.updateZoomAndPan(),this.eventManager.dispatchEvent({type:EventType.PAN_MOUSE_MOVE,data:{offsetX:e.panOffsetX,offsetY:e.panOffsetY,zoomFactor:this.vfData.getZoomFactor()}}),this.bIsMouseDown=!1}},e.prototype.boundsChecking=function(t,e){var i=this.vfData.getCorner("Origin","LB"),n=this.vfData.getCorner("Virtual","LB"),o=this.vfData.getCorner("Origin","RT"),s=this.vfData.getCorner("Virtual","RT");if(t>0)(r=i[0]-n[0])<=t&&(t=r);else if(t<0){var r;(r=o[0]-s[0])>=t&&(t=r)}if(e<0)(a=i[1]-n[1])>=e&&(e=a);else if(e>0){var a;(a=o[1]-s[1])<=e&&(e=a)}return[t,e]},e.prototype.updateZoomAndPan=function(){var t=this.vfData.getCorner("Origin","LT"),e=this.vfData.getCorner("Virtual","LT");ZoomEditor.offsetXForZoomAndPan=t[0]-e[0],ZoomEditor.offsetYForZoomAndPan=t[1]-e[1]},e.clear=function(){e.panOffsetX=0,e.panOffsetY=0,e.panOffsetXForCamera=0,e.panOffsetYForCamera=0},e}(Editor),CameraNode=function(t){function e(){var e=t.call(this)||this;return e.cameraCircleNode=null,e.cameraArrowNode=null,e.rotateAngle=0,e.panelSize=[298,198],e.build(),e}return __extends(e,t),e.prototype.build=function(){var t=document.createElementNS(this.xmlns,"g");t.setAttribute("fill","none"),t.setAttribute("fill-rule","evenodd"),t.setAttribute("stroke-width","1");var e=document.createElementNS(this.xmlns,"circle");e.setAttribute("r","4.5"),e.setAttribute("stroke","#FFFFFF"),e.setAttribute("fill","#32D3A6"),this.cameraCircleNode=e;var i=document.createElementNS(this.xmlns,"path");i.setAttribute("d","M5.94925387,0 C18.4132389,0 28.6581001,9.50119823 29.8362478,21.6560048 L5.94925387,25 Z"),i.setAttribute("fill","url(#radialGradient-1)"),i.setAttribute("transform","translate(13,-21)rotate(50)"),this.cameraArrowNode=i;var n=document.createElementNS(this.xmlns,"defs"),o=document.createElementNS(this.xmlns,"radialGradient"),s=document.createElementNS(this.xmlns,"stop"),r=document.createElementNS(this.xmlns,"stop");o.setAttribute("cx","0%"),o.setAttribute("cy","100%"),o.setAttribute("fx","0%"),o.setAttribute("fy","100%"),o.setAttribute("r","104.321936%"),o.setAttribute("id","radialGradient-1"),s.setAttribute("stop-color","#36D4A8"),s.setAttribute("offset","0%"),r.setAttribute("stop-color","#36D4A8"),r.setAttribute("offset","100%"),r.setAttribute("stop-opacity","0"),n.append(o),o.append(s),o.append(r),t.appendChild(n),t.appendChild(e),t.appendChild(i),this.svgNode=t},e.prototype.setCircleAttribute=function(t,e){this.cameraCircleNode.setAttribute(t,e)},e.prototype.setArrowAttribute=function(t,e){this.cameraArrowNode.setAttribute(t,e)},e.prototype.rotate=function(t){t&&(this.rotateAngle=t);var e=this.svgNode.getAttribute("transform");e+="rotate("+this.rotateAngle+")",this.svgNode.setAttribute("transform",e)},e.prototype.setOffsetAndRotate=function(t,e,i){var n=this.setOffsetBoundary(t,e);this.locate(n.X,n.Y),this.rotate(i),PanEditor.panOffsetXForCamera=0,PanEditor.panOffsetYForCamera=0},e.prototype.move=function(t,e){var i=this.position.x+t,n=this.position.y+e,o=this.setOffsetBoundary(i,n);this.svgNode.setAttribute("transform","translate("+o.X+","+o.Y+")")},e.prototype.setOpacity=function(t){this.svgNode.setAttribute("opacity",t)},e.prototype.setCameraArrowOpacity=function(t){this.cameraArrowNode.setAttribute("opacity",t)},e.prototype.setCameraCircleOpacity=function(t){this.cameraCircleNode.setAttribute("opacity",t)},e.prototype.setBigCamera=function(){this.cameraCircleNode.setAttribute("r","4.5"),this.cameraArrowNode.setAttribute("transform","translate(13,-21)rotate(50)")},e.prototype.setSmallCamera=function(){this.cameraCircleNode.setAttribute("r","2"),this.cameraArrowNode.setAttribute("transform","translate(20,-21)rotate(50)")},e.prototype.setPanelSize=function(t){this.panelSize=t},e.prototype.setOffsetBoundary=function(t,e){var i=this.panelSize[0]/2-6,n=-this.panelSize[0]/2+6,o=this.panelSize[1]/2-6,s=-this.panelSize[1]/2+6;return t>=i||t<=n||e>=o||e<=s?this.setSmallCamera():this.setBigCamera(),t>i&&(t=i),t<n&&(t=n),e>o&&(e=o),e<s&&(e=s),{X:t,Y:e}},e}(DrawableItem),AxisGrids=function(){function t(t){this.resourceGrids=t,this.floorPlaneBox=new THREE.Box2}return t.prototype.get=function(){return this.resourceGrids},t}(),Levels=function(){function t(t){this.resourceLevels=t,this.elevations=[],this.offsetForPlane=235,this.createElevationsInOrder()}return t.prototype.createElevationsInOrder=function(){var t=this.resourceLevels;for(var e in t)null!=t[e].elevation&&this.elevations.push(t[e].elevation);this.elevations.sort((function(t,e){return t-e})),this.elevations[this.elevations.length-1]-this.elevations[0]<this.offsetForPlane&&(this.offsetForPlane/=1e3)},t.prototype.getMinMaxElevations=function(t){var e=[0,0],i=this.resourceLevels;for(var n in i)if(i[n].name==t){e[0]=i[n].elevation-this.offsetForPlane;break}for(var o=0;o<this.elevations.length;o++)if(this.elevations[o]-e[0]-this.offsetForPlane>1e-6){e[1]=this.elevations[o],e[1]-=this.offsetForPlane;break}return e},t.prototype.getElevation=function(t){for(var e=this.resourceLevels,i=0;i<e.length;i++){var n=e[i];if(n.id==t)return n.elevation}},t.prototype.getElevationsInOrder=function(){return this.elevations},t.prototype.getLevelIdByElevation=function(t){for(var e=this.resourceLevels,i=0;i<e.length;i++){var n=e[i];if(n.elevation==t)return n.id}},t}(),FloorPlanes=function(){function t(t){this.resourcePlanes=t}return t.prototype.find=function(t){for(var e=0;e<this.resourcePlanes.length;e++){var i=this.resourcePlanes[e];if(i.id==t)return i}},t.prototype.getFloorPlaneBox=function(t){var e=this.find(t);return e?e.boundingBox||e.BoundingBox:void 0},t.prototype.getUrl=function(t){var e=this.find(t);return e?e.path||e.Path:void 0},t.prototype.getElevation=function(t){var e=this.find(t);return e?e.Elevation:void 0},t.prototype.getName=function(t){var e=this.find(t);return e?e.name||e.Name:void 0},t}(),HighlightPoint=function(t){function e(e,i){var n=t.call(this)||this;return n.radius=e,n.material=i,n.build(),n}return __extends(e,t),e.prototype.build=function(){var t=document.createElementNS(this.xmlns,"circle");t.setAttribute("r",this.radius+""),t.setAttribute("fill",this.glodonColor),t.setAttribute("style","fill: none; stroke: "+this.glodonColor),t.setAttribute("opacity","0"),this.svgNode=t},e.prototype.highlight=function(){this.svgNode.setAttribute("style","stroke:"+this.glodonColor),this.svgNode.setAttribute("opacity","1")},e.prototype.cancelHighlight=function(){this.svgNode.setAttribute("style","stroke:rgb(153,153,153)"),this.svgNode.setAttribute("opacity","0")},e.prototype.setOffset=function(t,e){this.svgNode.setAttribute("transform","translate("+t+","+e+")")},e}(DrawableItem),TipNode=function(t){function e(){var e=t.call(this)||this;return e.tipNodeBackgroundColor="#fff",e.tipNodeColor="#000",e.initialize(),e.build(),e}return __extends(e,t),e.prototype.initialize=function(){var t=".cloud-tip:after { box-sizing: border-box;display: inline;font-size: 10px;width: 100%;line-height: 1;color: "+this.tipNodeBackgroundColor+";content: '\\25BC';position: absolute;text-align: center;margin: -4px 0 0 0;top: 100%;left: 0;}";this.loadStyleString(t)},e.prototype.loadStyleString=function(t){var e=document.createElement("style");e.type="text/css",e.appendChild(document.createTextNode(t)),document.getElementsByTagName("head")[0].appendChild(e)},e.prototype.build=function(){var t=document.createElement("div");t.className="cloud-tip",t.style.position="absolute",t.style.opacity="0",t.style.background=this.tipNodeBackgroundColor,t.style.color=this.tipNodeColor,t.style.padding="0 8px 0 8px",t.style.borderRadius="2px",t.style.fontSize="8px",t.style.zIndex="10",this.svgNode=t},e.prototype.show=function(){this.svgNode.style.opacity=1,this.svgNode.className="cloud-tip"},e.prototype.hide=function(){this.svgNode.style.opacity=0,this.svgNode.className=""},e.prototype.setContent=function(t){this.svgNode.innerHTML=t},e.prototype.setOffset=function(t,e){var i=this.svgNode.getBoundingClientRect();this.svgNode.style.left=t[0]/2+e[0]-.5*i.width+"px",this.svgNode.style.top=t[1]/2+e[1]-i.height-12+"px"},e}(DrawableItem),ViewerFloorData=function(){function t(){this.zoomFactor=1,this.bboxLengthStages=[15e4,3e5],this.zoomFactors1=[1,7/4,2.5,10/3],this.zoomFactors2=[1,7/4,2.5,14/3,65/12,20/3],this.zoomFactors3=[1,7/4,2.5,10/3,14/3,65/12,20/3,49/6,10],this.needFlip=!1,this.floorPlaneId=null,this.drawableItems=[],this.width=298,this.height=198,this.bIsShowAxisGrid=!1,this.bIsShowCameraNode=!0,this.bIsShowFloorPlane=!0,this.floorPlaneBox=new THREE.Box3,this.axisGridNode=null,this.cameraNode=null,this.floorPlaneNode=null,this.algorithm=new Algorithm,this.glodonColor="#11DAB7",this.scratchVector=new THREE.Vector2,this.scratchVector_2=new THREE.Vector2,this.scratchVector_3=new THREE.Vector2,this.scratchVector_4=new THREE.Vector2,this.axisGridBoxSize=new THREE.Vector2,this.floorPlaneBox2DSize=new THREE.Vector2}return t.prototype.setAxisGrids=function(t){this.dataAxisGrid=new AxisGrids(t.Grids),this.dataLevels=new Levels(t.Levels)},t.prototype.setPlanes=function(t){this.dataFloorPlanes=new FloorPlanes(t)},t.prototype.setFloorPlaneId=function(t){this.floorPlaneId=t,this.build()},t.prototype.setFlip=function(t){this.needFlip=t},t.prototype.getFloorPlaneId=function(){return this.floorPlaneId},t.prototype.getFloorPlaneBox=function(){var t=this.dataFloorPlanes.getFloorPlaneBox(this.floorPlaneId),e=this.dataFloorPlanes.getName(this.floorPlaneId),i=this.dataLevels.getMinMaxElevations(e);return t&&(this.floorPlaneBox.min=new THREE.Vector3(t.Min.X||t.Min.x,t.Min.Y||t.Min.y,i[0]),this.floorPlaneBox.max=new THREE.Vector3(t.Max.X||t.Max.x,t.Max.Y||t.Max.y,i[1])),this.floorPlaneBox},t.prototype.setSize=function(t,e){this.width=t,this.height=e},t.prototype.getSize=function(){return[this.width*this.zoomFactor,this.height*this.zoomFactor]},t.prototype.getOriginSize=function(){return[this.width,this.height]},t.prototype.getGlodonColor=function(){return this.glodonColor},t.prototype.build=function(){var t=!!this.dataAxisGrid&&this.dataAxisGrid.get();if(this.axisGridNode=new AxisGrid(t,this.getSize(),this.bIsShowAxisGrid,this.getZoomFactor()),this.axisGridNode.isEmpty()&&(this.bIsShowAxisGrid=!1),this.bIsShowAxisGrid&&this.drawableItems.push(this.axisGridNode),this.buildFloorPlane(),this.bIsShowCameraNode){this.cameraNode=new CameraNode;var e=this.getOriginSize();this.cameraNode.setPanelSize(e),this.drawableItems.push(this.cameraNode)}this.intersectPoint=new HighlightPoint(3),this.drawableItems.push(this.intersectPoint),this.tipNode=new TipNode,this.drawableItems.push(this.tipNode)},t.prototype.buildFloorPlane=function(){if(this.bIsShowFloorPlane){var t=this.getFloorPlaneBox();this.getAxisGridBox2D().containsBox(t)||console.warn("the bounding-box of axis-grid is not contains the bounding-box of floor-plane!");var e=this.getFloorPlaneParams();this.floorPlaneNode=new FloorPlane(this.dataFloorPlanes.getUrl(this.floorPlaneId),e,this.needFlip),this.drawableItems.push(this.floorPlaneNode)}},t.prototype.getFloorPlaneParams=function(){var t=this.getFloorPlaneBox(),e=this.getAxisGridBox2D(),i=new THREE.Box2(new THREE.Vector2(t.min.x,t.min.y),new THREE.Vector2(t.max.x,t.max.y)),n=this.getSize()[0],o=n/this.getSize()[1];e.getSize(this.axisGridBoxSize),this.axisGridBoxSize.x/this.axisGridBoxSize.y!=o&&(this.algorithm.expandBbox(e,o),e.getSize(this.axisGridBoxSize));var s=[],r=n/this.axisGridBoxSize.x;i.getSize(this.floorPlaneBox2DSize);var a=this.floorPlaneBox2DSize.x*r,l=this.floorPlaneBox2DSize.y*r;s.push(a,l);var h=i.getCenter(this.scratchVector).clone().sub(e.getCenter(this.scratchVector_2));return h.x*=r,h.y*=-r,s.push(h.x,h.y),s},t.prototype.updateFloorPlane=function(t){for(var e=this.dataLevels.getElevationsInOrder(),i=this.getElevationById(),n=void 0,o=void 0,s=0;s<e.length;s++){if((r=e[s])>t){o=r;break}}for(s=e.length-1;s>=0;s--){var r;if((r=e[s])<t){n=r;break}}if(null==n){var a=this.dataLevels.getLevelIdByElevation(o);return this.floorPlaneId=a,!0}if(null==o){a=this.dataLevels.getLevelIdByElevation(n);return this.floorPlaneId=a,!0}if(i>=n&&i<o)return!1;a=this.dataLevels.getLevelIdByElevation(n);return this.floorPlaneId=a,!0},t.prototype.getDataFloorPlanes=function(){return this.dataFloorPlanes},t.prototype.getAxisGridBox2D=function(t){var e=this.axisGridNode.getAxisGridBox(t);if(0==e.getSize(this.axisGridBoxSize).length()){var i=this.getFloorPlaneBox();if(t)return i;var n=(new THREE.Box2).set(new THREE.Vector2(i.min.x,i.min.y),new THREE.Vector2(i.max.x,i.max.y)),o=n.getCenter(this.scratchVector);n.getSize(this.scratchVector_4);var s=new THREE.Vector2,r=this.width/this.height,a=this.scratchVector_4.x/this.scratchVector_4.y,l=this.scratchVector_4.x,h=this.scratchVector_4.y;return a>r?h=l/r:a<r&&(l=h*r),s.set(l,h),n.setFromCenterAndSize(o,s),n}return e},t.prototype.getDrawableItems=function(){return this.drawableItems},t.prototype.destroy=function(){this.drawableItems=[]},t.prototype.setIsShowAxisGrid=function(t){this.bIsShowAxisGrid=t},t.prototype.getCameraNode=function(){for(var t=this.drawableItems,e=0;e<t.length;e++){var i=t[e];if(i instanceof CameraNode)return i}},t.prototype.getElevationById=function(){return this.dataLevels.getElevation(this.floorPlaneId)},t.prototype.updateMovement=function(){this.getFloorPlaneNode().move(PanEditor.panOffsetX,PanEditor.panOffsetY);var t=this.getAxisGridNode();t&&t.move(PanEditor.panOffsetX,PanEditor.panOffsetY);var e=this.getCameraNode();e.move(PanEditor.panOffsetXForCamera,PanEditor.panOffsetYForCamera),e.rotate()},t.prototype.getCorner=function(t,e){var i=[],n=[];"Origin"==t?(i=[0,0],n=this.getOriginSize()):"Virtual"==t&&(i=[PanEditor.panOffsetX,PanEditor.panOffsetY],n=this.getSize());var o=0,s=0;switch(e){case"LB":o=i[0]-n[0]/2,s=i[1]+n[1]/2;break;case"LT":o=i[0]-n[0]/2,s=i[1]-n[1]/2;break;case"RT":o=i[0]+n[0]/2,s=i[1]-n[1]/2;break;case"RB":o=i[0]+n[0]/2,s=i[1]+n[1]/2;break;default:console.log("CornerName is wrong.")}return[o,s]},t.prototype.getIntersections=function(){return this.axisGridNode.getIntersections()},t.prototype.getGridLineByName=function(t){return this.axisGridNode.getGridLineByName(t)},t.prototype.getTipNode=function(){return this.tipNode},t.prototype.getFloorPlaneNode=function(){return this.floorPlaneNode},t.prototype.getAxisGridNode=function(){return 0==this.bIsShowAxisGrid?null:this.axisGridNode},t.prototype.getIntersectPoint=function(){return this.intersectPoint},t.prototype.setZoomFactor=function(t){this.zoomFactor=t},t.prototype.getZoomFactor=function(){return this.zoomFactor},t.prototype.getProperZoomFactors=function(){this.getAxisGridBox2D(!0).getSize(this.scratchVector_3);var t=Math.max(this.scratchVector_3.x,this.scratchVector_3.y);return t<=this.bboxLengthStages[0]?this.zoomFactors1:t<=this.bboxLengthStages[1]?this.zoomFactors2:this.zoomFactors3},t}(),ViewerFloorView=function(){function t(t,e,i){this.viewer=t,this.domContainer=e,this.viewerFloorData=i,this.width=298,this.height=198,this.manHeight=t._manHeight,this.algorithm=new Algorithm,this.eventManager=null,this.currentFloorName=null,this.bBoxCenter=new THREE.Vector2,this.projectedCameraPosition=new THREE.Vector3,this.projectedTargetPosition=new THREE.Vector3,this.sceneMatrixInverse=new THREE.Matrix4,this.initialize()}return t.prototype.initialize=function(){var t="http://www.w3.org/2000/svg";this.drawableContainer=document.createElementNS(t,"svg"),this.drawableContainer.setAttribute("width",this.width+""),this.drawableContainer.setAttribute("height",this.height+""),this.drawableContainer.setAttribute("viewBox",-this.width/2+" "+-this.height/2+" "+this.width+" "+this.height),this.drawableContainer.style.position="absolute",this.auxContainer=document.createElementNS(t,"svg"),this.auxContainer.setAttribute("width",this.width+""),this.auxContainer.setAttribute("height",this.height+""),this.auxContainer.setAttribute("viewBox",-this.width/2+" "+-this.height/2+" "+this.width+" "+this.height),this.auxContainer.style.position="absolute",this.mapContainer=document.createElement("div"),this.mapContainer.style.left="0px",this.mapContainer.style.bottom="0px",this.mapContainer.style.position="relative",this.mapContainer.outling="none",this.mapContainer.appendChild(this.drawableContainer),this.mapContainer.appendChild(this.auxContainer),this.domContainer.appendChild(this.mapContainer),this.cameraHeightChangedCallbackBinded=this.cameraHeightChangedCallback.bind(this)},t.prototype.cameraHeightChangedCallback=function(t){var e=t.cameraPosition,i=this.viewer.getScene().getMatrixGlobal();this.sceneMatrixInverse.copy(i).invert();var n=e.clone().applyMatrix4(this.sceneMatrixInverse);if(this.viewerFloorData.getAxisGridBox2D().containsPoint(new THREE.Vector2(n.x,n.y))&&this.viewerFloorData.updateFloorPlane(n.z)){var o=this.viewerFloorData.getDataFloorPlanes().getName(this.viewerFloorData.getFloorPlaneId());o&&this.currentFloorName!=o&&(this.currentFloorName=o,this.eventManager.dispatchEvent({type:EventType.Camera_Height_Changed,id:this.viewerFloorData.getFloorPlaneId()}),console.log("Current floor plane is "+o))}},t.prototype.getMapContainer=function(){return this.drawableContainer},t.prototype.getDomContainer=function(){return this.mapContainer},t.prototype.getAuxContainer=function(){return this.auxContainer},t.prototype.getViewer=function(){return this.viewer},t.prototype.getData=function(){return this.viewerFloorData},t.prototype.setSize=function(t,e){this.mapContainer.style.width=t+"px",this.mapContainer.style.height=e+"px",this.drawableContainer.setAttribute("width",t+""),this.drawableContainer.setAttribute("height",e+""),this.drawableContainer.setAttribute("viewBox",-t/2+" "+-e/2+" "+t+" "+e),this.auxContainer.setAttribute("width",t+""),this.auxContainer.setAttribute("height",e+""),this.auxContainer.setAttribute("viewBox",-t/2+" "+-e/2+" "+t+" "+e),this.destroy(),this.viewerFloorData.destroy(),this.viewerFloorData.build(),this.update(),this.eventManager.dispatchEvent({type:EventType.Resize,size:{width:t,height:e}})},t.prototype.destroy=function(){for(var t=this.drawableContainer;t.children.length>0;){var e=t.children[0];t.removeChild(e)}this.mapContainer.removeChild(t);var i=this.getData().getTipNode();i&&null!=i.getSvgNode().parentNode&&this.mapContainer.removeChild(i.getSvgNode())},t.prototype.updateCameraNode=function(){var t=this.viewer,e=t.camera,i=t.cameraControl;if(e&&i){var n=e.position,o=e.target,s=this.algorithm.getMainSceneMatrix(t),r=new THREE.Matrix4;r.copy(s).invert();var a=this.viewerFloorData.getFloorPlaneBox();a.getCenter(this.bBoxCenter);var l=new THREE.Vector3(a.min.x,a.min.y,this.bBoxCenter.z).applyMatrix4(s),h=new THREE.Vector3(a.min.x,a.max.y,this.bBoxCenter.z).applyMatrix4(s),c=new THREE.Vector3(a.max.x,a.min.y,this.bBoxCenter.z).applyMatrix4(s),d=new THREE.Plane;d.setFromCoplanarPoints(l,h,c),d.projectPoint(n,this.projectedCameraPosition),this.projectedCameraPosition.applyMatrix4(r),d.projectPoint(o,this.projectedTargetPosition),this.projectedTargetPosition.applyMatrix4(r);var u=this.projectedTargetPosition.clone().sub(this.projectedCameraPosition);u.z=0,u.normalize();var p=n.clone();p.applyMatrix4(r);var g=p.clone(),m=this.viewerFloorData.getSize(),f={width:m[0]/2,height:m[1]/2},w=this.viewerFloorData.getAxisGridBox2D();this.algorithm.worldToNormalizedPoint(g,w),this.algorithm.normalizedPointToScreen(g,f);var v=this.viewerFloorData.getCameraNode();if(v.setOpacity("1.0"),u.length()<1e-5)v.setCameraArrowOpacity("0.0"),v.setOffsetAndRotate(g.x+PanEditor.panOffsetX,g.y+PanEditor.panOffsetY,0);else{var y=new THREE.Vector3(0,0,1),b=new THREE.Vector3(1,0,0),E=this.algorithm.isAngleGreaterThanPi(b,u,y),C=THREE.Math.radToDeg(b.angleTo(u));E||(C*=-1),v.setBigCamera(),v.setOffsetAndRotate(g.x+PanEditor.panOffsetX,g.y+PanEditor.panOffsetY,C),v.setCameraArrowOpacity("1.0")}}},t.prototype.update=function(t){for(var e=this.viewerFloorData.getDrawableItems(),i=0;i<e.length;i++){var n=e[i];n instanceof TipNode?this.mapContainer.appendChild(n.getSvgNode()):n.abtainRenderables(this.drawableContainer)}this.updateCameraNode();var o=this.mapContainer.firstChild;o?this.mapContainer.insertBefore(this.drawableContainer,o):this.mapContainer.appendChild(this.drawableContainer)},t.prototype.setEventManager=function(t){this.eventManager=t},t.prototype.getEventManager=function(){return this.eventManager},t.prototype.registerCameraHeightChanged=function(t){this.viewer.registerEventListener(t,this.cameraHeightChangedCallbackBinded)},t.prototype.getManHeight=function(){return this.manHeight},t}(),HighlightControl=function(){function t(t){this.viewerFloorData=t}return t.prototype.hightlight=function(t,e,i){var n=this.viewerFloorData.getOriginSize();this.intersectPoint=this.viewerFloorData.getIntersectPoint();var o=[t.intersectionPoint.x+e,t.intersectionPoint.y+i];this.intersectPoint.setOffset(o[0],o[1]),this.abcGridLine=this.viewerFloorData.getGridLineByName(t.abcName),this.numeralGridLine=this.viewerFloorData.getGridLineByName(t.numeralName),this.intersectPoint.highlight(),this.abcGridLine.highlight(),this.numeralGridLine.highlight(),this.tipNode=this.viewerFloorData.getTipNode(),this.tipNode.setContent(t.numeralName+"-"+t.abcName),this.tipNode.setOffset(n,o),this.tipNode.show()},t.prototype.cancelHightlight=function(){this.intersectPoint&&(this.intersectPoint.cancelHighlight(),this.abcGridLine.cancelHighlight(),this.numeralGridLine.cancelHighlight(),this.tipNode.hide(),this.intersectPoint=null,this.abcGridLine=null,this.numeralGridLine=null,this.tipNode=null)},t}(),PickEditor=function(t){function e(e,i){var n=t.call(this)||this;return n.name=EditorName.PICK_Editor,n.vfViewer=e,n.vfData=e.getData(),n.algorithm=new Algorithm,n.highlightControl=new HighlightControl(n.vfData),n.cameraProjectedPosZ=e.getManHeight(),n.mapClickMode="default",n.lastMousePoint=new THREE.Vector2,n.eventManager=i,n.bIsEnableHover=!0,n}return __extends(e,t),e.prototype.onMouseDown=function(t){this.bIsMouseDown=!0,this.lastMousePoint.setX(t.clientX),this.lastMousePoint.setY(t.clientY)},e.prototype.onMouseMove=function(t){if(0!=this.bIsEnableHover||!this.bIsMouseDown){var e=new THREE.Vector2(t.clientX,t.clientY);e.x+=ZoomEditor.offsetXForZoomAndPan,e.y+=+ZoomEditor.offsetYForZoomAndPan;var i=this.vfViewer.getMapContainer(),n=this.vfData.getSize();if(this.algorithm.isMouseOverCanvas(i,n,e)){var o=this.algorithm.normalizePoint(i,n,e),s=new THREE.Vector2(o.x,o.y),r=null;this.bIsAllowNear?(this.algorithm.normalizedPointToScreen(s,{width:n[0]/2,height:n[1]/2}),r=this.algorithm.getIntersectionToMinDistance(this.vfData.getIntersections(),s)):r=this.getIntersectionByNormalizedPoint(s),this.highlightControl.cancelHightlight(),r&&this.highlightControl.hightlight(r,PanEditor.panOffsetX,PanEditor.panOffsetY)}}},e.prototype.onMouseUp=function(t){this.bIsMouseDown=!1,this.lastMousePoint.x===t.clientX&&this.lastMousePoint.y===t.clientY&&this.locateByClientPoint(t.clientX+ZoomEditor.offsetXForZoomAndPan,t.clientY+ZoomEditor.offsetYForZoomAndPan)},e.prototype.setIsAllowNear=function(t){this.bIsAllowNear=t},e.prototype.getIntersectionByNormalizedPoint=function(t){for(var e=null,i=this.vfData.getIntersections(),n=0,o=i.length;n<o;n++){var s=i[n].intersectionPoint;if(s){var r=new THREE.Vector2(t.x,t.y),a=this.vfData.getSize();if(this.algorithm.normalizedPointToScreen(r,{width:a[0]/2,height:a[1]/2}),s.distanceToSquared(r)<9){e=i[n];break}}}return e},e.prototype.locateByClientPoint=function(t,e){var i=new THREE.Vector2(t,e),n=new THREE.Vector3,o=this.vfViewer.getMapContainer(),s=this.vfData.getSize(),r=this.algorithm.normalizePoint(o,s,i);if(null!=r){var a=this.vfData.getAxisGridBox2D();this.algorithm.normalizedPointToWorld(r,a);var l=this.algorithm.normalizePoint(o,s,i);this.algorithm.normalizedPointToScreen(l,{width:s[0]/2,height:s[1]/2});var h=this.algorithm.getIntersectionToMinDistance(this.vfData.getIntersections(),l);if(h&&h.intersectionPoint){var c=new THREE.Vector2(h.intersectionPoint.x,h.intersectionPoint.y);if(l.sub(c).lengthSq()<9){var d=c.clone(),u={width:s[0]/2,height:s[1]/2};this.algorithm.screenToNormalizedPoint(d,u),this.algorithm.normalizedPointToWorld(d,a),n.set(d.x,d.y,this.cameraProjectedPosZ)}else n.set(r.x,r.y,this.cameraProjectedPosZ)}else n.set(r.x,r.y,this.cameraProjectedPosZ);var p=n.clone(),g=this.vfData.getElevationById();return"string"==typeof g&&(g=parseFloat(g)),p.z+=g,"default"==this.mapClickMode?(this.eventManager.dispatchEvent({type:EventType.PICK_MOUSE_UP,data:p}),this.algorithm.transformWorldPoint(this.vfViewer.getViewer(),p),this.algorithm.flyToPointWithParallelEye(this.vfViewer.getViewer(),p)):"static"==this.mapClickMode&&this.eventManager.dispatchEvent({type:EventType.PICK_MOUSE_UP,data:p}),!0}console.warn("Click point out of boundary.")},e.prototype.setClickMode=function(t){this.mapClickMode=t},e}(Editor),NaviAction=function(){function t(t){this.vfViewer=t,this.vfData=t.getData(),this.svgRect=null,this.rectForMinimapId="RectForMinimap",this.bEditMode=!1,this.bPanMode=!1,this.bMouseDown=!1,this.rectangle=[],this.currentGripId=-1,this.lastHighlightGripId=-1,this.bFirstMouseClick=!0,this.lastMousePoint=new THREE.Vector2,this.lastMousePointToRectMin=new THREE.Vector2,this.lastMousePointToRectMax=new THREE.Vector2,this.pointOnBorder=[],this.eventManager=t.getEventManager(),this.panOffset=[0,0],this.zoomFactor=1;var e=this;this.eventManager.addEventListener(EventType.ZOOM_MOUSE_WHEEL,(function(t){var i=t.data;e.zoomAndPan(i.offsetX,i.offsetY,i.zoomFactor)})),this.eventManager.addEventListener(EventType.PAN_MOUSE_MOVE,(function(t){var i=t.data;e.zoomAndPan(i.offsetX,i.offsetY,i.zoomFactor)}))}return t.prototype.getMouseClickState=function(){return this.bFirstMouseClick},t.prototype.setMouseClickState=function(t){this.bFirstMouseClick=!!t},t.prototype.getCurrentGripId=function(){return this.currentGripId},t.prototype.setCurrentGripId=function(t){this.currentGripId=t},t.prototype.getRectangleInfo=function(){var t=Math.abs(this.rectangle[2]-this.rectangle[0]),e=Math.abs(this.rectangle[3]-this.rectangle[1]);return{x:this.rectangle[0],y:this.rectangle[1],width:t,height:e}},t.prototype.setLastMousePoint=function(t,e){this.lastMousePoint.x=t,this.lastMousePoint.y=e},t.prototype.equalWithLastPoint=function(t,e){return this.lastMousePoint.x===t&&this.lastMousePoint.y===e},t.prototype.getRectangle=function(){return this.rectangle},t.prototype.addPointToRectangle=function(t,e){"number"==typeof t&&this.rectangle.push(t),"number"==typeof e&&this.rectangle.push(e)},t.prototype.pointsCount=function(){return this.rectangle.length/2},t.prototype.pointValidation=function(t,e){var i=this.vfViewer.getDomContainer().getBoundingClientRect();(t<0||e<0||t>i.width||e>i.height)&&(t=this.pointOnBorder[0],e=this.pointOnBorder[1]),t<this.rectangle[0]?(this.rectangle.push(this.rectangle[0]),this.rectangle[0]=t):this.rectangle.push(t),e<this.rectangle[1]?(this.rectangle.push(this.rectangle[1]),this.rectangle[1]=e):this.rectangle.push(e)},t.prototype.getMouseState=function(){return this.bMouseDown},t.prototype.setMouseState=function(t){this.bMouseDown=!!t},t.prototype.getEditMode=function(){return this.bEditMode},t.prototype.setEditMode=function(t){this.bEditMode=!!t},t.prototype.getPanMode=function(){return this.bPanMode},t.prototype.setPanMode=function(t){this.bPanMode=!!t},t.prototype.createSvgElement=function(t){var e=document.createElementNS("http://www.w3.org/2000/svg",t);return e.setAttribute("pointer-events","inherit"),e},t.prototype.createSvgRect=function(t){this.svgRect||(this.svgRect=this.createSvgElement("rect"),this.svgRect.setAttribute("id",this.rectForMinimapId),this.svgRect.setAttribute("stroke-width",2),this.svgRect.style.position="absolute",this.svgRect.style.fillOpacity="0.4",this.svgRect.style.fill=this.vfData.getGlodonColor(),this.svgRect.style.display="block",this.svgRect.style.stroke=this.vfData.getGlodonColor(),this.svgRect.style.strokeWidth="2");var e=Math.abs(t.x-this.rectangle[0]),i=Math.abs(t.y-this.rectangle[1]),n=this.vfViewer.getAuxContainer(),o=n.clientWidth,s=n.clientHeight,r=["translate(",t.x-o/2,",",t.y-s/2,") ","rotate(",0,") "].join("");this.svgRect.setAttribute("transform",r),this.svgRect.setAttribute("width",e+""),this.svgRect.setAttribute("height",i+""),n.appendChild(this.svgRect)},t.prototype.updateSvgRect=function(t){this.pointOnBorder=[],this.pointOnBorder.push(t.x,t.y);var e=Math.abs(t.x-this.rectangle[0]),i=Math.abs(t.y-this.rectangle[1]),n={x:this.rectangle[0],y:this.rectangle[1]};if(t.x<n.x||t.y<n.y){t.x<n.x&&(n.x=t.x),t.y<n.y&&(n.y=t.y);var o=this.vfData.getOriginSize(),s=["translate(",n.x-o[0]/2,",",n.y-o[1]/2,") ","rotate(",0,") "].join("");this.svgRect.setAttribute("transform",s)}this.svgRect.setAttribute("width",e+""),this.svgRect.setAttribute("height",i+"")},t.prototype.resetSvgRect=function(){var t=Math.abs(this.rectangle[0]-this.rectangle[2]),e=Math.abs(this.rectangle[1]-this.rectangle[3]);this.svgRect.setAttribute("width",t+""),this.svgRect.setAttribute("height",e+"");var i=this.vfViewer.getAuxContainer(),n=i.clientWidth,o=i.clientHeight,s=["translate(",this.rectangle[0]-n/2,",",this.rectangle[1]-o/2,") ","rotate(",0,") "].join("");this.svgRect.setAttribute("transform",s),this.eventManager.dispatchEvent({type:EventType.Minimap_Rect_Changed,rectInfo:this.getRectangleInfo()})},t.prototype.clearRectangle=function(){this.rectangle=[]},t.prototype.adjustRectangle=function(t,e,i){if(e[0]>=i[0])switch(t){case 0:case 1:case 2:e[0]=i[0];break;case 4:case 5:case 6:i[0]=e[0]}if(e[1]>=i[1])switch(t){case 2:case 3:case 4:i[1]=e[1];break;case 6:case 7:case 0:e[1]=i[1]}return e.concat(i)},t.prototype.gripDragging=function(t,e){var i=this.rectangle,n=e.x-t.x,o=e.y-t.y,s=[i[0],i[1]],r=[i[2],i[3]];switch(this.currentGripId){case 0:s[0]+=n,s[1]+=o;break;case 1:s[0]+=n;break;case 2:s[0]+=n,r[1]+=o;break;case 3:r[1]+=o;break;case 4:r[0]+=n,r[1]+=o;break;case 5:r[0]+=n;break;case 6:s[1]+=o,r[0]+=n;break;case 7:s[1]+=o;break;default:console.log("default grip id."+this.currentGripId)}var a=this.vfData.getOriginSize();r[0]=r[0]>a[0]?a[0]:r[0],r[1]=r[1]>a[1]?a[1]:r[1],this.rectangle=this.adjustRectangle(this.currentGripId,s,r)},t.prototype.hightlightGrip=function(t){var e={x:t.offsetX,y:t.offsetY},i=this.hitGrips(e);i!=this.lastHighlightGripId&&(this.currentGripId<0&&this.lastHighlightGripId>=0&&(document.getElementById(this.rectForMinimapId+"-"+this.lastHighlightGripId).style.stroke=this.vfData.getGlodonColor()));(this.currentGripId>=0||i>=0)&&(this.currentGripId>=0&&(i=this.currentGripId),document.getElementById(this.rectForMinimapId+"-"+i).style.stroke="#f5a623",this.currentGripId<0&&(this.lastHighlightGripId=i))},t.prototype.drawGrips=function(){for(var t=this.getGrips(),e=0;e<t.length;e+=2){if(!((e/2-1)%2)){var i=this.createSegmentGrip(e/2,this.vfData.getGlodonColor());this.currentGripId==e/2&&(i=this.createSegmentGrip(e/2,"#FF9D0B")),this.vfViewer.getAuxContainer().appendChild(i)}}for(e=0;e<t.length;e+=2){if(!!((e/2-1)%2)){i=this.createGrip(e/2,this.vfData.getGlodonColor());this.currentGripId==e/2&&(i=this.createGrip(e/2,"#FF9D0B")),this.vfViewer.getAuxContainer().appendChild(i)}}},t.prototype.createSegmentGrip=function(t,e){var i=this.getGrips(),n=this.rectForMinimapId+"-"+t,o=document.getElementById(n);o&&o.parentNode.removeChild(o);var s=this.createSvgElement("line"),r=this.vfViewer.getAuxContainer().clientWidth,a=this.vfViewer.getAuxContainer().clientHeight,l=(t-1)%(i.length/2),h=(t+1)%(i.length/2),c=String(i[2*l]-r/2),d=String(i[2*l+1]-a/2),u=String(i[2*h]-r/2),p=String(i[2*h+1]-a/2);return s.setAttribute("id",n),s.setAttribute("x1",c),s.setAttribute("y1",d),s.setAttribute("x2",u),s.setAttribute("y2",p),s.setAttribute("style","fill: none; stroke: "+(e||"#4784cb")+"; stroke-width: 2; fill: #ffffff; display: block; position: absolute"),s},t.prototype.createGrip=function(t,e){var i=this.getGrips(),n=this.rectForMinimapId+"-"+t,o=document.getElementById(n);o&&o.parentNode.removeChild(o);var s=this.createSvgElement("circle"),r=this.vfViewer.getAuxContainer().clientWidth,a=this.vfViewer.getAuxContainer().clientHeight,l=["translate(",i[2*t]-r/2,",",i[2*t+1]-a/2,") ","rotate(",0,") "].join("");return s.setAttribute("id",n),s.setAttribute("transform",l),s.setAttribute("r","3"),s.setAttribute("style","fill: none; stroke: "+(e||"#4784cb")+"; stroke-width: 1; fill: #ffffff; display: block; position: absolute"),s},t.prototype.removeGrips=function(){for(var t=0;t<8;t++){var e=document.getElementById(this.rectForMinimapId+"-"+t);e&&e.parentNode.removeChild(e)}},t.prototype.removeSvgRect=function(){var t=document.getElementById(this.rectForMinimapId);t&&t.parentNode.removeChild(t)},t.prototype.destroyAll=function(){this.removeGrips(),this.removeSvgRect(),this.clearRectangle(),this.eventManager.dispatchEvent({type:EventType.Minimap_Rect_Destroyed})},t.prototype.getGrips=function(){var t={x:this.rectangle[0],y:this.rectangle[1]},e={x:this.rectangle[2],y:this.rectangle[3]},i={x:(t.x+e.x)/2,y:(t.y+e.y)/2},n=[];return n.push(t.x,t.y),n.push(t.x,i.y),n.push(t.x,e.y),n.push(i.x,e.y),n.push(e.x,e.y),n.push(e.x,i.y),n.push(e.x,t.y),n.push(i.x,t.y),n},t.prototype.hitGrips=function(t){for(var e=this.getGrips(),i=0;i<e.length;i+=2){var n=!1;if(!((i/2-1)%2)){var o=(i/2-1)%(e.length/2),s=(i/2+1)%(e.length/2),r=e[2*o],a=e[2*o+1],l=e[2*s],h=e[2*s+1];n=this.isPointInSegment(t.x,t.y,r,a,l,h,3)}else{var c=[e[i],e[i+1]];n=this.isPointInCircle(t,c,6)}if(n)return i/2}return-1},t.prototype.isPointInCircle=function(t,e,i){var n=t.x-e[0],o=t.y-e[1];return Math.sqrt(n*n+o*o)<=i},t.prototype.isPointInSegment=function(t,e,i,n,o,s,r){r=r||0;var a=(o-i)*(t-i)+(s-n)*(e-n);if(a<=0)return Math.sqrt((t-i)*(t-i)+(e-n)*(e-n))<=r;var l=(o-i)*(o-i)+(s-n)*(s-n);if(a>=l)return Math.sqrt((t-o)*(t-o)+(e-s)*(e-s))<=r;var h=a/l,c=i+(o-i)*h,d=n+(s-n)*h;return Math.sqrt((t-c)*(t-c)+(d-e)*(d-e))<=r},t.prototype.isPointInRectangle=function(t,e){if(this.pointsCount()<2)return!1;var i=this.rectangle,n=i[0]<i[2]?[i[0],i[2]]:[i[2],i[0]],o=n[0],s=n[1],r=(i[1],i[3],[i[1],i[3]]);return o<t&&t<s&&r[0]<e&&e<r[1]},t.prototype.panRectangle=function(t,e){var i=this.rectangle,n=this.vfViewer.getDomContainer().getBoundingClientRect();this.lastMousePointToRectMin.x+t<0?t=-this.lastMousePointToRectMin.x:this.lastMousePointToRectMax.x+t>n.width&&(t=n.width-this.lastMousePointToRectMax.x),this.lastMousePointToRectMin.y+e<0?e=-this.lastMousePointToRectMin.y:this.lastMousePointToRectMax.y+e>n.height&&(e=n.height-this.lastMousePointToRectMax.y),i[0]=this.lastMousePointToRectMin.x+t,i[1]=this.lastMousePointToRectMin.y+e,i[2]=this.lastMousePointToRectMax.x+t,i[3]=this.lastMousePointToRectMax.y+e,this.resetSvgRect(),this.drawGrips()},t.prototype.updateLastMousePointToRect=function(){this.lastMousePointToRectMin.x=this.rectangle[0]-this.lastMousePoint.x,this.lastMousePointToRectMin.y=this.rectangle[1]-this.lastMousePoint.y,this.lastMousePointToRectMax.x=this.rectangle[2]-this.lastMousePoint.x,this.lastMousePointToRectMax.y=this.rectangle[3]-this.lastMousePoint.y},t.prototype.zoomAndPan=function(t,e,i){if(this.pointsCount()<2)return this.panOffset=[t,e],void(this.zoomFactor=i);for(var n=this.vfViewer.getDomContainer().getBoundingClientRect(),o=n.width,s=n.height,r=new THREE.Vector2(.5*o,.5*s),a=0;a<=this.rectangle.length/2;a+=2){var l=new THREE.Vector2(this.rectangle[a]-this.panOffset[0],this.rectangle[a+1]-this.panOffset[1]).clone().sub(r);l.divideScalar(this.zoomFactor),this.rectangle[a]=l.x+r.x,this.rectangle[a+1]=l.y+r.y;var h=new THREE.Vector2(this.rectangle[a],this.rectangle[a+1]).clone().sub(r);h.multiplyScalar(i),this.rectangle[a]=r.x+h.x+t,this.rectangle[a+1]=r.y+h.y+e}this.panOffset=[t,e],this.zoomFactor=i,this.resetSvgRect(),this.drawGrips()},t}(),RectPickEditor=function(t){function e(e,i){var n=t.call(this)||this;return n.name=EditorName.RECTPICK_Editor,n.eventManager=i,n.viewerFloorData=e.getData(),n.naviAction=new NaviAction(e),n.vfViewer=e,n.algorithm=new Algorithm,n}return __extends(e,t),e.prototype.onMouseDown=function(t){this.naviAction.setMouseState(!0);var e=this.adjustEvent(t);if(this.naviAction.setLastMousePoint(e.clientX,e.clientY),0==this.naviAction.pointsCount()){var i={x:e.offsetX,y:e.offsetY};this.naviAction.addPointToRectangle(i.x,i.y),this.naviAction.createSvgRect(i)}if(2==this.naviAction.pointsCount()){var n={x:t.offsetX,y:t.offsetY},o=this.naviAction.hitGrips(n),s=this.naviAction.isPointInRectangle(n.x,n.y);o>=0?this.naviAction.setEditMode(!0):s&&(this.naviAction.updateLastMousePointToRect(),this.naviAction.setPanMode(!0))}this.eventManager.dispatchEvent({type:EventType.RECTPICK_MOUSE_DOWN})},e.prototype.onMouseMove=function(t){if(2==this.naviAction.pointsCount()&&this.naviAction.hightlightGrip(t),this.naviAction.getMouseState()){var e=this.vfViewer.getDomContainer().getBoundingClientRect(),i=t.clientX-e.left,n=t.clientY-e.top;if(this.naviAction.pointsCount()<2&&this.naviAction.updateSvgRect({x:i,y:n}),this.naviAction.getEditMode()){var o={x:i,y:n},s=this.naviAction.hitGrips(o);if(this.naviAction.getMouseClickState())return this.firstPos=o,this.naviAction.setMouseClickState(!1),void(s>=0&&this.naviAction.setCurrentGripId(s));var r=o;this.naviAction.getCurrentGripId()>=0&&(this.naviAction.gripDragging(this.firstPos,r),this.naviAction.resetSvgRect(),this.naviAction.removeGrips(),this.naviAction.drawGrips()),this.firstPos=r}this.naviAction.getPanMode()&&this.naviAction.panRectangle(t.clientX,t.clientY)}},e.prototype.onMouseUp=function(t){if(this.naviAction.setMouseState(!1),this.naviAction.setMouseClickState(!0),this.naviAction.setCurrentGripId(-1),this.naviAction.setPanMode(!1),this.naviAction.equalWithLastPoint(t.clientX,t.clientY))1==this.naviAction.pointsCount()&&this.naviAction.clearRectangle();else{if(1==this.naviAction.pointsCount()){var e=this.adjustEvent(t),i=this.vfViewer.getDomContainer().getBoundingClientRect(),n=e.clientX-i.left,o=e.clientY-i.top;this.naviAction.pointValidation(n,o),this.naviAction.resetSvgRect(),this.naviAction.drawGrips()}this.naviAction.setEditMode(!1)}},e.prototype.clear=function(){this.naviAction.destroyAll()},e.prototype.getBoundingBoxIsolate=function(){var t=this.naviAction.getRectangle(),e={x:t[0]+ZoomEditor.offsetXForZoomAndPan,y:t[1]+ZoomEditor.offsetYForZoomAndPan},i={x:t[2]+ZoomEditor.offsetXForZoomAndPan,y:t[3]+ZoomEditor.offsetYForZoomAndPan},n=this.algorithm.getCuttingBoxOnCanvas(e,i,this.viewerFloorData.getSize(),this.viewerFloorData.getAxisGridBox2D()),o=this.viewerFloorData.getFloorPlaneBox();return n.min.z=o.min.z,n.max.z=o.max.z,n},e.prototype.getIntersectionByNormalizedPoint=function(t,e){var i=this.vfViewer.getData().getIntersections(),n=new THREE.Vector2(t.x,t.y);return this.algorithm.normalizedPointToScreen(n,{width:e[0]/2,height:e[1]/2}),Algorithm.getIntersectionByPoint(i,n)},e.prototype.adjustEvent=function(t){var e={offsetX:t.offsetX,offsetY:t.offsetY,clientX:t.clientX,clientY:t.clientY},i=new THREE.Vector2(e.clientX,e.clientY);i.x+=ZoomEditor.offsetXForZoomAndPan,i.y+=ZoomEditor.offsetYForZoomAndPan;var n=this.vfViewer.getMapContainer(),o=this.vfViewer.getData().getSize(),s=this.algorithm.normalizePoint(n,o,i),r=this.getIntersectionByNormalizedPoint(s,o);if(r){var a=this.vfViewer.getDomContainer().getBoundingClientRect();e.clientX=r.intersectionPoint.x-ZoomEditor.offsetXForZoomAndPan,e.offsetX=e.clientX+o[0]/2,e.clientX=e.offsetX+a.left,e.clientY=r.intersectionPoint.y-ZoomEditor.offsetYForZoomAndPan,e.offsetY=e.clientY+o[1]/2,e.clientY=e.offsetY+a.top}return e},e}(Editor),ViewerFloorEditor=function(){function t(t,e,i){this.eventManager=new EventManager,this.mapContainer=t,this.viewerFloorData=e,this.vfViewer=i,this.vfViewer.setEventManager(this.eventManager),this.activeEditors=[],this.bIsEnablePickHover=!1,this.initialize()}return t.prototype.initialize=function(){this.onContextmenuBinded=this.onContextmenu.bind(this),this.onMouseDownBinded=this.onMouseDown.bind(this),this.onMouseUpBinded=this.onMouseUp.bind(this),this.onMouseMoveBinded=this.onMouseMove.bind(this),this.onMouseWheelBinded=this.onMouseWheel.bind(this),this.addDomEventListeners(),this.enableEditor(EditorName.PICK_Editor),this.enableEditor(EditorName.PAN_Editor),this.enableEditor(EditorName.Zoom_Editor)},t.prototype.addDomEventListeners=function(){var t=this.mapContainer;t.addEventListener("contextmenu",this.onContextmenuBinded,!1),t.addEventListener("mousemove",this.onMouseMoveBinded,!1),t.addEventListener("mousedown",this.onMouseDownBinded,!1),t.addEventListener("mousewheel",this.onMouseWheelBinded,!1),document.addEventListener("mouseup",this.onMouseUpBinded,!1)},t.prototype.removeDomEventListeners=function(){var t=this.mapContainer;t.removeEventListener("contextmenu",this.onContextmenuBinded,!1),t.removeEventListener("mousemove",this.onMouseMoveBinded,!1),t.removeEventListener("mousedown",this.onMouseDownBinded,!1),document.removeEventListener("mouseup",this.onMouseUpBinded,!1)},t.prototype.onMouseDown=function(t){for(var e=this.activeEditors,i=0;i<e.length;i++){var n=e[i];n.getName()==EditorName.PICK_Editor&&t.button!=MouseEventType.Left||(n.getName()==EditorName.RECTPICK_Editor&&t.button!=MouseEventType.Left||n.getName()==EditorName.PAN_Editor&&t.button==MouseEventType.Left||n.onMouseDown(t))}},t.prototype.onMouseMove=function(t){for(var e=this.activeEditors,i=0;i<e.length;i++){var n=e[i];n.getName()==EditorName.PICK_Editor&&0==this.bIsEnablePickHover||n.onMouseMove(t)}},t.prototype.onMouseUp=function(t){for(var e=this.activeEditors,i=0;i<e.length;i++){var n=e[i];n.getName()==EditorName.PICK_Editor&&t.button!=MouseEventType.Left||(n.getName()==EditorName.RECTPICK_Editor&&t.button!=MouseEventType.Left||n.getName()==EditorName.PAN_Editor&&t.button==MouseEventType.Left||n.onMouseUp(t))}},t.prototype.onMouseWheel=function(t){var e=this.find(EditorName.Zoom_Editor);e&&e.onMouseWheel(t)},t.prototype.onContextmenu=function(t){t.preventDefault()},t.prototype.addEventListener=function(t,e){this.eventManager.addEventListener(t,e)},t.prototype.clearRectPick=function(){var t=this.find(EditorName.RECTPICK_Editor);t instanceof RectPickEditor&&t.clear()},t.prototype.clearZoomAndPan=function(){PanEditor.clear(),ZoomEditor.clear(),this.viewerFloorData.setZoomFactor(1);var t=this.find(EditorName.Zoom_Editor);t instanceof ZoomEditor&&t.setZoonIndex(0)},t.prototype.getBoundingBoxIsolate=function(){var t=this.find(EditorName.RECTPICK_Editor);if(t instanceof RectPickEditor)return t.getBoundingBoxIsolate()},t.prototype.setMapClickMode=function(t){var e=this.find(EditorName.PICK_Editor);e instanceof PickEditor&&e.setClickMode(t)},t.prototype.find=function(t){for(var e=this.activeEditors,i=0;i<e.length;i++)if(e[i].getName()===t)return e[i]},t.prototype.enableEditor=function(t){if(!this.find(t)){var e=this.activeEditors;switch(t){case EditorName.PICK_Editor:e.push(new PickEditor(this.vfViewer,this.eventManager));break;case EditorName.RECTPICK_Editor:e.push(new RectPickEditor(this.vfViewer,this.eventManager));break;case EditorName.PAN_Editor:e.push(new PanEditor(this.vfViewer,this.eventManager));break;case EditorName.Zoom_Editor:e.push(new ZoomEditor(this.vfViewer,this.eventManager))}}},t.prototype.getEventManager=function(){return this.eventManager},t.prototype.disableEditor=function(t){for(var e=this.activeEditors,i=0;i<e.length;i++)e[i].getName()===t&&e.splice(i,1)},t.prototype.enablePickHover=function(t){this.bIsEnablePickHover=t},t.prototype.setZoomMode=function(t){var e=this.find(EditorName.Zoom_Editor);e instanceof ZoomEditor&&e.enableMode(t)},t.prototype.setZoomFactors=function(t){var e=this.find(EditorName.Zoom_Editor);e instanceof ZoomEditor&&e.setZoomFactors(t)},t}(),ViewerFloor=function(){function t(t,e){this.vfData=new ViewerFloorData,this.vfView=new ViewerFloorView(t,e,this.vfData),this.bIsEnableFloorPlaneChangedEvent=!0;var i=this.getMapContainer();this.vfEditor=new ViewerFloorEditor(i,this.vfData,this.vfView),THREE.vf=this}return t.prototype.setAxisGridData=function(t){this.vfData.setAxisGrids(t)},t.prototype.setPlanes=function(t){this.vfData.setPlanes(t)},t.prototype.setFloorPlaneId=function(t){this.vfData.setFloorPlaneId(t);var e=this.vfData.getProperZoomFactors();this.vfEditor.setZoomFactors(e),PanEditor.clear(),this.bIsEnableFloorPlaneChangedEvent&&this.vfEditor.getEventManager().dispatchEvent({type:EventType.Floor_Plane_Changed,elevation:this.vfData.getElevationById()}),this.vfEditor.getEventManager().dispatchEvent({type:EventType.Floor_Plane_Changed_For_Panel,name:this.getFloorPlaneName()})},t.prototype.getEventManager=function(){return this.vfEditor.getEventManager()},t.prototype.enableFloorPlaneChangedEvent=function(t){this.bIsEnableFloorPlaneChangedEvent=t},t.prototype.setSize=function(t,e){this.vfData.setSize(t,e)},t.prototype.setFlip=function(t){this.vfData.setFlip(t)},t.prototype.resize=function(t,e,i){this.vfEditor.clearZoomAndPan(),this.vfData.setIsShowAxisGrid(i),this.vfData.setSize(t,e),this.vfView.setSize(t,e),i?(this.vfEditor.setZoomMode(VFSizeMode.Max),this.vfEditor.enableEditor(EditorName.RECTPICK_Editor),this.vfEditor.enablePickHover(!0)):(this.clearRectPick(),this.vfEditor.setZoomMode(VFSizeMode.Min),this.vfEditor.disableEditor(EditorName.RECTPICK_Editor),this.vfEditor.enablePickHover(!1)),this.vfData.getTipNode().hide()},t.prototype.destroy=function(){this.vfView.destroy(),this.vfData.destroy(),this.clearRectPick()},t.prototype.rebuildData=function(){this.vfData.build()},t.prototype.renderCameraNode=function(){this.vfView.updateCameraNode()},t.prototype.addEventListener=function(t,e){this.vfEditor.addEventListener(t,e)},t.prototype.clearRectPick=function(){this.vfEditor.clearRectPick()},t.prototype.clearZoomAndPan=function(){this.vfEditor.clearZoomAndPan(),this.vfView.destroy(),this.vfData.destroy(),this.vfData.build(),this.vfView.update()},t.prototype.getBoundingBoxIsolate=function(){return this.vfEditor.getBoundingBoxIsolate()},t.prototype.getFloorPlaneName=function(){return this.vfData.getDataFloorPlanes().getName(this.vfData.getFloorPlaneId())},t.prototype.getAxisGridBox2D=function(){return this.vfData.getAxisGridBox2D()},t.prototype.setMapClickMode=function(t){this.vfEditor.setMapClickMode(t)},t.prototype.getMapContainer=function(){return this.vfView.getDomContainer()},t.prototype.render=function(){this.vfView.update()},t.prototype.getPanOffset=function(){return{x:PanEditor.panOffsetX,y:PanEditor.panOffsetY}},t.prototype.registerCameraHeightChanged=function(t){this.vfView.registerCameraHeightChanged(t)},t}();!function(){var t="Bimface.Plugins.Section.SectionPlane",e=Glodon$1.Bimface.Data.StatisticsDataManager.getInstance(),i=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Map"),n=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.Dom"),o=(Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.HttpRequest"),function(t){var e=this,i=t;if(this.defaultFloorPlane="F01",e._opt=i,e.id=t.id,!i.domElement)return console.log("domElement must not be empty."),!1;if(!i.viewer)return console.log("viewer is not defined."),!1;let n=new Glodon$1.Web.Lang.EventManager;this.getEventManager=function(){return n},this.EventType={RECTPICK_MOUSE_MOVE:1001,RECTPICK_MOUSE_UP:1002,PICK_MOUSE_UP:2002,Floor_Plane_Changed:3e3,Floor_Plane_Changed_For_Panel:3001,Camera_Height_Changed:5e3,ZOOM_MOUSE_WHEEL:6e3,Minimap_Rect_Changed:8e3,Minimap_Rect_Destroyed:8001},e._floors=[],e._axisGrids={},e._hasFloor=void 0===i.hasFloor||i.hasFloor,e._mapHeader=i.mapHeader,e._mapEvents=Glodon$1.Bimface.Plugins.Map.MapEvents;var o=i.viewer.getViewer();const s=o.getBoundingBoxWorld(),r=s.max.z-s.min.z,a=i.viewer.getUnit()===Glodon$1.Bimface.Common.Units.LengthUnits.Meter;e._manHeight=e._hasFloor?a?1.75:1750:Math.min(a?1:1e3,r/20),e._refreshHeight=Math.min(a?3:3e3,r/10),o._manHeight=e._manHeight,e.viewerFloor=new ViewerFloor(o,i.domElement),e.viewerFloor.registerCameraHeightChanged(CLOUD$1.EVENTS.ON_CAMERA_HEIGHT_CHANGED),e._helper=this,e._useEngineMap=i.viewer._opt.enableRealisticMiniMap,e.renderCB=function(){e._inited&&e.viewerFloor.renderCameraNode()},o.addCallbacks("render",e.renderCB),e.init()});o.prototype={addEventListener:function(t,e){this.getEventManager().addEvent(t,e)},removeEventListener:function(t,e){this.getEventManager().removeEvent(t,e)},init:function(){e.send(t,"init");const i=this._opt.viewer;let o=[],s=[],r=[];if(this._hasFloor){const t=()=>{this._axisGrids={Grids:s,Levels:r},this._floors=o,(this._axisGrids.Grids||this._axisGrids.Levels)&&this.viewerFloor.setAxisGridData(this._axisGrids),this.viewerFloor.setPlanes(this._floors);var t=new Glodon$1.Bimface.UI.Select.SelectConfig;t.className="bf-select bf-select-map";var e=this.getDefaultFloorPlane(),i=this._floors.getObjectByAttribute("name",e);0!=i&&(t.default=i.id),t.options=this._floors,t.element=this._mapHeader,t.prefix=BimfaceLanguage.bf_panel_map_level;var n=this,a=new Glodon$1.Bimface.UI.Select.Select(t);a.addEventListener("Change",(function(t){n.showFloorById(t.id)})),this.addEventListener(this._mapEvents.FloorPlaneChanged,(function(t){a._currentElement.innerText=BimfaceLanguage.bf_panel_map_level+t})),this.createMap()};let e=0;const n=i.getModels().length;i.getModels().forEach((i=>{i["getMapInfo"+(this._opt.loadAsync?"Async":"")]((i=>{o=[...i.floors,...o],s=i.axisGrid.Grids?[...i.axisGrid.Grids,...s]:s,r=i.axisGrid.Levels?[...i.axisGrid.Levels,...r]:r,e++,e===n&&t()}),(()=>{e++,e===n&&t()}))}))}else{var a=n.create("div","bf-map-header-title");this._mapHeader.appendChild(a),this.addEventListener(this._mapEvents.FloorPlaneChanged,(function(t){void 0===t&&(t=0),i.getUnit()===Glodon$1.Bimface.Common.Units.LengthUnits.Millimeter&&(t/=1e3),a.innerHTML=BimfaceLanguage.bf_panel_map_height+t+"m"})),this.createMap()}},createMap:function(){e.send(t,"createMap");var i=(a=this).getEventManager(),n=Glodon$1.Bimface.Plugins.Map.MapEvents,o=a._opt;let s=this.EventType;if(this.viewerFloor.addEventListener(s.PICK_MOUSE_UP,(function(t){i.fireEvent(n.MouseClicked,t.data)})),this.viewerFloor.setMapClickMode(o.navigationMode.toLocaleLowerCase()),this.viewerFloor.addEventListener(s.Minimap_Rect_Changed,(function(t){i.fireEvent("MinimapRectChanged",t.rectInfo)})),this.viewerFloor.addEventListener(s.Minimap_Rect_Destroyed,(function(t){i.fireEvent("MinimapRectDestroyed",t)})),this.viewerFloor.addEventListener(s.Camera_Height_Changed,(function(t){a.viewerFloor.enableFloorPlaneChangedEvent(!1),a.showFloorById(t.id),a.viewerFloor.enableFloorPlaneChangedEvent(!0)})),this.viewerFloor.addEventListener(s.Floor_Plane_Changed_For_Panel,(function(t){i.fireEvent("FloorPlaneChanged",t.name)})),this.viewerFloor.addEventListener(s.ZOOM_MOUSE_WHEEL,(function(t){i.fireEvent(n.Zoom,t.data)})),this.viewerFloor.addEventListener(s.Floor_Plane_Changed,(function(t){if(null!=t.elevation){"string"==typeof t.elevation&&(t.elevation=parseFloat(t.elevation));var e=o.viewer.getViewer(),i=e.camera,n=t.elevation,s=o.viewer.sceneToWorld(i.position.clone()),r=new THREE.Vector3(s.x,s.y,n+a._manHeight);const h=e.getBoundingBoxWorld();r.z=Math.min(r.z,h.max.z);var l=o.viewer.worldToScene(r);e.cameraControl.flyToPointWithParallelEye(new THREE.Vector3(l.x,l.y,l.z))}})),a.viewerFloor.enableFloorPlaneChangedEvent(!1),a._hasFloor)if(this._useEngineMap){let t=this;t.viewerFloor.setFlip(!0);let e=o.viewer.getViewer();t.mapManager=new Glodon$1.Bimface.Plugins.Map.MapManager({viewer:o.viewer});const i=this._axisGrids,n=this._floors;let s={};s.maxPixel=t._opt.maxPixel,s.height=[],s.boundingbox=[],s.useBorder=!1;const r=i.Levels;for(let i=0;i<n.length;i++){const o=r.find((({id:t})=>t==n[i].id));if(o){const r=t.viewerFloor.vfData.getDataFloorPlanes().getFloorPlaneBox(n[i].id);let a=new THREE.Box3(new THREE.Vector3(r.Min.X,r.Min.Y,r.Min.Z),new THREE.Vector3(r.Max.X,r.Max.Y,r.Max.Z));a.applyMatrix4(e.getScene().getMatrixGlobal()),s.boundingbox.push(a),s.height.push(o.elevation)}}let a=e=>{for(let t=0;t<e.length;t++)n[t].path=e[t];if(n.length>0){var i=n.getObjectByAttribute("name",this.defaultFloorPlane);0==i?this.showFloorById(n[0].id):this.showFloorById(i.id)}t.viewerFloor.enableFloorPlaneChangedEvent(!0),t._inited=!0};s.successCallback=a,t.mapManager.removeCreateMapEvent(),t.mapManager.createMapByHeight(s)}else{const t=this._floors;if(t.length>0){var r=t.getObjectByAttribute("name",this.defaultFloorPlane);0==r?this.showFloorById(t[0].id):this.showFloorById(r.id)}a.viewerFloor.enableFloorPlaneChangedEvent(!0),a._inited=!0}else{var a;(a=this).viewerFloor.setFlip(!0);const t=o.viewer,e=t.getViewer().getBoundingBoxWorld(),i={Min:e.min,Max:e.max};a.mapManager=new Glodon$1.Bimface.Plugins.Map.MapManager({viewer:t});let n=t.getCamera().getStatus().position.z;n=Math.floor(Math.min(Math.max(n,e.min.z),e.max.z));let s=n=>{let o=t.getCamera().getStatus().position.z;o=Math.floor(Math.min(Math.max(o,e.min.z),e.max.z));let s=[];s.push({id:o,name:"top",elevation:o}),s.push({id:e.min.z,name:o.toString(),elevation:e.min.z});let r={Grids:[],Levels:s};a.viewerFloor.setAxisGridData(r);let l=[];l.push({id:o,name:o,path:n,BoundingBox:i}),a._floors=l,a.viewerFloor.setPlanes(l),a.showFloorById(o),a._inited=!0},r={};r.maxPixel=a._opt.maxPixel,r.spacing=a._refreshHeight,r.successCallback=s,a.mapManager.removeCreateMapEvent(),a.mapManager.createMapByCamera(r),t.getViewer().getModelManager().dispatchEvent({type:CLOUD$1.EVENTS.ON_CAMERA_CHANGED_AND_RENDERED})}},setDefaultFloorPlane:function(t){for(var e=this._floors,i=0;i<e.length;i++)if(e[i].name==t){this.viewerFloor;this.getEventManager().fireEvent("FloorPlaneChanged",t);var n=e.getObjectByAttribute("name",t);return helpershowFloorById(n.id),!0}return!1},getFloorList:function(){return this._floors},getDefaultFloorPlane:function(){return this.defaultFloorPlane},getBoundingBox:function(){return this.viewerFloor.getBoundingBoxIsolate()},showFloorById:function(t){this.viewerFloor.setFloorPlaneId(t),this.viewerFloor.destroy(),this.viewerFloor.rebuildData(),this.viewerFloor.render()},resize:function(t,e,i){var n=this._opt.domElement;n.style.width=t+"px",n.style.height=e+"px",this.viewerFloor.resize(t,e,i),this.getEventManager().fireEvent("Resize",{width:t,height:e})},setPlaneChangedCallback:function(t){this.addEventListener("FloorPlaneChanged",(function(e){t&&t(e)}))},setMinimapResizeCallback:function(t){this.addEventListener("Resize",(function(e){t&&t(e)}))},setNavigationMode:function(t){var e=this._opt,i=this.viewerFloor;e.navigationMode=t,i.setMapClickMode(e.navigationMode.toLocaleLowerCase())},clear:function(){this.viewerFloor.clearRectPick()},clearZoomAndPan:function(){this.viewerFloor.clearZoomAndPan();let t=this.EventType;this.viewerFloor.getEventManager().dispatchEvent({type:t.ZOOM_MOUSE_WHEEL,data:{offsetX:0,offsetY:0,zoomFactor:1}})},getMapContainer:function(){return this.viewerFloor.getMapContainer()},getFloorPlaneName:function(){return this.viewerFloor.getFloorPlaneName()},getAxisGridBox2D:function(){return this.viewerFloor.getAxisGridBox2D()},exit:function(){var t=this;t._opt.viewer.getViewer().removeCallbacks("render",t.renderCB),t.clear(),t.mapManager&&t.mapManager.destroy()}},i.Map=o}(),Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.NavigationMap").NavigationMapConfig=function(){return{viewer:null,mapViewer:null,successCallback:null,failureCallback:null,type:"Relevance",mapAnchors:null,modelAnchors:null,url:null,PDFId:void 0,drawingId:void 0,height:0}},function(){let t=Object.freeze({MouseClicked:"MouseClicked",MapChanged:"MapChanged"});Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.NavigationMap").MapViewerEvent=t}();
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */
var extendStatics$1=function(t,e){return extendStatics$1=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])},extendStatics$1(t,e)};function __extends$1(t,e){function i(){this.constructor=t}extendStatics$1(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}var EditorName$1,DrawableItem$1=function(){function t(){this.xmlns="http://www.w3.org/2000/svg",this.material=null,this.svgNode=null,this.children=[],this.glodonColor="#11DAB7",this.position=new THREE.Vector2}return t.prototype.add=function(t){this.children.push(t)},t.prototype.getSvgNode=function(){return this.svgNode},t.prototype.abtainRenderables=function(t){t.appendChild(this.svgNode)},t.prototype.isMatch=function(t){return this.name==t},t.prototype.highlight=function(){this.svgNode.setAttribute("style","stroke:"+this.glodonColor)},t.prototype.cancelHighlight=function(){this.svgNode.setAttribute("style","stroke:"+this.material.color.getStyle())},t.prototype.locate=function(t,e){this.position.set(t,e),this.move(0,0)},t.prototype.move=function(t,e){var i=this.position.x+t,n=this.position.y+e;this.svgNode.setAttribute("transform","translate("+i+","+n+")")},t}(),Algorithm$1=function(){function t(){this._boxSize=new THREE.Vector2,this._boxCenter=new THREE.Vector2,this._intersect=new THREE.Vector3}return t.prototype.cross=function(t,e,i,n){return(e.x-t.x)*(n.y-i.y)-(e.y-t.y)*(n.x-i.x)},t.prototype.getArea=function(t,e,i){return this.cross(t,e,t,i)},t.prototype.getAbsArea=function(t,e,i){return Math.abs(this.getArea(t,e,i))},t.prototype.getInterPoint=function(t,e,i,n){var o=this.getAbsArea(t,e,i),s=this.getAbsArea(t,e,n);return new THREE.Vector2((n.x*o+i.x*s)/(o+s),(n.y*o+i.y*s)/(o+s))},t.prototype.isAngleGreaterThanPi=function(t,e,i){var n=new THREE.Vector3;return n.crossVectors(t,e),!(n.dot(i)>=0)},t.prototype.normalizedPointToScreen=function(t,e){t.x=t.x*e.width,t.y=-t.y*e.height},t.prototype.screenToNormalizedPoint=function(t,e){t.x=t.x/e.width,t.y=-t.y/e.height},t.prototype.normalizedPointToWorld=function(t,e){e.getSize(this._boxSize),t.x=.5*(t.x+1)*this._boxSize.x+e.min.x,t.y=.5*(t.y+1)*this._boxSize.y+e.min.y},t.prototype.worldToNormalizedPoint=function(t,e){e.getSize(this._boxSize),t.x=(t.x-e.min.x)/this._boxSize.x*2-1,t.y=(t.y-e.min.y)/this._boxSize.y*2-1},t.prototype.toWorldPoint=function(t,e,i,n){t.x<0&&(t.x=0),t.x>e&&(t.x=e),t.y<0&&(t.y=0),t.y>i&&(t.y=i),t.x=t.x/e*2-1,t.y=-t.y/i*2+1,this.normalizedPointToWorld(t,n)},t.prototype.getCuttingBoxOnCanvas=function(t,e,i,n){var o=new THREE.Box3,s=new THREE.Vector2(t.x,t.y),r=new THREE.Vector2(e.x,e.y);this.toWorldPoint(s,i[0],i[1],n),this.toWorldPoint(r,i[0],i[1],n);var a=[];return a.push(new THREE.Vector3(s.x,s.y)),a.push(new THREE.Vector3(s.x,s.y)),a.push(new THREE.Vector3(s.x,r.y)),a.push(new THREE.Vector3(s.x,r.y)),a.push(new THREE.Vector3(r.x,r.y)),a.push(new THREE.Vector3(r.x,r.y)),a.push(new THREE.Vector3(r.x,s.y)),a.push(new THREE.Vector3(r.x,s.y)),o.setFromPoints(a),{min:{x:o.min.x,y:o.min.y,z:0},max:{x:o.max.x,y:o.max.y,z:0}}},t.prototype.canvasPointToClient=function(t,e){var i=e.mapContainer;if(!i||!e.floorPlaneBox)return null;var n=this.getContainerOffsetToClient(i);if(0===n.width||0===n.height)return null;var o=new THREE.Vector2;return o.x=t.x+n.left,o.y=t.y+n.top,o},t.prototype.getMainSceneMatrix=function(t){return t.getScene().getMatrixGlobal()},t.prototype.transformWorldPoint=function(t,e){var i=this.getMainSceneMatrix(t);e.applyMatrix4(i)},t.prototype.expandBbox=function(t,e){var i=t.getCenter(this._boxCenter);t.getSize(this._boxSize);var n=new THREE.Vector2,o=e,s=this._boxSize.x/this._boxSize.y,r=this._boxSize.x,a=this._boxSize.y;s>o?a=r/o:s<o&&(r=a*o),n.set(r,a),t.setFromCenterAndSize(i,n)},t.prototype.containsPointInMainScene=function(t,e){var i=t.getScene().getBoundingBoxWorld();return!!i&&i.containsPoint(e)},t.prototype.isMouseOverCanvas=function(t,e,i){if(t){var n=this.getContainerOffsetToClient(t),o=new THREE.Vector2;if(o.x=i.x-n.left,o.y=i.y-n.top,0===n.width||0===n.height)return!1;var s={width:e[0],height:e[0]};if(o.x>0&&o.x<s.width&&o.y>0&&o.y<s.height)return!0}return!1},t.prototype.normalizePoint=function(t,e,i){var n=new THREE.Vector2;if(t){var o=this.getContainerOffsetToClient(t),s=new THREE.Vector2;s.x=i.x-o.left,s.y=i.y-o.top;var r={width:e[0],height:e[1]};if(s.x>0&&s.x<r.width&&s.y>0&&s.y<r.height)return n.x=s.x/r.width*2-1,n.y=-s.y/r.height*2+1,new THREE.Vector2(n.x,n.y)}return null},t.getIntersectionByPoint=function(t,e,i){void 0===i&&(i=3);for(var n=null,o=i*i,s=0,r=t.length;s<r;s++){var a=t[s].intersectionPoint;if(a)if(a.distanceToSquared(e)<o){n=t[s];break}}return n},t.prototype.flyToPointWithParallelEye=function(t,e){t.cameraControl.flyToPointWithParallelEye(e)},t.prototype.getIntersectionToMinDistance=function(t,e){if(t.length<1)return null;for(var i=0,n=0,o=0,s=t.length;o<s;o++){var r=t[o];if(r.intersectionPoint){var a=new THREE.Vector2(r.intersectionPoint.x,r.intersectionPoint.y).distanceToSquared(e);0==i?i=a:i>a&&(i=a,n=o)}}return t[n]},t.prototype.getAxisGridInfoByNormalizedPoint=function(t,e){var i=e.clone(),n=t.naviData.getAxisGridBox2D();this.normalizedPointToWorld(i,n);var o=e.clone(),s={width:t.svgHalfWidth,height:t.svgHalfHeight};this.normalizedPointToScreen(o,s);var r=this.getIntersectionToMinDistance(t.naviData.getAxisGridIntersectionPoints(),o);if(r&&r.intersectionPoint){var a=new THREE.Vector2(r.intersectionPoint.x,r.intersectionPoint.y);this.screenToNormalizedPoint(a,s),this.normalizedPointToWorld(a,n);var l=Math.round(i.x-a.x),h=Math.round(i.y-a.y);return{position:i,abcName:r.abcName,numeralName:r.numeralName,offsetX:l,offsetY:h}}return{position:new THREE.Vector3,abcName:"",numeralName:"",offsetX:"",offsetY:""}},t.prototype.getAxisGridInfoByPoint=function(t,e){var i=this.getMainSceneMatrix(t.viewer),n=new THREE.Matrix4;n.copy(i).invert();var o=e.clone();o.applyMatrix4(n);var s=o.clone(),r={width:t.svgHalfWidth,height:t.svgHalfHeight},a=t.naviData.getAxisGridBox2D();this.worldToNormalizedPoint(s,a),this.normalizedPointToScreen(s,r);var l=this.getIntersectionToMinDistance(t.naviData.getAxisGridIntersectionPoints(),s);if(l&&l.intersectionPoint){var h=new THREE.Vector2(l.intersectionPoint.x,l.intersectionPoint.y);this.screenToNormalizedPoint(h,r),this.normalizedPointToWorld(h,a);var c=Math.round(o.x-h.x),d=Math.round(o.y-h.y);return{position:o,abcName:l.abcName,numeralName:l.numeralName,offsetX:c,offsetY:d}}return{position:new THREE.Vector3,abcName:"",numeralName:"",offsetX:"",offsetY:""}},t.prototype.calculateEdgePositionCameraOutBounds=function(t,e,i){var n=function(t,e){for(var i=!1,n=0,o=t.length;n<o;n++)if(this.isEqualBetweenPoints(e,t[n],this.epsilon)){i=!0;break}return i},o=i.clone();if(o.min.x-=.5,o.min.y-=.5,o.max.x+=.5,o.max.y+=.5,!o.containsPoint(t)){var s=[],r=new THREE.Vector3(t.x,t.y,0),a=new THREE.Ray(r,e),l=new THREE.Vector3(i.min.x,i.min.y,0),h=new THREE.Vector3(-1,0,0),c=new THREE.Plane;if(c.setFromNormalAndCoplanarPoint(h,l),a.intersectPlane(c,this._intersect),this._intersect&&o.containsPoint(this._intersect)&&s.push(this._intersect),l.set(i.max.x,i.max.y,0),h.set(-1,0,0),c.setFromNormalAndCoplanarPoint(h,l),a.intersectPlane(c,this._intersect),this._intersect&&o.containsPoint(this._intersect)&&s.push(this._intersect),l.set(i.min.x,i.min.y,0),h.set(0,1,0),c.setFromNormalAndCoplanarPoint(h,l),a.intersectPlane(c,this._intersect),this._intersect&&o.containsPoint(this._intersect)&&(n(this._intersect,s)||s.push(this._intersect)),l.set(i.max.x,i.max.y,0),h.set(0,1,0),c.setFromNormalAndCoplanarPoint(h,l),a.intersectPlane(c,this._intersect),this._intersect&&o.containsPoint(this._intersect)&&(n(this._intersect,s)||s.push(this._intersect)),2!=s.length)return null;var d=s[0],u=s[1].clone().sub(d).normalize();return this.isEqualBetweenPoints(u,e,1e-5)?s[0]:s[1]}return null},t.prototype.getContainerOffsetToClient=function(t){var e,i;if(t!=document){var n=(i=t).getBoundingClientRect?function(t){var e=t.getBoundingClientRect(),i=document.body,n=document.documentElement,o=n.clientTop||i.clientTop,s=n.clientLeft||i.clientLeft,r=e.top-o,a=e.left-s;return{top:Math.round(r),left:Math.round(a)}}(i):function(t){for(var e=0,i=0;t;)e+=t.offsetTop,i+=t.offsetLeft,t=t.offsetParent;var n=document.body,o=document.documentElement;return{top:e-=window.pageYOffset||o.scrollTop||n.scrollTop,left:i-=window.pageXOffset||o.scrollLeft||n.scrollLeft}}(i);e={width:t.offsetWidth,height:t.offsetHeight,left:n.left,top:n.top}}else e={width:window.innerWidth,height:window.innerHeight,left:0,top:0};return e},t.prototype.isEqualBetweenPoints=function(t,e,i){i=i||1e-4;var n=t.x-e.x,o=t.y-e.y;return!(Math.sqrt(n*n+o*o)>i)},t}(),GridLine$1=function(t){function e(e,i,n,o){var s=t.call(this)||this;return s.start=e,s.end=i,s.material=n,s.name=o,s.build(),s}return __extends$1(e,t),e.prototype.build=function(){var t=document.createElementNS(this.xmlns,"line");t.setAttribute("x1",this.start.x),t.setAttribute("y1",this.start.y),t.setAttribute("x2",this.end.x),t.setAttribute("y2",this.end.y);var e=this.material;e instanceof THREE.LineBasicMaterial&&t.setAttribute("style","fill: none; stroke: "+e.color.getStyle()+"; stroke-width: "+e.linewidth+"; stroke-opacity: "+e.opacity+"; stroke-linecap: "+e.linecap+"; stroke-linejoin: "+e.linejoin),this.svgNode=t},e}(DrawableItem$1),GridLineArc$1=function(t){function e(e,i,n){var o=t.call(this)||this;return o.arcPoints=e,o.material=i,o.name=n,o.build(),o}return __extends$1(e,t),e.prototype.build=function(){var t=document.createElementNS(this.xmlns,"polyline");t.setAttribute("points",this.arcPoints.map((function(t){return t.x+","+t.y})).join(" "));var e=this.material;e instanceof THREE.LineBasicMaterial&&t.setAttribute("style","fill: none; stroke: "+e.color.getStyle()+"; stroke-width: "+e.linewidth+"; stroke-opacity: "+e.opacity+"; stroke-linecap: "+e.linecap+"; stroke-linejoin: "+e.linejoin),this.svgNode=t},e}(DrawableItem$1),TipText$1=function(t){function e(e,i){var n=t.call(this)||this;return n.center=e,n.literal=i,n.fontSize=8,n.textColor=new THREE.Color(.6,.6,.6),n.build(),n}return __extends$1(e,t),e.prototype.build=function(){var t=this.center.x,e=this.center.y;if("NaN"!=t.toString()&&"NaN"!=e.toString()){var i=document.createElementNS(this.xmlns,"text");i.setAttribute("style","font-size:"+this.fontSize+"px; fill: none; stroke: "+this.textColor.getStyle()+"; stroke-width: 1"),i.innerHTML=this.literal,i.textContent=this.literal;i.getBoundingClientRect();var n=t-3.5,o=e+2.8;this.svgNode=i,this.locate(n,o)}},e}(DrawableItem$1),AxisNotation$1=function(t){function e(e,i){var n=t.call(this)||this;return n.name=i,n.labelPoints=e,n.build(),n}return __extends$1(e,t),e.prototype.build=function(){var t=this;this.labelPoints.forEach((function(e){t.add(new TipText$1(e,t.name))}))},e.prototype.abtainRenderables=function(t){for(var e=0;e<this.children.length;e++){this.children[e].abtainRenderables(t)}},e.prototype.move=function(t,e){this.children.forEach((function(i){i.move(t,e)}))},e}(DrawableItem$1),AxisGrid$1=function(t){function e(e,i,n,o){var s=t.call(this)||this;return s.intersections=[],s.lineElements=[],s.horizLineElements=[],s.verticalLineElements=[],s.width=i[0],s.height=i[1],s.bIsShowAxisGrid=n,s.multiplyZoomFactor=o,s.algorithm=new Algorithm$1,s.materialGrid=new THREE.LineBasicMaterial({color:10066329,linewidth:.5}),s.children=[],s.resourceGrids=e,s.boundingBox=new THREE.Box2,s.realBoundingBox=new THREE.Box2,s.clipBox2D=new THREE.Box2(new THREE.Vector2(-s.width/2,-s.height/2),new THREE.Vector2(s.width/2,s.height/2)),s.axisGridNumberInterval=3,s.scratchVector=new THREE.Vector3,s.boxSize=new THREE.Vector2,s.isValid()&&s.build(),s}return __extends$1(e,t),e.prototype.build=function(){var t=this,e=this.getAxisGridBox(),i={width:this.width/2,height:this.height/2},n=function(n){var o=new THREE.Vector2(n.x,n.y);return t.algorithm.worldToNormalizedPoint(o,e),t.algorithm.normalizedPointToScreen(o,i),o},o=this.materialGrid;this.resourceGrids.forEach((function(e){var i=e.name,s=e.geometry,r=e.label;s.forEach((function(e){if("Line"===e.lineType){var s=e.startPoint,r=e.endPoint,a=n(s),l=n(r),h=l.clone().sub(a).normalize();t.add(new GridLine$1(a,l,o,i)),Math.abs(h.x)>=Math.abs(h.y)?t.horizLineElements.push({name:i,v1:a,v2:l,material:o}):t.verticalLineElements.push({name:i,v1:a,v2:l,material:o})}else if("Arc"===e.lineType){var c=e.points.map(n);t.add(new GridLineArc$1(c,o,i))}}));var a=r.positions.map(n);t.add(new AxisNotation$1(a,i))})),this.lineElements.push(this.horizLineElements),this.lineElements.push(this.verticalLineElements),this.calculateIntersections()},e.prototype.calculateAxisGridBox=function(t,e,i){var n=this;this.boundingBox.makeEmpty(),this.resourceGrids.forEach((function(t){t.geometry.forEach((function(t){if("Line"===t.lineType){var e=t.startPoint,i=t.endPoint,o=new THREE.Vector2(e.x,e.y),s=new THREE.Vector2(i.x,i.y);t.points=[o,s]}else if("Arc"===t.lineType){var r=window.CLOUD.AxisGridManager.getArcGridPoints(t);t.points=r}t.points.forEach((function(t){return n.boundingBox.expandByPoint(t)}))}))})),this.realBoundingBox=this.boundingBox.clone();var o=this.boundingBox.getCenter(this.scratchVector);this.boundingBox.getSize(this.boxSize);var s=new THREE.Vector2,r=t/e,a=this.boxSize.x/this.boxSize.y,l=this.boxSize.x,h=this.boxSize.y,c=4*(i+4)*this.multiplyZoomFactor;a>r?(this.bIsShowAxisGrid&&(l=this.boxSize.x*t/(t-c)),h=l/r):a<r&&(this.bIsShowAxisGrid&&(h=this.boxSize.y*e/(e-c)),l=h*r),s.set(l,h),this.boundingBox.setFromCenterAndSize(o,s)},e.prototype.getAxisGridBox=function(t){return this.isValid()&&this.calculateAxisGridBox(this.width,this.height,10),t?this.realBoundingBox:this.boundingBox},e.prototype.isEmpty=function(){return this.boundingBox.getSize(this.boxSize),0==this.boxSize.length()},e.prototype.isValid=function(){return!!this.resourceGrids},e.prototype.calculateIntersections=function(){for(var t,e,i,n,o,s,r,a,l=this.horizLineElements.length,h=this.verticalLineElements.length,c=0;c<l;c++){n=(t=this.horizLineElements[c]).name,o=t.v1.clone(),s=t.v2.clone();for(var d=0;d<h;d++){i=(e=this.verticalLineElements[d]).name,r=e.v1.clone(),a=e.v2.clone();var u=!1;r.x<=Math.max(o.x,s.x)&&r.x>=Math.min(o.x,s.x)&&o.y<=Math.max(r.y,a.y)&&o.y>=Math.min(r.y,a.y)&&(u=!0);var p=null;u&&(p=this.algorithm.getInterPoint(o,s,r,a)),this.intersections.push({intersectionPoint:p,horizLine:[o.clone(),s.clone()],verticalLine:[r.clone(),a.clone()],abcName:n,numeralName:i})}}},e.prototype.getIntersections=function(){return this.intersections},e.prototype.abtainRenderables=function(t){for(var e=0;e<this.children.length;e++){this.children[e].abtainRenderables(t)}},e.prototype.getGridLineByName=function(t){for(var e=this.children,i=0;i<e.length;i++){var n=e[i];if(n instanceof GridLine$1&&n.isMatch(t))return n}},e.prototype.move=function(t,e){this.children.forEach((function(i){i.move(t,e)}))},e}(DrawableItem$1),FloorPlane$1=function(t){function e(e,i,n){var o=t.call(this)||this;return o.imageUrl=e,o.width=i[0],o.height=i[1],o.offsetX=i[2],o.offsetY=i[3],o.isFlip=n,o.build(),o}return __extends$1(e,t),e.prototype.build=function(){var t=document.createElementNS(this.xmlns,"image");t.href.baseVal=this.imageUrl,t.setAttribute("herf",this.imageUrl),t.setAttribute("preserveAspectRatio","none"),t.setAttribute("width",this.width+""),t.setAttribute("height",this.height+""),t.setAttribute("x",-.5*this.width+""),t.setAttribute("y",-.5*this.height+""),this.isFlip&&t.setAttribute("transform","scale(-1,1)"),this.svgNode=t,this.locate(this.offsetX,this.offsetY)},e.prototype.move=function(t,e){var i=this.position.x+t,n=this.position.y+e;return this.isFlip?this.svgNode.setAttribute("transform","translate("+i+", "+n+")\n            scale("+"-1,1)"):this.svgNode.setAttribute("transform","translate("+i+","+n+")"),{x:i,y:n}},e}(DrawableItem$1);!function(t){t.Default="Editor",t.PICK_Editor="Pick",t.RECTPICK_Editor="RectPick",t.PAN_Editor="Pan",t.Zoom_Editor="Zoom"}(EditorName$1||(EditorName$1={}));var EventType$1,MouseEventType$1,VFSizeMode$1,Editor$1=function(){function t(){this.bIsMouseDown=!1,this.name=EditorName$1.Default}return t.prototype.onMouseDown=function(t){},t.prototype.onMouseMove=function(t){},t.prototype.onMouseUp=function(t){},t.prototype.onMouseWheel=function(t){},t.prototype.getName=function(){return this.name},t}();!function(t){t[t.RECTPICK_MOUSE_DOWN=1e3]="RECTPICK_MOUSE_DOWN",t[t.RECTPICK_MOUSE_MOVE=1001]="RECTPICK_MOUSE_MOVE",t[t.RECTPICK_MOUSE_UP=1002]="RECTPICK_MOUSE_UP",t[t.PICK_MOUSE_DOWN=2e3]="PICK_MOUSE_DOWN",t[t.PICK_MOUSE_MOVE=2001]="PICK_MOUSE_MOVE",t[t.PICK_MOUSE_UP=2002]="PICK_MOUSE_UP",t[t.Floor_Plane_Changed=3e3]="Floor_Plane_Changed",t[t.Floor_Plane_Changed_For_Panel=3001]="Floor_Plane_Changed_For_Panel",t[t.Resize=4e3]="Resize",t[t.Camera_Height_Changed=5e3]="Camera_Height_Changed",t[t.ZOOM_MOUSE_WHEEL=6e3]="ZOOM_MOUSE_WHEEL",t[t.PAN_MOUSE_MOVE=7e3]="PAN_MOUSE_MOVE",t[t.Minimap_Rect_Changed=8e3]="Minimap_Rect_Changed",t[t.Minimap_Rect_Destroyed=8001]="Minimap_Rect_Destroyed"}(EventType$1||(EventType$1={})),function(t){t[t.Left=0]="Left",t[t.Middle=1]="Middle",t[t.Right=2]="Right"}(MouseEventType$1||(MouseEventType$1={})),function(t){t.Min="Min",t.Max="Max"}(VFSizeMode$1||(VFSizeMode$1={}));var EditorName$1$1,ZoomEditor$1=function(t){function e(e,i){var n=t.call(this)||this;return n.totalZoomFactors=[],n.zoomFactors=[],n.lastZoomFactor=1,n.currentIdx=0,n.name=EditorName$1.Zoom_Editor,n.eventManager=i,n.vfData=e.getData(),n.vfViewer=e,n}return __extends$1(e,t),e.prototype.onMouseWheel=function(t){var e=(t.deltaY||-t.wheelDelta||t.detail)<0,i=-1;if(e?this.currentIdx<this.zoomFactors.length-1&&(this.currentIdx++,i=this.zoomFactors[this.currentIdx]):this.currentIdx>0&&(this.currentIdx--,i=this.zoomFactors[this.currentIdx]),!(i<0||this.lastZoomFactor==i)){this.lastZoomFactor=i,1==i&&PanEditor$1.clear();var n=this.vfData.getOriginSize(),o=new THREE.Vector2(t.offsetX-n[0]/2,t.offsetY-n[1]/2),s=this.zoomFactors[this.currentIdx],r=0,a=0;if(e){var l=s/(u=this.zoomFactors[this.currentIdx-1]),h=[],c=this.vfData.getCorner("Virtual","LB");c[0]-=o.x,c[1]-=o.y,h.push(c[0]*l+o.x),h.push(c[1]*l+o.y),this.vfData.setZoomFactor(s);var d=this.vfData.getCorner("Virtual","LB");this.vfData.setZoomFactor(u),r=h[0]-d[0],a=h[1]-d[1]}else{var u=this.zoomFactors[this.currentIdx+1],p=this.boundsChecking(s,u,o);r=p[0],a+=p[1]}PanEditor$1.panOffsetX+=r,PanEditor$1.panOffsetY+=a,PanEditor$1.panOffsetXForCamera+=r,PanEditor$1.panOffsetYForCamera+=a,this.vfData.setZoomFactor(i),this.vfViewer.destroy(),this.vfData.destroy(),this.vfData.build(),this.vfViewer.update(),this.vfData.updateMovement(),this.updateZoomAndPan(),this.eventManager.dispatchEvent({type:EventType$1.ZOOM_MOUSE_WHEEL,data:{offsetX:PanEditor$1.panOffsetX,offsetY:PanEditor$1.panOffsetY,zoomFactor:i}})}},e.prototype.boundsChecking=function(t,e,i){var n=t/e,o=this.vfData.getCorner("Virtual","LB"),s=this.vfData.getCorner("Virtual","LT"),r=this.vfData.getCorner("Virtual","RT"),a=this.vfData.getCorner("Virtual","RB"),l=[0,0],h=(o[0]-i.x)*n+i.x,c=(o[1]-i.y)*n+i.y;this.vfData.setZoomFactor(t);var d=this.vfData.getCorner("Virtual","LB");this.vfData.setZoomFactor(e),l[0]=h-d[0],l[1]=c-d[1];var u=0,p=0,g=this.vfData.getCorner("Origin","LB");h>g[0]&&(l[0]+=g[0]-h,u++),c<g[1]&&(l[1]+=g[1]-c,p++),h=(s[0]-i.x)*n+i.x,c=(s[1]-i.y)*n+i.y;var m=this.vfData.getCorner("Origin","LT");h>m[0]&&0==u&&(l[0]+=m[0]-h,u++),c>m[1]&&0==p&&(l[1]+=m[1]-c,p++),h=(r[0]-i.x)*n+i.x,c=(r[1]-i.y)*n+i.y;var f=this.vfData.getCorner("Origin","RT");h<f[0]&&0==u&&(l[0]+=f[0]-h,u++),c>f[1]&&0==p&&(l[1]+=f[1]-c,p++),h=(a[0]-i.x)*n+i.x,c=(a[1]-i.y)*n+i.y;var w=this.vfData.getCorner("Origin","RB");return h<w[0]&&0==u&&(l[0]+=w[0]-h,u++),c<w[1]&&0==p&&(l[1]+=w[1]-c,p++),l},e.prototype.enableMode=function(t){if(t==VFSizeMode$1.Min)this.zoomFactors=this.totalZoomFactors;else if(t==VFSizeMode$1.Max){this.zoomFactors=this.totalZoomFactors.slice(1,this.totalZoomFactors.length);for(var e=1;e<this.zoomFactors.length;e++)this.zoomFactors[e]/=this.zoomFactors[0];this.zoomFactors[0]=1}this.currentIdx=0},e.prototype.setZoomFactors=function(t){this.totalZoomFactors=t,this.zoomFactors=t},e.prototype.setZoonIndex=function(t){this.currentIdx=t},e.prototype.getZoonIndex=function(){return this.currentIdx},e.prototype.updateZoomAndPan=function(){var t=this.vfData.getCorner("Origin","LT"),i=this.vfData.getCorner("Virtual","LT");e.offsetXForZoomAndPan=t[0]-i[0],e.offsetYForZoomAndPan=t[1]-i[1]},e.clear=function(){e.offsetXForZoomAndPan=0,e.offsetYForZoomAndPan=0},e.offsetXForZoomAndPan=0,e.offsetYForZoomAndPan=0,e}(Editor$1),PanEditor$1=function(t){function e(i,n){var o=t.call(this)||this;return o.name=EditorName$1.PAN_Editor,o.eventManager=n,o.vfData=i.getData(),o.bIsMouseDown=!1,o.mouseDownPos=new THREE.Vector2,e.panOffsetX=0,e.panOffsetY=0,o}return __extends$1(e,t),e.prototype.onMouseDown=function(t){this.bIsMouseDown=!0,this.mouseDownPos.setX(t.clientX),this.mouseDownPos.setY(t.clientY)},e.prototype.onMouseMove=function(t){if(0!=this.bIsMouseDown&&1!=this.vfData.getZoomFactor()){var i=t.clientX-this.mouseDownPos.x,n=t.clientY-this.mouseDownPos.y,o=this.boundsChecking(i,n);i=o[0],n=o[1],e.panOffsetX+=i,e.panOffsetY+=n,e.panOffsetXForCamera+=i,e.panOffsetYForCamera+=n,this.vfData.updateMovement(),this.updateZoomAndPan(),this.mouseDownPos.setX(t.clientX),this.mouseDownPos.setY(t.clientY)}},e.prototype.onMouseUp=function(t){if(0!=this.bIsMouseDown&&1!=this.vfData.getZoomFactor()){var i=t.clientX-this.mouseDownPos.x,n=t.clientY-this.mouseDownPos.y,o=this.boundsChecking(i,n);i=o[0],n=o[1],e.panOffsetX+=i,e.panOffsetY+=n,e.panOffsetXForCamera+=i,e.panOffsetYForCamera+=n,this.vfData.updateMovement(),this.updateZoomAndPan(),this.eventManager.dispatchEvent({type:EventType$1.PAN_MOUSE_MOVE,data:{offsetX:e.panOffsetX,offsetY:e.panOffsetY,zoomFactor:this.vfData.getZoomFactor()}}),this.bIsMouseDown=!1}},e.prototype.boundsChecking=function(t,e){var i=this.vfData.getCorner("Origin","LB"),n=this.vfData.getCorner("Virtual","LB"),o=this.vfData.getCorner("Origin","RT"),s=this.vfData.getCorner("Virtual","RT");if(t>0)(r=i[0]-n[0])<=t&&(t=r);else if(t<0){var r;(r=o[0]-s[0])>=t&&(t=r)}if(e<0)(a=i[1]-n[1])>=e&&(e=a);else if(e>0){var a;(a=o[1]-s[1])<=e&&(e=a)}return[t,e]},e.prototype.updateZoomAndPan=function(){var t=this.vfData.getCorner("Origin","LT"),e=this.vfData.getCorner("Virtual","LT");ZoomEditor$1.offsetXForZoomAndPan=t[0]-e[0],ZoomEditor$1.offsetYForZoomAndPan=t[1]-e[1]},e.clear=function(){e.panOffsetX=0,e.panOffsetY=0,e.panOffsetXForCamera=0,e.panOffsetYForCamera=0},e}(Editor$1),CameraNode$1=function(t){function e(){var e=t.call(this)||this;return e.cameraCircleNode=null,e.cameraArrowNode=null,e.rotateAngle=0,e.panelSize=[298,198],e.build(),e}return __extends$1(e,t),e.prototype.build=function(){var t=document.createElementNS(this.xmlns,"g");t.setAttribute("fill","none"),t.setAttribute("fill-rule","evenodd"),t.setAttribute("stroke-width","1");var e=document.createElementNS(this.xmlns,"circle");e.setAttribute("r","4.5"),e.setAttribute("stroke","#FFFFFF"),e.setAttribute("fill","#32D3A6"),this.cameraCircleNode=e;var i=document.createElementNS(this.xmlns,"path");i.setAttribute("d","M5.94925387,0 C18.4132389,0 28.6581001,9.50119823 29.8362478,21.6560048 L5.94925387,25 Z"),i.setAttribute("fill","url(#radialGradient-1)"),i.setAttribute("transform","translate(13,-21)rotate(50)"),this.cameraArrowNode=i;var n=document.createElementNS(this.xmlns,"defs"),o=document.createElementNS(this.xmlns,"radialGradient"),s=document.createElementNS(this.xmlns,"stop"),r=document.createElementNS(this.xmlns,"stop");o.setAttribute("cx","0%"),o.setAttribute("cy","100%"),o.setAttribute("fx","0%"),o.setAttribute("fy","100%"),o.setAttribute("r","104.321936%"),o.setAttribute("id","radialGradient-1"),s.setAttribute("stop-color","#36D4A8"),s.setAttribute("offset","0%"),r.setAttribute("stop-color","#36D4A8"),r.setAttribute("offset","100%"),r.setAttribute("stop-opacity","0"),n.append(o),o.append(s),o.append(r),t.appendChild(n),t.appendChild(e),t.appendChild(i),this.svgNode=t},e.prototype.setCircleAttribute=function(t,e){this.cameraCircleNode.setAttribute(t,e)},e.prototype.setArrowAttribute=function(t,e){this.cameraArrowNode.setAttribute(t,e)},e.prototype.rotate=function(t){t&&(this.rotateAngle=t);var e=this.svgNode.getAttribute("transform");e+="rotate("+this.rotateAngle+")",this.svgNode.setAttribute("transform",e)},e.prototype.setOffsetAndRotate=function(t,e,i){var n=this.setOffsetBoundary(t,e);this.locate(n.X,n.Y),this.rotate(i),PanEditor$1.panOffsetXForCamera=0,PanEditor$1.panOffsetYForCamera=0},e.prototype.move=function(t,e){var i=this.position.x+t,n=this.position.y+e,o=this.setOffsetBoundary(i,n);this.svgNode.setAttribute("transform","translate("+o.X+","+o.Y+")")},e.prototype.setOpacity=function(t){this.svgNode.setAttribute("opacity",t)},e.prototype.setCameraArrowOpacity=function(t){this.cameraArrowNode.setAttribute("opacity",t)},e.prototype.setCameraCircleOpacity=function(t){this.cameraCircleNode.setAttribute("opacity",t)},e.prototype.setBigCamera=function(){this.cameraCircleNode.setAttribute("r","4.5"),this.cameraArrowNode.setAttribute("transform","translate(13,-21)rotate(50)")},e.prototype.setSmallCamera=function(){this.cameraCircleNode.setAttribute("r","2"),this.cameraArrowNode.setAttribute("transform","translate(20,-21)rotate(50)")},e.prototype.setPanelSize=function(t){this.panelSize=t},e.prototype.setOffsetBoundary=function(t,e){var i=this.panelSize[0]/2-6,n=-this.panelSize[0]/2+6,o=this.panelSize[1]/2-6,s=-this.panelSize[1]/2+6;return t>=i||t<=n||e>=o||e<=s?this.setSmallCamera():this.setBigCamera(),t>i&&(t=i),t<n&&(t=n),e>o&&(e=o),e<s&&(e=s),{X:t,Y:e}},e}(DrawableItem$1),FloorPlanes$1=function(){function t(t){this.resourcePlanes=t}return t.prototype.find=function(t){for(var e=0;e<this.resourcePlanes.length;e++){var i=this.resourcePlanes[e];if(i.id==t)return i}},t.prototype.getFloorPlaneBox=function(t){var e=this.find(t);return e?e.boundingBox||e.BoundingBox:void 0},t.prototype.getUrl=function(t){var e=this.find(t);return e?e.path||e.Path:void 0},t.prototype.getElevation=function(t){var e=this.find(t);return e?e.Elevation:void 0},t.prototype.getName=function(t){var e=this.find(t);return e?e.name||e.Name:void 0},t}(),NavigationMapAlgorithm=function(t){function e(){return t.call(this)||this}return __extends$1(e,t),e.prototype.getCuttingBoxOnCanvas=function(t,e,i,n){var o=new THREE.Box3,s=new THREE.Vector2(t.x,t.y),r=new THREE.Vector2(e.x,e.y);this.toWorldPoint(s,i[0],i[1],n),this.toWorldPoint(r,i[0],i[1],n);var a=[];return a.push(new THREE.Vector3(s.x,s.y)),a.push(new THREE.Vector3(s.x,s.y)),a.push(new THREE.Vector3(s.x,r.y)),a.push(new THREE.Vector3(s.x,r.y)),a.push(new THREE.Vector3(r.x,r.y)),a.push(new THREE.Vector3(r.x,r.y)),a.push(new THREE.Vector3(r.x,s.y)),a.push(new THREE.Vector3(r.x,s.y)),o.setFromPoints(a),{min:{x:o.min.x,y:o.min.y,z:0},max:{x:o.max.x,y:o.max.y,z:0}}},e.prototype.toWorldPoint=function(t,e,i,n){t.x<0&&(t.x=0),t.x>e&&(t.x=e),t.y<0&&(t.y=0),t.y>i&&(t.y=i),t.x=t.x/e*2-1,t.y=-t.y/i*2+1,n.normalizedPointToWorld(t)},e.prototype.normalizePointByZoomFactor=function(t,e,i,n){var o=new THREE.Vector2;if(t){var s=this.getContainerOffsetToClient(t),r=new THREE.Vector2;r.x=i.x-s.left-(t.clientWidth*n-e[0])/2,r.y=i.y-s.top-(t.clientHeight*n-e[1])/2;var a={width:e[0],height:e[1]};if(r.x>0&&r.x<a.width&&r.y>0&&r.y<a.height)return o.x=r.x/a.width*2-1,o.y=-r.y/a.height*2+1,new THREE.Vector2(o.x,o.y)}return null},e}(Algorithm$1),CoordinateTransform=function(){function t(t,e){this.point2D=new THREE.Vector2;var i=t[0],n=t[1],o=e[0],s=e[1],r=n.clone().sub(i).length()/s.clone().sub(o).length();this.rotateAngle=this.calculateRotateAngle(s.x-o.x,o.y-s.y,n.x-i.x,n.y-i.y);var a=(new THREE.Matrix3).translate(-o.x,o.y),l=(new THREE.Matrix3).translate(i.x,i.y),h=(new THREE.Matrix3).rotate(-this.rotateAngle),c=(new THREE.Matrix3).scale(r,r);this.mapToModelMatrix=l.clone().multiply(c).multiply(h).multiply(a);var d=(new THREE.Matrix3).translate(o.x,-o.y),u=(new THREE.Matrix3).translate(-i.x,-i.y),p=(new THREE.Matrix3).rotate(this.rotateAngle),g=(new THREE.Matrix3).scale(1/r,1/r);this.modelToMapMatrix=d.clone().multiply(p).multiply(g).multiply(u)}return t.prototype.calculateRotateAngle=function(t,e,i,n){var o=1e-6,s=Math.acos(-1),r=Math.sqrt(t*t+e*e);e/=r;var a=0,l=(t/=r)*(i/=r=Math.sqrt(i*i+n*n))+e*(n/=r);if(Math.abs(l-1)<=o)a=0;else if(Math.abs(l+1)<=o)a=s;else{a=Math.acos(l),t*n-i*e<0&&(a=2*s-a)}return a},t.prototype.getRotateAngle=function(){return this.rotateAngle},t.prototype.mapToModel=function(t){return new THREE.Vector2(t.x,-t.y).applyMatrix3(this.mapToModelMatrix)},t.prototype.modelToMap=function(t){this.point2D.set(t.x,t.y);var e=this.point2D.clone().applyMatrix3(this.modelToMapMatrix);return e.y=-e.y,e},t}(),HighlightPoint$1=function(t){function e(e,i){var n=t.call(this)||this;return n.radius=e,n.material=i,n.build(),n}return __extends$1(e,t),e.prototype.build=function(){var t=document.createElementNS(this.xmlns,"circle");t.setAttribute("r",this.radius+""),t.setAttribute("fill",this.glodonColor),t.setAttribute("style","fill: none; stroke: "+this.glodonColor),t.setAttribute("opacity","0"),this.svgNode=t},e.prototype.highlight=function(){this.svgNode.setAttribute("style","stroke:"+this.glodonColor),this.svgNode.setAttribute("opacity","1")},e.prototype.cancelHighlight=function(){this.svgNode.setAttribute("style","stroke:rgb(153,153,153)"),this.svgNode.setAttribute("opacity","0")},e.prototype.setOffset=function(t,e){this.svgNode.setAttribute("transform","translate("+t+","+e+")")},e}(DrawableItem$1);!function(t){t.Default="Editor",t.PICK_Editor="Pick",t.RECTPICK_Editor="RectPick",t.PAN_Editor="Pan",t.Zoom_Editor="Zoom"}(EditorName$1$1||(EditorName$1$1={}));var EventType$1$1,MouseEventType$1$1,Editor$1$1=function(){function t(){this.bIsMouseDown=!1,this.name=EditorName$1$1.Default}return t.prototype.onMouseDown=function(t){},t.prototype.onMouseMove=function(t){},t.prototype.onMouseUp=function(t){},t.prototype.onMouseWheel=function(t){},t.prototype.getName=function(){return this.name},t.prototype.scale=function(t,e,i){},t}();!function(t){t[t.RECTPICK_MOUSE_DOWN=1e3]="RECTPICK_MOUSE_DOWN",t[t.RECTPICK_MOUSE_MOVE=1001]="RECTPICK_MOUSE_MOVE",t[t.RECTPICK_MOUSE_UP=1002]="RECTPICK_MOUSE_UP",t[t.PICK_MOUSE_DOWN=2e3]="PICK_MOUSE_DOWN",t[t.PICK_MOUSE_MOVE=2001]="PICK_MOUSE_MOVE",t[t.PICK_MOUSE_UP=2002]="PICK_MOUSE_UP",t[t.Floor_Plane_Changed=3e3]="Floor_Plane_Changed",t[t.Floor_Plane_Changed_For_Panel=3001]="Floor_Plane_Changed_For_Panel",t[t.Resize=4e3]="Resize",t[t.Camera_Height_Changed=5e3]="Camera_Height_Changed",t[t.ZOOM_MOUSE_WHEEL=6e3]="ZOOM_MOUSE_WHEEL",t[t.PAN_MOUSE_MOVE=7e3]="PAN_MOUSE_MOVE",t[t.NavigationMapRectChanged=8e3]="NavigationMapRectChanged",t[t.NavigationMapRectDestroyed=8001]="NavigationMapRectDestroyed"}(EventType$1$1||(EventType$1$1={})),function(t){t[t.Left=0]="Left",t[t.Middle=1]="Middle",t[t.Right=2]="Right"}(MouseEventType$1$1||(MouseEventType$1$1={}));var VFSizeMode$1$1,EventManager$1$1=function(){function t(){this.eventDispatcher=new THREE.EventDispatcher}return t.prototype.addEventListener=function(t,e){this.eventDispatcher.addEventListener(t,e)},t.prototype.hasEventListener=function(t){this.eventDispatcher.hasEventListener(t)},t.prototype.removeEventListener=function(t,e){this.eventDispatcher.removeEventListener(t,e)},t.prototype.dispatchEvent=function(t){this.eventDispatcher.dispatchEvent(t)},t}();!function(t){t.Min="Min",t.Max="Max"}(VFSizeMode$1$1||(VFSizeMode$1$1={}));var ZoomEditor$1$1=function(t){function e(e,i){var n=t.call(this)||this;return n.totalZoomFactors=[],n.zoomFactors=[],n.lastZoomFactor=1,n.currentIdx=0,n.name=EditorName$1$1.Zoom_Editor,n.eventManager=i,n.nmData=e.getData(),n.nmViewer=e,n}return __extends$1(e,t),e.prototype.scale=function(t,e,i){var n=e>t,o=-1;if(n?this.currentIdx<this.zoomFactors.length-1&&(this.currentIdx++,o=this.zoomFactors[this.currentIdx]):this.currentIdx>0&&(this.currentIdx--,o=this.zoomFactors[this.currentIdx]),!(o<0||this.lastZoomFactor==o)){this.lastZoomFactor=o,1==o&&PanEditor$1$1.clear();var s=this.nmData.getOriginSize(),r=new THREE.Vector2(i[0]-s[0]/2,i[1]-s[1]/2),a=this.zoomFactors[this.currentIdx],l=0,h=0;if(n){var c=a/(g=this.zoomFactors[this.currentIdx-1]),d=[],u=this.nmData.getCorner("Virtual","LB");u[0]-=r.x,u[1]-=r.y,d.push(u[0]*c+r.x),d.push(u[1]*c+r.y),this.nmData.setZoomFactor(a);var p=this.nmData.getCorner("Virtual","LB");this.nmData.setZoomFactor(g),l=d[0]-p[0],h=d[1]-p[1]}else{var g=this.zoomFactors[this.currentIdx+1],m=this.boundsChecking(a,g,r);l=m[0],h+=m[1]}PanEditor$1$1.panOffsetX+=l,PanEditor$1$1.panOffsetY+=h,PanEditor$1$1.panOffsetXForCamera+=l,PanEditor$1$1.panOffsetYForCamera+=h,this.nmData.setZoomFactor(o),this.nmViewer.destroy(),this.nmData.destroy(),this.nmData.build(),this.nmViewer.update(),this.nmData.updateMovement(),this.updateZoomAndPan(),this.eventManager.dispatchEvent({type:EventType$1$1.ZOOM_MOUSE_WHEEL,data:{offsetX:PanEditor$1$1.panOffsetX,offsetY:PanEditor$1$1.panOffsetY,zoomFactor:o}})}},e.prototype.onMouseWheel=function(t){var e=(t.deltaY||-t.wheelDelta||t.detail)<0,i=-1;if(e?this.currentIdx<this.zoomFactors.length-1&&(this.currentIdx++,i=this.zoomFactors[this.currentIdx]):this.currentIdx>0&&(this.currentIdx--,i=this.zoomFactors[this.currentIdx]),!(i<0||this.lastZoomFactor==i)){this.lastZoomFactor=i,1==i&&PanEditor$1$1.clear();var n=this.nmData.getOriginSize(),o=new THREE.Vector2(t.offsetX-n[0]/2,t.offsetY-n[1]/2),s=this.zoomFactors[this.currentIdx],r=0,a=0;if(e){var l=s/(u=this.zoomFactors[this.currentIdx-1]),h=[],c=this.nmData.getCorner("Virtual","LB");c[0]-=o.x,c[1]-=o.y,h.push(c[0]*l+o.x),h.push(c[1]*l+o.y),this.nmData.setZoomFactor(s);var d=this.nmData.getCorner("Virtual","LB");this.nmData.setZoomFactor(u),r=h[0]-d[0],a=h[1]-d[1]}else{var u=this.zoomFactors[this.currentIdx+1],p=this.boundsChecking(s,u,o);r=p[0],a+=p[1]}PanEditor$1$1.panOffsetX+=r,PanEditor$1$1.panOffsetY+=a,PanEditor$1$1.panOffsetXForCamera+=r,PanEditor$1$1.panOffsetYForCamera+=a,this.nmData.setZoomFactor(i),this.nmViewer.destroy(),this.nmData.destroy(),this.nmData.build(),this.nmViewer.update(),this.nmData.updateMovement(),this.updateZoomAndPan(),this.eventManager.dispatchEvent({type:EventType$1$1.ZOOM_MOUSE_WHEEL,data:{offsetX:PanEditor$1$1.panOffsetX,offsetY:PanEditor$1$1.panOffsetY,zoomFactor:i}})}},e.prototype.boundsChecking=function(t,e,i){var n=t/e,o=this.nmData.getCorner("Virtual","LB"),s=this.nmData.getCorner("Virtual","LT"),r=this.nmData.getCorner("Virtual","RT"),a=this.nmData.getCorner("Virtual","RB"),l=[0,0],h=(o[0]-i.x)*n+i.x,c=(o[1]-i.y)*n+i.y;this.nmData.setZoomFactor(t);var d=this.nmData.getCorner("Virtual","LB");this.nmData.setZoomFactor(e),l[0]=h-d[0],l[1]=c-d[1];var u=0,p=0,g=this.nmData.getCorner("Origin","LB");h>g[0]&&(l[0]+=g[0]-h,u++),c<g[1]&&(l[1]+=g[1]-c,p++),h=(s[0]-i.x)*n+i.x,c=(s[1]-i.y)*n+i.y;var m=this.nmData.getCorner("Origin","LT");h>m[0]&&0==u&&(l[0]+=m[0]-h,u++),c>m[1]&&0==p&&(l[1]+=m[1]-c,p++),h=(r[0]-i.x)*n+i.x,c=(r[1]-i.y)*n+i.y;var f=this.nmData.getCorner("Origin","RT");h<f[0]&&0==u&&(l[0]+=f[0]-h,u++),c>f[1]&&0==p&&(l[1]+=f[1]-c,p++),h=(a[0]-i.x)*n+i.x,c=(a[1]-i.y)*n+i.y;var w=this.nmData.getCorner("Origin","RB");return h<w[0]&&0==u&&(l[0]+=w[0]-h,u++),c<w[1]&&0==p&&(l[1]+=w[1]-c,p++),l},e.prototype.enableMode=function(t){if(t==VFSizeMode$1$1.Min)this.zoomFactors=this.totalZoomFactors;else if(t==VFSizeMode$1$1.Max){this.zoomFactors=this.totalZoomFactors.slice(1,this.totalZoomFactors.length);for(var e=1;e<this.zoomFactors.length;e++)this.zoomFactors[e]/=this.zoomFactors[0];this.zoomFactors[0]=1}this.currentIdx=0},e.prototype.setZoomFactors=function(t){this.totalZoomFactors=t,this.zoomFactors=t},e.prototype.setZoonIndex=function(t){this.currentIdx=t},e.prototype.getZoonIndex=function(){return this.currentIdx},e.prototype.updateZoomAndPan=function(){var t=this.nmData.getCorner("Origin","LT"),i=this.nmData.getCorner("Virtual","LT");e.offsetXForZoomAndPan=t[0]-i[0],e.offsetYForZoomAndPan=t[1]-i[1]},e.clear=function(){e.offsetXForZoomAndPan=0,e.offsetYForZoomAndPan=0},e.offsetXForZoomAndPan=0,e.offsetYForZoomAndPan=0,e}(Editor$1$1),PanEditor$1$1=function(t){function e(i,n){var o=t.call(this)||this;return o.name=EditorName$1$1.PAN_Editor,o.eventManager=n,o.nmData=i.getData(),o.bIsMouseDown=!1,o.mouseDownPos=new THREE.Vector2,e.panOffsetX=0,e.panOffsetY=0,o}return __extends$1(e,t),e.prototype.onMouseDown=function(t){this.bIsMouseDown=!0,this.mouseDownPos.setX(t.clientX),this.mouseDownPos.setY(t.clientY)},e.prototype.onMouseMove=function(t){if(0!=this.bIsMouseDown&&1!=this.nmData.getZoomFactor()){var i=t.clientX-this.mouseDownPos.x,n=t.clientY-this.mouseDownPos.y;if(0!==i||0!==n){var o=this.boundsChecking(i,n);i=o[0],n=o[1],e.panOffsetX+=i,e.panOffsetY+=n,e.panOffsetXForCamera+=i,e.panOffsetYForCamera+=n,this.nmData.updateMovement(),this.updateZoomAndPan(),this.eventManager.dispatchEvent({type:EventType$1$1.PAN_MOUSE_MOVE,data:{offsetX:e.panOffsetX,offsetY:e.panOffsetY,zoomFactor:this.nmData.getZoomFactor()}}),this.mouseDownPos.setX(t.clientX),this.mouseDownPos.setY(t.clientY)}}},e.prototype.onMouseUp=function(t){0!=this.bIsMouseDown&&(this.bIsMouseDown=!1)},e.prototype.boundsChecking=function(t,e){var i=this.nmData.getCorner("Origin","LB"),n=this.nmData.getCorner("Virtual","LB"),o=this.nmData.getCorner("Origin","RT"),s=this.nmData.getCorner("Virtual","RT");if(t>0)(r=i[0]-n[0])<=t&&(t=r);else if(t<0){var r;(r=o[0]-s[0])>=t&&(t=r)}if(e<0)(a=i[1]-n[1])>=e&&(e=a);else if(e>0){var a;(a=o[1]-s[1])<=e&&(e=a)}return[t,e]},e.prototype.updateZoomAndPan=function(){var t=this.nmData.getCorner("Origin","LT"),e=this.nmData.getCorner("Virtual","LT");ZoomEditor$1$1.offsetXForZoomAndPan=t[0]-e[0],ZoomEditor$1$1.offsetYForZoomAndPan=t[1]-e[1]},e.clear=function(){e.panOffsetX=0,e.panOffsetY=0,e.panOffsetXForCamera=0,e.panOffsetYForCamera=0},e}(Editor$1$1),NavigationMapData=function(){function t(){this.zoomFactor=1,this.imageScale=1,this.imageOriginScale=1,this.bboxLengthStages=[15e4,3e5],this.zoomFactors1=[1,7/4,2.5,10/3],this.zoomFactors2=[1,7/4,2.5,14/3,65/12,20/3],this.zoomFactors3=[1,7/4,2.5,10/3,14/3,65/12,20/3,49/6,10],this.url=null,this.drawableItems=[],this.bIsShowAxisGrid=!1,this.bIsShowCameraNode=!0,this.bIsShowFloorPlane=!0,this.floorPlaneBox=new THREE.Box3,this.axisGridNode=null,this.cameraNode=null,this.floorPlaneNode=null,this.algorithm=new NavigationMapAlgorithm,this.glodonColor="#11DAB7",this.axisGridBoxSize=new THREE.Vector2,this.boxCenter=new THREE.Vector2,this.boxSize=new THREE.Vector2,this.boxCenter2=new THREE.Vector2}return t.prototype.setPlanes=function(t){this.dataFloorPlanes=new FloorPlanes$1(t)},t.prototype.setUrl=function(t,e){this.url=t,this.isProfile=e,this.build()},t.prototype.setAnchor=function(t){var e=t.modelAnchor,i=t.mapAnchor,n=t.zHeight,o=t.maxHeight;this.modelAnchor=e,this.mapAnchor=i,this.zHeight=n,this.maxHeight=o,this.coordinateTransform=new CoordinateTransform(e,i)},t.prototype.getRotateAngle=function(){return this.coordinateTransform.getRotateAngle()},t.prototype.mapToModel=function(t){var e=this.coordinateTransform.mapToModel(t);return new THREE.Vector3(e.x,e.y,this.zHeight)},t.prototype.modelToMap=function(t){return this.coordinateTransform.modelToMap(t)},t.prototype.worldToNormalizedPoint=function(t){var e=this.modelToMap(t);return t.x=e.x/this.imgSize.width*2-1,t.y=2*(1-e.y/this.imgSize.height)-1,t},t.prototype.normalizedPointToWorld=function(t){var e=new THREE.Vector2;e.x=.5*(t.x+1)*this.imgSize.width,e.y=(1-.5*(t.y+1))*this.imgSize.height;var i=this.mapToModel(e);t.x=i.x,t.y=i.y},t.prototype.clientToModel=function(t){var e=t.x/this.getSize()[0]*this.imgSize.width,i=t.y/this.getSize()[1]*this.imgSize.height,n=new THREE.Vector2(e,i);return this.mapToModel(n)},t.prototype.normalizedPointToScreen=function(t,e){t.x=t.x*e.width,t.y=-t.y*e.height},t.prototype.getUrl=function(){return this.url},t.prototype.getFloorPlaneBox=function(){var t=this.modelAnchor[0],e=this.modelAnchor[1];return t.z=this.zHeight,e.z=this.maxHeight,this.floorPlaneBox.makeEmpty(),this.floorPlaneBox.expandByPoint(t),this.floorPlaneBox.expandByPoint(e),this.floorPlaneBox},t.prototype.setSize=function(t,e){this.width=t,this.height=e},t.prototype.getSize=function(){return[this.width*this.zoomFactor,this.height*this.zoomFactor]},t.prototype.getImageSize=function(){return[this.imgSize.width*this.imageScale*this.zoomFactor,this.imgSize.height*this.imageScale*this.zoomFactor]},t.prototype.saveImageSize=function(t){var e=this.width,i=this.height,n=t.width,o=t.height,s=i/e,r=o/n;this.imageOriginScale=s>=r?e/n:i/o,this.imgSize=t},t.prototype.getOriginSize=function(){return[this.width,this.height]},t.prototype.getGlodonColor=function(){return this.glodonColor},t.prototype.build=function(){if(this.axisGridNode=new AxisGrid$1(!1,this.getSize(),this.bIsShowAxisGrid,this.getZoomFactor()),this.buildFloorPlane(),this.bIsShowCameraNode){this.cameraNode=new CameraNode$1;var t=this.getOriginSize();this.cameraNode.setPanelSize(t),this.drawableItems.push(this.cameraNode)}this.intersectPoint=new HighlightPoint$1(3),this.drawableItems.push(this.intersectPoint)},t.prototype.buildFloorPlane=function(){var t=this.getUrl();if(this.bIsShowFloorPlane){var e=this.getFloorPlaneBox();this.getAxisGridBox2D().containsBox(e)||console.warn("the bounding-box of axis-grid is not contains the bounding-box of floor-plane!");var i=this.getFloorPlaneParams2();this.floorPlaneNode=new FloorPlane$1(t,i,this.isProfile),this.drawableItems.push(this.floorPlaneNode)}},t.prototype.getFloorPlaneParams2=function(){var t=this.getSize()[0],e=this.getSize()[1],i=this.imgSize.width,n=this.imgSize.height,o=e/t,s=n/i;this.imageScale=o>=s?t/(i*this.zoomFactor):e/(n*this.zoomFactor);var r=i*this.imageScale*this.zoomFactor,a=n*this.imageScale*this.zoomFactor,l=[];return l.push(r,a),l.push(0,0),l},t.prototype.getFloorPlaneParams=function(){var t=this.getFloorPlaneBox(),e=this.getAxisGridBox2D(),i=new THREE.Box2(new THREE.Vector2(t.min.x,t.min.y),new THREE.Vector2(t.max.x,t.max.y)),n=this.getSize()[0],o=n/this.getSize()[1];e.getSize(this.axisGridBoxSize),this.axisGridBoxSize.x/this.axisGridBoxSize.y!=o&&(this.algorithm.expandBbox(e,o),e.getSize(this.axisGridBoxSize));var s=[],r=n/this.axisGridBoxSize.x;i.getSize(this.boxSize);var a=this.boxSize.x*r,l=this.boxSize.y*r;s.push(a,l),i.getCenter(this.boxCenter),e.getCenter(this.boxCenter2);var h=this.boxCenter.clone().sub(this.boxCenter2);return h.x*=r,h.y*=-r,s.push(h.x,h.y),s},t.prototype.getDataFloorPlanes=function(){return this.dataFloorPlanes},t.prototype.getAxisGridBox2D=function(t){var e=this.axisGridNode.getAxisGridBox(t);if(e.getSize(this.axisGridBoxSize),0==this.axisGridBoxSize.length()){var i=this.getFloorPlaneBox();if(t)return i;var n=(new THREE.Box2).set(new THREE.Vector2(i.min.x,i.min.y),new THREE.Vector2(i.max.x,i.max.y));n.getCenter(this.boxCenter),n.getSize(this.boxSize);var o=new THREE.Vector2,s=this.width/this.height,r=this.boxSize.x/this.boxSize.y,a=this.boxSize.x,l=this.boxSize.y;return r>s?l=a/s:r<s&&(a=l*s),o.set(a,l),n.setFromCenterAndSize(this.boxCenter,o),n}return e},t.prototype.getDrawableItems=function(){return this.drawableItems},t.prototype.destroy=function(){this.drawableItems=[]},t.prototype.setIsShowAxisGrid=function(t){this.bIsShowAxisGrid=t},t.prototype.getCameraNode=function(){for(var t=this.drawableItems,e=0;e<t.length;e++){var i=t[e];if(i instanceof CameraNode$1)return i}},t.prototype.updateMovement=function(){var t=this.getFloorPlaneNode();this.imgPosition=t.move(PanEditor$1$1.panOffsetX,PanEditor$1$1.panOffsetY);var e=this.getAxisGridNode();e&&e.move(PanEditor$1$1.panOffsetX,PanEditor$1$1.panOffsetY);var i=this.getCameraNode();i.move(PanEditor$1$1.panOffsetXForCamera,PanEditor$1$1.panOffsetYForCamera),i.rotate()},t.prototype.getPicPosition=function(t){var e=this.getFloorPlaneNode(),i=t.x-this.imgPosition.x,n=t.y-this.imgPosition.y;return{x:(i-.5*this.width- -.5*e.width)/e.width*this.imgSize.width,y:(n-.5*this.height- -.5*e.height)/e.height*this.imgSize.height}},t.prototype.getCorner=function(t,e){var i=[],n=[];"Origin"==t?(i=[0,0],n=this.getOriginSize()):"Virtual"==t&&(i=[PanEditor$1$1.panOffsetX,PanEditor$1$1.panOffsetY],n=this.getSize());var o=0,s=0;switch(e){case"LB":o=i[0]-n[0]/2,s=i[1]+n[1]/2;break;case"LT":o=i[0]-n[0]/2,s=i[1]-n[1]/2;break;case"RT":o=i[0]+n[0]/2,s=i[1]-n[1]/2;break;case"RB":o=i[0]+n[0]/2,s=i[1]+n[1]/2;break;default:console.log("CornerName is wrong.")}return[o,s]},t.prototype.getHeight=function(){return this.zHeight},t.prototype.getIntersections=function(){return this.axisGridNode.getIntersections()},t.prototype.getGridLineByName=function(t){return this.axisGridNode.getGridLineByName(t)},t.prototype.getFloorPlaneNode=function(){return this.floorPlaneNode},t.prototype.getAxisGridNode=function(){return 0==this.bIsShowAxisGrid?null:this.axisGridNode},t.prototype.getIntersectPoint=function(){return this.intersectPoint},t.prototype.setZoomFactor=function(t){this.zoomFactor=t},t.prototype.getZoomFactor=function(){return this.zoomFactor},t.prototype.getProperZoomFactors=function(){this.getAxisGridBox2D(!0).getSize(this.boxSize);var t=Math.max(this.boxSize.x,this.boxSize.y);return t<=this.bboxLengthStages[0]?this.zoomFactors1:t<=this.bboxLengthStages[1]?this.zoomFactors2:this.zoomFactors3},t}(),NavigationMapView=function(){function t(t,e,i){this.viewer=t,this.domContainer=e,this.navigationMapData=i,this.width=e.offsetWidth,this.height=e.offsetHeight,this.offsetLeft=e.offsetLeft,this.offsetTop=e.offsetTop,this.algorithm=new NavigationMapAlgorithm,this.eventManager=null,this.bBoxCenter=new THREE.Vector3,this.inverseMatrix=new THREE.Matrix4,this.rotateMatrix=new THREE.Matrix3,this.projectedCameraPosition=new THREE.Vector3,this.projectedTargetPosition=new THREE.Vector3,this.initialize()}return t.prototype.initialize=function(){var t="http://www.w3.org/2000/svg";this.drawableContainer=document.createElementNS(t,"svg"),this.drawableContainer.setAttribute("width",this.width+""),this.drawableContainer.setAttribute("height",this.height+""),this.drawableContainer.setAttribute("viewBox",-this.width/2+" "+-this.height/2+" "+this.width+" "+this.height),this.drawableContainer.style.position="absolute",this.auxContainer=document.createElementNS(t,"svg"),this.auxContainer.setAttribute("width",this.width+""),this.auxContainer.setAttribute("height",this.height+""),this.auxContainer.setAttribute("viewBox",-this.width/2+" "+-this.height/2+" "+this.width+" "+this.height),this.auxContainer.style.position="absolute",this.mapContainer=document.createElement("div"),this.mapContainer.style.left="0px",this.mapContainer.style.bottom="0px",this.mapContainer.style.position="relative",this.mapContainer.outling="none",this.mapContainer.appendChild(this.drawableContainer),this.mapContainer.appendChild(this.auxContainer),this.domContainer.appendChild(this.mapContainer),this.cameraHeightChangedCallbackBinded=this.cameraHeightChangedCallback.bind(this)},t.prototype.cameraHeightChangedCallback=function(t){var e=t.cameraPosition,i=(this.viewer.getScene().getMatrixGlobal(),this.viewer.getScene().getInverseMatrixGlobal()),n=e.clone().applyMatrix4(i);this.navigationMapData.getAxisGridBox2D().containsPoint(new THREE.Vector2(n.x,n.y))},t.prototype.getMapContainer=function(){return this.drawableContainer},t.prototype.getDomContainer=function(){return this.domContainer},t.prototype.getAuxContainer=function(){return this.auxContainer},t.prototype.getViewer=function(){return this.viewer},t.prototype.getData=function(){return this.navigationMapData},t.prototype.setSize=function(t,e){this.mapContainer.style.width=t+"px",this.mapContainer.style.height=e+"px",this.drawableContainer.setAttribute("width",t+""),this.drawableContainer.setAttribute("height",e+""),this.drawableContainer.setAttribute("viewBox",-t/2+" "+-e/2+" "+t+" "+e),this.auxContainer.setAttribute("width",t+""),this.auxContainer.setAttribute("height",e+""),this.auxContainer.setAttribute("viewBox",-t/2+" "+-e/2+" "+t+" "+e),this.destroy(),this.navigationMapData.destroy(),this.navigationMapData.build(),this.update(),this.eventManager.dispatchEvent({type:EventType$1$1.Resize,size:{width:t,height:e}})},t.prototype.destroy=function(){for(var t=this.drawableContainer;t.children.length>0;){var e=t.children[0];t.removeChild(e)}this.mapContainer.removeChild(t)},t.prototype.updateCameraNode=function(){var t=this.viewer,e=t.camera,i=t.cameraControl;if(e&&i){var n=e.position,o=e.target,s=this.algorithm.getMainSceneMatrix(t);this.inverseMatrix.copy(s).invert();var r=this.navigationMapData.getFloorPlaneBox();if(isNaN(r.min.z)){var a=n.clone();a.applyMatrix4(this.inverseMatrix),r.min.z=a.z,r.max.z=this.navigationMapData.maxHeight}r.getCenter(this.bBoxCenter);var l=new THREE.Vector3(r.min.x,r.min.y,this.bBoxCenter.z).applyMatrix4(s),h=new THREE.Vector3(r.min.x,r.max.y,this.bBoxCenter.z).applyMatrix4(s),c=new THREE.Vector3(r.max.x,r.min.y,this.bBoxCenter.z).applyMatrix4(s),d=new THREE.Plane;d.setFromCoplanarPoints(l,h,c),d.projectPoint(n,this.projectedCameraPosition),this.projectedCameraPosition.applyMatrix4(this.inverseMatrix),d.projectPoint(o,this.projectedTargetPosition),this.projectedTargetPosition.applyMatrix4(this.inverseMatrix);var u=this.projectedTargetPosition.clone().sub(this.projectedCameraPosition);u.z=0,u.normalize();var p=n.clone();p.applyMatrix4(this.inverseMatrix);var g=p.clone(),m=this.navigationMapData.getCameraNode();if(m){var f=this.navigationMapData.getImageSize(),w={width:f[0]/2,height:f[1]/2};this.navigationMapData.getAxisGridBox2D();if(this.getData().worldToNormalizedPoint(g),this.algorithm.normalizedPointToScreen(g,w),m.setOpacity("1.0"),u.length()<1e-5)m.setCameraArrowOpacity("0.0"),m.setOffsetAndRotate(g.x+PanEditor$1$1.panOffsetX,g.y+PanEditor$1$1.panOffsetY,0);else{var v=new THREE.Vector3(0,0,1),y=new THREE.Vector3(1,0,0);this.rotateMatrix.identity(),this.rotateMatrix.rotate(this.navigationMapData.getRotateAngle()),u.applyMatrix3(this.rotateMatrix);var b=this.algorithm.isAngleGreaterThanPi(y,u,v),E=THREE.Math.radToDeg(y.angleTo(u));b||(E*=-1),m.setBigCamera(),m.setOffsetAndRotate(g.x+PanEditor$1$1.panOffsetX,g.y+PanEditor$1$1.panOffsetY,E),m.setCameraArrowOpacity("1.0")}}}},t.prototype.update=function(t){for(var e=this.navigationMapData.getDrawableItems(),i=0;i<e.length;i++){e[i].abtainRenderables(this.drawableContainer)}this.updateCameraNode();var n=this.mapContainer.firstChild;n?this.mapContainer.insertBefore(this.drawableContainer,n):this.mapContainer.appendChild(this.drawableContainer)},t.prototype.setEventManager=function(t){this.eventManager=t},t.prototype.getEventManager=function(){return this.eventManager},t.prototype.registerCameraHeightChanged=function(t){this.viewer.registerEventListener(t,this.cameraHeightChangedCallbackBinded)},t}(),PickEditor$1=function(t){function e(e,i){var n=t.call(this)||this;return n.name=EditorName$1$1.PICK_Editor,n.nmViewer=e,n.nmData=e.getData(),n.algorithm=new NavigationMapAlgorithm,n.cameraProjectedPosZ=1750,n.nmViewer.getViewer().modelManager.isMeterUnit()&&(n.cameraProjectedPosZ=n.cameraProjectedPosZ/1e3),n.mapClickMode="default",n.lastMousePoint=new THREE.Vector2,n.eventManager=i,n}return __extends$1(e,t),e.prototype.onMouseDown=function(t){this.bIsMouseDown=!0,this.lastMousePoint.setX(t.clientX),this.lastMousePoint.setY(t.clientY)},e.prototype.onMouseMove=function(t){},e.prototype.onMouseUp=function(t){this.bIsMouseDown=!1,this.lastMousePoint.x===t.clientX&&this.lastMousePoint.y===t.clientY&&this.locateByClientPoint(t.clientX+ZoomEditor$1$1.offsetXForZoomAndPan,t.clientY+ZoomEditor$1$1.offsetYForZoomAndPan,t)},e.prototype.flyToPointWithParallelEye=function(t){var e=this.nmData.clientToModel(t),i=this.nmViewer.getViewer(),n=i.worldToDrawing(e);i.cameraControl.flyToPointWithParallelEye(new THREE.Vector3(n.x,n.y,n.z))},e.prototype.locateByClientPoint=function(t,e,i){var n=new THREE.Vector2(t,e),o=new THREE.Vector3,s=this.nmViewer.getMapContainer(),r=this.nmData.getImageSize(),a=this.nmData.getZoomFactor(),l=this.algorithm.normalizePointByZoomFactor(s,r,n,a);if(null!=l){var h=this.nmData.getAxisGridBox2D();this.nmData.normalizedPointToWorld(l);var c=this.algorithm.normalizePointByZoomFactor(s,r,n,a);this.algorithm.normalizedPointToScreen(c,{width:r[0]/2,height:r[1]/2});var d=this.algorithm.getIntersectionToMinDistance(this.nmData.getIntersections(),c);if(d&&d.intersectionPoint){var u=new THREE.Vector2(d.intersectionPoint.x,d.intersectionPoint.y);if(c.sub(u).lengthSq()<9){var p=u.clone(),g={width:r[0]/2,height:r[1]/2};this.algorithm.screenToNormalizedPoint(p,g),this.algorithm.normalizedPointToWorld(p,h),o.set(p.x,p.y,this.cameraProjectedPosZ)}else o.set(l.x,l.y,this.cameraProjectedPosZ)}else o.set(l.x,l.y,this.cameraProjectedPosZ);var m=o.clone(),f=this.nmData.getHeight();isNaN(f)||(m.z=f),this.nmData.updateMovement();var w=this.algorithm.getContainerOffsetToClient(s),v={x:i.clientX-w.left,y:i.clientY-w.top},y=this.nmData.getPicPosition(v);return this.eventManager.dispatchEvent({type:EventType$1$1.PICK_MOUSE_UP,data:{worldPosition:m.clone(),picPosition:y,clientPosition:v,screenPosition:{x:i.clientX,y:i.clientY}}}),this.algorithm.transformWorldPoint(this.nmViewer.getViewer(),m),this.algorithm.flyToPointWithParallelEye(this.nmViewer.getViewer(),m),!0}console.warn("Click point out of boundary.")},e}(Editor$1$1),NaviAction$1=function(){function t(t){this.nmViewer=t,this.nmData=t.getData(),this.svgRect=null,this.rectForMinimapId="RectForMinimap",this.bEditMode=!1,this.bPanMode=!1,this.bMouseDown=!1,this.rectangle=[],this.currentGripId=-1,this.lastHighlightGripId=-1,this.bFirstMouseClick=!0,this.lastMousePoint=new THREE.Vector2,this.lastMousePointToRectMin=new THREE.Vector2,this.lastMousePointToRectMax=new THREE.Vector2,this.pointOnBorder=[],this.eventManager=t.getEventManager(),this.panOffset=[0,0],this.zoomFactor=1;var e=this;this.eventManager.addEventListener(EventType$1$1.ZOOM_MOUSE_WHEEL,(function(t){var i=t.data;e.zoomAndPan(i.offsetX,i.offsetY,i.zoomFactor),e.nmViewer.updateCameraNode()})),this.eventManager.addEventListener(EventType$1$1.PAN_MOUSE_MOVE,(function(t){var i=t.data;e.zoomAndPan(i.offsetX,i.offsetY,i.zoomFactor),e.nmViewer.updateCameraNode()}))}return t.prototype.getMouseClickState=function(){return this.bFirstMouseClick},t.prototype.setMouseClickState=function(t){this.bFirstMouseClick=!!t},t.prototype.getCurrentGripId=function(){return this.currentGripId},t.prototype.setCurrentGripId=function(t){this.currentGripId=t},t.prototype.getRectangleInfo=function(){var t=Math.abs(this.rectangle[2]-this.rectangle[0]),e=Math.abs(this.rectangle[3]-this.rectangle[1]);return{x:this.rectangle[0],y:this.rectangle[1],width:t,height:e}},t.prototype.setLastMousePoint=function(t,e){this.lastMousePoint.x=t,this.lastMousePoint.y=e},t.prototype.equalWithLastPoint=function(t,e){return this.lastMousePoint.x===t&&this.lastMousePoint.y===e},t.prototype.getRectangle=function(){return this.rectangle},t.prototype.addPointToRectangle=function(t,e){"number"==typeof t&&this.rectangle.push(t),"number"==typeof e&&this.rectangle.push(e)},t.prototype.pointsCount=function(){return this.rectangle.length/2},t.prototype.pointValidation=function(t,e){var i=this.nmViewer.getDomContainer().getBoundingClientRect();(t<0||e<0||t>i.width||e>i.height)&&(t=this.pointOnBorder[0],e=this.pointOnBorder[1]),t<this.rectangle[0]?(this.rectangle.push(this.rectangle[0]),this.rectangle[0]=t):this.rectangle.push(t),e<this.rectangle[1]?(this.rectangle.push(this.rectangle[1]),this.rectangle[1]=e):this.rectangle.push(e)},t.prototype.getMouseState=function(){return this.bMouseDown},t.prototype.setMouseState=function(t){this.bMouseDown=!!t},t.prototype.getEditMode=function(){return this.bEditMode},t.prototype.setEditMode=function(t){this.bEditMode=!!t},t.prototype.getPanMode=function(){return this.bPanMode},t.prototype.setPanMode=function(t){this.bPanMode=!!t},t.prototype.createSvgElement=function(t){var e=document.createElementNS("http://www.w3.org/2000/svg",t);return e.setAttribute("pointer-events","inherit"),e},t.prototype.createSvgRect=function(t){this.svgRect||(this.svgRect=this.createSvgElement("rect"),this.svgRect.setAttribute("id",this.rectForMinimapId),this.svgRect.setAttribute("stroke-width",2),this.svgRect.style.position="absolute",this.svgRect.style.fillOpacity="0.4",this.svgRect.style.fill=this.nmData.getGlodonColor(),this.svgRect.style.display="block",this.svgRect.style.stroke=this.nmData.getGlodonColor(),this.svgRect.style.strokeWidth="2");var e=Math.abs(t.x-this.rectangle[0]),i=Math.abs(t.y-this.rectangle[1]),n=this.nmViewer.getAuxContainer(),o=n.clientWidth,s=n.clientHeight,r=["translate(",t.x-o/2,",",t.y-s/2,") ","rotate(",0,") "].join("");this.svgRect.setAttribute("transform",r),this.svgRect.setAttribute("width",e+""),this.svgRect.setAttribute("height",i+""),n.appendChild(this.svgRect)},t.prototype.updateSvgRect=function(t){this.pointOnBorder=[],this.pointOnBorder.push(t.x,t.y);var e=Math.abs(t.x-this.rectangle[0]),i=Math.abs(t.y-this.rectangle[1]),n={x:this.rectangle[0],y:this.rectangle[1]};if(t.x<n.x||t.y<n.y){t.x<n.x&&(n.x=t.x),t.y<n.y&&(n.y=t.y);var o=this.nmData.getOriginSize(),s=["translate(",n.x-o[0]/2,",",n.y-o[1]/2,") ","rotate(",0,") "].join("");this.svgRect.setAttribute("transform",s)}this.svgRect.setAttribute("width",e+""),this.svgRect.setAttribute("height",i+"")},t.prototype.resetSvgRect=function(){var t=Math.abs(this.rectangle[0]-this.rectangle[2]),e=Math.abs(this.rectangle[1]-this.rectangle[3]);this.svgRect.setAttribute("width",t+""),this.svgRect.setAttribute("height",e+"");var i=this.nmViewer.getAuxContainer(),n=i.clientWidth,o=i.clientHeight,s=["translate(",this.rectangle[0]-n/2,",",this.rectangle[1]-o/2,") ","rotate(",0,") "].join("");this.svgRect.setAttribute("transform",s),this.eventManager.dispatchEvent({type:EventType$1$1.NavigationMapRectChanged,rectInfo:this.getRectangleInfo()})},t.prototype.clearRectangle=function(){this.rectangle=[]},t.prototype.adjustRectangle=function(t,e,i){if(e[0]>=i[0])switch(t){case 0:case 1:case 2:e[0]=i[0];break;case 4:case 5:case 6:i[0]=e[0]}if(e[1]>=i[1])switch(t){case 2:case 3:case 4:i[1]=e[1];break;case 6:case 7:case 0:e[1]=i[1]}return e.concat(i)},t.prototype.gripDragging=function(t,e){var i=this.rectangle,n=e.x-t.x,o=e.y-t.y,s=[i[0],i[1]],r=[i[2],i[3]];switch(this.currentGripId){case 0:s[0]+=n,s[1]+=o;break;case 1:s[0]+=n;break;case 2:s[0]+=n,r[1]+=o;break;case 3:r[1]+=o;break;case 4:r[0]+=n,r[1]+=o;break;case 5:r[0]+=n;break;case 6:s[1]+=o,r[0]+=n;break;case 7:s[1]+=o;break;default:console.log("default grip id."+this.currentGripId)}var a=this.nmData.getOriginSize();r[0]=r[0]>a[0]?a[0]:r[0],r[1]=r[1]>a[1]?a[1]:r[1],this.rectangle=this.adjustRectangle(this.currentGripId,s,r)},t.prototype.hightlightGrip=function(t){var e={x:t.offsetX,y:t.offsetY},i=this.hitGrips(e);i!=this.lastHighlightGripId&&(this.currentGripId<0&&this.lastHighlightGripId>=0&&(document.getElementById(this.rectForMinimapId+"-"+this.lastHighlightGripId).style.stroke=this.nmData.getGlodonColor()));(this.currentGripId>=0||i>=0)&&(this.currentGripId>=0&&(i=this.currentGripId),document.getElementById(this.rectForMinimapId+"-"+i).style.stroke="#f5a623",this.currentGripId<0&&(this.lastHighlightGripId=i))},t.prototype.drawGrips=function(){for(var t=this.getGrips(),e=0;e<t.length;e+=2){if(!((e/2-1)%2)){var i=this.createSegmentGrip(e/2,this.nmData.getGlodonColor());this.currentGripId==e/2&&(i=this.createSegmentGrip(e/2,"#FF9D0B")),this.nmViewer.getAuxContainer().appendChild(i)}}for(e=0;e<t.length;e+=2){if(!!((e/2-1)%2)){i=this.createGrip(e/2,this.nmData.getGlodonColor());this.currentGripId==e/2&&(i=this.createGrip(e/2,"#FF9D0B")),this.nmViewer.getAuxContainer().appendChild(i)}}},t.prototype.createSegmentGrip=function(t,e){var i=this.getGrips(),n=this.rectForMinimapId+"-"+t,o=document.getElementById(n);o&&o.parentNode.removeChild(o);var s=this.createSvgElement("line"),r=this.nmViewer.getAuxContainer().clientWidth,a=this.nmViewer.getAuxContainer().clientHeight,l=(t-1)%(i.length/2),h=(t+1)%(i.length/2),c=String(i[2*l]-r/2),d=String(i[2*l+1]-a/2),u=String(i[2*h]-r/2),p=String(i[2*h+1]-a/2);return s.setAttribute("id",n),s.setAttribute("x1",c),s.setAttribute("y1",d),s.setAttribute("x2",u),s.setAttribute("y2",p),s.setAttribute("style","fill: none; stroke: "+(e||"#4784cb")+"; stroke-width: 2; fill: #ffffff; display: block; position: absolute"),s},t.prototype.createGrip=function(t,e){var i=this.getGrips(),n=this.rectForMinimapId+"-"+t,o=document.getElementById(n);o&&o.parentNode.removeChild(o);var s=this.createSvgElement("circle"),r=this.nmViewer.getAuxContainer().clientWidth,a=this.nmViewer.getAuxContainer().clientHeight,l=["translate(",i[2*t]-r/2,",",i[2*t+1]-a/2,") ","rotate(",0,") "].join("");return s.setAttribute("id",n),s.setAttribute("transform",l),s.setAttribute("r","3"),s.setAttribute("style","fill: none; stroke: "+(e||"#4784cb")+"; stroke-width: 1; fill: #ffffff; display: block; position: absolute"),s},t.prototype.removeGrips=function(){for(var t=0;t<8;t++){var e=document.getElementById(this.rectForMinimapId+"-"+t);e&&e.parentNode.removeChild(e)}},t.prototype.removeSvgRect=function(){var t=document.getElementById(this.rectForMinimapId);t&&t.parentNode.removeChild(t)},t.prototype.destroyAll=function(){this.removeGrips(),this.removeSvgRect(),this.clearRectangle(),this.eventManager.dispatchEvent({type:EventType$1$1.NavigationMapRectDestroyed})},t.prototype.getGrips=function(){var t={x:this.rectangle[0],y:this.rectangle[1]},e={x:this.rectangle[2],y:this.rectangle[3]},i={x:(t.x+e.x)/2,y:(t.y+e.y)/2},n=[];return n.push(t.x,t.y),n.push(t.x,i.y),n.push(t.x,e.y),n.push(i.x,e.y),n.push(e.x,e.y),n.push(e.x,i.y),n.push(e.x,t.y),n.push(i.x,t.y),n},t.prototype.hitGrips=function(t){for(var e=this.getGrips(),i=0;i<e.length;i+=2){var n=!1;if(!((i/2-1)%2)){var o=(i/2-1)%(e.length/2),s=(i/2+1)%(e.length/2),r=e[2*o],a=e[2*o+1],l=e[2*s],h=e[2*s+1];n=this.isPointInSegment(t.x,t.y,r,a,l,h,3)}else{var c=[e[i],e[i+1]];n=this.isPointInCircle(t,c,6)}if(n)return i/2}return-1},t.prototype.isPointInCircle=function(t,e,i){var n=t.x-e[0],o=t.y-e[1];return Math.sqrt(n*n+o*o)<=i},t.prototype.isPointInSegment=function(t,e,i,n,o,s,r){r=r||0;var a=(o-i)*(t-i)+(s-n)*(e-n);if(a<=0)return Math.sqrt((t-i)*(t-i)+(e-n)*(e-n))<=r;var l=(o-i)*(o-i)+(s-n)*(s-n);if(a>=l)return Math.sqrt((t-o)*(t-o)+(e-s)*(e-s))<=r;var h=a/l,c=i+(o-i)*h,d=n+(s-n)*h;return Math.sqrt((t-c)*(t-c)+(d-e)*(d-e))<=r},t.prototype.isPointInRectangle=function(t,e){if(this.pointsCount()<2)return!1;var i=this.rectangle,n=i[0]<i[2]?[i[0],i[2]]:[i[2],i[0]],o=n[0],s=n[1],r=(i[1],i[3],[i[1],i[3]]);return o<t&&t<s&&r[0]<e&&e<r[1]},t.prototype.panRectangle=function(t,e){var i=this.rectangle,n=this.nmViewer.getDomContainer().getBoundingClientRect();this.lastMousePointToRectMin.x+t<0?t=-this.lastMousePointToRectMin.x:this.lastMousePointToRectMax.x+t>n.width&&(t=n.width-this.lastMousePointToRectMax.x),this.lastMousePointToRectMin.y+e<0?e=-this.lastMousePointToRectMin.y:this.lastMousePointToRectMax.y+e>n.height&&(e=n.height-this.lastMousePointToRectMax.y),i[0]=this.lastMousePointToRectMin.x+t,i[1]=this.lastMousePointToRectMin.y+e,i[2]=this.lastMousePointToRectMax.x+t,i[3]=this.lastMousePointToRectMax.y+e,this.resetSvgRect(),this.drawGrips()},t.prototype.updateLastMousePointToRect=function(){this.lastMousePointToRectMin.x=this.rectangle[0]-this.lastMousePoint.x,this.lastMousePointToRectMin.y=this.rectangle[1]-this.lastMousePoint.y,this.lastMousePointToRectMax.x=this.rectangle[2]-this.lastMousePoint.x,this.lastMousePointToRectMax.y=this.rectangle[3]-this.lastMousePoint.y},t.prototype.zoomAndPan=function(t,e,i){if(this.pointsCount()<2)return this.panOffset=[t,e],void(this.zoomFactor=i);for(var n=this.nmViewer.getDomContainer().getBoundingClientRect(),o=n.width,s=n.height,r=new THREE.Vector2(.5*o,.5*s),a=0;a<=this.rectangle.length/2;a+=2){var l=new THREE.Vector2(this.rectangle[a]-this.panOffset[0],this.rectangle[a+1]-this.panOffset[1]).clone().sub(r);l.divideScalar(this.zoomFactor),this.rectangle[a]=l.x+r.x,this.rectangle[a+1]=l.y+r.y;var h=new THREE.Vector2(this.rectangle[a],this.rectangle[a+1]).clone().sub(r);h.multiplyScalar(i),this.rectangle[a]=r.x+h.x+t,this.rectangle[a+1]=r.y+h.y+e}this.panOffset=[t,e],this.zoomFactor=i,this.resetSvgRect(),this.drawGrips()},t}(),RectPickEditor$1=function(t){function e(e,i){var n=t.call(this)||this;return n.name=EditorName$1$1.RECTPICK_Editor,n.eventManager=i,n.nmData=e.getData(),n.naviAction=new NaviAction$1(e),n.nmViewer=e,n.algorithm=new NavigationMapAlgorithm,n}return __extends$1(e,t),e.prototype.onMouseDown=function(t){this.naviAction.setMouseState(!0);var e=this.adjustEvent(t);if(this.naviAction.setLastMousePoint(e.clientX,e.clientY),0==this.naviAction.pointsCount()){var i={x:e.offsetX,y:e.offsetY};this.naviAction.addPointToRectangle(i.x,i.y),this.naviAction.createSvgRect(i)}if(2==this.naviAction.pointsCount()){var n={x:t.offsetX,y:t.offsetY},o=this.naviAction.hitGrips(n),s=this.naviAction.isPointInRectangle(n.x,n.y);o>=0?this.naviAction.setEditMode(!0):s&&(this.naviAction.updateLastMousePointToRect(),this.naviAction.setPanMode(!0))}this.eventManager.dispatchEvent({type:EventType$1$1.RECTPICK_MOUSE_DOWN})},e.prototype.onMouseMove=function(t){if(2==this.naviAction.pointsCount()&&this.naviAction.hightlightGrip(t),this.naviAction.getMouseState()){var e=this.nmViewer.getDomContainer().getBoundingClientRect(),i=t.clientX-e.left,n=t.clientY-e.top;if(this.naviAction.pointsCount()<2&&this.naviAction.updateSvgRect({x:i,y:n}),this.naviAction.getEditMode()){var o={x:i,y:n},s=this.naviAction.hitGrips(o);if(this.naviAction.getMouseClickState())return this.firstPos=o,this.naviAction.setMouseClickState(!1),void(s>=0&&this.naviAction.setCurrentGripId(s));var r=o;this.naviAction.getCurrentGripId()>=0&&(this.naviAction.gripDragging(this.firstPos,r),this.naviAction.resetSvgRect(),this.naviAction.removeGrips(),this.naviAction.drawGrips()),this.firstPos=r}this.naviAction.getPanMode()&&this.naviAction.panRectangle(t.clientX,t.clientY)}},e.prototype.onMouseUp=function(t){if(this.naviAction.setMouseState(!1),this.naviAction.setMouseClickState(!0),this.naviAction.setCurrentGripId(-1),this.naviAction.setPanMode(!1),this.naviAction.equalWithLastPoint(t.clientX,t.clientY))1==this.naviAction.pointsCount()&&this.naviAction.clearRectangle();else{if(1==this.naviAction.pointsCount()){var e=this.adjustEvent(t),i=this.nmViewer.getDomContainer().getBoundingClientRect(),n=e.clientX-i.left,o=e.clientY-i.top;this.naviAction.pointValidation(n,o),this.naviAction.resetSvgRect(),this.naviAction.drawGrips()}this.naviAction.setEditMode(!1)}},e.prototype.clear=function(){this.naviAction.destroyAll()},e.prototype.getBoundingBoxIsolate=function(){var t=this.naviAction.getRectangle(),e={x:t[0]+ZoomEditor$1$1.offsetXForZoomAndPan,y:t[1]+ZoomEditor$1$1.offsetYForZoomAndPan},i={x:t[2]+ZoomEditor$1$1.offsetXForZoomAndPan,y:t[3]+ZoomEditor$1$1.offsetYForZoomAndPan},n=this.algorithm.getCuttingBoxOnCanvas(e,i,this.nmData.getSize(),this.nmData),o=this.nmData.getFloorPlaneBox();if(isNaN(o.min.z)){var s=this.nmViewer.getViewer().camera.position,r=this.nmViewer.getViewer().getScene().getInverseMatrixGlobal(),a=s.clone();a.applyMatrix4(r),o.min.z=a.z,o.max.z=this.nmData.maxHeight}return n.min.z=o.min.z,n.max.z=o.max.z,n},e.prototype.getIntersectionByNormalizedPoint=function(t,e){var i=this.nmViewer.getData().getIntersections(),n=new THREE.Vector2(t.x,t.y);return this.algorithm.normalizedPointToScreen(n,{width:e[0]/2,height:e[1]/2}),NavigationMapAlgorithm.getIntersectionByPoint(i,n)},e.prototype.adjustEvent=function(t){var e={offsetX:t.offsetX,offsetY:t.offsetY,clientX:t.clientX,clientY:t.clientY},i=new THREE.Vector2(e.clientX,e.clientY);i.x+=ZoomEditor$1$1.offsetXForZoomAndPan,i.y+=ZoomEditor$1$1.offsetYForZoomAndPan;var n=this.nmViewer.getMapContainer(),o=this.nmViewer.getData().getSize(),s=this.nmData.getZoomFactor(),r=this.algorithm.normalizePointByZoomFactor(n,o,i,s),a=this.getIntersectionByNormalizedPoint(r,o);if(a){var l=this.nmViewer.getDomContainer().getBoundingClientRect();e.clientX=a.intersectionPoint.x-ZoomEditor$1$1.offsetXForZoomAndPan,e.offsetX=e.clientX+o[0]/2,e.clientX=e.offsetX+l.left,e.clientY=a.intersectionPoint.y-ZoomEditor$1$1.offsetYForZoomAndPan,e.offsetY=e.clientY+o[1]/2,e.clientY=e.offsetY+l.top}return e},e}(Editor$1$1),NavigationMapEditor=function(){function t(t,e,i){this.eventManager=new EventManager$1$1,this.mapContainer=t,this.navigationMapData=e,this.nmViewer=i,this.touches=[],this.nmViewer.setEventManager(this.eventManager),this.offset=t.getBoundingClientRect(),this.activeEditors=[],this.bIsEnablePickHover=!1,this.initialize()}return t.prototype.initialize=function(){this.onContextmenuBinded=this.onContextmenu.bind(this),this.onTouchStartBinded=this.onTouchStart.bind(this),this.onTouchEndBinded=this.onTouchEnd.bind(this),this.onTouchMoveBinded=this.onTouchMove.bind(this),this.onMouseWheelBinded=this.onMouseWheel.bind(this),this.onMouseUpBinded=this.onMouseUp.bind(this),this.onMouseDownBinded=this.onMouseDown.bind(this),this.onMouseMoveBinded=this.onMouseMove.bind(this),this.addDomEventListeners(),this.enableEditor(EditorName$1$1.PICK_Editor),this.enableEditor(EditorName$1$1.Zoom_Editor),this.enableEditor(EditorName$1$1.PAN_Editor),this.enableEditor(EditorName$1$1.RECTPICK_Editor),this.enablePickHover(!0)},t.prototype.addDomEventListeners=function(){var t=this.mapContainer;t.addEventListener("contextmenu",this.onContextmenuBinded,!1),t.addEventListener("touchmove",this.onTouchMoveBinded,!1),t.addEventListener("touchstart",this.onTouchStartBinded,!1),t.addEventListener("touchend",this.onTouchEndBinded,!1),t.addEventListener("mousewheel",this.onMouseWheelBinded,!1),t.addEventListener("mousedown",this.onMouseDownBinded,!1),t.addEventListener("mousemove",this.onMouseMoveBinded,!1),document.addEventListener("mouseup",this.onMouseUpBinded,!1)},t.prototype.removeDomEventListeners=function(){var t=this.mapContainer;t.removeEventListener("contextmenu",this.onContextmenuBinded,!1),t.removeEventListener("touchmove",this.onTouchMoveBinded,!1),t.removeEventListener("touchstart",this.onTouchStartBinded,!1),t.removeEventListener("touchend",this.onTouchEndBinded,!1),t.removeEventListener("mousewheel",this.onMouseWheelBinded,!1),t.removeEventListener("mousedown",this.onMouseDownBinded,!1),t.removeEventListener("mousemove",this.onMouseMoveBinded,!1),document.removeEventListener("mouseup",this.onMouseUpBinded,!1)},t.prototype.destroy=function(){this.removeDomEventListeners()},t.prototype.enablePickHover=function(t){this.bIsEnablePickHover=t},t.prototype.onTouchStart=function(t){this.touches=this.originTouches=t.touches;var e=this.activeEditors;if(!(this.touches.length>1))for(var i=0;i<e.length;i++){e[i].onMouseDown(this.formatPoint(t.touches[0]))}},t.prototype.onTouchMove=function(t){var e,i,n,o=t.touches;this.activeEditors;1==o.length?this.touches=o:2==o.length&&(e=Math.sqrt(Math.pow(this.touches[0].pageX-this.touches[1].pageX,2)+Math.pow(this.touches[0].pageY-this.touches[1].pageY,2)),i=Math.sqrt(Math.pow(o[0].pageX-o[1].pageX,2)+Math.pow(o[0].pageY-o[1].pageY,2)),n=[(this.originTouches[0].pageX+this.originTouches[1].pageX)/2-this.offset.left,(this.originTouches[0].pageY+this.originTouches[1].pageY)/2-this.offset.top],Math.abs(e-i)>8&&(this.onScale(e,i,n),this.touches=o))},t.prototype.onTouchEnd=function(t){for(var e=t.changedTouches[0],i=[],n=0;n<this.touches.length;n++){var o=this.touches[n];o.clientX==e.clientX&&o.clientY==e.clientY||i.push(o)}this.touches=i;var s=this.activeEditors;if(1==this.touches.length);else if(0==this.touches.length)for(n=0;n<s.length;n++){s[n].onMouseUp(this.formatPoint(e))}},t.prototype.onScale=function(t,e,i){var n=this.find(EditorName$1$1.Zoom_Editor);n&&n.scale(t,e,i)},t.prototype.onMouseWheel=function(t){var e=this.find(EditorName$1$1.Zoom_Editor);e&&e.onMouseWheel(t)},t.prototype.onContextmenu=function(t){t.preventDefault()},t.prototype.clearRectPick=function(){var t=this.find(EditorName$1$1.RECTPICK_Editor);t instanceof RectPickEditor$1&&t.clear()},t.prototype.getBoundingBoxIsolate=function(){var t=this.find(EditorName$1$1.RECTPICK_Editor);if(t instanceof RectPickEditor$1)return t.getBoundingBoxIsolate()},t.prototype.onMouseUp=function(t){for(var e=this.activeEditors,i=0;i<e.length;i++){var n=e[i];n.getName()==EditorName$1$1.PICK_Editor&&t.button!=MouseEventType$1$1.Left||(n.getName()==EditorName$1$1.RECTPICK_Editor&&t.button!=MouseEventType$1$1.Left||n.getName()==EditorName$1$1.PAN_Editor&&t.button==MouseEventType$1$1.Left||n.onMouseUp(t))}},t.prototype.onMouseDown=function(t){for(var e=this.activeEditors,i=0;i<e.length;i++){var n=e[i];n.getName()==EditorName$1$1.PICK_Editor&&t.button!=MouseEventType$1$1.Left||(n.getName()==EditorName$1$1.RECTPICK_Editor&&t.button!=MouseEventType$1$1.Left||n.getName()==EditorName$1$1.PAN_Editor&&t.button==MouseEventType$1$1.Left||n.onMouseDown(t))}},t.prototype.onMouseMove=function(t){for(var e=this.activeEditors,i=0;i<e.length;i++){var n=e[i];n.getName()==EditorName$1$1.PICK_Editor&&0==this.bIsEnablePickHover||n.onMouseMove(t)}},t.prototype.formatPoint=function(t){var e,i={};for(e in t)i[e]=t[e];return i},t.prototype.addEventListener=function(t,e){this.eventManager.addEventListener(t,e)},t.prototype.clearZoomAndPan=function(){PanEditor$1$1.clear(),ZoomEditor$1$1.clear(),this.navigationMapData.setZoomFactor(1);var t=this.find(EditorName$1$1.Zoom_Editor);t instanceof ZoomEditor$1$1&&t.setZoonIndex(0)},t.prototype.find=function(t){for(var e=this.activeEditors,i=0;i<e.length;i++)if(e[i].getName()===t)return e[i]},t.prototype.enableEditor=function(t){if(!this.find(t)){var e=this.activeEditors;switch(t){case EditorName$1$1.PICK_Editor:e.push(new PickEditor$1(this.nmViewer,this.eventManager));break;case EditorName$1$1.RECTPICK_Editor:e.push(new RectPickEditor$1(this.nmViewer,this.eventManager));break;case EditorName$1$1.PAN_Editor:e.push(new PanEditor$1$1(this.nmViewer,this.eventManager));break;case EditorName$1$1.Zoom_Editor:e.push(new ZoomEditor$1$1(this.nmViewer,this.eventManager))}}},t.prototype.getEventManager=function(){return this.eventManager},t.prototype.disableEditor=function(t){for(var e=this.activeEditors,i=0;i<e.length;i++)e[i].getName()===t&&e.splice(i,1)},t.prototype.setZoomMode=function(t){var e=this.find(EditorName$1$1.Zoom_Editor);e instanceof ZoomEditor$1$1&&e.enableMode(t)},t.prototype.setZoomFactors=function(t){var e=this.find(EditorName$1$1.Zoom_Editor);e instanceof ZoomEditor$1$1&&e.setZoomFactors(t)},t}(),NavigationFloorMap=function(){function t(t,e,i){this.nmData=new NavigationMapData,this.nmData.setSize(e.offsetWidth,e.offsetHeight),this.nmView=new NavigationMapView(t,e,this.nmData),this.setAnchor(i);var n=this.getMapContainer();this.nmEditor=new NavigationMapEditor(n,this.nmData,this.nmView)}return t.prototype.setAnchor=function(t){this.nmData.setAnchor(t)},t.prototype.saveImageSize=function(t){this.nmData.saveImageSize(t)},t.prototype.setPlanes=function(t){this.nmData.setPlanes(t)},t.prototype.updateUrl=function(t,e){this.nmData.setUrl(t,e);var i=this.nmData.getProperZoomFactors();this.nmEditor.setZoomFactors(i),PanEditor$1$1.clear()},t.prototype.getEventManager=function(){return this.nmEditor.getEventManager()},t.prototype.setSize=function(t,e){this.nmData.setSize(t,e)},t.prototype.resize=function(t,e){this.nmEditor.clearZoomAndPan(),this.nmData.setSize(t,e),this.nmView.setSize(t,e),this.nmEditor.setZoomMode(VFSizeMode$1$1.Min)},t.prototype.destroy=function(){this.nmEditor.clearZoomAndPan(),this.nmView.destroy(),this.nmData.destroy(),this.clearRectPick()},t.prototype.destroyEditor=function(){this.nmEditor.destroy()},t.prototype.rebuildData=function(){this.nmData.build()},t.prototype.renderCameraNode=function(){this.nmView.updateCameraNode()},t.prototype.addEventListener=function(t,e){this.nmEditor.addEventListener(t,e)},t.prototype.getBoundingBox=function(){return this.nmEditor.getBoundingBoxIsolate()},t.prototype.clearRectPick=function(){this.nmEditor.clearRectPick()},t.prototype.clearZoomAndPan=function(){this.nmEditor.clearZoomAndPan(),this.nmView.destroy(),this.nmData.destroy(),this.nmData.build(),this.nmView.update()},t.prototype.getAxisGridBox2D=function(){return this.nmData.getAxisGridBox2D()},t.prototype.getMapContainer=function(){return this.nmView.getDomContainer()},t.prototype.render=function(){this.nmView.update()},t.prototype.getPanOffset=function(){return{x:PanEditor$1$1.panOffsetX,y:PanEditor$1$1.panOffsetY}},t.prototype.registerCameraHeightChanged=function(t){this.nmView.registerCameraHeightChanged(t)},t}();!function(){let t=Glodon$1.Bimface.Data.StatisticsDataManager.getInstance(),e=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.NavigationMap");e.NavigationMap=class{constructor(t){if(!t.viewer||!t.mapViewer)return console.log("viewer is not defined."),!1;t.domElement=t.mapViewer.domElement,this._opt=t,this.id=t.id,this.eventManager=t.mapViewer.eventManager,this.EventType={PICK_MOUSE_UP:2002,Camera_Height_Changed:5e3,ZOOM_MOUSE_WHEEL:6e3,NavigationMap_Rect_Changed:8e3,NavigationMap_Rect_Destroyed:80001};var e=t.viewer.getViewer();switch(this.viewer=e,this.renderCB=()=>{this._initialized&&this.navigationMap.renderCameraNode()},e.addCallbacks("render",this.renderCB),this.maxHeight=e.getBoundingBoxWorld().max.z,this.onClickCallback=t.onClickCallback,this.initConfig=null,this.cloudMapManager=new Glodon$1.Bimface.Plugins.Map.MapManager({viewer:t.viewer}),t.type){case"Relevance":default:this.associateModel(t);break;case"SetProfile":t.isProfile=!0,this.initConfig=t,this.setProfileHeight(t);break;case"AutoProfile":t.isProfile=!0,this.setProfileAutoHeight(t)}}getEventManager(){return this.eventManager}addEventListener(t,e){this.getEventManager().addEvent(t,e)}removeEventListener(t,e){this.getEventManager().removeEvent(t,e)}init(){t.send("Bimface.Plugins.NavigationMap.NavigationMap","init");const e=this.getEventManager(),i=Glodon$1.Bimface.Plugins.NavigationMap.MapViewerEvent;let n=this.EventType;this.navigationMap.addEventListener(n.PICK_MOUSE_UP,(t=>{const n=t.data;this.onClickCallback&&this.onClickCallback(t.data),e.fireEvent(i.MouseClicked,n)})),this._initialized=!0,this._opt.successCallback&&this._opt.successCallback(),this.navigationMap.setSize(this.mapContainer.offsetWidth,this.mapContainer.offsetHeight),this.initConfig&&(this.setProfileHeight(this.initConfig),this.initConfig=null),this.navigationMap.addEventListener(this.EventType.NavigationMap_Rect_Changed,(t=>{this.getEventManager().fireEvent("NavigationMapRectChanged",t.rectInfo)})),this.navigationMap.addEventListener(this.EventType.NavigationMap_Rect_Destroyed,(t=>{this.getEventManager().fireEvent("NavigationMapRectDestroyed",t)})),this.addEventListener("NavigationMapRectChanged",(t=>{this._updateToolBarByMinmapRect(t)})),this.addEventListener("NavigationMapRectDestroyed",(t=>{this.toolbar&&this.toolbar.hide()}))}associateModel(t){let{mapAnchors:e,modelAnchors:i,url:n,domElement:o}=t;o&&(this.mapContainer=o);const s=Math.min(i.point1.z,i.point2.z);this.getImageSize(n,(o=>{const r=[new THREE.Vector2(i.point1.x,i.point1.y),new THREE.Vector2(i.point2.x,i.point2.y)],a=[new THREE.Vector2(e.point1.x,e.point1.y),new THREE.Vector2(e.point2.x,e.point2.y)],l=this.maxHeight,h={modelAnchor:r,mapAnchor:a,zHeight:s,maxHeight:l};this._initialized?(this.navigationMap.clearZoomAndPan(),this.navigationMap.setAnchor(h)):(this.navigationMap=new NavigationFloorMap(this.viewer,this.mapContainer,h),this.navigationMap.registerCameraHeightChanged(CLOUD$1.EVENTS.ON_CAMERA_HEIGHT_CHANGED),this.init()),this.navigationMap.saveImageSize(o),this.update(n,t.isProfile)}))}setProfileHeight(t,e,i){let n={maxPixel:800};n.height=void 0===t.height?0:t.height;n.successCallback=i=>{const o=this.viewer.getBoundingBoxWorld();let s=o.min,r=o.max;s.z=r.z=n.height;const a={point1:s,point2:r};let l=new THREE.Vector3;o.getSize(l);const h=l.x/l.y;let c=n.maxPixel,d=n.maxPixel;h>1?d/=h:c/=h;const u={modelAnchors:a,mapAnchors:{point1:new THREE.Vector2(0,d),point2:new THREE.Vector2(c,0)},url:i,domElement:t.domElement,isProfile:t.isProfile};this.associateModel(u),e&&e()},this.cloudMapManager.removeCreateMapEvent(),this.cloudMapManager.createMapByHeight(n)}setProfileAutoHeight(t,e,i){let n={maxPixel:800};n.successCallback=i=>{const o=this.viewer.getBoundingBoxWorld();let s=o.min,r=o.max;s.z=r.z=n.height;const a={point1:s,point2:r};let l=new THREE.Vector3;o.getSize(l);const h=l.x/l.y;let c=n.maxPixel,d=n.maxPixel;h>1?d/=h:c/=h;const u={modelAnchors:a,mapAnchors:{point1:new THREE.Vector2(0,d),point2:new THREE.Vector2(c,0)},url:i,domElement:t.domElement,isProfile:t.isProfile};this.associateModel(u),e&&e()},this.cloudMapManager.createMapByCamera(n),this.viewer.modelManager.dispatchEvent({type:CLOUD$1.EVENTS.ON_CAMERA_CHANGED_AND_RENDERED})}getImageSize(t,e){let i=document.createElement("img");i.onload=()=>{e({width:i.width,height:i.height})},i.onerror=()=>{this._opt.failureCallback&&this._opt.failureCallback()},i.src=t}update(t,e){this.navigationMap.updateUrl(t,e),this.navigationMap.destroy(),this.navigationMap.rebuildData(),this.navigationMap.render()}destroy(){this._opt.viewer.getViewer().removeCallbacks("render",this.renderCB),this.cloudMapManager.destroy(),this.navigationMap.destroy(),this.navigationMap.destroyEditor(),this.mapContainer.innerHTML=""}resize(t,e){var i=this._opt.domElement;i.style.width=t+"px",i.style.height=e+"px",this.navigationMap.resize(t,e),this.getEventManager().fireEvent("Resize",{width:t,height:e})}_clearState(){let t=this._opt.viewer,e=t._sectionBox;e&&e.exit(),t.restoreDefault()}_clearSectionBox(){let t=this._opt.viewer._sectionBox;t&&t.reset()}_updateSectionBox(t){let e=this._opt.viewer,i=e._sectionBox;if(!i){let t=new Glodon$1.Bimface.Plugins.Section.SectionBoxConfig;t.viewer=e,t.id="SectionBox",i=new Glodon$1.Bimface.Plugins.Section.SectionBox(t)}i.setBox(t),e.zoomToBoundingBox(t),e.render()}_updateToolBarByMinmapRect(t){const e=this._opt.domElement;let i=this._opt.viewer;if(this.toolbar)this.toolbar.show();else{let t=new Glodon$1.Bimface.UI.Button.ButtonConfig;t.id="mapIsolate",t.title=BimfaceLanguage.bf_panel_map_isolation,t.className="bf-map-button bf-map-isolate";let n=new Glodon$1.Bimface.UI.Button.Button(t);n.setHtml(BimfaceLanguage.bf_panel_map_isolation),n.setStyle({cursor:"default"}),n.addEventListener("Click",(()=>{this._clearState();const t=this.navigationMap.getBoundingBox();i.isolateByBox(t,Glodon$1.Bimface.Viewer.IsolateOption.HideOthers),i.zoomToBoundingBox(t),this.navigationMap.clearRectPick(),this.toolbar.hide(),i.render()}));let o=new Glodon$1.Bimface.UI.Button.ButtonConfig;o.id="mapSection",o.title=BimfaceLanguage.bf_panel_map_section,o.className="bf-map-button bf-map-section";let s=new Glodon$1.Bimface.UI.Button.Button(o);s.setHtml(BimfaceLanguage.bf_panel_map_section),s.setStyle({cursor:"default"}),s.addEventListener("Click",(()=>{this._clearState();const t=this.navigationMap.getBoundingBox();this._clearSectionBox(),this._updateSectionBox(t),this.navigationMap.clearRectPick(),this.toolbar.hide(),i.render()}));let r=new Glodon$1.Bimface.UI.Button.ButtonConfig;r.id="mapCancel",r.title=BimfaceLanguage.bf_general_cancel,r.className="bf-map-button bf-map-cancel";let a=new Glodon$1.Bimface.UI.Button.Button(r);a.setHtml(BimfaceLanguage.bf_general_cancel),a.setStyle({cursor:"default"}),a.addEventListener("Click",(t=>{this.navigationMap.clearRectPick(),this.toolbar.hide()})),a.addEventListener("mousedown",(t=>{t.preventDefault(),t.stopPropagation()}));let l=new Glodon$1.Bimface.UI.Toolbar.ToolbarConfig;l.className="bf-map-toolbar",this.toolbar=new Glodon$1.Bimface.UI.Toolbar.Toolbar(l),this.toolbar.addControls([n,s,a]),this.toolbar.element.style.zIndex=11,e.appendChild(this.toolbar.element)}e.offsetWidth;const n=e.offsetHeight,o=this.toolbar.element.offsetWidth,s=this.toolbar.element.offsetHeight;t.x+t.width<o?this.toolbar.element.style.left=t.x+"px":this.toolbar.element.style.left=t.x+t.width-o+"px",n<t.y+t.height+s?this.toolbar.element.style.top=t.y+t.height-s-6+"px":this.toolbar.element.style.top=t.y+t.height+6+"px",(this.toolbar.element.offsetLeft+this.toolbar.element.offsetWidth>this._opt.domElement.offsetWidth||this.toolbar.element.offsetTop+this.toolbar.element.offsetHeight>this._opt.domElement.offsetHeight||this.toolbar.element.offsetLeft<0||this.toolbar.element.offsetTop<0)&&this.toolbar.hide()}}}(),function(){let t=Glodon$1.Bimface.Data.StatisticsDataManager.getInstance(),e=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.NavigationMap");e.MapViewer=class{constructor(e){t.send("Bimface.Plugins.NavigationMap.MapViewer","bf_c_newMapViewer"),this.domElement=e.domElement,this.eventManager=new Glodon$1.Web.Lang.EventManager}destroy(){}addEventListener(t,e){this.eventManager.addEvent(t,e)}removeEventListener(t,e){this.eventManager.getEventManager().removeEvent(t,e)}}}(),function(){var t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.NavigationMap");t.MapViewerConfig=class{constructor(){this.map=null,this.domElement=[]}}}();
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */
var extendStatics$2=function(t,e){return extendStatics$2=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])},extendStatics$2(t,e)};function __extends$2(t,e){function i(){this.constructor=t}extendStatics$2(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}var CubeComponent=function(){function t(){this.faceDefaultColor=14936556,this.wireframeDefaultColor=13421772,this.faceHighlightColor=12255212,this.wireframeHighlightColor=3330982}return t.prototype.createMesh=function(t){for(var e=new THREE.BufferGeometry,i=t.length-2,n=new Uint32Array(3*i),o=0,s=1;s<=i;s++)n[o++]=0,n[o++]=s,n[o++]=s+1;var r=new THREE.MeshBasicMaterial({color:this.faceDefaultColor,side:THREE.DoubleSide}),a=new Float32Array(3*t.length);e.setAttribute("position",new THREE.BufferAttribute(a,3).copyVector3sArray(t)),e.setIndex(new THREE.BufferAttribute(n,1));var l=new THREE.Mesh(e,r);return l.componentId=this.componentId,l},t.prototype.createWireframe=function(t){for(var e=new THREE.LineGeometry,i=[],n=0;n<t.length;n++){var o=t[n];i.push(o.x,o.y,o.z)}e.setPositions(i);var s=new THREE.LineMaterial({color:this.wireframeDefaultColor,linewidth:1});s.resolution.set(160,160);var r=new THREE.Line2(e,s);return r.componentId=this.componentId,r},t.prototype.getMesh=function(){return this.mesh},t.prototype.getWireframe=function(){return this.wireframeMesh},t.prototype.transparent=function(t){t.material&&(t.material.transparent=!0,t.material.opacity=0)},t.prototype.opaque=function(t){t.material&&(t.material.transparent=!1,t.material.opacity=1)},t.prototype.getId=function(){return this.componentId},t}(),CubeEdge=function(t){function e(e,i,n){var o=t.call(this)||this;return o.highlightWidth=3,o.width=15,o.vertices=e,o.indices=i,o.componentId=n,o.highlightWireframeMesh=null,o.testWireframe=null,o.build(),o}return __extends$2(e,t),e.prototype.build=function(){var t=this.indices[0],e=this.indices[1],i=this.vertices[t],n=this.vertices[e],o=i.clone().add(n).multiplyScalar(.5).clone().multiplyScalar(-1),s=o.clone().normalize(),r=[],a=n.clone().sub(i).normalize(),l=i.clone().add(a.clone().multiplyScalar(20)),h=i.clone().add(a.clone().multiplyScalar(80)),c=[];if(0!==o.x){var d=o.x>0?this.width:-this.width;c.push((new THREE.Vector3).setX(d).add(s))}if(0!==o.y){var u=o.y>0?this.width:-this.width;c.push((new THREE.Vector3).setY(u).add(s))}if(0!==o.z){var p=o.z>0?this.width:-this.width;c.push((new THREE.Vector3).setZ(p).add(s))}2===c.length&&(r.push(l.clone().add(s)),r.push(l.clone().add(c[0])),r.push(h.clone().add(c[0])),r.push(h.clone().add(s)),r.push(h.clone().add(c[1])),r.push(l.clone().add(c[1]))),this.mesh=this.createMesh(r),this.transparent(this.mesh),this.wireframeMesh=this.createWireframe([l,h]),this.highlightWireframeMesh=this.createHighlightWireframe([l.sub(s),h.sub(s)])},e.prototype.createHighlightWireframe=function(t){for(var e=[],i=0;i<t.length;i++){var n=t[i];e.push(n.x,n.y,n.z)}var o=new THREE.LineGeometry;o.setPositions(e);var s=new THREE.LineMaterial({color:this.wireframeHighlightColor,linewidth:this.highlightWidth,dashed:!1});s.resolution.set(160,160);var r=new THREE.Line2(o,s);return r.computeLineDistances(),r.scale.set(1,1,1),r.visible=!1,r.renderOrder=100,r},e.prototype.getTestWireframe=function(){return this.testWireframe},e.prototype.getHighlightWireframeMesh=function(){return this.highlightWireframeMesh},e.prototype.highlight=function(){this.highlightWireframeMesh.visible=!0,this.highlightWireframeMesh.renderOrder=100},e.prototype.cancelHighlight=function(){this.highlightWireframeMesh.visible=!1},e}(CubeComponent),CubeCorner=function(t){function e(e,i){var n=t.call(this)||this;return n.length=20,n.vertex=e,n.cornerFace=null,n.cornerWireframe=null,n.componentId=i,n.cornerVertices=null,n.build(),n}return __extends$2(e,t),e.prototype.build=function(){var t=[],e=this.vertex.clone(),i=e.clone().multiplyScalar(-1);t.push(e);var n=this.vertex.clone(),o=i.x>0?this.length:-this.length;n.x+=o,t.push(n);var s=this.vertex.clone(),r=i.y>0?this.length:-this.length;s.y+=r,t.push(s);var a=this.vertex.clone(),l=i.z>0?this.length:-this.length;a.z+=l,t.push(a),this.cornerVertices=t,this.mesh=this.createMesh([n,s,a]),this.wireframeMesh=this.createWireframe([n,s,a,n]),this.buildCornerFace(),this.buildCornerWireframe()},e.prototype.highlight=function(){this.wireframeMesh.material.color.setHex(this.wireframeHighlightColor),this.wireframeMesh.renderOrder=100,this.mesh.material.color.setHex(this.faceHighlightColor),this.cornerFace.material.color.setHex(this.faceHighlightColor),this.cornerFace.material.transparent=!0,this.cornerFace.material.opacity=.5,this.cornerWireframe.material.color.setHex(this.wireframeHighlightColor),this.cornerWireframe.visible=!0},e.prototype.cancelHighlight=function(){this.wireframeMesh.material.color.setHex(this.wireframeDefaultColor),this.wireframeMesh.renderOrder=0,this.mesh.material.color.setHex(this.faceDefaultColor),this.transparent(this.cornerFace),this.cornerWireframe.visible=!1},e.prototype.buildCornerFace=function(){if(!this.cornerFace){var t=this.cornerVertices;t.push(t[1]),this.cornerFace=this.createMesh(t),this.transparent(this.cornerFace)}},e.prototype.getCornerFace=function(){return this.cornerFace},e.prototype.getCornerWireframe=function(){return this.cornerWireframe},e.prototype.buildCornerWireframe=function(){if(!this.cornerWireframe){for(var t=[],e=1;e<this.cornerVertices.length;e++){var i=this.cornerVertices[0],n=this.cornerVertices[e];t.push(i,n)}this.cornerWireframe=this.createWireframe(t),this.cornerWireframe.visible=!1}},e}(CubeComponent),CubeFace=function(t){function e(e,i,n,o){var s=t.call(this)||this;return s.length=60,s.vertices=e,s.indices=i,s.componentId=n,s.vertexUvs=null,s.texture=o,s.highlightMesh=null,s.wireframeMesh=null,s.vertexUvs=[],s.vertexUvs.push(new THREE.Vector2(0,.2)),s.vertexUvs.push(new THREE.Vector2(0,.8)),s.vertexUvs.push(new THREE.Vector2(.2,1)),s.vertexUvs.push(new THREE.Vector2(.8,1)),s.vertexUvs.push(new THREE.Vector2(1,.8)),s.vertexUvs.push(new THREE.Vector2(1,.2)),s.vertexUvs.push(new THREE.Vector2(.8,0)),s.vertexUvs.push(new THREE.Vector2(.2,0)),s.build(),s}return __extends$2(e,t),e.prototype.build=function(){for(var t=[],e=null,i=null,n=0,o=this.indices.length;n<o;n++){var s=this.indices[n],r=this.indices[n+1];e=this.vertices[s],i=this.vertices[r],n===o-1&&(i=this.vertices[this.indices[0]]);var a=i.clone().sub(e).normalize(),l=e.clone().add(i).multiplyScalar(.5);t.push(l.clone().sub(a.clone().multiplyScalar(this.length/2))),t.push(l.clone().add(a.clone().multiplyScalar(this.length/2)))}this.createTexturedMesh(t);for(var h=new THREE.Box3,c=0;c<this.indices.length;c++){var d=this.indices[c];h.expandByPoint(this.vertices[d])}for(var u=h.getCenter(new THREE.Vector3).normalize(),p=[],g=0;g<t.length;g++){var m=t[g];p.push(m.clone().add(u))}this.highlightMesh=this.createMesh(p),this.highlightMesh.visible=!1,this.highlightMesh.isHighlightMesh=!0,p.push(p[0]),this.wireframeMesh=this.createWireframe(p)},e.prototype.highlight=function(){this.highlightMesh.visible=!0,this.highlightMesh.material.color.setHex(this.faceHighlightColor),this.highlightMesh.material.transparent=!0,this.highlightMesh.material.opacity=.5,this.wireframeMesh.material.color.setHex(this.wireframeHighlightColor)},e.prototype.cancelHighlight=function(){this.highlightMesh.visible=!1,this.wireframeMesh.material.color.setHex(this.wireframeDefaultColor)},e.prototype.createTexturedMesh=function(t){for(var e=t.length-2,i=new Uint32Array(3*e),n=0,o=1;o<=e;o++)i[n++]=0,i[n++]=o,i[n++]=o+1;var s=new THREE.BufferGeometry,r=new Float32Array(3*t.length),a=new Float32Array(2*this.vertexUvs.length);s.setAttribute("position",new THREE.BufferAttribute(r,3).copyVector3sArray(t)),s.setAttribute("uv",new THREE.BufferAttribute(a,2).copyVector2sArray(this.vertexUvs)),s.setIndex(new THREE.BufferAttribute(i,1));var l=new THREE.MeshBasicMaterial({map:this.texture,side:THREE.DoubleSide,transparent:!1});this.mesh=new THREE.Mesh(s,l),this.mesh.componentId=this.componentId},e.prototype.getHighlightMesh=function(){return this.highlightMesh},e.prototype.buildVertexUvs=function(t){var e=[],i=(new THREE.Box3).setFromPoints(t),n=i.min,o=new THREE.Vector2;i.getSize(o);for(var s=0==o.x?"x":0==o.y?"y":"z",r=0;r<t.length;r++){var a=t[r],l=(o.x+o.y+o.z)/2,h=a.clone().sub(n).multiplyScalar(1/l),c=new THREE.Vector2(h.x,h.y);"x"==s?c=new THREE.Vector2(h.y,h.z):"y"==s&&(c=new THREE.Vector2(h.x,h.z)),e.push(c)}return e},e}(CubeComponent),BimCubeData=function(){function t(t,e){this.languageType=t,this.initialize(),this.scene=new THREE.Scene,this.callback=e,this.buildEdges(),this.buildCorners(),this.buildFaces()}return t.prototype.initialize=function(){this.enumViewMode={2673:"Top",4015:"Bottom","0231":"Front",5764:"Back",1375:"Right",4620:"Left",3:"RoofSouthEast",2:"RoofSouthWest",7:"RoofNorthEast",6:"RoofNorthWest",1:"BottomSouthEast",0:"BottomSouthWest",4:"BottomNorthWest",5:"BottomNorthEast",32:"RoofFront",76:"RoofBack",37:"RoofRight",26:"RoofLeft","01":"BottomFront",45:"BottomBack",15:"BottomRight","04":"BottomLeft",13:"SouthEast",20:"SouthWest",57:"NorthEast",64:"NorthWest"},this.length=100,this.vertices=[],this.vertexIds=[],this.edgeIds=[],this.edgeIndices=[],this.faceIds=[],this.faceIndices=[],this.componentList=[],this.texturesLoaded=0;var t=this.length;this.vertices.push(new THREE.Vector3(-t/2,-t/2,t/2)),this.vertices.push(new THREE.Vector3(t/2,-t/2,t/2)),this.vertices.push(new THREE.Vector3(-t/2,t/2,t/2)),this.vertices.push(new THREE.Vector3(t/2,t/2,t/2)),this.vertices.push(new THREE.Vector3(-t/2,-t/2,-t/2)),this.vertices.push(new THREE.Vector3(t/2,-t/2,-t/2)),this.vertices.push(new THREE.Vector3(-t/2,t/2,-t/2)),this.vertices.push(new THREE.Vector3(t/2,t/2,-t/2));for(var e=0;e<8;e++)this.vertexIds.push(e+"");this.edgeIndices.push([0,1],[1,3],[3,2],[2,0]),this.edgeIndices.push([0,4],[1,5],[2,6],[3,7]),this.edgeIndices.push([4,5],[5,7],[7,6],[6,4]);for(e=0;e<12;e++){var i=this.edgeIndices[e];this.edgeIds.push(i[0]+""+i[1])}this.faceIndices.push([0,2,3,1]),this.faceIndices.push([4,0,1,5]),this.faceIndices.push([4,6,2,0]),this.faceIndices.push([2,6,7,3]),this.faceIndices.push([1,3,7,5]),this.faceIndices.push([5,7,6,4]);for(e=0;e<6;e++){var n=this.faceIndices[e];this.faceIds.push(n[0]+""+n[1]+n[2]+n[3])}},t.prototype.buildFaces=function(){for(var t=this.vertices,e=this.faceIndices,i=this.faceIds,n=function(n){var s=window.BimfaceLoaderConfig.fullStaticHost+"/textures/"+o.languageType+"/"+o.enumViewMode[i[n]]+".png",r=new THREE.TextureLoader;r.setCrossOrigin("anonymous");var a=o;r.load(s,(function(o){var s=new CubeFace(t,e[n],i[n],o);a.componentList.push(s),a.scene.add(s.getMesh()),a.scene.add(s.getWireframe()),a.scene.add(s.getHighlightMesh()),6==++a.texturesLoaded&&a.callback&&a.callback()}))},o=this,s=0;s<6;s++)n(s)},t.prototype.buildEdges=function(){for(var t=this.vertices,e=this.edgeIndices,i=this.edgeIds,n=0;n<12;n++){var o=new CubeEdge(t,e[n],i[n]);this.componentList.push(o),this.scene.add(o.getMesh()),this.scene.add(o.getWireframe()),this.scene.add(o.getHighlightWireframeMesh())}},t.prototype.buildCorners=function(){for(var t=this.vertices,e=this.vertexIds,i=0;i<8;i++){var n=new CubeCorner(t[i],e[i]);this.componentList.push(n),this.scene.add(n.getMesh()),this.scene.add(n.getWireframe()),this.scene.add(n.getCornerFace()),this.scene.add(n.getCornerWireframe())}},t.prototype.getComponent=function(t){for(var e=0;e<this.componentList.length;e++){var i=this.componentList[e];if(i.getId()==t)return i}return null},t.prototype.transparentCorners=function(){},t.prototype.opaqueCorners=function(){},t.prototype.getScene=function(){return this.scene},t.prototype.getMeshes=function(){for(var t=[],e=this.scene.children,i=0;i<e.length;i++){var n=e[i];"Mesh"===n.type&&!0!==n.isHighlightMesh&&t.push(n)}return t},t.prototype.destroy=function(){this.scene=null,this.vertices=null,this.vertexIds=null,this.edgeIds=null,this.edgeIndices=null,this.faceIds=null,this.faceIndices=null,this.componentList=null,this.enumViewMode=null},t}(),BimCubeView=function(){function t(t,e){this.container=t,this.bimCubeData=e,this.activeCamera=new THREE.OrthographicCamera(-110,110,110,-110,.01,500),this.activeCamera.position.set(0,0,200),this.activeScene,this.initialize(),this.cameraTarget=new THREE.Vector3(0,0,0)}return t.prototype.initialize=function(){var t,e;this.renderer=new THREE.WebGLRenderer({antialias:!0,alpha:!0,preserveDrawingBuffer:!0}),this.container.appendChild(this.renderer.domElement),"none"==this.container.style.display?(t=this.container.style.width.replace("px",""),e=this.container.style.height.replace("px","")):(t=this.container.offsetWidth,e=this.container.offsetHeight),this.renderer.setSize(t,e)},t.prototype.switchCameraType=function(t){},t.prototype.getActiveCamera=function(){return this.activeCamera},t.prototype.setActiveScene=function(t){this.activeScene=t},t.prototype.render=function(t){t&&(this.activeCamera.position.copy(new THREE.Vector3(0,0,200).applyQuaternion(t.quaternion)),this.activeCamera.up.copy(t.up),this.activeCamera.lookAt(this.cameraTarget),this.activeCamera.updateMatrixWorld());var e=this.activeScene||this.bimCubeData.getScene();this.renderer.autoClear=!0,this.renderer.render(e,this.activeCamera)},t.prototype.destroy=function(){this.container.removeChild(this.renderer.domElement),this.container=null,this.renderer.dispose(),this.renderer=null,this.activeScene=null,this.bimCubeData=null,this.activeCamera=null},t.enumTypes={PERSPECTIVE:1e3,ORTHOGRAPHIC:1001},t}(),EventManager$2=function(){function t(){this.eventDispatcher=new THREE.EventDispatcher}return t.prototype.addEventListener=function(t,e){this.eventDispatcher.addEventListener(t,e)},t.prototype.hasEventListener=function(t){this.eventDispatcher.hasEventListener(t)},t.prototype.removeEventListener=function(t,e){this.eventDispatcher.removeEventListener(t,e)},t.prototype.dispatchEvent=function(t){this.eventDispatcher.dispatchEvent(t)},t.enumTypes={ON_COMPONENT_HOVER:1e3,ON_COMPONENT_CLICK:1001},t}(),BimCubeEditor=function(){function t(t,e,i){this.eventManager=new EventManager$2,this.container=t,this.bimCubeData=e,this.bimCubeView=i,this.initialize()}return t.prototype.initialize=function(){this.onMouseDownBinded=this.onMouseDown.bind(this),this.onMouseUpBinded=this.onMouseUp.bind(this),this.onMouseMoveBinded=this.onMouseMove.bind(this);var t=this.container;t.addEventListener("mousemove",this.onMouseMoveBinded,!1),t.addEventListener("mousedown",this.onMouseDownBinded,!1),this.raycaster=new THREE.Raycaster,this.lastHoverComponentId=null,this.bMouseDown=!1,this.mouseDownPos=null,this.doubleClickFlag=!1},t.prototype.onMouseDown=function(t){this.bMouseDown=!0,this.mouseDownPos=new THREE.Vector2(t.offsetX,t.offsetY),window.addEventListener("mouseup",this.onMouseUpBinded,!1)},t.prototype.onMouseMove=function(t){if(!this.bMouseDown){var e={x:t.offsetX,y:t.offsetY},i=this.canvasToNormalized(e),n=this.hitTest(i),o=this.lastHoverComponentId;if(n){if(n!=this.lastHoverComponentId)this.bimCubeData.getComponent(n).highlight(),this.bimCubeView.render(),this.lastHoverComponentId=n}else this.lastHoverComponentId=null;if(o&&n!=o)this.bimCubeData.getComponent(o).cancelHighlight(),this.bimCubeView.render()}},t.prototype.onMouseUp=function(t){if(window.removeEventListener("mouseup",this.onMouseUpBinded),0!=this.bMouseDown){var e=this;if(0==this.doubleClickFlag){this.doubleClickFlag=!0,setTimeout((function(){e.doubleClickFlag=!1}),1e3),this.bMouseDown=!1;var i=new THREE.Vector2(t.offsetX,t.offsetY);if(i.x==this.mouseDownPos.x&&i.y==this.mouseDownPos.y){var n={x:t.offsetX,y:t.offsetY},o=this.canvasToNormalized(n),s=this.hitTest(o);if(s){if(this.lastHoverComponentId)this.bimCubeData.getComponent(this.lastHoverComponentId).cancelHighlight(),this.lastHoverComponentId=null,this.bimCubeView.render();var r={type:EventManager$2.enumTypes.ON_COMPONENT_CLICK,componentId:s,viewType:this.bimCubeData.enumViewMode[s]};this.eventManager.dispatchEvent(r)}}}else this.bMouseDown=!1}},t.prototype.canvasToNormalized=function(t){var e=this.container.offsetWidth,i=this.container.offsetHeight,n={x:0,y:0};return n.x=t.x/e*2-1,n.y=-t.y/i*2+1,n},t.prototype.hitTest=function(t){var e=this.bimCubeView.getActiveCamera();this.raycaster.setFromCamera(t,e);var i=this.bimCubeData.getMeshes(),n=this.raycaster.intersectObjects(i,!0);if(0!=n.length){var o=n[0].object.componentId;if(n.length>=2){var s=n[1].object.componentId;4==o.length&&2==s.length&&n[1].distance<n[0].distance+5&&(o=s)}return o}},t.prototype.addEventListener=function(t,e){this.eventManager.addEventListener(t,e)},t.prototype.destroy=function(){window.removeEventListener("mouseup",this.onMouseUpBinded),this.container.removeEventListener("mousemove",this.onMouseMoveBinded),this.container.removeEventListener("mousedown",this.onMouseDownBinded),this.container=null,this.eventManager=null,this.bimCubeData=null,this.bimCubeView=null,this.onMouseDownBinded=null,this.onMouseUpBinded=null,this.onMouseMoveBinded=null,this.raycaster=null,this.lastHoverComponentId=null,this.mouseDownPos=null},t}(),BimCube=function(){function t(t,e,i){this.callback=i,this.functionsUnexecuted=[];var n=this;this.bimCubeData=new BimCubeData(e,(function(){n.bimCubeView=new BimCubeView(t,n.bimCubeData),n.bimCubeEditor=new BimCubeEditor(t,n.bimCubeData,n.bimCubeView),n.callback&&n.callback(),n.applyFunctionsUnexecuted()}))}return t.prototype.applyFunctionsUnexecuted=function(){for(var t=this.functionsUnexecuted,e=0;e<t.length;e++){switch(t[e]){case"show":this.show();break;case"hide":this.hide()}}this.functionsUnexecuted=[]},t.prototype.switchCameraType=function(t){this.bimCubeView.switchCameraType(t)},t.prototype.addEventListener=function(t,e){this.bimCubeEditor.addEventListener(t,e)},t.prototype.show=function(){if(this.bimCubeView){var t=this.bimCubeData.getScene();this.bimCubeView.setActiveScene(t),this.bimCubeView.render()}else this.functionsUnexecuted.push("show")},t.prototype.hide=function(){if(this.bimCubeView){var t=new THREE.Scene;this.bimCubeView.setActiveScene(t),this.bimCubeView.render()}else this.functionsUnexecuted.push("hide")},t.prototype.update=function(t){this.bimCubeView.render(t)},t.prototype.destroy=function(){this.bimCubeData&&this.bimCubeData.destroy(),this.bimCubeData=null,this.bimCubeEditor&&this.bimCubeEditor.destroy(),this.bimCubeEditor=null,this.bimCubeView&&this.bimCubeView.destroy(),this.bimCubeView=null,this.callback=null,this.functionsUnexecuted=null},t}();!function(){var t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins");t.ViewHouseNavi=class{constructor(t,e){this.viewer=t.getViewer(),this.enumEventTypes={ON_COMPONENT_HOVER:1e3,ON_COMPONENT_CLICK:1001},this.initialize();var i=this;this.bimcube=new BimCube(e,BimfaceLanguage.name,(function(){i.hookEvents(),i.bimcube.update(i.viewer.getActiveCameraInfo())}))}initialize(){this.enumViewMode={Home:0,Top:1,Bottom:2,Front:3,Back:4,Right:5,Left:6,SouthEast:7,SouthWest:8,NorthEast:9,NorthWest:10,BottomFront:11,BottomBack:12,BottomRight:13,BottomLeft:14,BottomSouthEast:15,BottomSouthWest:16,BottomNorthEast:17,BottomNorthWest:18,RoofFront:19,RoofBack:20,RoofRight:21,RoofLeft:22,RoofSouthEast:23,RoofSouthWest:24,RoofNorthEast:25,RoofNorthWest:26,TopTurnRight:27,TopTurnBack:28,TopTurnLeft:29,BottomTurnRight:30,BottomTurnBack:31,BottomTurnLeft:32,FrontTurnRight:33,FrontTurnTop:34,FrontTurnLeft:35,RightTurnBack:36,RightTurnTop:37,RightTurnFront:38,BackTurnRight:39,BackTurnTop:40,BackTurnLeft:41,LeftTurnFront:42,LeftTurnTop:43,LeftTurnBack:44}}hookEvents(){var t=this.bimcube,e=this.viewer,i=this.enumViewMode,n=function(){e.render()};t.addEventListener(this.enumEventTypes.ON_COMPONENT_CLICK,(function(t){var o=i[t.viewType];o&&e.setStandardView(o,null,n,n)})),e.addRenderCallback((function(){t.update(e.getActiveCameraInfo())}))}setVisible(t){!0===t?this.bimcube.show():this.bimcube.hide()}getImpl(){return this.bimcube}destroy(){this.viewer=null,this.enumEventTypes=null,this.enumViewMode=null,this.bimcube.destroy(),this.bimcube=null}}}(),Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins").ViewHouseConfig=function(){return{width:140,height:140,domElement:null,viewer:null}},Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Application.UI.Menu").ViewHouseMenu=function(t){var e=this,i=t.viewer;this.viewer=i;var n=t.domElement,o=Glodon$1.Bimface.UI.Control.ControlEvent,s=Glodon$1.Bimface.Viewer.Viewer3DEvent,r=i.getDomElement(),a=new Glodon$1.Bimface.UI.Menu.MenuConfig;a.element=n,this.menu=new Glodon$1.Bimface.UI.Menu.Menu(a),this.menu.element.style.backgroundColor="#EBEFF1",this.menu.element.style.border="1px solid #D0D6D6";var l=this.menu,h=new Glodon$1.Bimface.UI.Menu.MenuItemConfig;h.id="home";var c=new Glodon$1.Bimface.UI.Menu.MenuItem(h);c.setText(BimfaceLanguage.bf_viewHouse_home),c.element.addClass("bf-menu-item1"),i.getEventManager().addEvent(s.ToolbarHomeClick,(function(){e.switchHomeView()})),c.addEventListener(o.Click,(function(){e.switchHomeView(),e.hide()})),this.switchHomeView=function(){var t=i.getCustomHomeview(),e=i.getDefaultHomeview(),n=t||e,o=i.getCameraStatus().name;n.name=o,"orth"==o&&u.setText(BimfaceLanguage.bf_viewHouse_perspective),"persp"==o&&u.setText(BimfaceLanguage.bf_viewHouse_orthographic),i.setCameraStatus(n,(function(){0==i.getCameraAnimation()&&i.render()}))};var d=new Glodon$1.Bimface.UI.Menu.MenuItemConfig;d.id="orthographic";var u=new Glodon$1.Bimface.UI.Menu.MenuItem(d);u.setText(BimfaceLanguage.bf_viewHouse_orthographic),u.element.addClass("bf-menu-item1"),u.addEventListener(o.Click,(function(){e.hide(),u.element.textContent==BimfaceLanguage.bf_viewHouse_orthographic?(i.setCameraType("OrthographicCamera"),i.render(),u.setText(BimfaceLanguage.bf_viewHouse_perspective)):(i.setCameraType("PerspectiveCamera"),i.render(),u.setText(BimfaceLanguage.bf_viewHouse_orthographic))})),this.orthographic=u;var p=new Glodon$1.Bimface.UI.Menu.MenuItemConfig;p.id="setAsHome";var g=new Glodon$1.Bimface.UI.Menu.MenuItem(p);g.setText(BimfaceLanguage.bf_viewHouse_setAsHome),g.element.addClass("bf-menu-item1"),g.addEventListener(o.Click,(function(){e.hide();var t=i.getCameraStatus();i.recordCustomHomeview(t)}));var m=new Glodon$1.Bimface.UI.Menu.MenuItemConfig;m.id="resetHome";var f=new Glodon$1.Bimface.UI.Menu.MenuItem(m);f.setText(BimfaceLanguage.bf_viewHouse_resetHome),f.element.addClass("bf-menu-item1"),f.addEventListener(o.Click,(function(){e.hide(),i.recordCustomHomeview(null)}));var w=new Glodon$1.Bimface.UI.Menu.Spacer;w.element.style.backgroundColor="#D0D6D6";var v=new Glodon$1.Bimface.UI.Menu.Spacer;v.element.style.backgroundColor="#D0D6D6",this.menu.addControl(c),this.menu.addControl(w),this.menu.addControl(u),this.menu.addControl(v),this.menu.addControl(g),this.menu.addControl(f),this.hide=function(){this.menu.element.style.display="none"},this.show=function(){this.menu.element.style.display=""},this.isHide=function(){return"none"==this.menu.element.style.display},this.update=function(){var t=this.viewer.getCameraStatus().name;"orth"==t&&this.orthographic.setText(BimfaceLanguage.bf_viewHouse_perspective),"persp"==t&&this.orthographic.setText(BimfaceLanguage.bf_viewHouse_orthographic)},this.destroy=function(){this.viewer=null,this.menu=null,this.orthographic=null},r.addEventListener("mousedown",(function(t){l&&e.hide()}))},function(){var t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins"),e=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.Dom"),i=(Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.HttpRequest"),function(t){var i=t,n=e.create("div","bf-house");n.style.width=`${i.width}px`,n.style.height=`${i.height}px`,i.domElement.appendChild(n),this._domElement=n,this._opt=i,this.viewer=i.viewer,this.init()});i.prototype={init:function(){var t=this;this.viewHouseNavi=new Glodon$1.Bimface.Plugins.ViewHouseNavi(this._opt.viewer,this._domElement);var i=e.createNS("svg","bf-home-svg");i.setAttribute("viewBox","0 0 20 20");var n=e.createNS("g","");n.setAttribute("fill","none"),n.setAttribute("fill-rule","evenodd");var o=e.createNS("polygon","");o.setAttribute("fill","#E3E9EC"),o.setAttribute("points","1.207 9.5 3.5 9.5 3.5 16.499 7.501 16.499 7.503 12.5 12.5 12.5 12.5 16.499 16.5 16.499 16.5 9.5 18.793 9.5 10 .707"),i.addEventListener("mouseover",(function(){o.setAttribute("fill","#BAFFEC"),s.setAttribute("fill","#32D3A6")})),i.addEventListener("mouseout",(function(){o.setAttribute("fill","#E3E9EC"),s.setAttribute("fill","#BCC0C2")})),i.addEventListener("mousedown",(function(){t.viewHouseMenu.switchHomeView()}));var s=e.createNS("path","");s.setAttribute("fill","#BCC0C2"),s.setAttribute("d","M10,0 L0,10 L3,10 L3,17 L8,17 L8.003,13.001 L12,13.001 L12,17 L17,17 L17,10 L20,10 L10,0 Z M10,1.414 L17.586,9 L17,9 L16,9 L16,10 L16,16 L13,16 L13,13.001 L13,12 L12,12 L8.003,12 L7.004,12 L7.003,12.999 L7.001,16 L4,16 L4,10 L4,9 L3,9 L2.414,9 L10,1.414 Z"),n.appendChild(o),n.appendChild(s),i.appendChild(n),t._domElement.appendChild(i),this.homeSvg=i;var r=e.createNS("svg","bf-menu-svg");r.setAttribute("viewBox","0 0 20 20"),r.style.position="absolute";var a=e.createNS("g","");a.setAttribute("fill","none"),a.setAttribute("fill-rule","evenodd"),a.setAttribute("transform","translate(3 6)");var l=e.createNS("polygon","");l.setAttribute("fill","#E3E9EC"),l.setAttribute("points","1.207 4.5 6.999 10.292 12.793 4.5");var h=e.createNS("path","");h.setAttribute("fill","#BCC0C2"),h.setAttribute("d","M0.0004,3.9998 L6.9994,10.9998 L13.9994,3.9998 L0.0004,3.9998 Z M2.4144,4.9998 L11.5864,4.9998 L6.9994,9.5858 L2.4144,4.9998 Z");var c=e.createNS("polygon","");c.setAttribute("fill","#E3E9EC"),c.setAttribute("points",".5 2.5 13.5 2.5 13.5 .5 .5 .5");var d=e.createNS("path","");d.setAttribute("fill","#BCC0C2"),d.setAttribute("d","M0,3 L14,3 L14,0 L0,0 L0,3 Z M1,2 L13,2 L13,1 L1,1 L1,2 Z"),r.addEventListener("mouseover",(function(){l.setAttribute("fill","#BAFFEC"),h.setAttribute("fill","#32D3A6"),c.setAttribute("fill","#BAFFEC"),d.setAttribute("fill","#32D3A6")})),r.addEventListener("mouseout",(function(){l.setAttribute("fill","#E3E9EC"),h.setAttribute("fill","#BCC0C2"),c.setAttribute("fill","#E3E9EC"),d.setAttribute("fill","#BCC0C2")})),a.appendChild(l),a.appendChild(h),a.appendChild(c),a.appendChild(d),r.appendChild(a),t._domElement.appendChild(r),this.menuSvg=r;var u=new Glodon$1.Bimface.Application.UI.Menu.ViewHouseMenu(this._opt);this.viewHouseMenu=u,u.hide(),r.addEventListener("click",(function(e){t.viewer.getDomElement().getBoundingClientRect();u.isHide()?(u.update(),u.show()):u.hide()}))},enableViewHouse:function(t){this.viewHouseNavi.setVisible(t),this._domElement.style.display=!0===t?"block":"none"},getDomElement:function(){return this._domElement},destroy:function(){this.viewHouseNavi.destroy(),this.viewHouseNavi=null,this.viewHouseMenu.destroy(),this.viewHouseMenu=null,this._domElement.removeChild(this.menuSvg),this.menuSvg=null,this._domElement.removeChild(this.homeSvg),this.homeSvg=null,this._domElement=null,this.viewer=null,this._opt=null}},t.ViewHouse=i}(),Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins").AnnotationConfig=function(){return{background:null,domElement:null,viewer:null,style:{"stroke-width":3,"stroke-color":"#ff0000","stroke-opacity":1,"fill-color":"#ff0000","fill-opacity":0,"font-family":"Arial","font-size":16,"font-style":"italic","font-weight":"bold"}}},function(){let t=Object.freeze({Arrow:"Arrow",Rectangle:"Rectangle",Circle:"Circle",Cross:"Cross",Cloud:"Cloud",Text:"Text"});Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins").AnnotationTypeOption=t}(),function(){var t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins"),e=(Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.Dom"),Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.HttpRequest"),function(t){this._opt=t,this.init()});e.prototype={init:function(){var t,e=this._opt;if(e.viewer)t=new CLOUD$1.Extensions.AnnotationHelper3D(e.viewer.getViewer());else{if(!e.domElement)return alert("domElement must not be empty."),!1;(t=new CLOUD$1.Extensions.AnnotationHelper2D).setDomContainer(e.domElement)}this._helper=t},begin:function(){var t=this._helper,e=this._opt;t.editAnnotationBegin(e.absBasePoint,e.screenBasePoint,e.zoomFactor)},end:function(){this._helper.editAnnotationEnd()},save:function(){return this._helper.getAnnotationInfoList()},load:function(t){var e=this._helper;this._opt;e.loadAnnotations(t)},createSnapshot:function(t,e){return this._helper.captureAnnotationsScreenSnapshot(t,e)},setType:function(t){this._helper.setAnnotationType({arrow:0,rectangle:1,circle:2,cross:3,cloud:4,text:5}[t.toLocaleLowerCase()])},setStyle:function(t){this._helper.setAnnotationStyle(t)},destroy:function(){this._helper.destroy()}},t.Annotation=e,t.Annotation.Annotation=t.Annotation,t.Annotation.AnnotationConfig=t.AnnotationConfig}(),Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Annotation").AnnotationManagerConfig=function(){return{viewer:null,lineWidth:3,lineColor:new Glodon$1.Web.Graphics.Color(208,2,27,1),fillColor:new Glodon$1.Web.Graphics.Color(255,255,255,0),fontFamily:"Arial",fontSize:14,windowAdaption:!1}},function(){let t=Object.freeze({Arrow:"Arrow",Rectangle:"Rectangle",Circle:"Ellips",Ellips:"Ellips",Cross:"Cross",Cloud:"Cloud",CloudRect:"Cloud-rect",Text:"Text",Polyline:"Polyline"});Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Annotation").AnnotationTypeOption=t}(),function(){var t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Annotation"),e=(Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.Dom"),Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.HttpRequest"),function(t){});e.prototype={init:function(){var t,e=this._opt;t=new CLOUD$1.Extensions.AnnotationHelper3D(e.viewer.getViewer(),e),this._helper=t},startDrawing:function(){var t=this._helper;this._opt;t.editAnnotationBegin(),this.isShowAnnotation=!0},getAnnotationList:function(){return this._helper.getAnnotationInfoList()},setAnnotationList:function(t){t&&0!=t.length?(this._annotationList=t,this._helper.loadAnnotations(t),this.isShowAnnotation=!0):this.clear()},createSnapshot:function(t){this._opt.viewer;this._helper.captureAnnotationsScreenSnapshot("",t)},setState:function(t){var e=this,i=e._opt.viewer;i.setState(t.state),i.render(),setTimeout((function(){e.setAnnotationList(t.annotationList)}),1e3)},updateSvg:function(){var t=this._annotationList,e=this._opt.viewer.getZoomScale();if(!t||0==t.length)return!1;for(var i=0,n=t.length;i<n;i++)t[i].position=this.getSVGPosition(t[i],e),t[i].size.width=t[i].defaultSize.width*e,t[i].size.height=t[i].defaultSize.height*e;this.isShowAnnotation&&this.setAnnotationList(t)},getSVGPosition:function(t,e){var i=this._opt.viewer,n=i.screenWidth/2,o=i.screenHeight/2,s=i.worldToClient(t.worldPosition);return{x:s.x-n,y:o-s.y}},revoke:function(){}},t.AnnotationViewer3dManager=e}(),function(){var t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Annotation"),e=(Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.Dom"),Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.HttpRequest"),function(t){var e=Glodon$1.Bimface.Viewer.Viewer2DEvent,i=t.viewer,n=this;i.addEventListener(e.ViewMoving,(function(t){n.updateSvg()})),i.addEventListener(e.ViewZooming,(function(t){n.updateSvg()}))});e.prototype={init:function(){var t,e=this._opt;(t=new CLOUD$1.Extensions.AnnotationHelper2D(e)).setDomContainer(e.viewer.getDomElement()),this._helper=t},startDrawing:function(){var t=this._helper,e=this._opt;t.editAnnotationBegin();e.viewer.getZoomScale();t.editor.svg.addEventListener("mousewheel",(function(t){t.preventDefault(),t.stopPropagation()})),this.isShowAnnotation=!0},getAnnotationList:function(){var t=this._helper.getAnnotationInfoList();if(t&&t.length>0)for(var e=this._opt.viewer.getZoomScale(),i=0,n=t.length;i<n;i++)t[i].worldPosition=this.getWorldPosition(t[i]),t[i].defaultSize={width:t[i].size.width/e,height:t[i].size.height/e};return t},setAnnotationList:function(t){if(t&&0!=t.length){for(var e=this._opt.viewer.getZoomScale(),i=0,n=t.length;i<n;i++)t[i].position=this.getSVGPosition(t[i],e),t[i].size.width=t[i].defaultSize.width*e,t[i].size.height=t[i].defaultSize.height*e;this._annotationList=t,this._helper.loadAnnotations(t),this.isShowAnnotation=!0}else this.clear()},createSnapshot:function(t){var e=this;e._opt.viewer.createSnapshotAsync("",(function(i){e._helper.captureAnnotationsScreenSnapshot(i,t)}))},setState:function(t){this._opt.viewer.setState(t.state),this.setAnnotationList(t.annotationList)},updateSvg:function(){var t=this._annotationList,e=this._opt.viewer.getZoomScale();if(!t||0==t.length)return!1;for(var i=0,n=t.length;i<n;i++)t[i].position=this.getSVGPosition(t[i],e),t[i].size.width=t[i].defaultSize.width*e,t[i].size.height=t[i].defaultSize.height*e;this.isShowAnnotation&&this.setAnnotationList(t)},getSVGPosition:function(t,e){var i=this._opt.viewer,n=i.screenWidth/2,o=i.screenHeight/2,s=i.worldToClient(t.worldPosition);return{x:s.x-n,y:o-s.y}},revoke:function(){}},t.AnnotationViewer2dManager=e}(),function(){var t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Annotation"),e=(Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.Dom"),Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.HttpRequest"),function(t){this._viewer=t,this.drawingViewer=t.getViewer()});e.prototype={init:function(){var t,e=this._opt;t=this.drawingViewer.mouseEditorMgr,this.type="arrow",this.setLineWidth(e.lineWidth),this.setLineColor(e.lineColor),this.setFillColor(e.fillColor),this.setFontFamily(e.fontFamily),this.setFontSize(e.fontSize),this._helper=t},startDrawing:function(){var t,e=this._helper;this._opt;e.activeEditorByName("markup"),(t=e.getEditor()).setMarkupType(this.type),this.annotationToolbar&&(this.setLineColor({red:208,green:2,blue:27,alpha:1}),this.setLineWidth(2)),this.editor=t,this.isShowAnnotation=!0},endDrawing:function(){this.drawingViewer.markupManager.setFillColor("transparent"),this.clear(),this._helper.activeEditorByName("pick"),this.drawingViewer.update(),this.isShowAnnotation=!1},getAnnotationList:function(){return this.drawingViewer.markupManager.markups},setAnnotationList:function(t){this.drawingViewer.markupManager.markups=t,this.drawingViewer.update()},clear:function(){this.drawingViewer.markupManager.clear(),this.drawingViewer.update()},createSnapshot:function(t){var e=this._viewer.getRootElement();t(this.drawingViewer.snapshot(e.style.background))},resize:function(){this._viewer.resize()},setAnnotationType:function(t){this.type={arrow:"arrow",rectangle:"rectangle","cloud-rect":"cloud-rect",circle:"ellips",cross:"cross",cloud:"cloud",text:"text"}[t.toLocaleLowerCase()],this.editor&&this.editor.setMarkupType(this.type)},setLineWidth:function(t){this.drawingViewer.markupManager.setLineWidth(t)},setLineColor:function(t){this.drawingViewer.markupManager.setColor(`rgba(${t.red},${t.green},${t.blue},${t.alpha})`)},setFillColor:function(t){this.drawingViewer.markupManager.setFillColor(`rgba(${t.red},${t.green},${t.blue},${t.alpha})`)},setFontFamily:function(t){this.drawingViewer.markupManager.setFontFamily(t)},setFontSize:function(t){this.drawingViewer.markupManager.setFontSize(t)},getCurrentState:function(){var t=this._opt.viewer,e=this.getAnnotationList();return{annotationList:this.stringifyAnnotationList(e),state:t.getCurrentState()}},stringifyAnnotationList(t){return this.drawingViewer.markupManager.toString(t)},jsonifyAnnotationList(t){return this.drawingViewer.markupManager.fromString(t)},setState:function(t){var e=this._opt.viewer;if("string"==typeof t.annotationList){var i=this.jsonifyAnnotationList(t.annotationList);this.setAnnotationList(i)}else this.setAnnotationList(t.annotationList);e.setState(t.state)},updateSvg:function(){var t=this._annotationList,e=this._opt.viewer.getZoomScale();if(!t||0==t.length)return!1;for(var i=0,n=t.length;i<n;i++)t[i].position=this.getSVGPosition(t[i],e),t[i].size.width=t[i].defaultSize.width*e,t[i].size.height=t[i].defaultSize.height*e;this.isShowAnnotation&&this.setAnnotationList(t)},getWorldPosition:function(t){var e=this._opt.viewer,i=e.screenWidth/2,n=e.screenHeight/2,o={x:i+t.position.x,y:n-t.position.y};return e.clientToWorld(o)},getSVGPosition:function(t,e){var i=this._opt.viewer,n=i.screenWidth/2,o=i.screenHeight/2,s=i.worldToClient(t.worldPosition);return{x:s.x-n,y:o-s.y}},revoke:function(){}},t.AnnotationDrawingManager=e}();
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */
var extendStatics$3=function(t,e){return extendStatics$3=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])},extendStatics$3(t,e)};function __extends$3(t,e){function i(){this.constructor=t}extendStatics$3(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}var MouseButtons,__assign=function(){return __assign=Object.assign||function(t){for(var e,i=1,n=arguments.length;i<n;i++)for(var o in e=arguments[i])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t},__assign.apply(this,arguments)},MarkupTool=function(){function t(){}return t.prototype.onDrawing=function(t,e,i,n){this.markup&&(e.strokeStyle=this.markup.strokeStyle,e.lineWidth=this.markup.lineWidth,e.fillStyle=this.markup.fillStyle,this.markup.draw(t,e,i,n))},t.prototype.addMarkup=function(t,e){e.drawEnd=!0,this.markupManager.add(e),"function"==typeof t.itemCompleted&&t.itemCompleted(e)},t.prototype.redraw=function(t){},t.prototype.onExit=function(t){},t.prototype.onMouseMove=function(t,e,i,n){},t}(),Markups=function(){function t(){}return t.prototype.getCenter=function(t){var e=t.worldToClientPoint(this.drawPoints[0]),i=t.worldToClientPoint(this.drawPoints[1]);return[(e[0]+i[0])/2,(e[1]+i[1])/2]},t.prototype.getColor=function(){return this.strokeStyle},t.prototype.getHighlightFillColor=function(){return"rgba(61, 204, 147, 0.5)"},t.prototype.getHoverColor=function(t){return(t.markupManager.getHighlightConfig&&t.markupManager.getHighlightConfig()||{}).hoverColor||""},t.prototype.getHighlightColor=function(t){return(t.markupManager.getHighlightConfig&&t.markupManager.getHighlightConfig()||{}).highlightColor||""},t}(),EllipsMarkup=function(t){function e(e,i,n,o,s){var r=t.call(this)||this;return r.rotation=o||0,r.markupType="Ellipse",r.drawPoints=e,r.strokeStyle=i,r.lineWidth=n,r.fillStyle=s,r.bNeedHitByBbox=!0,r}return __extends$3(e,t),e.prototype.draw=function(t,e,i,n,o){if(!(this.drawPoints.length<2)){var s=t.worldToClientPoint([this.drawPoints[0][0],this.drawPoints[0][1],this.drawPoints[0][2]]),r=t.worldToClientPoint([this.drawPoints[1][0],this.drawPoints[1][1],this.drawPoints[1][2]]),a=.5*Math.abs(r[0]-s[0]),l=.5*Math.abs(r[1]-s[1]),h=this.getCenter(t);e.save(),e.translate(h[0],h[1]),e.rotate(this.rotation),e.beginPath(),e.ellipse(0,0,a,l,0,0,2*Math.PI),e.restore(),e.closePath(),this.highlightColor?(e.fillStyle=this.getHighlightFillColor(),"rgba(255,255,255,0)"===this.fillStyle&&(e.fillStyle=this.fillStyle),e.strokeStyle=this.highlightColor):(e.fillStyle=this.fillStyle,e.strokeStyle=this.strokeStyle);var c=this.getHoverColor(t);c&&o?(e.shadowColor=c,e.shadowBlur=2):(e.shadowColor="",e.shadowBlur=0),this.fillStyle&&e.fill(),e.stroke(),i.ctx.lineWidth=MarkupViewer.isMobile?18:this.lineWidth+i.lineWidth,i.ctx.fillStyle=this.fillStyle,i.drawEllips(s,r,h,this.rotation,n,a,l)}},e.prototype.setPoints=function(t){this.drawPoints=t},e.prototype.getPoints=function(){return this.drawPoints},e.prototype.getGrips=function(t){var e=t.worldToClientPoint(this.drawPoints[0]),i=t.worldToClientPoint(this.drawPoints[1]),n=[(e[0]+i[0])/2,(e[1]+i[1])/2],o=[];return o.push(e[0],e[1]),o.push(e[0],n[1]),o.push(e[0],i[1]),o.push(n[0],i[1]),o.push(i[0],i[1]),o.push(i[0],n[1]),o.push(i[0],e[1]),o.push(n[0],e[1]),o},e}(Markups);!function(t){t[t.CONTINUE=0]="CONTINUE",t[t.FINISHED=1]="FINISHED",t[t.LelftButton=1]="LelftButton",t[t.RightButton=2]="RightButton",t[t.MiddleButton=4]="MiddleButton",t[t.MouseMode=1]="MouseMode",t[t.TouchMode=2]="TouchMode"}(MouseButtons||(MouseButtons={}));var Mouse$2=MouseButtons,EllipsMarkupTool=function(t){function e(e){var i=t.call(this)||this;return i.markupManager=e,i}return __extends$3(e,t),e.prototype.begin=function(t,e,i,n){this.startX=e,this.startY=i;var o=t.markupManager.getColor(),s=t.markupManager.getLineWidth(),r=t.markupManager.getFillStyleState()?t.markupManager.getFillColor():void 0;this.markup=new EllipsMarkup([],o,s,0,r)},e.prototype.onEditing=function(t,e,i,n){var o=t.clientToWorldPoint([this.startX,this.startY]),s=t.clientToWorldPoint([e,i]);this.markup.setPoints([o,s]),this.redraw(t)},e.prototype.end=function(t,e,i,n){return this.startX==e&&this.startY==i?(console.log("Ignore single point."),Mouse$2.FINISHED):(this.addMarkup(t,this.markup),this.markup=null,Mouse$2.FINISHED)},e}(MarkupTool),RectMarkup=function(t){function e(e,i,n,o,s){var r=t.call(this)||this;return r.rotation=o||0,r.markupType="Rectangle",r.drawPoints=e,r.strokeStyle=i,r.lineWidth=n,r.fillStyle=s,r.bNeedHitByBbox=!0,r}return __extends$3(e,t),e.prototype.draw=function(t,e,i,n,o){if(!(this.drawPoints.length<2)){var s=t.worldToClientPoint([this.drawPoints[0][0],this.drawPoints[0][1],this.drawPoints[0][2]]),r=t.worldToClientPoint([this.drawPoints[1][0],this.drawPoints[1][1],this.drawPoints[1][2]]),a=this.getCenter(t);e.save(),e.translate(a[0],a[1]),e.rotate(this.rotation),e.beginPath(),e.rect(-.5*(r[0]-s[0]),-.5*(r[1]-s[1]),r[0]-s[0],r[1]-s[1]),e.restore(),e.closePath(),this.highlightColor?(e.fillStyle=this.getHighlightFillColor(),"rgba(255,255,255,0)"===this.fillStyle&&(e.fillStyle=this.fillStyle),e.strokeStyle=this.highlightColor):(e.fillStyle=this.fillStyle,e.strokeStyle=this.strokeStyle);var l=this.getHoverColor(t);l&&o?(e.shadowColor=l,e.shadowBlur=2):(e.shadowColor="",e.shadowBlur=0),this.fillStyle&&e.fill(),e.stroke(),i.ctx.lineWidth=MarkupViewer.isMobile?18:this.lineWidth+i.lineWidth,i.ctx.fillStyle=this.fillStyle,i.drawRect(this,s,r,a,this.rotation,n)}},e.prototype.setPoints=function(t){this.drawPoints=t},e.prototype.getPoints=function(){return this.drawPoints},e.prototype.getGrips=function(t){var e=t.worldToClientPoint(this.drawPoints[0]),i=t.worldToClientPoint(this.drawPoints[1]),n=[(e[0]+i[0])/2,(e[1]+i[1])/2],o=[];return o.push(e[0],e[1]),o.push(e[0],n[1]),o.push(e[0],i[1]),o.push(n[0],i[1]),o.push(i[0],i[1]),o.push(i[0],n[1]),o.push(i[0],e[1]),o.push(n[0],e[1]),o},e.prototype.getRotateGrips=function(t){var e=t.worldToClientPoint(this.drawPoints[0]),i=t.worldToClientPoint(this.drawPoints[1]);return[[(e[0]+i[0])/2,(e[1]+i[1])/2][0],e[1]-20]},e}(Markups),Mouse$3=MouseButtons,RectMarkupTool=function(t){function e(e){var i=t.call(this)||this;return i.markupManager=e,i}return __extends$3(e,t),e.prototype.begin=function(t,e,i,n){this.startX=e,this.startY=i;var o=t.markupManager.getColor(),s=t.markupManager.getLineWidth(),r=t.markupManager.getFillStyleState()?t.markupManager.getFillColor():void 0;this.markup=new RectMarkup([],o,s,0,r)},e.prototype.onEditing=function(t,e,i,n){var o=t.clientToWorldPoint([this.startX,this.startY]),s=t.clientToWorldPoint([e,i]);this.markup.setPoints([o,s]),this.redraw(t)},e.prototype.end=function(t,e,i,n){return this.startX==e&&this.startY==i?(console.log("Ignore single point."),Mouse$3.FINISHED):(this.addMarkup(t,this.markup),this.markup=null,Mouse$3.FINISHED)},e}(MarkupTool),ArrowMarkup=function(t){function e(e,i,n,o){var s=t.call(this)||this;return s.rotation=o||0,s.markupType="Arrow",s.drawPoints=e,s.strokeStyle=i,s.lineWidth=n,s.bNeedHitByBbox=!1,s}return __extends$3(e,t),e.prototype.draw=function(t,e,i,n,o){if(!(this.drawPoints.length<2)){var s=t.worldToClientPoint([this.drawPoints[0][0],this.drawPoints[0][1],this.drawPoints[0][2]]),r=t.worldToClientPoint([this.drawPoints[1][0],this.drawPoints[1][1],this.drawPoints[1][2]]),a=10+this.lineWidth,l=s[0],h=s[1],c=r[0],d=r[1],u=180*Math.atan2(h-d,l-c)/Math.PI,p=(u+30)*Math.PI/180,g=(u-30)*Math.PI/180,m=a*Math.cos(p),f=a*Math.sin(p),w=a*Math.cos(g),v=a*Math.sin(g),y=l-m,b=h-f,E=[(s[0]+r[0])/2,(s[1]+r[1])/2];this.highlightColor?(e.fillStyle=this.highlightColor,e.strokeStyle=this.highlightColor):(e.fillStyle=this.strokeStyle,e.strokeStyle=this.strokeStyle);var C=this.getHoverColor(t);C&&o?(e.shadowColor=C,e.shadowBlur=1):(e.shadowColor="",e.shadowBlur=0),e.beginPath(),y=c+m,b=d+f,e.moveTo(y,b),e.lineTo(c,d),y=c+w,b=d+v,e.lineTo(y,b),e.closePath(),e.fill(),e.beginPath(),e.moveTo(l,h),m=(a-3)*Math.cos(p),f=(a-3)*Math.sin(p);var x=[c+(m+(w=(a-3)*Math.cos(g)))/2,d+(f+(v=(a-3)*Math.sin(g)))/2];e.lineTo(x[0],x[1]),e.stroke(),i.drawArrow(this,l,h,c,d,m,f,w,v,E,this.rotation,n,s,r)}},e.prototype.setPoints=function(t){this.drawPoints=t},e.prototype.getPoints=function(){return this.drawPoints},e.prototype.getGrips=function(t){var e=t.worldToClientPoint(this.drawPoints[0]),i=t.worldToClientPoint(this.drawPoints[1]);return e.concat(i)},e}(Markups),Mouse$4=MouseButtons,ArrowMarkupTool=function(t){function e(e){var i=t.call(this)||this;return i.markupManager=e,i}return __extends$3(e,t),e.prototype.begin=function(t,e,i,n){this.startX=e,this.startY=i;var o=t.markupManager.getColor(),s=t.markupManager.getLineWidth();this.markup=new ArrowMarkup([],o,s)},e.prototype.onEditing=function(t,e,i,n){var o=t.clientToWorldPoint([this.startX,this.startY]),s=t.clientToWorldPoint([e,i]);this.markup.setPoints([o,s]),this.redraw(t)},e.prototype.end=function(t,e,i,n){return this.startX==e&&this.startY==i?(console.log("Ignore single point."),Mouse$4.FINISHED):(this.addMarkup(t,this.markup),this.markup=null,Mouse$4.FINISHED)},e}(MarkupTool),CrossMarkup=function(t){function e(e,i,n,o){var s=t.call(this)||this;return s.rotation=o||0,s.markupType="Cross",s.drawPoints=e,s.strokeStyle=i,s.lineWidth=n,s.bNeedHitByBbox=!1,s}return __extends$3(e,t),e.prototype.draw=function(t,e,i,n,o){if(!(this.drawPoints.length<2)){var s=t.worldToClientPoint([this.drawPoints[0][0],this.drawPoints[0][1],this.drawPoints[0][2]]),r=t.worldToClientPoint([this.drawPoints[1][0],this.drawPoints[1][1],this.drawPoints[1][2]]),a=this.getCenter(t);e.save(),e.translate(a[0],a[1]),e.rotate(this.rotation),e.beginPath(),e.moveTo(-.5*(r[0]-s[0]),-.5*(r[1]-s[1])),e.lineTo(.5*(r[0]-s[0]),.5*(r[1]-s[1])),e.moveTo(-.5*(r[0]-s[0]),.5*(r[1]-s[1])),e.lineTo(.5*(r[0]-s[0]),-.5*(r[1]-s[1])),this.highlightColor?e.strokeStyle=this.highlightColor:e.strokeStyle=this.strokeStyle;var l=this.getHoverColor(t);l&&o?(e.shadowColor=l,e.shadowBlur=2):(e.shadowColor="",e.shadowBlur=0),e.stroke(),e.restore(),i.ctx.lineWidth=MarkupViewer.isMobile?18:this.lineWidth+i.lineWidth,i.drawCross(s,r,a,this.rotation,n)}},e.prototype.setPoints=function(t){this.drawPoints=t},e.prototype.getPoints=function(){return this.drawPoints},e.prototype.getGrips=function(t){var e=t.worldToClientPoint(this.drawPoints[0]),i=t.worldToClientPoint(this.drawPoints[1]),n=[(e[0]+i[0])/2,(e[1]+i[1])/2],o=[];return o.push(e[0],e[1]),o.push(e[0],n[1]),o.push(e[0],i[1]),o.push(n[0],i[1]),o.push(i[0],i[1]),o.push(i[0],n[1]),o.push(i[0],e[1]),o.push(n[0],e[1]),o},e}(Markups),Mouse$5=MouseButtons,CrossMarkupTool=function(t){function e(e){var i=t.call(this)||this;return i.markupManager=e,i}return __extends$3(e,t),e.prototype.begin=function(t,e,i,n){this.startX=e,this.startY=i;var o=t.markupManager.getColor(),s=t.markupManager.getLineWidth();this.markup=new CrossMarkup([],o,s)},e.prototype.onEditing=function(t,e,i,n){var o=t.clientToWorldPoint([this.startX,this.startY]),s=t.clientToWorldPoint([e,i]);this.markup.setPoints([o,s]),this.redraw(t)},e.prototype.end=function(t,e,i,n){return this.startX==e&&this.startY==i?(console.log("Ignore single point."),Mouse$5.FINISHED):(this.addMarkup(t,this.markup),this.markup=null,Mouse$5.FINISHED)},e}(MarkupTool),MathUtil=function(){function t(){}return t.distance=function(t,e){var i=e.x-t.x,n=e.y-t.y;return Math.sqrt(i*i+n*n)},t.center=function(t,e){return{x:(e.x+t.x)/2,y:(e.y+t.y)/2}},t.centerByArr=function(t,e){return[(e[0]+t[0])/2,(e[1]+t[1])/2]},t.distanceByArr=function(t,e){var i=e[0]-t[0],n=e[1]-t[1];return Math.sqrt(i*i+n*n)},t.normalize=function(t){var e=Math.sqrt(t[0]*t[0]+t[1]*t[1]);return[t[0]/e,t[1]/e]},t.isPointInBBox=function(t,e,i,n){var o=.5*n[0];if(t<i[0]-o||t>i[0]+o)return!1;var s=.5*n[1];return!(e<i[1]-s||e>i[1]+s)},t.rotateAround=function(t,e,i){var n=[0,0],o=Math.cos(i),s=Math.sin(i),r=t[0]-e[0],a=t[1]-e[1];return n[0]=r*o-a*s+e[0],n[1]=r*s+a*o+e[1],n},t}(),CloudMarkup=function(t){function e(e,i,n,o,s,r,a){var l=t.call(this)||this;return l.rotation=s||0,l.fillStyle=r||0,l.close=a||!1,l.markupType="Cloud",l.drawPoints=e,l.strokeStyle=i,l.lineWidth=n,l.controlPt=[],l.editPt=null,l.bNeedHitByBbox=!0,l}return __extends$3(e,t),e.prototype.draw=function(t,e,i,n,o){if(!(this.drawPoints.length<2)){var s=t.markupManager.getMarkupCenter(t,n);s||(s=[0,0]),e.save(),e.translate(s[0],s[1]),e.rotate(this.rotation),e.beginPath(),i.ctx.save(),i.ctx.translate(s[0],s[1]),i.ctx.rotate(this.rotation),i.ctx.beginPath(),i.ctx.strokeStyle="rgba("+(2*n+2)+",60,60,1)",i.ctx.fillStyle="rgba("+(2*n+2)+",60,255,1)",i.ctx.lineWidth=MarkupViewer.isMobile?18:this.lineWidth+i.lineWidth;for(var r=1,a=this.drawPoints.length;r<a;r++){var l=t.worldToClientPoint([this.drawPoints[r-1][0],this.drawPoints[r-1][1],this.drawPoints[r-1][2]]),h=t.worldToClientPoint([this.drawPoints[r][0],this.drawPoints[r][1],this.drawPoints[r][2]]),c=void 0;if(1==r&&(e.moveTo(l[0]-s[0],l[1]-s[1]),i.ctx.moveTo(l[0]-s[0],l[1]-s[1])),this.editPt&&this.editPt[r-1])c=t.worldToClientPoint([this.editPt[r-1][0],this.editPt[r-1][1],this.editPt[r-1][2]]);else if(this.controlPt[r-1]&&r<a-1)c=t.worldToClientPoint([this.controlPt[r-1][0],this.controlPt[r-1][1],this.controlPt[r-1][2]]);else{c=this.getControlPt(l,h);var d=t.clientToWorldPoint(c);d[0]&&d[1]&&(this.controlPt[r-1]=d)}e.quadraticCurveTo(c[0]-s[0],c[1]-s[1],h[0]-s[0],h[1]-s[1]),i.ctx.quadraticCurveTo(c[0]-s[0],c[1]-s[1],h[0]-s[0],h[1]-s[1])}i.ctx.stroke(),this.highlightColor?(e.fillStyle=this.getHighlightFillColor(),"rgba(255,255,255,0)"===this.fillStyle&&(e.fillStyle=this.fillStyle),e.strokeStyle=this.highlightColor):(e.fillStyle=this.fillStyle,e.strokeStyle=this.strokeStyle);var u=this.getHoverColor(t);u&&o?(e.shadowColor=u,e.shadowBlur=2):(e.shadowColor="",e.shadowBlur=0),this.close&&this.fillStyle&&e.fill(),e.stroke(),e.restore(),i.ctx.restore()}},e.prototype.shouldClose=function(t,e,i){if(this.drawPoints.length<3)return!1;var n=t.worldToClientPoint([this.drawPoints[0][0],this.drawPoints[0][1],this.drawPoints[0][2]]);return MathUtil.distanceByArr(n,[e,i])<5?(this.close=!0,!0):(this.close=!1,!1)},e.prototype.getControlPt=function(t,e,i){var n=[(t[0]+e[0])/2,(t[1]+e[1])/2],o=.6*MathUtil.distanceByArr(t,e),s=[e[1]-t[1],t[0]-e[0]];return s=MathUtil.normalize(s),[n[0]+s[0]*o,n[1]+s[1]*o]},e.prototype.setPoints=function(t){this.drawPoints=t},e.prototype.addPoint=function(t){this.drawPoints.push(t)},e.prototype.getStartPoint=function(){return this.drawPoints[0]},e.prototype.popPoint=function(){this.drawPoints.pop()},e.prototype.isEmpty=function(){return 0==this.drawPoints.length},e.prototype.getPoints=function(){return this.drawPoints},e.prototype.getGrips=function(t,e){if(null==e)return this.drawPoints;var i=t.markupManager.getMarkupBbox(t,e),n=[i[0],i[1]],o=[i[2],i[3]],s=[(n[0]+o[0])/2,(n[1]+o[1])/2],r=[];return r.push(n[0],n[1]),r.push(n[0],s[1]),r.push(n[0],o[1]),r.push(s[0],o[1]),r.push(o[0],o[1]),r.push(o[0],s[1]),r.push(o[0],n[1]),r.push(s[0],n[1]),r},e}(Markups),Mouse$6=MouseButtons,CloudMarkupTool=function(t){function e(e){var i=t.call(this)||this;return i.markupManager=e,i.bFirstCloudMarkup=!0,i.uncertainty=!1,i}return __extends$3(e,t),e.prototype.begin=function(t,e,i,n){if(this.bFirstCloudMarkup){if(t.markupManager.hitTest(t,e,i)>-1)return;var o=t.markupManager.getColor(),s=t.markupManager.getLineWidth(),r=t.markupManager.getFillStyleState()?t.markupManager.getFillColor():void 0;this.markup=new CloudMarkup([],o,s,null,0,r),this.bFirstCloudMarkup=!1}if(this.markup.shouldClose(t,e,i))this.addMarkup(t,this.markup),this.markup=null,this.redraw(t),this.bFirstCloudMarkup=!0;else{var a=t.clientToWorldPoint([e,i]);this.markup.popPoint(),this.markup.addPoint(a)}this.uncertainty=!1},e.prototype.onEditing=function(t,e,i,n){if(!this.bFirstCloudMarkup){var o=void 0;o=this.markup.shouldClose(t,e,i)?this.markup.getStartPoint():t.clientToWorldPoint([e,i]),this.uncertainty&&this.markup.drawPoints.length>1?this.markup.popPoint():this.uncertainty=!0,this.markup.addPoint(o),this.redraw(t)}},e.prototype.onMouseMove=function(t,e,i,n){this.onEditing(t,e,i,n)},e.prototype.end=function(t,e,i,n){if(this.bFirstCloudMarkup)return Mouse$6.FINISHED},e.prototype.onMouseRightClick=function(t,e){this.bFirstCloudMarkup||(this.markup.popPoint(),this.markup.drawPoints.length>1&&this.addMarkup(t,this.markup),this.markup.close=!1,this.markup=null,this.redraw(t),this.bFirstCloudMarkup=!0)},e.prototype.onDoubleClick=function(t,e){if(!this.bFirstCloudMarkup){this.markup.popPoint();var i=this.markup.drawPoints.length;i>1&&this.addMarkup(t,this.markup);var n=t.worldToClientPoint([this.markup.drawPoints[i-1][0],this.markup.drawPoints[i-1][1],this.markup.drawPoints[i-1][2]]);MathUtil.distanceByArr(n,[e.x,e.y])<5&&this.markup.popPoint(),this.markup=null,this.redraw(t),this.bFirstCloudMarkup=!0}},e.prototype.getIsEndDrawing=function(){return this.bFirstCloudMarkup},e}(MarkupTool),CloudRectMarkup=function(t){function e(e,i,n,o,s){var r=t.call(this)||this;return r.rotation=o||0,r.markupType="CloudRect",r.drawPoints=e,r.strokeStyle=i,r.lineWidth=n,r.fillStyle=s,r.baseUnit="30",r.bNeedHitByBbox=!0,r}return __extends$3(e,t),e.prototype.draw=function(t,e,i,n,o){if(!(this.drawPoints.length<2)){var s=t.worldToClientPoint([this.drawPoints[0][0],this.drawPoints[0][1],this.drawPoints[0][2]]),r=t.worldToClientPoint([this.drawPoints[1][0],this.drawPoints[1][1],this.drawPoints[1][2]]),a=this.getCenter(t),l=r[1]-s[1],h=r[0]-s[0],c=Math.abs(h),d=Math.abs(l),u=c/this.baseUnit,p=d/this.baseUnit,g=parseInt(u),m=parseInt(p),f=0==g?c:c/g,w=0==m?d:d/m;e.save(),e.translate(a[0],a[1]),e.rotate(this.rotation),e.beginPath(),i.ctx.save(),i.ctx.translate(a[0],a[1]),i.ctx.rotate(this.rotation),i.ctx.beginPath();var v=[-c/2,-d/2],y=[c/2,d/2];i.ctx.strokeStyle="rgba("+(2*n+2)+",40,40,1)",i.ctx.lineWidth=MarkupViewer.isMobile?18:this.lineWidth+i.lineWidth,e.lineJoin="round",this.drawSide("orientation",f,c,v[0],v[1],e,null,n,i,!0),this.drawSide("portrait",w,d,y[0],v[1],e,null,n,i),this.drawSide("orientation",f,c,y[0],y[1],e,!0,n,i),this.drawSide("portrait",w,d,v[0],y[1],e,!0,n,i),this.highlightColor?(e.fillStyle=this.getHighlightFillColor(),"rgba(255,255,255,0)"===this.fillStyle&&(e.fillStyle=this.fillStyle),e.strokeStyle=this.highlightColor):(e.fillStyle=this.fillStyle,e.strokeStyle=this.strokeStyle);var b=this.getHoverColor(t);b&&o?(e.shadowColor=b,e.shadowBlur=2):(e.shadowColor="",e.shadowBlur=0),this.fillStyle&&e.fill(),e.stroke(),e.restore(),i.ctx.stroke(),i.ctx.restore()}},e.prototype.drawSide=function(t,e,i,n,o,s,r,a,l,h){var c,d=0,u=0,p=i/e,g=n,m=o;"orientation"==t?d=e:u=e;for(var f=0;f<p;f++){h&&0==f&&s.moveTo(n,o),c=r?[n-d,o-u]:[n+d,o+u],d&&Math.abs(c[0]-g)>i?c[0]=r?g-i:g+i:u&&Math.abs(c[1]-m)>i&&(c[1]=r?m-i:m+i);var w=this.getControlPt([n,o],c);s.quadraticCurveTo(w[0],w[1],c[0],c[1]),l.drawCloudRect(n,o,w,c,a),n=c[0],o=c[1]}},e.prototype.getControlPt=function(t,e,i){var n=[(t[0]+e[0])/2,(t[1]+e[1])/2],o=.5*MathUtil.distanceByArr(t,e),s=[e[1]-t[1],t[0]-e[0]];return s=MathUtil.normalize(s),[n[0]+s[0]*o,n[1]+s[1]*o]},e.prototype.setPoints=function(t){this.drawPoints=t},e.prototype.getPoints=function(){return this.drawPoints},e.prototype.getGrips=function(t){var e=t.worldToClientPoint(this.drawPoints[0]),i=t.worldToClientPoint(this.drawPoints[1]),n=[(e[0]+i[0])/2,(e[1]+i[1])/2],o=[];return o.push(e[0],e[1]),o.push(e[0],n[1]),o.push(e[0],i[1]),o.push(n[0],i[1]),o.push(i[0],i[1]),o.push(i[0],n[1]),o.push(i[0],e[1]),o.push(n[0],e[1]),o},e}(Markups),Mouse$7=MouseButtons,CloudRectMarkupTool=function(t){function e(e){var i=t.call(this)||this;return i.markupManager=e,i}return __extends$3(e,t),e.prototype.begin=function(t,e,i,n){this.startX=e,this.startY=i;var o=t.markupManager.getColor(),s=t.markupManager.getLineWidth(),r=t.markupManager.getFillStyleState()?t.markupManager.getFillColor():void 0;this.markup=new CloudRectMarkup([],o,s,0,r)},e.prototype.onEditing=function(t,e,i,n){var o=t.clientToWorldPoint([this.startX,this.startY]),s=t.clientToWorldPoint([e,i]);this.markup.setPoints([o,s]),this.redraw(t)},e.prototype.end=function(t,e,i,n){return this.startX==e&&this.startY==i?(console.log("Ignore single point."),Mouse$7.FINISHED):(this.addMarkup(t,this.markup),this.markup=null,Mouse$7.FINISHED)},e}(MarkupTool),TextMarkup=function(t){function e(e,i,n,o,s,r,a,l,h){var c=t.call(this)||this;c.rotation=r||0,c.textAreaId=a||null,c.center=l||null,c.markupType="Text",c.drawPoints=h?e:[e],c.pureText=i,c.userText=i,c.strokeStyle=n,c.fontSize=o,c.fontFamily=s;var d=document.createElement("canvas");return c.virtualCtx=d.getContext("2d"),c.bNeedHitByBbox=!1,c}return __extends$3(e,t),e.prototype.draw=function(t,e,i,n,o){var s=t.worldToClientPoint(this.drawPoints[0]),r=this.getTextBbox(t),a=[(r[2]+r[0])/2,(r[3]+r[1])/2];this.center&&(a=t.worldToClientPoint(this.center)),e.save(),e.translate(a[0],a[1]),e.rotate(this.rotation),e.beginPath(),i.init(a,this.rotation),e.fillStyle=e.strokeStyle,e.font=this.fontSize+"px "+this.fontFamily,e.zIndex=120,i.ctx.font="bold "+this.fontSize+"px "+this.fontFamily,i.ctx.strokeStyle="rgba("+(2*n+2)+",80,80,1)",i.ctx.fillStyle="rgba("+(2*n+2)+",80,80,1)";var l=this.userText.split(/\n/);this.highlightColor?e.fillStyle=this.getHighlightFillColor():e.fillStyle=this.strokeStyle;var h=this.getHoverColor(t);h&&o?(e.shadowColor=h,e.shadowBlur=1):(e.shadowColor="",e.shadowBlur=0);for(var c=0;c<l.length;c++){e.fillText(l[c],s[0]-a[0],s[1]-a[1]+(c+1)*this.fontSize),i.ctx.fillText(l[c],s[0]-a[0],s[1]-a[1]+(c+1)*this.fontSize);var d=l[c].replace(/[a-z]/g,"aa").replace(/[^\u0000-\u00ff]/g,"aaaa").replace(/[A-Z]/g,"aaa").replace(/[0-9]/g,"aa").length;i.ctx.fillRect(s[0]-a[0],s[1]-a[1]+c*this.fontSize,d*this.fontSize*4/14,20)}e.restore(),i.ctx.restore()},e.prototype.setPoints=function(t){this.drawPoints=t},e.prototype.getPoints=function(){return this.drawPoints},e.prototype.getId=function(){return this.textAreaId},e.prototype.getUserText=function(){return this.userText},e.prototype.getPureText=function(){return this.pureText},e.prototype.setUserText=function(t){this.userText=t},e.prototype.setPureText=function(t){this.pureText=t},e.prototype.show=function(t){var e=t.worldToClientPoint([this.drawPoints[0][0],this.drawPoints[0][1],this.drawPoints[0][2]]),i=document.getElementById(this.textAreaId),n=t.wrapDom.getBoundingClientRect();i.style.left=e[0]+n.left+"px",i.style.top=e[1]+n.top+"px",i.style.fontFamily=this.fontFamily,i.style.fontSize=this.fontSize,i.style.border="4px",i.style.resize="none",i.style.zIndex=100,i.style.display="block",i.value=this.userText},e.prototype.resizeText=function(t){this.virtualCtx.font=this.fontSize+"px "+this.fontFamily;for(var e=(this.pureText||this.userText).split(/\n/),i=t[0],n=0;n<e.length;n++){for(var o="",s=e[n].slice(),r="",a=0,l=0;l<s.length;l++){var h=this.virtualCtx.measureText(s[l]).width;a+=h,o+=s[l],a>i&&o.length>1?(r+="\n"+s[l],a=h,o=s[l]):a==i?(e[n]=s.slice(0,l+1)+"\n"+s.slice(l+1),r+=s[l]+"\n",a=0,o=""):r+=s[l]}e[n]=r}this.userText=e.join("\n")},e.prototype.resizeTextarea=function(){var t=document.getElementById(this.textAreaId);t.value=this.userText;var e=this.userText.split(/\n/),i=0;t.rows=e.length;for(var n=0;n<e.length;n++){var o=e[n].replace(/[^\u0000-\u00ff]/g,"aa").replace(/[A-Z]/g,"aa").length;o>i&&(i=o)}t.cols=i},e.prototype.getTextBbox=function(t){var e,i=this.getTextSize(),n=t.worldToClientPoint(this.drawPoints[0]);return e=this.drawPoints[1]?t.worldToClientPoint(this.drawPoints[1]):[n[0]+i[0],n[1]+i[1]],n.concat(e)},e.prototype.getTextSize=function(){var t=0;this.virtualCtx.font=this.fontSize+"px "+this.fontFamily;for(var e,i=this.userText.split(/\n/),n=0;n<i.length;n++)(e=this.virtualCtx.measureText(i[n])).width>t&&(t=e.width);return[t,i.length*this.fontSize]},e.prototype.getEndPt=function(t){var e=this.getTextBbox(t);return[e[2],e[3]]},e.prototype.getGrips=function(t){var e=t.worldToClientPoint(this.drawPoints[0]);if(this.drawPoints[1]){o=t.worldToClientPoint(this.drawPoints[1]);var i=[(e[0]+o[0])/2,(e[1]+o[1])/2]}else var n=this.getTextBbox(t),o=(i=[(n[2]+n[0])/2,(n[3]+n[1])/2],[n[2],n[3]]);var s=[];return s.push(e[0],e[1]),s.push(e[0],i[1]),s.push(e[0],o[1]),s.push(i[0],o[1]),s.push(o[0],o[1]),s.push(o[0],i[1]),s.push(o[0],e[1]),s.push(i[0],e[1]),s},e}(Markups),Mouse$8=MouseButtons,TextMarkupTool=function(t){function e(e,i,n){var o=t.call(this)||this;return o.editorMode=-1,o.rotation=i,o.worldPoint=[],o.drawPoints=n,o.markupManager=e,o}return __extends$3(e,t),e.prototype.begin=function(t,i,n,o){this.startX=i,this.startY=n,this.textAreaId="";var s=!0;null==this.userText&&(s=this.initDom(t)),s&&""==e.lastTextareaId&&(this.createDiv(e.divId),this.insertTextArea2Dom(t),this.addKeyDownListener(t),this.addInputListener(t))},e.prototype.onEditing=function(t,e,i,n){},e.prototype.end=function(t,e,i,n){return Mouse$8.FINISHED},e.prototype.onExit=function(t){""!=e.lastTextareaId&&(this.removeTextAreaInDom(e.lastTextareaId),e.lastTextareaId="")},e.prototype.initDom=function(t){if(""!=e.lastTextareaId){var i=document.getElementById(e.lastTextareaId),n=i.value.trim();if(""==n)this.removeTextAreaInDom(e.lastTextareaId);else{var o=t.wrapDom.getBoundingClientRect(),s=parseInt(i.style.left.split("px")[0]),r=parseInt(i.style.top.split("px")[0]),a=[s-o.left,r-o.top],l=this.drawPoints&&this.drawPoints[0]||this.worldPoint!==[]&&this.worldPoint||t.clientToWorldPoint(a),h=i.style.color,c=t.markupManager.getFontSize(),d=i.style.fontFamily,u=new TextMarkup(l,n,h,c,d,this.rotation||0,e.lastTextareaId);this.size&&(u.setPureText(n),this.setPureText(n),u.resizeText(this.size)),this.rotation=0,this.hideTextArea(e.lastTextareaId),this.addMarkup(t,u),u=null,this.redraw(t)}return e.lastTextareaId="",!1}return!0},e.prototype.createDiv=function(t){if(null==document.getElementById(t)){console.log("Create div in dom.");var i=document.createElement("div");i.addEventListener("mousedown",(function(){event.stopImmediatePropagation()})),i.addEventListener("mouseup",(function(){event.stopImmediatePropagation()})),i.addEventListener("mousemove",(function(){event.stopImmediatePropagation()})),i.setAttribute("id",e.divId),i.style.position="absolute",i.style.left="0",i.style.top="0",this.markupManager.viewer.wrapDom.appendChild(i);var n=document.createElement("span");n.id="box",n.style.visibility="hidden",i.appendChild(n);var o=document.createElement("span");n.id="boxEdit",n.style.visibility="hidden",n.style.wordBreak="break-all",n.style.display="inline-block",i.appendChild(o)}},e.prototype.setEditBox=function(t){this.size=t},e.prototype.hideTextArea=function(t){var e=document.getElementById(t);e.blur(),e.style.display="none"},e.prototype.showTextArea=function(t){document.getElementById(t).style.display="block"},e.prototype.setUserText=function(t){this.userText=t},e.prototype.setPureText=function(t){this.pureText=t},e.prototype.addKeyDownListener=function(t){var e=this,i=document.getElementById(this.textAreaId);i&&i.addEventListener("keydown",(function(i){return e.keyDownFunction(t,i)}),!0)},e.prototype.addInputListener=function(t){var e=this,i=document.getElementById(this.textAreaId);i&&(i.addEventListener("input",(function(n){e.resize(i,t)})),i.addEventListener("blur",(function(t){})))},e.prototype.resize=function(t,i){var n=t.value.split(/\n/),o=document.querySelectorAll("#"+e.divId+" span")[0];o.innerText=t.value,o.style.fontSize=i.markupManager.getFontSize()+"px",t.style.width=o.offsetWidth+20+"px",t.rows=n.length},e.prototype.keyDownFunction=function(t,e){var i=document.getElementById(this.textAreaId);13==e.keyCode&&(i.rows=i.rows+1,console.log("Key enter pressed."))},e.prototype.addMouseDownListener=function(){var t=document.getElementById(this.textAreaId);t&&t.addEventListener("click",(function(t){console.log("Mouse click textarea now.")}))},e.prototype.createTextArea=function(t){var e=[this.startX,this.startY];this.worldPoint=t.clientToWorldPoint(e);var i=document.createElement("textArea");i.setAttribute("id",this.textAreaId),i.setAttribute("maxlength",999),i.value=null==this.userText?"":this.userText,i.style.color=t.markupManager.getColor(),i.style.position="fixed",i.style.lineHeight="100%",i.style.width="10px",i.style.paddingLeft="6px",i.style.overflow="hidden",i.style.webkitUserSelect="auto",null!=this.userText?this.resize(i,t):i.rows="1";var n=t.wrapDom.getBoundingClientRect();return i.style.left=e[0]+n.left+"px",i.style.top=e[1]+n.top+"px",i.style.fontFamily=t.markupManager.getFontFamily(),i.style.fontSize=t.markupManager.getFontSize()+"px",i.style.border="1px solid red",i.style.background="transparent",i.style.outline="none",i.style.resize="none",i.style.zIndex=100,i.style.display="block",i},e.prototype.insertTextArea2Dom=function(t){var i=document.getElementById(e.divId),n=i.childElementCount+1;this.textAreaId="textArea_"+n;var o=this.createTextArea(t);this.textArea=o,i.appendChild(o),o.focus(),e.lastTextareaId=this.textAreaId},e.prototype.reposition=function(t){var e=t.worldToClientPoint(this.worldPoint),i=t.wrapDom.getBoundingClientRect();this.textArea.style.left=e[0]+i.left+"px",this.textArea.style.top=e[1]+i.top+"px"},e.prototype.removeTextAreaInDom=function(t){var i=document.getElementById(e.divId),n=document.getElementById(t);try{i.removeChild(n)}catch(t){}},e.lastTextareaId="",e.divId="bf-drawing-textEditor",e}(MarkupTool),PolylineMarkup=function(t){function e(e,i,n,o,s,r){var a=t.call(this)||this;return a.rotation=o||0,a.close=r||!1,a.fillStyle=s,a.markupType="Polyline",a.drawPoints=e,a.strokeStyle=i,a.lineWidth=n,a.editPt=null,a.bNeedHitByBbox=!1,a}return __extends$3(e,t),e.prototype.draw=function(t,e,i,n,o){if(!(this.drawPoints.length<2)){var s=t.markupManager.getMarkupCenter(t,n);s||(s=[0,0]),e.save(),e.translate(s[0],s[1]),e.rotate(this.rotation),e.beginPath(),e.lineJoin="round",i.init(s,this.rotation),i.ctx.lineWidth=MarkupViewer.isMobile?18:this.lineWidth+i.lineWidth;for(var r=1,a=this.drawPoints.length;r<a;r++){var l=t.worldToClientPoint([this.drawPoints[r-1][0],this.drawPoints[r-1][1],this.drawPoints[r-1][2]]),h=t.worldToClientPoint([this.drawPoints[r][0],this.drawPoints[r][1],this.drawPoints[r][2]]);1==r&&e.moveTo(l[0]-s[0],l[1]-s[1]),e.lineTo(h[0]-s[0],h[1]-s[1]),i.drawPolyline(l,h,s,this.rotation,n)}this.highlightColor?(e.fillStyle=this.getHighlightFillColor(),"rgba(255,255,255,0)"===this.fillStyle&&(e.fillStyle=this.fillStyle),e.strokeStyle=this.highlightColor):(e.fillStyle=this.fillStyle,e.strokeStyle=this.strokeStyle);var c=this.getHoverColor(t);c&&o?(e.shadowColor=c,e.shadowBlur=2):(e.shadowColor="",e.shadowBlur=0),this.close&&this.fillStyle&&(e.fill(),this.bNeedHitByBbox=!0),e.stroke(),e.restore(),i.ctx.restore()}},e.prototype.shouldClose=function(t,e,i){if(this.drawPoints.length<3)return!1;var n=t.worldToClientPoint([this.drawPoints[0][0],this.drawPoints[0][1],this.drawPoints[0][2]]);return MathUtil.distanceByArr(n,[e,i])<5?(this.close=!0,!0):(this.close=!1,!1)},e.prototype.setPoints=function(t){this.drawPoints=t},e.prototype.addPoint=function(t){this.drawPoints.push(t)},e.prototype.getStartPoint=function(){return this.drawPoints[0]},e.prototype.popPoint=function(){this.drawPoints.pop()},e.prototype.isEmpty=function(){return 0==this.drawPoints.length},e.prototype.getPoints=function(){return this.drawPoints},e.prototype.getGrips=function(t,e){if(null==e)return this.drawPoints;var i=t.markupManager.getMarkupBbox(t,e),n=[i[0],i[1]],o=[i[2],i[3]],s=[(n[0]+o[0])/2,(n[1]+o[1])/2],r=[];return r.push(n[0],n[1]),r.push(n[0],s[1]),r.push(n[0],o[1]),r.push(s[0],o[1]),r.push(o[0],o[1]),r.push(o[0],s[1]),r.push(o[0],n[1]),r.push(s[0],n[1]),r},e}(Markups),Mouse$9=MouseButtons,PolylineMarkupTool=function(t){function e(e){var i=t.call(this)||this;return i.markupManager=e,i.bFirstCloudMarkup=!0,i.uncertainty=!1,i}return __extends$3(e,t),e.prototype.begin=function(t,e,i,n){if(this.bFirstCloudMarkup){if(t.markupManager.hitTest(t,e,i)>-1)return;var o=t.markupManager.getColor(),s=t.markupManager.getLineWidth(),r=t.markupManager.getFillStyleState()?t.markupManager.getFillColor():void 0;this.markup=new PolylineMarkup([],o,s,0,r),this.bFirstCloudMarkup=!1}if(this.markup.shouldClose(t,e,i))this.addMarkup(t,this.markup),this.markup=null,this.redraw(t),this.bFirstCloudMarkup=!0;else{var a=t.clientToWorldPoint([e,i]);this.markup.popPoint(),this.markup.addPoint(a)}this.uncertainty=!1},e.prototype.onEditing=function(t,e,i,n){if(!this.bFirstCloudMarkup){var o=void 0;o=this.markup.shouldClose(t,e,i)?this.markup.getStartPoint():t.clientToWorldPoint([e,i]),this.uncertainty&&this.markup.drawPoints.length>1?this.markup.popPoint():this.uncertainty=!0,this.markup.addPoint(o),this.redraw(t)}},e.prototype.onMouseMove=function(t,e,i,n){this.onEditing(t,e,i,n)},e.prototype.end=function(t,e,i,n){if(this.bFirstCloudMarkup)return Mouse$9.FINISHED},e.prototype.onMouseRightClick=function(t,e){this.bFirstCloudMarkup||(this.markup.popPoint(),this.markup.drawPoints.length>1&&this.addMarkup(t,this.markup),this.markup=null,this.redraw(t),this.bFirstCloudMarkup=!0)},e.prototype.onDoubleClick=function(t,e){this.bFirstCloudMarkup||(this.markup.popPoint(),this.markup.drawPoints.length>1&&this.addMarkup(t,this.markup),this.markup=null,this.redraw(t),this.bFirstCloudMarkup=!0)},e.prototype.getIsEndDrawing=function(){return this.bFirstCloudMarkup},e}(MarkupTool),Mouse$1=MouseButtons,MarkupEditor=function(){function t(t,e,i,n,o){this.canvas=t,this.MarkupVirtualPad=i,this.modelViewer=o,this.ctx=t.getContext("2d"),this.markupManager=e,this.setMarkupType("arrow"),this.curIndex=-1,this.editIndex=-1,this.preEdit=-1,this.inEditMode=!1,this.currentGrip=-1,this.bFirstClick=!0,this.firstPos=[],this.touchPos=[],this.device=n,this.hightLightColor="yellow",this.isEndDrawingForRightClick=!0,new TextMarkupTool(this.markupManager).createDiv(TextMarkupTool.divId)}return t.prototype.onDrawing=function(t,e,i){if(this.tool.onDrawing(t,e,this.MarkupVirtualPad,this.curIndex),this.curIndex!=this.highLightId&&this.highLightId>=0&&(this.canvas.style.cursor="",this.highLightId=-1),this.curIndex>=0){if(!(o=t.markupManager.get(this.curIndex)))return;i&&t.markupManager.hitTest(t,i[0],i[1])==this.curIndex&&t.isEnableAnnotationPick&&(this.canvas.style.cursor="pointer",this.highLightId=this.curIndex,t.markupManager.viewer.alwaysMode&&o.draw(t,e,this.MarkupVirtualPad,this.curIndex,!0))}if(this.editIndex>=0){if(t.markupManager.viewer.alwaysMode)return;if(0==t.markupManager.markups.length)return this.editIndex,!1;var n=t.markupManager.getMarkupBbox(t,this.editIndex);if(!n)return;var o,s=[n[0],n[1]],r=[n[2],n[3]],a=(o=t.markupManager.get(this.editIndex)).getGrips(t,this.editIndex),l=t.markupManager.getMarkupCenter(t,this.editIndex);if(!l)return;e.save(),e.translate(l[0],l[1]),"Arrow"!=o.markupType&&e.rotate(o.rotation),e.beginPath(),e.lineWidth="1",e.strokeStyle="red",e.fillStyle="#ffffff";var h=(o.lineWidth||0)/2;4!=a.length&&(t.operationTypes&&!t.operationTypes.includes("Move")&&(e.strokeStyle="#999999"),e.strokeRect(-.5*(r[0]-s[0])-h,-.5*(r[1]-s[1])-h,r[0]-s[0]+2*h,r[1]-s[1]+2*h),e.strokeStyle="red",t.operationTypes&&!t.operationTypes.includes("Rotate")&&(e.strokeStyle="#ffffff",e.fillStyle="#999999"),e.arc(0,s[1]-l[1]-20,6,0,2*Math.PI,!1),e.fill(),e.stroke(),e.closePath(),e.beginPath(),e.arc(0,s[1]-l[1]-20,3,.5*Math.PI,1.8*Math.PI,!1),e.moveTo(3,s[1]-l[1]-21),e.lineTo(.5,s[1]-l[1]-19.5),e.moveTo(3,s[1]-l[1]-21),e.lineTo(3,s[1]-l[1]-24.5),e.stroke()),e.closePath(),e.strokeStyle="red",e.fillStyle="#ffffff";var c=void 0,d=void 0;if("Arrow"==o.markupType){t.operationTypes&&!t.operationTypes.includes("Stretch")&&(e.strokeStyle="#999999");var u=t.markupManager.getMarkupSize(t,this.editIndex),p=Math.sqrt(u[0]*u[0]+u[1]*u[1]),g=u[0]/p*3,m=u[1]/p*3;e.beginPath(),e.arc(a[0]-l[0]+(a[0]<a[2]?-g/2:g/2),a[1]-l[1]+(a[1]<a[3]?-m/2:m/2),4,0,2*Math.PI,!1),e.fill(),e.stroke(),e.closePath(),e.beginPath(),e.arc(a[2]-l[0]+(a[0]<a[2]?g:-g),a[3]-l[1]+(a[1]<a[3]?m:-m),4,0,2*Math.PI,!1),e.fill(),e.stroke(),e.closePath()}else{t.operationTypes&&!t.operationTypes.includes("Rotate")&&(e.strokeStyle="#999999"),e.moveTo(0,s[1]-l[1]),e.lineTo(0,s[1]-l[1]-15),e.stroke();for(var f=0;f<a.length;f+=2){e.beginPath(),t.operationTypes&&!t.operationTypes.includes("Stretch")?e.strokeStyle="#999999":e.strokeStyle="red";var w=[a[f],a[f+1]];if("Text"==o.markupType)c=1,d=1;else{var v=t.worldToClientPoint(o.drawPoints[0]),y=t.worldToClientPoint(o.drawPoints[1]);c=v[0]<y[0]?1:-1,d=v[1]<y[1]?1:-1}switch(f){case 0:e.arc(w[0]-l[0]-h*c,w[1]-l[1]-h*d,4,0,2*Math.PI,!1);break;case 2:e.arc(w[0]-l[0]-h*c,w[1]-l[1],4,0,2*Math.PI,!1);break;case 4:e.arc(w[0]-l[0]-h*c,w[1]-l[1]+h*d,4,0,2*Math.PI,!1);break;case 6:e.arc(w[0]-l[0],w[1]-l[1]+h*d,4,0,2*Math.PI,!1);break;case 8:e.arc(w[0]-l[0]+h*c,w[1]-l[1]+h*d,4,0,2*Math.PI,!1);break;case 10:e.arc(w[0]-l[0]+h*c,w[1]-l[1],4,0,2*Math.PI,!1);break;case 12:e.arc(w[0]-l[0]+h*c,w[1]-l[1]-h*d,4,0,2*Math.PI,!1);break;case 14:e.arc(w[0]-l[0],w[1]-l[1]-h*d,4,0,2*Math.PI,!1)}e.fill(),e.stroke(),e.closePath()}}e.restore(),this.MarkupVirtualPad.drawEdit(s,r,l,o,a,this.editIndex,g,m,h,[c,d])}},t.prototype.canCreateMarkup=function(t){if(-1==this.curIndex)return!0;var e=t.markupManager.get(this.curIndex);if(!e)return!0;var i=e.getGrips(t);return this.editIndex!=this.curIndex&&0!=i.length&&"Text"!=e.markupType},t.prototype.setMarkupType=function(t){if(!MarkupViewer.isMobile||"cloud"!==t&&"polyline"!==t){switch(this.tool&&this.tool.onExit(),this.crtMarkupType=t,this.start=!1,t){case"ellips":this.tool=new EllipsMarkupTool(this.markupManager);break;case"rectangle":this.tool=new RectMarkupTool(this.markupManager);break;case"arrow":this.tool=new ArrowMarkupTool(this.markupManager);break;case"cross":this.tool=new CrossMarkupTool(this.markupManager);break;case"cloud":this.tool=new CloudMarkupTool(this.markupManager);break;case"cloud-rect":this.tool=new CloudRectMarkupTool(this.markupManager);break;case"text":this.tool=new TextMarkupTool(this.markupManager);break;case"polyline":this.tool=new PolylineMarkupTool(this.markupManager);break;default:console.log("Current type is not supported.")}this.tool.redraw=this.redraw.bind(this),this.tool.type=t}},t.prototype.begin=function(t,e,i,n){if(this.modelViewer&&"ViewerDrawing"===this.modelViewer.viewerType&&this.modelViewer.snapIsEnabled){var o=this.modelViewer._drawingViewer.snapToPoint(e,i),s=this.modelViewer._drawingViewer.toScreenPoint([o.GetPoint()[0],o.GetPoint()[1]]);e=s[0],i=s[1]}else this.modelViewer&&"Viewer3D"===this.modelViewer.viewerType&&this.modelViewer.snap&&(e=this.modelViewer.snap.context.hoverPosition.x,i=this.modelViewer.snap.context.hoverPosition.y);this.curIndex=t.markupManager.hitTest(t,e,i,!0);var r=this.MarkupVirtualPad.isEdge(e,i);if(!t.isEnableAnnotationPick||this.curIndex<0&&this.canCreateMarkup(t)&&!r){if(this.editIndex>-1)return this.editIndex=-1,void this.redraw(t);if(n==Mouse$1.LelftButton){if(this.start=!0,this.textMarkupTool)return this.textMarkupTool.initDom(t),this.textMarkupTool=null,void this.redraw(t);this.tool.begin(t,e,i,n)}this.start&&n==Mouse$1.RightButton&&this.tool.begin(t,e,i,n)}this.bFirstClick=!0;var a=this.editIndex;if(this.preEdit=a,this.curIndex>=0){var l=t.markupManager.get(this.curIndex).markupType;if(MarkupViewer.isMobile&&("Cloud"===l||"Polyline"===l))return;if(t.hasOwnProperty("isEnableAnnotationPick")&&!t.isEnableAnnotationPick)return;this.editIndex=this.curIndex,this.inEditMode=!0,this.redraw(t)}else this.editIndex=-1,this.redraw(t);this.editIndex!=a&&t.onSelectChange(this.editIndex)},t.prototype.onEditing=function(t,e,i,n){if(this.start?-1!=this.curIndex&&this.editIndex==this.curIndex||this.tool.onEditing(t,e,i,n):this.tool.onMouseMove(t,e,i,n),this.inEditMode){var o=t.markupManager.hitGrip(t,[e,i],this.editIndex);if(this.bFirstClick){this.firstPos=[e,i],this.bFirstClick=!1,this.currentGrip=o>=0?o:-1;var s=t.markupManager.get(this.editIndex);if(!s)return;return s.originPoints=s.getPoints(),s.originRotation=s.rotation,"Text"==s.markupType&&(this.editIndex==this.preEdit&&s.userText&&s.originUserText&&this.currentGrip<9?s.userText=s.originUserText:-1!=this.currentGrip&&this.currentGrip<9&&(s.originUserText=s.userText)),s.controlPt&&(s.originControlPt=s.controlPt),void(s.editPt&&(s.originEditPt=s.editPt))}var r=[e,i];9==this.currentGrip?t.operationTypes&&t.operationTypes.includes("Rotate")&&(t.markupManager.gripRotate(t,this.editIndex,this.firstPos,r),this.redraw(t,r)):this.currentGrip>=0&&this.currentGrip<9?t.operationTypes&&t.operationTypes.includes("Stretch")&&(t.markupManager.gripDragging(t,this.editIndex,this.currentGrip,this.firstPos,r),this.redraw(t,r)):t.operationTypes&&t.operationTypes.includes("Move")&&(t.markupManager.translatePos(t,this.editIndex,this.firstPos,r),this.redraw(t,r))}else this.bFirstClick=!0,this.currentGrip=-1,this.curIndex=t.markupManager.hitTest(t,e,i),this.redraw(t,[e,i])},t.prototype.end=function(t,e,i,n){if(this.modelViewer&&"ViewerDrawing"===this.modelViewer.viewerType&&this.modelViewer.snapIsEnabled){var o=this.modelViewer._drawingViewer.snapToPoint(e,i),s=this.modelViewer._drawingViewer.toScreenPoint([o.GetPoint()[0],o.GetPoint()[1]]);e=s[0],i=s[1]}else this.modelViewer&&"Viewer3D"===this.modelViewer.viewerType&&this.modelViewer.snap&&(e=this.modelViewer.snap.context.hoverPosition.x,i=this.modelViewer.snap.context.hoverPosition.y);this.onEditing(t,e,i,n),this.start&&(-1!=this.curIndex&&this.editIndex==this.curIndex||Mouse$1.FINISHED==this.tool.end(t,e,i,n)&&(this.start=!1)),this.inEditMode&&(this.inEditMode=!1),this.start=!1},t.prototype.onExit=function(t){this.tool.onExit(t)},t.prototype.onMouseWheel=function(t,e){this.start},t.prototype.onKeyDown=function(t,e){this.editIndex>=0&&("Delete"==e.code||"Backspace"==e.code)&&t.operationTypes&&t.operationTypes.includes("Delete")&&(t.markupManager.remove(this.editIndex),this.curIndex=-1,this.editIndex=-1,this.redraw(t))},t.prototype.onClick=function(t,e){var i=this.formatEventOffset(t,e),n=t.markupManager.hitTest(t,i.x,i.y,!0);if(n>-1){var o=t.markupManager.get(n);if(0==e.button||2==e.button&&this.isEndDrawingForRightClick){var s={click:0==e.button?0:1,clientPosition:{x:e.clientX,y:e.clientY},screenPosition:{x:e.screenX,y:e.screenY},eventType:0==e.button?"Click":"RightClick"};t.onClick(__assign(__assign({},s),o))}}this.isEndDrawingForRightClick=!0},t.prototype.onDoubleClick=function(t,e){var i=this.formatEventOffset(t,e),n=t.markupManager.hitTest(t,i.x,i.y,!0);if(n>-1){var o=t.markupManager.get(n),s={clientPosition:{x:e.clientX,y:e.clientY},screenPosition:{x:e.screenX,y:e.screenY}};t.onDoubleClick(__assign(__assign({},s),o))}t.operationTypes&&t.operationTypes.includes("Edit")&&(this.tool.onDoubleClick&&this.tool.onDoubleClick(t,e),this.editText(t))},t.prototype.onDoubleTouch=function(t,e){t.operationTypes&&t.operationTypes.includes("Edit")&&(this.tool.onDoubleTouch&&this.tool.onDoubleTouch(t,e),this.editText(t))},t.prototype.editText=function(t){if(!(this.curIndex<0||null==this.curIndex)){var e=t.markupManager.get(this.curIndex);if(e){var i=e.getPoints();if("Text"==e.markupType){""!=TextMarkupTool.lastTextareaId&&(this.textMarkupTool?this.textMarkupTool.initDom(t):this.tool.initDom(t));var n=new TextMarkupTool(this.markupManager,e.rotation,i),o=t.worldToClientPoint([i[0][0],i[0][1],i[0][2]]);n.setUserText(e.getPureText()),this.tool.rotation=e.rotation,n.begin(t,o[0],o[1],Mouse$1.LelftButton),n.setEditBox(e.getTextSize()),this.device.isMobileApple||this.device.isPc||setTimeout((function(){n.reposition(t)}),500),t.markupManager.remove(this.curIndex),this.highLightId=-1,this.curIndex=-1,this.editIndex=-1,this.textMarkupTool=n,this.redraw(t)}}}},t.prototype.onMouseDown=function(t,e){2==e.button?(t.startX=null,t.startY=null,this.isEndDrawingForRightClick=!0,(this.tool instanceof PolylineMarkupTool||this.tool instanceof CloudMarkupTool)&&(this.isEndDrawingForRightClick=this.tool.getIsEndDrawing()),this.tool.onMouseRightClick&&this.tool.onMouseRightClick(t,e)):this.begin(t,e.offsetX,e.offsetY,e.buttons)},t.prototype.onMouseMove=function(t,e){var i=this.formatEventOffset(t,e);this.onEditing(t,i.x,i.y,e.buttons)},t.prototype.onMouseUp=function(t,e,i){var n=this.formatEventOffset(t,e);t.markupManager.viewer.alwaysMode&&2==e.button&&(t.markupManager.hitTest(t,n.x,n.y,!0)>-1&&(e.preventDefault(),e.stopPropagation()));if(this.curIndex>=0&&t.markupManager.viewer.alwaysMode){var o=this.markupManager.get(this.curIndex),s=this.markupManager.getHighlightConfig()||{highlightColor:""};o.highlightColor=o.highlightColor?"":s.highlightColor,this.redraw(t)}return this.end(t,n.x,n.y,e.buttons)},t.prototype.onTouchstart=function(t,e){var i=this.formatEventOffset(t,e);this.begin(t,i.x,i.y,1)},t.prototype.onTouchmove=function(t,e){var i=this.formatEventOffset(t,e);this.touchPos=[i.x,i.y],this.onEditing(t,i.x,i.y,1)},t.prototype.onTouchend=function(t,e){return this.end(t,this.touchPos[0],this.touchPos[1],1)},t.prototype.isPanMode=function(t){return t==Mouse$1.MiddleButton||t==Mouse$1.RightButton},t.prototype.formatEventOffset=function(t,e){var i,n,o=this.canvas.getBoundingClientRect();return MarkupViewer.isMobile?(i=e.touches[0].pageX-(o.x||o.left),n=e.touches[0].pageY-(o.y||o.top)):(i=e.clientX-(o.x||o.left),n=e.clientY-(o.y||o.top)),{x:i,y:n}},t.prototype.redraw=function(t,e){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.MarkupVirtualPad.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.MarkupVirtualPad.ctx.fillStyle="rgba(0,0,0,0)",this.MarkupVirtualPad.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.markupManager.draw(t,this.ctx),this.onDrawing(t,this.ctx,e)},t.prototype.getStart=function(){return this.start},t}(),MarkupIO=function(){function t(){}return t.markups2string=function(t){return JSON.stringify(t)},t.string2markups=function(t){var e=JSON.parse(t);return this.transform2markups(e)},t.transform2markups=function(t){for(var e=[],i=0;i<t.length;i++){var n=t[i],o=n.drawPoints,s=n.strokeStyle,r=n.lineWidth,a=n.fillStyle,l=n.close,h=n.userText,c=n.fontSize,d=n.rotation,u=n.fontFamily,p=n.textAreaId,g=n.center,m=n.markupId,f=n.controlPt,w=null;switch(n.markupType){case"Ellipse":w=new EllipsMarkup(o,s,r,d,a);break;case"Rectangle":w=new RectMarkup(o,s,r,d,a);break;case"Arrow":w=new ArrowMarkup(o,s,r);break;case"Cross":w=new CrossMarkup(o,s,r,d);break;case"Cloud":w=new CloudMarkup(o,s,r,f,d,a,l);break;case"CloudRect":w=new CloudRectMarkup(o,s,r,d,a);break;case"Text":if(2==o.length&&"number"==typeof o[0]){if(w=new TextMarkup(o,h,s,c,u,d,p,g,!0),n.pureText){var v=w.getTextSize();w.resizeText(v)}}else w=new TextMarkup(o[0],h,s,c,u,d,p,g);break;case"Polyline":w=new PolylineMarkup(o,s,r,d,a,l);break;default:console.log("Current type is not supported.")}m&&(w.markupId=m),e.push(w)}return e},t}(),MarkupManager=function(){function t(t,e){this.MarkupVirtualPad=t,this.viewer=e,this.markups=[],this.strokeStyle="red",this.lineWidth=3,this.fontSize=14,this.fontFamily="Arial",this.fillStyle="",this.enableFillStyle=!0,this.highlightConfig={hoverColor:"#FFFFFF",highlightColor:"#3DCC93"}}return t.prototype.toString=function(t){return MarkupIO.markups2string(t||this.markups)},t.prototype.fromString=function(t){return MarkupIO.string2markups(t)},t.prototype.add=function(t){t.markupId=Date.now(),this.markups.push(t)},t.prototype.setMarkups=function(t){this.markups=t.slice(),this.viewer.editor.editIndex=-1},t.prototype.clear=function(){this.markups=[],this.viewer.editor.tool.markup&&(this.viewer.editor.tool.markup.setPoints([]),this.viewer.editor.tool.bFirstCloudMarkup=!0)},t.prototype.draw=function(t,e){for(var i=this.markups,n=0,o=i.length;n<o;++n){var s=i[n];e.strokeStyle=s.strokeStyle,e.lineWidth=(MarkupViewer.isMobile,s.lineWidth),e.fillStyle=s.fillStyle,e.fontFamily=s.fontFamily,s.highLight&&(e.strokeStyle=s.highLight,s.highLight=null),s.highlightColor&&(e.strokeStyle=s.highlightColor,e.fillStyle=s.highlightColor),s.draw(t,e,this.MarkupVirtualPad,n)}},t.prototype.getColor=function(){return this.strokeStyle},t.prototype.setColor=function(t){this.strokeStyle=t},t.prototype.setHighlightConfig=function(t){this.highlightConfig=t},t.prototype.getHighlightConfig=function(){return this.highlightConfig},t.prototype.getFillColor=function(){return this.fillStyle},t.prototype.setFillColor=function(t){this.enableFillStyle=!0,t.getRGBA&&(t=t.getRGBA()),this.fillStyle=t},t.prototype.setFillStyleState=function(t){this.enableFillStyle=t},t.prototype.getFillStyleState=function(){return this.enableFillStyle},t.prototype.getLineWidth=function(){return this.lineWidth},t.prototype.setLineWidth=function(t){this.lineWidth=t},t.prototype.getFont=function(){return this.font},t.prototype.getFontSize=function(){return this.fontSize},t.prototype.setFont=function(t){this.font=t},t.prototype.get=function(t){return this.markups[t]},t.prototype.remove=function(t){t<0||this.markups.splice(t,1)},t.prototype.hitTest=function(t,e,i,n){var o=t.isEnableAnnotationPick?this.MarkupVirtualPad.hitTest(e,i):-1;if(null==n||o>=0)return o;o=-1;for(var s=this.markups.length-1;s>=0;s--){var r=this.markups[s];if(0!=r.bNeedHitByBbox&&"rgba(255,255,255,0)"!=r.fillStyle){var a=this.getMarkupBbox(t,s),l=this.getMarkupCenter(t,s),h=MathUtil.rotateAround([e,i],l,-r.rotation);if(1==!(h[0]<a[0]||h[0]>a[2]||h[1]<a[1]||h[1]>a[3])){o=s;break}}}return o},t.prototype.getMarkupBbox=function(t,e){var i=this.markups[e];if(!(e<0)&&i){var n=[Number.MAX_VALUE,Number.MAX_VALUE],o=[-Number.MAX_VALUE,-Number.MAX_VALUE],s=i.getPoints();if("Text"==i.markupType)return i.getTextBbox(t);i.editPt?s=s.concat(i.editPt):i.controlPt&&(s=s.concat(i.controlPt));for(var r=0;r<s.length;r++){var a=t.worldToClientPoint(s[r]);a[0]<n[0]&&(n[0]=a[0]),a[1]<n[1]&&(n[1]=a[1]),a[0]>o[0]&&(o[0]=a[0]),a[1]>o[1]&&(o[1]=a[1])}return n.concat(o)}},t.prototype.getMarkupCenter=function(t,e){var i=this.getMarkupBbox(t,e);if(i)return[(i[0]+i[2])/2,(i[1]+i[3])/2]},t.prototype.setFontSize=function(t){this.fontSize=t},t.prototype.getMarkupSize=function(t,e){var i=this.getMarkupBbox(t,e);return[Math.abs(i[2]-i[0]),Math.abs(i[3]-i[1])]},t.prototype.getFontFamily=function(){return this.fontFamily},t.prototype.setFontFamily=function(t){this.fontFamily=t},t.prototype.translatePos=function(t,e,i,n){var o=this.markups[e];if(o.setPoints(o.originPoints),o.editPt&&(o.editPt=o.originEditPt),o.controlPt&&(o.controlPt=o.originControlPt),this.getMarkupCenter(t,e)){for(var s=n[0]-i[0],r=n[1]-i[1],a=o.originPoints,l=[],h=[],c=0;c<a.length;c++)h[c]=t.worldToClientPoint(a[c]),h[c][0]+=s,h[c][1]+=r,l[c]=t.clientToWorldPoint(h[c]);if(o.setPoints(l),"Cloud"==o.markupType){var d=(o.editPt&&o.originEditPt||o.controlPt&&o.originControlPt).slice();if(d){var u=[];for(c=0;c<d.length;c++)u[c]=t.worldToClientPoint(d[c]),u[c][0]+=s,u[c][1]+=r,d[c]=t.clientToWorldPoint(u[c]);o.editPt?o.editPt=d:o.controlPt=d}}}},t.prototype.isPointInCircle=function(t,e,i){return MathUtil.distanceByArr(t,e)<=i},t.prototype.hitGrip=function(t,e,i){return this.MarkupVirtualPad.hitGrip(e[0],e[1])},t.prototype.getX=function(t,e,i,n){return(n-e)/i+t},t.prototype.getY=function(t,e,i,n){return(n-t)*i+e},t.prototype.gripRotate=function(t,e,i,n){var o=this.markups[e];o.rotation=o.originRotation;var s=this.getMarkupCenter(t,e),r=Math.sqrt(Math.pow(i[0]-s[0],2)+Math.pow(i[1]-s[1],2)),a=Math.sqrt(Math.pow(n[0]-s[0],2)+Math.pow(n[1]-s[1],2)),l=Math.sqrt(Math.pow(n[0]-i[0],2)+Math.pow(n[1]-i[1],2)),h=(l*l-r*r-a*a)/(-2*r*a),c=Math.acos(h),d=(i[1]-s[1])/(i[0]-s[0]),u=this.getY(i[0],i[1],d,n[0]),p=this.getX(i[0],i[1],d,n[1]);i[0]>s[0]&&i[1]<s[1]?n[0]<p&&n[1]<u&&(c=2*Math.PI-c):i[0]>s[0]&&i[1]>s[1]?n[0]>p&&n[1]<u&&(c=2*Math.PI-c):i[0]<s[0]&&i[1]>s[1]?n[0]>p&&n[1]>u&&(c=2*Math.PI-c):i[0]<s[0]&&i[1]<s[1]&&n[0]<p&&n[1]>u&&(c=2*Math.PI-c),o.rotation=o.originRotation+c},t.prototype.rotateTransform=function(t,e,i,n,o){i=-(i%=2*Math.PI);var s,r,a=Math.sin(i),l=Math.cos(i),h=(s=n-t)*a+(r=o-e)*l;return[s=s*l-r*a+t,r=h+e]},t.prototype.gripDragging=function(t,e,i,n,o){var s=this.markups[e],r=s.originPoints;s.setPoints(r),s.originUserText&&(s.userText=s.originUserText);var a=s.getGrips(t,e),l=this.getMarkupSize(t,e),h=l.slice(),c=this.getMarkupCenter(t,e),d=c.slice();if("Arrow"==s.markupType){var u=o[0]-n[0],p=o[1]-n[1],g=t.worldToClientPoint(r[0]),m=t.worldToClientPoint(r[1]);switch(i){case 0:g[0]+=u,g[1]+=p;break;case 4:m[0]+=u,m[1]+=p;break;default:console.log("default grip id."+i)}return g=t.clientToWorldPoint(g),m=t.clientToWorldPoint(m),void s.setPoints([g,m])}var f=this.rotateTransform(n[0],n[1],s.rotation,o[0],o[1]),w=f[0]-n[0],v=f[1]-n[1];switch(i){case 0:d[0]+=.5*w*Math.cos(s.rotation),d[1]+=.5*w*Math.sin(s.rotation),d[0]-=.5*v*Math.sin(s.rotation),d[1]+=.5*v*Math.cos(s.rotation),h[1]-=v,h[0]-=w;break;case 1:d[0]+=.5*w*Math.cos(s.rotation),d[1]+=.5*w*Math.sin(s.rotation),h[0]-=w;break;case 2:d[0]+=.5*w*Math.cos(s.rotation),d[1]+=.5*w*Math.sin(s.rotation),d[0]-=.5*v*Math.sin(s.rotation),d[1]+=.5*v*Math.cos(s.rotation),h[1]+=v,h[0]-=w;break;case 3:d[0]-=.5*v*Math.sin(s.rotation),d[1]+=.5*v*Math.cos(s.rotation),h[1]+=v;break;case 4:d[0]+=.5*w*Math.cos(s.rotation),d[1]+=.5*w*Math.sin(s.rotation),d[0]-=.5*v*Math.sin(s.rotation),d[1]+=.5*v*Math.cos(s.rotation),h[0]+=w,h[1]+=v;break;case 5:d[0]+=.5*w*Math.cos(s.rotation),d[1]+=.5*w*Math.sin(s.rotation),h[0]+=w;break;case 6:d[0]+=.5*w*Math.cos(s.rotation),d[1]+=.5*w*Math.sin(s.rotation),d[0]-=.5*v*Math.sin(s.rotation),d[1]+=.5*v*Math.cos(s.rotation),h[1]-=v,h[0]+=w;break;case 7:d[0]-=.5*v*Math.sin(s.rotation),d[1]+=.5*v*Math.cos(s.rotation),h[1]-=v}if("Cloud"!=s.markupType&&"Polyline"!=s.markupType){var y=[d[0]-.5*h[0],d[1]-.5*h[1]],b=[d[0]+.5*h[0],d[1]+.5*h[1]];"Text"==s.markupType&&s.resizeText(h),y=t.clientToWorldPoint(y),b=t.clientToWorldPoint(b),s.setPoints([y,b])}else this.draggingMultipleGrip(t,s,i,n,o,w,v,a,l,h,c,d)},t.prototype.draggingMultipleGrip=function(t,e,i,n,o,s,r,a,l,h,c,d){var u=e.originPoints.slice(),p=c[0]-l[0]/2,g=c[1]-l[1]/2,m=d[0]-h[0]/2,f=d[1]-h[1]/2,w=function(e){for(var i=0;i<e.length;i++){var n=t.worldToClientPoint(e[i]),o=n[0],s=n[1],r=o-p,a=s-g;n[0]=r/l[0]*h[0]+m,n[1]=a/l[1]*h[1]+f,e[i]=t.clientToWorldPoint(n)}return e},v=w(u);if(e.setPoints(v),"Cloud"==e.markupType){var y=(e.originEditPt||e.originControlPt).slice();e.editPt=w(y)}},t}(),MarkupVirtualPad=function(){function t(t,e,i){this.isMobile=i,this.canvas=document.createElement("canvas"),this.viewer=t,this.canvas.id="markupVirtual",this.canvas.width=e.clientWidth,this.canvas.height=e.clientHeight,document.body.appendChild(this.canvas),this.canvas.style.display="none",this.ctx=this.canvas.getContext("2d"),this.lineWidth=MarkupViewer.isMobile?18:2}return t.prototype.init=function(t,e){var i=this.ctx;i.save(),i.translate(t[0],t[1]),i.rotate(e),i.beginPath()},t.prototype.drawEdit=function(t,e,i,n,o,s,r,a,l,h){var c=this.ctx;if(c.save(),c.translate(i[0],i[1]),"Arrow"!=n.markupType&&c.rotate(n.rotation),c.beginPath(),c.lineWidth=n.lineWidth+2,c.fillStyle="rgba("+(2*s+2)+",255,255,1)",c.fillRect(-.5*(e[0]-t[0]),-.5*(e[1]-t[1]),e[0]-t[0],e[1]-t[1]),c.fillStyle=c.strokeStyle="rgba("+(2*s+2)+",100,255,1)",c.arc(0,t[1]-i[1]-20,13,0,2*Math.PI,!1),c.fill(),"Arrow"==n.markupType)c.fillStyle=c.strokeStyle="rgba("+(2*s+2)+",110,255,1)",c.beginPath(),c.arc(o[0]-i[0]+(o[0]<o[2]?-r/2:r/2),o[1]-i[1]+(o[1]<o[3]?-a/2:a/2),10,0,2*Math.PI,!1),c.fill(),c.stroke(),c.closePath(),c.fillStyle=c.strokeStyle="rgba("+(2*s+2)+",150,255,1)",c.beginPath(),c.arc(o[2]-i[0]+(o[0]<o[2]?r:-r),o[3]-i[1]+(o[1]<o[3]?a:-a),10,0,2*Math.PI,!1),c.fill(),c.stroke(),c.closePath();else for(var d=h[0],u=h[1],p=0;p<o.length;p+=2){c.fillStyle=c.strokeStyle="rgba("+(2*s+2)+","+(5*p+110)+",255,1)",c.beginPath();var g=[o[p],o[p+1]],m=this.isMobile?6:3;switch(p){case 0:c.arc(g[0]-i[0]-l*d,g[1]-i[1]-l*u,m,0,2*Math.PI,!1);break;case 2:c.arc(g[0]-i[0]-l*d,g[1]-i[1],m,0,2*Math.PI,!1);break;case 4:c.arc(g[0]-i[0]-l*d,g[1]-i[1]+l*u,m,0,2*Math.PI,!1);break;case 6:c.arc(g[0]-i[0],g[1]-i[1]+l*u,m,0,2*Math.PI,!1);break;case 8:c.arc(g[0]-i[0]+l*d,g[1]-i[1]+l*u,m,0,2*Math.PI,!1);break;case 10:c.arc(g[0]-i[0]+l*d,g[1]-i[1],m,0,2*Math.PI,!1);break;case 12:c.arc(g[0]-i[0]+l*d,g[1]-i[1]-l*u,m,0,2*Math.PI,!1);break;case 14:c.arc(g[0]-i[0],g[1]-i[1]-l*u,m,0,2*Math.PI,!1)}c.fill(),c.stroke(),c.closePath()}c.restore()},t.prototype.drawArrow=function(t,e,i,n,o,s,r,a,l,h,c,d,u,p){var g=e-s,m=i-r,f=this.ctx;f.save(),f.lineWidth=MarkupViewer.isMobile?18:t.lineWidth+this.lineWidth,f.strokeStyle="rgba("+(2*d+2)+",20,20,1)",f.fillStyle="rgba("+(2*d+2)+",20,255,1)",f.beginPath(),f.moveTo(e,i),f.lineTo(n,o),g=n+s,m=o+r,f.moveTo(g,m),f.lineTo(n,o),g=n+a,m=o+l,f.lineTo(g,m),f.stroke(),f.restore()},t.prototype.drawRect=function(t,e,i,n,o,s){var r=this.ctx;r.save(),r.translate(n[0],n[1]),r.rotate(o),r.beginPath(),r.lineWidth=MarkupViewer.isMobile?18:t.lineWidth+this.lineWidth,r.strokeStyle="rgba("+(2*s+2)+",10,10,1)",r.fillStyle="rgba("+(2*s+2)+",10,255,1)",r.rect(-.5*(i[0]-e[0]),-.5*(i[1]-e[1]),i[0]-e[0],i[1]-e[1]),r.closePath(),r.stroke(),r.restore()},t.prototype.drawCross=function(t,e,i,n,o){var s=this.ctx;s.save(),s.translate(i[0],i[1]),s.rotate(n),s.strokeStyle="rgba("+(2*o+2)+",30,30,1)",s.fillStyle="rgba("+(2*o+2)+",30,255,1)",s.beginPath(),s.moveTo(-.5*(e[0]-t[0]),-.5*(e[1]-t[1])),s.lineTo(.5*(e[0]-t[0]),.5*(e[1]-t[1])),s.moveTo(-.5*(e[0]-t[0]),.5*(e[1]-t[1])),s.lineTo(.5*(e[0]-t[0]),-.5*(e[1]-t[1])),s.stroke(),s.restore()},t.prototype.drawCloudRect=function(t,e,i,n,o){var s=this.ctx;s.moveTo(t,e),s.quadraticCurveTo(i[0],i[1],n[0],n[1])},t.prototype.drawEllips=function(t,e,i,n,o,s,r){var a=this.ctx;a.save(),a.strokeStyle="rgba("+(2*o+2)+",50,50,1)",a.fillStyle="rgba("+(2*o+2)+",50,255,1)",a.translate(i[0],i[1]),a.rotate(n),a.beginPath(),a.ellipse(0,0,s,r,0,0,2*Math.PI),a.closePath(),a.stroke(),a.restore()},t.prototype.drawPolyline=function(t,e,i,n,o){var s=this.ctx;s.strokeStyle="rgba("+(2*o+2)+",70,70,1)",s.moveTo(t[0]-i[0],t[1]-i[1]),s.lineTo(e[0]-i[0],e[1]-i[1]),s.stroke()},t.prototype.isEdge=function(t,e){var i=this.ctx.getImageData(t,e,1,1).data,n=i[0],o=i[1],s=i[2],r=i[3];return s==o&&o<100&&s%10==0&&n>=2&&255==r},t.prototype.hitTest=function(t,e){var i=this.ctx.getImageData(t,e,1,1).data,n=i[0],o=i[1],s=i[2],r=i[3];return n+o+s<3?-1:s==o&&o<100&&s%10==0&&n>=2&&255==r||255==s&&o>99?(n-2)/2:void 0},t.prototype.hitGrip=function(t,e){var i=this.ctx.getImageData(t,e,1,1).data,n=i[0],o=i[1],s=i[2];if(n+o+s+i[3]<3)return-1;if(255==s){if(100==o)return 9;if(255==o)return 10;if(o>100)return(o-110)/10}return-1},t}(),Mouse=MouseButtons,MarkupViewer=function(){function t(e,i){var n=this;this.getDevice=function(){var t=navigator.userAgent,e=/(?:Windows Phone)/.test(t),i=/(?:SymbianOS)/.test(t)||e,n=/(?:Android)/.test(t),o=/(?:Firefox)/.test(t),s=(/(?:Chrome|CriOS)/.test(t),/(?:iPad|PlayBook)/.test(t)||n&&!/(?:Mobile)/.test(t)||o&&/(?:Tablet)/.test(t));return{isPc:!(/(?:iPhone)/.test(t)&&!s||n||i||s),isMobileApple:/(?:iPhone|iPad)/.test(t)}},this.work=!1,this.alwaysMode=!1,this.restoreState=!1,this.firstTouch=0,this.modelViewer=e,this.canvas=document.createElement("canvas"),this.canvas.id="markup",this.canvas.style.zIndex=10,this.canvas.width=i.clientWidth,this.canvas.height=i.clientHeight,this.canvas.style.position="absolute",this.canvas.style.top="0",this.canvas.style.left="0",this.ctx=this.canvas.getContext("2d"),this.wrapDom=i,this.canvas.style.display="none",t.isMobile=!this.getDevice().isPc,i.appendChild(this.canvas),this.bindEvent();var o=this;this.viewer=e.getViewer?e.getViewer():e,this.viewer.wrapDom=i,this.MarkupVirtualPad=new MarkupVirtualPad(this.viewer,i,t.isMobile),this.viewer.markupManager=this.markupManager=new MarkupManager(this.MarkupVirtualPad,this),this.editor=this.viewer.markupEditor=new MarkupEditor(this.canvas,this.markupManager,this.MarkupVirtualPad,this.getDevice(),this.modelViewer),this.editor.markupManager=this.viewer.markupManager,this.viewer.onSelectChange=function(t){},this.viewer.onClick=function(t){},this.viewer.itemCompleted=function(t){},this.viewer.onDoubleClick=function(t){},this.viewer.isEnableAnnotationPick=!0,this.viewer.operationTypes=["Delete","Edit","Move","Rotate","Stretch"],this.initOnresize=window.onresize,window.onresize=function(){o.canvas.width=i.clientWidth,o.canvas.height=i.clientHeight,o.MarkupVirtualPad.canvas.width=i.clientWidth,o.MarkupVirtualPad.canvas.height=i.clientHeight,o.modelViewer.resize(),o.update(),"[object Function]"===toString.call(o.initOnresize)&&o.initOnresize()},t.isMobile&&(this.offsetHeight=this.wrapDom.offsetHeight,setInterval((function(){var t=n.wrapDom.offsetHeight;n.offsetHeight!=t&&(n.offsetHeight=t,n.resize())}),500))}return t.prototype.resize=function(){this.editor.tool.reposition&&this.editor.tool.reposition(this.viewer)},t.prototype.getContainerSize=function(){return this.wrapDom.getBoundingClientRect()},t.prototype.hideCanvas=function(){this.canvas.style.display="none"},t.prototype.showCanvas=function(){this.canvas.style.display="block"},t.prototype.startDrawing=function(){this.work=!0,this.alwaysMode=!1,this.showCanvas()},t.prototype.switchMode=function(){},t.prototype.initStyle=function(){var t=this.viewer.markupManager;t.markups=[],t.strokeStyle="red",t.lineWidth=3,t.fontSize=14,t.fontFamily="Arial",t.fillStyle="white",t.enableFillStyle=!1},t.prototype.update=function(){this.editor.redraw(this.viewer)},t.prototype.bindEvent=function(){this.getDevice().isPc?(this.wrapDom.addEventListener("dblclick",this.onDoubleClick.bind(this),!1),this.wrapDom.addEventListener("mousedown",this.onMouseDown.bind(this),!0),"ViewerDrawing"===this.modelViewer.getViewerType()?this.wrapDom.parentElement.parentElement.addEventListener("mouseup",this.onMouseUp.bind(this),!0):this.wrapDom.addEventListener("mouseup",this.onMouseUp.bind(this),!1),this.wrapDom.addEventListener("mousemove",this.onMouseMove.bind(this),!1),this.wrapDom.addEventListener("mousewheel",this.onMouseWheel.bind(this),!1),this.wrapDom.addEventListener("DOMMouseScroll",this.onMouseWheel.bind(this),!1),this.wrapDom.addEventListener("contextmenu",this.oncontextmenu.bind(this),!1)):(this.wrapDom.addEventListener("touchstart",this.onTouchstart.bind(this),!0),this.wrapDom.addEventListener("touchend",this.onTouchend.bind(this),!0),this.wrapDom.addEventListener("touchmove",this.onTouchmove.bind(this),!0)),document.addEventListener("keydown",this.onKeyDown.bind(this)),document.addEventListener("keyup",this.onKeyUp.bind(this))},t.prototype.endDrawing=function(){this.work=!1,this.clearAnnotations(),this.editor.redraw(this.viewer),this.hideCanvas(),this.switchMode(),this.restoreState=!1;var t=document.querySelector("#bf-drawing-textEditor");if(t){var e=t.querySelectorAll("textarea");e.length&&(e[e.length-1].style.display="none",e[e.length-1].value="")}},t.prototype.clearAnnotations=function(){this.markupManager.clear(),this.update()},t.prototype.removeSelectedAnnotation=function(){-1!=this.editor.editIndex&&(this.markupManager.remove(this.editor.editIndex),this.editor.editIndex=-1,this.update())},t.prototype.createSnapshot=function(t){},t.prototype.showAnnotation=function(){},t.prototype.setAnnotationType=function(t){this.editor.setMarkupType(t),this.editor.tool.redraw&&this.editor.tool.redraw(this.viewer)},t.prototype.setAnnotationStyle=function(t){t["stroke-color"]&&this.markupManager.setColor(t["stroke-color"]),t["font-size"]&&this.markupManager.setFontSize(t["font-size"]),t["stroke-width"]&&this.markupManager.setLineWidth(t["stroke-width"]),t["fill-color"]&&this.markupManager.setFillColor(t["fill-color"]),t["font-family"]&&this.markupManager.setFontFamily(t["font-family"])},t.prototype.getAnnotationList=function(){return this.markupManager.markups.slice()},t.prototype.setAnnotationList=function(t){var e=t[0];if(!e)return this.clearAnnotations();if(e.drawPoints&&"number"==typeof e.drawPoints[0])for(var i=0;i<t.length;i++){for(var n=t[i].drawPoints,o=[],s=0;s<n.length;s+=2)o.push([n[s],n[s+1]]);t[i].drawPoints=o}e&&e.draw||(t=MarkupIO.transform2markups(t)),this.markupManager.setMarkups(t),this.restoreState=!0,this.showCanvas(),this.update()},t.prototype.editAnnotationEnd=function(){this.endDrawing()},t.prototype.getCurrentState=function(){return{annotationList:this.getAnnotationList(),state:this.modelViewer.getCurrentState()}},t.prototype.transform=function(t){return t},t.prototype.setState=function(t){var e=this;this.clearAnnotations(),this.modelViewer.setState(t.state),setTimeout((function(){if("string"==typeof t.annotationList){var i=e.markupManager.fromString(t.annotationList);e.setAnnotationList(i)}else t.annotationList[0].id?e.setAnnotationList(e.transform(t.annotationList)):e.setAnnotationList(t.annotationList)}),1500)},t.prototype.oncontextmenu=function(t){t.preventDefault()},t.prototype.onDoubleClick=function(t){if(clearTimeout(this.clickStore),this.alwaysMode)return t.preventDefault(),void this.editor.onDoubleClick(this.viewer,t);!this.work&&this.restoreState&&(this.restoreState=!1,this.endDrawing()),t.preventDefault(),this.editor.onDoubleClick(this.viewer,t)},t.prototype.onMouseDown=function(t){this.mouseDownClientX=t.clientX,this.mouseDownClientY=t.clientY,this.alwaysMode||(!this.work&&this.restoreState&&(this.restoreState=!1,this.endDrawing()),this.work&&t.target==this.canvas&&(t.preventDefault(),t.buttons==Mouse.LelftButton?(t.stopPropagation(),this.editor.onMouseDown(this.viewer,t)):this.editor.onMouseDown(this.viewer,t)))},t.prototype.onTouchstart=function(t){if(!this.alwaysMode&&"CANVAS"==t.target.tagName.toUpperCase()){var e=Date.now();e-this.firstTouch<500?this.editor.onDoubleTouch(this.viewer,t):(this.firstTouch=e,!this.work&&this.restoreState&&(this.restoreState=!1,this.endDrawing()),this.work&&t.target==this.canvas&&(t.preventDefault(),t.buttons==Mouse.LelftButton&&t.stopPropagation(),this.editor.onTouchstart(this.viewer,t),this.containerSize=this.getContainerSize()))}},t.prototype.onMouseMove=function(t){if(this.alwaysMode)return this.update(),void this.editor.onMouseMove(this.viewer,t);this.work&&("Viewer3D"===this.modelViewer.viewerType&&this.modelViewer.snap||"ViewerDrawing"===this.modelViewer.viewerType&&this.modelViewer.snapIsEnabled||(t.preventDefault(),t.stopPropagation()),this.editor.onMouseMove(this.viewer,t))},t.prototype.onTouchmove=function(t){if(this.alwaysMode||"CANVAS"!=t.target.tagName.toUpperCase())return this.update(),void this.editor.onMouseMove(this.viewer,t);if(this.work){var e=t.touches[0],i=this.containerSize,n=i.left,o=i.top,s=i.width,r=i.height;t.preventDefault(),t.stopPropagation(),e.pageX>n&&e.pageX<n+s&&e.pageY>o&&e.pageY<o+r&&this.editor.onTouchmove(this.viewer,t)}},t.prototype.onTouchend=function(t){this.alwaysMode||"CANVAS"!=t.target.tagName.toUpperCase()?this.update():(!this.work&&this.restoreState&&(this.restoreState=!1,this.endDrawing()),this.work&&(t.preventDefault(),t.stopPropagation(),this.editor.onTouchend(this.viewer,t)))},t.prototype.onMouseWheel=function(t){this.alwaysMode||(!this.work&&this.restoreState&&(this.restoreState=!1,this.endDrawing()),this.work&&(t.preventDefault(),t.stopPropagation(),this.editor.onMouseWheel(this.viewer,t)))},t.prototype.onMouseUp=function(t){var e=this;clearTimeout(this.clickStore),this.mouseDownClientX!==t.clientX||this.mouseDownClientY!==t.clientY||this.editor.getStart()||(this.clickStore=setTimeout((function(){e.editor.onClick(e.viewer,t)}),500)),this.alwaysMode||t.button==Mouse.FINISHED?this.editor.onMouseUp(this.viewer,t,!0):(!this.work&&this.restoreState&&(this.restoreState=!1,this.endDrawing()),this.work&&(t.preventDefault(),t.stopPropagation(),this.editor.onMouseUp(this.viewer,t,!0)))},t.prototype.onKeyDown=function(t){this.work&&("textarea"!=document.activeElement.tagName.toLowerCase()&&t.stopPropagation(),this.editor.onKeyDown(this.viewer,t))},t.prototype.onKeyUp=function(t){this.work&&"textarea"!=document.activeElement.tagName.toLowerCase()&&(t.preventDefault(),t.stopPropagation())},t}(),MarkupDrawing=function(t){function e(e,i){var n=t.call(this,e,i)||this;return n.modelViewer.addEventListener("Rendered",(function(){n.update()})),n.viewer.clientToWorldPoint=function(t){return n.viewer.toWorldPoint(t)},n.viewer.worldToClientPoint=function(t){return t?n.viewer.toScreenPoint([t[0],t[1]]):[]},n.isLock=!1,n}return __extends$3(e,t),e.prototype.getCurrentState=function(){return{annotationList:this.getAnnotationList(),state:JSON.parse(this.modelViewer.getCurrentState())}},e.prototype.startDrawing=function(){this.isLock||(this.canvas.style.zIndex=10,this.work=!0,this.alwaysMode=!1,this.showCanvas(),this.switchMode())},e.prototype.onTouchstart=function(t){if(!this.alwaysMode&&!this.isLock){var e=Date.now();e-this.firstTouch<500?this.editor.onDoubleTouch(this.viewer,t):(this.firstTouch=e,!this.work&&this.restoreState&&(this.restoreState=!1,this.endDrawing()),this.work&&t.target==this.canvas&&t.touches.length<2&&(t.preventDefault(),this.editor.onTouchstart(this.viewer,t),this.containerSize=this.getContainerSize()))}},e.prototype.onTouchmove=function(t){if(this.alwaysMode||this.isLock)this.update();else if(this.work){var e=t.touches[0],i=this.containerSize,n=i.left,o=i.top,s=i.width,r=i.height;t.touches.length<2?(t.preventDefault(),t.stopPropagation(),e.pageX>n&&e.pageX<n+s&&e.pageY>o&&e.pageY<o+r&&this.editor.onTouchmove(this.viewer,t)):this.update()}},e.prototype.showAnnotation=function(){this.alwaysMode=!0,this.canvas.style.zIndex=5,this.editor.editIndex=-1,this.update(),this.showCanvas()},e.prototype.hideAnnotation=function(){this.hideCanvas()},e.prototype.setState=function(t){if("string"!=typeof t.state&&(t.state=JSON.stringify(t.state)),this.modelViewer.setState(t.state),"string"==typeof t.annotationList){var e=this.markupManager.fromString(t.annotationList);this.setAnnotationList(e)}else t.annotationList[0].id?this.setAnnotationList(this.transform(t.annotationList)):this.setAnnotationList(t.annotationList)},e.prototype.onMouseWheel=function(t){this.alwaysMode?this.update():(!this.work&&this.restoreState&&(this.restoreState=!1,this.endDrawing()),this.work&&(t.preventDefault(),this.update(),this.editor.onMouseWheel(this.viewer,t)))},e.prototype.createSnapshot=function(t){var e=this.viewer.snapshotPure(),i=document.createElement("canvas");i.width=this.wrapDom.clientWidth,i.height=this.wrapDom.clientHeight;var n=i.getContext("2d");n.beginPath(),n.fillStyle=this.wrapDom.style.background,n.fillRect(0,0,i.width,i.height),n.drawImage(e,0,0),n.drawImage(this.canvas,0,0),t(i.toDataURL())},e.prototype.switchMode=function(){},e.prototype.lockAnnotationAction=function(){this.isLock=!0,this.alwaysMode=!0,document.getElementById(TextMarkupTool.lastTextareaId)&&this.editor.tool.onExit(),this.editor.tool.markup=null,this.editor.tool.bFirstCloudMarkup=!0,this.editor.tool.redraw&&this.editor.tool.redraw(this.viewer)},e.prototype.restoreAnnotationAction=function(){this.isLock=!1,this.alwaysMode=!1,this.editor.tool.redraw&&this.editor.tool.redraw(this.viewer),this.startDrawing()},e.prototype.highlightAnnotationByIds=function(t){var e=this,i=this.getAnnotationList();if(t&&i.length&&t.length){Array.isArray(t)||(t=[t]);var n=null;t.forEach((function(t){(n=i.find((function(e){return e.markupId==t})))&&(n.highlightColor=e.markupManager.highlightConfig.highlightColor)})),this.setAnnotationList(i),this.editor.tool.redraw&&this.editor.tool.redraw(this.viewer)}},e.prototype.clearHighlight=function(){var t=this.getAnnotationList();t.length&&(t.map((function(t){t.highlightColor=""})),this.editor.tool.redraw&&this.editor.tool.redraw(this.viewer))},e.prototype.setHighlightConfig=function(t){this.markupManager.highlightConfig=t},e}(MarkupViewer),MarkupPDF=function(t){function e(e,i){var n=t.call(this,e,i)||this;return n.modelViewer.addEventListener("Rendered",(function(){n.update()})),n.viewer.clientToWorldPoint=function(t){return n.viewer.views[n.modelViewer._defaultViewId].toWorldPoint(t)},n.viewer.worldToClientPoint=function(t){return t?n.viewer.views[n.modelViewer._defaultViewId].toScreenPoint([t[0],t[1]]):[]},n}return __extends$3(e,t),e.prototype.getCurrentState=function(){return{annotationList:this.getAnnotationList(),state:JSON.parse(this.modelViewer.getCurrentState())}},e.prototype.startDrawing=function(){this.canvas.style.zIndex=10,this.work=!0,this.alwaysMode=!1,this.showCanvas(),this.switchMode()},e.prototype.onTouchstart=function(t){if(!this.alwaysMode){var e=Date.now();e-this.firstTouch<500?this.editor.onDoubleTouch(this.viewer,t):(this.firstTouch=e,!this.work&&this.restoreState&&(this.restoreState=!1,this.endDrawing()),this.work&&t.target==this.canvas&&t.touches.length<2&&(t.preventDefault(),this.editor.onTouchstart(this.viewer,t),this.containerSize=this.getContainerSize()))}},e.prototype.onTouchmove=function(t){if(this.alwaysMode)this.update();else if(this.work){var e=t.touches[0],i=this.containerSize,n=i.left,o=i.top,s=i.width,r=i.height;t.touches.length<2?(t.preventDefault(),t.stopPropagation(),e.pageX>n&&e.pageX<n+s&&e.pageY>o&&e.pageY<o+r&&this.editor.onTouchmove(this.viewer,t)):this.update()}},e.prototype.showAnnotation=function(){this.alwaysMode=!0,this.canvas.style.zIndex=5,this.editor.editIndex=-1,this.update(),this.showCanvas()},e.prototype.hideAnnotation=function(){this.hideCanvas()},e.prototype.setState=function(t){if("string"!=typeof t.state&&(t.state=JSON.stringify(t.state)),this.modelViewer.setState(t.state),"string"==typeof t.annotationList){var e=this.markupManager.fromString(t.annotationList);this.setAnnotationList(e)}else t.annotationList[0].id?this.setAnnotationList(this.transform(t.annotationList)):this.setAnnotationList(t.annotationList)},e.prototype.onMouseWheel=function(t){this.alwaysMode?this.update():(!this.work&&this.restoreState&&(this.restoreState=!1,this.endDrawing()),this.work&&(t.preventDefault(),this.update(),this.editor.onMouseWheel(this.viewer,t)))},e.prototype.createSnapshot=function(t){var e=document.createElement("canvas");e.width=this.canvas.clientWidth,e.height=this.canvas.clientHeight;var i=e.getContext("2d");i.beginPath(),i.drawImage(this.canvas,0,0);var n=this;n.viewer.views[n.modelViewer._defaultViewId].snapshotPure().then((function(i){var o=document.createElement("canvas");o.width=n.wrapDom.clientWidth,o.height=n.wrapDom.clientHeight;var s=o.getContext("2d");s.beginPath(),s.fillStyle=n.wrapDom.style.background,s.fillRect(0,0,o.width,o.height),s.drawImage(i,0,0),s.drawImage(e,0,0),t(o.toDataURL())}))},e.prototype.switchMode=function(){},e.prototype.highlightAnnotationByIds=function(t){var e=this,i=this.getAnnotationList();if(t&&i.length&&t.length){Array.isArray(t)||(t=[t]);var n=null;t.forEach((function(t){(n=i.find((function(e){return e.markupId==t})))&&(n.highlightColor=e.markupManager.highlightConfig.highlightColor)})),this.setAnnotationList(i),this.editor.tool.redraw&&this.editor.tool.redraw(this.viewer)}},e.prototype.clearHighlight=function(){var t=this.getAnnotationList();t.length&&(t.map((function(t){t.highlightColor=""})),this.editor.tool.redraw&&this.editor.tool.redraw(this.viewer))},e.prototype.setHighlightConfig=function(t){this.markupManager.highlightConfig=t},e}(MarkupViewer),MarkupViewer3D=function(t){function e(e,i){var n=t.call(this,e,i)||this;return n.cameraControl=n.viewer.cameraControl,n.viewBox={width:1e3,height:1e3},n.viewer.clientToWorldPoint=function(t){var e={x:t[0],y:t[1],z:0},i=n.viewer.canvasToWorld(e);return[i.x,i.y,i.z]},n.viewer.worldToClientPoint=function(t){var e={x:t[0],y:t[1],z:t[2]||0},i=n.viewer.worldToCanvas(e);return[i.x,i.y]},n}return __extends$3(e,t),e.prototype.bindEvent=function(){this.getDevice().isPc?(this.wrapDom.addEventListener("dblclick",this.onDoubleClick.bind(this),!0),this.wrapDom.addEventListener("mousedown",this.onMouseDown.bind(this),!0),this.wrapDom.addEventListener("mouseup",this.onMouseUp.bind(this),!0),this.wrapDom.addEventListener("mousemove",this.onMouseMove.bind(this),!0),this.wrapDom.addEventListener("mousewheel",this.onMouseWheel.bind(this),!0),this.wrapDom.addEventListener("DOMMouseScroll",this.onMouseWheel.bind(this),!0),this.wrapDom.addEventListener("contextmenu",this.oncontextmenu.bind(this),!0),document.addEventListener("keydown",this.onKeyDown.bind(this),!0),document.addEventListener("keyup",this.onKeyUp.bind(this),!0)):(this.wrapDom.addEventListener("touchstart",this.onTouchstart.bind(this),!0),this.wrapDom.addEventListener("touchend",this.onTouchend.bind(this),!0),this.wrapDom.addEventListener("touchmove",this.onTouchmove.bind(this),!0))},e.prototype.showAnnotation=function(){this.alwaysMode=!0,this.canvas.style.zIndex=5,this.editor.editIndex=-1,this.update(),this.showCanvas()},e.prototype.createSnapshot=function(t){var e=this.wrapDom.querySelector(".bf-view canvas"),i=document.createElement("canvas");i.width=this.wrapDom.clientWidth,i.height=this.wrapDom.clientHeight;var n=i.getContext("2d");n.beginPath();var o=window.devicePixelRatio||1;n.drawImage(e,0,0,i.width*o,i.height*o,0,0,i.width,i.height),n.drawImage(this.canvas,0,0),t(i.toDataURL())},e.prototype.transform=function(t){for(var e=[],i=0;i<t.length;i++){var n,o=t[i],s=o.style,r=s["fill-opacity"];switch(o.shapeType){case 0:var a=this.getArrowPoints(o.size,o.position,-o.rotation);n=new ArrowMarkup(a,s["stroke-color"],s["stroke-width"],o.rotation);break;case 7:n=new CloudRectMarkup(this.getDrawPoints(o.size,o.position),s["stroke-color"],s["stroke-width"],o.rotation,r&&s["fill-color"]);break;case 4:var l=this.getCloudPoints(o);(n=new CloudMarkup(l[0],s["stroke-color"],s["stroke-width"],l[1],o.rotation,r&&s["fill-color"],!0)).close=!0;break;case 1:n=new RectMarkup(this.getDrawPoints(o.size,o.position),s["stroke-color"],s["stroke-width"],o.rotation,r&&s["fill-color"]);break;case 2:n=new EllipsMarkup(this.getDrawPoints(o.size,o.position),s["stroke-color"],s["stroke-width"],o.rotation,r&&s["fill-color"]);break;case 3:n=new CrossMarkup(this.getDrawPoints(o.size,o.position),s["stroke-color"],s["stroke-width"],o.rotation);break;case 5:var h=this.worldToClient({x:o.position.x-.5*o.size.width,y:o.position.y+.5*o.size.height,z:o.position.z}),c=this.worldToClient(o.position),d=this.viewer.clientToWorldPoint([c.x,c.y]);n=new TextMarkup(this.viewer.clientToWorldPoint([h.x,h.y]),decodeURIComponent(o.text),s["stroke-color"],s["font-size"],s["font-family"],o.rotation,null,d)}e.push(n)}return e},e.prototype.getCloudPoints=function(t){for(var e=t.size.width/t.originSize.width,i=t.size.height/t.originSize.height,n=(new window.THREE.Matrix4).makeScale(e,i,1),o=(new window.THREE.Matrix4).makeRotationZ(-t.rotation),s=(new window.THREE.Matrix4).makeTranslation(t.position.x,t.position.y,t.position.z).multiply(o).multiply(n),r=t.shapePoints.split(","),a=[],l=[],h=!0,c=1;c<r.length;c+=2){var d=new window.THREE.Vector3,u=this.viewBoxToWorld({x:parseInt(r[c-1]),y:parseInt(r[c])},t.originSize);d.x=u.x,d.y=u.y,d.z=0,d.applyMatrix4(s);var p=this.worldToClient(d),g=this.viewer.clientToWorldPoint([p.x,p.y]);h?a.push(g):l.push(g),h=!h}return[a,l]},e.prototype.viewBoxToWorld=function(t,e){var i=e.width,n=e.height,o=this.viewBox.width,s=this.viewBox.height;return{x:t.x/o*i,y:t.y/s*n}},e.prototype.getDrawPoints=function(t,e){var i=this.worldToClient({x:e.x-.5*t.width,y:e.y-.5*t.height,z:e.z}),n=this.worldToClient({x:e.x+.5*t.width,y:e.y+.5*t.height,z:e.z});return[this.viewer.clientToWorldPoint([i.x,i.y]),this.viewer.clientToWorldPoint([n.x,n.y])]},e.prototype.getArrowPoints=function(t,e,i){var n=this.worldToClient({x:e.x-.5*t.width,y:e.y,z:e.z}),o=this.worldToClient({x:e.x+.5*t.width,y:e.y,z:e.z}),s=this.worldToClient(e);return n=this.markupManager.rotateTransform(s.x,s.y,i,n.x,n.y),o=this.markupManager.rotateTransform(s.x,s.y,i,o.x,o.y),[this.viewer.clientToWorldPoint(n),this.viewer.clientToWorldPoint(o)]},e.prototype.worldToClient=function(t){var e=this.getContainerOffsetToClient(this.wrapDom),i=this.cameraControl.getCamera(),n=new window.THREE.Vector3(t.x,t.y,t.z);return n.applyMatrix4(i.matrixWorld),n.sub(i.position),n.project(i),n.x=Math.floor(.5*(n.x+1)*e.width+.5),n.y=Math.floor(-.5*(n.y-1)*e.height+.5),n.z=0,n},e.prototype.getContainerOffsetToClient=function(t){var e,i;if(t!=document){var n=(i=t).getBoundingClientRect?function(t){var e=t.getBoundingClientRect(),i=document.body,n=document.documentElement,o=n.clientTop||i.clientTop,s=n.clientLeft||i.clientLeft,r=e.top-o,a=e.left-s;return{top:Math.round(r),left:Math.round(a)}}(i):function(t){for(var e=0,i=0;t;)e+=t.offsetTop,i+=t.offsetLeft,t=t.offsetParent;var n=document.body,o=document.documentElement;return{top:e-=window.pageYOffset||o.scrollTop||n.scrollTop,left:i-=window.pageXOffset||o.scrollLeft||n.scrollLeft}}(i);e={width:t.offsetWidth,height:t.offsetHeight,left:n.left,top:n.top}}else e={width:window.innerWidth,height:window.innerHeight,left:0,top:0};return e},e.prototype.highlightAnnotationByIds=function(t){var e=this,i=this.getAnnotationList();if(t&&i.length&&t.length){Array.isArray(t)||(t=[t]);var n=null;t.forEach((function(t){(n=i.find((function(e){return e.markupId==t})))&&(n.highlightColor=e.markupManager.highlightConfig.highlightColor)})),this.setAnnotationList(i),this.editor.tool.redraw&&this.editor.tool.redraw(this.viewer)}},e.prototype.clearHighlight=function(){var t=this.getAnnotationList();t.length&&(t.map((function(t){t.highlightColor=""})),this.editor.tool.redraw&&this.editor.tool.redraw(this.viewer))},e.prototype.setHighlightConfig=function(t){this.markupManager.highlightConfig=t},e}(MarkupViewer),Mouse$11=MouseButtons,MarkupViewer2D=function(t){function e(e,i){var n=t.call(this,e,i)||this;return n.absoluteBasePoint=null,n.screenBasePoint=null,n.zoomFactor={x:1,y:1},n.viewBox={width:1e3,height:1e3},n.viewer.clientToWorldPoint=function(t){var e=n.viewer.clientToWorld({x:t[0],y:t[1]});return[e.x,e.y]},n.viewer.worldToClientPoint=function(t){var e=n.viewer.worldToClient({x:t[0],y:t[1]});return[e.x,e.y]},n}return __extends$3(e,t),e.prototype.onMouseUp=function(t){!this.work&&this.restoreState&&(this.restoreState=!1,this.endDrawing()),this.work&&this.editor.onMouseUp(this.viewer,t)},e.prototype.setState=function(t){if(this.modelViewer.setState(t.state),"string"==typeof t.annotationList){var e=this.markupManager.fromString(t.annotationList);this.setAnnotationList(e)}else t.annotationList[0].id?this.setAnnotationList(this.transform(t.annotationList)):this.setAnnotationList(t.annotationList)},e.prototype.createSnapshot=function(t){var e=this;this.viewer._imageRender.createSnapshotAsync("",(function(i){e.getScreenSnapshot(i,t)}))},e.prototype.getScreenSnapshot=function(t,e){var i=document.createElement("canvas"),n=this.getContainerOffsetToClient(this.wrapDom);i.width=n.width,i.height=n.height;var o,s=i.getContext("2d"),r=this;if(e&&t)return(o=new Image).onload=function(){s.drawImage(o,0,0),s.drawImage(r.canvas,0,0);var t=i.toDataURL("image/png");i=s=null,e(t)},o.src=t,null;t&&((o=new Image).src=t,s.drawImage(o,0,0));s.drawImage(this.canvas,0,0);var a=i.toDataURL("image/png");return i=s=null,a},e.prototype.transform=function(t){for(var e=[],i=0;i<t.length;i++){var n,o=t[i],s=o.style,r=s["fill-opacity"];switch(o.shapeType){case 0:var a=this.getArrowPoints(o.size,o.position,-o.rotation);n=new ArrowMarkup(a,s["stroke-color"],s["stroke-width"],o.rotation);break;case 7:n=new CloudRectMarkup(this.getDrawPoints(o.size,o.position),s["stroke-color"],s["stroke-width"],o.rotation,r&&s["fill-color"]);break;case 4:var l=this.getCloudPoints(o);n=new CloudMarkup(l[0],s["stroke-color"],s["stroke-width"],l[1],o.rotation,r&&s["fill-color"]);break;case 1:n=new RectMarkup(this.getDrawPoints(o.size,o.position),s["stroke-color"],s["stroke-width"],o.rotation,r&&s["fill-color"]);break;case 2:n=new EllipsMarkup(this.getDrawPoints(o.size,o.position),s["stroke-color"],s["stroke-width"],o.rotation,r&&s["fill-color"]);break;case 3:n=new CrossMarkup(this.getDrawPoints(o.size,o.position),s["stroke-color"],s["stroke-width"],o.rotation);break;case 5:var h=this.worldToClient({x:o.position.x-.5*o.size.width,y:o.position.y+.5*o.size.height,z:o.position.z}),c=this.worldToClient(o.position),d=this.viewer.clientToWorldPoint([c.x,c.y]);n=new TextMarkup(this.viewer.clientToWorldPoint([h.x,h.y]),decodeURIComponent(o.text),s["stroke-color"],s["font-size"],s["font-family"],o.rotation,null,d)}e.push(n)}return e},e.prototype.getContainerOffsetToClient=function(t){var e,i;if(t!=document){var n=(i=t).getBoundingClientRect?function(t){var e=t.getBoundingClientRect(),i=document.body,n=document.documentElement,o=n.clientTop||i.clientTop,s=n.clientLeft||i.clientLeft,r=e.top-o,a=e.left-s;return{top:Math.round(r),left:Math.round(a)}}(i):function(t){for(var e=0,i=0;t;)e+=t.offsetTop,i+=t.offsetLeft,t=t.offsetParent;var n=document.body,o=document.documentElement;return{top:e-=window.pageYOffset||o.scrollTop||n.scrollTop,left:i-=window.pageXOffset||o.scrollLeft||n.scrollLeft}}(i);e={width:t.offsetWidth,height:t.offsetHeight,left:n.left,top:n.top}}else e={width:window.innerWidth,height:window.innerHeight,left:0,top:0};return e},e.prototype.getCloudPoints=function(t){for(var e=t.size.width/t.originSize.width,i=t.size.height/t.originSize.height,n=(new window.THREE.Matrix4).makeScale(e,i,1),o=(new window.THREE.Matrix4).makeRotationZ(-t.rotation),s=(new window.THREE.Matrix4).makeTranslation(t.position.x,t.position.y,t.position.z).multiply(o).multiply(n),r=t.shapePoints.split(","),a=[],l=[],h=!0,c=1;c<r.length;c+=2){var d=new window.THREE.Vector3,u=this.viewBoxToWorld({x:parseInt(r[c-1]),y:parseInt(r[c])},t.originSize);d.x=u.x,d.y=u.y,d.z=0,d.applyMatrix4(s);var p=this.worldToClient(d),g=this.viewer.clientToWorldPoint([p.x,p.y]);h?a.push(g):l.push(g),h=!h}return[a,l]},e.prototype.worldToClient=function(t){var e=this.getContainerOffsetToClient(this.wrapDom),i=new window.THREE.Vector3,n=this.absoluteBasePoint,o=this.screenBasePoint;return this.absoluteBasePoint||(n={x:0,y:0}),this.screenBasePoint||(o={x:.5*e.width,y:.5*e.height}),i.x=(t.x-n.x)*this.zoomFactor.x+o.x,i.y=(-t.y-n.y)*this.zoomFactor.y+o.y,i.z=0,i},e.prototype.viewBoxToWorld=function(t,e){var i=e.width,n=e.height,o=this.viewBox.width,s=this.viewBox.height;return{x:t.x/o*i,y:t.y/s*n}},e.prototype.getDrawPoints=function(t,e){var i=this.worldToClient({x:e.x-.5*t.width,y:e.y-.5*t.height,z:e.z}),n=this.worldToClient({x:e.x+.5*t.width,y:e.y+.5*t.height,z:e.z});return[this.viewer.clientToWorldPoint([i.x,i.y]),this.viewer.clientToWorldPoint([n.x,n.y])]},e.prototype.getArrowPoints=function(t,e,i){var n=this.worldToClient({x:e.x-.5*t.width,y:e.y,z:e.z}),o=this.worldToClient({x:e.x+.5*t.width,y:e.y,z:e.z}),s=this.worldToClient(e);return n=this.markupManager.rotateTransform(s.x,s.y,i,n.x,n.y),o=this.markupManager.rotateTransform(s.x,s.y,i,o.x,o.y),[this.viewer.clientToWorldPoint(n),this.viewer.clientToWorldPoint(o)]},e.prototype.onMouseDown=function(t){!this.work&&this.restoreState&&(this.restoreState=!1,this.endDrawing()),this.work&&t.target==this.canvas&&(t.preventDefault(),t.buttons==Mouse$11.LelftButton?(t.stopPropagation(),this.editor.onMouseDown(this.viewer,t)):this.editor.onMouseDown(this.viewer,t))},e.prototype.onMouseWheel=function(t){this.work&&(t.preventDefault(),this.update(),this.editor.onMouseWheel(this.viewer,t))},e}(MarkupViewer);!function(){var t="Bimface.Plugins.Annotation.AnnotationManager",e=Glodon$1.Bimface.Data.StatisticsDataManager.getInstance(),i=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Annotation"),n=(Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.Dom"),Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.HttpRequest"),function(t){var e=t.viewer;if(this._opt=t,this.isShowAnnotation=!1,this.historyQueue=[],Glodon$1.Bimface.Viewer.Viewer3D&&"Viewer3D"===e.viewerType)this._helper=new MarkupViewer3D(e,e._opt.domElement);else if(Glodon$1.Bimface.Viewer.Viewer2D&&e instanceof Glodon$1.Bimface.Viewer.Viewer2D)this.isViewer2D=!0,this._helper=new MarkupViewer2D(e,e._opt.domElement.querySelector(".bf-image"));else if(Glodon$1.Bimface.Viewer.ViewerPDF&&e instanceof Glodon$1.Bimface.Viewer.ViewerPDF)this._helper=new MarkupPDF(e,e._opt.domElement.querySelector(".bf-pdf-outer"));else{this._helper=new MarkupDrawing(e,e._opt.domElement);let t={hoverColor:"#ADADAD",highlightColor:"#3DCC93"};e.getDisplayMode&&0===e.getDisplayMode()&&(t={hoverColor:"#FFFFFF",highlightColor:"#3DCC93"}),this._helper.setHighlightConfig&&this._helper.setHighlightConfig(t)}this._helper.viewer.onSelectChange=t=>{this.onSelectChange(t)},this._helper.viewer.itemCompleted=t=>{this.itemCompleted(t)},this.init()});n.prototype={init:function(){var t=this._opt;t.lineWidth&&this.setLineWidth(t.lineWidth),t.lineColor&&this.setLineColor(t.lineColor),t.fillColor&&this.setFillColor(t.fillColor),t.fontFamily&&this.setFontFamily(t.fontFamily),t.fontSize&&this.setFontSize(t.fontSize)},exit:function(){this.endDrawing()},onSelectChange(t){},onClick(t){this._helper.viewer.onClick=t},itemCompleted(t){this._helper.viewer.itemCompleted=t},onDoubleClick(t){this._helper.viewer.onDoubleClick=t},enablePick(t){this._helper.viewer.isEnableAnnotationPick=t},setOperationMode(t){"[object Array]"===Object.prototype.toString.call(t)&&(this._helper.viewer.operationTypes=t)},restoreOperationMode(){this._helper.viewer.operationTypes=["Delete","Edit","Move","Rotate","Stretch"]},getAnnotationList:function(){return this._helper.getAnnotationList()},setAnnotationList:function(t){t.length>0&&t[0].id&&(t=this._helper.transform(t)),this._helper.setAnnotationList(t),this._helper.update()},setState:function(t){this._helper.setState(t)},createSnapshot:function(t){this._helper.createSnapshot(t)},startDrawing:function(){this._helper.startDrawing();var t=document.querySelector(".bf-toolbar-select");t&&(t.style.display="none")},endDrawing:function(){e.send(t,"endDrawing"),this._helper.editAnnotationEnd(),this.isShowAnnotation=!1;var i=document.querySelector(".bf-toolbar-select");i&&(i.style.display="block")},clear:function(){e.send(t,"clear"),this._helper.clearAnnotations()},resize:function(){},setAnnotationType:function(i){e.send(t,"setAnnotationType"),this.restoreAnnotationAction(),this._helper.setAnnotationType(i.toLocaleLowerCase())},setLineWidth:function(i){e.send(t,"setLineWidth"),this._helper.setAnnotationStyle({"stroke-width":i})},setLineColor:function(i){e.send(t,"setLineColor"),this._helper.setAnnotationStyle({"stroke-color":`${i.getRGBA()}`})},setFillColor:function(i){e.send(t,"setFillColor"),this._helper.setAnnotationStyle({"fill-color":`${i.getRGBA()}`})},setFontFamily:function(i){e.send(t,"setFontFamily"),this._helper.setAnnotationStyle({"font-family":i})},setFontSize:function(i){e.send(t,"setFontSize"),this._helper.setAnnotationStyle({"font-size":i})},removeSelectedAnnotation:function(){this._helper.removeSelectedAnnotation()},showAnnotation:function(){this._helper.showAnnotation()},hideAnnotation:function(){this._helper.hideAnnotation()},setStyle:function(t){this._helper.setAnnotationStyle(t)},destroy:function(){this.endDrawing()},getCurrentState:function(){if(this.isViewer2D)var t=this._helper.getCurrentState();else{var e=this._opt.viewer.getViewer();this._opt.windowAdaption&&e.setCameraStateWithFrustum&&e.setCameraStateWithFrustum(!0);t=this._helper.getCurrentState();e.setCameraStateWithFrustum&&e.setCameraStateWithFrustum(!1)}return t},getWorldPosition:function(t){var e=this._opt.viewer,i=e.screenWidth/2,n=e.screenHeight/2,o={x:i+t.position.x,y:n-t.position.y};return e.clientToWorld(o)},inherit:function(t){for(var e in t)this[e]=t[e]},stringifyAnnotationList(t){return this._helper.markupManager.toString(t)},jsonifyAnnotationList(t){return this._helper.markupManager.fromString(t)},lockAnnotationAction(){this._helper.lockAnnotationAction&&this._helper.lockAnnotationAction()},restoreAnnotationAction(){this._helper.restoreAnnotationAction&&this._helper.restoreAnnotationAction()},highlightAnnotationByIds(t){this._helper.highlightAnnotationByIds&&this._helper.highlightAnnotationByIds(t)},clearHighlight(){this._helper.clearHighlight&&this._helper.clearHighlight()},setHighlightConfig(t){this._helper.setHighlightConfig&&this._helper.setHighlightConfig(t)}},i.AnnotationManager=n}(),Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Annotation").AnnotationToolbarConfig=function(){},function(){var t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Annotation");let e=Object.freeze({Saved:"Saved",Cancelled:"Cancelled"});t.AnnotationToolbarEvent=e}(),function(){var t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Annotation"),e=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.Dom"),i=(Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.HttpRequest"),Glodon$1.Bimface.Plugins.Annotation.AnnotationToolbarEvent),n=function(t){var n=this._eventManager=new Glodon$1.Web.Lang.EventManager,o=t.viewer,s=Glodon$1.Bimface.Viewer.ViewerDrawing&&o instanceof Glodon$1.Bimface.Viewer.ViewerDrawing;this.isDrawing=s;var r=Glodon$1.Bimface.Viewer.ViewerPDF&&o instanceof Glodon$1.Bimface.Viewer.ViewerPDF;this.isPDF=r;var a=e.create("div","bf-annotation bf-hide");this.domElement=a;var l=Glodon$1.Bimface.Plugins.Annotation.AnnotationTypeOption,h=new Glodon$1.Bimface.Plugins.Annotation.AnnotationManagerConfig,c=h.lineColor;h.viewer=o,h.windowAdaption=t.windowAdaption,h.annotationCallback=t.annotationCallback;var d=new Glodon$1.Bimface.UI.Toolbar.ToolbarConfig;d.element=a,d.className="bf-toolbar bf-toolbar-annotation";var u=this.annotationToolbar=new Glodon$1.Bimface.UI.Toolbar.Toolbar(d);this.annotationToolbar=u,s&&(h.annotationToolbar=u);var p=this._annotationManager=new Glodon$1.Bimface.Plugins.Annotation.AnnotationManager(h);o.getDomElement().appendChild(a),a.addEventListener("mousedown",(function(t){t.stopPropagation()})),a.addEventListener("touchstart",(function(t){t.stopPropagation()})),a.addEventListener("touchmove",(function(t){t.stopPropagation()}));var g=new Glodon$1.Bimface.UI.Toolbar.ToolbarConfig;g.element=a,g.className="bf-toolbar bf-toolbar-control";var m=new Glodon$1.Bimface.UI.Toolbar.Toolbar(g);if(s){var f=new Glodon$1.Bimface.UI.Button.ButtonConfig;f.className="bf-button gld-bf-drag",f.title="视图交互",f.id="annotationHand_id",f.groupName="Annotation";var w=new Glodon$1.Bimface.UI.Button.SingleButton(f);w.addEventListener("Click",(function(){p.lockAnnotationAction(),Y.show(),nt.hide()})),u.addControl(w)}var v=new Glodon$1.Bimface.UI.Button.ButtonConfig;v.className="bf-button gld-bf-narrow ",v.title="箭头",v.id="annotationArrow_id",v.groupName="Annotation";var y=new Glodon$1.Bimface.UI.Button.SingleButton(v);y.addEventListener("Click",(function(){p.setAnnotationType(l.Arrow),Y.show(),nt.hide()})),y.setChecked(),u.addControl(y);var b=new Glodon$1.Bimface.UI.Button.ButtonConfig;b.className="bf-button gld-bf-n-cloud",b.title="云线框",b.groupName="Annotation",b.id="annotationCloudrect_id";var E=new Glodon$1.Bimface.UI.Button.SingleButton(b);E.addEventListener("Click",(function(){p.setAnnotationType(l.CloudRect),Y.show(),nt.hide()})),u.addControl(E);var C=new Glodon$1.Bimface.UI.Button.ButtonConfig;C.className="bf-button gld-bf-ncloud",C.title="云线",C.groupName="Annotation",C.id="annotationCloud_id";var x=new Glodon$1.Bimface.UI.Button.SingleButton(C);x.addEventListener("Click",(function(){p.setAnnotationType(l.Cloud),Y.show(),nt.hide()})),u.addControl(x);var M=new Glodon$1.Bimface.UI.Button.ButtonConfig;M.className="bf-button gld-bf-n-ployline",M.title="折线",M.groupName="Annotation",M.id="annotationPolyline_id";var P=new Glodon$1.Bimface.UI.Button.SingleButton(M);P.addEventListener("Click",(function(){p.setAnnotationType(l.Polyline),Y.show(),nt.hide()})),u.addControl(P);var I=new Glodon$1.Bimface.UI.Button.ButtonConfig;I.className="bf-button gld-bf-nrectangle",I.title="矩形",I.groupName="Annotation",I.id="annotationRectangle_id";var T=new Glodon$1.Bimface.UI.Button.SingleButton(I);T.addEventListener("Click",(function(){p.setAnnotationType(l.Rectangle),Y.show(),nt.hide()})),u.addControl(T);var D=new Glodon$1.Bimface.UI.Button.ButtonConfig;D.className="bf-button gld-bf-noval",D.title="椭圆",D.groupName="Annotation",D.id="annotationNoval_id";var S=new Glodon$1.Bimface.UI.Button.SingleButton(D);S.addEventListener("Click",(function(){p.setAnnotationType(l.Ellips),Y.show(),nt.hide()})),u.addControl(S);var B=new Glodon$1.Bimface.UI.Button.ButtonConfig;B.className="bf-button gld-bf-mark",B.title="X",B.groupName="Annotation",B.id="annotationCross_id";var A=new Glodon$1.Bimface.UI.Button.SingleButton(B);A.addEventListener("Click",(function(){p.setAnnotationType(l.Cross),Y.show(),nt.hide()})),u.addControl(A);var _=new Glodon$1.Bimface.UI.Button.ButtonConfig;_.className="bf-button gld-bf-ntext",_.title="文字",_.groupName="Annotation",_.id="annotationText_id";var k=new Glodon$1.Bimface.UI.Button.SingleButton(_);k.addEventListener("Click",(function(){p.setAnnotationType(l.Text),Y.hide(),nt.show()})),u.addControl(k);var L=new Glodon$1.Bimface.UI.Button.ButtonConfig;L.className="bf-combobox bf-color",L.title="颜色",L.id="annotationColor_id";var R=new Glodon$1.Bimface.UI.Button.ComboBox(L),G=new Glodon$1.Bimface.UI.Button.ButtonConfig;G.className="bf-button bf-color",G.title="红",G.id="annotationColorRed_id";var N=new Glodon$1.Bimface.UI.Button.ComboBoxOptionButton(G);N.color=new Glodon$1.Web.Graphics.Color(208,2,27,1);var V=e.create("div","bf-color-button");V.setCss({backgroundColor:`#${N.color.getHEX()}`}),N.setHtml(V.outerHTML),R.addControl(N);var $=new Glodon$1.Bimface.UI.Button.ButtonConfig;$.className="bf-button bf-color",$.title="黄",$.id="annotationColorYellow_id";var O=new Glodon$1.Bimface.UI.Button.ComboBoxOptionButton($);O.color=new Glodon$1.Web.Graphics.Color(245,166,35,1);var U=e.create("div","bf-color-button");U.setCss({backgroundColor:`#${O.color.getHEX()}`}),O.setHtml(U.outerHTML),R.addControl(O);var H=new Glodon$1.Bimface.UI.Button.ButtonConfig;H.className="bf-button bf-color",H.title="蓝",H.id="annotationColorBlue_id";var z=new Glodon$1.Bimface.UI.Button.ComboBoxOptionButton(H);z.color=new Glodon$1.Web.Graphics.Color(74,144,226,1);var F=e.create("div","bf-color-button");F.setCss({backgroundColor:`#${z.color.getHEX()}`}),z.setHtml(F.outerHTML),R.addControl(z);var W=new Glodon$1.Bimface.UI.Button.ButtonConfig;W.className="bf-button bf-color",W.title="绿",W.id="annotationColorGreen_id";var j=new Glodon$1.Bimface.UI.Button.ComboBoxOptionButton(W);j.color=new Glodon$1.Web.Graphics.Color(126,211,33,1);var Z=e.create("div","bf-color-button");Z.setCss({backgroundColor:`#${j.color.getHEX()}`}),j.setHtml(Z.outerHTML),R.addControl(j),u.addControl(R),(X=new Glodon$1.Bimface.UI.Button.ButtonConfig).className="bf-combobox",X.title="粗细",X.id="annotationLine_id";var X,Y=new Glodon$1.Bimface.UI.Button.ComboBox(X);(X=new Glodon$1.Bimface.UI.Button.ButtonConfig).className="bf-button bf-line",X.title="细",X.id="annotationLineThin_id";var q=new Glodon$1.Bimface.UI.Button.ComboBoxOptionButton(X);q.lineWidth=3;var K=e.create("div","bf-line-button");K.setCss({height:`${q.lineWidth}px`,backgroundColor:`#${c.getHEX()}`,margin:(32-q.lineWidth)/2+"px 4px"}),q.element.appendChild(K),Y.addControl(q),X.title="中";var J=new Glodon$1.Bimface.UI.Button.ComboBoxOptionButton(X);J.lineWidth=6,J.id="annotationLineMiddle_id";var Q=e.create("div","bf-line-button");Q.setCss({height:`${J.lineWidth}px`,backgroundColor:`#${c.getHEX()}`,margin:(32-J.lineWidth)/2+"px 4px"}),J.element.appendChild(Q),Y.addControl(J),X.title="粗";var tt=new Glodon$1.Bimface.UI.Button.ComboBoxOptionButton(X);tt.lineWidth=10,tt.id="annotationLineThick_id";var et=e.create("div","bf-line-button");et.setCss({height:`${tt.lineWidth}px`,backgroundColor:`#${c.getHEX()}`,margin:(32-tt.lineWidth)/2+"px 4px"}),tt.element.appendChild(et),Y.addControl(tt),R.addEventListener("Change",(function(t){p.setLineColor(t.color);(c=t.color).getHEX();K.setCss({height:`${q.lineWidth}px`,backgroundColor:`#${c.getHEX()}`,margin:(32-q.lineWidth)/2+"px 4px"}),Q.setCss({height:`${J.lineWidth}px`,backgroundColor:`#${c.getHEX()}`,margin:(32-J.lineWidth)/2+"px 4px"}),et.setCss({height:`${tt.lineWidth}px`,backgroundColor:`#${c.getHEX()}`,margin:(32-tt.lineWidth)/2+"px 4px"});var e=Y.getCurrentControl();Y.setSelectedControlById(e.getId())})),Y.addEventListener("Change",(function(t){p.setLineWidth(t.lineWidth)})),u.addControl(Y);var it=new Glodon$1.Bimface.UI.Button.ButtonConfig;it.className="bf-combobox bf-font-button",it.title="字号",it.id="annotationFont_id";var nt=new Glodon$1.Bimface.UI.Button.ComboBox(it),ot=new Glodon$1.Bimface.UI.Button.ButtonConfig;ot.className="bf-button bf-size",ot.title="14";var st=new Glodon$1.Bimface.UI.Button.ComboBoxOptionButton(ot);st.fontSize=14,st.id="annotationSizeSmall_id",st.setHtml("14"),nt.addControl(st),ot.title="18";var rt=new Glodon$1.Bimface.UI.Button.ComboBoxOptionButton(ot);rt.fontSize=18,rt.id="annotationSizeMiddle_id",rt.setHtml("18"),nt.addControl(rt),ot.title="24";var at=new Glodon$1.Bimface.UI.Button.ComboBoxOptionButton(ot);at.fontSize=24,at.id="annotationSizeLarge_id",at.setHtml("24"),nt.addControl(at),nt.addEventListener("Change",(function(t){p.setFontSize(t.fontSize)})),nt.hide(),u.addControl(nt);var lt=new Glodon$1.Bimface.UI.Button.ButtonConfig;lt.className="bf-save",lt.id="annotatioSave_id",lt.title=BimfaceLanguage.bf_general_save;var ht=new Glodon$1.Bimface.UI.Button.SingleButton(lt);ht.setHtml(BimfaceLanguage.bf_general_save),ht.addEventListener("Click",(function(){s||r?n.fireEvent(i.Saved,{annotationList:p.getAnnotationList()}):n.fireEvent(i.Saved,{annotationList:p.getAnnotationList(),state:p.getCurrentState()}),p.endDrawing(),a.addClass("bf-hide")})),m.addControl(ht);var ct=new Glodon$1.Bimface.UI.Button.ButtonConfig;ct.className="bf-cancel",ct.title=BimfaceLanguage.bf_general_cancel,ct.id="annotationCancel_id";var dt=new Glodon$1.Bimface.UI.Button.SingleButton(ct);dt.setHtml(BimfaceLanguage.bf_general_cancel),dt.addEventListener("Click",(function(){p.endDrawing(),n.fireEvent(i.Cancelled),a.addClass("bf-hide")})),m.addControl(dt),this.getEventManager=function(){return n}};n.prototype={getEventManager:function(){return this._eventManager},addEventListener:function(t,e){this.getEventManager().addEvent(t,e)},removeEventListener:function(t,e){this.getEventManager().removeEvent(t,e)},show:function(t,e){this.isDrawing||this.isPDF||this._annotationManager.clear(),this._annotationManager.startDrawing(),this.domElement.removeClass("bf-hide")},getAnnotationManager:function(){return this._annotationManager},exit:function(){this.annotationToolbar.hide(),this.getAnnotationManager().exit()}},t.AnnotationToolbar=n}(),Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins").TagConfig=function(){return{viewer:null}},function(){var t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins"),e=(Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.Dom"),Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.HttpRequest"),function(t){var e=this,i=this._viewer=t.viewer.getViewer();if(this._opt=t,this._renderCallback=function(){e.resize()},t.minimap){this.mapHelper=t.minimap;var n=new CLOUD$1.View2dAdapter(this.mapHelper,i);this.mapHelper.setMinimapResizeCallback((function(t){e._tagHelper.updateGroupName(),e._tagHelper.updateDomContainer(),e._tagHelper.resize(t),e._tagHelper.updateByGroup()})),this.mapHelper.setPlaneChangedCallback((function(){e._tagHelper.updateGroupName(),e._tagHelper.updateByGroup()}))}else{n=new CLOUD$1.View3dAdapter(i);i.addCallbacks("render",this._renderCallback)}this._tagHelper=new CLOUD$1.Extensions.MarkerEditor(n),this._tagHelper.disableInteractions(!0),this.init()});e.prototype={init:function(){this._tagHelper.isInitialized()||this._tagHelper.init()},addTag:function(t,e){if(!t)return!1;var i=!1,n=this.getTags();t.userId=t.objectId,t.worldBoundingBox=t.boundingBox,t.worldPosition||(t.worldPosition={x:(t.worldBoundingBox.min.x+t.worldBoundingBox.max.x)/2,y:(t.worldBoundingBox.min.y+t.worldBoundingBox.max.y)/2,z:(t.worldBoundingBox.min.z+t.worldBoundingBox.max.z)/2});for(var o=0,s=n.length;o<s;o++){if(n[o].userId==t.userId)return i=!0,!1}t.floorList?this._tagHelper.setMarkerGroups(t.floorList):this._tagHelper.setMarkerGroups([]),this._tagHelper.updateGroupName(),i||this._tagHelper.createMarkerByIntersect(t,e.shape,e.image,e.size)},deleteTag:function(t,e){if(e)return this._tagHelper.removeMarkerInGroup(t,e),!1;for(var i=this.getTags(),n=0,o=i.length;n<o;n++){var s=i[n];if(s.userId==t)return this._tagHelper.deleteMarker(s),!1}},destroy:function(){this._viewer.removeCallbacks("render",this._renderCallback),this._tagHelper.markerClickCallback=null,this.unLoadTags(),this._tagHelper.clearMarkers(),this._tagHelper=null},loadTags:function(t){this._tagHelper.loadMarkers(t)},unLoadTags:function(){this._tagHelper.unloadMarkers()},getTags:function(){return this._tagHelper.getMarkerInfoList()},getTagById:function(t){return this._tagHelper.getMarker(t)},zoomToSelectedTag:function(){this._tagHelper.zoomToSelectedMarkers()},resize:function(){this._tagHelper.onResize()},onSelected:function(t){this._tagHelper.setMarkerClickCallback(t)}},t.Tag=e}();class DimensionEventControl{constructor(t,e,i){this.viewer=t,this.domContainer=e,this.dimensionItems=i,this.selectedItem=null,this.isEnableSelection=!0,this.offset=e.getBoundingClientRect(),Glodon$1.Web.Lang.Utility.ClientHelper.getIsDesktop()&&this.hookEvents()}hookEvents(){this.domContainer.addEventListener("mousemove",(t=>{if(!this.isEnableSelection)return;let e=new Vector2(t.clientX,t.clientY);this.viewer.isFullScreen||(e.x-=this.offset.left,e.y-=this.offset.top),this.hitTest(e)?(this.domContainer.style.cursor="pointer",t.preventDefault(),t.stopPropagation()):this.domContainer.style.cursor=""}),!1),this.domContainer.addEventListener("mousedown",(t=>{if(!this.isEnableSelection)return;let e=new Vector2(t.clientX,t.clientY);this.viewer.isFullScreen||(e.x-=this.offset.left,e.y-=this.offset.top);let i=this.hitTest(e);i?(i.getIsSelected()?(this.setSelectedItem(null),i.unselect()):(this.setSelectedItem(i),i.select()),i&&t.altKey&&console.info(Object.assign({},i.content,{id:i.id})),t.preventDefault(),t.stopPropagation()):this.setSelectedItem(null)}),!1),this.domContainer.addEventListener("dblclick",(t=>{if(!this.isEnableSelection)return;let e=new Vector2(t.clientX,t.clientY);this.viewer.isFullScreen||(e.x-=this.offset.left,e.y-=this.offset.top),this.hitTest(e)&&(t.preventDefault(),t.stopPropagation())}),!1)}hitTest(t){for(var e=this.dimensionItems.length-1;e>=0;e--){let i=this.dimensionItems[e];if(i.getNotation().hitTest(t))return i}for(e=this.dimensionItems.length-1;e>=0;e--){let i=this.dimensionItems[e];if(i.hitTest(t))return i}return null}setSelectedItem(t){this.selectedItem&&(this.selectedItem.actionWhenUnselected(),this.selectedItem.unselect()),this.selectedItem=t,t&&t.actionWhenSelected()}getSelectedItem(){return this.selectedItem}hasSelected(){return null!==this.selectedItem}setIsEnableSelection(t){this.isEnableSelection=t}}!function(){var t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Dimension");t.DimensionContainerConfig=class{constructor(){this.viewer=null,this.contents=[]}}}();class DimensionUtil{}DimensionUtil.xmlns="http://www.w3.org/2000/svg",DimensionUtil.makeCircle=function(t){var e=document.createElementNS(DimensionUtil.xmlns,"circle");return e.style.fill=t.color,e.setAttribute("r",t.radius+""),e.setAttribute("stroke","#FFFFFF"),e.setAttribute("stroke-width",t.strokeWidth),e.setAttribute("transform","translate("+t.position.x+","+t.position.y+")"),e},DimensionUtil.makeConcentricCircle=function(t){var e=document.createElementNS(DimensionUtil.xmlns,"g"),i=document.createElementNS(DimensionUtil.xmlns,"circle");i.style.fill=t.color,i.setAttribute("r",t.innerRadius+""),i.setAttribute("stroke","#FFFFFF"),i.setAttribute("stroke-width",t.innerStrokeWidth),i.setAttribute("transform","translate("+t.position.x+","+t.position.y+")");var n=i.cloneNode();return n.setAttribute("r",t.outerRadius+""),n.setAttribute("stroke-width",t.outerStrokeWidth||0),e.appendChild(n),e.appendChild(i),e},DimensionUtil.makeLine=function(t){var e=document.createElementNS(DimensionUtil.xmlns,"line");return e.setAttribute("stroke",t.color),e.setAttribute("stroke-width",t.lineWidth),e.setAttribute("x1",t.start.x+""),e.setAttribute("y1",t.start.y+""),e.setAttribute("x2",t.end.x+""),e.setAttribute("y2",t.end.y+""),e},DimensionUtil.makeRectangle=function(t){var e=document.createElementNS(DimensionUtil.xmlns,"rect");return e.setAttribute("stroke-width",2),e.setAttribute("x",t.x),e.setAttribute("y",t.y),e.setAttribute("width",t.width),e.setAttribute("height",t.height),e.setAttribute("rx",t.radius),e.style.fill=t.fillColor||"none",e.setAttribute("fill-opacity",t.fillOpacity||1),e.setAttribute("stroke",t.strokeColor||"none"),e},DimensionUtil.makeText=function(t){var e=document.createElementNS(DimensionUtil.xmlns,"text");e.setAttribute("x",t.x),e.setAttribute("y",t.y),e.setAttribute("fill",t.color||"#000"),e.setAttribute("font-size",t.fontsize);var i=t.content?t.content.split("\n"):[""];if(i.length>1)for(let o=0;o<i.length;o++){var n=document.createElementNS(DimensionUtil.xmlns,"tspan");n.setAttribute("x",t.x),n.setAttribute("y",t.y+30*o),n.textContent=i[o],e.appendChild(n)}else e.textContent=i[0];return e},DimensionUtil.measureText=function(t,e='14px "Microsoft YaHei'){var i=document.createElement("canvas").getContext("2d");return i.font=e,i.measureText(t).width},DimensionUtil.distanceToSegment=function(t,e,i){var n=e.distanceToSquared(i);if(0==n)return t.distanceTo(e);var o=((t.x-e.x)*(i.x-e.x)+(t.y-e.y)*(i.y-e.y))/n;o=Math.max(0,Math.min(1,o));let s=new Vector2;return s.x=e.x+o*(i.x-e.x),s.y=e.y+o*(i.y-e.y),t.distanceTo(s)};class DimensionNotation{constructor(t){this.type=t}initialize(){this.notationSelected=[],this.notationUnselected=[],this.notationSegmentRects=[]}drawAnnotation(t,e){}calcAnnotationStyle(t,e){}select(){this.isInitialized()&&(this.notationUnselected.forEach((t=>{t.style.display="none"})),this.notationSelected.forEach((t=>{t.style.display="block"})))}unselect(){this.isInitialized()&&(this.notationUnselected.forEach((t=>{t.style.display="block"})),this.notationSelected.forEach((t=>{t.style.display="none"})))}dropShadow(t){this.isInitialized()&&this.notationUnselected.forEach((e=>{e.setAttribute("filter",t),e.setAttribute("filter",t)}))}isInitialized(){return!!this.notationUnselected&&!!this.notationSelected}clear(){this.notationSelected=[],this.notationUnselected=[],this.notationSegmentRects=[]}hitTest(t){if(!this.isInitialized())return!1;let e=this.hitTestEpsilon;return this.notationSegmentRects.some((i=>DimensionUtil.distanceToSegment(t,i.start,i.end)<=e))}}class DimensionViewer3dNotation extends DimensionNotation{constructor(t){super(t),this.defaultColor="#F99D0B",this.defaultOpacity=1,this.initialize()}initialize(){super.initialize(),this.annotationStyle={height:21,radius:4},this.hitTestEpsilon=this.annotationStyle.height/2}drawAnnotation(t,e,i,n,o){var s=this.calcAnnotationStyle(e,t),r=DimensionUtil.makeRectangle({x:s.offsetRect.x,y:s.offsetRect.y,width:s.width,height:this.annotationStyle.height,radius:this.annotationStyle.radius,fillColor:n||this.defaultColor,fillOpacity:o||this.defaultOpacity});this.notationUnselected.push(r);let a=DimensionUtil.makeRectangle({x:s.offsetRect.x-2,y:s.offsetRect.y-2,width:s.width+4,height:this.annotationStyle.height+4,radius:this.annotationStyle.radius,strokeColor:"#FFFFFF",fillColor:n||this.defaultColor,fillOpacity:o||this.defaultOpacity});this.notationSelected.push(a);let l=new Vector2(s.offsetRect.x,s.offsetRect.y+this.annotationStyle.height/2),h=new Vector2(s.offsetRect.x+s.width,l.y);this.notationSegmentRects.push({start:l,end:h});var c=DimensionUtil.makeText({x:s.offsetText.x,y:s.offsetText.y,color:"#FFFFFF",fontsize:14,content:e});return this.svgGroup=[],this.svgGroup.push(r),this.svgGroup.push(a),this.svgGroup.push(c),this.unselect(),this.svgGroup}calcAnnotationStyle(t,e){var i=0,n=new Vector2(e.x,e.y),o=new Vector2(e.x,e.y);return i=DimensionUtil.measureText(t),n.x-=i/2,n.y-=this.annotationStyle.height/2,o.x=n.x+5,o.y=n.y+19-3.5,{offsetRect:n,offsetText:o,width:i+=10}}}!function(){Glodon$1.Bimface.Data.StatisticsDataManager.getInstance();let t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Dimension");t.DrawableItem=class{constructor(t){this.viewer=t.viewer,this.id=Glodon$1.Web.Lang.Utility.UUID.createUUID(),t.color&&(t.color instanceof Glodon$1.Web.Graphics.Color||(console.log("ERROR::color should be instance of Glodon.Web.Graphics.Color"),t.color=null)),this.defaultColor=t.color?"#"+t.color.getHEX():"#F99D0B",this.defaultOpacity=t.color?t.color.getAlpha():1,this.isShow=!0,this.svgGroup=[],this.lineWidth="3",this.radius=5,this.strokeWidth=2,this.hitTestEpsilon=10,this.hitTestSegments=[],this.selectElements=[],this.unSelectElements=[],this.isSelected=!0,this.notation=new DimensionViewer3dNotation(this.type),this.unitObj={Kilometer:"km",Meter:"m",Centimeter:"cm",Millimeter:"mm"}}getSvgGroup(){return this.svgGroup}getId(){return this.id}getType(){return this.type}clear(){this.detach(),this.notation.clear(),this.svgGroup=[],this.hitTestSegments=[]}detach(){for(const e of this.svgGroup){var t=e.parentNode;t&&t.removeChild(e)}}attach(t){for(const e of this.svgGroup)t.appendChild(e)}calcLine(t,e){let i=[];var n=this.viewer.getViewer(),o=this.viewer.getDomElement().getBoundingClientRect(),s=n.worldPointsToClient(t,e);if(s){t=new Vector2(s.start.x-o.left,s.start.y-o.top),e=new Vector2(s.end.x-o.left,s.end.y-o.top);i.push(t,e)}return i}calcTerminalLines(t,e,i){if(0===t.length)return[];let n=[],o=t[0],s=t[1],r=o.clone().sub(s).normalize(),a=r.clone().multiplyScalar(i).add(o).rotateAround(o.clone(),e),l=r.clone().multiplyScalar(i).add(o).rotateAround(o.clone(),-e);n.push({start:a,end:l}),r=r.multiplyScalar(-1);let h=r.clone().multiplyScalar(i).add(s).rotateAround(s.clone(),e),c=r.clone().multiplyScalar(i).add(s).rotateAround(s.clone(),-e);return n.push({start:h,end:c}),n}select(){for(const t of this.selectElements)t.style.display="none";for(const t of this.unSelectElements)t.style.display="block";this.notation.select(),this.isSelected=!0}unselect(){for(const t of this.selectElements)t.style.display="block";for(const t of this.unSelectElements)t.style.display="none";this.notation.unselect(),this.isSelected=!1}getIsSelected(){return this.isSelected}actionWhenSelected(){}actionWhenUnselected(){}dropShadow(t){this.notation.dropShadow(t)}show(){for(const t of this.svgGroup)t.style.display="block";this.isSelected?this.select():this.unselect(),this.isShow=!0}hide(){for(const t of this.svgGroup)t.style.display="none";this.isShow=!1}getNotation(){return this.notation}hitTest(t){let e=this.hitTestEpsilon;for(let i=0;i<this.hitTestSegments.length-1;i++){if(DimensionUtil.distanceToSegment(t,this.hitTestSegments[i],this.hitTestSegments[i+1])<=e)return!0}return!1}}}(),function(){var t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Dimension");t.LinearConfig=class{constructor(){this.color=null,this.viewer=null}}}(),function(){Glodon$1.Bimface.Data.StatisticsDataManager.getInstance();let t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Dimension"),e=Glodon$1.Bimface.Plugins.Dimension.DrawableItem;t.Linear=class extends e{constructor(t){super(t),this.viewer=t.viewer,this.color=t.color,this.type="Linear",this.selectElements=[],this.unSelectElements=[]}initialize(){if(!this.worldPositions)return;let t=this.calcLine(this.worldPositions[0],this.worldPositions[1]);this.hitTestSegments=t;let e=this.calAuxLines(),i=this.calcTerminalLines(t,Math.PI/2,6.5);this.attachSingleLine(t),this.attachTerminalLines(i),this.attachTerminalPoints([e[0].start,e[2].end]);let n={x:(this.worldPositions[0].x+this.worldPositions[1].x)/2,y:(this.worldPositions[0].y+this.worldPositions[1].y)/2,z:(this.worldPositions[0].z+this.worldPositions[1].z)/2},o=this.viewer.worldToClient(n);this.viewer.isInViewFrustum(n)&&(this.attachNotation([o,o]),this.unselect())}attachTerminalPoints(t){for(const e of t){let t=DimensionUtil.makeCircle({position:e,radius:this.radius,strokeWidth:this.strokeWidth,color:this.defaultColor});this.svgGroup.push(t),this.unSelectElements.push(t)}}attachSingleLine(t){if(0===t.length)return;let e=DimensionUtil.makeLine({start:t[0],end:t[1],color:this.defaultColor,lineWidth:this.lineWidth});this.svgGroup.push(e)}attachTerminalLines(t){if(0!==t.length)for(let e=0;e<2;e++){let i=DimensionUtil.makeLine({start:t[e].start,end:t[e].end,color:this.defaultColor,lineWidth:2});this.selectElements.push(i),this.svgGroup.push(i)}}attachAuxLines(t,e){let i=0;for(const n of t){let t=DimensionUtil.makeLine({start:n.start,end:n.end,color:this.defaultColor,lineWidth:this.lineWidth});t.setAttribute("stroke-dasharray","6,4"),t.style.stroke=e[i++],this.unSelectElements.push(t),this.svgGroup.push(t)}}attachNotation(t){if(0===t.length)return;let e=this.notation.drawAnnotation({x:(t[0].x+t[1].x)/2,y:(t[0].y+t[1].y)/2},this.showText,this.id,this.defaultColor,this.defaultOpacity);for(const t of e)this.svgGroup.push(t)}calAuxLines(){let t=this.worldPositions;for(var e=this.viewer.getDomElement().getBoundingClientRect(),i={x:t[1].x,y:t[0].y,z:t[0].z},n={x:t[1].x,y:t[1].y,z:t[0].z},o=[],s=[t[0],i,n,t[1]],r=this.viewer.getViewer(),a=0;a<s.length-1;a++){var l=r.worldPointsToClient(s[a],s[a+1]);if(l)l.start.x-=e.left,l.start.y-=e.top,l.end.x-=e.left,l.end.y-=e.top;else{l={start:{x:-1,y:-1},end:{x:-1,y:-1}}}o.push(l)}return o}show(){super.show()}hide(){super.hide()}setContent(t){this.content=t,this.worldPositions=t.dimension.points,this.showText=t.dimension.text?t.dimension.text:t.dimension.distance+" "+(this.unitObj[t.dimension.unit]||""),this.initialize()}getItemId(){return this.id}}}(),function(){Glodon$1.Bimface.Data.StatisticsDataManager.getInstance();let t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Dimension"),e=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.Dom");t.DimensionContainer=class{constructor(t){var i=t.viewer;if(i){this.viewer=i,this._items=[];var n=e.create("div","bf-dimension-context"),o=e.createNS("svg","bf-dimension-svg");i.getDomElement().appendChild(n),n.appendChild(o),this.eventControl=new DimensionEventControl(i,o,this._items),this.context={rootDomElement:n,dimensionContainer:o},this.dimensionContainer=o,this.id="Dimension",this.viewer.addEventListener("Rendered",(()=>{this.update()})),this.viewer.render(),t.contents&&t.contents.length>0&&this.initDimensions(t.contents)}}initDimensions(t){t.map((t=>{if("Distance"==t.dimension.type){let e=new Glodon$1.Bimface.Plugins.Dimension.LinearConfig;e.viewer=this.viewer;let i=new Glodon$1.Bimface.Plugins.Dimension.Linear(e);i.setContent(t),this.addItem(i)}}))}addItem(t){this._items.push(t),t.attach(this.dimensionContainer)}addItems(t){t.map((t=>this.addItem(t)))}getAllItems(){return this._items}getItemById(t){let e=null;return this._items.map((i=>{i.id!=t||(e=i)})),e}hideAllItems(){this._items.map((t=>t.hide()))}showAllItems(){this._items.map((t=>t.show()))}update(){this.remove();for(const t of this._items)t.initialize(),t.attach(this.dimensionContainer),!t.isShow&&t.hide();this.eventControl.hasSelected()&&(this.eventControl.getSelectedItem().select(),!this.eventControl.getSelectedItem().isShow&&this.eventControl.getSelectedItem().hide())}clear(){this.remove(),this._items=[]}remove(){for(const t of this._items)t.clear()}}}();class ExplosionHelper{constructor(){}}ExplosionHelper.ifExploded=function(t,e,i){let n="ViewerDrawing"===t.getViewerType(),o="ViewerDrawingSet"===t.getViewerType();if(n||o||e instanceof Glodon.Bimface.Plugins.Drawable.ClusterTag)return e;const s=t.getViewer();if(!s.modelManager)return e;const r=s.modelManager.explosionManager;let a=e.modelId;if(i&&e.layerId){const i=t.getLayerManager().getLayer(e.layerId);if(!i)return e;if("TileLayer"===i.typeName||"TilesetLayer"===i.typeName)return e;a=i.getModelId().toString()}else{if(i&&!e.layerId)return e;a||(a=t._defaultModel.modelId.toString())}e.modelId=a;const l=t.getModel(a).getFloorExplosionDirection(),h=r.getFloorInfos(a),c=s.modelManager.getModel(a).modelExplosion;let d=()=>{if(h&&r.isExploded(a)){let t=e.worldPosition||e.getOriginalPosition(),i=c.getExplosionTranslationByObjId(e.objectId);const n=r.getExplosionParam(a).explosionExtent;if(!e.objectId&&n>0&&(i=this.getCenterExplosionOffset(s,n,e,!0)),i.length()>0){const n={x:t.x-i.x,y:t.y-i.y,z:t.z-i.z};return e.explosionOffset={x:i.x,y:i.y,z:i.z},e.originalPosition?e.originalPosition=n:e.worldPosition=n,e}if(e.levelName){let i=this.getExplodedOffsetByLevelName(h,e.levelName);if(i){const n={x:t.x-i*l.x,y:t.y-i*l.y,z:t.z-i*l.z};e.explosionOffset={x:i*l.x,y:i*l.y,z:i*l.z},e.originalPosition?e.originalPosition=n:e.worldPosition=n}}else this.setDrawableOffsetByFloorInfos(h,e,l)}return e};if(e._config.objectId){let t=s.getComponentInfoByUserId(e._config.objectId);if(t)return e.levelName=t.userData&&t.userData.levelName,d();{if(i)return e;const t=s.modelManager.getModel("ExtrudeBodyManager");return t&&t.getNode(e._config.objectId)&&(e._isBindRoom=!0),e}}return d()},ExplosionHelper.getExplodedOffsetByLevelName=function(t,e){for(const i of t)if(i.name===e)return i.explodedHeight-i.elevation;return 0},ExplosionHelper.setDrawableOffsetByFloorInfos=function(t,e,i){let n=e.worldPosition||e.getOriginalPosition();for(const o of t){const t=o.explodedHeight-o.elevation,s=o.boundingBox;if(n.z-t<s.min.z&&n.z-t>s.max.z)continue;e.levelName=o.name;const r={x:n.x-t*i.x,y:n.y-t*i.y,z:n.z-t*i.z};e.originalPosition?e.originalPosition=r:e.worldPosition=r,e.explosionOffset={x:i.x*t,y:i.y*t,z:i.z*t}}},ExplosionHelper.attachExplosionOffset=function(t,e,i){if(!i.worldPosition&&!i.position)return;const n=i._config.objectId;let o=null;if(n){o=t.modelManager.getModel(i.modelId).modelExplosion.getExplosionTranslationByObjId(n),i.explosionOffset.x+=o.x,i.explosionOffset.y+=o.y,i.explosionOffset.z+=o.z}else o=this.getCenterExplosionOffset(t,e,i),i.explosionOffset.x=o.x,i.explosionOffset.y=o.y,i.explosionOffset.z=o.z},ExplosionHelper.getCenterExplosionOffset=function(t,e,i,n){this.scratchVector=new THREE.Vector3,t.getScene().getOriginalBoundingBoxWorld().getCenter(this.scratchVector);const o=(new THREE.Box3).expandByPoint(i.worldPosition||i.getOriginalPosition());return!0===n?CLOUD.Utils.computeAfterExplodeTranslation(this.scratchVector,o,e):CLOUD.Utils.computeExplodeTranslation(this.scratchVector,o,e)},Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Drawable").DrawableContainerConfig=function(){return{viewer:null,maxNum:20,affectedBySection:!0,enableRender:!0}},Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Drawable").DrawableItemConfig=function(){return{id:null,objectId:null,modelId:null,tooltip:"",tooltipStyle:{},draggable:!1,worldPosition:new Glodon$1.Web.Geometry.Point3d(0,0,0),angle:0,layerId:void 0}},function(){var t="Bimface.Plugins.Drawable.DrawableItem",e=Glodon$1.Bimface.Data.StatisticsDataManager.getInstance();let i=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Drawable"),n=(Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.Dom"),Glodon$1.Web.Common.MouseButton,function(t){this.id=t.id||Glodon$1.Web.Lang.Utility.UUID.createUUID(),this.layerId=t.layerId,this.modelId=t.modelId,this.objectId=t.objectId,t.worldPosition?this.worldPosition=t.worldPosition:console.log("worldPosition must not be empty."),null!=t.viewerDrawingId&&(this.viewerDrawingId=t.viewerDrawingId),this.config=t,this.angle=t.angle,this.explosionOffset=new Vector3,this.explosionExtent=0,this._enableDepthTest=t.enableDepthTest,this._isCover=!1,this._enableDepthTestCallback=null});n.prototype={draw:function(t){},onClick:function(i){e.send(t,"onClick"),this._onclick=i},onDoubleClick:function(i){e.send(t,"onClick"),this._doubleClick=i},onRightClick:function(i){e.send(t,"onRightClick"),this._onrightclick=i},onEndDrag:function(i){e.send(t,"onEndDrag"),this._onenddrag=i},setTooltip:function(i){e.send(t,"setTooltip"),this.tipElement.querySelector("span").innerText=i},setTooltipStyle:function(i){for(var n in e.send(t,"setTooltipStyle"),i)this.tipElement.style[n]=i[n]},getTooltip:function(){return this.tipElement.querySelector("span").innerText},getTooltipStyle:function(){return this.tipElement.style},getWorldPosition:function(){return this.worldPosition},setWorldPosition:function(i){e.send(t,"setWorldPosition"),this.worldPosition=i},getSize:function(){return{width:this.config.width,height:this.config.height}},hide:function(){e.send(t,"hide"),this._domElement.style.display="none",this.notControlByCameraPosition=!0,this.forceHide=!0},hideByCameraPosition:function(){this.notControlByCameraPosition||(this._domElement.style.display="none",this.forceHide=!0)},show:function(){e.send(t,"show"),this.notControlByCameraPosition=!1,this.visibleDistance?this.viewer.drawableContainer.showOrHideLabelForCamearPosition():(this._domElement.style.display="",this.forceHide=!1)},showByCameraPosition:function(){this.forceHide&&(this.notControlByCameraPosition||(this._domElement.style.display="",this.forceHide=!1))},updateVisibility:function(){this.isHideByClustering||this.forceHide?this._domElement.style.display="none":this._domElement.style.display="block"},attachExplosionOffset:function(t,e){if(!this.worldPosition)return;let i=this._config.objectId;if(i){let n={};n[i]=!0;let o=t.modelManager.getBoundingBoxByIds(n),s=this.assoiatedComponentBbox,r=o;if(s){let t=r.getCenter().clone();t.sub(s.getCenter().clone()),this.explosionOffset=t,this.explosionExtent>0&&0===e&&(this.worldPosition.x+=t.x,this.worldPosition.y+=t.y,this.worldPosition.z+=t.z,this.explosionExtent=0,this.explosionOffset=new Vector3,this.assoiatedComponentBbox=r.clone())}}else{let i=t.getScene().getOriginalBoundingBoxWorld().getCenter(),n=(new Box3).expandByPoint(this.worldPosition),o=CLOUD.Utils.computeExplodeTranslation(i,n,e);this.explosionOffset=o}},setInitialExplosionInfo:function(t){if("Viewer3D"!==t.getViewerType()&&"ViewerGIS"!==t.getViewerType())return;let e=null;"Viewer3D"===t.getViewerType()?e=this.modelId?t.getModel(this.modelId):t.getDefaultModel():"ViewerGIS"===t.getViewerType()&&(e=t.getLayerManager().getLayer(this.layerId)||null),this.explosionExtent=null===e?0:e.getExplosionExtent();const i=this._config.objectId;if(!i)return;let n=t.getViewer(),o={};o[i]=!0,n.modelManager.getBoundingBoxByIds(o).isEmpty()&&(this._config.objectId=null,console.log("Cannot find component with Id "+i))},clearExplosionOffset:function(){this.explosionOffset=new Vector3},getCurrentPosition:function(){return{x:this.worldPosition.x+this.explosionOffset.x,y:this.worldPosition.y+this.explosionOffset.y,z:this.worldPosition.z+this.explosionOffset.z}},getId:function(){return this.id},handleEnableDepthTest(t){if(!this._enableDepthTest||!this.viewer)return;if("Viewer3D"!==this.viewer.getViewerType()&&"ViewerGIS"!==this.viewer.getViewerType())return;if("LeadLabel"==this.name&&this._modelId&&this._objectId&&"Viewer3D"==this.viewer.getViewerType()){this.update&&this.update();let t=this.viewer.getModel(this._modelId).getComponentStatus(this._objectId);if("hidden"==t||"translucent"==t)return void(this._isCover=!1)}!t&&(t=this.viewer.getCameraStatus().position);let e=new THREE.Vector3(...Object.values(t)),i=new THREE.Vector3(...Object.values(this.worldPosition));const n=i.clone().sub(e).normalize(),o=this.viewer.getViewer().getComponentsByRaycaster(e,n,[]);let s=o.length>0?o[0].distance:i.clone().sub(e).length(),r=1;switch(this.viewer.getUnit()){case Glodon$1.Bimface.Common.Units.LengthUnits.Kilometer:r=1e-6;break;case Glodon$1.Bimface.Common.Units.LengthUnits.Meter:r=.001;break;case Glodon$1.Bimface.Common.Units.LengthUnits.Centimeter:r=.1;break;case Glodon$1.Bimface.Common.Units.LengthUnits.Millimeter:r=1}let a=i.clone().sub(e).length()>=s+r;this._isCover!=a&&this._enableDepthTestCallback&&this._enableDepthTestCallback(a),this._isCover=a},enableDepthTest:function(t){this._enableDepthTest=t,this.handleEnableDepthTest()},isDepthTestEnabled:function(){return this._enableDepthTest},onObstructionChanged:function(t){this._enableDepthTestCallback=t,this._enableDepthTest&&(this.handleEnableDepthTest(),t(this._isCover))}},i.DrawableItem=n}(),function(){let t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Drawable"),e=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.Dom"),i=function(){this.rootDomElement=e.create("div","bf-drawable-context"),this.clientPosition=null};i.prototype.destroy=function(){this.rootDomElement.parentNode&&this.rootDomElement.parentNode.removeChild(this.rootDomElement)},t.DrawableContext=i}(),function(){let t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Drawable"),e=new Glodon$1.Bimface.Plugins.Drawable.DrawableItemConfig;t.ImageConfig=function(){let t={width:32,height:32,viewer:null,opacity:.75,src:null,offsetX:0,offsetY:0,modelId:void 0,layerId:void 0,objectId:void 0,visibleDistance:null,enableDepthTest:!1};return Object.assign({},e,t)}}(),function(){var t="Bimface.Plugins.Drawable.Image",e=Glodon$1.Bimface.Data.StatisticsDataManager.getInstance();let i=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Drawable"),n=Glodon$1.Bimface.Plugins.Drawable.DrawableItem,o=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.Dom"),s=function(t){n.call(this,t);let e=this;this.viewer=t.viewer,this._isDragging=!1,this._isViewerGIS=Glodon$1.Bimface.Viewer.ViewerGIS&&this.viewer instanceof Glodon$1.Bimface.Viewer.ViewerGIS;let i=o.create("div","bf-drawable-text"),s=o.create("img","bf-drawable-image");i.draggable=!1,s.src=t.src,s.style.width=`${t.width}px`,s.style.height=`${t.height}px`,s.style.opacity=`${t.opacity}`,s.style.transform=`rotate(${t.angle}deg)`,i.appendChild(s),this._config=t,this._domElement=i,this._imgElement=s;let r=o.create("div","bf-tooltip tooltipTop");r.style.display="none",r.innerHTML=`<div class="bf-tooltip-content"><div class="bf-tooltip-arrow"></div><div class="bf-tooltip-inner"><span>${t.tooltip}</span></div></div>`,r.style.left=`${t.tooltipStyle.left}`,r.style.top=`${t.tooltipStyle.top}`;var a,l=t.tooltipStyle;for(var h in l)r.style[h]=l[h];this.tipElement=r,i.appendChild(r),this.clientPosition={},this.visibleDistance=t.visibleDistance;t.draggable&&o.drag({element:i,cursor:"pointer",end:function(t){e._isDragging=!1;var i,n=e.viewer,o="Viewer3D"===n.getViewerType(),s="ViewerGIS"===n.getViewerType(),r={x:t.x-a.x+e.clientPosition.x,y:t.y-a.y+e.clientPosition.y};if(o){var l=n.pickByPoint(r);if(!l||!l.objectId)return void e.update();if(l.objectId){e._config.objectId=l.objectId;let t=n.getViewer().getComponentInfoByUserId(l.objectId);e.levelName=t&&t.userData&&t.userData.levelName,e.setInitialExplosionInfo(n),e.clearExplosionOffset(),e.needForceUpdate=!0}i=l.worldPosition}else if(s){let t=n.getDomElement().getBoundingClientRect(),i=n.getViewer().pickByPoint({x:r.x+t.left,y:r.y+t.top});if(!i||!i.meshId)return void e.update();i.meshId&&(e._config.objectId=i.meshId),e.worldPosition=i.worldPosition}else i=n.clientToWorld(r);i?(e.worldPosition=i,e.update(),e._onenddrag&&e._onenddrag(e)):e.update()},start:function(t){a=t},move:function(){e._isDragging=!0}}),i.addEventListener("mouseup",(function(t){var i=t||window.event;"0"==i.button&&e._onclick&&(!e._isDragging||a.x==i.clientX&&a.y==i.clientY)&&(e.clickTimerId&&clearTimeout(e.clickTimerId),e.clickTimerId=setTimeout((()=>{e._onclick(e)}),500))})),i.addEventListener("mousedown",(function(t){var i=t||window.event;i.stopPropagation(),"2"==i.button&&e._onrightclick?e._onrightclick(e):"1"==i.button&&e._onmiddleclick&&e._onmiddleclick(e)})),i.addEventListener("mouseover",(function(t){r&&r.querySelector("span").innerText.length>0&&(r.style.display="block")})),i.addEventListener("mouseout",(function(t){e.tipElement&&(e.tipElement.style.display="none")})),i.addEventListener("dblclick",(function(t){(t=t||event).stopPropagation(),e._doubleClick&&e._doubleClick(e),e.clickTimerId&&clearTimeout(e.clickTimerId)}))};Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility").Type.inheritPrototype(s,n);!function(t,e){var i=e.prototype;for(var n in t)i[n]=t[n]}({draw:function(t){if(!this._isDragging){var e=this._domElement,i=this._config;this.clientPosition=t.clientPosition,e.style.left=t.clientPosition.x+i.offsetX-i.width/2+"px",e.style.top=t.clientPosition.y+i.offsetY-i.height/2+"px",t.rootDomElement.contains&&t.rootDomElement.contains(e)||t.rootDomElement.appendChild(e)}},getWidth:function(){return this._config.width},setWidth:function(i){e.send(t,"setWidth");var n=this._config.width,o=this._imgElement,s=(n-i)/2,r=parseInt(o.style.left);this._config.width=i,o.style.width=`${i}px`,o.style.left=`${r+s}px`},getHeight:function(){return this._config.height},setHeight:function(i){e.send(t,"setHeight");var n=this._config.height,o=this._imgElement,s=(n-i)/2,r=parseInt(o.style.top);this._config.height=i,o.style.height=`${i}px`,o.style.top=`${r+s}px`},getOpacity:function(){return this._config.opacity},setOpacity:function(i){e.send(t,"setOpacity"),this._config.opacity=i,this._imgElement.style.opacity=i},getSrc:function(){return this._config.src},setSrc:function(i){e.send(t,"setSrc"),this._config.src=i,this._imgElement.src=i},getOffsetX:function(){return this._config.offsetX},setOffsetX:function(i){e.send(t,"setOffsetX");var n=this._config.offsetX,o=this._domElement,s=i-n,r=parseInt(o.style.left);this._config.offsetX=i,o.style.left=`${r+s}px`},getOffsetY:function(){return this._config.offsetY},setOffsetY:function(i){e.send(t,"setOffsetY");var n=this._config.offsetY,o=this._domElement,s=i-n,r=parseInt(o.style.top);this._config.offsetY=i,o.style.top=`${r+s}px`},getAngle:function(){return this.angle},setAngle:function(i){e.send(t,"setAngle"),this.angle=i,this._imgElement.style.transform=`rotate(${i}deg)`},getVisibleDistance:function(){return this.visibleDistance},setVisibleDistance:function(t){this.visibleDistance=t,this.viewer.drawableContainer.showOrHideLabelForCamearPosition()},enableDepthTest:function(t){n.prototype.enableDepthTest.call(this,t)},isDepthTestEnabled:function(){return n.prototype.isDepthTestEnabled.call(this)},onObstructionChanged:function(t){n.prototype.onObstructionChanged.call(this,t)}},s),i.Image=s}(),function(){let t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Drawable"),e=new Glodon$1.Bimface.Plugins.Drawable.DrawableItemConfig;t.CustomItemConfig=function(){let t={width:0,height:0,opacity:.75,content:"",offsetX:0,offsetY:0,viewer:null,modelId:void 0,layerId:void 0,objectId:void 0,visibleDistance:null,enableDepthTest:!1};return Object.assign({},e,t)}}(),function(){var t="Bimface.Plugins.Drawable.CustomItem",e=Glodon$1.Bimface.Data.StatisticsDataManager.getInstance();let i=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Drawable"),n=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins"),o=Glodon$1.Bimface.Plugins.Drawable.DrawableItem,s=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.Dom"),r=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility");n.IE11Store={};let a=function(t){o.call(this,t),this._isDragging=!1,this.viewer=t.viewer;let e=this,i=Glodon$1.Web.Lang.Utility.ClientHelper.getIsDesktop(),n=Glodon$1.Bimface.Viewer.ViewerDrawing&&t.viewer instanceof Glodon$1.Bimface.Viewer.ViewerDrawing,r=s.create("div","bf-drawable-text");r.style.width=`${t.width}px`,r.style.height=`${t.height}px`;let a=s.create("div","bf-drawable-contentwrap");var l;r.appendChild(a),this._domElement=r,this.name="customItem",this._contentElement=a,this._config=t,this.clientPosition={},this.visibleDistance=t.visibleDistance,this.setContent(t.content);let h=s.create("div","bf-tooltip");h.style.display="none",h.innerHTML=`<div class="bf-tooltip-content"><div class="bf-tooltip-arrow"></div><div class="bf-tooltip-inner"><span>${t.tooltip}</span></div></div>`,h.style.left=`${t.width}px`,h.style.top=`-${t.height}px`;var c=t.tooltipStyle;for(var d in c)h.style[d]=c[d];this.tipElement=h,r.appendChild(h);t.draggable&&s.drag({element:r,cursor:"pointer",end:function(t){e._isDragging=!1;var i,o=e.viewer,s=Glodon$1.Bimface.Viewer.Viewer3D&&"Viewer3D"===o.viewerType,r=Glodon$1.Bimface.Viewer.ViewerGIS&&o instanceof Glodon$1.Bimface.Viewer.ViewerGIS,a={x:t.x-l.x+e.clientPosition.x,y:t.y-l.y+e.clientPosition.y};if(s){let t=o.getDomElement().getBoundingClientRect(),n=o.pickByPoint({x:a.x+t.left,y:a.y+t.top});if(!n||!n.objectId)return void e.update();if(n.objectId){e._config.objectId=n.objectId;let t=o.getViewer().getComponentInfoByUserId(n.objectId);e.levelName=t&&t.userData&&t.userData.levelName,e.setInitialExplosionInfo(o),e.clearExplosionOffset(),e.needForceUpdate=!0}i=n.worldPosition}else if(r){let t=o.getDomElement().getBoundingClientRect(),n=o.getViewer().pickByPoint({x:a.x+t.left,y:a.y+t.top});if(!n||!n.meshId)return void e.update();n.meshId&&(e._config.objectId=n.meshId),i=n.worldPosition}else if(n){var h=o.getViewer().toWorldPoint([a.x,a.y]);i={x:h[0],y:h[1]}}else i=o.clientToWorld(a);i?(e.worldPosition=i,e.update(),e._onenddrag&&e._onenddrag(e)):e.update()},start:function(t){l=t},move:function(){e._isDragging=!0}}),r.style.width=`${t.width}px`,r.style.height=`${t.height}px`,r.style.opacity=`${t.opacity}`,r.addEventListener("mouseover",(function(t){e.tipElement&&e.tipElement.querySelector("span").innerText.length>0&&(e.tipElement.style.display="block")})),r.addEventListener("mouseout",(function(t){e.tipElement&&(e.tipElement.style.display="none")})),r.addEventListener("keydown",(function(t){t.stopPropagation()})),i&&r.addEventListener("mouseup",(function(t){var i=t||window.event;"0"==i.button&&e._onclick&&(!e._isDragging||l.x==i.clientX&&l.y==i.clientY)&&(e.clickTimerId&&clearTimeout(e.clickTimerId),e.clickTimerId=setTimeout((()=>{e._onclick(e)}),500))})),r.addEventListener("mousedown",(function(t){var i=t||window.event;i.stopPropagation(),"2"==i.button&&e._onrightclick?e._onrightclick(e):"1"==i.button&&e._onmiddleclick&&e._onmiddleclick(e)})),r.addEventListener("dblclick",(function(t){(t=t||event).stopPropagation(),e._doubleClick&&e._doubleClick(e),e.clickTimerId&&clearTimeout(e.clickTimerId)})),r.addEventListener("touchstart",(function(t){(t||window.event).stopPropagation()})),r.addEventListener("touchmove",(function(t){(t||window.event).stopPropagation()})),!i&&r.addEventListener("touchend",(function(i){var n=i||window.event;n.stopPropagation(),e._onclick&&(!t.draggable||l.x==n.changedTouches[0].clientX&&l.y==n.changedTouches[0].clientY)&&e._onclick(e)}))};r.Type.inheritPrototype(a,o);!function(t,e){var i=e.prototype;for(var n in t)i[n]=t[n]}({draw:function(t){if(!this._isDragging){var e=this._domElement,i=this._config;this.clientPosition=t.clientPosition,e.style.left=t.clientPosition.x+i.offsetX-i.width/2+"px",e.style.top=t.clientPosition.y+i.offsetY-i.height/2+"px",""==e.innerHTML&&(this.dom&&this.domId?e.appendChild(n.IE11Store[this.domId].cloneNode(!0)):this.text&&(e.innerText=this.text)),t.rootDomElement.contains&&t.rootDomElement.contains(e)||t.rootDomElement.appendChild(e)}},getWidth:function(){return this._config.width},setWidth:function(i){e.send(t,"setWidth");var n=this._config.width,o=this._domElement,s=(n-i)/2,r=parseInt(o.style.left);this._config.width=i,o.style.width=`${i}px`,o.style.left=`${r+s}px`},getHeight:function(){return this._config.height},setHeight:function(i){e.send(t,"setHeight");var n=this._config.height,o=this._domElement,s=(n-i)/2,r=parseInt(o.style.top);this._config.height=i,o.style.height=`${i}px`,o.style.top=`${r+s}px`},getOpacity:function(){return this._config.opacity},setOpacity:function(i){e.send(t,"setOpacity"),this._config.opacity=i,this._domElement.style.opacity=i},getContent:function(){return this._config.content||this.text},setContent:function(i){e.send(t,"setContent"),this._contentElement.innerHTML="",i instanceof HTMLElement?(i.draggable=!1,this._config.content=i,this._domElement.content=i,this.dom=i,this.domId||(this.domId=Glodon$1.Web.Lang.Utility.UUID.createUUID()),n.IE11Store[this.domId]=i.cloneNode(!0),this._contentElement.appendChild(i)):(this._contentElement.innerHTML=i,this.text=i,this._config.content="")},getOffsetX:function(){return this._config.offsetX},setOffsetX:function(i){e.send(t,"setOffsetX");var n=this._config.offsetX,o=this._domElement,s=i-n,r=parseInt(o.style.left);this._config.offsetX=i,o.style.left=`${r+s}px`},getOffsetY:function(){return this._config.offsetY},setOffsetY:function(i){e.send(t,"setOffsetY");var n=this._config.offsetY,o=this._domElement,s=i-n,r=parseInt(o.style.top);this._config.offsetY=i,o.style.top=`${r+s}px`},getVisibleDistance:function(){return this.visibleDistance},setVisibleDistance:function(t){this.visibleDistance=t,this.viewer.drawableContainer.showOrHideLabelForCamearPosition()},enableDepthTest:function(t){o.prototype.enableDepthTest.call(this,t)},isDepthTestEnabled:function(){return o.prototype.isDepthTestEnabled.call(this)},onObstructionChanged:function(t){o.prototype.onObstructionChanged.call(this,t)},resetClientPosition:function(t){const e=this._domElement,i=this._config;"Viewer3D"!==this.viewer.viewerType&&"ViewerGIS"!==this.viewer.viewerType||(t=this.viewer.worldToClient(t)),e.style.left=t.x+i.offsetX-i.width/2+"px",e.style.top=t.y+i.offsetY-i.height/2+"px"},getContainer:function(){return this._domElement},setContainerVisible(t){this._domElement.style.display=!0===t?"block":"none"}},a),i.CustomItem=a}(),function(){let t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Drawable"),e=new Glodon$1.Bimface.Plugins.Drawable.DrawableItemConfig;t.LeadLabelConfig=function(){let t={text:null,viewer:null,containerCss:{boxSizing:"border-box",fontSize:"12px",lineHeight:1.5,borderWidth:"2px",borderStyle:"solid",padding:"5px",borderColor:"#1f93ff",backgroundColor:"#eeeeee",padding:"2px 8px",opacity:.9},lineCss:{width:"2px",color:"#1f93ff"},pointCss:{radius:4,backgroundColor:"#1f93ff",borderColor:"#ffffff",borderStyle:"solid",borderWidth:"1px"},offset:{x:27,y:-47},height:26,width:140,modelId:void 0,layerId:void 0,objectId:void 0,visibleDistance:null,enableDepthTest:!1,style:{lineColor:new Glodon$1.Web.Graphics.Color(31,147,255,1),lineWidth:2,backgroundColor:new Glodon$1.Web.Graphics.Color(238,238,238,1),fontSize:12}};return Object.assign({},e,t)}}(),function(){var t="Bimface.Plugins.Drawable.LeadLabel",e=Glodon$1.Bimface.Data.StatisticsDataManager.getInstance();let i=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Drawable"),n=Glodon$1.Bimface.Plugins.Drawable.DrawableItem,o=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.Dom");var s=function(t){n.call(this,t);let e=this,i=Glodon$1.Web.Lang.Utility.ClientHelper.getIsDesktop(),s=o.create("div","bf-drawable-lead-label"),r=o.create("div","bf-drawable-lead-label-textarea");s.appendChild(r);let a=o.createNS("line","bf-drawable-lead-line"),l=o.createNS("line","bf-drawable-lead-line"),h=o.createNS("circle","bf-drawable-lead-point"),c=o.createNS("g","bf-drawable-group"),d=t.viewer;this.viewer=t.viewer,this._isViewerGIS=Glodon$1.Bimface.Viewer.ViewerGIS&&d instanceof Glodon$1.Bimface.Viewer.ViewerGIS,e._text=t.text,this.name="LeadLabel",this.isAssociateComponentHide=!1,this.visibleDistance=t.visibleDistance,s.setCss(t.containerCss),r.innerText=e._text.replace(/\n/g," ");let u=[s,a,l,h];this._labelCombination=u;let p=o.create("div","bf-tooltip");p.style.display="none",p.innerHTML=`<div class="bf-tooltip-content"><div class="bf-tooltip-arrow"></div><div class="bf-tooltip-inner"><span>${t.tooltip}</span></div></div>`,p.style.left="0px",p.style.top="0px";var g=t.tooltipStyle;for(var m in g)p.style[m]=g[m];this.tipElement=p,s.appendChild(p),s.style.width=parseFloat(t.width)+"px",s.style.minHeight=parseFloat(t.height)+"px";let f=Math.trunc((t.height-8)/18);var w;r.style.webkitLineClamp=f||1,l.setAttribute("stroke-width",t.lineCss.width),l.style.stroke=t.lineCss.color,a.setAttribute("stroke-width",t.lineCss.width),a.style.stroke=t.lineCss.color,h.setAttribute("r",t.pointCss.radius),h.style.fill=t.pointCss.backgroundColor,h.setAttribute("stroke-width",t.pointCss.borderWidth),h.style.stroke=t.pointCss.borderColor,l.setAttribute("x1",0),l.setAttribute("y1",0-t.offset.y+18),l.setAttribute("x2",t.offset.x),l.setAttribute("y2",18),a.setAttribute("x1",t.offset.x),a.setAttribute("y1",18),a.setAttribute("x2",t.offset.x+23),a.setAttribute("y2",18),h.setAttribute("cx",0),h.setAttribute("cy",18-t.offset.y),this.setStyle(t.style),this._isDragging=!1;t.draggable&&o.drag({element:s,cursor:"pointer",start:function(t){w=t},move:function(i){e._isDragging=!0;var n=i.x-w.x+e.clientPosition.x,o=i.y-w.y+e.clientPosition.y;c.setAttribute("transform",`translate(${n},${o+t.offset.y-18})`)},end:function(t){e._isDragging=!1;var i="Viewer3D"===d.viewerType,n=d.getDomElement().getBoundingClientRect(),o={x:t.x-w.x+e.clientPosition.x+n.left,y:t.y-w.y+e.clientPosition.y+n.top};if(i){var s=d.pickByPoint(o);if(s){if(e.setWorldPosition(s.worldPosition),e.bindComponentById(s.objectId,s.modelId),s.objectId){e._config.objectId=s.objectId,e._config.modelId=s.modelId;let t=d.getViewer().getComponentInfoByUserId(s.objectId,s.modelId);e.levelName=t&&t.userData&&t.userData.levelName,e.needForceUpdate=!0}e.setInitialExplosionInfo(d),e.clearExplosionOffset()}d.render()}else if(e._isViewerGIS){let t=d.getDomElement().getBoundingClientRect(),i=d.getViewer().pickByPoint({x:o.x+t.left,y:o.y+t.top});if(!i||!i.meshId)return void e.update();i.meshId&&(e._config.objectId=i.meshId),e.worldPosition=i.worldPosition}else{var r=d.clientToWorld(o);r&&e.setWorldPosition(r),d.update()}e._dragEnd&&e._dragEnd()}}),s.addEventListener("mousedown",(function(t){(t=t||event).stopPropagation()})),s.addEventListener("mouseover",(function(t){p&&p.querySelector("span").innerText.length>0&&(p.style.display="block")})),s.addEventListener("mouseout",(function(t){e.tipElement&&(e.tipElement.style.display="none")})),i&&s.addEventListener("click",(function(t){(t=t||event).stopPropagation(),e.clickTimerId&&clearTimeout(e.clickTimerId),e.clickTimerId=setTimeout((()=>{e._click&&e._click(e)}),500)})),!i&&s.addEventListener("touchstart",(function(){(event||window.event).stopPropagation(),e._click&&e._click(e)})),s.addEventListener("contextmenu",(function(t){e._rightClick&&e._rightClick(e)})),s.addEventListener("dblclick",(function(t){(t=t||event).stopPropagation(),e._doubleClick&&e._doubleClick(e),e.clickTimerId&&clearTimeout(e.clickTimerId)})),s.addEventListener("mouseenter",(function(t){r.innerText=e._text;let i=s.offsetHeight;s.addClass("bf-drawable-show"),r.addClass("bf-drawable-show"),i>s.offsetHeight&&(s.removeClass("bf-drawable-show"),r.removeClass("bf-drawable-show"))})),s.addEventListener("mouseleave",(function(t){r.innerText=e._text.replace(/\n/g," "),s.removeClass("bf-drawable-show"),r.removeClass("bf-drawable-show")})),c.appendChild(l),c.appendChild(a),c.appendChild(h),e._objectId=t.objectId,e._modelId=t.modelId,e._container=s,e._domTextArea=r,e._svgGroup=c,e._config=t,e._offset=t.offset};Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility").Type.inheritPrototype(s,n),s.prototype=Object.assign({},n.prototype,{draw:function(t,e){if(!this._isDragging){var i=this._container,n=this._svgGroup,s=this._offset,r=this._config.viewer,a=this._objectId,l=this._modelId;if(r&&a&&!this._isViewerGIS){var h=r.getModel(l).getComponentStatus(a);if("hidden"==h||"translucent"==h)return this.hide(),void(this.isAssociateComponentHide=!0);this.isAssociateComponentHide&&(this.show(),this.isAssociateComponentHide=!1)}!0!==this.isHideByClustering?(this.clientPosition=t.clientPosition,i.style.left=`${t.clientPosition.x+s.x+23}px`,i.style.top=t.clientPosition.y+s.y-18+"px",n.setAttribute("transform",`translate(${t.clientPosition.x},${t.clientPosition.y+s.y-18})`),t.domContainer||(t.domContainer=o.create("div","bf-drawable-container"),t.rootDomElement.appendChild(t.domContainer)),t.svgContainer||(t.svgContainer=o.createNS("svg","bf-drawable-svg"),t.rootDomElement.appendChild(t.svgContainer)),this.isShow("default"==e),t.rootDomElement.contains&&t.domContainer.contains(i)||(t.domContainer.appendChild(i),t.svgContainer.appendChild(n))):this.hide()}},setDisplayMode:function(t){this.show(),this.displayMode=t,this.isShow()},hide:function(){e.send(t,"hide"),this.forceHide=!0,this.notControlByCameraPosition=!0,this._container.style.display="none",this._svgGroup.style.display="none"},show:function(){e.send(t,"show"),this.notControlByCameraPosition=!1,this.visibleDistance?this.viewer.drawableContainer.showOrHideLabelForCamearPosition():(this.forceHide=!1,this._container.style.display="",this._svgGroup.style.display="")},hideByCameraPosition:function(){this.notControlByCameraPosition||(this.forceHide=!0,this._container.style.display="none",this._svgGroup.style.display="none")},showByCameraPosition:function(){!this.notControlByCameraPosition&&this.forceHide&&(this.forceHide=!1,this._container.style.display="",this._svgGroup.style.display="")},onClick:function(i){e.send(t,"onClick"),i&&(this._click=i)},onRightClick:function(i){e.send(t,"onRightClick"),i&&(this._rightClick=i)},onDoubleClick:function(t){t&&(this._doubleClick=t)},onEndDrag:function(i){e.send(t,"onEndDrag"),i&&(this._dragEnd=i)},getText:function(){return this._text},setText:function(i){e.send(t,"setText"),this._domTextArea.innerText=i,this._text=i},getOpacity:function(){return this._container.style.opacity},setOpacity:function(i,n){e.send(t,"setOpacity"),this._container.style.opacity=i},getHeight:function(){return parseFloat(this._container.style.height)},setHeight:function(i){e.send(t,"setHeight"),this._container.style.height=parseFloat(i)+"px";let n=Math.trunc((i-8)/18);this._domTextArea.style.webkitLineClamp=n||1},getWidth:function(){return parseFloat(this._container.style.width)},setWidth:function(i){e.send(t,"setWidth"),this._container.style.width=parseFloat(i)+"px"},getObjectId:function(){return this._objectId},associateComponentById:function(t,e){console.log("[BIMFACE WARN]: LeadLabel.associateComponentById() is obsolete, please use LeadLabel.bindComponentById() instead."),this.bindComponentById(t,e)},bindComponentById:function(t,e){let i=this._config.viewer.getViewer().getComponentInfoByUserId(t);i?(this.levelName=i.userData&&i.userData.levelName,this._objectId=t,this._config.objectId=t,this._modelId=e):console.warn("invalid component id")},clearAssociation:function(){console.log("LeadLabel.clearAssociation() is obsolete, please use LeadLabel.unbind() instead."),this.unbind()},unbind:function(){this._objectId=null,this._modelId=null},isShow:function(t){var e=this._container,i=this._svgGroup;null!=this.displayMode&&(t=1!==this.displayMode),t?(e.removeClass("bf-drawable-mini"),i.removeClass("bf-drawable-mini-svg")):(e.addClass("bf-drawable-mini"),i.addClass("bf-drawable-mini-svg"))},getVisibleDistance:function(){return this.visibleDistance},setVisibleDistance:function(t){this.visibleDistance=t,this.viewer.drawableContainer.showOrHideLabelForCamearPosition()},enableDepthTest:function(t){n.prototype.enableDepthTest.call(this,t)},isDepthTestEnabled:function(){return n.prototype.isDepthTestEnabled.call(this)},onObstructionChanged:function(t){n.prototype.onObstructionChanged.call(this,t)},resetClientPosition:function(t){const e=this._container,i=this._config;"Viewer3D"!==i.viewer.viewerType&&"ViewerGIS"!==i.viewer.viewerType||(t=i.viewer.worldToClient(t)),e.style.left=`${t.x+i.offset.x+23}px`,e.style.top=t.y+i.offset.y-18+"px",this._svgGroup.setAttribute("transform",`translate(${t.x},${t.y+i.offset.y-18})`)},setContainerVisible:function(t){!0!==t?this.hide():this.show()},setStyle:function(i){if(i&&null!==i){const[t,e,n,o]=this._labelCombination,s=i.lineColor&&i.lineColor.getRGBA();i.lineColor&&(this.config.style.lineColor=i.lineColor,e.style.stroke=s,n.style.stroke=s,t.style.borderColor=s,o.style.fill=s),i.lineWidth&&(this.config.style.lineWidth=i.lineWidth,t.style.borderWidth=i.lineWidth+"px",e.style.strokeWidth=i.lineWidth+"px",n.style.strokeWidth=i.lineWidth+"px",o.style.strokeWidth=i.lineWidth+"px"),i.backgroundColor&&(this.config.style.backgroundColor=i.backgroundColor,t.style.backgroundColor=i.backgroundColor.getRGBA()),i.fontSize&&(this.config.style.fontSize=i.fontSize,t.style.fontSize=i.fontSize+"px")}null!==this.config.style&&null!==i||(this.config.style=new Object),e.send(t,"setStyle")},getStyle:function(){return this.config.style}}),i.LeadLabel=s}(),function(){let t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Drawable"),e=new Glodon$1.Bimface.Plugins.Drawable.DrawableItemConfig;t.MiniTagConfig=function(){return Object.assign({},e,{minimap:null,floorList:[],height:20,width:20,objectId:"",src:"",worldPosition:null,viewer:null})}}();
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */
var extendStatics$4=function(t,e){return extendStatics$4=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])},extendStatics$4(t,e)};function __extends$4(t,e){function i(){this.constructor=t}extendStatics$4(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}var DomUtil2D=function(){function t(){}return t.create=function(t,e,i){var n=document.createElement(t);return n.id=e||"",n.style.position="absolute",n.style.width="100%",n.style.top=0,n.style.bottom=0,i&&i.appendChild(n),n},t.remove=function(t){var e=t.parentNode;e&&e.removeChild(t)},t.setPosition=function(t,e){t.position=e,t.style.left=e.x+"px",t.style.top=e.y+"px"},t.setOpacity=function(e,i){"opacity"in e.style?e.style.opacity=i:"filter"in e.style&&t._setOpacityIE(e,i)},t._setOpacityIE=function(t,e){var i=!1,n="DXImageTransform.Microsoft.Alpha";try{i=t.filters.item(n)}catch(t){if(1===e)return}e=Math.round(100*e),i?(i.Enabled=100!==e,i.Opacity=e):t.style.filter+=" progid:"+n+"(opacity="+e+")"},t.splitStr=function(t){return t.trim().split(/\s+/g)},t.getContainerOffsetToClient=function(t){var e,i;if(t!=document){var n=(i=t).getBoundingClientRect?function(t){var e=t.getBoundingClientRect(),i=document.body,n=document.documentElement,o=n.clientTop||i.clientTop,s=n.clientLeft||i.clientLeft,r=e.top-o,a=e.left-s;return{top:Math.round(r),left:Math.round(a)}}(i):function(t){for(var e=0,i=0;t;)e+=t.offsetTop,i+=t.offsetLeft,t=t.offsetParent;var n=document.body,o=document.documentElement;return{top:e-=window.pageYOffset||o.scrollTop||n.scrollTop,left:i-=window.pageXOffset||o.scrollLeft||n.scrollLeft}}(i);e={width:t.offsetWidth,height:t.offsetHeight,left:n.left,top:n.top}}else e={width:window.innerWidth,height:window.innerHeight,left:0,top:0};return e},t.setClassName=function(t,e){var i=document.getElementById(t);i&&(i.className=e)},t.addClassName=function(t,e){var i,n,o,s,r,a=document.getElementById(t);if(a&&(n=a,e&&"string"==typeof e&&(i=e.split(/\s+/),1===n.nodeType)))if(n.className||1!==i.length){for(o=" "+n.className+" ",s=0,r=i.length;s<r;++s)o.indexOf(" "+i[s]+" ")<0&&(o+=i[0]+" ");n.className=o.trim()}else n.className=e},t.removeClassName=function(t,e){var i,n,o,s,r,a=document.getElementById(t);if(a&&(o=a,e&&"string"==typeof e&&(i=(e||"").split(/\s+/),1===o.nodeType&&o.className))){for(n=(" "+o.className+" ").replace("O"," "),s=0,r=i.length;s<r;s++)for(;n.indexOf(" "+i[s]+" ")>=0;)n=n.replace(" "+i[s]+" "," ");o.className=e?n.trim():""}},t.showOrHideElement=function(t,e){var i=document.getElementById(t);i&&(i.style.display=e?"":"none")},t.prototype.getStyleString=function(t){var e=[];for(var i in t){var n=t[i];e.push(i),e.push(":"),e.push(n),e.push("; ")}return e.join("")},t.cloneStyle=function(t){var e={};for(var i in t)e[i]=t[i];return e},t.removeStyleAttribute=function(t,e){Array.isArray(e)||(e=[e]),e.forEach((function(e){e in t&&delete t[e]}))},t.trimRight=function(t){if(0===t.length)return"";for(var e=t.length-1,i=e;i>=0;--i)if(" "!==t.charAt(i)){e=i;break}return t.substr(0,e+1)},t.trimLeft=function(t){if(0===t.length)return"";for(var e=0,i=0;i<t.length;++i)if(" "!==t.charAt(i)){e=i;break}return t.substr(e)},t.matchesSelector=function(t,e){if(t.matches)return t.matches(e);if(t.matchesSelector)return t.matchesSelector(e);if(t.webkitMatchesSelector)return t.webkitMatchesSelector(e);if(t.msMatchesSelector)return t.msMatchesSelector(e);if(t.mozMatchesSelector)return t.mozMatchesSelector(e);if(t.oMatchesSelector)return t.oMatchesSelector(e);if(t.querySelectorAll){for(var i=(t.document||t.ownerDocument).querySelectorAll(e),n=0;i[n]&&i[n]!==t;)n++;return!!i[n]}return!1},t.toTranslate3d=function(t,e){return"translate3d("+t+"px,"+e+"px,0)"},t.setCursorStyle=function(t,e){var i;switch(e){case"n":case"s":i="ns-resize";break;case"w":case"e":i="ew-resize";break;case"ne":case"sw":i="nesw-resize";break;case"nw":case"se":i="nwse-resize"}t.style.cursor=i},t.debounce=function(t,e){var i,n=this;return void 0===e&&(e=500),function(){for(var o=[],s=0;s<arguments.length;s++)o[s]=arguments[s];i||t.apply(n,o),clearTimeout(i),i=setTimeout((function(){i=void 0}),e)}},t}(),ViewAdapter=function(){function t(){this.domContainer=null,this.cameraControl=null,this.scene=null,this.name=""}return t.prototype.getName=function(){return this.name},t.prototype.setDomContainer=function(t){this.domContainer=t},t.prototype.getDomContainer=function(){return this.domContainer},t.prototype.worldToClient=function(t){},t.prototype.clientToWorld=function(t){var e=this.getDomContainerBounds(),i=this.cameraControl.camera,n=new window.THREE.Vector3;n.x=t.x/e.width*2-1,n.y=-t.y/e.height*2+1,n.z=0,n.unproject(i);var o=this.getInverseSceneMatrix();return n.applyMatrix4(o),n},t.prototype.getSceneMatrix=function(){return this.scene.getMatrixGlobal()},t.prototype.getInverseSceneMatrix=function(){var t=this.getSceneMatrix(),e=new window.THREE.Matrix4;return e.copy(t).invert(),e},t.prototype.clientToViewport=function(t){var e=this.getDomContainerBounds(),i=new window.THREE.Vector3;return i.x=t.x/e.width*2-1,i.y=-t.y/e.height*2+1,i.z=0,i},t.prototype.getDomContainerBounds=function(t){return DomUtil2D.getContainerOffsetToClient(t||this.domContainer)},t}();window.Glodon.Bimface.Marker={};var View3dAdapter=function(t){function e(e){var i=t.call(this)||this;return i.name="VIEW3D",i.domContainer=e.domElement,i.cameraControl=e.cameraControl,i.scene=e.getScene(),i}return __extends$4(e,t),e.prototype.worldToClient=function(t){var e=this.getDomContainerBounds(),i=this.cameraControl.camera,n=this.getSceneMatrix(),o=new window.THREE.Vector3(t.x,t.y,t.z);return o.applyMatrix4(n),o.project(i),Math.abs(o.z)>1?null:(o.x=Math.round(.5*(o.x+1)*e.width),o.y=Math.round(-.5*(o.y-1)*e.height),o.z=0,o)},e}(ViewAdapter);window.Glodon.Bimface.Marker.View3dAdapter=View3dAdapter;var View2dAdapter=function(t){function e(e,i){var n=t.call(this)||this;n.name="VIEW2D",n.minimap=e,n.domContainer=e.getMapContainer(),n.cameraControl=i.cameraControl,n.scene=i.getScene();var o=e.viewerFloor.vfData,s=o.width||298,r=o.height||198;return n.initialDomSize={width:s,height:r},n.currentDomSize={width:s,height:r},n._boxSize=new THREE.Vector2,n}return __extends$4(e,t),e.prototype.getInitialDomSize=function(){return this.initialDomSize},e.prototype.resize=function(t){this.currentDomSize=t},e.prototype.getDomContainerBounds=function(){return this.currentDomSize},e.prototype.getMinimap=function(){return this.minimap},e.prototype.worldToClient=function(t){var e=new window.THREE.Vector3(t.x,t.y,t.z),i=this.minimap.getAxisGridBox2D();this.worldToNormalizedPoint(e,i);var n=this.getDomContainerBounds(),o={width:n.width/2,height:n.height/2};return this.normalizedPointToScreen(e,o),e.x+=o.width,e.y+=o.height,e},e.prototype.normalizedPointToScreen=function(t,e){t.x=t.x*e.width,t.y=-t.y*e.height},e.prototype.worldToNormalizedPoint=function(t,e){e.getSize(this._boxSize),t.x=(t.x-e.min.x)/this._boxSize.x*2-1,t.y=(t.y-e.min.y)/this._boxSize.y*2-1},e}(ViewAdapter);window.Glodon.Bimface.Marker.View2dAdapter=View2dAdapter;var DrawingdAdapter=function(t){function e(e,i){var n=t.call(this)||this;n.name="DRAWING",n.minimap=e,n.domContainer=e.getMapContainer(),n.viewer=i;return n.initialDomSize={width:300,height:240},n.currentDomSize={width:300,height:240},n}return __extends$4(e,t),e.prototype.getInitialDomSize=function(){return this.initialDomSize},e.prototype.resize=function(t){this.currentDomSize=t},e.prototype.getDomContainerBounds=function(){return this.currentDomSize},e.prototype.getMinimap=function(){return this.minimap},e.prototype.worldToClient=function(t){var e=this.getMinimap().getDrawingContentsBbox(),i=this.getDomContainerBounds(),n=Math.abs(e.max.x-e.min.x),o=Math.abs(e.max.y-e.min.y);return{x:i.height*(t.x-e.min.x)/n+(i.width-i.height)/2,y:i.height*(e.max.y-t.y)/o}},e}(ViewAdapter);window.Glodon.Bimface.Marker.DrawingdAdapter=DrawingdAdapter;var Marker=function(){function t(e,i){this.canUseThree=!!window.THREE,this.id=e,this.editor=i,this.position=this.canUseThree&&new window.THREE.Vector3||{x:0,y:0},this.boundingBox=this.canUseThree&&new window.THREE.Box3||{min:{x:1/0,y:1/0,z:1/0},max:{x:-1/0,y:-1/0,z:-1/0}},this.shape=null,this.style=t.getDefaultStyle(),this.selected=!1,this.highlighted=!1,this.highlightColor="#000088",this.isDisableInteractions=!1,this.ratioW=1,this.ratioH=1,this.keys={BACKSPACE:8,ALT:18,ESC:27,LEFT:37,UP:38,RIGHT:39,BOTTOM:40,DELETE:46,ZERO:48,A:65,D:68,E:69,Q:81,S:83,W:87,PLUS:187,SUB:189},this.onMouseDownBinded=this.onMouseDown.bind(this),this.onClickBinded=this.onClick.bind(this),this.onDoubleClickBinded=this.onDoubleClick.bind(this),this.onKeyUpBinded=this.onKeyUp.bind(this)}return t.prototype.addDomEventListeners=function(){this.shape.addEventListener("mousedown",this.onMouseDownBinded,!0),this.shape.addEventListener("click",this.onClickBinded,!0),this.shape.addEventListener("dblclick",this.onDoubleClickBinded,!0),this.shape.addEventListener("touchstart",this.onClickBinded,!0),window.addEventListener("keyup",this.onKeyUpBinded)},t.prototype.removeDomEventListeners=function(){this.shape.removeEventListener("mousedown",this.onMouseDownBinded,!0),this.shape.removeEventListener("click",this.onClickBinded,!0),this.shape.removeEventListener("dblclick",this.onDoubleClickBinded,!0),this.shape.removeEventListener("touchstart",this.onClickBinded,!0),window.removeEventListener("keyup",this.onKeyUpBinded)},t.prototype.onMouseDown=function(t){t.preventDefault(),t.stopPropagation(),2==t.button&&this.select(t.button)},t.prototype.onClick=function(t){var e=this;t.preventDefault(),t.stopPropagation(),this.clickTimerId&&clearTimeout(this.clickTimerId),this.clickTimerId=setTimeout((function(){e.select(t.button)}),500)},t.prototype.onDoubleClick=function(t){t.preventDefault(),t.stopPropagation(),this.editor.doubleClickMarker(this),this.clickTimerId&&clearTimeout(this.clickTimerId)},t.prototype.onKeyUp=function(t){if(t.keyCode===this.keys.DELETE)this.editor.deselectMarker(),this.delete()},t.prototype.createShape=function(){},t.prototype.destroy=function(){this.removeDomEventListeners(),this.deselect(),this.setParent(null)},t.prototype.set=function(t,e,i,n){this.userId=t,this.canUseThree&&this.position.set(e.x,e.y,e.z)||(this.position=e),i&&(this.boundingBox=this.canUseThree?i.clone():i),n&&(this.style=DomUtil2D.cloneStyle(n)),this.update()},t.prototype.setRatio=function(t,e){this.ratioW=t,this.ratioH=e},t.prototype.setParent=function(t){var e=this.shape;e&&(e.parentNode&&e.parentNode.removeChild(e),t&&t.appendChild(e))},t.prototype.setStyle=function(t){this.style=DomUtil2D.cloneStyle(t),this.update()},t.prototype.select=function(t){this.selected||(this.selected=!0,this.highlight(!0)),this.editor.selectMarker(this,t)},t.prototype.deselect=function(){this.highlight(!1),this.selected=!1},t.prototype.highlight=function(t){this.isDisableInteractions||(this.highlighted=t,this.update())},t.prototype.disableInteractions=function(t){this.isDisableInteractions=t},t.prototype.delete=function(){this.editor.deleteMarker(this)},t.prototype.getClientPosition=function(){return this.editor.getAdapter().worldToClient(this.position)},t.prototype.getBoundingBox=function(){return this.boundingBox},t.prototype.toNewObject=function(){return{id:this.id,userId:this.userId,shapeType:this.shapeType,cx:this.cx,cy:this.cy,position:this.position?Object.assign({},this.position):null,boundingBox:this.boundingBox?Object.assign({},this.boundingBox):null}},t.prototype.show=function(){this.shape.style.display="block"},t.prototype.hide=function(){this.shape.style.display="none"},t.prototype.update=function(){var t=this.style["stroke-width"],e=this.highlighted?this.highlightColor:this.style["stroke-color"],i=this.style["stroke-opacity"],n=this.style["fill-color"],o=this.style["fill-opacity"],s=this.getClientPosition();if(s){var r=s.x,a=s.y;if(2==this.shapeType)var l=["translate(",r-this.pictureSize.width*this.ratioW*.5,",",a-this.pictureSize.height*this.ratioH*.5,") "].join("");else l=["translate(",r,",",a,") "].join("");this.cx=r,this.cy=a,this.shape.setAttribute("transform",l),this.shape.setAttribute("stroke-width",t),this.shape.setAttribute("stroke",e),this.shape.setAttribute("stroke-opacity",i),this.shape.setAttribute("fill",n),this.shape.setAttribute("fill-opacity",o)}else this.shape.style.display="none"},t.shapeTypes={BUBBLE:0,FLAG:1,COMMON:2},t.getDefaultStyle=function(){var t={"stroke-width":2,"stroke-color":"#fffaff","stroke-opacity":1,"fill-color":"#ff2129","fill-opacity":1};return t},t}(),MarkerBubble=function(t){function e(e,i){var n=t.call(this,e,i)||this;return n.shapeType=Marker.shapeTypes.BUBBLE,n.createShape(),n.addDomEventListeners(),n}return __extends$4(e,t),e}(Marker),Shape2D=function(){function t(){}return t.createSvgElement=function(t){var e=document.createElementNS("http://www.w3.org/2000/svg",t);return e.setAttribute("pointer-events","inherit"),e},t.getRGBAString=function(t,e){return e<=0?"none":["rgba("+parseInt("0x"+t.substr(1,2)),",",parseInt("0x"+t.substr(3,2)),",",parseInt("0x"+t.substr(5,2)),",",e,")"].join("")},t.makeFlag=function(){var t=this.createSvgElement("path");return t.setAttribute("d","M0 0 L0 -20 L15 -13 L4 -6.87 L4 0Z"),t},t.makeBubble=function(){var t=this.createSvgElement("path");return t.setAttribute("d","m0.0035,-19.88544c-3.838253,0 -6.95,2.581968 -6.95,5.766754c0,3.185555 6.95,13.933247 6.95,13.933247s6.95,-10.747692 6.95,-13.933247c0,-3.184786 -3.11082,-5.766754 -6.95,-5.766754z"),t},t.makeCommon=function(t,e){var i=this.createSvgElement("image");return i.href.baseVal=t,i.setAttribute("height",e.height.toString()+"px"),i.setAttribute("width",e.width.toString()+"px"),i},t}(),MarkerCommon=function(t){function e(e,i,n,o){var s=t.call(this,e,i)||this;return s.shapeType=Marker.shapeTypes.COMMON,s.pictureSize=o||{width:20,height:20},s.createShape(n),s.addDomEventListeners(),s}return __extends$4(e,t),e.prototype.createShape=function(t){this.shape=Shape2D.makeCommon(t,this.pictureSize)},e.prototype.reset=function(){var t=this.pictureSize.width*this.ratioW,e=this.pictureSize.height*this.ratioH;this.shape.setAttribute("width",t.toString()+"px"),this.shape.setAttribute("height",e.toString()+"px")},e}(Marker),MarkerFlag=function(t){function e(e,i){var n=t.call(this,e,i)||this;return n.shapeType=Marker.shapeTypes.COMMON,n.createShape(),n.addDomEventListeners(),n}return __extends$4(e,t),e.prototype.createShape=function(){this.shape=Shape2D.makeFlag()},e}(Marker),MarkerEditor=function(){function t(t){this.disableInteractions=function(t){this.isDisableInteractions=t},this.adapter=t,this.markers=[],this.mapGroupMarkers={},this.groups=null,this.selectedMarker=null,this.flagColors={red:"#ff2129",green:"#85af03",yellow:"#fe9829"},this.bubbleColors={red:"#f92a24",green:"#86b507",gray:"#ff9326"},this.nextMarkerId=0,this.initialized=!1,this.markerClickCallback=null,this.markerDoubleClickCallback=null,this.markerRightClickCallback=null,this.markersRatioH=1,this.markersRatioW=1}return t.prototype.getAdapter=function(){return this.adapter},t.prototype.updateDomContainer=function(){var t=this.adapter.getDomContainer();this.adapter.setDomContainer(t)},t.prototype.getMarkers=function(){return this.markers},t.prototype.getMarkersByGroupName=function(t){return this.mapGroupMarkers.hasOwnProperty(t)?this.mapGroupMarkers[t]:[]},t.prototype.addMarkerToGroup=function(t,e){this.mapGroupMarkers.hasOwnProperty(e)||(this.mapGroupMarkers[e]=[]),this.mapGroupMarkers[e].push(t)},t.prototype.setMarkerGroups=function(t){this.groups=t},t.prototype.removeMarkerInGroup=function(t,e){for(var i=this.mapGroupMarkers[e],n=0,o=i.length;n<o;n++)if(i[n].userId==t)return i.splice(n,1),void this.updateByGroup()},t.prototype.removeMarker=function(t){for(var e=this.markers,i=0,n=e.length;i<n;i++)if(e[i].userId==t)return e[i].destroy(),void e.splice(i,1)},t.prototype.clearMarkers=function(){this.unloadMarkers(!0),this.markers=[],this.mapGroupMarkers={}},t.prototype.setVisible=function(t,e){var i=this.mapGroupMarkers;for(var n in i){var o=i[n];if(o instanceof Array){var s=o.getObjectByAttribute("id",t);s&&(!0===e?s.show():s.hide())}}},t.prototype.updateByGroup=function(t){var e=t||this.groupName;this.unloadMarkers();var i=this.mapGroupMarkers[e];if(i instanceof Array)for(var n=0,o=i.length;n<o;n++)i[n]&&i[n].setParent(this.svgGroup)},t.prototype.resize=function(t){var e=this.adapter.getInitialDomSize(),i=t.width/e.width,n=t.height/e.height;this.markersRatioH=n,this.markersRatioW=i;var o=this.mapGroupMarkers[this.groupName];if(o instanceof Array){for(var s=0,r=o.length;s<r;s++){var a=o[s];a.setRatio(i,n),a.reset(),a.update()}t.width==e.width&&t.height==e.height||(e=t),this.svg.setAttribute("width",t.width+""),this.svg.setAttribute("height",t.height+"")}},t.prototype.setGroupName=function(t){this.groupName=t},t.prototype.updateGroupName=function(){var t=this.adapter.getMinimap();t&&(this.groupName=t.getFloorPlaneName())},t.prototype.onResize=function(){if(this.svg){var t=this.adapter.getDomContainerBounds();this.svg.setAttribute("width",t.width+""),this.svg.setAttribute("height",t.height+""),this.updateMarkers()}},t.prototype.init=function(){if(!this.svg){var t=this.adapter.getDomContainerBounds(),e=t.width,i=t.height;this.svg=Shape2D.createSvgElement("svg"),this.svg.style.position="absolute",this.svg.style.display="block",this.svg.style.position="absolute",this.svg.style.display="block",this.svg.style.left="0",this.svg.style.top="0",this.svg.setAttribute("width",e+""),this.svg.setAttribute("height",i+""),this.adapter.getDomContainer().appendChild(this.svg),this.svgGroup=Shape2D.createSvgElement("g"),this.svg.insertBefore(this.svgGroup,this.svg.firstChild)}this.initialized=!0},t.prototype.uninit=function(){this.initialized=!1,this.svg&&(this.unloadMarkers(),this.svgGroup&&this.svgGroup.parentNode&&this.svgGroup.parentNode.removeChild(this.svgGroup),this.svg.parentNode&&this.svg.parentNode.removeChild(this.svg),this.svgGroup=null,this.svg=null,this.markerClickCallback=null,this.markerDoubleClickCallback=null,this.markerRightClickCallback=null)},t.prototype.isInitialized=function(){return this.initialized},t.prototype.generateMarkerId=function(){return++this.nextMarkerId,this.nextMarkerId.toString(10)},t.prototype.clear=function(t){var e=this.markers;if(1==t)for(;e.length;){var i=e[0];this.deleteMarker(i)}var n=this.svgGroup;if(n&&n.childNodes.length>0)for(;n.childNodes.length;)n.removeChild(n.childNodes[0])},t.prototype.addMarker=function(t){var e=this.adapter.getName();if("VIEW3D"!=e&&"DRAWING"!=e||t.setParent(this.svgGroup),this.markers.push(t),this.groups)for(var i=0,n=this.groups.length;i<n;i++)this.addMarkerToGroup(t,this.groups[i]);this.groupName&&this.updateByGroup(this.groupName)},t.prototype.deleteMarker=function(t){if(t){this.removeMarker(t.userId);var e=this.mapGroupMarkers;for(var i in e)this.removeMarkerInGroup(t.userId,i);e&&this.updateByGroup()}},t.prototype.selectMarker=function(t,e){if(!0===this.isDisableInteractions)return this.markerClickCallback&&0==e&&this.markerClickCallback(t.toNewObject()),void(this.markerRightClickCallback&&2==e&&this.markerRightClickCallback(t.toNewObject()));this.selectedMarker!==t?(this.deselectMarker(),this.selectedMarker=t):this.deselectMarker(),this.markerClickCallback&&(this.selectedMarker?this.markerClickCallback(this.selectedMarker.toNewObject()):this.markerClickCallback(null))},t.prototype.doubleClickMarker=function(t){this.markerDoubleClickCallback&&this.markerDoubleClickCallback(t.toNewObject())},t.prototype.deselectMarker=function(){this.selectedMarker&&(this.selectedMarker.deselect(),this.selectedMarker=null)},t.prototype.enableSVGPaint=function(t){t?this.svg&&this.svg.setAttribute("pointer-events","painted"):this.svg&&this.svg.setAttribute("pointer-events","none")},t.prototype.getMarkerColor=function(t,e){var i=this.bubbleColors.red;switch(t<0&&t>1&&(t=0),e>2&&(e-=3),e<0&&e>2&&(e=0),e){case 0:i=0===t?this.bubbleColors.red:this.flagColors.red;break;case 1:i=0===t?this.bubbleColors.green:this.flagColors.green;break;case 2:i=0===t?this.bubbleColors.gray:this.flagColors.yellow}return i},t.prototype.createMarkerByIntersect=function(t,e,i,n){var o={size:n,id:t.id||this.generateMarkerId(),userId:t.userId,position:t.worldPosition||t.object.point,boundingBox:t.worldBoundingBox||t.object&&t.object.boundingBox,shapeType:e,state:i};this.createMarker(o)},t.prototype.createMarker=function(t){if(t){var e=Marker.getDefaultStyle();e["fill-color"]=this.getMarkerColor(t.shapeType,t.state);var i,n=t.id||this.generateMarkerId(),o=Marker.shapeTypes;switch(t.shapeType){case o.BUBBLE:i=new MarkerBubble(n,this);break;case o.COMMON:(i=new MarkerCommon(n,this,t.state,t.size)).setRatio(this.markersRatioW,this.markersRatioH),i.reset();break;case o.FLAG:default:i=new MarkerFlag(n,this)}this.isDisableInteractions&&i.disableInteractions(!0),i.set(t.userId,t.position,t.boundingBox,e),this.addMarker(i)}},t.prototype.getMarkersBoundingBox=function(){if(this.markers.length<1)return null;for(var t=new window.THREE.Box3,e=0,i=this.markers.length;e<i;e++){var n=this.markers[e];n.getBoundingBox()&&t.union(n.getBoundingBox())}return t},t.prototype.getMarkerInfoList=function(){for(var t=[],e=0,i=this.markers.length;e<i;e++){var n=this.markers[e],o=n.userId+"_"+e,s={id:n.id||o,userId:n.userId,shapeType:n.shapeType,position:n.position,boundingBox:n.boundingBox,state:n.state};t.push(s)}return t},t.prototype.loadMarkers=function(t){this.clear();for(var e=0,i=t.length;e<i;e++){var n=t[e],o=n.userId+"_"+e,s=n.id||o,r=n.userId,a=n.shapeType,l=n.state,h=n.position,c=window.THREE?new window.THREE.Box3:{min:{x:1/0,y:1/0,z:1/0},max:{x:-1/0,y:-1/0,z:-1/0}};c.max.x=n.boundingBox.max.x,c.max.y=n.boundingBox.max.y,c.max.z=n.boundingBox.max.z,c.min.x=n.boundingBox.min.x,c.min.y=n.boundingBox.min.y,c.min.z=n.boundingBox.min.z;var d={id:s,userId:r,position:h,boundingBox:c,shapeType:a,state:l};this.createMarker(d)}},t.prototype.loadMarkersFromIntersect=function(t,e,i){this.clear(),this.createMarkerByIntersect(t,e,i)},t.prototype.unloadMarkers=function(t){this.clear(t)},t.prototype.updateMarkers=function(){for(var t=0,e=this.markers.length;t<e;t++){this.markers[t].update()}},t.prototype.getMarker=function(t){for(var e=this.markers,i=e.length,n=0;n<i;++n)if(e[n].userId==t)return e[n];return null},t.prototype.getMarkerByUserId=function(t){for(var e=this.markers,i=e.length,n=0;n<i;++n)if(e[n].userId==t)return e[n];return null},t.prototype.setMarkerClickCallback=function(t){this.markerClickCallback=t},t.prototype.setMarkerDoubleClickCallback=function(t){this.markerDoubleClickCallback=t},t.prototype.setMarkerRightClickCallback=function(t){this.markerRightClickCallback=t},t.prototype.zoomAndPanMarkerById=function(t,e,i,n){var o=this.mapGroupMarkers,s=this.svg.getAttribute("width"),r=this.svg.getAttribute("height"),a=new THREE.Vector2(.5*s,.5*r);for(var l in o){var h=o[l];if(h instanceof Array){var c=h.getObjectByAttribute("id",t);if(c){var d=c.getClientPosition(),u=c.pictureSize.width*c.ratioW,p=c.pictureSize.height*c.ratioH,g=new THREE.Vector2(d.x,d.y).clone().sub(a);g.multiplyScalar(n);var m="translate("+(a.x+g.x-.5*u+e)+","+(a.y+g.y-.5*p+i)+")";c.shape.setAttribute("transform",m)}}}},t}();!function(){var t="Bimface.Plugins.Drawable.MiniTag",e=Glodon$1.Bimface.Data.StatisticsDataManager.getInstance();let i=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Drawable"),n=Glodon$1.Bimface.Plugins.Drawable.DrawableItem;Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.Dom"),Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.HttpRequest");let o=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility");var s=function(t){n.call(this,t);var e=this,i=this._viewer=t.viewer.getViewer();if(this.miniTagConfig=t,this._config=t,e.worldPosition=t.worldPosition,this._renderCallback=function(){e.resize()},"ViewerDrawing"==t.viewer.viewerType){this.mapHelper=t.minimap;var o=new Glodon$1.Bimface.Marker.DrawingdAdapter(this.mapHelper,t.viewer)}else if(t.minimap){this.mapHelper=t.minimap;o=new Glodon$1.Bimface.Marker.View2dAdapter(this.mapHelper,i);this.mapHelper.setMinimapResizeCallback((function(t){o.resize(t),s._tagHelper.updateGroupName(),s._tagHelper.updateDomContainer(),s._tagHelper.resize(t),s._tagHelper.updateByGroup()})),this.mapHelper.setPlaneChangedCallback((function(){s._tagHelper.updateGroupName(),s._tagHelper.updateByGroup()}));const n={Floor_Plane_Changed_For_Panel:3001,ZOOM_MOUSE_WHEEL:6e3,PAN_MOUSE_MOVE:7e3};this.mapHelper.viewerFloor.addEventListener(n.ZOOM_MOUSE_WHEEL,(function(t){var i=t.data;e.zoomAndPan(i.offsetX,i.offsetY,i.zoomFactor)})),this.mapHelper.viewerFloor.addEventListener(n.PAN_MOUSE_MOVE,(function(t){var i=t.data;e.zoomAndPan(i.offsetX,i.offsetY,i.zoomFactor)})),this.mapHelper.viewerFloor.addEventListener(n.Floor_Plane_Changed_For_Panel,(function(t){var i=e.mapHelper.viewerFloor,n=i.getPanOffset();e.zoomAndPan(n.x,n.y,i.vfData.zoomFactor)}))}else{o=new Glodon$1.Bimface.Marker.View3dAdapter(i);i.addCallbacks("render",this._renderCallback)}null==s._tagHelper&&(s._tagHelper=new MarkerEditor(o),s._tagHelper.disableInteractions(!0)),r()},r=function(){s._tagHelper.isInitialized()||s._tagHelper.init()},a=function(t){for(var e=s._tagHelper.getMarkerInfoList(),i=0,n=e.length;i<n;i++){var o=e[i];o.id==t&&s._tagHelper.deleteMarker(o)}};s.clear=function(){s._tagHelper&&s._tagHelper.clearMarkers()},o.Type.inheritPrototype(s,n),s.prototype=Object.assign({},n.prototype,{draw:function(){var t=this.miniTagConfig;!function(t,e){if(!t)return!1;var i=!1,n=s._tagHelper.getMarkerInfoList();t.userId=t.objectId;for(var o=0,r=n.length;o<r;o++)if(n[o].id==t.id)return i=!0,!1;t.floorList?s._tagHelper.setMarkerGroups(t.floorList):s._tagHelper.setMarkerGroups([]),"ViewerDrawing"!=t.config.viewer.viewerType&&s._tagHelper.updateGroupName(),i||s._tagHelper.createMarkerByIntersect(t,e.shape,e.image,e.size)}({id:this.id,config:this._config,objectId:t.objectId,worldPosition:t.worldPosition,floorList:t.floorList},{shape:2,image:t.src,size:{width:t.width,height:t.height}});var e=this.mapHelper.viewerFloor;if(e){var i=e.getPanOffset();this.zoomAndPan(i.x,i.y,e.vfData.zoomFactor)}},show:function(){e.send(t,"show"),s._tagHelper.setVisible(this.id,!0)},hide:function(){e.send(t,"hide"),s._tagHelper.setVisible(this.id,!1)},getFloorList:function(){return this.miniTagConfig.floorList},setFloorList:function(i){e.send(t,"setFloorList"),this.miniTagConfig.floorList=i,a(this.id),this.draw()},getHeight:function(){return this.miniTagConfig.height},setHeight:function(i){e.send(t,"setHeight"),this.miniTagConfig.height=i,a(this.id),this.draw()},getId:function(){return this.id},getObjectId:function(){return this.miniTagConfig.objectId},setObjectId:function(i){e.send(t,"setObjectId");var n=this.miniTagConfig;a(this.id),n.objectId=i,this.draw()},getSrc:function(){return this.miniTagConfig.src},setSrc:function(i){e.send(t,"setSrc"),this.miniTagConfig.src=i,a(this.id),this.draw()},getWidth:function(){return this.miniTagConfig.width},setWidth:function(i){e.send(t,"setWidth"),this.miniTagConfig.width=i,a(this.id),this.draw()},getWorldPosition:function(){return this.miniTagConfig.worldPosition},setWorldPosition:function(i){e.send(t,"setWorldPosition"),this.miniTagConfig.worldPosition=i,a(this.id),this.draw()},onClick:function(i){e.send(t,"onClick"),s._tagHelper.setMarkerClickCallback(i)},onDoubleClick:function(i){e.send(t,"onDoubleClick"),s._tagHelper.setMarkerDoubleClickCallback(i)},onRightClick:function(i){e.send(t,"onRightClick"),s._tagHelper.setMarkerRightClickCallback(i)},onEndDrag:function(i){e.send(t,"onEndDrag")},zoomAndPan:function(t,e,i){s._tagHelper.zoomAndPanMarkerById(this.id,t,e,i)}}),i.MiniTag=s}(),function(){let t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Drawable"),e=new Glodon$1.Bimface.Plugins.Drawable.DrawableItemConfig;t.ClusterTagConfig=function(){return Object.assign({},e,{width:52,height:57,content:"",src:null,offsetX:0,offsetY:0})}}(),function(){let t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Drawable"),e=Glodon$1.Bimface.Plugins.Drawable.DrawableItem,i=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.Dom"),n=function(t){e.call(this,t),this.includedTags=[],this.clusterBbox=null,this.attachFilter=t.attachFilter;let n=i.create("div","bf-drawable-cluster");n.style.position="absolute",n.style.width=`${t.width}px`,n.style.height=`${t.height}px`,n.innerHTML=this.getClusterTagHtml();let o=i.create("div","bf-drawable-cluster-textarea");o.innerText=t.content,n.appendChild(o),this.clusterStyle=Glodon$1.Bimface.Plugins.Cluster.ClusterStyle.Success,this.forceHide=!1,this._config=t,this._domTextArea=o,this._container=n,this.hookEvents()};Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility").Type.inheritPrototype(n,e);!function(t,e){var i=e.prototype;for(var n in t)i[n]=t[n]}({hookEvents:function(){let t=this._container,e=this;this.isMouseDown=!1,t.addEventListener("mouseup",(function(t){e.isMouseDown=!1})),t.addEventListener("mousemove",(function(t){e.isMouseDown||e.onHoverCallback&&e.onHoverCallback({id:e.id,position:e.worldPosition,includedTags:e.getIncluded(),boundingBox:e.clusterBbox})})),t.addEventListener("mousedown",(function(t){(t||window.event).stopPropagation(),e.isMouseDown=!0})),t.addEventListener("click",(function(t){(t||window.event).stopPropagation(),e.clickTimerId&&clearTimeout(e.clickTimerId),e.clickTimerId=setTimeout((()=>{e.onClickCallback&&e.onClickCallback({id:e.id,position:e.worldPosition,includedTags:e.getIncluded(),boundingBox:e.clusterBbox})}),500)})),t.addEventListener("dblclick",(function(t){(t||window.event).stopPropagation(),e._doubleClick&&e._doubleClick({id:e.id,position:e.worldPosition,includedTags:e.getIncluded(),boundingBox:e.clusterBbox}),e.clickTimerId&&clearTimeout(e.clickTimerId)}))},draw:function(t){var e=this._container,i=this._config;e.style.left=t.clientPosition.x+i.offsetX-i.width/2+"px",e.style.top=t.clientPosition.y+i.offsetY-i.height/2+"px",t.rootDomElement.appendChild(e)},getClusterTagHtml(){let t='<defs><filter x="-23.9%" y="-21.4%" width="147.7%" height="142.9%" filterUnits="objectBoundingBox" id="filter-clustertag"><feOffset dx="0" dy="1" in="SourceAlpha" result="shadowOffsetOuter1"></feOffset><feGaussianBlur stdDeviation="2" in="shadowOffsetOuter1" result="shadowBlurOuter1"></feGaussianBlur> <feColorMatrix values="0 0 0 0 0   0 0 0 0 0   0 0 0 0 0  0 0 0 0.5 0" type="matrix" in="shadowBlurOuter1" result="shadowMatrixOuter1"></feColorMatrix> <feMerge><feMergeNode in="shadowMatrixOuter1"></feMergeNode><feMergeNode in="SourceGraphic"></feMergeNode></feMerge></filter> </defs>';this.attachFilter||(t="");let e='<svg width="52px" height="57px" version="1.1" transform="translate(0,0)">'+t;return e+=`<g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"> <g id="编组" filter="#filter-clustertag" transform="translate(4.000000, 3.000000)"> <path id="${this.id}" d="M43.7259252,22.0045824 C43.7259252,9.85175882 33.9373645,0.000288235294 21.8628598,0.000288235294 C9.78835514,0.000288235294 0.000205607477,9.85175882 0.000205607477,22.0045824 C0.000205607477,29.7679941 3.99803738,36.5872294 10.0313832,40.5039353 L10.0202804,40.5039353 L21.8628598,48.6045824 L33.7058505,40.5039353 L33.6947477,40.5039353 C39.7276822,36.5872294 43.7259252,29.7679941 43.7259252,22.0045824" id="Fill-1" fill="#32D3A6"></path><circle fill="#FFFFFF" cx="22" cy="22" r="16"></circle></g></g></svg>`,e},setScale:function(t){this._container.style.transform=`scale(${t})`},getText:function(){return this._domTextArea.innerText},setText:function(t){this._domTextArea.innerText=t},updateText:function(){let t=this.getIncluded().length;t<=99?this.setText(t.toString()):this.setText("99+")},show:function(){this._container.style.display="block",this.forceHide=!1},hide:function(){this._container.style.display="none",this.forceHide=!0},onClick:function(t){this.onClickCallback=t},onHover:function(t){this.onHoverCallback=t},include:function(t){this.includedTags.push(t)},isInclude:function(t){for(const e of this.includedTags)if(e.getId()===t)return!0;return!1},setBoundingBox:function(t){this.clusterBbox=t},getIncluded:function(){return this.includedTags},getContainer:function(){return this._container},hideIncludedTags:function(){for(const t of this.includedTags)t.isHideByClustering=!0},showIncludedTags:function(){for(const t of this.includedTags)t.isHideByClustering=!1},getCurrentPosition:function(){return{x:this.worldPosition.x,y:this.worldPosition.y,z:this.worldPosition.z}},setStyle:function(t){this.clusterStyle=t;let e=document.getElementById(this.getId());e&&(e.style.fill=t),this._domTextArea.style.color=t},getStyle:function(){return this.clusterStyle},getOpacity:function(){return""===this._container.style.opacity?1:this._container.style.opacity},setOpacity:function(t){this._container.style.opacity=t},resetClientPosition:function(t){const e=this._container,i=this._config;"Viewer3D"!==this.viewer.viewerType&&"ViewerGIS"!==this.viewer.viewerType||(t=this.viewer.worldToClient(t)),e.style.left=t.x+i.offsetX-i.width/2+"px",e.style.top=t.y+i.offsetY-i.height/2+"px"},setContainerVisible(t){this._container.style.display=!0===t?"block":"none"},play:function(t){if(!(this.clusterBbox&&this.clusterBbox.center&&this.includedTags.length>0))return void console.log("clusterBbox");const e=this.clusterBbox.center,i=this.includedTags,n=i.length;for(let t=0;t<n;t++){const e=i[t];e.originClientPosition=e.clientPosition}this.time=500;let o=(new Date).valueOf(),s=o-16;this.progress=0;let r=()=>{this.animationId=requestAnimationFrame(r),this.progress>=1&&(this.curvePos=1,t&&t(),cancelAnimationFrame(this.animationId),this.progress=0),(t=>{for(let o=0;o<n;o++){const n=i[o];let s=n.originClientPosition;s.x=s.x+(e.x-s.x)*t,s.y=s.y+(e.y-s.y)*t,n.resetClientPosition(s)}})(this.progress),o=(new Date).valueOf();const a=o-s;s=o,this.progress+=a/this.time};r()}},n),t.ClusterTag=n}(),function(){var t="Bimface.Plugins.Drawable.DrawableContainer",e=Glodon$1.Bimface.Data.StatisticsDataManager.getInstance();let i=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Drawable"),n=(Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.Dom"),Glodon$1.Bimface.Plugins.Drawable.ClusterTag);i.DrawableContainer=class{constructor(t){let e=this,i=t.viewer;if(i.drawableContainer)return i.drawableContainer;i.drawableContainer=this;let n=Glodon$1.Bimface.Viewer.ViewerDrawing&&i instanceof Glodon$1.Bimface.Viewer.ViewerDrawing,o=Glodon$1.Bimface.Viewer.Viewer3D&&"Viewer3D"===i.viewerType,s=Glodon$1.Bimface.Viewer.ViewerDrawingSet&&i instanceof Glodon$1.Bimface.Viewer.ViewerDrawingSet,r=Glodon$1.Bimface.Viewer.ViewerGIS&&i instanceof Glodon$1.Bimface.Viewer.ViewerGIS,a=new Glodon$1.Web.Lang.EventManager,l=new Glodon$1.Bimface.Plugins.Drawable.DrawableContext;if(this.bIsEnableMinitagUpdate=!0,this.boxMap={},e._enableRender=t.enableRender,i.addEventListener("Rendered",(function(t){e.bIsEnableMinitagUpdate=!1,e.update(t),e.bIsEnableMinitagUpdate=!0})),o||r){let t=null,n=null;i.addEventListener(Glodon$1.Bimface.Viewer.Viewer3DEvent.CameraPositionChanged,(function(i){n||(n=setTimeout((()=>{e.showOrHideLabelForCamearPosition(i.position),e.handleEnableDepthTest(i.position),n=null}),500)),t&&(clearTimeout(t),t=null),t=setTimeout((()=>{clearTimeout(n),n=null,e.showOrHideLabelForCamearPosition(i.position),e.handleEnableDepthTest(i.position)}),200)}))}r&&(i.addEventListener(Glodon$1.Bimface.Viewer.ViewerGISEvent.ViewChanged,(function(){e.handleEnableDepthTest()})),i.addEventListener(Glodon$1.Bimface.Viewer.ViewerGISEvent.LayerVisibleChanged,(function(){e.handleEnableDepthTest()}))),o&&(i.addEventListener(Glodon$1.Bimface.Viewer.Viewer3DEvent.ViewChanged,(function(){e.handleEnableDepthTest()})),i.addEventListener(Glodon$1.Bimface.Viewer.Viewer3DEvent.ViewLoaded,(function(){e.handleEnableDepthTest()})),i.addEventListener(Glodon$1.Bimface.Viewer.Viewer3DEvent.ModelVisibleChanged,(function(){e.handleEnableDepthTest()})));let h=()=>{let t=i.getViewer();t.registerEventListener(CLOUD.EVENTS.ON_EXPLOSION,(e=>{let i=this.getAllItems();for(let n=0,o=i.length;n<o;n++)i[n]instanceof Glodon$1.Bimface.Plugins.Drawable.MiniTag||ExplosionHelper.attachExplosionOffset(t,e.extent,i[n])}))};if(n)i.getRootElement().appendChild(l.rootDomElement);else if(s){i.getActiveDrawing().viewerDrawing.getRootElement().appendChild(l.rootDomElement)}else r?(i.getDomElement().appendChild(l.rootDomElement),this.calculateViewerGISExplosionOffset=t=>{const n=i.getViewer(),o=t.modelId,s=t.floorInfos.length,r=n.getFloorExplosionExtent(o),a=n.getFloorExplosionDirection(o);if(0===r)for(const t of e.getAllItems())t.setInitialExplosionInfo(i);const l=t.floorInfos;let h=[];for(var c=0;c<s;c++){let t=l[c],e=l[c+1],i=l[c-1];if(h.push({box:{min:i?t.boundingBox.min.z:-1/0,max:e?e.boundingBox.min.z:1/0},floorName:t.name,explodedOffset:t.explodedHeight-t.elevation}),h.length==s){this.boxMap[o]=h;break}}const d=i.getLayerManager();let u=this._items;for(let t=0,e=u.length;t<e;t++){if(!u[t].getWorldPosition())continue;const e=d.getLayer(u[t].layerId);if(!e||!e.modelId)continue;if(e.modelId.toString()!==o||!u[t].levelName)continue;let i=h.getObjectByAttribute("floorName",u[t].levelName);i&&(u[t].explosionOffset={x:a.x*i.explodedOffset,y:a.y*i.explodedOffset,z:a.z*i.explodedOffset})}},i.addEventListener(Glodon$1.Bimface.Viewer.ViewerGISEvent.FloorExplosion,(t=>{this.calculateViewerGISExplosionOffset(t)})),h()):(i.getDomElement().appendChild(l.rootDomElement),t.affectedBySection&&(i.addEventListener(Glodon$1.Bimface.Plugins.Section.SectionBoxEvent.SectionBoxUpdate,(function(t){e.section=t,e.update()})),i.addEventListener(Glodon$1.Bimface.Plugins.Section.SectionPlaneEvent.SectionPlaneUpdate,(function(t){e.section=t,e.update()}))),this.calculateViewer3dExplosionOffset=t=>{const n=t.modelId,o=t.floorInfos.length,s=i.getDefaultModel().modelId.toString(),r=i.getModel(n).getFloorExplosionExtent(),a=i.getModel(n).getFloorExplosionDirection();if(0===r)for(const t of e.getAllItems())t.setInitialExplosionInfo(i);let l=[];e.floorInfos=t;var h=function(){let t=e._items;for(let i=0,o=t.length;i<o;i++){let o=t[i].getWorldPosition();if(o)if(!0!==t[i]._isBindRoom)if(t[i].levelName){let e=l.getObjectByAttribute("floorName",t[i].levelName);e&&(t[i].explosionOffset={x:a.x*e.explodedOffset,y:a.y*e.explodedOffset,z:a.z*e.explodedOffset})}else if(n!==s)t[i].explosionOffset={x:t[i].explosionOffset.x,y:t[i].explosionOffset.y,z:t[i].explosionOffset.z};else{let e=!0;for(let n=0;n<l.length;n++){const s=l[n];if(s.box.min<o.z&&s.box.max>o.z){t[i].explosionOffset={x:a.x*s.explodedOffset,y:a.y*s.explodedOffset,z:a.z*s.explodedOffset},t[i].levelName=s.floorName,e=!1;break}}e&&(t[i].explosionOffset={x:0,y:0,z:0})}else{const n=e._viewer.getViewer().modelManager.modelCollection.getById("ExtrudeBodyManager").getNode(t[i]._config.objectId),o=n.explodedHeight,s=n.explodedDirection;t[i].explosionOffset={x:s.x*o,y:s.y*o,z:s.z*o}}}};if(o)for(var c=0;c<o;c++){let i=t.floorInfos[c],n=t.floorInfos[c+1],s=t.floorInfos[c-1];l.push({box:{min:s?i.boundingBox.min.z:-1/0,max:n?n.boundingBox.min.z:1/0},floorName:i.name,explodedOffset:i.explodedHeight-i.elevation}),l.length==o&&(h(),e.boxs=l)}},i.addEventListener(Glodon$1.Bimface.Viewer.Viewer3DEvent.FloorExplosion,(t=>{this.calculateViewer3dExplosionOffset(t)})),h());e._items=[],e._viewer=i,e._context=l,e._isDrawingView=n,e._isDrawingViewSet=s,e._isViewer3D=o,e._isViewerGIS=r,e._areaData={},e.loadAreas=void 0,e.addItemCallback=[],e._maxNum=t.maxNum,e.getEventManager=function(){return a}}showOrHideLabelForCamearPosition(t){if(!this._isViewer3D&&!this._isViewerGIS)return;!t&&(t=this._viewer.getCameraStatus().position);let e=this._items;for(let i=0;i<e.length;i++)if("number"==typeof e[i].visibleDistance){let n=e[i].worldPosition;Math.sqrt(Math.pow(n.x-t.x,2)+Math.pow(n.y-t.y,2)+Math.pow(n.z-t.z,2))>e[i].visibleDistance?e[i].hideByCameraPosition():e[i].showByCameraPosition()}this.update()}handleEnableDepthTest(t){(this._isViewer3D||this._isViewerGIS)&&this._items&&this._items.length>0&&this._items.map((e=>e.handleEnableDepthTest(t)))}addItem(i){e.send(t,"addItem");const n=this._items,o=this._viewer;if(i.viewer=o,i.update=this.update.bind(this),!i.worldPosition)return;if(i instanceof Glodon$1.Bimface.Plugins.Drawable.MiniTag)n.push(i),this.update();else{let t=ExplosionHelper.ifExploded(o,i,this._isViewerGIS);t&&("Viewer3D"===this._viewer.getViewerType()&&t.setInitialExplosionInfo(this._viewer),n.push(t),this._enableRender&&this.update())}this.showOrHideLabelForCamearPosition(),i.handleEnableDepthTest&&i.handleEnableDepthTest()}getLevelNameById(t,e){if(!this._spatialRelation){let t=new Glodon$1.Bimface.Plugins.SpatialRelation.RoomConfig;t.viewer=this._viewer;let e=new Glodon$1.Bimface.Plugins.SpatialRelation.Room(t);this._spatialRelation=e}let i=this._spatialRelation.getBoundaryByRoomId(t);if(i){if(this._levelsInfo)return levelName=function(t,e){let i=t[0][2];for(let t=0;t<e.length;t++)if(Math.abs(i-e[t].elevation)<5)return e[t].name;return!1}(i,this._levelsInfo),levelName;(this._isViewer3D?this._viewer.getDefaultModel():this._viewer).getMapInfo((t=>{this._levelsInfo=t.axisGrid.Levels,this.addItem(e)}))}}removeItemById(i){e.send(t,"removeItemById");let n=this._items.removeObjectByAttribute("id",i);n=n&&n[0];let o=n._domElement||n._container;n&&this._context.rootDomElement.contains(o)&&o.remove(),n._svgGroup&&this._context.svgContainer.contains(n._svgGroup)&&this._context.svgContainer.removeChild(n._svgGroup),this.update()}getItemById(t){return this._items.getObjectByAttribute("id",t)}getAllItems(){return this._items}addItems(i){if(e.send(t,"addItems"),i.length)for(var n=0;n<i.length;n++)i[n].update=this.update.bind(this),i[n].viewer=this._viewer;if("Viewer3D"===this._viewer.getViewerType()||this._isViewerGIS)for(const t of i){let e=ExplosionHelper.ifExploded(this._viewer,t,this._isViewerGIS);e&&this._items.push(e),t.setInitialExplosionInfo(this._viewer)}else for(const t of i)this._items.push(t);this._enableRender&&this.update()}clear(){e.send(t,"clear"),this._items=[],this._context.rootDomElement.innerHTML="",this._context.domContainer=null,this._context.svgContainer=null,this.update()}update(){let t=this._items,e=this._viewer,i=this._context,n=this._maxNum;var o=document.body.getBoundingClientRect(),s=Glodon$1.Bimface.Plugins.Drawable.MiniTag;if(this.bIsEnableMinitagUpdate&&s.clear(),this._isDrawingView&&(e=e.getViewer()),this._isDrawingView)for(let n=0,s=t.length;n<s;n++){let s=t[n].getWorldPosition();if(s)if(t[n]instanceof Glodon$1.Bimface.Plugins.Drawable.ClusterTag){let o=e.toScreenPoint([s.x,s.y]);i.clientPosition={x:o[0],y:o[1]},t[n].draw(i)}else{var r=e.toScreenPoint([s.x,s.y]);if(t[n]._domElement){var a=t[n]._domElement.offsetWidth/2,l=t[n]._domElement.offsetHeight/2;if(t[n].isHideByClustering){t[n]._domElement.style.display="none";continue}if(r[0]<-a||r[0]>o.width+a||r[1]<-l||r[1]>o.height+l){t[n]._domElement.style.display="none";continue}t[n]._domElement.style.display="block",t[n].updateVisibility()}i.clientPosition={x:r[0],y:r[1]},t[n].draw(i)}}else if(this._isDrawingViewSet)for(let n=0,o=t.length;n<o;n++){let o=t[n].getWorldPosition();r=e.getDrawingById(t[n].viewerDrawingId).viewerDrawing.worldToClient(o);if(i.clientPosition=r,t[n]instanceof Glodon$1.Bimface.Plugins.Drawable.ClusterTag){let s=e.toScreenPoint([o.x,o.y]);i.clientPosition={x:s[0],y:s[1]},t[n].draw(i)}else t[n].updateVisibility(),t[n].draw(i)}else{for(let i=0,n=t.length;i<n;i++){let n=t[i];n.needForceUpdate&&(n=ExplosionHelper.ifExploded(e,n,this._isViewerGIS),n.needForceUpdate=!1);let o=n.getCurrentPosition();n.clientPosition=e.worldToClient(o);let s=n._container||n._domElement,r=n._svgGroup;if(n instanceof Glodon$1.Bimface.Plugins.Drawable.MiniTag||e.isInViewFrustum(o)){if(this.section&&!this.section.isIncluded(o)||n.forceHide||n.isHideByClustering&&!0!==n.isInAnimation){s&&(s.style.display="none"),r&&(r.style.display="none");continue}s&&(s.style.display=""),r&&(r.style.display="")}else s&&(s.style.display="none"),r&&(r.style.display="none")}t.sort((function(t,e){return t.clientPosition.z>=e.clientPosition.z?1:-1}));for(let e=0;e<t.length;e++){var h="default";e>=n&&(h="mini"),i.clientPosition=t[e].clientPosition,t[e]instanceof Glodon$1.Bimface.Plugins.Drawable.MiniTag&&0==this.bIsEnableMinitagUpdate||t[e].draw(i,h)}}}exit(){e.send(t,"exit"),this.clear(),this._context.destroy()}hideItemsById(i){e.send(t,"hideItemsById");let n=this;if(i&&i.length>0)for(let t=0;t<i.length;t++){var o=n.getItemById(i[t]);o&&o.hide()}}hideAllItems(){e.send(t,"hideAllItems");let i=this._items;if(i&&i.length>0)for(let t=0;t<i.length;t++)i[t].hide()}showItemsById(i){e.send(t,"showItemsById");let n=this;if(i&&i.length>0)for(let t=0;t<i.length;t++){var o=n.getItemById(i[t]);o&&o.show()}}showAllItems(){e.send(t,"showAllItems");let i=this._items;if(i&&i.length>0)for(let t=0;t<i.length;t++)i[t].show()}removeClusterTags(t){let e=this.getAllItems();for(let i=e.length-1;i>=0;){let o=e[i];if(o instanceof n&&o.clusterItemId===t){e.splice(i--,1);let t=o.getContainer();this._context.rootDomElement.contains(t)&&t.remove()}else i--}}showItemsByLayerId(i){e.send(t,"showItemsByLayerId");let n=this.getAllItems();for(let t=n.length-1;t>=0;t--){let e=n[t];e.layerId==i&&e.show()}}hideItemsByLayerId(i){e.send(t,"hideItemsByLayerId");let n=this.getAllItems();for(let t=n.length-1;t>=0;t--){let e=n[t];e.layerId==i&&e.hide()}}removeItemsByLayerId(i){e.send(t,"removeItemsByLayerId");let n=this.getAllItems();for(let t=n.length-1;t>=0;){let e=n[t];if(e.layerId==i){let i=e._domElement||e._container;e&&this._context.rootDomElement.contains(i)&&i.remove(),e._svgGroup&&e._svgGroup.parentElement.removeChild(e._svgGroup),n.splice(t--,1)}else t--}}}}(),Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Cluster").ClusterContainerConfig=function(){return{viewer:null,enableAnimation:!0}},function(){var t=Glodon$1.Bimface.Data.StatisticsDataManager.getInstance(),e=(Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.Dom"),Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Cluster"));e.ClusterContainer=class{constructor(e){t.send("Bimface.Plugins.Cluster","ClusterContainer"),this.viewer=e.viewer,this.isViewer3D="Viewer3D"===e.viewer.getViewerType()||"ViewerGIS"===e.viewer.getViewerType(),this.clusterItems=[],this._lastZoomFactorData=null,this.hookEvents(e.viewer),this.enableAnimation=!1!==e.enableAnimation}hookEvents(t){let e=t.getViewerType();this.isViewer3D?this.hookViewer3DEvents():"ViewerDrawing"===e?this.hookViewerDrawingEvents():this.hookViewerDrawingSetEvents()}hookViewer3DEvents(){var t=this.viewer.getViewer();let e=[];e.push(CLOUD.EVENTS.ON_EDITOR_ZOOM),e.push(CLOUD.EVENTS.ON_EDITOR_PANING),e.push(CLOUD.EVENTS.ON_EDITOR_ROTATING),e.push(CLOUD.EVENTS.ON_EDITOR_WALKING),e.push(CLOUD.EVENTS.ON_CAMERA_ANIMATION_UPDATE);for(const i of e)t.registerEventListener(i,(()=>{this.update()}));t.registerEventListener(CLOUD.EVENTS.ON_EXPLOSION,(()=>{this.update(!0)})),this.viewer.addEventListener(Glodon$1.Bimface.Viewer.Viewer3DEvent.FloorExplosion,(()=>{for(const t of this.clusterItems)t.meanShift=null;this.update(!0)}))}hookViewerDrawingEvents(){let t=Glodon$1.Bimface.Viewer.ViewerDrawingEvent;this.viewer.addEventListener(t.ZoomFactorChanged,(t=>{let e=!1;(null===this._lastZoomFactorData||t>=this._lastZoomFactorData)&&(e=!0),this.update(!1,e),this._lastZoomFactorData=t}))}hookViewerDrawingSetEvents(){let t=Glodon$1.Bimface.Viewer.ViewerDrawingSetEvent;this.viewer.addEventListener(t.ZoomFactorChanged,(t=>{let e=!1;(null===this._lastZoomFactorData||t>=this._lastZoomFactorData)&&(e=!0),this.update(!1,e),this._lastZoomFactorData=t}))}addCluster(t){this.clusterItems.push(t),t.setIsNeedMakingClusterTag(!0)}addClusters(t){for(const e of t)this.addCluster(e)}getClusterById(t){for(const e of this.clusterItems)if(e.getId()===t)return e;return null}getClusters(){return this.clusterItems}removeClustersById(t){let e=this.clusterItems;for(let i=e.length-1;i>=0;){let n=e[i];t.indexOf(n.id)>=0?(n.clearClusterTags(),e.splice(i--,1)):i--}}clear(){for(const t of this.clusterItems)t.clearClusterTags();this.clusterItems=[]}update(t,e){for(const i of this.clusterItems){if(this.isViewer3D){if(0===i.calcClusterLevel()){i.clearClusterTags();continue}}(t||i.isNeedClustering())&&i.clustering(e),i.updateClusterTags(this.enableAnimation)}}enableClusterAnimation(t){this.enableAnimation=t}}}(),Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Cluster").ClusterItemConfig=function(){return{scale:1,tags:[],distance:50,maxLevel:4,style:Glodon$1.Bimface.Plugins.Cluster.ClusterStyle.Success,minClusterSize:2,viewer:null}},function(){var t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Cluster");let e=Object.freeze({Danger:"#FF001F",Information:"#1A82FC",Success:"#32D3A6",Warning:"#FF9D0B"});t.ClusterStyle=e}();class ClusterItem3DImpl{constructor(t){this.viewer3d=t.viewer,this.currentLevel=0,this._maxLevel=t.maxLevel,this._minClusterSize=t.minClusterSize,this._sceneSize=new THREE.Vector3}prepareTagPositions(t){let e=[];for(let i=0;i<t.length;i++){let n=t[i].getCurrentPosition(),o=new Vector3(n.x,n.y,n.z);o.index=i,e.push(o)}return e}calcSearchRange(t){return this.currentLevel=this.calcClusterLevel(t),this.getSearchRangeScalar(this.currentLevel,this.getMaxLevel())*this.getLength(t)[1]}getSearchRangeScalar(t,e){return.5**(e-t)}calcClusterLevel(t){if(!t)return 0;let e=this.getLength(t),i=this.getMaxLevel(),n=20*e[1]/e[2],o=e[0]*n/e[1],s=Math.exp(Math.log(40)/(i-1)),r=-1;for(let t=i;t>=1;t--)if(o>=.5*s**(t-1)){r=t;break}return-1===r&&(r=0),r}getLength(t){let e=this.prepareTagPositions(t),i=this.viewer3d.getCameraStatus().position;i=new Vector3(i.x,i.y,i.z);let n=(new Box3).setFromPoints(e).getSize().length(),o=i.distanceTo(e[0]);e.forEach((t=>{const e=i.distanceTo(t);o=Math.min(o,e)}));let s=.995*this.getCameraMaxRange(),r=[];return r.push(o),r.push(n),r.push(s),r}getCameraMaxRange(){var t=this.viewer3d.getViewer(),e=t.camera;t.getBoundingBoxWorld().getSize(this._sceneSize);const i=.5*this._sceneSize.length()/Math.tan(THREE.Math.degToRad(.5*e.fov));return t.cameraControl.getMaximalRangeofCamera()*i}setMaxLevel(t){this._maxLevel=t}getMaxLevel(){return this._maxLevel}getMinClusterSize(){return this._minClusterSize}setMinClusterSize(t){this._minClusterSize=t}isLevelChanged(t){return this.calcClusterLevel(t)!==this.currentLevel}cullingByFrustum(t){for(const e of t){this.viewer3d.isInViewFrustum(e.worldPosition)?e.show():e.hide()}}getBoundingbox(t){return t.min=t.bbox.min,t.max=t.bbox.max,t}getCenter(t){return t.center}setDistance(){console.log("ClusterItem3D doesn't support setDistance.")}getDistance(){console.log("ClusterItem3D doesn't support getDistance.")}clustering(t,e){t.clustering(e,!0)}}class ClusterItemDrawingImpl{constructor(t){this.viewerDrawing=t.viewer,this.searchRange=t.distance,this._minClusterSize=t.minClusterSize}prepareTagPositions(t){let e=[];for(let i=0;i<t.length;i++){let n=t[i].getWorldPosition();n=this.viewerDrawing.worldToClient(n);let o=new Vector3(n.x,n.y,n.z);o.index=i,e.push(o)}return e}calcSearchRange(t){return this.searchRange}isLevelChanged(){return!0}setDistance(t){this.searchRange=t}getDistance(){return this.searchRange}setMaxLevel(t){console.log("Drawing clustering has no maxlevel.")}getMaxLevel(){console.log("Drawing clustering has no maxLevel.")}getMinClusterSize(){return this._minClusterSize}setMinClusterSize(t){this._minClusterSize=t}cullingByFrustum(){}getBoundingbox(t){return t}getCenter(t){let e=t.center;return this.viewerDrawing.clientToWorld(e)}clustering(t,e){t.clustering(e,!1,(t=>{const e=this.viewerDrawing.getViewer(),i=e.width,n=e.height;return!(t.x<0||t.x>i||t.y<0||t.y>n)}))}}class ClusterAnimation{constructor(){}}ClusterAnimation.time=300,ClusterAnimation.Play=function(t){const{clusterTags:e,lastClusterTags:i,clusters:n,lastClusters:o,enableAnimation:s,isZoomIn:r,tags:a,container:l}=t;(()=>{for(const t of e)t.updateText()})();!1===s||null===o||(()=>{const t=n.length;if(t!==o.length)return!1;for(let e=0;e<t;e++)if(n[e].id!==o[e].id)return!1;return!0})()||(!0===r?ClusterAnimation.ZoomInPlay(e,i,n,o,a):ClusterAnimation.ZoomOutPlay(e,i,n,o,a,l))},ClusterAnimation.getCluster=function(t,e){for(const i of t)if(i.id===e)return i},ClusterAnimation.getClusterTag=function(t,e){for(const i of t)if(i.clusterBbox.id===e)return i},ClusterAnimation.getIndices=function(t){let e=[];for(const i of t.points)e.push(i.index);return e},ClusterAnimation.getEndClientPosition=function(t){return t instanceof Glodon.Bimface.Plugins.Marker3D.Marker3D?t.position:"Viewer3D"===t.viewer.viewerType||"ViewerGIS"===t.viewer.viewerType?{x:t.worldPosition.x+t.explosionOffset.x,y:t.worldPosition.y+t.explosionOffset.y,z:t.worldPosition.z+t.explosionOffset.z}:t.clientPosition},ClusterAnimation.ZoomInPlay=function(t,e,i,n,o,s){for(const n of i){if(n.id===n.parent)continue;const i=n.parent,s=ClusterAnimation.getClusterTag(e,i);for(const r of e)if(r.clusterBbox.id===i){const e=ClusterAnimation.getClusterTag(t,n.id),i=r.clusterBbox.center;let a=null;if(e){a=e.clusterBbox.center,ClusterAnimation.CreateZoomAnimation(e,s,i,a,!0);continue}const l=ClusterAnimation.getIndices(n);for(const t of l){let e=o[t];a=ClusterAnimation.getEndClientPosition(e),a&&(e.setContainerVisible(!0),ClusterAnimation.CreateZoomAnimation(e,s,i,a,!0))}}}},ClusterAnimation.CreateZoomAnimation=function(t,e,i,n,o,s){let r=0,a=t.getOpacity(),l=a;e.show(),!0===o&&(r=1,a=0),e.setOpacity(r),t.setOpacity(a);let h=(new Date).valueOf(),c=h-16,d=0,u=()=>{const o=requestAnimationFrame(u);if(d>=1)return d=1,t.resetClientPosition(n),t.setOpacity(l),s&&s(),void cancelAnimationFrame(o);(o=>{const s={x:i.x+(n.x-i.x)*o,y:i.y+(n.y-i.y)*o,z:i.z+(n.z-i.z)*o};e.setOpacity(Math.abs(r-o)),t.setOpacity(l*Math.abs(1-r-o)),t.resetClientPosition(s)})(d),h=(new Date).valueOf();const a=h-c;c=h,d+=a/this.time};u()},ClusterAnimation.ZoomOutPlay=function(t,e,i,n,o,s){for(const r of i){const i=r.children;if(0===i.length)continue;const a=ClusterAnimation.getClusterTag(t,r.id);if(a)for(const t of i){const i=ClusterAnimation.getClusterTag(e,t),l=r.center;let h=null;if(i){h=i.clusterBbox.center,ClusterAnimation.CreateZoomOutAnimation(i,a,h,l,s);continue}const c=ClusterAnimation.getCluster(n,t),d=ClusterAnimation.getIndices(c);for(const t of d){let e=o[t];h=ClusterAnimation.getEndClientPosition(e),h&&ClusterAnimation.CreateItemZoomOutAnimation(e,a,h,l,s)}}}},ClusterAnimation.CreateZoomOutAnimation=function(t,e,i,n,o){const s=t.getContainer();o._context.rootDomElement.appendChild(s),ClusterAnimation.CreateZoomAnimation(t,e,i,n,!1,(()=>{e.show(),s.remove()}))},ClusterAnimation.CreateItemZoomOutAnimation=function(t,e,i,n,o){t.setContainerVisible(!0),t.isInAnimation=!0,ClusterAnimation.CreateZoomAnimation(t,e,i,n,!1,(()=>{e.show(),t.isInAnimation=null,t.setContainerVisible(!1)}))},function(){var t=Glodon$1.Bimface.Data.StatisticsDataManager.getInstance(),e=(Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.Dom"),Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Cluster"));class i{constructor(e){t.send("Bimface.Plugins.Cluster","ClusterItem"),this.viewer=e.viewer,this.isViewer3D="Viewer3D"===e.viewer.getViewerType()||"ViewerGIS"===e.viewer.getViewerType(),this.impl=this.isViewer3D?new ClusterItem3DImpl(e):new ClusterItemDrawingImpl(e),this.id=Glodon$1.Web.Lang.Utility.UUID.createUUID(),this.setTags(e.tags),this._isVisible=!0,this.clusterTags=[],this._mapTagIsExist={},this._mapClusterTags={},this.mapDrawableStyle={},this.mapClusterException={},this.onClusterChanged=null,this.clusterStyle=e.style,this.scale=e.scale,this._isNeedClustering=!0,this._isNeedMakingClusterTag=!0,this.meanShift=null,this._lastSearchRange=null,this._lastClusters=null,this._lastClusterTags=null}setScale(t){this.scale=t,this.makeClusterTags()}getScale(){return this.scale}getId(){return this.id}getTags(){return this._tags}addTags(t){for(let e=0;e<t.length;e++){let i=t[e];i instanceof Glodon$1.Bimface.Plugins.Drawable.MiniTag||!0!==this._mapTagIsExist[i.id]&&(this._tags.push(i),this._mapTagIsExist[i.id]=!0)}this._isNeedClustering=!0,this.meanShift=null}getMinClusterSize(){return this.impl.getMinClusterSize()}setMinClusterSize(t){"number"==typeof t&&t>0?(this.impl.setMinClusterSize(t),this._isNeedClustering=!0):console.log("Invalid param, please input valid param.")}setTags(t){if(0!==t.length){if(this._tags)for(const t of this._tags)t.isHideByClustering=!1;this._tags=[],this._mapTagIsExist={},this.addTags(t)}}removeTagsByIds(t){for(let e=this._tags.length-1;e>=0;){let i=this._tags[e];t.indexOf(i.id)>=0?(this._tags.splice(e--,1),delete this._mapTagIsExist[i.id],i.isHideByClustering=!1):e--}this._isNeedClustering=!0}setDistance(t){this.impl.setDistance(t)}getDistance(){return this.impl.getDistance()}getMaxLevel(){return this.impl.getMaxLevel()}setMaxLevel(t){this.impl.setMaxLevel(t),this._isNeedClustering=!0}onClick(t){this.onClickCallback=t;for(const t of this.clusterTags)t.onClick(this.onClickCallback)}onDoubleClick(t){this.onDoubleClickCallback=t;for(const t of this.clusterTags)t.onClick(this.onDoubleClickCallback)}onHover(t){this.onHoverCallback=t;for(const t of this.clusterTags)t.onClick(this.onHoverCallback)}hide(){for(const t of this.clusterTags)t.hide();for(let t=0;t<this._tags.length;t++)this._tags[t].isHideByClustering=!0;this._getContainer().update(),this._isVisible=!1}show(){for(const t of this.clusterTags)t.show();this._isVisible=!0,this.clustering(),this.updateClusterTags()}getClusterTagById(t){for(const e of this.clusterTags)if(e.isInclude(t))return e;return null}getClusterTag(t){let e=this._mapClusterTags[t];return e||(console.log("Can't find a cluster tag whose id is "+t),null)}onClusterChange(t){this.onClusterChanged=t}getStyle(){return this.clusterStyle}setStyle(t){this.clusterStyle=t;for(const e of this.clusterTags)e.setStyle(t)}getStyleById(t){let e=this.getClusterTag(t);return e&&e.getStyle()}setStyleById(t,e){let i=this.getClusterTag(t);return i&&i.setStyle(e)}setException(t,e){[].concat(t).forEach((t=>{this.mapDrawableStyle[t]=e}))}removeException(t){[].concat(t).forEach((t=>{delete this.mapDrawableStyle[t]}))}clearException(){let t=Object.keys(this.mapDrawableStyle),e=Glodon$1.Bimface.Plugins.Cluster.ClusterStyle.Success;t.forEach((t=>{this.mapDrawableStyle[t]=e}))}_updateMapException(){let t=Object.keys(this.mapDrawableStyle);this.mapClusterException={};let e=this.mapClusterException;for(const i of t){let t=this.getClusterTagById(i);if(!t)continue;let n=t.getId(),o=this.mapDrawableStyle[i];e[n]||(e[n]={}),e[n][o]=!0}}_updateCurrentStyle(){this._updateMapException();for(const t of this.clusterTags){let e=t.getId(),i=this.mapClusterException;if(!i[e]){this.setStyleById(e,this.clusterStyle);continue}let n=this._getStyleInOrder(i[e]);n&&this.setStyleById(e,n)}}_getStyleInOrder(t){let e=Glodon$1.Bimface.Plugins.Cluster.ClusterStyle,i=[e.Danger,e.Warning,e.Information,e.Success];for(const e of i)if(t[e])return e;return e.Success}clustering(t){if(!1===this._isVisible)return;let e=this.getTags();for(const t of e)t.isHideByClustering=!1;let i=this.impl.calcSearchRange(this.getTags()),n=this.impl.prepareTagPositions(this.getTags());null===this.meanShift&&(this.meanShift=new Glodon$1.Web.Algorithm.MeanShift(n,i)),this.meanShift.setSearchRange(i),this.meanShift.setPoints(n);let o=!0;null!=this._lastSearchRange&&this._lastSearchRange<i&&(o=!1),this.isZoomIn=void 0!==t?t:o,this.impl.clustering(this.meanShift,this.isZoomIn),this._lastSearchRange=i,this._isNeedClustering=!1,this._isNeedMakingClusterTag=!0}updateClusterTags(t){if(!1!==this._isVisible)if(this.isNeedMakingClusterTag())this.makeClusterTags(t),!1===this._isVisible&&this.hide(),this._isNeedMakingClusterTag=!1,this.onClusterChanged&&this.onClusterChanged();else if(this._isVisible)return this.impl.cullingByFrustum(this.clusterTags),this._getClusterContainer().update(),void this._updateCurrentStyle()}makeClusterTags(t){for(let t=0;t<this._tags.length;t++)this._tags[t].isHideByClustering=!1,!0===this._tags[t].forceHide&&(this._tags[t].forceHide=!1);this.clusterTags=[],this._mapClusterTags={};let e=!1;for(const t of this.meanShift.clusters){let n=this._getIndices(t);if(n.length<this.impl.getMinClusterSize())continue;let o=i.makeClusterTag(this.impl.getCenter(t),e,this.scale);e=!0;for(const e of n){let i=this._tags[e];i&&(i.isHideByClustering=!0,o.include(i),o.setBoundingBox(this.impl.getBoundingbox(t)))}o.clusterItemId=this.id,this.onClickCallback&&o.onClick(this.onClickCallback),this.onDoubleClickCallback&&o.onDoubleClick(this.onDoubleClickCallback),this.onHoverCallback&&o.onHover(this.onHoverCallback),this.clusterTags.push(o),this._mapClusterTags[o.getId()]=o}this.impl.cullingByFrustum(this.clusterTags),this._getClusterContainer().removeClusterTags(this.id),this._getClusterContainer().addItems(this.clusterTags),this._updateCurrentStyle();let n=this._getContainer();n.update(),!0===n.isMarker3DContainer&&(t=!1);const o={clusterTags:this.clusterTags,lastClusterTags:this._lastClusterTags,clusters:this.meanShift.clusters,lastClusters:this._lastClusters,enableAnimation:t,isZoomIn:this.isZoomIn,tags:this._tags,container:this.viewer.drawableContainer};ClusterAnimation.Play(o),this._lastClusterTags=this.clusterTags,this._lastClusters=this.meanShift.clusters}clearClusterTags(){if(!this._tags)return;for(let t=0;t<this._tags.length;t++)this._tags[t].isHideByClustering=!1,!0===this._tags[t].forceHide&&(this._tags[t].forceHide=!1);this._getClusterContainer().removeClusterTags(this.id),this._getContainer().update()}calcClusterLevel(){return this.impl.calcClusterLevel(this.getTags())}_getClusterContainer(){let t=this.viewer.drawableContainer;if(!t){var e=new Glodon$1.Bimface.Plugins.Drawable.DrawableContainerConfig;e.viewer=this.viewer,t=new Glodon$1.Bimface.Plugins.Drawable.DrawableContainer(e)}return t}isNeedClustering(){return this._isNeedClustering||this.impl.isLevelChanged(this.getTags())}isNeedMakingClusterTag(){return this._isNeedMakingClusterTag}setIsNeedMakingClusterTag(t){this._isNeedMakingClusterTag=t}_getContainer(){return this._tags[0]instanceof Glodon$1.Bimface.Plugins.Marker3D.Marker3D?this.viewer.marker3DContainer:this.viewer.drawableContainer}_getIndices(t){let e=[];for(const i of t.points)e.push(i.index);return e}}i.makeClusterTag=function(t,e,i){let n=new Glodon$1.Bimface.Plugins.Drawable.ClusterTagConfig;n.worldPosition=t,n.attachFilter=!e;let o=new Glodon$1.Bimface.Plugins.Drawable.ClusterTag(n);return o.setScale(i),o},e.ClusterItem=i}(),Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Measure").MeasureConfig=function(){return{viewer:null,measureType:Glodon$1.Bimface.Plugins.Measure.MeasureTypeOption.Distance,color:new Glodon$1.Web.Graphics.Color(249,157,11,1),hoverColor:new Glodon$1.Web.Graphics.Color(17,218,183,.2),width:3,radius:25,snapDistance:5,precision:{distance:3,elevation:3,area:3,angle:2,latLon:9},scale:1,units:null}},function(){var t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Measure");let e=Object.freeze({Measuring:"Measuring",Measured:"Measured",Reset:"Reset",MeasureSelected:"MeasureSelected",MeasureUnselected:"MeasureUnselected",MeasureResultUpdating:"MeasureResultUpdating",MeasureResultUpdated:"MeasureResultUpdated"});t.MeasureEvent=e}(),function(){let t=Object.freeze({Distance:"Distance",Area:"Area",Angle:"Angle",MinimumDistance:"MinimumDistance",Elevation:"Elevation",Position:"Position",PolylineDistance:"PolylineDistance",TriangleDistance:"TriangleDistance",SpatialArea:"SpatialArea",ProjectedArea:"ProjectedArea",SurfaceArea:"SurfaceArea",GroundlineDistance:"GroundlineDistance",Volume:"Volume",LaserClearDistance:"LaserClearDistance"});Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Measure").MeasureTypeOption=t}(),function(){let t=Object.freeze({None:"None",Kilometer:"Kilometer",Meter:"Meter",Centimeter:"Centimeter",Millimeter:"Millimeter"});Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Measure").LengthUnits=t}(),Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Measure").MeasureItemConfig=function(){return{id:null,color:new Glodon$1.Web.Graphics.Color(255,157,11,1),hoverColor:new Glodon$1.Web.Graphics.Color(17,218,183,.2),fillColor:new Glodon$1.Web.Graphics.Color(255,157,11,.2),objectColor:new Glodon$1.Web.Graphics.Color(17,218,183,.9),width:3,radius:25,viewer:null}};class MeasureUtil{}MeasureUtil.xmlns="http://www.w3.org/2000/svg",MeasureUtil.makeCircle=function(t){var e=document.createElementNS(MeasureUtil.xmlns,"circle");return e.style.fill=t.color,e.setAttribute("r",t.radius+""),e.setAttribute("stroke","#FFFFFF"),e.setAttribute("stroke-width",t.strokeWidth),e.setAttribute("transform","translate("+t.position.x+","+t.position.y+")"),e},MeasureUtil.makeConcentricCircle=function(t){var e=document.createElementNS(MeasureUtil.xmlns,"g"),i=document.createElementNS(MeasureUtil.xmlns,"circle");i.style.fill=t.color,i.setAttribute("r",t.innerRadius+""),i.setAttribute("stroke","#FFFFFF"),i.setAttribute("stroke-width",t.innerStrokeWidth),i.setAttribute("transform","translate("+t.position.x+","+t.position.y+")");var n=i.cloneNode();return n.setAttribute("r",t.outerRadius+""),n.setAttribute("stroke-width",t.outerStrokeWidth||0),e.appendChild(n),e.appendChild(i),e},MeasureUtil.makeLine=function(t){var e=document.createElementNS(MeasureUtil.xmlns,"line");return e.setAttribute("stroke",t.color),e.setAttribute("stroke-width",t.lineWidth),e.setAttribute("x1",t.start.x+""),e.setAttribute("y1",t.start.y+""),e.setAttribute("x2",t.end.x+""),e.setAttribute("y2",t.end.y+""),e},MeasureUtil.makeDashLine=function(t){let e=MeasureUtil.makeLine(t);return e.setAttribute("stroke-dasharray",t.dashArray||"10 8"),e},MeasureUtil.makePath=function(t){var e=document.createElementNS(MeasureUtil.xmlns,"path");let i=t.info;return e.setAttribute("d",`M ${i.pointA.x} ${i.pointA.y} A ${t.arcRadius} ${t.arcRadius} 0 0 ${i.direction} ${i.pointB.x} ${i.pointB.y}`),e.setAttribute("fill","rgba(0,0,0,0)"),e.setAttribute("stroke",t.color),e.setAttribute("stroke-width",t.lineWidth),e},MeasureUtil.makePolyline=function(t){var e=document.createElementNS(MeasureUtil.xmlns,"polyline");return e.setAttribute("stroke",t.color),e.setAttribute("stroke-width",t.width),e.style.fill=t.fillColor||"none",e.style.opacity=t.opacity||1,e.setAttribute("points",t.points),e},MeasureUtil.makePolygon=function(t){var e=document.createElementNS(MeasureUtil.xmlns,"polygon");return e.setAttribute("stroke",t.color),e.setAttribute("stroke-width",t.width),e.style.fill=t.fillColor||"none",e.setAttribute("points",t.points),e},MeasureUtil.calcPolylinePoints=function(t){for(var e="",i=0;i<t.length;i++)e+=t[i].x+","+t[i].y+" ";return e},MeasureUtil.makeRectangle=function(t){var e=document.createElementNS(MeasureUtil.xmlns,"rect");return e.setAttribute("stroke-width",2),e.setAttribute("x",t.x),e.setAttribute("y",t.y),e.setAttribute("width",t.width),e.setAttribute("height",t.height),e.setAttribute("rx",t.radius),e.style.fill=t.fillColor||"none",e.setAttribute("fill-opacity",t.fillOpacity||1),e.setAttribute("stroke",t.strokeColor||"none"),e},MeasureUtil.makeMarker=function(t){var e=document.createElementNS(this.xmlns,"marker");e.setAttribute("id",t.id),e.setAttribute("viewBox","0 0 10 10"),e.setAttribute("refX","5"),e.setAttribute("refY","5"),e.setAttribute("markerWidth",t.markerWidth||"6"),e.setAttribute("markerHeight",t.markerHeight||"6"),e.setAttribute("orient","auto-start-reverse");var i=document.createElementNS(this.xmlns,"path");i.setAttribute("d","M 0 0 L 10 5 L 0 10 z"),i.style.fill=t.color,e.appendChild(i);let n=MeasureUtil.makeDefs();return n.appendChild(e),n},MeasureUtil.makeText=function(t){var e=document.createElementNS(MeasureUtil.xmlns,"text");e.setAttribute("x",t.x),e.setAttribute("y",t.y),e.setAttribute("fill",t.color||"#000"),e.setAttribute("font-size",t.fontsize);var i=t.content?t.content.split("\n"):[""];if(i.length>1)for(let o=0;o<i.length;o++){var n=document.createElementNS(MeasureUtil.xmlns,"tspan");n.setAttribute("x",t.x),n.setAttribute("y",t.y+30*o),n.textContent=i[o],e.appendChild(n)}else e.textContent=i[0];return e},MeasureUtil.makeDefs=function(){return document.createElementNS(this.xmlns,"defs")},MeasureUtil.measureText=function(t,e='14px "Microsoft YaHei'){var i=document.createElement("canvas").getContext("2d");return i.font=e,i.measureText(t).width},MeasureUtil.distanceToSegment=function(t,e,i){var n=e.distanceToSquared(i);if(0==n)return t.distanceTo(e);var o=((t.x-e.x)*(i.x-e.x)+(t.y-e.y)*(i.y-e.y))/n;o=Math.max(0,Math.min(1,o));let s=new Vector2;return s.x=e.x+o*(i.x-e.x),s.y=e.y+o*(i.y-e.y),t.distanceTo(s)},MeasureUtil.isPointInPolygon=function(t,e){let i=0,n=e.length;for(let o=0;o<n;o++){let s=e[o],r=e[(o+1)%n];s.y!=r.y&&(t.y<Math.min(s.y,r.y)||t.y>=Math.max(s.y,r.y)||(t.y-s.y)*(r.x-s.x)/(r.y-s.y)+s.x>t.x&&i++)}return i%2==1},MeasureUtil.isPointInTriangle=function(t,e){const{a:i,b:n,c:o}=e;let s=n.clone().sub(i),r=o.clone().sub(i),a=t.clone().sub(i),l=s.clone().cross(r),h=s.clone().cross(a);return l.dot(h)>=0},MeasureUtil.calcSpatialArea=function(t){let e=new THREE.Vector3,i=new THREE.Vector3;const n=t.length;if(n<3)return 0;let o=0,s=new THREE.Triangle;for(let r=2;r<n;r++){let n=s.clone().set(t[r-1],t[r],t[0]),a=n.getArea();if(r>2){let o=s.getNormal(e),l=n.getNormal(i),h=o.angleTo(l);if((Math.abs(h-3.1415)<2e-4||Math.abs(h)<2e-4)&&(s.containsPoint(t[r])||n.containsPoint(t[r-2]))){let t=s.getArea();a=Math.abs(a-t)-t}}o+=a,s.copy(n)}return o},MeasureUtil.calcProjectedArea=function(t){let e=[];return t.forEach((t=>{let i=t.clone();i.z=0,e.push(i)})),this.calcSpatialArea(e)},MeasureUtil.cutFillAnalysis=null,MeasureUtil.calcSurfaceArea=function(t,e){let i=0;if(t.length<3||!e)return this.console.warn("Parameter points or viewer is invalid."),i;let n=e.getViewer(),o=t.map((t=>n.worldToDrawing(t)));return MeasureUtil.cutFillAnalysis?MeasureUtil.cutFillAnalysis.effectOpt({boundary:o}):MeasureUtil.cutFillAnalysis=new CLOUD.CutFillMeasure({boundary:o,viewer:e}),i=MeasureUtil.cutFillAnalysis.getTotalSuperficialArea(),i};class MeasureNotation{constructor(t){this.type=t,this.observer=null}initialize(){this.notationSelected=[],this.notationUnselected=[],this.notationSegmentRects=[]}drawAnnotation(t,e){}calcAnnotationStyle(t,e){}select(){this.isInitialized()&&(this.notationUnselected.forEach((t=>{t.style.display="none"})),this.notationSelected.forEach((t=>{t.style.display="block"})))}unselect(){this.isInitialized()&&(this.notationUnselected.forEach((t=>{t.style.display="block"})),this.notationSelected.forEach((t=>{t.style.display="none"})))}dropShadow(t){this.isInitialized()&&this.notationUnselected.forEach((e=>{e.setAttribute("filter",t),e.setAttribute("filter",t)}))}isInitialized(){return!!this.notationUnselected&&!!this.notationSelected}clear(){this.notationSelected=[],this.notationUnselected=[],this.notationSegmentRects=[]}hitTest(t){if(!this.isInitialized())return!1;let e=this.hitTestEpsilon;return this.notationSegmentRects.some((i=>MeasureUtil.distanceToSegment(t,i.start,i.end)<=e))}}class MeasureViewer3dNotation extends MeasureNotation{constructor(t){super(t),this.defaultColor="#F99D0B",this.initialize()}initialize(){super.initialize(),this.annotationStyle={height:21,radius:4},this.hitTestEpsilon=this.annotationStyle.height/2}drawAnnotation(t,e,i,n){var o=this.calcAnnotationStyle(e,t),s=MeasureUtil.makeRectangle({x:o.offsetRect.x,y:o.offsetRect.y,width:o.width,height:this.annotationStyle.height,radius:this.annotationStyle.radius,fillColor:n||this.defaultColor});this.notationUnselected.push(s);let r=MeasureUtil.makeRectangle({x:o.offsetRect.x-2,y:o.offsetRect.y-2,width:o.width+4,height:this.annotationStyle.height+4,radius:this.annotationStyle.radius,strokeColor:"#FFFFFF",fillColor:n||this.defaultColor});this.notationSelected.push(r);let a=new Vector2(o.offsetRect.x,o.offsetRect.y+this.annotationStyle.height/2),l=new Vector2(o.offsetRect.x+o.width,a.y);this.notationSegmentRects.push({start:a,end:l});var h=MeasureUtil.makeText({x:o.offsetText.x,y:o.offsetText.y,color:"#FFFFFF",fontsize:14,content:e});return this.svgGroup=[],this.svgGroup.push(s),this.svgGroup.push(r),this.svgGroup.push(h),this.unselect(),this.svgGroup}calcAnnotationStyle(t,e){var i=0,n=new Vector2(e.x,e.y),o=new Vector2(e.x,e.y);return"Elevation"!==this.type&&(i=MeasureUtil.measureText(t),n.x-=i/2,n.y-=this.annotationStyle.height/2,o.x=n.x+5,o.y=n.y+19-3.5),"Elevation"==this.type&&(n.x-=12,n.y-=39,o.x=n.x+5,o.y=n.y+19-3.5,i=MeasureUtil.measureText(t)),{offsetRect:n,offsetText:o,width:i+=10}}}class MeasureViewerGISNotation extends MeasureNotation{constructor(t,e){super(t),this.defaultColor=e||"#20262F",this.initialize()}initialize(){super.initialize(),this.annotationStyle={height:this.calcAnnotationHeight(),radius:this.calcAnnotationRadius(),fillOpacity:.85},this.hitTestEpsilon=this.annotationStyle.height/2}drawAnnotation(t,e,i,n){var o=this.calcAnnotationStyle(e,t,n),s=MeasureUtil.makeRectangle({x:o.offsetRect.x,y:o.offsetRect.y,width:o.width,height:this.annotationStyle.height,radius:this.annotationStyle.radius,fillColor:this.defaultColor,fillOpacity:this.annotationStyle.fillOpacity});let r=new Vector2(o.offsetRect.x,o.offsetRect.y+this.annotationStyle.height/2),a=new Vector2(o.offsetRect.x+o.width,r.y);this.notationSegmentRects.push({start:r,end:a});let l=MeasureUtil.makeText({x:o.offsetText.x,y:o.offsetText.y,color:"#FFFFFF",fontsize:14,content:e});this.notationSelected.push(l);let h=MeasureUtil.makeText({x:o.offsetText.x,y:o.offsetText.y,color:"#A4A8AE",fontsize:14,content:e});if(this.notationUnselected.push(h),this.svgGroup=[],this.type==Glodon.Bimface.Plugins.Measure.MeasureTypeOption.Position){var c=MeasureUtil.makeRectangle({x:o.offsetArrow.x,y:o.offsetArrow.y,width:7,height:7,radius:0,fillColor:this.defaultColor,fillOpacity:this.annotationStyle.fillOpacity});c.setAttribute("transform",`rotate(45 ${o.offsetArrow.x} ${o.offsetArrow.y})`),this.svgGroup.push(c)}return this.svgGroup.push(s),this.svgGroup.push(h),this.svgGroup.push(l),this.unselect(),this.svgGroup}calcAnnotationStyle(t,e,i){var n=0,o=this.annotationStyle.height,s=new Vector2(e.x,e.y),r=new Vector2(e.x,e.y),a=new Vector2(e.x,e.y);if(this.type==Glodon.Bimface.Plugins.Measure.MeasureTypeOption.Position){t.split("\n").forEach((t=>{let e=MeasureUtil.measureText(t);n=e>n?e:n})),n+=10,s.x-=n/2+5,s.y-=o+8+10,r.x=s.x+10,r.y=s.y+30-3.5}else n=MeasureUtil.measureText(t),!0===i?s.x+=15:s.x-=n/2,s.y-=this.annotationStyle.height/2,r.x=s.x+5,r.y=s.y+19-3.5;return a.y-=22.5,{offsetRect:s,offsetText:r,offsetArrow:a,width:n+=10}}calcAnnotationHeight(){let t=21;return"Position"==this.type&&(t=100),t}calcAnnotationRadius(){let t=4;return"Position"==this.type&&(t=0),t}}!function(){let t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Measure"),e=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.Dom"),i=new Glodon$1.Web.Graphics.Color(17,218,183,.2),n=function(t){this.id=t.id||Glodon$1.Web.Lang.Utility.UUID.createUUID(),this.nextMeasurePoint=null,this.measurePoints=[],this.maxPointsNum=2,this.measureResult=null,this.measureParams={precision:t.precision,scale:t.scale,unit:t.unit,defaultUnit:t.defaultUnit},this.measureItemConfig=t,this.viewer=t.viewer;t.color.getRGBA();let n=e.createNS("circle","bf-measure-handle");n.setAttribute("stroke-width",0),n.setAttribute("r",t.width),n.setAttribute("fill",i.getRGB()),n.style.fill=i.getRGB();let o=e.createNS("line","bf-measure-line");o.style.strokeWidth=2,o.style.stroke=i.getRGB();let s=e.createNS("polygon","bf-measure-rect");s.setAttribute("fill",i.getRGBA()),s.setAttribute("stroke",i.getRGB()),s.setAttribute("stroke-width",1);var r=e.createNS("path","bf-measure-foot");r.setAttribute("fill","none"),r.setAttribute("stroke",i.getRGB()),r.setAttribute("stroke-width",2),this.hoverFoot=r,this.hoverPoint=n,this.hoverLine=o,this.hoverPanel=s,this.hoverPanelSize={width:20,height:20},this.defaultColor=`#${t.color.getHEX()}`||"#F99D0B",this.lineWidth="3",this.radius=5,this.strokeWidth=2,this.measureType=t.measureType,this.notation="ViewerGIS"===this.viewer.getViewerType()?new MeasureViewerGISNotation(this.measureType):new MeasureViewer3dNotation(this.measureType),this.isReserverd=!1,this.hoverPositionUpdated=!1};n.prototype={stretchOnDirection:function(t,e,i){let n=t.clone().add(e).multiplyScalar(.5),o=e.clone().sub(t).normalize();return[n.clone().sub(o.clone().multiplyScalar(i/2)),n.clone().add(o.clone().multiplyScalar(i/2))]},draw:function(t){},drawLine(t){if(0===t.length)return;let e=MeasureUtil.makeLine({start:t[0],end:t[1],color:this.defaultColor,lineWidth:this.lineWidth});this._svg.appendChild(e)},drawTerminalPoint(t){let e=MeasureUtil.makeCircle({position:t,radius:this.radius,strokeWidth:this.strokeWidth,color:this.defaultColor});e.setAttribute("filter",this.filterUrl),this._svg.appendChild(e)},drawNotation(t,e,i){if(0===t.length)return;let n=this.notation.drawAnnotation({x:(t[0].x+t[1].x)/2,y:(t[0].y+t[1].y)/2},e,this.id,i);for(const t of n)this._svg.appendChild(t)},drawCaptureItem:function(t){let e=this.hoverPoint,i=this.hoverLine,n=this.hoverPanel,o=this.hoverPanelSize;switch(t.hoverObjectType){case"Point":e.setAttribute("cx",t.hoverPosition.x),e.setAttribute("cy",t.hoverPosition.y),t.svg.appendChild(e);break;case"Line":if(t.footPoint){let e=t.footPoint.x,i=t.footPoint.y;this.hoverFoot.setAttribute("d",`M ${e},${i-12} v 12 h 12 M ${e},${i-7} h 7 v 7`),t.svg.appendChild(this.hoverFoot)}else i.setAttribute("x1",t.lineStartPoint.x),i.setAttribute("y1",t.lineStartPoint.y),i.setAttribute("x2",t.lineEndPoint.x),i.setAttribute("y2",t.lineEndPoint.y),t.svg.appendChild(i);break;case"Panel":let s=t.clientPts,r=s[0].distanceTo(s[1]),a=s[0].distanceTo(s[3]),l=r/o.width,h=a/o.height;if(1!=l){let t=this.stretchOnDirection(s[0],s[1],o.width),e=this.stretchOnDirection(s[2],s[3],o.width);s=t.concat(e)}if(1!=h){let t=this.stretchOnDirection(s[0],s[3],o.height),e=this.stretchOnDirection(s[1],s[2],o.height);s=[t[0],e[0],e[1],t[1]]}let c="";for(let t=0;t<s.length;t++)c+=s[t].x+",",c+=s[t].y+" ";n.setAttribute("points",c),t.svg.appendChild(n)}},reset:function(){if(this.measurePoints=[],this.nextMeasurePoint=null,this.measureResult=null,this._svg){for(var t=this._svg.childNodes,e=t.length-1;e>-1;e--)this._svg.removeChild(t[e]);this._svg.innerHTML=""}},addPoint:function(t){if(this.measurePoints.length==this.maxPointsNum)this.reset();else if(this.measurePoints.length>0){let e=this.measurePoints.length,i=this.measurePoints[e-1];if(t.x===i.x&&t.y===i.y&&t.z===i.z)return}this.measurePoints.push(t),this.setIsReserverd(!1)},redo:function(){this.measurePoints.length>0&&this.measurePoints.length<this.maxPointsNum?this.measurePoints.pop():this.measurePoints=[]},getPoints:function(){return this.measurePoints},calcLine:function(t,e){let i=[];var n=this.viewer.getViewer(),o=this.viewer.getDomElement().getBoundingClientRect(),s=n.worldPointsToClient(t,e);if(s){t=new THREE.Vector2(s.start.x-o.left,s.start.y-o.top),e=new THREE.Vector2(s.end.x-o.left,s.end.y-o.top);i.push(t,e)}return i},setMeasureParams:function(t){this.measureParams.precision=t.precision,this.measureParams.scale=t.scale,this.measureParams.unit=t.unit,this.measureParams.defaultUnit=t.defaultUnit},setIsReserverd:function(t){this.isReserverd=t},getIsReserverd:function(){return this.isReserverd}},t.MeasureItem=n}(),function(){let t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility"),e=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Measure"),i=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.Dom"),n=(new Glodon$1.Web.Graphics.Color(17,218,183,.2),function(t){e.MeasureItem.call(this,t),this.maxPointsNum=2,this.measurePoints=[];var n=t.color.getRGBA(),o=i.createNS("circle","bf-measure-handle");o.setAttribute("stroke-width",0),o.setAttribute("r",5),o.setAttribute("stroke","#FFFFFF"),o.setAttribute("stroke-width",2),o.setAttribute("fill",n),o.style.fill=n;var s=o.cloneNode(),r=i.createNS("line","bf-measure-line"),a=r.cloneNode();a.style.strokeWidth=2,a.setAttribute("stroke-dasharray","6,4");var l=a.cloneNode(),h=a.cloneNode();r.style.strokeWidth=t.width,r.style.stroke=t.color.getRGBA(),a.style.stroke="#CC021B",l.style.stroke="#7CCF21",h.style.stroke="#4A90E2",r.setAttribute("stroke-width",t.width),this.line=r,this.lineX=a,this.lineY=l,this.lineZ=h,this.startPoint=o,this.endPoint=s});t.Type.inheritPrototype(n,e.MeasureItem);n.prototype=Object.assign(n.prototype,{stretchOnDirection:function(t,e,i){var n=t.clone().add(e).multiplyScalar(.5),o=e.clone().sub(t).normalize();return[n.clone().sub(o.clone().multiplyScalar(i/2)),n.clone().add(o.clone().multiplyScalar(i/2))]},draw:function(t){var e=this.line,i=this.lineX,n=this.lineY,o=this.lineZ,s=this.startPoint,r=this.endPoint;if(this._svg=t.svg,this.drawCaptureItem(t),!this.getIsReserverd())switch(t.clientPoints.length){case 2:var a=t.auxLines[0],l=t.auxLines[1],h=t.auxLines[2];a&&(i.setAttribute("x1",a.start.x),i.setAttribute("y1",a.start.y),i.setAttribute("x2",a.end.x),i.setAttribute("y2",a.end.y),t.svg.appendChild(i)),l&&(n.setAttribute("x1",l.start.x),n.setAttribute("y1",l.start.y),n.setAttribute("x2",l.end.x),n.setAttribute("y2",l.end.y),t.svg.appendChild(n)),h&&(o.setAttribute("x1",h.start.x),o.setAttribute("y1",h.start.y),o.setAttribute("x2",h.end.x),o.setAttribute("y2",h.end.y),t.svg.appendChild(o)),s.setAttribute("cx",t.clientPoints[1].x),s.setAttribute("cy",t.clientPoints[1].y),r.setAttribute("cx",t.clientPoints[0].x),r.setAttribute("cy",t.clientPoints[0].y),e.setAttribute("x1",t.clientPoints[0].x),e.setAttribute("y1",t.clientPoints[0].y),e.setAttribute("x2",t.clientPoints[1].x),e.setAttribute("y2",t.clientPoints[1].y),t.svg.appendChild(s),t.svg.appendChild(r),t.svg.appendChild(e);break;case 1:s.setAttribute("cx",t.clientPoints[0].x),s.setAttribute("cy",t.clientPoints[0].y),this.getPoints().length!=this.maxPointsNum&&t.hoverPosition&&(e.setAttribute("x1",t.clientPoints[0].x),e.setAttribute("y1",t.clientPoints[0].y),e.setAttribute("x2",t.hoverPosition.x),e.setAttribute("y2",t.hoverPosition.y),t.svg.appendChild(e)),t.svg.appendChild(s)}}}),e.MeasureDistanceItem=n}();class MeasureResultFormat{constructor(){}static formatDistance(t,e){if(null==t)return null;let i=e.precision,n=e.scale||1,o=e.unit,s=1;return"Centimeter"===o?s=10:"Meter"===o?s=1e3:"Kilometer"===o&&(s=1e6),"m"===e.defaultUnit&&(n*=1e3),t*=n,t/=s,this.formatPrecision(t,i)}static formatArea(t,e){let i=e.precision,n=e.scale,o=e.unit,s=1;return"Centimeter"===o?s=100:"Meter"===o?s=1e6:"Kilometer"===o&&(s=1e13),"m"===e.defaultUnit&&(n*=1e3),t*=Math.pow(n,2),t/=s,this.formatPrecision(t,i)}static formatCubic(t,e){let i=e.precision,n=e.scale,o=e.unit,s=1;return"Centimeter"===o?s=1e3:"Meter"===o?s=1e9:"Kilometer"===o&&(s=1e19),"m"===e.defaultUnit&&(n*=1e3),t*=Math.pow(n,3),t/=s,i?this.toLocaleString(this.formatPrecision(t,i)):this.formatPrecision(t,i)}static getPostFix(t,e){if("None"===t)return"";let i={None:"",Kilometer:"km",Meter:"m",Centimeter:"cm",Millimeter:"mm"}[t];return e?i+="²":i=" "+i,i}static toLocaleString(t){let e=t.toString();return e=e.replace(/\d{1,3}(?=((\d{3})+(\.\d+)?)$)/g,"$&,"),e}static formatPrecision(t,e){if(t=parseInt(Math.round(t*Math.pow(10,e)))/Math.pow(10,e),0!=e){let i=t.toFixed(e).split(".");t=i[0]+"."+i[1]}else t=this.toLocaleString(t);return t}}!function(){let t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility"),e=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Measure"),i=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.Dom"),n=(new Glodon$1.Web.Graphics.Color(17,218,183,.2),function(t){e.MeasureItem.call(this,t),this.maxPointsNum=3,this.radius=t.radius,this.measurePoints=[];var n=t.color.getRGBA(),o=i.createNS("circle","bf-measure-handle");o.setAttribute("stroke-width",0),o.setAttribute("r",5),o.setAttribute("stroke","#FFFFFF"),o.setAttribute("stroke-width",2),o.setAttribute("fill",n),o.style.fill=n;var s=o.cloneNode(),r=o.cloneNode(),a=i.createNS("path","bf-measure-angle");a.setAttribute("fill","rgba(0,0,0,0)"),a.setAttribute("stroke",n),a.setAttribute("stroke-width",t.width);var l=i.createNS("line","bf-measure-line");l.style.strokeWidth=t.width,l.style.stroke=n,l.setAttribute("stroke-width",t.width);var h=l.cloneNode(),c=i.create("span","bf-measure-number");c.style.backgroundColor=t.color.getRGBA(),this.points=[o,s,r],this.lines=[l,h],this.angleLine=a,this.text=c});t.Type.inheritPrototype(n,e.MeasureItem);var o={_getPoint:function(t,e,i,n){t=new THREE.Vector2(t.x,t.y),e=new THREE.Vector2(e.x,e.y),i=new THREE.Vector2(i.x,i.y);var o=1,s=t.sub(e),r=i.sub(e);if(s.length()<n||r.length()<n)return!1;s.setLength(n),r.setLength(n);var a=s.angle(),l=180*(r.angle()-a)/Math.PI;return l<0&&(l+=360),o=l<180?1:0,{pointA:e.clone().add(s),pointB:e.clone().add(r),flag:1,direction:o}},draw:function(t,e){var i=this.points;if(this._svg=t.svg,this.drawCaptureItem(t),this.getIsReserverd())return;for(var n=0,o=t.clientPoints.length;n<o;n++)t.clientPoints[n]&&(i[n].setAttribute("cx",t.clientPoints[n].x),i[n].setAttribute("cy",t.clientPoints[n].y),t.svg.appendChild(i[n]));"ViewerGIS"===this.viewer.viewerType?this.drawAngleWithResult(t,e):this.drawAngle(t)},drawAngle:function(t){var e=this.lines,i=this.angleLine;switch(t.clientPoints.length){case 3:e[0].setAttribute("x1",t.clientPoints[0].x),e[0].setAttribute("y1",t.clientPoints[0].y),e[0].setAttribute("x2",t.clientPoints[1].x),e[0].setAttribute("y2",t.clientPoints[1].y),e[1].setAttribute("x1",t.clientPoints[1].x),e[1].setAttribute("y1",t.clientPoints[1].y),e[1].setAttribute("x2",t.clientPoints[2].x),e[1].setAttribute("y2",t.clientPoints[2].y);var n=this.radius,o=this._getPoint(t.clientPoints[0],t.clientPoints[1],t.clientPoints[2],n);o&&(i.setAttribute("d",`M ${o.pointA.x} ${o.pointA.y} A ${n} ${n} 0 0 ${o.direction} ${o.pointB.x} ${o.pointB.y}`),t.svg.appendChild(i)),t.svg.appendChild(e[1]),t.svg.appendChild(e[0]);break;case 2:e[0].setAttribute("x1",t.clientPoints[0].x),e[0].setAttribute("y1",t.clientPoints[0].y),e[0].setAttribute("x2",t.clientPoints[1].x),e[0].setAttribute("y2",t.clientPoints[1].y),t.svg.appendChild(e[0]),this.getPoints().length!=this.maxPointsNum&&t.hoverPosition&&(e[1].setAttribute("x1",t.clientPoints[1].x),e[1].setAttribute("y1",t.clientPoints[1].y),e[1].setAttribute("x2",t.hoverPosition.x),e[1].setAttribute("y2",t.hoverPosition.y),t.svg.appendChild(e[1]));break;case 1:this.getPoints().length!=this.maxPointsNum&&t.hoverPosition&&(e[0].setAttribute("x1",t.clientPoints[0].x),e[0].setAttribute("y1",t.clientPoints[0].y),e[0].setAttribute("x2",t.hoverPosition.x),e[0].setAttribute("y2",t.hoverPosition.y),t.svg.appendChild(e[0]))}},drawAngleWithResult:function(t,e){var i=this.lines,n=this.angleLine;switch(this.measureResult=e.angle,t.clientPoints.length){case 2:i[0].setAttribute("x1",t.clientPoints[0].x),i[0].setAttribute("y1",t.clientPoints[0].y),i[0].setAttribute("x2",t.clientPoints[1].x),i[0].setAttribute("y2",t.clientPoints[1].y),i[1].setAttribute("x1",t.clientPoints[1].x),i[1].setAttribute("y1",t.clientPoints[1].y),i[1].setAttribute("x2",t.hoverPosition.x),i[1].setAttribute("y2",t.hoverPosition.y);var o=this.radius,s=this._getPoint(t.clientPoints[0],t.clientPoints[1],t.hoverPosition,o);s&&(n.setAttribute("d",`M ${s.pointA.x} ${s.pointA.y} A ${o} ${o} 0 0 ${s.direction} ${s.pointB.x} ${s.pointB.y}`),t.svg.appendChild(n)),t.svg.appendChild(i[1]),t.svg.appendChild(i[0]),this.drawNotation(t,s);break;case 1:this.getPoints().length!=this.maxPointsNum&&t.hoverPosition&&(i[0].setAttribute("x1",t.clientPoints[0].x),i[0].setAttribute("y1",t.clientPoints[0].y),i[0].setAttribute("x2",t.hoverPosition.x),i[0].setAttribute("y2",t.hoverPosition.y),t.svg.appendChild(i[0]))}},drawNotation(t,e){if(e){var i=new THREE.Vector2((e.pointA.x+e.pointB.x)/2,(e.pointA.y+e.pointB.y)/2),n=new THREE.Vector2(t.clientPoints[1].x,t.clientPoints[1].y),o=i.clone().sub(n).normalize().multiplyScalar(35);i=n.clone().add(o);let s=this.notation.drawAnnotation(i,this.getMeasureResult(),this.id);for(const e of s)t.svg.appendChild(e)}},getMeasureResult(){this.measureParams.unit;let t=this.measureResult.toString();return MeasureResultFormat.formatPrecision(t,this.measureParams.precision).split(",").join("")+"°"}};n.prototype=Object.assign(n.prototype,o),e.MeasureAngleItem=n}(),function(){let t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility"),e=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Measure"),i=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.Dom"),n=function(t){e.MeasureItem.call(this,t),this.maxPointsNum=2,this.measurePoints=[],this.opt=t,this.minDistanceLine=null,this.svgContainer=i.createNS("svg","bf-minDistanceMeasure-svg"),this.startPoint=i.createNS("circle","bf-minDistanceMeasure-handle"),this.endPoint=i.createNS("circle","bf-minDistanceMeasure-handle"),this.line=i.createNS("line","bf-minDistanceMeasure-line")};t.Type.inheritPrototype(n,e.MeasureItem);n.prototype=Object.assign(n.prototype,{draw:function(t){},setMinDistanceLine:function(t){this.minDistanceLine=t},clearMinDistanceLine:function(){var t=this.startPoint;t.parentNode&&this.svgContainer.removeChild(t);var e=this.endPoint;e.parentNode&&this.svgContainer.removeChild(e);var i=this.line;i.parentNode&&this.svgContainer.removeChild(i)},addPoint:function(t){var e=this.opt.viewer;this.opt.objectColor;this.measurePoints.length==this.maxPointsNum&&this.reset();var i=!1;this.measurePoints.some((e=>(e.modelId===t.modelId&&e.userId===t.userId&&(i=!0),i))),i||(this.measurePoints.push(t),(t.modelId?e.getModel(t.modelId):e).addSelectedComponentsById([t.userId]),e.render())},reset:function(t){var e=this.opt.viewer;!1!==t&&this.measurePoints.forEach((t=>{(t.modelId?e.getModel(t.modelId):e).removeSelectedId([t.userId])})),this.measurePoints=[],this.clearMinDistanceLine(),this.minDistanceLine=null,e.render()},redo:function(){var t=this.opt.viewer;if(this.measurePoints.length>0&&this.measurePoints.length<this.maxPointsNum){var e=this.measurePoints.pop();(e.modelId?t.getModel(e.modelId):t).removeSelectedId([e.userId]),t.render()}else this.reset()}}),e.MeasureMinimumDistanceItem=n}(),function(){let t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility"),e=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Measure"),i=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.Dom"),n=function(t){e.MeasureItem.call(this,t),this.viewer=t.viewer,this.maxPointsNum=1;var n=new Glodon$1.Web.Graphics.Color(17,218,183,.2),o=i.createNS("circle","bf-measure-handle");o.setAttribute("r",t.width),o.setAttribute("fill",n.getRGB()),o.style.fill=n.getRGB();var s=i.createNS("line","bf-measure-line");s.style.strokeWidth=2,s.style.stroke=n.getRGB();var r=i.createNS("polygon","bf-measure-rect");r.setAttribute("fill",n.getRGBA()),r.setAttribute("stroke",n.getRGB()),r.setAttribute("stroke-width",1),this.hoverLine=s,this.hoverPoint=o,this.hoverPanel=r,this.hoverPanelSize={width:20,height:20}};t.Type.inheritPrototype(n,e.MeasureItem);n.prototype=Object.assign(n.prototype,{stretchOnDirection:function(t,e,i){var n=t.clone().add(e).multiplyScalar(.5),o=e.clone().sub(t).normalize();return[n.clone().sub(o.clone().multiplyScalar(i/2)),n.clone().add(o.clone().multiplyScalar(i/2))]},draw:function(t){var e=this.hoverLine,i=this.hoverPoint,n=this.hoverPanel,o=this.hoverPanelSize;switch(t.hoverObjectType){case"Point":i.setAttribute("cx",t.hoverPosition.x),i.setAttribute("cy",t.hoverPosition.y),t.svg.appendChild(i);break;case"Line":e.setAttribute("x1",t.lineStartPoint.x),e.setAttribute("y1",t.lineStartPoint.y),e.setAttribute("x2",t.lineEndPoint.x),e.setAttribute("y2",t.lineEndPoint.y),t.svg.appendChild(e);break;case"Panel":var s=t.clientPts,r=s[0].distanceTo(s[1]),a=s[0].distanceTo(s[3]),l=r/o.width,h=a/o.height;if(1!=l){var c=this.stretchOnDirection(s[0],s[1],o.width),d=this.stretchOnDirection(s[2],s[3],o.width);s=c.concat(d)}if(1!=h){c=this.stretchOnDirection(s[0],s[3],o.height),d=this.stretchOnDirection(s[1],s[2],o.height);s=[c[0],d[0],d[1],c[1]]}for(var u="",p=0;p<s.length;p++)u+=s[p].x+",",u+=s[p].y+" ";n.setAttribute("points",u),t.svg.appendChild(n)}}}),e.MeasureElevationItem=n}(),function(){let t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility"),e=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Measure"),i=(Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.Dom"),function(t){e.MeasureItem.call(this,t),this.maxPointsNum=1,this.measurePoints=[],this.measureAllPoints=[],this.opt=t});t.Type.inheritPrototype(i,e.MeasureItem);var n={draw:function(t){},addPoint:function(t){var e=this.opt.viewer;this.opt.objectColor;this.measurePoints.length==this.maxPointsNum&&this.reset();var i=!1;this.measurePoints.some((e=>(e.modelId===t.modelId&&e.userId===t.userId&&(i=!0),i))),i||(this.measurePoints.push(t),(t.modelId?e.getModel(t.modelId):e).addSelectedComponentsById([t.userId]),e.render())},reset:function(t){var e=this.opt.viewer;!1!==t&&(console.info(JSON.parse(JSON.stringify(this.measurePoints))),this.measurePoints.forEach((t=>{(t.modelId?e.getModel(t.modelId):e).removeSelectedId([t.userId])}))),this.measurePoints=[],e.render()}};i.prototype=Object.assign(i.prototype,n),e.MeasureVolumeItem=i}();const measureNS=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Measure"),DomNS=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.Dom");class MeasureLaserClearDistanceItem extends measureNS.MeasureItem{constructor(t){super(t),this.opt=t,this.maxPointsNum=1;const e=new Glodon$1.Web.Graphics.Color(17,218,183,.2),i=DomNS.createNS("circle","bf-measure-handle");i.setAttribute("r",t.width),i.setAttribute("fill",e.getRGB()),i.style.fill=e.getRGB();const n=DomNS.createNS("line","bf-measure-line");n.style.strokeWidth=2,n.style.stroke=e.getRGB();const o=DomNS.createNS("polygon","bf-measure-rect");o.setAttribute("fill",e.getRGBA()),o.setAttribute("stroke",e.getRGB()),o.setAttribute("stroke-width",1),this.hoverLine=n,this.hoverPoint=i,this.hoverPanel=o,this.hoverPanelSize={width:20,height:20};const s=this.viewer.getDomElement();let r=document.getElementsByClassName("bf-measure-dragbutton")[0];if(!r){r=document.createElement("div"),r.innerHTML='\n        <svg width="160px" height="160px" viewBox="0 0 160 160" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n          <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">\n            <g>\n              <g fill="#FFFFFF" fill-opacity="0.3" stroke="#999999" stroke-width="2">\n                <path d="M80,1 C82.7908696,1 85.5479441,1.14468216 88.264129,1.4269862 C89.0464893,1.50830005 89.8254567,1.60103155 90.6008619,1.70501165 C95.2372276,2.32673796 99.7462267,3.35063053 104.091601,4.74047874 C109.461201,6.4579211 114.580945,8.73415789 119.382458,11.5007405 C131.430077,18.4424547 141.474355,28.4710659 148.435065,40.506339 C155.154653,52.1247049 159,65.6133154 159,80 C159,101.815248 150.157624,121.565248 135.861436,135.861436 C121.565248,150.157624 101.815248,159 80,159 C58.1847524,159 38.4347524,150.157624 24.1385643,135.861436 C9.84237619,121.565248 1,101.815248 1,80 C1,58.1847524 9.84237619,38.4347524 24.1385643,24.1385643 C38.4347524,9.84237619 58.1847524,1 80,1 Z" id="Oval-2"></path>\n              </g>\n              <circle fill-opacity="0.8" fill="#FFFFFF" cx="80" cy="80" r="40"></circle>\n              <g transform="translate(58.000000, 58.000000)" fill="#32D3A6" fill-rule="nonzero">\n                <path d="M23.2727273,27.1515152 L23.2727273,36.8484848 L29.0909091,36.8484848 L22.3030303,44.6060606 L15.5151515,36.8484848 L21.3333333,36.8484848 L21.3333333,27.1515152 L23.2727273,27.1515152 Z M36.8484848,15.5151515 L44.6060606,22.3030303 L36.8484848,29.0909091 L36.8484848,23.2707879 L27.1515152,23.2727273 L27.1515152,21.3333333 L36.8484848,21.3313939 L36.8484848,15.5151515 Z M7.75757576,15.5151515 L7.75757576,21.3333333 L17.4545455,21.3333333 L17.4545455,23.2727273 L7.75757576,23.2727273 L7.75757576,29.0909091 L0,22.3030303 L7.75757576,15.5151515 Z M22.3030303,0 L29.0909091,7.75757576 L23.2727273,7.75757576 L23.2727273,17.4545455 L21.3333333,17.4545455 L21.3333333,7.75757576 L15.5151515,7.75757576 L22.3030303,0 Z" id="形状"></path>\n              </g>\n            </g>\n          </g>\n        </svg>\n      ',r.className="bf-measure-dragbutton",r.style.display="none";let t=this.dragEvents={touchmove:t=>{let{top:e,left:i}=s.getBoundingClientRect(),{clientX:n,clientY:o}=t.touches[0];this.setButtonPosition(r,n-i,o-e);const a=new Touch({identifier:Date.now(),target:s,clientX:n,clientY:o,radiusX:2.5,radiusY:2.5,rotationAngle:10,force:.5}),l=new TouchEvent("touchstart",{touches:[a]});s.dispatchEvent(l);const h=new TouchEvent("touchend");s.dispatchEvent(h),t.stopPropagation(),t.preventDefault()}};for(let e in t)r.addEventListener(e,t[e]);s.appendChild(r)}this.dragButton=r,this.dragButtonPoint=null,this.dragButtonVisible=!1,this._result={};const a=this.nextButtons={};["positive_X","negative_X","positive_Y","negative_Y","positive_Z"].forEach((t=>{const e=document.createElement("div");e.addEventListener("touchstart",(t=>{t.stopPropagation(),t.preventDefault()})),e.addEventListener("touchmove",(t=>{t.stopPropagation(),t.preventDefault()})),e.addEventListener("touchend",(e=>{this.getNextResult(t),e.stopPropagation(),e.preventDefault()})),e.className=`bf-measure-nextbutton ${t}`;const i={button:e};let n;Object.defineProperty(i,"position",{set:t=>{if(t){e.style.display="block";let{x:i,y:n}=this.viewer.worldToClient(t);i&&n&&this.setButtonPosition(e,i,n)}else e.style.display="none";n=t},get:()=>n}),s.appendChild(e),a[t]=i})),this.viewer.addEventListener(Glodon$1.Bimface.Viewer.Viewer3DEvent.CameraPositionChanged,(()=>{if(this.dragButtonVisible&&this.dragButtonPoint){this.dragButton.style.display=this.viewer.isInViewFrustum(this.dragButtonPoint)?"block":"none";let{x:t,y:e}=this.viewer.worldToClient(this.dragButtonPoint);t&&e&&this.setButtonPosition(this.dragButton,t,e)}Object.values(a).forEach((t=>{t.position=t.position?t.position.clone():void 0,t.position&&!this.viewer.isInViewFrustum(t.position)&&(t.button.style.display="none")}))}))}computeMeasureResult(t){let e=this.getPoints();if(0===e.length)return;let{point:i}=e[0];this._result.pointInfo=e[0];const n=i.clone().add(t.clone().multiplyScalar(1)),o=(t,e)=>{const i=this.viewer.getComponentsByRaycaster(n,e),s=this.viewer.getComponentsByRaycaster(n,e.clone().negate());return this._result[t]=i.length>0&&s.length>0?{enable:!0,direction:e,positiveIntersects:i,negativeIntersects:s,positiveIndex:0,negativeIndex:0}:{enable:!1},this.nextButtons[`positive_${t}`].position=i.length>1?i[0].position:void 0,"Z"!==t&&(this.nextButtons[`negative_${t}`].position=s.length>1?s[0].position:void 0),o};let s,r,a;return Math.abs(1-Math.abs(t.z))<.001?(s=new THREE.Vector3(1,0,0),r=new THREE.Vector3(0,1,0),a=new THREE.Vector3(0,0,1)):(s=t.clone().cross(new THREE.Vector3(0,0,1)),s.x<0&&s.negate(),r=t.clone().cross(s),r.y<0&&r.negate(),a=t),o("X",s)("Y",r)("Z",a),this.showDragButton(i),this.getMeasureResult()}getMeasureResult(){let t={},{componentId:e,modelId:i,point:n}=this._result.pointInfo;t.pointSelected={x:n.x,y:n.y,z:n.z},t.componentSelected={componentId:e,modelId:i},t.type=this.measureType;const o=e=>{if(this._result[e].enable){let{direction:i,positiveIntersects:n,negativeIntersects:o,positiveIndex:s,negativeIndex:r}=this._result[e],a=n[s],l=o[r];t[`Laser${e}`]={vector:{x:i.x,y:i.y,z:i.z},distance:a.distance+l.distance,endPoints:[{x:a.position.x,y:a.position.y,z:a.position.z,direction:"positive"},{x:l.position.x,y:l.position.y,z:l.position.z,direction:"negative"}],endComponents:[{componentId:a.id,modelId:a.modelId,direction:"positive"},{componentId:l.id,modelId:l.modelId,direction:"negative"}]}}return o};return o("X")("Y")("Z"),t}getNextResult(t){let[e,i]=t.split("_");if(!this._result[i]||!this._result[i].enable)return;let n=this._result[i][`${e}Intersects`],o=++this._result[i][`${e}Index`];n.length<=o&&(this._result[i][`${e}Index`]=o=0),this.opt.measure.measureByInfo(this.getMeasureResult()),this.nextButtons[t].position=n[o].position}draw(t){this.drawCaptureItem(t)}showDragButton(t){this.reset(),this.viewer.render(),this.dragButtonPoint=t,this.dragButtonVisible=!0;let{x:e,y:i}=this.viewer.worldToClient(t);this.dragButton.style.display="block",e&&i&&this.setButtonPosition(this.dragButton,e,i)}hideDragButton(){this.dragButtonVisible=!1,this.dragButton.style.display="none",Object.values(this.nextButtons).forEach((t=>t.position=void 0))}setButtonPosition(t,e,i){t.style.top=`${i}px`,t.style.left=`${e}px`}}measureNS.MeasureLaserClearDistanceItem=MeasureLaserClearDistanceItem;class MeasureDrawable{constructor(t,e,i,n){this.viewer=t,this.id=e,this.type=i,this.isShow=!0,this.xmlns="http://www.w3.org/2000/svg",this.defaultColor=n.defaultColor||"#F99D0B",this.svgGroup=[],this.lineWidth="3",this.radius=5,this.strokeWidth=2,this.hitTestEpsilon=10,this.hitTestSegments=[],this.selectElements=[],this.unSelectElements=[],this.elementsOnTop=[],this.isSelected=!0,this.notation="ViewerGIS"===this.viewer.getViewerType()?new MeasureViewerGISNotation(i):new MeasureViewer3dNotation(i),this.measureParams={precision:0,scale:1,unit:"None"}}getSvgGroup(){return this.svgGroup}getId(){return this.id}getType(){return this.type}clear(t){this.detach(t),this.notation.clear(t),this.svgGroup=[],this.hitTestSegments=[]}detach(t){for(const t of this.svgGroup){(e=t.parentNode)&&e.removeChild(t)}for(const t of this.elementsOnTop){var e;(e=t.parentNode)&&e.removeChild(t)}}attach(t){for(const e of this.svgGroup)t.appendChild(e)}calcLine(t,e){let i=[];var n=this.viewer.getViewer(),o=this.viewer.getDomElement().getBoundingClientRect(),s=n.worldPointsToClient(t,e);if(s){t=new Vector2(s.start.x-o.left,s.start.y-o.top),e=new Vector2(s.end.x-o.left,s.end.y-o.top);i.push(t,e)}return i}calcTerminalLines(t,e,i){if(0===t.length)return[];let n=[],o=t[0],s=t[1],r=o.clone().sub(s).normalize(),a=r.clone().multiplyScalar(i).add(o).rotateAround(o.clone(),e),l=r.clone().multiplyScalar(i).add(o).rotateAround(o.clone(),-e);n.push({start:a,end:l}),r=r.multiplyScalar(-1);let h=r.clone().multiplyScalar(i).add(s).rotateAround(s.clone(),e),c=r.clone().multiplyScalar(i).add(s).rotateAround(s.clone(),-e);return n.push({start:h,end:c}),n}select(){for(const t of this.selectElements)t.style.display="none";for(const t of this.unSelectElements)t.style.display="block";this.notation.select(),this.isSelected=!0}unselect(){for(const t of this.selectElements)t.style.display="block";for(const t of this.unSelectElements)t.style.display="none";this.notation.unselect(),this.isSelected=!1}getIsSelected(){return this.isSelected}actionWhenSelected(){}actionWhenUnselected(){}dropShadow(t){this.notation.dropShadow(t)}setMeasureParams(t){this.measureParams.precision=t.precision,this.measureParams.scale=t.scale,this.measureParams.unit=t.unit,this.measureParams.defaultUnit=t.defaultUnit}show(){for(const t of this.svgGroup)t.style.display="block";for(const t of this.elementsOnTop)t.style.display="block";this.isShow=!0}hide(){for(const t of this.svgGroup)t.style.display="none";for(const t of this.elementsOnTop)t.style.display="none";this.isShow=!1}getNotation(){return this.notation}hitTest(t){let e=this.hitTestEpsilon;for(let i=0;i<this.hitTestSegments.length-1;i++){if(MeasureUtil.distanceToSegment(t,this.hitTestSegments[i],this.hitTestSegments[i+1])<=e)return!0}return!1}}class Viewer3dDistance extends MeasureDrawable{constructor(t,e,i,n){super(t,i,e.type,n),this.filterUrl=e.filterUrl,this.worldPositions=e.points,this.measureResult=e.distance,this.selectElements=[],this.unSelectElements=[],this.setMeasureParams({precision:e.precision,scale:e.scale,unit:e.unit,defaultUnit:e.defaultUnit})}initialize(){let t=this.calcLine(this.worldPositions[0],this.worldPositions[1]);this.hitTestSegments=t;let e=this.calAuxLines(),i=this.calcTerminalLines(t,Math.PI/2,6.5);this.attachSingleLine(t),this.attachTerminalLines(i);this.attachAuxLines(e,["#CC021B","#7CCF21","#4A90E2"]),this.attachTerminalPoints([e[0].start,e[2].end]);let n={x:(this.worldPositions[0].x+this.worldPositions[1].x)/2,y:(this.worldPositions[0].y+this.worldPositions[1].y)/2,z:(this.worldPositions[0].z+this.worldPositions[1].z)/2},o=this.viewer.worldToClient(n);this.viewer.isInViewFrustum(n)&&(this.attachNotation([o,o]),this.notation.dropShadow(this.filterUrl),this.unselect())}attachTerminalPoints(t){for(const e of t){let t=MeasureUtil.makeCircle({position:e,radius:this.radius,strokeWidth:this.strokeWidth,color:this.defaultColor});this.svgGroup.push(t),t.setAttribute("filter",this.filterUrl),this.unSelectElements.push(t)}}attachSingleLine(t){if(0===t.length)return;let e=MeasureUtil.makeLine({start:t[0],end:t[1],color:this.defaultColor,lineWidth:this.lineWidth});this.svgGroup.push(e)}attachTerminalLines(t){if(0!==t.length)for(let e=0;e<2;e++){let i=MeasureUtil.makeLine({start:t[e].start,end:t[e].end,color:this.defaultColor,lineWidth:2});this.selectElements.push(i),this.svgGroup.push(i)}}attachAuxLines(t,e){let i=0;for(const n of t){let t=MeasureUtil.makeLine({start:n.start,end:n.end,color:this.defaultColor,lineWidth:this.lineWidth});t.setAttribute("stroke-dasharray","6,4"),t.style.stroke=e[i++],this.unSelectElements.push(t),this.svgGroup.push(t)}}attachNotation(t){if(0===t.length)return;let e=this.notation.drawAnnotation({x:(t[0].x+t[1].x)/2,y:(t[0].y+t[1].y)/2},this.getMeasureResult(),this.id);for(const t of e)this.svgGroup.push(t)}calAuxLines(){let t=this.worldPositions;for(var e=this.viewer.getDomElement().getBoundingClientRect(),i={x:t[1].x,y:t[0].y,z:t[0].z},n={x:t[1].x,y:t[1].y,z:t[0].z},o=[],s=[t[0],i,n,t[1]],r=this.viewer.getViewer(),a=0;a<s.length-1;a++){var l=r.worldPointsToClient(s[a],s[a+1]);if(l)l.start.x-=e.left,l.start.y-=e.top,l.end.x-=e.left,l.end.y-=e.top;else{l={start:{x:-1,y:-1},end:{x:-1,y:-1}}}o.push(l)}return o}getMeasureResult(){let t=this.measureParams.unit,e=this.measureResult.toString(),i=MeasureResultFormat.formatDistance(e,this.measureParams);return i+=MeasureResultFormat.getPostFix(t,!1),i.split(",").join("")}}class Viewer3dAngle extends MeasureDrawable{constructor(t,e,i,n){super(t,i,e.type,n),this.filterUrl=e.filterUrl,this.worldPositions=e.points,this.measureAngle=e.angle,this.setMeasureParams({precision:e.precision})}initialize(){let t=this.getClientPoints();this.hitTestSegments=t;for(let e=0;e<t.length-1;e++){let i=MeasureUtil.makeLine({start:t[e],end:t[e+1],color:this.defaultColor,lineWidth:this.lineWidth});this.svgGroup.push(i)}for(let e=0;e<t.length;e++){let i=MeasureUtil.makeCircle({position:t[e],radius:this.radius,strokeWidth:this.strokeWidth,color:this.defaultColor});this.unSelectElements.push(i),this.svgGroup.push(i),i.setAttribute("filter",this.filterUrl)}var e=this.getArcData(t[0],t[1],t[2]);if(!e)return void this.unselect();var i=MeasureUtil.makePath({color:this.defaultColor,lineWidth:this.lineWidth,arcRadius:25,info:e});this.svgGroup.push(i);var n=new Vector2((e.pointA.x+e.pointB.x)/2,(e.pointA.y+e.pointB.y)/2),o=new Vector2(t[1].x,t[1].y),s=n.clone().sub(o);if(0==s.x&&0==s.y){var r=0==o.clone().sub(e.pointA).y;r&&0==e.direction?s.y=35:r&&1==e.direction?s.y=-35:r||0!=e.direction?r||1!=e.direction||(s.x=35):s.x=-35}else s.normalize().multiplyScalar(35);n=o.clone().add(s);let a=this.notation.drawAnnotation(n,this.getMeasureResult(),this.id);for(const t of a)this.svgGroup.push(t);this.notation.dropShadow(this.filterUrl),this.unselect()}getClientPoints(){let t=[],e=this.calcLine(this.worldPositions[0],this.worldPositions[1]),i=this.calcLine(this.worldPositions[1],this.worldPositions[2]);return e.length>0&&t.push(e[0],e[1]),i.length>0&&(t.length>0?t.push(i[1]):t.push(i[0],i[1])),t}getArcData(t,e,i){if(!t||!e||!i)return!1;t=new Vector2(t.x,t.y),e=new Vector2(e.x,e.y),i=new Vector2(i.x,i.y);var n,o=t.sub(e),s=i.sub(e);if(o.length()<25||s.length()<25)return!1;o.setLength(25),s.setLength(25);var r=o.angle(),a=180*(s.angle()-r)/Math.PI;return a<0&&(a+=360),n=a<180?1:0,{pointA:e.clone().add(o),pointB:e.clone().add(s),flag:1,direction:n}}getMeasureResult(){this.measureParams.unit;let t=this.measureAngle.toString();return MeasureResultFormat.formatPrecision(t,this.measureParams.precision).split(",").join("")+"°"}}class Viewer3dElevation extends MeasureDrawable{constructor(t,e,i,n){super(t,i,e.type,n),this.filterUrl=e.filterUrl,this.elevationPoint=e.points[0],this.setMeasureParams({precision:e.precision,unit:e.unit,defaultUnit:e.defaultUnit})}initialize(){if(this.viewer.isInViewFrustum&&!this.viewer.isInViewFrustum(this.elevationPoint))return;var t=new THREE.Vector3(this.elevationPoint.x,this.elevationPoint.y,this.elevationPoint.z);t=this.viewer.worldToClient(t);for(var e=[58,-12,-12,-12,0,0,12,-12],i="",n=0;n<e.length;n+=2)e[n]+=t.x,e[n+1]+=t.y,i+=e[n]+","+e[n+1]+" ";var o=MeasureUtil.makePolyline({color:this.defaultColor,width:2,points:i});this.svgGroup.push(o);var s=new THREE.Vector2(t.x,t.y);let r=this.notation.drawAnnotation(s,this.getMeasureResult(),this.id);for(const t of r)this.svgGroup.push(t);this.notation.dropShadow(this.filterUrl),this.unselect()}getMeasureResult(){let t=this.measureParams.unit,e=this.elevationPoint.z.toString(),i=MeasureResultFormat.formatDistance(e,this.measureParams);return i+=MeasureResultFormat.getPostFix(t,!1),i=i.split(",").join(""),0==i.split(" ")[0]&&(i=`±${i}`),i}hitTest(t){var e=new THREE.Vector3(this.elevationPoint.x,this.elevationPoint.y,this.elevationPoint.z);e=this.viewer.worldToClient(e);let i=new THREE.Vector2(e.x-12,e.y-22),n=new THREE.Vector2(e.x+58,e.y-22);return MeasureUtil.distanceToSegment(t,i,n)<=22||this.notation.hitTest(t)}}class Viewer3dMinDistanceLine extends MeasureDrawable{constructor(t,e,i,n){super(t,i,e.type,n),this.filterUrl=e.filterUrl,this.selectedComponentsId=e.points,this.worldPositions=[e.start,e.end],this.measureResult=e.distance,this.setMeasureParams({precision:e.precision,scale:e.scale,unit:e.unit,defaultUnit:e.defaultUnit})}initialize(){let t=this.calcLine(this.worldPositions[0],this.worldPositions[1]);this.hitTestSegments=t;let e=this.calcTerminalLines(t,Math.PI/3,8);for(let i=0;i<e.length;i++){let n=[];n.push(e[i].start,t[i],e[i].end);let o=MeasureUtil.makePolyline({color:this.defaultColor,width:2,points:MeasureUtil.calcPolylinePoints(n)});this.svgGroup.push(o)}if(0===t.length)return void this.unselect();let i=MeasureUtil.makeLine({start:t[0],end:t[1],color:this.defaultColor,lineWidth:this.lineWidth});this.svgGroup.push(i);let n={x:(this.worldPositions[0].x+this.worldPositions[1].x)/2,y:(this.worldPositions[0].y+this.worldPositions[1].y)/2,z:(this.worldPositions[0].z+this.worldPositions[1].z)/2},o=this.viewer.worldToClient(n);if(!this.viewer.isInViewFrustum(n))return;let s=this.notation.drawAnnotation({x:o.x,y:o.y},this.getMeasureResult(),this.id);for(const t of s)this.svgGroup.push(t);this.notation.dropShadow(this.filterUrl),this.unselect()}actionWhenSelected(){this.selectedComponentsId.forEach((t=>{(t.modelId?this.viewer.getModel(t.modelId):this.viewer).addSelectedComponentsById([t.userId])})),this.viewer.render()}actionWhenUnselected(){this.selectedComponentsId.forEach((t=>{(t.modelId?this.viewer.getModel(t.modelId):this.viewer).removeSelectedId([t.userId])})),this.viewer.render()}getMeasureResult(){let t=this.measureParams.unit,e=this.measureResult.toString(),i=MeasureResultFormat.formatDistance(e,this.measureParams);return i+=MeasureResultFormat.getPostFix(t,!1),i.split(",").join("")}}class MeasureArea extends MeasureDrawable{constructor(t,e,i,n){super(t,i,e.type,n),this.filterUrl=e.filterUrl,this.worldPositions=e.points,this.measureResult=e.area,this.viewPortId=e.viewPortId,this.boundaryPoints=[],this.scratchVector=new Vector3,this.setMeasureParams({precision:e.precision,scale:e.scale,unit:e.unit})}initialize(){let t=new Box2,e=this.worldPositions;var i="";this.boundaryPoints=[];for(var n=0;n<=e.length;n++){let o=this.worldToClient(e[n%e.length]);n!==e.length&&this.hitTestSegments.push(new Vector2(o.x,o.y));let s=MeasureUtil.makeCircle({position:o,radius:this.radius,strokeWidth:this.strokeWidth,color:this.defaultColor});this.svgGroup.push(s),s.setAttribute("filter",this.filterUrl),this.unSelectElements.push(s),this.boundaryPoints.push(o),t.expandByPoint(new Vector2(o.x,o.y)),i+=o.x+","+o.y+" "}var o=MeasureUtil.makePolyline({color:this.defaultColor,fillColor:this.defaultColor,width:2,points:i});o.setAttribute("fill-opacity",.2),this.svgGroup.insert(0,o);var s=t.getCenter(this.scratchVector);let r=this.notation.drawAnnotation(s,this.getMeasureResult());for(const t of r)this.svgGroup.push(t);this.notation.dropShadow(this.filterUrl),this.unselect(),!this.isShow&&this.hide()}getMeasureResult(){let t=this.measureParams.unit,e=this.measureResult.toString(),i=MeasureResultFormat.formatArea(e,this.measureParams);return i+=MeasureResultFormat.getPostFix(t,!0),i.split(",").join("")}worldToClient(t){let e=[],i=this.viewer.getViewer();if(t.isActiveLayoutElement)e=i.toScreenPoint(t.point);else{const n=t.point?t.point:t;e=i.toViewportScreenPoint(n,t.viewPortId)}return{x:e[0],y:e[1]}}setViewId(t){this.viewId=t}getViewId(){return this.viewId}hitTest(t){let e=this.boundaryPoints,i=MeasureUtil.isPointInPolygon(t,e),n=!1;for(let e=0;e<this.hitTestSegments.length;e++)if(Math.abs(this.hitTestSegments[e].x-t.x)<=3&&Math.abs(this.hitTestSegments[e].y-t.y)<=3){n=!0;break}return i||n}}class DrawingDistance extends Viewer3dDistance{constructor(t,e,i,n){super(t,e,i,n),this.filterUrl=e.filterUrl,this.startPoint=new Vector2(e.start[0],e.start[1]),this.endPoint=new Vector2(e.end[0],e.end[1]),this.viewPortId=e.viewPortId,this.measureResult=e.distance,this.setMeasureParams({precision:e.precision,scale:e.scale,unit:e.unit}),this.isOnLayoutMeasure=e.isOnLayout}initialize(){let t=this.calAuxLines(),e=[];e.push(t[0].start,t[1].end),this.hitTestSegments=e;let i=this.calcTerminalLines(e,Math.PI/2,6.5);this.attachSingleLine(e),this.attachTerminalLines(i);this.attachAuxLines(t,["#7CCF21","#CC021B"]),this.attachTerminalPoints(e),this.attachNotation(e),this.notation.dropShadow(this.filterUrl),this.unselect(),!this.isShow&&this.hide()}attachNotation(t){if(0===t.length)return;let e=this.notation.drawAnnotation({x:(t[0].x+t[1].x)/2,y:(t[0].y+t[1].y)/2},this.getMeasureResult(),this.id);for(const t of e)this.svgGroup.push(t)}calAuxLines(){let t=[],e=this.startPoint.clone(),i=this.endPoint.clone(),n={x:i.x,y:e.y};t.push(e,n,i);let o=[];for(let e=0;e<t.length-1;e++){let i=this.worldToClient(t[e]),n=this.worldToClient(t[e+1]);o.push({start:new Vector2(i.x,i.y),end:new Vector2(n.x,n.y)})}return o}getMeasureResult(){let t=this.measureParams.unit,e=this.measureResult.toString(),i=MeasureResultFormat.formatDistance(e,this.measureParams);return i+=MeasureResultFormat.getPostFix(t,!1),i.split(",").join("")}worldToClient(t){if(this.isOnLayoutMeasure){let e=this.viewer.getViewer().toViewportScreenPoint([t.x,t.y],this.viewPortId);return{x:e[0],y:e[1]}}return this.viewer.worldToClient(t)}setViewId(t){this.viewId=t}getViewId(){return this.viewId}}class DrawingAngle extends Viewer3dAngle{constructor(t,e,i,n){super(t,e,i,n),this.isOnLayoutMeasure=e.isOnLayout,this.viewPortId=e.viewPortId}getClientPoints(){let t=[];for(let e=0;e<this.worldPositions.length;e++){let i=new Vector2(this.worldPositions[e][0],this.worldPositions[e][1]),n=this.worldToClient(i,this.worldPositions[e][2]);t.push(new Vector2(n.x,n.y))}return t}worldToClient(t,e){if(this.isOnLayoutMeasure){let i=this.viewer.getViewer().toViewportScreenPoint([t.x,t.y],e);return{x:i[0],y:i[1]}}return this.viewer.worldToClient(t)}setViewId(t){this.viewId=t}getViewId(){return this.viewId}}class ViewerGISPolylineDistance extends MeasureDrawable{constructor(t,e,i,n){super(t,i,e.type,n),this.filterUrl=e.filterUrl,this.worldPositions=e.points,this.measureResult={distance:e.distance,totalDistance:e.totalDistance},this.selectElements=[],this.unSelectElements=[],this.setMeasureParams({precision:e.precision,scale:e.scale,unit:e.unit,defaultUnit:e.defaultUnit})}initialize(){let t=this.worldPositions.length;if(!(t<2)){for(let e=1;e<t;e++){let t=this.calcLine(this.worldPositions[e],this.worldPositions[e-1]);0!==t.length&&(1===e&&this.hitTestSegments.push(t[1]),this.hitTestSegments.push(t[0]),this.attachSelectedTerminalPoints(t[0]),this.attachLines(t),this.attachSelectedTerminalPoints(t[1]),this.attachUnselectedTerminalPoints(t[0]),this.attachUnselectedTerminalPoints(t[1]))}this.attachNotations(),this.unselect()}}attachSelectedTerminalPoints(t){let e=MeasureUtil.makeCircle({position:t,radius:this.radius,strokeWidth:0,color:this.defaultColor});this.svgGroup.push(e),e.setAttribute("filter",this.filterUrl),this.selectElements.push(e)}attachLines(t){let e=MeasureUtil.makeLine({start:t[0],end:t[1],color:this.defaultColor,lineWidth:this.lineWidth});this.svgGroup.push(e)}attachUnselectedTerminalPoints(t){let e=MeasureUtil.makeCircle({position:t,radius:this.radius,strokeWidth:this.strokeWidth,color:this.defaultColor});this.svgGroup.push(e),e.setAttribute("filter",this.filterUrl),this.unSelectElements.push(e)}attachNotations(){const t=this.worldPositions.length,e=this.getMeasureResult();for(let i=1;i<t;i++){let t={x:(this.worldPositions[i].x+this.worldPositions[i-1].x)/2,y:(this.worldPositions[i].y+this.worldPositions[i-1].y)/2,z:(this.worldPositions[i].z+this.worldPositions[i-1].z)/2},n=this.viewer.worldToClient(t);this.viewer.isInViewFrustum(t)&&this.attachNotation([n,n],e.distance[i-1])}let i={x:this.worldPositions[t-1].x,y:this.worldPositions[t-1].y,z:this.worldPositions[t-1].z},n=this.viewer.worldToClient(i);this.viewer.isInViewFrustum(i)&&this.attachNotation([n,n],`总长度：${e.totalDistance}`,!0),this.notation.dropShadow(this.filterUrl)}attachNotation(t,e,i){if(0===t.length)return;let n=this.notation.drawAnnotation({x:(t[0].x+t[1].x)/2,y:(t[0].y+t[1].y)/2},e,this.id,i);for(const t of n)this.svgGroup.push(t)}getMeasureResult(){let t=this.measureParams.unit,{distance:e,totalDistance:i}=this.measureResult,n=[],o=0;return e.forEach((e=>{o+=e;let i=e.toString();i=MeasureResultFormat.formatDistance(i,this.measureParams),i+=MeasureResultFormat.getPostFix(t,!1),n.push(i)})),o=o.toString(),o=MeasureResultFormat.formatDistance(o,this.measureParams),o+=MeasureResultFormat.getPostFix(t,!1),{distance:n,totalDistance:o}}}class ViewerGISGroundlineDistance extends MeasureDrawable{constructor(t,e,i,n){super(t,i,e.type,n),this.filterUrl=e.filterUrl,this.worldPositions=e.points,this.measureResult={distance:e.distance,totalDistance:e.totalDistance},this.pointPos=e.positions,this.item=e.item,this.curves=e.curves,this.selectElements=[],this.unSelectElements=[],this.setMeasureParams({precision:e.precision,scale:e.scale,unit:e.unit,defaultUnit:e.defaultUnit})}initialize(){let t=this.worldPositions.length;if(!(t<2)){for(let e=1;e<t;e++){let t=this.calcLine(this.worldPositions[e],this.worldPositions[e-1]);0!==t.length&&(1===e&&this.hitTestSegments.push(t[1]),this.hitTestSegments.push(t[0]),this.attachSelectedTerminalPoints(t[0]),this.attachSelectedTerminalPoints(t[1]),this.attachUnselectedTerminalPoints(t[0]),this.attachUnselectedTerminalPoints(t[1]))}this.attachNotations(),this.unselect()}}attachSelectedTerminalPoints(t){let e=MeasureUtil.makeCircle({position:t,radius:this.radius,strokeWidth:0,color:this.defaultColor});this.svgGroup.push(e),e.setAttribute("filter",this.filterUrl),this.selectElements.push(e)}attachLines(t){}attachUnselectedTerminalPoints(t){let e=MeasureUtil.makeCircle({position:t,radius:this.radius,strokeWidth:this.strokeWidth,color:this.defaultColor});this.svgGroup.push(e),e.setAttribute("filter",this.filterUrl),this.unSelectElements.push(e)}attachNotations(){const t=this.worldPositions.length,e=this.getMeasureResult();for(let i=0;i<t-1;i++){let t={x:this.pointPos[i].midPoint.x,y:this.pointPos[i].midPoint.y,z:this.pointPos[i].midPoint.z},n=this.viewer.worldToClient(t);this.viewer.isInViewFrustum(t)&&this.attachNotation([n,n],e.distance[i])}let i={x:this.worldPositions[t-1].x,y:this.worldPositions[t-1].y,z:this.worldPositions[t-1].z},n=this.viewer.worldToClient(i);this.viewer.isInViewFrustum(i)&&this.attachNotation([n,n],`总长度：${e.totalDistance}`,!0),this.notation.dropShadow(this.filterUrl)}attachNotation(t,e,i){if(0===t.length)return;let n=this.notation.drawAnnotation({x:(t[0].x+t[1].x)/2,y:(t[0].y+t[1].y)/2},e,this.id,i);for(const t of n)this.svgGroup.push(t)}detach(t){super.detach(),t&&this.curves.forEach((t=>{this.item&&this.item.deleteCurveById(t.id)}))}getMeasureResult(){let t=this.measureParams.unit,{distance:e,totalDistance:i}=this.measureResult,n=[],o=0;return e.forEach((e=>{o+=e;let i=e.toString();i=MeasureResultFormat.formatDistance(i,this.measureParams),i+=MeasureResultFormat.getPostFix(t,!1),n.push(i)})),o=o.toString(),o=MeasureResultFormat.formatDistance(o,this.measureParams),o+=MeasureResultFormat.getPostFix(t,!1),{distance:n,totalDistance:o}}}class ViewerGISPosition extends MeasureDrawable{constructor(t,e,i,n){super(t,i,e.type,n),this.filterUrl=e.filterUrl,this.positionPoint=e.points[0],this.measureResult={alt:e.altitude,lonLat:e.lonLat},this.innerRadius=3,this.innerStrokeWidth=2,this.outerRadius=7,this.outerStrokeWidth=1,this.selectElements=[],this.unSelectElements=[],this.setMeasureParams({precision:e.precision,scale:e.scale,unit:e.unit,defaultUnit:e.defaultUnit})}initialize(){if(!this.viewer.isInViewFrustum(this.positionPoint))return;var t=new THREE.Vector3(this.positionPoint.x,this.positionPoint.y,this.positionPoint.z);t=this.viewer.worldToClient(t),this.attachSelectedCircle(t),this.attachUnselectedCircle(t);var e=new THREE.Vector2(t.x,t.y);let i=this.notation.drawAnnotation(e,this.getMeasureResult(),this.id);for(const t of i)this.svgGroup.push(t);this.notation.dropShadow(this.filterUrl),this.unselect()}attachSelectedCircle(t){let e=MeasureUtil.makeConcentricCircle({innerRadius:this.innerRadius,innerStrokeWidth:this.innerStrokeWidth,outerRadius:this.outerRadius,color:this.defaultColor,position:t});this.selectElements.push(e),this.svgGroup.push(e)}attachUnselectedCircle(t){let e=MeasureUtil.makeConcentricCircle({innerRadius:this.innerRadius,innerStrokeWidth:this.innerStrokeWidth,outerRadius:this.outerRadius,outerStrokeWidth:this.outerStrokeWidth,color:this.defaultColor,position:t});this.unSelectElements.push(e),this.svgGroup.push(e)}hitTest(t){var e=new THREE.Vector3(this.positionPoint.x,this.positionPoint.y,this.positionPoint.z);e=this.viewer.worldToClient(e);let i=new THREE.Vector2(e.x-12,e.y-22),n=new THREE.Vector2(e.x+58,e.y-22);return MeasureUtil.distanceToSegment(t,i,n)<=22||this.notation.hitTest(t)}getMeasureResult(){let t=this.measureParams.unit,{alt:e,lonLat:i}=this.measureResult,{elevation:n,latLon:o}=this.measureParams.precision,s={defaultUnit:this.measureParams.defaultUnit,precision:n,scale:this.measureParams.scale,unit:this.measureParams.unit},r=MeasureResultFormat.formatPrecision(i.latitude.toString(),o),a=MeasureResultFormat.formatPrecision(i.longitude.toString(),o),l=MeasureResultFormat.formatDistance(e.toString(),s);return l+=MeasureResultFormat.getPostFix(t,!1),`经度：${a} ° \n纬度：${r} ° \n高程：${l}`}}class ViewerGISTriangleDistance extends MeasureDrawable{constructor(t,e,i,n){super(t,i,e.type,n),this.filterUrl=e.filterUrl,this.worldPositions=e.points,this.measureResult={distance:e.distance,horizontalDistance:e.horizontalDistance,verticalDistance:e.verticalDistance},this.selectElements=[],this.unSelectElements=[],this.setMeasureParams({precision:e.precision,scale:e.scale,unit:e.unit,defaultUnit:e.defaultUnit})}initialize(){if(this.worldPositions.length<2)return;let t=this.getMeasureResult();if(this.attachSegmentByTerminalPoints(this.worldPositions,t.distance),this.worldPositions[0].z!=this.worldPositions[1].z){let e=this.worldPositions[0].z<this.worldPositions[1].z?this.worldPositions[0]:this.worldPositions[1],i=this.worldPositions[0].z<this.worldPositions[1].z?this.worldPositions[1]:this.worldPositions[0],n=this.calcTrianglePoint(this.worldPositions);this.attachSegmentByTerminalPoints([e,n],t.verticalDistance),this.attachSegmentByTerminalPoints([i,n],t.horizontalDistance)}else this.attachSegmentByTerminalPoints([this.worldPositions[0],this.worldPositions[0]],t.horizontalDistance);this.notation.dropShadow(this.filterUrl),this.unselect()}calcTrianglePoint(t){if(t.length<2)return null;let e=new THREE.Vector3;return t[0].z<t[1].z?e.set(t[0].x,t[0].y,t[1].z):t[0].z>t[1].z&&e.set(t[1].x,t[1].y,t[0].z),e}attachSegmentByTerminalPoints(t,e){let i=t[0],n=t[1],o=this.calcLine(i,n);this.hitTestSegments=this.hitTestSegments.concat(o),this.attachLine(o),this.attachSelectedTerminalPoints(o),this.attachUnselectedTerminalPoints(o);let s={x:(i.x+n.x)/2,y:(i.y+n.y)/2,z:(i.z+n.z)/2},r=this.viewer.worldToClient(s);this.viewer.isInViewFrustum(s)&&this.attachNotation([r,r],e)}attachSelectedTerminalPoints(t){for(const e of t){let t=MeasureUtil.makeCircle({position:e,radius:this.radius,strokeWidth:0,color:this.defaultColor});this.svgGroup.push(t),t.setAttribute("filter",this.filterUrl),this.selectElements.push(t)}}attachLine(t){if(0===t.length)return;let e=MeasureUtil.makeLine({start:t[0],end:t[1],color:this.defaultColor,lineWidth:this.lineWidth});this.svgGroup.push(e)}attachUnselectedTerminalPoints(t){for(const e of t){let t=MeasureUtil.makeCircle({position:e,radius:this.radius,strokeWidth:this.strokeWidth,color:this.defaultColor});this.svgGroup.push(t),t.setAttribute("filter",this.filterUrl),this.unSelectElements.push(t)}}attachNotation(t,e){if(0===t.length)return;let i=this.notation.drawAnnotation({x:(t[0].x+t[1].x)/2,y:(t[0].y+t[1].y)/2},e,this.id);for(const t of i)this.svgGroup.push(t)}getMeasureResult(){const t=this.measureParams.unit;let{distance:e,horizontalDistance:i,verticalDistance:n}=this.measureResult;return e=e.toString(),e=MeasureResultFormat.formatDistance(e,this.measureParams),e+=MeasureResultFormat.getPostFix(t,!1),i=i.toString(),i=MeasureResultFormat.formatDistance(i,this.measureParams),i+=MeasureResultFormat.getPostFix(t,!1),n=n.toString(),n=MeasureResultFormat.formatDistance(n,this.measureParams),n+=MeasureResultFormat.getPostFix(t,!1),{distance:e,horizontalDistance:i,verticalDistance:n}}}class ViewerGISSpatialArea extends MeasureDrawable{constructor(t,e,i,n){super(t,i,e.type,n),this.fillColor=new Glodon.Web.Graphics.Color(255,157,11,.2),this.filterUrl=e.filterUrl,this.worldPositions=e.points,this.measureResult=e.area,this.selectElements=[],this.unSelectElements=[],this.setMeasureParams({precision:e.precision,scale:e.scale,unit:e.unit,defaultUnit:e.defaultUnit})}initialize(){const t=this.worldPositions,e=t.length;if(!(e<3)&&this.areaFrontOfCamera(t)){this.attachArea(t);for(let i=0;i<e;i++){let n=this.viewer.worldToClient(t[i]);n=new THREE.Vector2(n.x,n.y),this.hitTestSegments.push(n),this.attachSelectedTerminalPoints(n),this.attachUnselectedTerminalPoints(n),i==e-1&&this.attachNotation(n,`${this.getNotationTitle()}：${this.getMeasureResult()}`)}this.unselect()}}attachSelectedTerminalPoints(t){let e=MeasureUtil.makeCircle({position:t,radius:this.radius,strokeWidth:0,color:this.defaultColor});this.svgGroup.push(e),e.setAttribute("filter",this.filterUrl),this.selectElements.push(e)}attachArea(t){let e="";t.forEach((t=>{let i=this.viewer.worldToClient(t);e+=i.x+","+i.y+" "}));let i=MeasureUtil.makePolygon({points:e,width:this.lineWidth,color:this.defaultColor,fillColor:this.fillColor.getRGBA()});this.svgGroup.push(i)}attachUnselectedTerminalPoints(t){let e=MeasureUtil.makeCircle({position:t,radius:this.radius,strokeWidth:this.strokeWidth,color:this.defaultColor});this.svgGroup.push(e),e.setAttribute("filter",this.filterUrl),this.unSelectElements.push(e)}attachNotation(t,e){let i=this.notation.drawAnnotation({x:t.x,y:t.y},e,this.id,!0);for(const t of i)this.svgGroup.push(t)}getNotationTitle(){return BimfaceLanguage.bf_tip_measure_spatial_area}areaFrontOfCamera(t){let e=this.viewer,i=e.getViewer(),n=new THREE.Vector3,o=new THREE.Plane(e.sceneToWorld(i.camera.getWorldDirection(n)).normalize());o.constant=-o.distanceToPoint(e.sceneToWorld(i.camera.position));for(let e=0;e<t.length;e++)if(o.distanceToPoint(t[e])<0)return!1;return!0}getMeasureResult(){let t=this.measureParams.unit,e=this.measureResult.toString();return e=MeasureResultFormat.formatArea(e,this.measureParams),e+=MeasureResultFormat.getPostFix(t,!0),e}}class ViewerGISProjectedArea extends ViewerGISSpatialArea{constructor(t,e,i,n){super(t,e,i,n)}getNotationTitle(){return BimfaceLanguage.bf_tip_measure_projected_area}}class MeasureSurfaceAreaMesh{constructor(t){t&&(this._opt=t,this.measurePoints=t.points||[],this.fillColor=t.fillColor||new Glodon$1.Web.Graphics.Color(255,157,11,.2),this.borderColor=t.color||new Glodon$1.Web.Graphics.Color(255,157,11,1),this.borderWidth=t.width||3,this.update())}setMeasurePoints(t){"[object Array]"===Object.prototype.toString.call(t)?(this.measurePoints=t,this.update()):console.warn("Parameter points is invalid.")}update(){if(this.measurePoints.length<2)this.disposeGroundBorder(),this.disposeGroundSurface();else if(2===this.measurePoints.length)this.disposeGroundSurface(),this.updateGroundBorder(this.measurePoints);else if(this.measurePoints.length>2){this.updateGroundSurface(this.measurePoints);let t=[...this.measurePoints];t.push(this.measurePoints[0]),this.updateGroundBorder(t)}}updateGroundBorder(t){this.groundBorder?this.groundBorder.geometry.updateGeometry({points:t}):(this.groundBorder=CLOUD.GroundPrimitiveManager.getInstance().createGroundCurve({points:t,color:this.borderColor,width:this.borderWidth,style:"Continuous",type:"polyline"}),this.groundBorder.onAdded())}updateGroundSurface(t){this.groundSurface?this.groundSurface.geometry.updateGeometry({points:t}):(this.groundSurface=CLOUD.GroundPrimitiveManager.getInstance().createGroundPolygon({points:t,color:this.fillColor}),this.groundSurface.onAdded())}updateTerminalPoints(t){this.selectedGroup||(this.selectedGroup=new THREE.Group,this.add(this.selectedGroup));let e=this.selectedGroup.children;for(let t=e.length-1;t>=0;t--)this.selectedGroup.remove(e[t]);let i=new THREE.CircleGeometry(200,180),n=new THREE.MeshBasicMaterial({color:this.borderColor,side:THREE.DoubleSide,depthTest:!1}),o=new THREE.Mesh(i,n);for(let e=0,i=t.length;e<i;e++){let i=o.clone();i.position.copy(t[e]),this.selectedGroup.add(i)}this.updateMatrixWorld()}hide(){this.hideGroundSurface(),this.hideGroundBorder()}hideGroundSurface(){this.groundSurface&&(this.groundSurface.visible=!1)}hideGroundBorder(){this.groundBorder&&(this.groundBorder.visible=!1)}show(){this.showGroundSurface(),this.showGroundBorder()}showGroundSurface(){this.groundSurface&&(this.groundSurface.visible=!0)}showGroundBorder(){this.groundBorder&&(this.groundBorder.visible=!0)}disposeGroundSurface(){this.groundSurface&&(this.groundSurface.onRemoved(),this.groundSurface.dispose(),this.groundSurface=null)}disposeGroundBorder(){this.groundBorder&&(this.groundBorder.onRemoved(),this.groundBorder.dispose(),this.groundBorder=null)}dispose(){this.measurePoints=null,this.disposeGroundSurface(),this.disposeGroundBorder()}}class ViewerGISSurfaceArea extends ViewerGISSpatialArea{constructor(t,e,i,n){super(t,e,i,n),this.measureSurfaceMesh=null}initialize(){this.measureSurfaceMesh||(this.measureSurfaceMesh=new MeasureSurfaceAreaMesh({fillColor:new Glodon.Web.Graphics.Color(255,157,11,.2),color:new Glodon.Web.Graphics.Color(255,157,11,1),width:this.lineWidth})),super.initialize()}attachArea(t){this.measureSurfaceMesh.setMeasurePoints(t),this.viewer.render()}getNotationTitle(){return BimfaceLanguage.bf_tip_measure_surface_area}clear(){super.clear(),this.measureSurfaceMesh&&(this.measureSurfaceMesh.dispose(),this.measureSurfaceMesh=null)}}class Viewer3dLaserClearDistance extends MeasureDrawable{constructor(t,e,i,n){super(t,i,e.type,n),this.lineWidth=1,this.data=e,this.setMeasureParams({precision:e.precision,scale:e.scale,unit:e.unit,defaultUnit:e.defaultUnit})}initialize(){const t={X:"#CC021B",Y:"#7CCF21",Z:"#4A90E2"};let e=[];const i=n=>{const o=this.data[`Laser${n}`];if(o){const s=t[n],[r,a]=o.endPoints,l=new THREE.Vector3(r.x,r.y,r.z),h=new THREE.Vector3(a.x,a.y,a.z),c=o.distance;let d=this.calcLine(l,h);if(2!==d.length)return i;let u=MeasureUtil.makeLine({start:d[0],end:d[1],color:s,lineWidth:this.lineWidth});this.svgGroup.push(u);let p=this.calcTerminalLines(d,5*Math.PI/6,8);for(let t=0;t<p.length;t++){let e=[];e.push(p[t].start,d[t],p[t].end);let i=MeasureUtil.makePolyline({color:s,width:this.lineWidth,points:MeasureUtil.calcPolylinePoints(e)});this.svgGroup.push(i)}let g={x:(l.x+h.x)/2,y:(l.y+h.y)/2,z:(l.z+h.z)/2},m=this.viewer.worldToClient(g);if(!this.viewer.isInViewFrustum(g)){const{offsetHeight:t,offsetWidth:e}=this.viewer.getDomElement(),n=i=>i.x>0&&i.y>0&&i.x<e&&i.y<t;let o=new THREE.Vector3(this.data.pointSelected.x,this.data.pointSelected.y,this.data.pointSelected.z);if(!this.viewer.isInViewFrustum(o))return i;let s=this.viewer.worldToClient(o),r=new THREE.Vector3(s.x,s.y,s.z),a=new THREE.Vector3(m.x,m.y,m.z);const l=100;if(m=r.clone().add(a.clone().sub(r).normalize().multiplyScalar(l)),n(m)||(m=r.clone().add(a.clone().sub(r).normalize().multiplyScalar(-l))),!n(m))return i}let f=this.notation.drawAnnotation({x:m.x,y:m.y},this.getMeasureResult(c),this.id,s);e.push(f)}return i};i("X")("Y")("Z"),e.flat().forEach((t=>this.svgGroup.push(t))),this.unselect()}getMeasureResult(t){let e=this.measureParams.unit,i=t.toString(),n=MeasureResultFormat.formatDistance(i,this.measureParams);return n+=MeasureResultFormat.getPostFix(e,!1),n.split(",").join("")}}class Viewer3dVolume extends MeasureDrawable{constructor(t,e,i,n){super(t,i,e.type,n),this.filterUrl=e.filterUrl,this.selectedComponentsId=e.points,this.worldPosition=this.viewer.sceneToWorld(e.volumePosition),this.measureResult=e.volumeResult,this.setMeasureParams({precision:e.precision,scale:e.scale,unit:e.unit,defaultUnit:e.defaultUnit})}initialize(){if(!this.measureResult)return;let t=this.viewer.worldToClient(this.worldPosition),e=this.notation.drawAnnotation({x:t.x,y:t.y},this.getMeasureResult(),this.id);for(const t of e)this.svgGroup.push(t);this.notation.dropShadow(this.filterUrl),this.unselect()}actionWhenSelected(){this.selectedComponentsId.forEach((t=>{(t.modelId?this.viewer.getModel(t.modelId):this.viewer).addSelectedComponentsById([t.userId])})),this.viewer.render()}actionWhenUnselected(){this.selectedComponentsId.forEach((t=>{(t.modelId?this.viewer.getModel(t.modelId):this.viewer).removeSelectedId([t.userId])})),this.viewer.render()}getMeasureResult(){let t=this.measureParams.unit,e=this.measureResult.toString(),i=MeasureResultFormat.formatCubic(e,this.measureParams);return i=i+MeasureResultFormat.getPostFix(t,!1)+"³",i.split(",").join("")}}class DrawingPolylineDistance extends MeasureDrawable{constructor(t,e,i,n){super(t,i,e.type,n),this.filterUrl=e.filterUrl,this.isOnLayoutMeasure=e.isOnLayout,this.viewPortId=e.viewPortId,this.worldPositions=e.points?e.points:[];for(let t=0;t<this.worldPositions.length;t++)this.worldPositions[t]=new Vector2(this.worldPositions[t][0],this.worldPositions[t][1]);this.measureResult={distance:e.distance,totalDistance:e.totalDistance},this.selectElements=[],this.unSelectElements=[],this.setMeasureParams({precision:e.precision,scale:e.scale,unit:e.unit,defaultUnit:e.defaultUnit})}initialize(){let t=this.worldPositions.length;if(!(t<2)){for(let e=1;e<t;e++){let t=[this.worldToClient(this.worldPositions[e]),this.worldToClient(this.worldPositions[e-1])];0!==t.length&&(1===e&&this.hitTestSegments.push(new Vector2(t[1].x,t[1].y)),this.hitTestSegments.push(new Vector2(t[0].x,t[0].y)),this.attachSelectedTerminalPoints(t[0]),this.attachLines(t),this.attachSelectedTerminalPoints(t[1]),this.attachUnselectedTerminalPoints(t[0]),this.attachUnselectedTerminalPoints(t[1]))}this.attachNotations(),this.unselect()}}worldToClient(t){if(this.isOnLayoutMeasure){let e=this.viewer.getViewer().toViewportScreenPoint([t.x,t.y],this.viewPortId);return{x:e[0],y:e[1]}}return this.viewer.worldToClient(t)}attachSelectedTerminalPoints(t){let e=MeasureUtil.makeCircle({position:t,radius:this.radius,strokeWidth:0,color:this.defaultColor});this.svgGroup.push(e),e.setAttribute("filter",this.filterUrl),this.selectElements.push(e)}attachLines(t){let e=MeasureUtil.makeLine({start:t[0],end:t[1],color:this.defaultColor,lineWidth:this.lineWidth});this.svgGroup.push(e)}attachUnselectedTerminalPoints(t){let e=MeasureUtil.makeCircle({position:t,radius:this.radius,strokeWidth:this.strokeWidth,color:this.defaultColor});this.svgGroup.push(e),e.setAttribute("filter",this.filterUrl),this.unSelectElements.push(e)}attachNotations(){const t=this.worldPositions.length,e=this.getMeasureResult();for(let i=1;i<t;i++){let t={x:(this.worldPositions[i].x+this.worldPositions[i-1].x)/2,y:(this.worldPositions[i].y+this.worldPositions[i-1].y)/2},n=this.worldToClient(t);this.attachNotation([n,n],e.distance[i-1])}let i={x:this.worldPositions[t-1].x,y:this.worldPositions[t-1].y},n=this.worldToClient(i);n.x+=10+MeasureUtil.measureText(`${BimfaceLanguage.bf_panel_measure_total_distance}：${e.totalDistance}`)/2,n.y-=15,this.attachNotation([n,n],`${BimfaceLanguage.bf_panel_measure_total_distance}：${e.totalDistance}`),this.notation.dropShadow(this.filterUrl)}attachNotation(t,e,i){if(0===t.length)return;let n=this.notation.drawAnnotation({x:(t[0].x+t[1].x)/2,y:(t[0].y+t[1].y)/2},e,this.id,i);for(const t of n)this.svgGroup.push(t)}getMeasureResult(){let t=this.measureParams.unit,{distance:e,totalDistance:i}=this.measureResult,n=[],o=0;return e.forEach((e=>{o+=e;let i=e.toString();i=MeasureResultFormat.formatDistance(i,this.measureParams),i+=MeasureResultFormat.getPostFix(t,!1),n.push(i)})),o=o.toString(),o=MeasureResultFormat.formatDistance(o,this.measureParams),o+=MeasureResultFormat.getPostFix(t,!1),{distance:n,totalDistance:o}}setViewId(t){this.viewId=t}getViewId(){return this.viewId}}class MeasureItemFactory{constructor(t){this.viewer=t}make(t,e,i,n){let o=null,s="ViewerDrawing"===this.viewer.getViewerType(),r={defaultColor:`#${n._opt.color.getHEX()}`};switch(t){case"Distance":o=s?new DrawingDistance(this.viewer,e,i,r):new Viewer3dDistance(this.viewer,e,i,r);break;case"Angle":o=s?new DrawingAngle(this.viewer,e,i,r):new Viewer3dAngle(this.viewer,e,i,r);break;case"MinimumDistance":o=new Viewer3dMinDistanceLine(this.viewer,e,i,r);break;case"Elevation":o=new Viewer3dElevation(this.viewer,e,i,r);break;case"Area":o=new MeasureArea(this.viewer,e,i,r);break;case"GroundlineDistance":o=new ViewerGISGroundlineDistance(this.viewer,e,i,r);break;case"PolylineDistance":o=s?new DrawingPolylineDistance(this.viewer,e,i,r):new ViewerGISPolylineDistance(this.viewer,e,i,r);break;case"Position":o=new ViewerGISPosition(this.viewer,e,i,r);break;case"TriangleDistance":o=new ViewerGISTriangleDistance(this.viewer,e,i,r);break;case"SpatialArea":o=new ViewerGISSpatialArea(this.viewer,e,i,r);break;case"ProjectedArea":o=new ViewerGISProjectedArea(this.viewer,e,i,r);break;case"SurfaceArea":o=new ViewerGISSurfaceArea(this.viewer,e,i,r);break;case"LaserClearDistance":o=new Viewer3dLaserClearDistance(this.viewer,e,i,r);break;case"Volume":o=new Viewer3dVolume(this.viewer,e,i,r)}return o.initialize(),o}}class Viewer3dDistance$1 extends Viewer3dDistance{constructor(t,e){super(t,e,e.id,{defaultColor:e.defaultColor}),this.worldPositions=e.worldPositions,this.measureResult=e.measureResult,this.updateIndex=e.updateIndex}calculate(t){this.worldPositions[this.updateIndex]=t,this.distanceX=Math.abs(this.worldPositions[1].x-this.worldPositions[0].x),this.distanceY=Math.abs(this.worldPositions[1].y-this.worldPositions[0].y),this.distanceZ=Math.abs(this.worldPositions[1].z-this.worldPositions[0].z),this.measureResult=Math.sqrt(Math.pow(this.distanceX,2)+Math.pow(this.distanceY,2)+Math.pow(this.distanceZ,2))}getInfo(){return{id:Glodon.Web.Lang.Utility.UUID.createUUID(),distance:this.measureResult,distanceX:this.distanceX,distanceY:this.distanceY,distanceZ:this.distanceZ,points:this.worldPositions,type:this.type}}}class Viewer3dAngle$1 extends Viewer3dAngle{constructor(t,e){super(t,e,e.id,{defaultColor:e.defaultColor}),this.worldPositions=e.worldPositions,this.measureAngle=e.measureAngle,this.updateIndex=e.updateIndex}calculate(t){this.worldPositions[this.updateIndex]=t;var e=new THREE.Vector3(this.worldPositions[0].x-this.worldPositions[1].x,this.worldPositions[0].y-this.worldPositions[1].y,this.worldPositions[0].z-this.worldPositions[1].z),i=new THREE.Vector3(this.worldPositions[2].x-this.worldPositions[1].x,this.worldPositions[2].y-this.worldPositions[1].y,this.worldPositions[2].z-this.worldPositions[1].z),n=e.angleTo(i);this.measureAngle=180*n/Math.PI}getInfo(){return{id:Glodon.Web.Lang.Utility.UUID.createUUID(),angle:this.measureAngle,points:this.worldPositions,type:this.type}}}class DrawingDistance$1 extends DrawingDistance{constructor(t,e){e.start=e.startPoint,e.end=e.endPoint,super(t,e,e.id,{defaultColor:e.defaultColor}),this.startPoint=new Vector2(e.worldPositions[0][0],e.worldPositions[0][1]),this.endPoint=new Vector2(e.worldPositions[1][0],e.worldPositions[1][1]),this.viewPortId=e.viewPortId,this.measureResult=e.measureResult,this.updateIndex=e.updateIndex,this.isOnLayoutMeasure=e.isOnLayoutMeasure}calculate(t,e){if(this.viewPortId&&this.viewPortId>0&&e!=this.viewPortId)return;0===this.updateIndex?this.startPoint=new Vector2(t[0],t[1]):this.endPoint=new Vector2(t[0],t[1]);let i=this.endPoint.x-this.startPoint.x,n=this.endPoint.y-this.startPoint.y;this.measureResult=Math.sqrt(i*i+n*n)}getInfo(){return{id:Glodon.Web.Lang.Utility.UUID.createUUID(),start:[this.startPoint.x,this.startPoint.y],end:[this.endPoint.x,this.endPoint.y],points:[[this.startPoint.x,this.startPoint.y],[this.endPoint.x,this.endPoint.y]],viewPortId:this.viewPortId,distance:this.measureResult,isOnLayout:this.isOnLayoutMeasure,type:this.type}}}class DrawingAngle$1 extends Viewer3dAngle$1{constructor(t,e){super(t,e),this.isOnLayoutMeasure=e.isOnLayoutMeasure,this.viewPortId=e.viewPortId}calculate(t,e){if(this.viewPortId&&this.viewPortId>0&&e!=this.viewPortId)return;this.worldPositions[this.updateIndex]=t;let i=this.getClientPoints();this.measureAngle=this.angleByArr([i[0].x,i[0].y],[i[1].x,i[1].y],[i[2].x,i[2].y])}getInfo(){return{id:Glodon.Web.Lang.Utility.UUID.createUUID(),angle:this.measureAngle,points:this.worldPositions,isOnLayout:this.isOnLayoutMeasure,viewPortId:this.viewPortId,type:this.type}}angleByArr(t,e,i){let n=Math.sqrt(Math.pow(e[0]-t[0],2)+Math.pow(e[1]-t[1],2)),o=Math.sqrt(Math.pow(e[0]-i[0],2)+Math.pow(e[1]-i[1],2)),s=Math.sqrt(Math.pow(t[0]-i[0],2)+Math.pow(t[1]-i[1],2)),r=(Math.pow(n,2)+Math.pow(o,2)-Math.pow(s,2))/(2*n*o);return r=r.toFixed(12),180*Math.acos(r)/Math.PI}getClientPoints(){let t=[];for(let e=0;e<this.worldPositions.length;e++){let i=new Vector2(this.worldPositions[e][0],this.worldPositions[e][1]),n=this.worldToClient(i,this.worldPositions[e][2]);t.push(new Vector2(n.x,n.y))}return t}worldToClient(t,e){if(this.isOnLayoutMeasure){let i=this.viewer.getViewer().toViewportScreenPoint([t.x,t.y],e);return{x:i[0],y:i[1]}}return this.viewer.worldToClient(t)}setViewId(t){this.viewId=t}getViewId(){return this.viewId}}class DrawingArea extends MeasureArea{constructor(t,e){super(t,e,e.id,{defaultColor:e.defaultColor}),this.worldPositions=e.worldPositions,this.measureResult=e.measureResult,this.viewPortId=e.viewPortId,this.updateIndex=e.updateIndex}calculate(t,e){if(this.viewPortId&&this.viewPortId>0&&e!=this.viewPortId)return;this.worldPositions[this.updateIndex]={point:[t[0],t[1]],viewPortId:e,isActiveLayoutElement:-1===e};let i=[];for(var n=0;n<this.worldPositions.length;n++)i.push(this.worldPositions[n].point);this.measureResult=this.getArea(i)}getArea(t){var e=t.length;if(e<3)return 0;for(var i=t[0][1]*(t[e-1][0]-t[1][0]),n=1;n<e;++n)i+=t[n][1]*(t[n-1][0]-t[(n+1)%e][0]);return Math.abs(i/2)}getInfo(){return{id:Glodon.Web.Lang.Utility.UUID.createUUID(),area:this.measureResult,points:this.worldPositions,viewPortId:this.viewPortId,type:this.type}}}class DrawingPolylineDistance$1 extends DrawingPolylineDistance{constructor(t,e){super(t,e,e.id,{defaultColor:e.defaultColor}),this.isOnLayoutMeasure=e.isOnLayoutMeasure,this.viewPortId=e.viewPortId,this.worldPositions=e.worldPositions,this.measureResult=e.measureResult,this.updateIndex=e.updateIndex}calculate(t,e){if(this.viewPortId&&this.viewPortId>0&&e!=this.viewPortId)return;this.worldPositions[this.updateIndex]=new Vector2(t[0],t[1]);let i=[],n=0;for(let t=1;t<this.worldPositions.length;t++){let e=this.worldPositions[t].x-this.worldPositions[t-1].x,o=this.worldPositions[t].y-this.worldPositions[t-1].y,s=Math.sqrt(e*e+o*o);i.push(s),n+=s}this.measureResult={distance:i,totalDistance:n}}getInfo(){let t=[];for(let e=0;e<this.worldPositions.length;e++)t.push([this.worldPositions[e].x,this.worldPositions[e].y]);return{id:Glodon.Web.Lang.Utility.UUID.createUUID(),distance:this.measureResult.distance,totalDistance:this.measureResult.totalDistance,isOnLayout:this.isOnLayoutMeasure,viewPortId:this.viewPortId,points:t,type:this.type}}}class ViewerGISPolylineDistance$1 extends ViewerGISPolylineDistance{constructor(t,e){super(t,e,e.id,{defaultColor:e.defaultColor}),this.worldPositions=e.worldPositions,this.measureResult=e.measureResult,this.updateIndex=e.updateIndex}calculate(t){this.worldPositions[this.updateIndex]=t;let e=this.worldPositions.length,i=[],n=0;for(let t=1;t<e;t++){let e=this.worldPositions[t].distanceTo(this.worldPositions[t-1]);i.push(e),n+=e}this.measureResult={distance:i,totalDistance:n}}getInfo(){return{id:Glodon.Web.Lang.Utility.UUID.createUUID(),distance:this.measureResult.distance,totalDistance:this.measureResult.totalDistance,points:this.worldPositions,type:this.type}}}class ViewerGISTriangleDistance$1 extends ViewerGISTriangleDistance{constructor(t,e){super(t,e,e.id,{defaultColor:e.defaultColor}),this.worldPositions=e.worldPositions,this.measureResult=e.measureResult,this.updateIndex=e.updateIndex}calculate(t){this.worldPositions[this.updateIndex]=t,this.measureResult.distance=this.worldPositions[0].distanceTo(this.worldPositions[1]);let e=this.worldPositions[0].clone(),i=0,n=0;this.worldPositions[0].z<this.worldPositions[1].z?(e.set(this.worldPositions[0].x,this.worldPositions[0].y,this.worldPositions[1].z),i=e.distanceTo(this.worldPositions[1]),n=e.distanceTo(this.worldPositions[0])):this.worldPositions[0].z>this.worldPositions[1].z&&(e.set(this.worldPositions[1].x,this.worldPositions[1].y,this.worldPositions[0].z),i=e.distanceTo(this.worldPositions[0]),n=e.distanceTo(this.worldPositions[1])),this.measureResult.horizontalDistance=i,this.measureResult.verticalDistance=n}getInfo(){return{id:Glodon.Web.Lang.Utility.UUID.createUUID(),distance:this.measureResult.distance,horizontalDistance:this.measureResult.horizontalDistance,verticalDistance:this.measureResult.verticalDistance,points:this.worldPositions,type:this.type}}}class ViewerGISSpatialArea$1 extends ViewerGISSpatialArea{constructor(t,e){super(t,e,e.id,{defaultColor:e.defaultColor}),this.worldPositions=e.worldPositions,this.measureResult=e.measureResult,this.updateIndex=e.updateIndex,this.selectElements=[],this.unSelectElements=[]}calculate(t){this.worldPositions[this.updateIndex]=t,this.measureResult=MeasureUtil.calcSpatialArea(this.worldPositions)}getInfo(){return{id:Glodon.Web.Lang.Utility.UUID.createUUID(),area:this.measureResult,points:this.worldPositions,type:this.type}}}class ViewerGISProjectedArea$1 extends ViewerGISSpatialArea$1{constructor(t,e){super(t,e)}calculate(t){this.worldPositions[this.updateIndex]=t,this.measureResult=MeasureUtil.calcProjectedArea(this.worldPositions)}getNotationTitle(){return BimfaceLanguage.bf_tip_measure_projected_area}}class ViewerGISSurfaceArea$1 extends ViewerGISSpatialArea$1{constructor(t,e){super(t,e),this.measureSurfaceMesh=null}calculate(t){this.worldPositions[this.updateIndex]=t,this.measureResult=MeasureUtil.calcSurfaceArea(this.worldPositions,this.viewer)}initialize(){this.measureSurfaceMesh||(this.measureSurfaceMesh=new MeasureSurfaceAreaMesh({fillColor:new Glodon.Web.Graphics.Color(255,157,11,.2),color:new Glodon.Web.Graphics.Color(255,157,11,1),width:this.lineWidth})),super.initialize()}attachArea(t){this.measureSurfaceMesh.setMeasurePoints(t),this.viewer.render()}getNotationTitle(){return BimfaceLanguage.bf_tip_measure_surface_area}clear(){super.clear(),this.measureSurfaceMesh&&(this.measureSurfaceMesh.dispose(),this.measureSurfaceMesh=null)}}class ViewerGISGroundlineDistance$1 extends ViewerGISGroundlineDistance{constructor(t,e){super(t,e,e.id,{defaultColor:e.defaultColor}),this.worldPositions=e.worldPositions,this.measureResult=e.measureResult,this.pointPos=e.pointPos,this.updateIndex=e.updateIndex,this.externalObjectManager=new Glodon.Bimface.Viewer.ExternalObjectManager(this.viewer),this.previewCurve=null,this.currentCurves=[],this.groundInfos=[],this.isFirst=!0}init(){for(let t=0;t<this.worldPositions.length-1;t++)this.createPath(this.worldPositions[t],this.worldPositions[t+1]),this.addInfo()}calculate(t){this.isFirst&&(this.init(),this.isFirst=!1),this.worldPositions[this.updateIndex]=t,this.updateIndex>0&&(this.createPath(this.worldPositions[this.updateIndex-1],this.worldPositions[this.updateIndex]),this.updateInfo(this.updateIndex-1)),this.updateIndex<this.worldPositions.length-1&&(this.createPath(this.worldPositions[this.updateIndex],this.worldPositions[this.updateIndex+1]),this.updateInfo(this.updateIndex));let e=[],i=0,n=[];for(let t=0;t<this.groundInfos.length;t++){let o=this.groundInfos[t];e.push(o.length),i+=o.length;let s={midPoint:o.midPoint,endPoint:o.endPoint};n.push(s)}this.measureResult.distance=e,this.measureResult.totalDistance=i,this.pointPos=n}getInfo(){return{id:Glodon.Web.Lang.Utility.UUID.createUUID(),distance:this.measureResult.distance,totalDistance:this.measureResult.totalDistance,points:this.worldPositions,positions:this.pointPos,item:this,curves:this.currentCurves,type:this.type}}createPath(t,e){let i=new THREE.Vector3(t.x,t.y,t.z),n=new THREE.Vector3(e.x,e.y,e.z);if(i.equals(n))return;let o,s=[];s.push(i),s.push(n),o=new THREE.CatmullRomCurve3(s),o.tension=0,o.type="catmullrom",this.createGroundCurve(o)}createGroundCurve(t){if(t){var e=new CLOUD.Raycaster,i=new THREE.Vector3,n=this.viewer.getViewer().cameraControl.getIntersectContext(null),o=new CLOUD.IntersectHelper(this.viewer.getViewer());e.camera=n.camera,e.viewportSize=n.viewportSize;var s=[];t.getPoints(100).forEach((t=>{i.copy(t),(i=this.viewer.worldToScene(t)).y=1e4,e.set(i,new THREE.Vector3(0,-1,0));let r=o.getObjectsByRaycaster(n,e,!0);if(r.length>0){let t;t=this.viewer.sceneToWorld(r[0].point),s.push(t)}else s.push(t)})),t=null,this.previewCurve=new Glodon.Bimface.Plugins.Geometry.SplineCurve(s),this.previewCurve.setWidth(3),this.previewCurve.setColor(new Glodon.Web.Graphics.Color(255,157,11,1)),this.previewCurve.projectToGround(!0)}}addInfo(){if(!this.previewCurve)return;let t=Glodon.Web.Lang.Utility.UUID.createUUID();this.currentCurves.push({id:t,curve:this.previewCurve}),this.groundInfos.push({id:t,length:this.previewCurve.length,midPoint:this.previewCurve.getPointByParameter(.5),endPoint:this.previewCurve.getPointByParameter(1),status:"finished"}),this.externalObjectManager&&this.externalObjectManager._addObject(t,this.previewCurve),this.previewCurve=null}updateInfo(t){if(!this.previewCurve)return;let e=this.groundInfos[t].id,i=this.externalObjectManager.getObjectIdByName(e);this.externalObjectManager.removeById(i),this.groundInfos[t]={id:e,length:this.previewCurve.length,midPoint:this.previewCurve.getPointByParameter(.5),endPoint:this.previewCurve.getPointByParameter(1),status:"finished"},this.externalObjectManager&&this.externalObjectManager._addObject(e,this.previewCurve),this.previewCurve=null}deleteCurveById(t){let e=this.externalObjectManager.getObjectIdByName(`${t}`);this.externalObjectManager.removeById(e)}}class MeasureUpdateManager{constructor(t,e,i){this.domContainer=t,this.viewer=e,this.measure=i,this.drawable=null,this.isDrawed=!1,this.lastMeasureType="",this.currentMeasureType=""}createDrawable(t){this.lastMeasureType=this.measure.type,this.currentMeasureType=t.type;let e="ViewerDrawing"===this.viewer.getViewerType();switch(t.type){case"Distance":this.drawable=e?new DrawingDistance$1(this.viewer,t):new Viewer3dDistance$1(this.viewer,t);break;case"Angle":this.drawable=e?new DrawingAngle$1(this.viewer,t):new Viewer3dAngle$1(this.viewer,t);break;case"PolylineDistance":this.drawable=e?new DrawingPolylineDistance$1(this.viewer,t):new ViewerGISPolylineDistance$1(this.viewer,t);break;case"Area":this.drawable=new DrawingArea(this.viewer,t);break;case"TriangleDistance":this.drawable=new ViewerGISTriangleDistance$1(this.viewer,t);break;case"SpatialArea":this.drawable=new ViewerGISSpatialArea$1(this.viewer,t);break;case"ProjectedArea":this.drawable=new ViewerGISProjectedArea$1(this.viewer,t);break;case"SurfaceArea":this.drawable=new ViewerGISSurfaceArea$1(this.viewer,t);break;case"GroundlineDistance":this.drawable=new ViewerGISGroundlineDistance$1(this.viewer,t);break;default:this.drawable=null}}draw(t,e){if(!this.drawable)return;this.isDrawed||this.measure.setMeasureType(this.currentMeasureType),this.isDrawed=!0;let i="ViewerDrawing"===this.viewer.getViewerType(),n={x:i&&!this.viewer.isFullScreen?t.clientX-e.left:t.clientX,y:i&&!this.viewer.isFullScreen?t.clientY-e.top:t.clientY},o={};if(i){var s=[],r=this.viewer._drawingViewer.snapToPoint(n.x,n.y),a=r.GetViewPortId&&r.GetViewPortId();if(r.GetPoint().length>0&&(s=[r.GetPoint()[0],r.GetPoint()[1],a]),!r.GetID()){let t=this.viewer._drawingViewer.toScreenPoint(r.GetPoint()),e=this.viewer._drawingViewer.toModelWorld(t);s=e,a=e[2]}o=s,this.drawable.calculate(o,a)}else{let t=this.viewer.getViewer().pickToPoint(n,5);t&&t.pickPoint&&(o=this.viewer.sceneToWorld(t.pickPoint),this.drawable.calculate(o))}let l=this.drawable.getInfo();this.measure.getEventManager().fireEvent(Glodon.Bimface.Plugins.Measure.MeasureEvent.MeasureResultUpdating,l),this.drawable.clear(),this.drawable.initialize(),this.drawable.select(),this.drawable.attach(this.domContainer)}end(){if(!this.drawable||!this.isDrawed)return;let t=this.drawable.getInfo();this.measure.drawableManager.addItem(t),this.drawable.clear(),this.drawable=null,this.isDrawed=!1,this.measure.getEventManager().fireEvent(Glodon.Bimface.Plugins.Measure.MeasureEvent.MeasureResultUpdated,t),this.measure.setMeasureType(this.lastMeasureType)}update(){this.drawable&&this.isDrawed&&(this.drawable.clear(),this.drawable.initialize(),this.drawable.select(),this.drawable.attach(this.domContainer))}}class SelectionControl{constructor(t,e,i){this.domContainer=t,this.measureItems=e,this.manage=i,this.measureUpdateManage=new MeasureUpdateManager(t,i.viewer,i.measure),this.selectedItem=null,this.selectionChanged=null,this.hoverChanged=null,this.isEnableSelection=!0,this.mousedownHitItem=null,this.offset=t.getBoundingClientRect(),Glodon$1.Web.Lang.Utility.ClientHelper.getIsDesktop()&&this.hookEvents()}hookEvents(){this.domContainer.addEventListener("mousemove",(t=>{if(!this.isEnableSelection)return;let e=new Vector2(t.clientX,t.clientY);this.manage.viewer.isFullScreen||(e.x-=this.offset.left,e.y-=this.offset.top),!this.isMouseDownMove&&this.mousedownPoint&&Math.abs(this.mousedownPoint.x-e.x)>=1&&Math.abs(this.mousedownPoint.y-e.y)>=1&&(this.isMouseDownMove=!0,this.mousedownPoint=null),this.isMouseDownMove&&(this.selectPointItemId&&(this.manage.removeItemById(this.selectPointItemId),this.selectPointItemId=null),this.measureUpdateManage.draw(t,this.offset));let i=this.hitTest(e);this.hoverChanged(i),i?(this.domContainer.style.cursor="default",t.preventDefault(),t.stopPropagation()):this.domContainer.style.cursor=""}),!1),this.domContainer.addEventListener("mousedown",(t=>{if(this.mousedownHitItem=null,this.selectPointItemId=null,this.mousedownPoint=null,this.isMouseDownMove=!1,!this.isEnableSelection)return;let e=new Vector2(t.clientX,t.clientY);this.manage.viewer.isFullScreen||(e.x-=this.offset.left,e.y-=this.offset.top);let i=this.hitTest(e);if(this.mousedownHitItem=i,i){for(let t=0;t<i.hitTestSegments.length;t++)if(Math.abs(i.hitTestSegments[t].x-e.x)<=3&&Math.abs(i.hitTestSegments[t].y-e.y)<=3){let n={...i,...i.measureParams,updateIndex:t};this.measureUpdateManage.createDrawable(n),this.measureUpdateManage.drawable&&(this.selectPointItemId=i.id,this.mousedownPoint=e);break}i.getIsSelected()?(this.selectionChanged(null),this.setSelectedItem(null),i.unselect()):(this.selectionChanged(i),this.setSelectedItem(i),i.select()),t.preventDefault(),t.stopPropagation()}}),!1),this.domContainer.addEventListener("mouseup",(t=>{this.measureUpdateManage.end(),this.selectPointItemId=null,this.mousedownPoint=null,this.isMouseDownMove=!1,this.mousedownHitItem&&(t.preventDefault(),t.stopPropagation())}),!1),this.domContainer.addEventListener("dblclick",(()=>{event.preventDefault(),event.stopPropagation()}),!1)}hitTest(t){for(var e=this.measureItems.length-1;e>=0;e--){let i=this.measureItems[e];if(i.getNotation().hitTest(t))return i}for(e=this.measureItems.length-1;e>=0;e--){let i=this.measureItems[e];if(i.hitTest(t))return i}return null}setSelectedItem(t){this.selectedItem&&(this.selectedItem.actionWhenUnselected(),this.selectedItem.unselect()),this.selectedItem=t,t&&t.actionWhenSelected()}getSelectedItem(){return this.selectedItem}hasSelected(){return null!==this.selectedItem}setIsEnableSelection(t){this.isEnableSelection=t}}class DropShadow{constructor(t){this.filterId=t.filterId,this.filterUnits=t.filterUnits,this.stdDeviation=t.stdDeviation,this.feOffset1=t.feOffset1,this.feOffset2=t.feOffset2,this.shadowOpacity=t.opacity,this.initialize()}initialize(){let t=document.createElementNS(this.xmlns,"defs"),e=document.createElementNS(this.xmlns,"filter");e.setAttribute("id",this.filterId),e.setAttribute("filterUnits",this.filterUnits);let i=document.createElementNS(this.xmlns,"feGaussianBlur");i.setAttribute("in","SourceAlpha"),i.setAttribute("stdDeviation",this.stdDeviation),e.appendChild(i);let n=document.createElementNS(this.xmlns,"feOffset");n.setAttribute("dx",this.feOffset1.dx),n.setAttribute("dy",this.feOffset1.dy),n.setAttribute("result","offsetblur");let o=document.createElementNS(this.xmlns,"feOffset");o.setAttribute("dx",this.feOffset2.dx),o.setAttribute("dy",this.feOffset2.dy),o.setAttribute("result","offsetblur"),e.appendChild(n),e.appendChild(o);let s=document.createElementNS(this.xmlns,"feComponentTransfer"),r=document.createElementNS(this.xmlns,"feFuncA");r.setAttribute("type","linear"),r.setAttribute("slope",this.shadowOpacity),s.appendChild(r),e.appendChild(s);let a=document.createElementNS(this.xmlns,"feMerge"),l=document.createElementNS(this.xmlns,"feMergeNode"),h=document.createElementNS(this.xmlns,"feMergeNode");h.setAttribute("in","SourceGraphic");let c=document.createElementNS(this.xmlns,"feMergeNode");c.setAttribute("in","SourceGraphic"),a.appendChild(l),a.appendChild(h),a.appendChild(c),e.appendChild(a),t.appendChild(e),this.dropShadowDefs=t}attach(t){this.dropShadowDefs||this.initialize(),t.appendChild(this.dropShadowDefs);let e=t.innerHTML;t.removeChild(this.dropShadowDefs),t.innerHTML=e}getFilterUrl(){return"url(#"+this.filterId+")"}}class MeasureItemManager{constructor(t,e,i){this.domContainer=t,this.viewer=e,this.measure=i,this.viewId=0,this.itemList=[],this.mapMeasureInfo={},this.initShadowManager(),this.drawableFactory=new MeasureItemFactory(e,i),this.hookViewer3DEvents()}hookViewer3DEvents(){this.selectionControl=new SelectionControl(this.domContainer,this.itemList,this),this.selectionControl.selectionChanged=t=>{if(t){let e=this.mapMeasureInfo[t.getId()];if(e.type=t.getType(),this.eventListener.fireEvent("MeasureSelected",e),this.bringToFront(t),this.itemClickCallback){let e=this.mapMeasureInfo[t.getId()];this.itemClickCallback(e)}}else this.eventListener.fireEvent("MeasureUnselected",{})},this.selectionControl.hoverChanged=t=>{t?(this.measure.disableMeasureCursor(),this.measure.setIsEnableSnap(!1)):t&&!this.measure.isMeasureOpen()||(this.measure.enableMeasureCursor(),this.measure.setIsEnableSnap(!0))},this.viewer.addEventListener("Rendered",(()=>{this.update(),this.selectionControl&&this.selectionControl.measureUpdateManage.update()})),document.addEventListener("keyup",(t=>{if(46===t.keyCode){let t=this.selectionControl.getSelectedItem();t&&(this.eventListener.fireEvent("MeasureSelected",{type:t.getType(),isDataEmpty:!0}),this.removeItemById(t.getId()),this.selectionControl.setSelectedItem(null))}})),this.viewer.addEventListener("ButtonOnToolbarClicked",(t=>{if("LeftSubToolbar"===t.id&&(this.selectionControl.setSelectedItem(null),this.showExclusiveByViewId(t.viewId),this.viewId=t.viewId),"Measure"===t.id){let e=this.selectionControl.getSelectedItem();if(t.isChecked){if(this.showAll(),e){let t=this.mapMeasureInfo[e.getId()];t.type=e.getType(),e&&e.actionWhenSelected(),this.eventListener.fireEvent("MeasureSelected",t)}}else this.hideAll(),e&&e.actionWhenUnselected()}}))}addItem(t){let e=t.type,i=t.id;if(this.mapMeasureInfo[i])return;this.mapMeasureInfo[i]=t,t.filterUrl=this.dropShadowManager.getFilterUrl();const n=this.measure.getMeasureParams();for(let e in n)t.hasOwnProperty(e)||(t[e]=n[e]);let o=this.drawableFactory.make(e,t,i,this.measure);"ViewerDrawing"===this.viewer.getViewerType()&&o.setViewId&&o.setViewId(this.viewId),o.attach(this.domContainer),o.select(),this.selectionControl.setSelectedItem(o),this.itemList.push(o)}removeItemById(t){this.mapMeasureInfo[t]&&delete this.mapMeasureInfo[t];for(var e=0;e<this.itemList.length;e++)if(this.itemList[e].getId()===t){this.itemList[e].clear(!0),this.itemList.splice(e,1);break}}update(){this.clear();for(const t of this.itemList)t.initialize(),t.attach(this.domContainer),t.dropShadow(this.dropShadowManager.getFilterUrl());this.selectionControl.hasSelected()&&this.selectionControl.getSelectedItem().select()}clear(t){for(const e of this.itemList)e.clear(t);t&&(this.itemList.length=0,this.selectionControl.setSelectedItem(null),this.eventListener.fireEvent("MeasureUnselected",{}),this.mapMeasureInfo={})}unselctedAll(){for(const t of this.itemList)t.unselect();this.selectionControl.selectedItem=null}hideAll(){for(const t of this.itemList)t.measureSurfaceMesh&&t.measureSurfaceMesh.hide();this.domContainer.style.display="none"}showAll(){for(const t of this.itemList)t.measureSurfaceMesh&&t.measureSurfaceMesh.show();this.domContainer.style.display="block",this.update()}onClick(t){t&&(this.itemClickCallback=t)}save(){let t=[],e=Object.keys(this.mapMeasureInfo);for(const i of e)t.push(this.mapMeasureInfo[i]);return t}load(t){for(var e=0;e<t.length;e++){var i=t[e];this.addItem(i)}this.unselctedAll()}setEventListener(t){this.eventListener=t,this.eventListener.addEvent("Measuring",(()=>{this.selectionControl.setSelectedItem(null),this.setIsEnableSelection(!1)})),this.eventListener.addEvent("Measured",(()=>{this.setIsEnableSelection(!0)})),this.eventListener.addEvent("Reset",(()=>{this.setIsEnableSelection(!0)})),this.eventListener.addEvent("MeasureParamsUpdated",(()=>{this.measure.measureItem&&this.measure.measureItem.setMeasureParams(this.measure.getMeasureParams());for(const t of this.itemList){let e=this.measure.getMeasureParams(t.type);t.setMeasureParams(e);t.id;this.mapMeasureInfo[t.id].precision=e.precision,this.mapMeasureInfo[t.id].scale=e.scale,this.mapMeasureInfo[t.id].unit=e.unit}if(this.update(),this.selectionControl.hasSelected()){let t=this.selectionControl.getSelectedItem(),e=this.mapMeasureInfo[t.getId()];e.type=t.getType(),this.eventListener.fireEvent("MeasureSelected",e)}}))}bringToFront(t){for(var e=0;e<this.itemList.length;e++)if(this.itemList[e].getId()===t.getId()){this.itemList.splice(e,1);break}t.detach(),this.itemList.push(t),t.attach(this.domContainer)}initShadowManager(){this.dropShadowManager=new DropShadow({filterId:"dropShadow",filterUnits:"userSpaceOnUse",stdDeviation:"2",feOffset1:{dx:5,dy:5},feOffset2:{dx:-5,dy:-5},opacity:"0.3"}),this.dropShadowManager.attach(this.domContainer)}getSelectedItem(){return this.selectionControl.getSelectedItem()}showExclusiveByViewId(t){for(const e of this.itemList)e.getViewId()===t?e.show():e.hide()}setIsEnableSelection(t){this.selectionControl.setIsEnableSelection(t)}}!function(){var t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Measure"),e=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.Dom"),i=null,n=null,o=[],s=null,r=null,a=function(t){var i=t.viewer,n=this,o=new Glodon$1.Web.Lang.EventManager,s=e.create("div","bf-measure-conext");n.isOpen=!1,i.addEventListener("Rendered",(function(){n.isOpen&&n.update()})),this._measureItemMap={},this.context={rootDomElement:s},this._opt=t,this.getEventManager=function(){return o},this.isEnableSnap=!0,this._p1=new THREE.Vector3,this._p2=new THREE.Vector3;var r=i.getViewer();r.registerEventListener(CLOUD$1.EVENTS.ON_MEASURE_PICK,(function(t){n.isOpen&&n.measureByPoint(t)})),r.registerEventListener(CLOUD$1.EVENTS.ON_VOLUME_MEASURE_END,(function(t){n.isOpen&&n.measureByPoint(t)})),r.registerEventListener(CLOUD$1.EVENTS.ON_MEASURE_RESET,(function(t){n.isOpen&&(n.measureItem.reset(),n.getEventManager().fireEvent(Glodon$1.Bimface.Plugins.Measure.MeasureEvent.Reset))}))};a.prototype={init:function(){var t=this.context,i=this._opt.viewer;i.getDomElement().appendChild(t.rootDomElement),i.getModels().forEach((t=>{t.setSelectedComponentsById()}));var n=e.createNS("svg","bf-measure-svg"),o=e.createNS("svg","bf-measure-svg"),s=e.create("div","bf-measure-text");t.rootDomElement.innerHTML="",t.rootDomElement.appendChild(n),t.rootDomElement.appendChild(o),this.drawableManager=new MeasureItemManager(o,i,this),this.drawableManager.setEventListener(this.getEventManager()),this.switchOn(),t.svg=n,t.text=s,i.render()},enableMeasureCursor(){this._opt.viewer.getDomElement().style.cursor=`url(${Cursor.measure}),auto`},disableMeasureCursor(){this._opt.viewer.getDomElement().style.cursor=""},hideDragButton(){!Glodon$1.Web.Lang.Utility.ClientHelper.getIsDesktop()&&this.measureItem&&this.measureItem.hideDragButton&&this.measureItem.hideDragButton()},activeByMeasureType:function(){Glodon$1.Web.Lang.Utility.ClientHelper.getIsDesktop()||this.drawableManager.clear(!0),this.enableMeasureCursor();let t=this._opt.viewer.getViewer();if(this.type===Glodon$1.Bimface.Plugins.Measure.MeasureTypeOption.Volume?(t.editorManager.disableTool(CLOUD$1.EditToolMode.PICK_BY_MEASURE),t.editorManager.enableTool(t,CLOUD$1.EditToolMode.VOLUME_MEASURE)):(t.editorManager.disableTool(CLOUD$1.EditToolMode.VOLUME_MEASURE),t.editorManager.enableTool(t,CLOUD$1.EditToolMode.PICK_BY_MEASURE)),this._measureItemMap[this.type])this.measureItem=this._measureItemMap[this.type];else{let t=new Glodon$1.Bimface.Plugins.Measure.MeasureItemConfig;t=Object.assign(t,this._opt),t.measure=this,t.measureType=this.type,this.measureItem=new Glodon$1.Bimface.Plugins.Measure[`Measure${this.type}Item`](t),this._measureItemMap[this.type]=this.measureItem}},switchOn:function(){this.isOpen||(this.activeByMeasureType(),this.isOpen=!0,this.drawableManager.setIsEnableSelection(!0),this.context.rootDomElement.setAttribute("style","display: block"))},switchOff:function(){if(this.isOpen){this.hideDragButton();var t=this,e=t._opt.viewer.getViewer();this.disableMeasureCursor(),e.editorManager.disableTool(CLOUD$1.EditToolMode.PICK_BY_MEASURE),e.editorManager.disableTool(CLOUD$1.EditToolMode.VOLUME_MEASURE),t.reset(),t.measureItem=null,this.isOpen=!1,this.drawableManager.setIsEnableSelection(!1),this.context.rootDomElement.setAttribute("style","display: none")}},measureByPoint:function(t){var e=this,a=Glodon$1.Web.Lang.Utility.ClientHelper.getIsDesktop(),l=e.measureItem;if(t){i=t.pickPoint?t.pickPoint:null,t.pickPlane?(s="Panel",r=t.normal):t.pickLine?(s="Line",o=t.pickLine):s=t.pickPoint?"Point":null;var h=this.type==Glodon$1.Bimface.Plugins.Measure.MeasureTypeOption.Volume;if(t.pick&&t.pickPoint||h){var c=this.type==Glodon$1.Bimface.Plugins.Measure.MeasureTypeOption.Elevation,d=this.type==Glodon$1.Bimface.Plugins.Measure.MeasureTypeOption.MinimumDistance;const i=this.type==Glodon$1.Bimface.Plugins.Measure.MeasureTypeOption.LaserClearDistance;if(c)l.redo(),l.addPoint(t.pickPoint),l.draw(this.context);else if(d&&t.userId)l.addPoint({userId:t.userId,modelId:t.modelId});else if(h&&t.objectId){for(let e in this.drawableManager.mapMeasureInfo){let i=this.drawableManager.mapMeasureInfo[e].points[0];if(i.modelId===t.modelId&&i.userId===t.objectId){this.drawableManager.removeItemById(e);break}}this.volumeResult=t.volume,this.volumePosition=t.position,l.addPoint({userId:t.objectId,modelId:t.modelId})}else i?t.userId&&l.addPoint({componentId:t.userId,modelId:t.modelId,point:t.pickPoint}):(l.addPoint(this.context.footPoint?n:t.pickPoint),e.update());l.getPoints().length==l.maxPointsNum?this.measureByInfo(this.getInfo()):(a||this.drawableManager.clear(!0),e.getEventManager().fireEvent(Glodon$1.Bimface.Plugins.Measure.MeasureEvent.Measuring,e.getInfo()))}else this.isEnableSnap&&e.update()}},measureByInfo(t){const e=Glodon$1.Web.Lang.Utility.ClientHelper.getIsDesktop();e||this.drawableManager.clear(!0),this.drawableManager.addItem(t),e||this.drawableManager.unselctedAll(),this.measureItem.setIsReserverd(!0),this.getEventManager().fireEvent(Glodon$1.Bimface.Plugins.Measure.MeasureEvent.Measured,t),this.measureItem.reset(!1)},measureMinimum:function(){},reset:function(){this.isOpen&&(this.measureItem.reset(),this.context.svg.innerHTML="",this.getEventManager().fireEvent(Glodon$1.Bimface.Plugins.Measure.MeasureEvent.Reset))},setIsEnableSnap:function(t){t||(this.context.svg.innerHTML=""),this.isEnableSnap=t},update:function(){var t=this.measureItem,e=this.context,a=this._opt.viewer,l=a.getDomElement(),h=l.getBoundingClientRect(),c=a.getViewer(),d=t.getPoints(),u=[],p=[];if(e.svg.innerHTML="",e.footPoint=null,i?(e.hoverPosition=a.worldToClient(i),e.hoverPositionDS=c.getScene().worldToDrawing(i),0!=d.length&&(u=d.concat([i]))):(e.hoverPosition=null,0!=d.length&&(u=d.concat(d[d.length-1]))),e.hoverObjectType=s,"Line"==s&&2==o.length){e.lineStartPoint=a.worldToClient(o[0]),e.lineEndPoint=a.worldToClient(o[1]);var g=new THREE.Vector2(e.lineStartPoint.x,e.lineStartPoint.y),m=new THREE.Vector2(e.lineEndPoint.x,e.lineEndPoint.y),f=new THREE.Box2;f.min.set(l.clientLeft,l.clientTop),f.max.set(f.min.x+l.clientWidth,f.min.y+l.clientHeight);var w=!f.containsPoint(g),v=!f.containsPoint(m),y={start:g,end:m},b=CLOUD$1.CameraUtil.lineIntersectWithRect(y,f);if(w&&v)2==b.length&&(e.lineStartPoint=b[0],e.lineEndPoint=b[1]);else if(w||v)for(var E=new THREE.Vector2(e.hoverPosition.x,e.hoverPosition.y),C=w?m.clone():g.clone(),x=C.clone().sub(E).normalize(),M=0;M<b.length;M++){if(C.clone().sub(b[M]).normalize().dot(x)>0){e.lineStartPoint=C,e.lineEndPoint=b[M];break}}let t=d[d.length-1];if(t){let i=o[0].clone(),s=o[1].clone();const r=i.x-s.x,l=i.y-s.y,h=i.z-s.z;let c=(t.x-i.x)*(i.x-s.x)+(t.y-i.y)*(i.y-s.y)+(t.z-i.z)*(i.z-s.z);c/=Math.pow(r,2)+Math.pow(l,2)+Math.pow(h,2);let d=new THREE.Vector3(i.x+c*r,i.y+c*l,i.z+c*h),u=a.worldToClient(d);new THREE.Vector2(e.hoverPosition.x,e.hoverPosition.y).distanceTo(u)<=5&&(e.footPoint=u,e.hoverPosition=u,n=d)}}if("Panel"==e.hoverObjectType){e.normal=c.getScene().worldToDrawing(r),e.normal.normalize();var P=c.cameraControl,I=new THREE.Plane;I.setFromNormalAndCoplanarPoint(e.normal,e.hoverPositionDS);var T=new THREE.Vector2(e.hoverPosition.x-10,e.hoverPosition.y-10),D=new THREE.Vector2(e.hoverPosition.x+10,e.hoverPosition.y-10),S=e.hoverPositionDS,B=P.getRaycaster(T.x,T.y);if(this._p1=B.ray.intersectPlane(I,this._p1),B=P.getRaycaster(D.x,D.y),this._p2=B.ray.intersectPlane(I,this._p2),null==this._p1||null==this._p2)return this._p1=new THREE.Vector3,void(this._p2=new THREE.Vector3);var A=new THREE.Vector3(1,0,0),_=new THREE.Vector3(0,1,0),k=new THREE.Vector3(0,0,1),L=Math.abs(e.normal.clone().dot(A))<=.0025,R=Math.abs(e.normal.clone().dot(k))<=.0025;if(L&&R)var G=A.clone(),N=k.clone();else G=_.clone().cross(e.normal).normalize(),N=e.normal.clone().cross(G).normalize();var V=this._p1.distanceTo(this._p2)/2,$=G.clone().multiplyScalar(V),O=N.clone().multiplyScalar(V),U=S.clone().sub($).add(O),H=S.clone().add($).add(O),z=S.clone().sub($).sub(O),F=S.clone().add($).sub(O),W=[];W.push(U,H,F,z);for(var j=[],Z=P.getContainerDimensions(),X=0;X<W.length;X++){var Y=CLOUD$1.CameraUtil.drawingToCanvas(P.camera,W[X],Z.width,Z.height);j.push(new THREE.Vector3(Y.x,Y.y,0))}e.clientPts=j}for(M=0;M<u.length-1;M++){if(et=c.worldPointsToClient(u[M],u[M+1])){var q={x:et.start.x-h.left,y:et.start.y-h.top};p.push(q)}}if(this.type==Glodon$1.Bimface.Plugins.Measure.MeasureTypeOption.Distance&&d.length==t.maxPointsNum){var K={x:d[1].x,y:d[0].y,z:d[0].z},J={x:d[1].x,y:d[1].y,z:d[0].z},Q=[],tt=[d[0],K,J,d[1]];for(X=0;X<tt.length-1;X++){var et;(et=c.worldPointsToClient(tt[X],tt[X+1]))&&(et.start.x-=h.left,et.start.y-=h.top,et.end.x-=h.left,et.end.y-=h.top),Q.push(et)}e.auxLines=Q}e.clientPoints=p,t.draw(e)},getInfo:function(){var t={},e=this.measureItem,i=this._opt.viewer,n=e.getPoints();if(t.type=this.type,t.id=Glodon$1.Web.Lang.Utility.UUID.createUUID(),this.type==Glodon$1.Bimface.Plugins.Measure.MeasureTypeOption.LaserClearDistance&&1===n.length)r&&Object.assign(t,e.computeMeasureResult(r));else if(this.type==Glodon$1.Bimface.Plugins.Measure.MeasureTypeOption.MinimumDistance){if(2==n.length){var o=i.getMinimumComponentDistanceById(`[${n[0].modelId}]${n[0].userId}`,`[${n[1].modelId}]${n[1].userId}`);t.distance=o.minDistance,t.start=o.start,t.end=o.end}t.points=n}else if(this.type==Glodon$1.Bimface.Plugins.Measure.MeasureTypeOption.Volume)t.volumeResult=this.volumeResult,t.volumePosition=this.volumePosition,t.notSupport=!this.volumeResult,t.points=n;else if(t.points=n,this.type==Glodon$1.Bimface.Plugins.Measure.MeasureTypeOption.Distance)n&&2==n.length&&(t.distanceX=Math.abs(n[1].x-n[0].x),t.distanceY=Math.abs(n[1].y-n[0].y),t.distanceZ=Math.abs(n[1].z-n[0].z),t.distance=Math.sqrt(Math.pow(t.distanceX,2)+Math.pow(t.distanceY,2)+Math.pow(t.distanceZ,2)));else if(3==n.length){var s=new THREE.Vector3(n[0].x-n[1].x,n[0].y-n[1].y,n[0].z-n[1].z),a=new THREE.Vector3(n[2].x-n[1].x,n[2].y-n[1].y,n[2].z-n[1].z),l=s.angleTo(a);t.angle=180*l/Math.PI}return t},redo:function(){this.measureItem.redo(),this.update(),this.getEventManager().fireEvent(Glodon$1.Bimface.Plugins.Measure.MeasureEvent.Measuring,this.getInfo())},exit:function(){this.switchOff()},isMeasureOpen:function(){return this.isOpen},getDefaultUnit:function(){return this._opt.viewer._defaultUnit}},t.MeasureViewer3D=a}(),function(){var t="Bimface.Plugins.Measure.MeasureDrawing",e=Glodon$1.Bimface.Data.StatisticsDataManager.getInstance(),i=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Measure"),n=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.Dom"),o=function(t){let e=Glodon$1.Web.Lang.Utility.ClientHelper.getIsDesktop();this._opt=t,this.isOpen=!1;var i=t.viewer,o=i.getViewer();this.viewer=i,this.viewerDrawing=o,this.domElement=i.getDomElement();var s=new Glodon$1.Web.Lang.EventManager;let r=this;this.getEventManager=function(){return s},i.setSnapDistance(t.snapDistance);let a=n.createNS("svg","bf-measure-svg");a.style.position="absolute",a.style.left=0,a.style.top=0,a.style.width="100%",a.style.height="100%",o.dom.appendChild(a),this.drawableManager=new MeasureItemManager(a,i,this),this.drawableManager.setEventListener(s),i.addEventListener("Measured",(t=>{if(!t)return;e||this.drawableManager.clear(!0),t.id=Glodon$1.Web.Lang.Utility.UUID.createUUID(),this.drawableManager.addItem(t),e||this.drawableManager.unselctedAll();let n=t.type,{type:o,id:s,points:a}=t,l={type:o,id:s,points:a};l[n.toLowerCase()]=t[n.toLowerCase()],l.type=n,r.getEventManager().fireEvent(Glodon$1.Bimface.Plugins.Measure.MeasureEvent.Measured,l),delete i.isMeasuring})),i.addEventListener("Measuring",(t=>{e||this.drawableManager.clear(!0),t.id=Glodon$1.Web.Lang.Utility.UUID.createUUID(),r.getEventManager().fireEvent(Glodon$1.Bimface.Plugins.Measure.MeasureEvent.Measuring,t),i.isMeasuring=!0})),i.addEventListener("Reset",(()=>{this.getEventManager().fireEvent(Glodon$1.Bimface.Plugins.Measure.MeasureEvent.Reset),delete i.isMeasuring}))};o.prototype={init:function(i){e.send(t,"init");i&&(this._callback=i),this.switchOn()},activeByMeasureType:function(){Glodon$1.Web.Lang.Utility.ClientHelper.getIsDesktop()||this.drawableManager.clear(!0);let t=this.viewerDrawing.mouseEditorMgr,e={color:`#${this._opt.color.getHEX()}`};this.type===Glodon$1.Bimface.Plugins.Measure.MeasureTypeOption.PolylineDistance&&(e.measureResultFormat=MeasureResultFormat,e.measure=this,e.totalLengthText=BimfaceLanguage.bf_panel_measure_total_distance),t.activeEditorByName(`${this.type}Measure`,e)},switchOn:function(){e.send(t,"switchOn"),this.isOpen||(this.isOpen=!0,this.enableMeasureCursor(),this.activeByMeasureType(),this.drawableManager.setIsEnableSelection(!0))},enableMeasureCursor:function(){this.domElement.firstElementChild.style.cursor=`url(${Cursor.measure}),auto`},enableOcclusionCursor:function(){this.domElement.firstElementChild.style.cursor=`url(${Cursor.occlusion}),auto`},disableMeasureCursor:function(){this.domElement.firstElementChild.style.cursor=""},switchOff:function(){e.send(t,"switchOff"),this.isOpen&&(this.isOpen=!1,this.disableMeasureCursor(),this.measureItem=null,this.viewerDrawing.mouseEditorMgr.editors.forEach((t=>{t.auxMobileMeasureTool&&(t.auxMobileMeasureTool.center=null)})),this.viewerDrawing.mouseEditorMgr.activeEditorByName("pick"),this.drawableManager.setIsEnableSelection(!1))},reset:function(){e.send(t,"reset");var i=this.viewerDrawing.mouseEditorMgr.getEditor();i.reset&&i.reset(),this.getEventManager().fireEvent(Glodon$1.Bimface.Plugins.Measure.MeasureEvent.Reset),this.viewerDrawing.update()},update:function(){e.send(t,"update")},exit:function(){e.send(t,"exit"),this.switchOff()},isMeasureOpen:function(){return this.isOpen},setIsEnableSnap:function(t){let e=this.viewerDrawing.mouseEditorMgr.getEditor();e.setIsEnableSnap&&e.setIsEnableSnap(t)},getDefaultUnit:function(){return null}},i.MeasureDrawing=o}(),function(){let t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility"),e=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Measure"),i=(Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.Dom"),new Glodon$1.Web.Graphics.Color(17,218,183,.2),function(t){e.MeasureItem.call(this,t),this.measureEnd=!1,this.maxPointsNum=1/0,this.minPointsNum=2});t.Type.inheritPrototype(i,e.MeasureItem);var n={reset:function(){if(this.measurePoints=[],this.measureEnd=!1,this.maxPointsNum=1/0,this._svg){for(var t=this._svg.childNodes,e=t.length-1;e>-1;e--)this._svg.removeChild(t[e]);this._svg.innerHTML=""}},addPoint:function(t){if(this.hoverPositionUpdated=!1,!0!==this.measureEnd||this.measurePoints.length==this.maxPointsNum){if(this.measurePoints.length==this.maxPointsNum)this.reset();else if(this.measurePoints.length>0){let e=this.measurePoints.length,i=this.measurePoints[e-1];if(t.x===i.x&&t.y===i.y&&t.z===i.z)return}this.measurePoints.push(t),this.setIsReserverd(!1)}else this.maxPointsNum=this.measurePoints.length},draw:function(t,e){if(this.measureResult=e,this._svg=t.svg,this.drawCaptureItem(t),!this.getIsReserverd())switch(t.clientPoints.length){case 0:break;case 1:this.getMeasureResult();this.drawTerminalPoint(t.clientPoints[0]),t.hoverPosition&&this.drawLine([t.clientPoints[0],t.hoverPosition]),this.drawNotations();break;default:for(let e=1;e<t.clientPoints.length;e++)this.drawTerminalPoint(t.clientPoints[e-1]),this.drawLine([t.clientPoints[e-1],t.clientPoints[e]]),this.drawTerminalPoint(t.clientPoints[e]),t.hoverPosition&&e==t.clientPoints.length-1&&this.drawLine([t.clientPoints[e],t.hoverPosition]);this.drawNotations()}},drawNotations(){let t=[...this.measurePoints];this.hoverPositionUpdated&&this.nextMeasurePoint&&t.push(this.nextMeasurePoint);const e=t.length,i=this.getMeasureResult();for(let n=1;n<e;n++){let e={x:(t[n].x+t[n-1].x)/2,y:(t[n].y+t[n-1].y)/2,z:(t[n].z+t[n-1].z)/2},o=this.viewer.worldToClient(e);this.viewer.isInViewFrustum(e)&&this.drawNotation([o,o],i.distance[n-1])}let n={x:t[e-1].x,y:t[e-1].y,z:t[e-1].z},o=this.viewer.worldToClient(n);this.viewer.isInViewFrustum(n)&&this.drawNotation([o,o],`总长度：${i.totalDistance}`,!0),this.notation.dropShadow(this.filterUrl)},getMeasureResult(){let t=this.measureParams.unit,{distance:e,totalDistance:i}=this.measureResult,n=[],o=0;return e.forEach((e=>{o+=e;let i=e.toString();i=MeasureResultFormat.formatDistance(i,this.measureParams),i+=MeasureResultFormat.getPostFix(t,!1),n.push(i)})),o=o.toString(),o=MeasureResultFormat.formatDistance(o,this.measureParams),o+=MeasureResultFormat.getPostFix(t,!1),{distance:n,totalDistance:o}}};i.prototype=Object.assign(i.prototype,n),e.MeasurePolylineDistanceItem=i}(),function(){let t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility"),e=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Measure"),i=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.Dom"),n=function(t){e.MeasureItem.call(this,t),this.viewer=t.viewer,this.maxPointsNum=1;var n=new Glodon$1.Web.Graphics.Color(17,218,183,.2),o=i.createNS("circle","bf-measure-handle");o.setAttribute("r",t.width),o.setAttribute("fill",n.getRGB()),o.style.fill=n.getRGB();var s=i.createNS("line","bf-measure-line");s.style.strokeWidth=2,s.style.stroke=n.getRGB();var r=i.createNS("polygon","bf-measure-rect");r.setAttribute("fill",n.getRGBA()),r.setAttribute("stroke",n.getRGB()),r.setAttribute("stroke-width",1),this.hoverLine=s,this.hoverPoint=o,this.hoverPanel=r,this.hoverPanelSize={width:20,height:20}};t.Type.inheritPrototype(n,e.MeasureItem);n.prototype=Object.assign(n.prototype,{draw:function(t){this.drawCaptureItem(t)}}),e.MeasurePositionItem=n}(),function(){let t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility"),e=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Measure"),i=(Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.Dom"),new Glodon$1.Web.Graphics.Color(17,218,183,.2),function(t){e.MeasureItem.call(this,t)});t.Type.inheritPrototype(i,e.MeasureItem);var n={draw:function(t,e){const i=this.measurePoints,n=this.nextMeasurePoint;if(this._svg=t.svg,this.measureResult={distance:e.distance,horizontalDistance:e.horizontalDistance,verticalDistance:e.verticalDistance},this.drawCaptureItem(t),this.getIsReserverd()||0==i.length)return;let o=i.concat([n]),s=this.getMeasureResult(),r=this.calcLine(o[0],o[1]);if(this.drawTerminalPoint(r[0]),this.drawBorderlineByPoints(o,s.distance),o[0].z!=o[1].z){let t=o[0].z<o[1].z?o[0]:o[1],e=o[0].z<o[1].z?o[1]:o[0],i=this.calcTrianglePoint(o);this.drawBorderlineByPoints([t,i],s.verticalDistance),this.drawBorderlineByPoints([e,i],s.horizontalDistance)}else this.drawBorderlineByPoints([o[0],o[0]],s.horizontalDistance)},calcTrianglePoint(t){if(t.length<2)return null;let e=new THREE.Vector3;return t[0].z<t[1].z?e.set(t[0].x,t[0].y,t[1].z):t[0].z>t[1].z&&e.set(t[1].x,t[1].y,t[0].z),e},drawBorderlineByPoints(t,e){let i=t[0],n=t[1],o=this.calcLine(i,n);this.drawLine(o);let s={x:(i.x+n.x)/2,y:(i.y+n.y)/2,z:(i.z+n.z)/2},r=this.viewer.worldToClient(s);this.viewer.isInViewFrustum(s)&&this.drawNotation([r,r],e)},drawNotation:function(t,e){if(0===t.length)return;let i=this.notation.drawAnnotation({x:(t[0].x+t[1].x)/2,y:(t[0].y+t[1].y)/2},e,this.id);for(const t of i)this._svg.appendChild(t)},getMeasureResult:function(){const t=this.measureParams.unit;let{distance:e,horizontalDistance:i,verticalDistance:n}=this.measureResult;return e=e.toString(),e=MeasureResultFormat.formatDistance(e,this.measureParams),e+=MeasureResultFormat.getPostFix(t,!1),i=i.toString(),i=MeasureResultFormat.formatDistance(i,this.measureParams),i+=MeasureResultFormat.getPostFix(t,!1),n=n.toString(),n=MeasureResultFormat.formatDistance(n,this.measureParams),n+=MeasureResultFormat.getPostFix(t,!1),{distance:e,horizontalDistance:i,verticalDistance:n}}};i.prototype=Object.assign(i.prototype,n),e.MeasureTriangleDistanceItem=i}(),function(){let t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility"),e=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Measure"),i=(Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.Dom"),new Glodon$1.Web.Graphics.Color(17,218,183,.2),function(t){e.MeasureItem.call(this,t),this.measureEnd=!1,this.minPointsNum=3,this.maxPointsNum=1/0});t.Type.inheritPrototype(i,e.MeasureItem);var n={addPoint:function(t){if(!0!==this.measureEnd||this.measurePoints.length==this.maxPointsNum){if(this.measurePoints.length==this.maxPointsNum)this.measureEnd=!1,this.maxPointsNum=1/0,this.measurePoints=[],this.reset();else if(this.measurePoints.length>0){let e=this.measurePoints.length,i=this.measurePoints[e-1];if(t.x===i.x&&t.y===i.y&&t.z===i.z)return}this.measurePoints.push(t),this.setIsReserverd(!1)}else this.maxPointsNum=this.measurePoints.length},reset:function(){if(this.measurePoints=[],this.measureEnd=!1,this.maxPointsNum=1/0,this._svg){for(var t=this._svg.childNodes,e=t.length-1;e>-1;e--)this._svg.removeChild(t[e]);this._svg.innerHTML=""}},draw:function(t,e){if(this.measureResult=e.area,this._svg=t.svg,this.drawCaptureItem(t),!this.getIsReserverd())switch(t.clientPoints.length){case 0:break;case 1:if(t.hoverPosition){let e=MeasureUtil.makeLine({start:t.clientPoints[0],end:t.hoverPosition,color:this.measureItemConfig.color.getRGBA(),lineWidth:this.measureItemConfig.width});t.svg.appendChild(e)}let e=MeasureUtil.makeCircle({strokeWidth:2,color:this.measureItemConfig.color.getRGBA(),radius:5,position:t.clientPoints[0]});e.setAttribute("filter",this.filterUrl),t.svg.appendChild(e);break;default:this.drawArea(t.clientPoints,t.hoverPosition),this.drawNotation(t.hoverPosition,`${this.getNotationTitle()}：${this.getMeasureResult()}`)}},drawArea:function(t,e){const i=e?t.concat(e):t;let n="";i.forEach((t=>{n+=t.x+","+t.y+" "}));let o=MeasureUtil.makePolygon({points:n,width:this.measureItemConfig.width,color:this.measureItemConfig.color.getRGBA(),fillColor:this.measureItemConfig.fillColor.getRGBA()});this._svg.appendChild(o),t.forEach((t=>{let e=MeasureUtil.makeCircle({strokeWidth:2,color:this.measureItemConfig.color.getRGBA(),radius:5,position:t});e.setAttribute("filter",this.filterUrl),this._svg.appendChild(e)}))},drawNotation:function(t,e){let i=this.notation.drawAnnotation({x:t.x,y:t.y},e,this.id,!0);for(const t of i)this._svg.appendChild(t)},getNotationTitle:()=>BimfaceLanguage.bf_tip_measure_spatial_area,getMeasureResult(){let t=this.measureParams.unit,e=this.measureResult.toString();return e=MeasureResultFormat.formatArea(e,this.measureParams),e+=MeasureResultFormat.getPostFix(t,!0),e}};i.prototype=Object.assign(i.prototype,n),e.MeasureSpatialAreaItem=i}(),function(){let t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility"),e=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Measure"),i=(Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.Dom"),new Glodon$1.Web.Graphics.Color(17,218,183,.2),function(t){e.MeasureSpatialAreaItem.call(this,t)});t.Type.inheritPrototype(i,e.MeasureSpatialAreaItem);let n={getNotationTitle:()=>BimfaceLanguage.bf_tip_measure_projected_area};i.prototype=Object.assign(i.prototype,n),e.MeasureProjectedAreaItem=i}(),function(){let t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility"),e=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Measure"),i=(Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.Dom"),new Glodon$1.Web.Graphics.Color(17,218,183,.2),function(t){e.MeasureSpatialAreaItem.call(this,t),this.defaultColor=t.color,this.fillColor=t.fillColor,this.borderWidth=t.width,this.measureSurfaceMesh=null});t.Type.inheritPrototype(i,e.MeasureSpatialAreaItem);let n={reset:function(){if(this.measurePoints=[],this.measureEnd=!1,this.maxPointsNum=1/0,this._svg){for(var t=this._svg.childNodes,e=t.length-1;e>-1;e--)this._svg.removeChild(t[e]);this._svg.innerHTML=""}this.measureSurfaceMesh&&(this.measureSurfaceMesh.dispose(),this.measureSurfaceMesh=null)},draw:function(t,e){if(this.measureResult=e.area,this._svg=t.svg,this.drawCaptureItem(t),!this.getIsReserverd())switch(this.measurePoints.length){case 0:this.measureSurfaceMesh&&this.measureSurfaceMesh.dispose();break;case 1:this.drawArea(this.measurePoints,t.hoverPosition),this.drawTerminals(t.clientPoints,t.hoverPosition);break;default:this.drawArea(this.measurePoints,t.hoverPosition),this.drawTerminals(t.clientPoints,t.hoverPosition),this.drawNotation(t.hoverPosition,`${this.getNotationTitle()}：${this.getMeasureResult()}`)}},drawArea(t,e){const i=this.viewer.getDomElement().getBoundingClientRect&&this.viewer.getDomElement().getBoundingClientRect(),n=i?i.x:0,o=i?i.y:0,s={x:e.x+n,y:e.y+o,z:e.z};let r=this.viewer.clientToWorld(s),a=[...t];a.push(r),this.measureSurfaceMesh||(this.measureSurfaceMesh=new MeasureSurfaceAreaMesh({fillColor:new Glodon$1.Web.Graphics.Color(255,157,11,.2),color:new Glodon$1.Web.Graphics.Color(255,157,11,1),width:this.borderWidth})),this.measureSurfaceMesh.setMeasurePoints(a),this.viewer.render()},drawTerminals(t,e){e&&t.concat(e);t.forEach((t=>{let e=MeasureUtil.makeCircle({strokeWidth:2,color:this.measureItemConfig.color.getRGBA(),radius:5,position:t});e.setAttribute("filter",this.filterUrl),this._svg.appendChild(e)}))},getNotationTitle:()=>BimfaceLanguage.bf_tip_measure_surface_area};i.prototype=Object.assign(i.prototype,n),e.MeasureSurfaceAreaItem=i}(),function(){let t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility"),e=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Measure"),i=(Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.Dom"),new Glodon$1.Web.Graphics.Color(17,218,183,.2),function(t){e.MeasureItem.call(this,t),this.measureEnd=!1,this.maxPointsNum=1/0,this.minPointsNum=2,this.groundCurve=new Map,this.currentCurves=[],this.groundInfos=[],this.externalObjectManager=new Glodon$1.Bimface.Viewer.ExternalObjectManager(this.viewer),this.previewCurve=null,this.mesh=null});t.Type.inheritPrototype(i,e.MeasureItem);var n={reset:function(){if(this.measurePoints=[],this.measureEnd=!1,this.maxPointsNum=1/0,this._svg){for(var t=this._svg.childNodes,e=t.length-1;e>-1;e--)this._svg.removeChild(t[e]);this._svg.innerHTML=""}this.clearPreview(),this.groundInfos=[],this.currentCurves=[]},redo(){this.clearPreview(),this.measurePoints.length>0&&this.measurePoints.length<this.maxPointsNum?this.measurePoints.pop():this.measurePoints=[];let t=this.groundInfos.pop();if(t){let e=this.groundCurve.get(t.id);if(e){e.groundCurve&&e.groundCurve.dispose();let i=this.externalObjectManager.getObjectIdByName(`${t.id}`);this.externalObjectManager.removeById(i)}}},deleteCurveById(t){if(this.measurePoints=[],this.measureEnd=!1,this.maxPointsNum=1/0,this._svg){for(var e=this._svg.childNodes,i=e.length-1;i>-1;i--)this._svg.removeChild(e[i]);this._svg.innerHTML=""}this.clearPreview();let n=this.groundCurve.get(t);if(n){n.groundCurve&&n.groundCurve.dispose();let e=this.externalObjectManager.getObjectIdByName(`${t}`);this.externalObjectManager.removeById(e)}this.groundInfos=[]},clear:function(){if(this.measurePoints=[],this.measureEnd=!1,this.maxPointsNum=1/0,this._svg){for(var t=this._svg.childNodes,e=t.length-1;e>-1;e--)this._svg.removeChild(t[e]);this._svg.innerHTML=""}this.clearPreview(),this.groundCurve.forEach(((t,e)=>{t.groundCurve&&t.groundCurve.dispose();let i=this.externalObjectManager.getObjectIdByName(`${e}`);this.externalObjectManager.removeById(i)})),this.groundCurve.clear(),this.groundInfos=[]},createGroundCurve(t){if(t){var e=new CLOUD$1.Raycaster,i=new THREE.Vector3,n=this.viewer.getViewer().cameraControl.getIntersectContext(null),o=new CLOUD$1.IntersectHelper(this.viewer.getViewer());e.camera=n.camera,e.viewportSize=n.viewportSize;var s=[];t.getPoints(100).forEach((t=>{i.copy(t),(i=this.viewer.worldToScene(t)).y=1e4,e.set(i,new THREE.Vector3(0,-1,0));let r=o.getObjectsByRaycaster(n,e,!0);if(r.length>0){let t;t=this.viewer.sceneToWorld(r[0].point),s.push(t)}else s.push(t)})),t=null,this.previewCurve=new Glodon$1.Bimface.Plugins.Geometry.SplineCurve(s),this.previewCurve.setWidth(3),this.previewCurve.setColor(new Glodon$1.Web.Graphics.Color(255,157,11,1)),this.previewCurve.projectToGround(!0),this.groundInfos.push({id:"preview",length:this.previewCurve.length,midPoint:this.previewCurve.getPointByParameter(.5),endPoint:this.previewCurve.getPointByParameter(1),status:"finished"}),this.externalObjectManager&&this.externalObjectManager._addObject("preview",this.previewCurve)}},clearPreview(){if(this.previewCurve){for(let t=0;t<this.groundInfos.length;t++)"preview"===this.groundInfos[t].id&&this.groundInfos.splice(t,1);let t=this.externalObjectManager.getObjectIdByName("preview");this.externalObjectManager.removeById(t),this.previewCurve.dispose(),this.previewCurve=null}},savePreview(){if(this.previewCurve){let t=Glodon$1.Web.Lang.Utility.UUID.createUUID();if(this.groundCurve.set(t,this.previewCurve),this.currentCurves.push({id:t,curve:this.previewCurve}),this.groundInfos.push({id:t,length:this.previewCurve.length,midPoint:this.previewCurve.getPointByParameter(.5),endPoint:this.previewCurve.getPointByParameter(1),status:"finished"}),this.externalObjectManager){let e=this.externalObjectManager.getObjectIdByName("preview");this.externalObjectManager.removeById(e),this.externalObjectManager._addObject(`${t}`,this.previewCurve)}}},createPath(t,e,i){let n=new THREE.Vector3(t.x,t.y,t.z),o=new THREE.Vector3(e.x,e.y,e.z);if(n.equals(o))return;let s,r=[];r.push(n),r.push(o),s=new THREE.CatmullRomCurve3(r),s.tension=0,s.type="catmullrom",this.createGroundCurve(s)},addPoint:function(t){if(this.hoverPositionUpdated=!1,!0===this.measureEnd&&this.measurePoints.length!=this.maxPointsNum)return this.maxPointsNum=this.measurePoints.length,void this.clearPreview();if(this.measurePoints.length==this.maxPointsNum)this.reset();else if(this.measurePoints.length>0){let e=this.measurePoints.length,i=this.measurePoints[e-1];if(t.x===i.x&&t.y===i.y&&t.z===i.z)return void this.clearPreview()}this.measurePoints.push(t),this.savePreview(),this.setIsReserverd(!1)},draw:function(t,e){if(this.clearPreview(),this._svg=t.svg,this.drawCaptureItem(t),!this.getIsReserverd())switch(t.clientPoints.length){case 0:break;case 1:this.drawTerminalPoint(t.clientPoints[0]),t.hoverPosition&&this.nextMeasurePoint&&this.createPath(this.measurePoints[this.measurePoints.length-1],this.nextMeasurePoint),this.drawNotations();break;default:for(let e=1;e<t.clientPoints.length;e++)this.drawTerminalPoint(t.clientPoints[e-1]),this.drawTerminalPoint(t.clientPoints[e]);this.createPath(this.measurePoints[this.measurePoints.length-1],this.nextMeasurePoint),this.drawNotations()}},drawNotations(){let t=null,e=0;for(let i=0;i<this.groundInfos.length;i++){let n=this.groundInfos[i],o={x:n.midPoint.x,y:n.midPoint.y,z:n.midPoint.z},s=this.viewer.worldToClient(o);this.viewer.isInViewFrustum(o)&&this.drawNotation([s,s],this.formatDistance(n.length)),e+=n.length,i===this.groundInfos.length-1&&(t=n.endPoint)}if(t){let i={x:t.x,y:t.y,z:t.z},n=this.viewer.worldToClient(i);this.viewer.isInViewFrustum(i)&&this.drawNotation([n,n],`总长度：${this.formatDistance(e)}`,!0)}this.notation.dropShadow(this.filterUrl)},formatDistance(t){let e=this.measureParams.unit,i=t.toString();return i=MeasureResultFormat.formatDistance(i,this.measureParams),i+=MeasureResultFormat.getPostFix(e,!1),i}};i.prototype=Object.assign(i.prototype,n),e.MeasureGroundlineDistanceItem=i}(),function(){var t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Measure"),e=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.Dom"),i=null,n=[],o=null,s=null,r=function(t){this.viewer3D=t.viewer;var i=new Glodon$1.Web.Lang.EventManager,n=e.create("div","bf-measure-conext");this.isOpen=!1,this.context={rootDomElement:n},this._opt=t,this.type=t.measureType,this.getEventManager=function(){return i},this.isEnableSnap=!0,this._p1=new THREE.Vector3,this._p2=new THREE.Vector3};r.prototype={init:function(){var t=this.context,i=this._opt.viewer;i.getDomElement().appendChild(t.rootDomElement);var n=e.createNS("svg","bf-measure-svg"),o=e.createNS("svg","bf-measure-svg"),s=e.create("div","bf-measure-text");t.rootDomElement.innerHTML="",t.rootDomElement.appendChild(n),t.rootDomElement.appendChild(o),this.drawableManager=new MeasureItemManager(o,i,this),this.drawableManager.setEventListener(this.getEventManager()),this._hookEvents(),this.switchOn(),t.svg=n,t.text=s,i.render()},_onViewerRender(){this.isOpen&&this.update()},_onCloudViewerMeasuring(t){this.isOpen&&(this.measureItem.hoverPositionUpdated=!0,this.measureByPoint(t))},_onCloudViewerMeasureReset(t){if(!this.isOpen)return;const e=this.measureItem;this.type==Glodon$1.Bimface.Plugins.Measure.MeasureTypeOption.Position||this.type==Glodon$1.Bimface.Plugins.Measure.MeasureTypeOption.TriangleDistance||this.type==Glodon$1.Bimface.Plugins.Measure.MeasureTypeOption.Angle||e.getPoints().length<e.minPointsNum?(e.reset(),this.getEventManager().fireEvent(Glodon$1.Bimface.Plugins.Measure.MeasureEvent.Reset)):e.getPoints().length!=e.maxPointsNum&&(e.measureEnd=!0,this.measureByPoint(t))},_hookEvents(){const t=this.viewer3D,e=t.getViewer();this._onRenderBinded=this._onViewerRender.bind(this),this._onMeasuringBinded=this._onCloudViewerMeasuring.bind(this),this._onMeasureResetBinded=this._onCloudViewerMeasureReset.bind(this),t.addEventListener(Glodon$1.Bimface.Viewer.Viewer3DEvent.Rendered,this._onRenderBinded),e.registerEventListener(CLOUD$1.EVENTS.ON_MEASURE_PICK,this._onMeasuringBinded),e.registerEventListener(CLOUD$1.EVENTS.ON_MEASURE_RESET,this._onMeasureResetBinded)},_unhookEvents(){const t=this.viewer3D,e=t.getViewer();t.removeEventListener(Glodon$1.Bimface.Viewer.Viewer3DEvent.Rendered,this._onRenderBinded),e.unregisterEventListener(CLOUD$1.EVENTS.ON_MEASURE_PICK,this._onMeasuringBinded),e.unregisterEventListener(CLOUD$1.EVENTS.ON_MEASURE_RESET,this._onMeasureResetBinded)},enableMeasureCursor(){this._opt.viewer.getDomElement().style.cursor=`url(${Cursor.measure}),auto`},disableMeasureCursor(){this._opt.viewer.getDomElement().style.cursor=""},activeByMeasureType:function(){Glodon$1.Web.Lang.Utility.ClientHelper.getIsDesktop()||this.drawableManager.clear(!0),this.enableMeasureCursor();let t,e=this._opt.viewer.getViewer();this.type===Glodon$1.Bimface.Plugins.Measure.MeasureTypeOption.Volume?(e.editorManager.disableTool(CLOUD$1.EditToolMode.PICK_BY_MEASURE),e.editorManager.enableTool(e,CLOUD$1.EditToolMode.VOLUME_MEASURE)):(e.editorManager.disableTool(CLOUD$1.EditToolMode.VOLUME_MEASURE),e.editorManager.enableTool(e,CLOUD$1.EditToolMode.PICK_BY_MEASURE));let i=new Glodon$1.Bimface.Plugins.Measure.MeasureItemConfig;switch(i=Object.assign(i,this._opt,this.getMeasureParams()),this.type){case Glodon$1.Bimface.Plugins.Measure.MeasureTypeOption.Angle:t=new Glodon$1.Bimface.Plugins.Measure.MeasureAngleItem(i);break;case Glodon$1.Bimface.Plugins.Measure.MeasureTypeOption.PolylineDistance:t=new Glodon$1.Bimface.Plugins.Measure.MeasurePolylineDistanceItem(i);break;case Glodon$1.Bimface.Plugins.Measure.MeasureTypeOption.Position:t=new Glodon$1.Bimface.Plugins.Measure.MeasurePositionItem(i);break;case Glodon$1.Bimface.Plugins.Measure.MeasureTypeOption.TriangleDistance:t=new Glodon$1.Bimface.Plugins.Measure.MeasureTriangleDistanceItem(i);break;case Glodon$1.Bimface.Plugins.Measure.MeasureTypeOption.SpatialArea:t=new Glodon$1.Bimface.Plugins.Measure.MeasureSpatialAreaItem(i);break;case Glodon$1.Bimface.Plugins.Measure.MeasureTypeOption.ProjectedArea:t=new Glodon$1.Bimface.Plugins.Measure.MeasureProjectedAreaItem(i);break;case Glodon$1.Bimface.Plugins.Measure.MeasureTypeOption.SurfaceArea:t=new Glodon$1.Bimface.Plugins.Measure.MeasureSurfaceAreaItem(i);break;case Glodon$1.Bimface.Plugins.Measure.MeasureTypeOption.GroundlineDistance:t=new Glodon$1.Bimface.Plugins.Measure.MeasureGroundlineDistanceItem(i);break;case Glodon$1.Bimface.Plugins.Measure.MeasureTypeOption.Volume:t=new Glodon$1.Bimface.Plugins.Measure.MeasureVolumeItem(i)}this.measureItem=t},switchOn:function(){this.isOpen||(this.activeByMeasureType(),this.isOpen=!0,this.drawableManager.setIsEnableSelection(!0))},switchOff:function(){if(this.isOpen){var t=this,e=t._opt.viewer.getViewer();this.disableMeasureCursor(),e.editorManager.disableTool(CLOUD$1.EditToolMode.PICK_BY_MEASURE),e.editorManager.disableTool(CLOUD$1.EditToolMode.VOLUME_MEASURE),t.reset(),t.measureItem=null,this.isOpen=!1,this.drawableManager.setIsEnableSelection(!1)}},measureByPoint:function(t){var e=this,r=Glodon$1.Web.Lang.Utility.ClientHelper.getIsDesktop(),a=e.measureItem;t&&(i=t.pickPoint?t.pickPoint:null,t.pickPlane?(o="Panel",s=t.normal):t.pickLine?(o="Line",n=t.pickLine):o=t.pickPoint?"Point":null,!t.modelId&&(o=null),t.pick&&t.pickPoint?(a.addPoint(t.pickPoint),a.getPoints().length==a.maxPointsNum?(r||this.drawableManager.clear(!0),this.drawableManager.addItem(this.getInfo(!0)),r||this.drawableManager.unselctedAll(),this.measureItem.setIsReserverd(!0),e.getEventManager().fireEvent(Glodon$1.Bimface.Plugins.Measure.MeasureEvent.Measured,e.getInfo(!0)),a.reset()):(r||this.drawableManager.clear(!0),e.getEventManager().fireEvent(Glodon$1.Bimface.Plugins.Measure.MeasureEvent.Measuring,e.getInfo())),e.update()):this.isEnableSnap&&e.update())},reset:function(){this.isOpen&&(this.measureItem.reset(),this.context.svg.innerHTML="",this.getEventManager().fireEvent(Glodon$1.Bimface.Plugins.Measure.MeasureEvent.Reset))},setIsEnableSnap:function(t){t||(this.context.svg.innerHTML=""),this.isEnableSnap=t},update:function(){var t=this.measureItem,e=this.context,r=this._opt.viewer,a=r.getDomElement(),l=a.getBoundingClientRect(),h=r.getViewer(),c=t.getPoints(),d=[],u=[];if(this.context.svg.innerHTML="",i?(e.hoverPosition=r.worldToClient(i),e.hoverPositionDS=h.getScene().worldToDrawing(i),t.nextMeasurePoint=i):e.hoverPosition=t.nextMeasurePoint?r.worldToClient(t.nextMeasurePoint):null,0!=c.length&&(d=c.concat([t.nextMeasurePoint])),e.hoverObjectType=o,"Line"==o&&2==n.length){e.lineStartPoint=r.worldToClient(n[0]),e.lineEndPoint=r.worldToClient(n[1]);var p=new THREE.Vector2(e.lineStartPoint.x,e.lineStartPoint.y),g=new THREE.Vector2(e.lineEndPoint.x,e.lineEndPoint.y),m=new THREE.Box2;m.min.set(a.clientLeft,a.clientTop),m.max.set(m.min.x+a.clientWidth,m.min.y+a.clientHeight);var f=!m.containsPoint(p),w=!m.containsPoint(g),v={start:p,end:g},y=CLOUD$1.CameraUtil.lineIntersectWithRect(v,m);if(f&&w)2==y.length&&(e.lineStartPoint=y[0],e.lineEndPoint=y[1]);else if(f||w)for(var b=new THREE.Vector2(e.hoverPosition.x,e.hoverPosition.y),E=f?g.clone():p.clone(),C=E.clone().sub(b).normalize(),x=0;x<y.length;x++){if(E.clone().sub(y[x]).normalize().dot(C)>0){e.lineStartPoint=E,e.lineEndPoint=y[x];break}}}if("Panel"==e.hoverObjectType){e.normal=h.getScene().worldToDrawing(s),e.normal.normalize();var M=h.cameraControl,P=new THREE.Plane;P.setFromNormalAndCoplanarPoint(e.normal,e.hoverPositionDS);var I=new THREE.Vector2(e.hoverPosition.x-10,e.hoverPosition.y-10),T=new THREE.Vector2(e.hoverPosition.x+10,e.hoverPosition.y-10),D=e.hoverPositionDS,S=M.getRaycaster(I.x,I.y);if(this._p1=S.ray.intersectPlane(P,this._p1),S=M.getRaycaster(T.x,T.y),this._p2=S.ray.intersectPlane(P,this._p2),null==this._p1||null==this._p2)return this._p1=new THREE.Vector3,void(this._p2=new THREE.Vector3);var B=new THREE.Vector3(1,0,0),A=new THREE.Vector3(0,1,0),_=new THREE.Vector3(0,0,1),k=Math.abs(e.normal.clone().dot(B))<=.0025,L=Math.abs(e.normal.clone().dot(_))<=.0025;if(k&&L)var R=B.clone(),G=_.clone();else R=A.clone().cross(e.normal).normalize(),G=e.normal.clone().cross(R).normalize();var N=this._p1.distanceTo(this._p2)/2,V=R.clone().multiplyScalar(N),$=G.clone().multiplyScalar(N),O=D.clone().sub(V).add($),U=D.clone().add(V).add($),H=D.clone().sub(V).sub($),z=D.clone().add(V).sub($),F=[];F.push(O,U,z,H);for(var W=[],j=M.getContainerDimensions(),Z=0;Z<F.length;Z++){var X=CLOUD$1.CameraUtil.drawingToCanvas(M.camera,F[Z],j.width,j.height);W.push(new THREE.Vector3(X.x,X.y,0))}e.clientPts=W}for(x=0;x<d.length-1;x++){var Y=h.worldPointsToClient(d[x],d[x+1]);if(Y){var q={x:Y.start.x-l.left,y:Y.start.y-l.top};u.push(q)}}e.clientPoints=u;let K=this.getInfo(!0,d);t.draw(e,K)},getInfo:function(t,e){var i={},n=this.measureItem,o=this._opt.viewer;e=e||n.getPoints();switch(i.type=this.type,i.id=Glodon$1.Web.Lang.Utility.UUID.createUUID(),i.points=e,this.type){case Glodon$1.Bimface.Plugins.Measure.MeasureTypeOption.Angle:if(3==e.length){var s=new THREE.Vector3(e[0].x-e[1].x,e[0].y-e[1].y,e[0].z-e[1].z),r=new THREE.Vector3(e[2].x-e[1].x,e[2].y-e[1].y,e[2].z-e[1].z),a=s.angleTo(r);i.angle=180*a/Math.PI}break;case Glodon$1.Bimface.Plugins.Measure.MeasureTypeOption.Position:if(1==e.length){i.coordinateSystem="GCJ-02";let t=o.worldToLatLon(e[0]);i.lonLat={longitude:t.lon,latitude:t.lat},i.altitude=e[0].z}break;case Glodon$1.Bimface.Plugins.Measure.MeasureTypeOption.PolylineDistance:if(e&&e.length>=2){let t=e.length;i.distance=[],i.totalDistance=0;for(let n=1;n<t;n++){let t=e[n].distanceTo(e[n-1]);i.distance.push(t),i.totalDistance+=t}}break;case Glodon$1.Bimface.Plugins.Measure.MeasureTypeOption.GroundlineDistance:if(e&&e.length>=2){i.distance=[],i.totalDistance=0,i.positions=[],i.item=n,i.curves=n.currentCurves;for(let t=0;t<n.groundInfos.length;t++){let e=n.groundInfos[t];i.distance.push(e.length),i.totalDistance+=e.length;let o={midPoint:e.midPoint,endPoint:e.endPoint};i.positions.push(o)}}break;case Glodon$1.Bimface.Plugins.Measure.MeasureTypeOption.TriangleDistance:if(2==e.length){i.distance=i.points[0].distanceTo(i.points[1]);let t=e[0].clone(),n=0,o=0;e[0].z<e[1].z?(t.set(e[0].x,e[0].y,e[1].z),n=t.distanceTo(e[1]),o=t.distanceTo(e[0])):e[0].z>e[1].z&&(t.set(e[1].x,e[1].y,e[0].z),n=t.distanceTo(e[0]),o=t.distanceTo(e[1])),Object.assign(i,{horizontalDistance:n,verticalDistance:o})}break;case Glodon$1.Bimface.Plugins.Measure.MeasureTypeOption.SpatialArea:if(e.length>=3&&t){let t=MeasureUtil.calcSpatialArea(e);Object.assign(i,{area:t})}break;case Glodon$1.Bimface.Plugins.Measure.MeasureTypeOption.ProjectedArea:if(e.length>=3&&t){let t=MeasureUtil.calcProjectedArea(e);Object.assign(i,{area:t})}break;case Glodon$1.Bimface.Plugins.Measure.MeasureTypeOption.SurfaceArea:if(e.length>=3&&t){let t=MeasureUtil.calcSurfaceArea(e,o);Object.assign(i,{area:t})}}return i},redo:function(){this.measureItem.redo(),this.update(),this.getEventManager().fireEvent(Glodon$1.Bimface.Plugins.Measure.MeasureEvent.Measuring,this.getInfo())},exit:function(){this.switchOff(),this._unhookEvents()},isMeasureOpen:function(){return this.isOpen},getDefaultUnit:function(){return"m"}},t.MeasureViewerGIS=r}(),function(){var t=Glodon$1.Bimface.Data.StatisticsDataManager.getInstance(),e=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Measure"),i=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.Dom"),n=function(t){var n=t.viewer;if(n){var o=new Glodon$1.Web.Lang.EventManager,s=i.create("div","bf-measure-conext");this.context={rootDomElement:s},this.id="Measure",this._opt=t,this.type=t.measureType,this.getEventManager=function(){return o},"Viewer3D"===n.getViewerType()?(e.MeasureViewer3D.call(this,t),this.inherit(Glodon$1.Bimface.Plugins.Measure.MeasureViewer3D.prototype)):"ViewerGIS"===n.getViewerType()?(e.MeasureViewerGIS.call(this,t),this.inherit(Glodon$1.Bimface.Plugins.Measure.MeasureViewerGIS.prototype)):(e.MeasureDrawing.call(this,t),this.inherit(Glodon$1.Bimface.Plugins.Measure.MeasureDrawing.prototype)),this._setDefaultUnits(t),this._setDefaultPrecisions(t),this.init()}};n.prototype={inherit:function(t){for(var e in t)this[e]=t[e]},addEventListener:function(t,e){this.getEventManager().addEvent(t,e)},removeEventListener:function(t,e){this.getEventManager().removeEvent(t,e)},_setDefaultUnits:function(t){const e=t.viewer.getViewerType();if(null!=t.lengthUnits&&null==t.units){switch(e){case"Viewer3D":t.units={distance:t.lengthUnits,elevation:t.lengthUnits};break;case"ViewerGIS":t.units={distance:t.lengthUnits,elevation:t.lengthUnits,area:t.lengthUnits};break;case"ViewerDrawing":t.units={distance:t.lengthUnits,area:t.lengthUnits}}return}const i=this.getDefaultUnit();"m"===i?t.lengthUnits=Glodon$1.Bimface.Common.Units.LengthUnits.Meter:"mm"===i&&(t.lengthUnits=Glodon$1.Bimface.Common.Units.LengthUnits.Millimeter);const n=t.units&&t.units.distance||t.lengthUnits||Glodon$1.Bimface.Common.Units.LengthUnits.Millimeter,o=t.units&&t.units.distance||t.lengthUnits||Glodon$1.Bimface.Common.Units.LengthUnits.None,s=t.units&&t.units.elevation||Glodon$1.Bimface.Common.Units.LengthUnits.Meter,r=t.units&&t.units.area||Glodon$1.Bimface.Common.Units.LengthUnits.Meter,a=t.units&&t.units.area||Glodon$1.Bimface.Common.Units.LengthUnits.None;switch(e){case"Viewer3D":t.units={distance:n,elevation:s};break;case"ViewerGIS":t.units={distance:n,elevation:s,area:r};break;case"ViewerDrawing":t.units={distance:o,area:a}}},_setDefaultPrecisions:function(t){if("number"==typeof t.precision)t.obsoletePrecision=t.precision,t.precision={distance:t.obsoletePrecision,elevation:t.obsoletePrecision,area:t.obsoletePrecision,angle:t.obsoletePrecision,latLon:t.obsoletePrecision};else{let{distance:e=3,elevation:i=3,area:n=3,angle:o=2,latLon:s=9}=t.precision;t.precision={distance:e,elevation:i,area:n,angle:o,latLon:s}}},getMeasureType:function(){return this.type},setMeasureType:function(e){t.send("Bimface.Plugins.Measure.Measure","setMeasureType"),this.hideDragButton&&this.hideDragButton(),this.type=e,this.reset(),this.activeByMeasureType(),this.getEventManager().fireEvent("typeChange",e)},setPrecision:function(t){"number"==typeof t||"string"==typeof t?(this._opt.obsoletePrecision=t,this._opt.precision={distance:t,elevation:t,area:t,angle:t,latLon:t}):this._opt.precision=Object.assign(this._opt.precision,t),this.getEventManager().fireEvent("MeasureParamsUpdated")},getPrecision:function(){return void 0!==this._opt.obsoletePrecision?this._opt.obsoletePrecision:this._opt.precision},setScale:function(t){this._opt.scale=t,this.getEventManager().fireEvent("MeasureParamsUpdated")},getScale:function(){return this._opt.scale},setLengthUnits:function(t){this._opt.lengthUnits=t;for(const e in this._opt.units)this._opt.units[e]=t;this.getEventManager().fireEvent("MeasureParamsUpdated")},getLengthUnits:function(){return this._opt.lengthUnits},setUnits:function(t){this._opt.units=Object.assign(this._opt.units,t),this.getEventManager().fireEvent("MeasureParamsUpdated")},getUnits:function(){return this._opt.units},getAllItems:function(){return this.drawableManager.save()},setItems:function(t){this.clear(),this.drawableManager.load(t)},clear:function(){this.drawableManager.clear(!0),this.hideDragButton&&this.hideDragButton()},hideAllItems:function(){this.drawableManager.hideAll()},showAllItems:function(){this.drawableManager.showAll()},onClick:function(t){this.drawableManager.onClick(t)},removeSelectedItem:function(){this.drawableManager.unselctedAll()},getSelectedItem:function(){return this.drawableManager.getSelectedItem()},getMeasureParams:function(t){let e={scale:this.getScale(),defaultUnit:this.getDefaultUnit()};switch(t||this.type){case Glodon$1.Bimface.Plugins.Measure.MeasureTypeOption.Angle:e=Object.assign(e,{precision:this._opt.precision.angle,unit:"°"});break;case Glodon$1.Bimface.Plugins.Measure.MeasureTypeOption.Elevation:e=Object.assign(e,{precision:this._opt.precision.elevation,unit:this.getUnits().elevation});break;case Glodon$1.Bimface.Plugins.Measure.MeasureTypeOption.Area:case Glodon$1.Bimface.Plugins.Measure.MeasureTypeOption.SpatialArea:case Glodon$1.Bimface.Plugins.Measure.MeasureTypeOption.ProjectedArea:case Glodon$1.Bimface.Plugins.Measure.MeasureTypeOption.SurfaceArea:e=Object.assign(e,{precision:this._opt.precision.area,unit:this.getUnits().area});break;case Glodon$1.Bimface.Plugins.Measure.MeasureTypeOption.Position:e=Object.assign(e,{precision:{elevation:this._opt.precision.elevation,latLon:this._opt.precision.latLon},unit:this.getUnits().elevation});break;default:e=Object.assign(e,{precision:this._opt.precision.distance,unit:this.getUnits().distance})}return e}},e.Measure=n}(),Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Measure").MeasureRayConfig=function(){return{viewer:null,targetsHintColor:new Glodon$1.Web.Graphics.Color(245,127,35,.6)}},Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Measure").MeasureRayItemConfig=function(){return{id:null,color:new Glodon$1.Web.Graphics.Color(245,127,35,1),width:2,startPoint:new Glodon$1.Web.Geometry.Point3d(0,0,0),endPoint:new Glodon$1.Web.Geometry.Point3d(0,0,0),startObjectId:null,endObjectId:null}},function(){let t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Measure"),e=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.Dom"),i=function(t){this.id=t.id||Glodon$1.Web.Lang.Utility.UUID.createUUID();this.startPoint=t.startPoint,this.endPoint=t.endPoint;this.startComponentId=t.startComponentId,this.endComponentId=t.endComponentId;var i=e.createNS("defs","bf-defs");i.innerHTML=`\n      <marker id="end" markerWidth="6" markerHeight="6" refx="5" refy="3" orient="auto" markerUnits="strokeWidth">\n        <path d="M0,0 L0,6 L6,3 z" fill="${t.color.getRGBA()}" />\n      </marker>`;var n=e.create("i","bf-measure-handle");n.style.width=12*t.width+"px",n.style.height=12*t.width+"px",n.style.backgroundColor=t.color.getRGBA(),n.style.lineHeight=12*t.width+"px";var o=e.createNS("line","bf-measure-line");o.style.stroke=t.color.getRGBA(),o.setAttribute("stroke-width",t.width);var s=e.create("span","bf-measure-number");s.style.backgroundColor=t.color.getRGBA(),this.domElement=i,this.line=o,this.circle=n,this.text=s};i.prototype={draw:function(t){var e=this.domElement,i=this.line,n=this.circle,o=this.text,s=Math.abs(t.endPoint.x-t.startPoint.x),r=Math.abs(t.endPoint.y-t.startPoint.y),a=Math.abs(t.endPoint.z-t.startPoint.z),l=Math.sqrt(Math.pow(s,2)+Math.pow(r,2)+Math.pow(a,2));i.setAttribute("x1",t.startPoint.x),i.setAttribute("y1",t.startPoint.y),i.setAttribute("x2",t.endPoint.x),i.setAttribute("y2",t.endPoint.y),n.style.left=`${t.startPoint.x}px`,n.style.top=`${t.startPoint.y}px`,t.isMove&&(n.style.border="2px solid #fff"),l<15?i.removeAttribute("marker-end"):i.setAttribute("marker-end","url(#end)"),o.innerText=t.distance,t.svg.appendChild(e),t.svg.appendChild(i),t.text.appendChild(n),0==t.distance?n.innerText="0":(o.style.left=(t.startPoint.x+t.endPoint.x)/2+"px",o.style.top=(t.startPoint.y+t.endPoint.y)/2+"px",o.style.transform="translate(-50%, 0)",o.style.marginTop="2px",t.text.appendChild(o))}},t.MeasureRayItem=i}(),function(){var t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Measure");let e=Object.freeze({Measured:"Measured",Clear:"Clear"});t.MeasureRayEvent=e}(),function(){var t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Measure"),e=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.Dom"),i=function(t){var i=t.viewer;if(i)if("Viewer3D"===i.viewerType){var n=this,o=new Glodon$1.Web.Lang.EventManager,s=e.create("div","bf-measure-conext");i.addEventListener("Rendered",(function(){n.measureItem&&n.update()})),this.context={rootDomElement:s},this._opt=t,this._enableMove=!1,this._events={mousedown:function(){this._startTime=(new Date).getTime()},mouseup:function(t){if(0==t.button||1==t.button)if(n._enableMove)n._enableMove=!1,n.measureByPoint(t);else{var e=this._startTime;(new Date).getTime()-e<300&&n.measureByPoint(t)}},mousemove:function(t){n._enableMove&&(t.stopPropagation(),n.measureByPoint(t))}},this.getEventManager=function(){return o}}else console.log("Viewer2D is not supported.")};i.prototype={addEventListener:function(t,e){this.getEventManager().addEvent(t,e)},removeEventListener:function(t,e){this.getEventManager().removeEvent(t,e)},switchOn:function(t){var i=this.context,n=this;n._opt.viewer.getDomElement().appendChild(i.rootDomElement),t&&(n._callback=t),n._opt.viewer.getModels().forEach((t=>{t.setSelectedComponentsById()}));var o=e.createNS("svg","bf-measure-svg"),s=e.create("div","bf-measure-text");i.rootDomElement.appendChild(o),i.rootDomElement.appendChild(s),i.svg=o,i.text=s,i.rootDomElement.addEventListener("mousedown",n._events.mousedown),i.rootDomElement.addEventListener("mouseup",n._events.mouseup),i.rootDomElement.addEventListener("mousemove",n._events.mousemove)},switchOff:function(){var t=this.context.rootDomElement,e=this,i=e._opt.viewer;e.measureItem&&(i.restoreComponentsColorById([e.measureItem.startComponentId,e.measureItem.endComponentId]),i.render()),t.removeEventListener("mousedown",e._events.mousedown),t.removeEventListener("mouseup",e._events.mouseup),t.removeEventListener("mousemove",e._events.mousemove),t.innerHTML="",t.remove(),e.measureItem=null},reset:function(){this.clear()},clear:function(){var t=this.context,e=this,i=e._opt.viewer;e.measureItem&&(i.restoreComponentsColorById([e.measureItem.startComponentId,e.measureItem.endComponentId]),i.render()),t.svg.innerHTML="",t.text.innerHTML="",e.measureItem=null,e.getEventManager().fireEvent(Glodon$1.Bimface.Plugins.Measure.MeasureRayEvent.Clear,data)},measureByPoint:function(t){var e=this,i=e._opt.viewer,n=i.getViewer().pickByPointWithNormal(t);if(n){e.measureItem&&i.restoreComponentsColorById([e.measureItem.startComponentId,e.measureItem.endComponentId]);Glodon$1.Bimface.Viewer.Viewer3DEvent;var o=e._getContextData(n),s=new Glodon$1.Bimface.Plugins.Measure.MeasureRayItemConfig;s.startComponentId=o.startComponentId,s.endComponentId=o.endComponentId,s.startPoint=o.startPoint,s.endPoint=o.endPoint;var r=new Glodon$1.Bimface.Plugins.Measure.MeasureRayItem(s);r.circle.addEventListener("mousedown",(function(t){2!=t.button&&(e._enableMove=!0)})),e.context.distance=o.distance,i.overrideComponentsColorById([o.startComponentId,o.endComponentId],e._opt.targetsHintColor),setTimeout((function(){e.update(),i.render()}),100),e.measureItem=r,e.getEventManager().fireEvent(Glodon$1.Bimface.Plugins.Measure.MeasureRayEvent.Measured,o)}},update:function(){var t=this.measureItem,e=this.context,i=this._opt.viewer;e.svg.innerHTML="",e.text.innerHTML="",e.isMove=this._enableMove;var n=i.worldToClient(t.startPoint),o=i.worldToClient(t.endPoint);n&&o&&(e.startPoint=new Glodon$1.Web.Geometry.Point3d(n.x,n.y,n.z),e.endPoint=new Glodon$1.Web.Geometry.Point3d(o.x,o.y,o.z),t.draw(e))},exit:function(){this.switchOff()},_getContextData:function(t){var e,i,n={};return e=i=t[0],t.length>1&&(i=t[1]),n.startComponentId=e.userId,n.startPoint=e.worldPosition,n.endComponentId=i.userId,n.endPoint=i.worldPosition,n.distanceX=Math.round(Math.abs(n.endPoint.x-n.startPoint.x)),n.distanceY=Math.round(Math.abs(n.endPoint.y-n.startPoint.y)),n.distanceZ=Math.round(Math.abs(n.endPoint.z-n.startPoint.z)),n.distance=Math.round(Math.sqrt(Math.pow(n.distanceX,2)+Math.pow(n.distanceY,2)+Math.pow(n.distanceZ,2))),n}},t.MeasureRay=i}(),Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Marker3D").Marker3DContainerConfig=function(){return{viewer:null,type:null,layerId:null}},Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Marker3D").Marker3DConfig=function(){return{id:null,objectId:null,size:30,tooltip:"",tooltipStyle:{color:"#333",fontSize:"14px",borderWidth:"1px",borderColor:"#666",borderStyle:"solid",backgroundColor:"#fff"},src:null,canvas:null,worldPosition:new Glodon$1.Web.Geometry.Point3d(0,0,0),modelId:void 0,layerId:void 0,hoverAnimation:!0}},function(){var t="Bimface.Plugins.Marker3D.Marker3D",e=Glodon$1.Bimface.Data.StatisticsDataManager.getInstance();let i=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Marker3D"),n=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.Dom"),o=function(t){var e=this;this.id=t.id||Glodon$1.Web.Lang.Utility.UUID.createUUID(),this.layerId=t.layerId,this.modelId=t.modelId,this.objectId=t.objectId,this.size=t.size,this.iconUrl=t.canvas?t.canvas.toDataURL():t.src,this.position=t.worldPosition,this.hoverAnimation=t.hoverAnimation,this.originalPosition=new THREE.Vector3(this.position.x,this.position.y,this.position.z),this.explosionOffset=new THREE.Vector3,this.tooltip=t.tooltip,this.tooltipElement=n.create("div","bf-tooltip"),this.tooltipElement.innerHTML=t.tooltip,this.tooltipElement.setCss(t.tooltipStyle),this.isHideByClustering=!1,this._tooltipCallback=function(t,i,n){var o=e.tooltipElement;n.appendChild(o);var s=o.offsetWidth,r=o.offsetHeight;o.style.left=i.x-s/2+"px",o.style.top=i.y-r-e.size+"px",e._hoverCallback&&e._hoverCallback(t)},this._config=t,this.scratchVector=new THREE.Vector3,this.scratchVector_2=new THREE.Vector3};o.prototype={getId:function(){return this.id},getWorldPosition:function(){return this.position},setWorldPosition:function(i){e.send(t,"setWorldPosition"),this.originalPosition=this.position=i,this.update()},getSize:function(){return this.size},setSize:function(i){e.send(t,"setSize"),this.size=i,this.update()},getSrc:function(){return this.iconUrl},setSrc:function(i){e.send(t,"setSrc"),this.iconUrl=i,this.update()},getTooltip:function(){return this.tooltip},setTooltip:function(i){e.send(t,"setTooltip"),this.tooltip=i,this.tooltipElement.innerHTML=i},onClick:function(i){e.send(t,"onClick"),i&&(this._clickCallback=i)},onHover:function(i){e.send(t,"onHover"),i&&(this._hoverCallback=i)},onDoubleClick:function(i){e.send(t,"onDoubleClick"),i&&(this._doubleClickCallback=i)},onRightClick:function(i){e.send(t,"onRightClick"),i&&(this._rightClickCallback=i)},update:function(){e.send(t,"update"),this.container&&this.container.update()},isHideByClustering:function(){return this.isHideByClustering},hideByClustering:function(t){this.isHideByClustering=!!t},attachExplosionOffset:function(t,e){if(!this.getWorldPosition())return;let i=this._config.objectId;if(i){let n={};n[i]=!0;let o=t.modelManager.getBoundingBoxByIds(n),s=this.assoiatedComponentBbox,r=o;if(s){let t=r.getCenter(this.scratchVector).clone();t.sub(s.getCenter(this.scratchVector_2).clone()),this.explosionOffset=t,this.explosionExtent>0&&0===e&&(this.originalPosition.x+=this.explosionDirection*t.x,this.originalPosition.y+=this.explosionDirection*t.y,this.originalPosition.z+=this.explosionDirection*t.z,this.explosionExtent=0,this.explosionOffset=new THREE.Vector3,this.assoiatedComponentBbox=r.clone())}}else{let i=t.getScene().getOriginalBoundingBoxWorld().getCenter(this.scratchVector),n=(new THREE.Box3).expandByPoint(this.getWorldPosition()),o=CLOUD.Utils.computeExplodeTranslation(i,n,e);this.explosionOffset=o}},updatePosition:function(){this.position.x=this.originalPosition.x+this.explosionOffset.x,this.position.y=this.originalPosition.y+this.explosionOffset.y,this.position.z=this.originalPosition.z+this.explosionOffset.z},getOriginalPosition:function(){return this.originalPosition},setInitialExplosionInfo:function(t){if("Viewer3D"!==t.getViewerType()&&"ViewerGIS"!==t.getViewerType())return;let e=null;"Viewer3D"===t.getViewerType()?e=this.modelId?t.getModel(this.modelId):t.getDefaultModel():"ViewerGIS"===t.getViewerType()&&(e=t.getLayerManager().getLayer(this.layerId)),this.explosionExtent=null===e?e.getExplosionExtent():0;let i=this._config.objectId;if(i){let e=t.getViewer(),n={};n[i]=!0;let o=e.modelManager.getBoundingBoxByIds(n);o.isEmpty()?(this._config.objectId=null,console.log("Cannot find component with Id "+i)):this.assoiatedComponentBbox=o.clone()}},getCurrentPosition:function(){return this.position},getHoverAnimation:function(){return this.hoverAnimation},setHoverAnimation:function(t){null!=t&&(this.hoverAnimation=t,this.update())},setContainerVisible:function(t){this.hideByClustering(!t),this.update()},getOpacity:function(){return 1},setOpacity:function(t){},resetClientPosition:function(t){this.setWorldPosition(t)}},i.Marker3D=o}(),function(){var t="Bimface.Plugins.Marker3D.Marker3DContainer",e=Glodon$1.Bimface.Data.StatisticsDataManager.getInstance();let i=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Marker3D");Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.Dom");i.Marker3DContainer=class{constructor(t){Glodon$1.Web.Lang.Utility.ClientHelper.getIsDesktop();if(!t.viewer)return void console.log("viewer must not be empty.");this.isMarker3DContainer=!0;const e="Viewer3D"===t.viewer.viewerType,i=Glodon$1.Bimface.Viewer.ViewerGIS&&t.viewer instanceof Glodon$1.Bimface.Viewer.ViewerGIS;var n=t.viewer.getDomElement(),o=t.viewer.getViewer();if(!e&&!i)return void console.log("Viewer2D is not supported.");if("ViewerGIS"===t.viewer.getViewerType()&&"ShpPoint"===t.type)this._helper=new CLOUD$1.ShpPointMarker(o,t.layerId);else{if(t.viewer.marker3DContainer)return t.viewer.marker3DContainer;t.viewer.marker3DContainer=this,this._helper=new CLOUD$1.Marker3D(o,!0)}var s=this;this._viewer=t.viewer,this._items=[],this._areaData={},this.loadAreas=void 0,this.getLevelCallback=[],this.boxMap={},this.hoverListenerAdded=!1,this._isViewerGIS=i,this._pick=t=>{if(!t.doubleClick&&2!==t.event.button){var e=t.intersectInfo;if(e&&e.objectType===CLOUD$1.PICKABLETYPE.Marker3d){var i=this.getItemById(e.selectedObjectId);i._clickCallback&&i._clickCallback(i)}}},this._doublePick=t=>{if(t.doubleClick){var e=t.intersectInfo;if(e&&e.objectType===CLOUD$1.PICKABLETYPE.Marker3d){var i=this.getItemById(e.selectedObjectId);i._doubleClickCallback&&i._doubleClickCallback(i)}}},this._rightPick=t=>{if(2==t.event.button){var e=t.intersectInfo;if(e&&e.objectType===CLOUD$1.PICKABLETYPE.Marker3d){var i=this.getItemById(e.selectedObjectId);i._rightClickCallback&&i._rightClickCallback(i)}}},this._hover=t=>{var e=this;e.tooltipElement&&n.contains(e.tooltipElement)&&(n.removeChild(e.tooltipElement),e.tooltipElement=null);var i=t.intersectInfo;if(i&&i.objectType===CLOUD$1.PICKABLETYPE.Marker3d){var o=e.getItemById(i.selectedObjectId);e.tooltipElement=o.tooltipElement,o._tooltipCallback&&""!=e.tooltipElement.innerHTML&&o._tooltipCallback(o,t.canvasPos,n)}},o.registerEventListener(CLOUD$1.EVENTS.ON_CLICK_MARKER3D_PICK,s._pick),o.registerEventListener(CLOUD$1.EVENTS.ON_CLICK_MARKER3D_PICK,s._rightPick),o.registerEventListener(CLOUD$1.EVENTS.ON_CLICK_MARKER3D_PICK,s._doublePick),e?(this.calculateViewer3dExplosionOffset=e=>{const i=e.modelId,n=e.floorInfos.length,o=t.viewer.getDefaultModel().modelId.toString(),r=t.viewer.getModel(i).getFloorExplosionExtent(),a=t.viewer.getModel(i).getFloorExplosionDirection();if(0===r)for(const e of s.getAllItems())e.setInitialExplosionInfo(t.viewer);let l=[];s.floorInfos=e;var h=function(){let t=s._items;for(let e=0,n=t.length;e<n;e++){let n=t[e].getWorldPosition();if(n)if(!0!==t[e]._isBindRoom)if(t[e].levelName){let i=l.getObjectByAttribute("floorName",t[e].levelName);i&&(t[e].explosionOffset={x:a.x*i.explodedOffset,y:a.y*i.explodedOffset,z:a.z*i.explodedOffset})}else if(i!==o)t[e].explosionOffset={x:t[e].explosionOffset.x,y:t[e].explosionOffset.y,z:t[e].explosionOffset.z};else{let i=!0;for(let o=0;o<l.length;o++){const s=l[o];if(s.box.min<n.z&&s.box.max>n.z){t[e].explosionOffset={x:a.x*s.explodedOffset,y:a.y*s.explodedOffset,z:a.z*s.explodedOffset},t[e].levelName=s.floorName,i=!1;break}}i&&(t[e].explosionOffset={x:0,y:0,z:0})}else{const i=s._viewer.getViewer().modelManager.modelCollection.getById("ExtrudeBodyManager").getNode(t[e]._config.objectId),n=i.explodedHeight,o=i.explodedDirection;t[e].explosionOffset={x:o.x*n,y:o.y*n,z:o.z*n}}}};if(n)for(var c=0;c<n;c++){let t=e.floorInfos[c],i=e.floorInfos[c+1],o=e.floorInfos[c-1];l.push({box:{min:o?t.boundingBox.min.z:-1/0,max:i?i.boundingBox.min.z:1/0},floorName:t.name,explodedOffset:t.explodedHeight-t.elevation}),l.length==n&&(h(),s.boxs=l)}s.update()},t.viewer.addEventListener(Glodon$1.Bimface.Viewer.Viewer3DEvent.FloorExplosion,(t=>{this.calculateViewer3dExplosionOffset(t)}))):i&&(this.calculateViewerGISExplosionOffset=e=>{const i=t.viewer,n=i.getViewer(),o=e.modelId,r=e.floorInfos.length,a=n.getFloorExplosionExtent(o),l=n.getFloorExplosionDirection(o);if(0===a)for(const t of s.getAllItems())t.setInitialExplosionInfo(i);const h=e.floorInfos;let c=[];for(var d=0;d<r;d++){let t=h[d],e=h[d+1],i=h[d-1];if(c.push({box:{min:i?t.boundingBox.min.z:-1/0,max:e?e.boundingBox.min.z:1/0},floorName:t.name,explodedOffset:t.explodedHeight-t.elevation}),c.length==r){this.boxMap[o]=c;break}}const u=i.getLayerManager();let p=this._items;for(let t=0,e=p.length;t<e;t++){if(!p[t].getWorldPosition())continue;const e=u.getLayer(p[t].layerId);if(!e||!e.modelId)continue;if(e.modelId.toString()!==o||!p[t].levelName)continue;let i=c.getObjectByAttribute("floorName",p[t].levelName);i&&(p[t].explosionOffset={x:l.x*i.explodedOffset,y:l.y*i.explodedOffset,z:l.z*i.explodedOffset})}this.update()},t.viewer.addEventListener(Glodon$1.Bimface.Viewer.ViewerGISEvent.FloorExplosion,(t=>{this.calculateViewerGISExplosionOffset(t)})));let r=t.viewer.getViewer();r.registerEventListener(CLOUD$1.EVENTS.ON_EXPLOSION,(t=>{let e=this.getAllItems();for(const i of e)ExplosionHelper.attachExplosionOffset(r,t.extent,i);this.update()}))}addItem(i){e.send(t,"addItem"),i.container=this;let n=ExplosionHelper.ifExploded(this._viewer,i,this._isViewerGIS);n&&(n.setInitialExplosionInfo(this._viewer),this._items.push(n),this.update()),this.addTipsHoverListener()}addTipsHoverListener(){if(!this.hoverListenerAdded){const e=Glodon$1.Web.Lang.Utility.ClientHelper.getIsDesktop();var t=this._viewer.getViewer();e&&t.registerEventListener(CLOUD$1.EVENTS.ON_HOVER_PICK,this._hover),this.hoverListenerAdded=e}}getLevelNameById(t,e){if(!this._spatialRelation){let t=new Glodon$1.Bimface.Plugins.SpatialRelation.RoomConfig;t.viewer=this._viewer;let e=new Glodon$1.Bimface.Plugins.SpatialRelation.Room(t);this._spatialRelation=e}let i=this._spatialRelation.getBoundaryByRoomId(t);if(i){if(this._levelsInfo)return levelName=function(t,e){let i=t[0][2];for(let t=0;t<e.length;t++)if(Math.abs(i-e[t].elevation)<5)return e[t].name;return!1}(i,this._levelsInfo),levelName;this._viewer.getDefaultModel().getMapInfo((t=>{this._levelsInfo=t.axisGrid.Levels,this.addItem(e)}))}}addItems(i){e.send(t,"addItems");for(const t of i){let e=ExplosionHelper.ifExploded(this._viewer,t,this._isViewerGIS);e&&this._items.push(e),t.setInitialExplosionInfo(this._viewer)}this.update(),this.addTipsHoverListener()}removeItemById(i){e.send(t,"removeItemById"),this._items.removeObjectByAttribute("id",i),this.update()}getItemById(t){return this._items.getObjectByAttribute("id",t)}getAllItems(){return[...this._items]}clear(){e.send(t,"clear");var i=this._viewer.getViewer();let n=Glodon$1.Web.Lang.Utility.ClientHelper.getIsDesktop();i.unregisterEventListener(CLOUD$1.EVENTS.ON_CLICK_PICK,this._pick),n&&i.unregisterEventListener(CLOUD$1.EVENTS.ON_HOVER_PICK,this._hover),this.hoverListenerAdded=!1,this._items=[],this.update()}update(){this._helper.clear();let t=this._items.slice();for(let e=0,i=t.length;e<i;e++){t[e].getWorldPosition()&&t[e].updatePosition()}let e=[];for(let i=0,n=t.length;i<n;i++)!1===t[i].isHideByClustering&&e.push(t[i]);this._helper.add(e),this._helper.update(),this._viewer.render()}hideItemsById(i){e.send(t,"hideItemsById"),this._helper.hideByIds(i),this._viewer.render()}hideAllItems(){e.send(t,"hideAllItems"),this._helper.hide(),this._viewer.render()}showItemsById(i){e.send(t,"showItemsById"),this._helper.showByIds(i),this._viewer.render()}showAllItems(){e.send(t,"showAllItems"),this._helper.show(),this._viewer.render()}}}(),function(){let t=Object.freeze({Forward:"Forward",Reverse:"Reverse"});Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Section").SectionBoxDirection=t}(),Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Section").SectionBoxConfig=function(){return{viewer:null,direction:Glodon$1.Bimface.Plugins.Section.SectionBoxDirection.Forward,isHatchEnabled:!0,hatchByMaterial:!1}},function(){let t=Object.freeze({SectionBoxUpdate:"SectionBoxUpdate",SectionBoxChanged:"SectionBoxChanged"});Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Section").SectionBoxEvent=t}(),function(){var t,e,i="Bimface.Plugins.Section.SectionBox",n=Glodon$1.Bimface.Data.StatisticsDataManager.getInstance(),o=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Section"),s=(Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.Dom"),function(i){var n=this,s=i.viewer;if(!s)return void console.log("domElement must not be empty.");const r="Viewer3D"===s.viewerType,a=s instanceof Glodon$1.Bimface.Viewer.ViewerGIS;if(r||a){if(s._sectionPlane&&(s._sectionPlane.hidePlane(),s._sectionPlane.exit()),n.enableHatch(i.isHatchEnabled),i.hatchByMaterial&&s.getViewer().getClipCapsManager().enableHatchByMaterial(i.hatchByMaterial,!0),t&&s==e)return t.id=i.id,t.reset(),t;if(t=this,e=s,s._sectionBox)return s._sectionBox.showBox(),s._sectionBox;s._sectionBox=this,this.sectionBoxEvent=o.SectionBoxEvent,this.eventManager=s.getEventManager(),n.id=i.id||"SectionBox",n._opt=i,n._viewer=s,n.boxState=!0,n._boxDirection=i.direction,n.init()}else console.log("Viewer2D is not supported.")});s.prototype={hookEvens:function(){var t=this._viewer.getViewer(),e=this._viewer.getDomElement();t.registerEventListener(CLOUD$1.EVENTS.ON_CLIP_HOVER,(function(t){t.onClipBox?e.style.cursor=`url(${Cursor.section}),auto`:e.style.removeProperty("cursor")}));var i=this;t.registerEventListener(CLOUD$1.EVENTS.ON_CLIP_MOUSE_MOVE,(function(t){i.eventManager.fireEvent(i.sectionBoxEvent.SectionBoxChanged)}))},init:function(){n.send(i,"init");var t=this._opt.viewer.getViewer(),e=this;t.editorManager.enableTool(t,CLOUD$1.EditToolMode.CLIP_BY_BOX),this._sectionBox=new CLOUD$1.ClipPlaneService(t),CLOUD$1.ClipPlaneManager.getInstance(t.getScene()).observer=function(){e.eventManager.fireEvent(e.sectionBoxEvent.SectionBoxUpdate,e)},this._sectionBox.reset(),this._sectionBox.toggle(!0,!0),this._sectionBox.setVisible(!0),"Reverse"===e._boxDirection?this._sectionBox.changeDirection(!0):this._sectionBox.changeDirection(!1),this.hookEvens()},addEventListener:function(t,e){this.eventManager.addEvent(t,e)},removeEventListener:function(t,e){this.eventManager.removeEvent(t,e)},setBox:function(t){n.send(i,"setBox"),this._sectionBox.getEditor().calculateOffsetByBox(t.min,t.max),CLOUD$1.GlobalData.ClippingCapsType==CLOUD$1.EnumClippingCapsTypes.ClipBox&&this._sectionBox&&this._sectionBox.getEditor().clipPlanes.reCalculateClippingIds()},getBox:function(){},hideBox:function(){n.send(i,"hideBox"),this._sectionBox&&this._sectionBox.setVisible(!1),this._viewer.render()},showBox:function(){n.send(i,"showBox"),this._sectionBox&&this._sectionBox.setVisible(!0),this._viewer.render()},setProgress:function(t,e){var i={x:["Left","Right"],y:["Back","Front"],z:["Bottom","Top"]};e&&(this._sectionBox.setProcess(i[t][0],e[0]/100),2==e.length&&this._sectionBox.setProcess(i[t][1],1-e[1]/100))},getProgress:function(t){var e=[],i={x:["Left","Right"],y:["Back","Front"],z:["Bottom","Top"]};return e.push(100*this._sectionBox.getProcess(i[t][0])),e.push(100-100*this._sectionBox.getProcess(i[t][1])),e},reset:function(){n.send(i,"reset"),this._sectionBox&&this._sectionBox.toggle(!0,!0),this._sectionBox&&this._sectionBox.reset("Rotate"),this.showBox()},enable:function(t){n.send(i,"enable");var e=this._opt.viewer.getViewer().getScene();CLOUD$1.ClipPlaneManager.getInstance(e).enable(t,t)},fitToModel:function(){n.send(i,"fitToModel"),this.reset();var t=this._sectionBox.recalculate().clone();t.isEmpty()&&t.expandByPoint(new THREE.Vector3),this.setBox(t),this._sectionBox.getEditor()._isVisible()&&this.showBox(),this.eventManager.fireEvent(this.sectionBoxEvent.SectionBoxChanged)},isIncluded:function(t){var e=this._opt.viewer,i=e.getViewer().getScene(),n=CLOUD$1.ClipPlaneManager.getInstance(i).getClipBoundingBox(),o=e.worldToScene(t);return n.containsPoint(o)},exit:function(){n.send(i,"exit");var e=this._opt.viewer.getViewer(),o=this._viewer.getDomElement();this.clearFilter(),this.reset(),e.editorManager.disableTool(CLOUD$1.EditToolMode.CLIP_BY_BOX),e.getClipCapsManager().resetClippingCapsStatus(),o.style.removeProperty("cursor"),this._sectionBox=null,this._opt.viewer._sectionBox=null,t=null,this.eventManager.fireEvent(this.sectionBoxEvent.SectionBoxUpdate,null),e.unregisterEventListener(CLOUD$1.EVENTS.ON_CLIP_HOVER,(function(t){t.onClipBox?o.style.cursor=`url(${Cursor.section}),auto`:o.style.removeProperty("cursor")}))},lockBox:function(t){this._opt.viewer.getViewer().editorManager.getToolByName("clipByBox").lockBoxFaces(t)},unlockBox:function(){this._opt.viewer.getViewer().editorManager.getToolByName("clipByBox").unlockBox()},getState:function(){var t=this._opt.viewer,e=this._sectionBox.saveState(),i=e.boundingBox;return i.min=t.sceneToWorld(i.min),i.max=t.sceneToWorld(i.max),e},setState:function(t){this._sectionBox.loadState(t)},restore:function(){var t=this._sectionBox.getEditor()._isVisible();this._sectionBox.toggle(!0,t),this._sectionBox.reset("Rotate")},getSectionBox:function(){n.send(i,"getSectionBox");var t=this._opt.viewer,e=this._sectionBox.saveState().boundingBox,o=t.getViewer().getScene().getMatrixGlobal();return o.invert(),e.applyMatrix4(o),e},setSectionBox:function(t){n.send(i,"setSectionBox");var e=this._opt.viewer,o=e.getViewer().getScene(),s=CLOUD$1.ClipPlaneManager.getInstance(o),r=(o=e.getViewer().getScene()).getMatrixGlobal(),a=new THREE.Box3(new THREE.Vector3(t.min.x,t.min.y,t.min.z),new THREE.Vector3(t.max.x,t.max.y,t.max.z));a.isEmpty()?console.warn("The x,y,z of box.min must be smaller than box.max"):(a.applyMatrix4(r),s.setSectionBox(a.min,a.max))},update:function(){this._sectionBox.update()},setObjectsById(t){this._opt.viewer.getModels().forEach((e=>{e.localClippingComponentsById(t)})),this._sectionBox.update(),this._opt.viewer.render()},setObjectsByObjectData(t){this._opt.viewer.getModels().forEach((e=>{e.localClippingComponentsByObjectData(t)})),this._sectionBox.update(),this._opt.viewer.render()},restoreObjects(){this._opt.viewer.getModels().forEach((t=>{t.clearLocalClipping()})),this._sectionBox.update(),this._opt.viewer.render()},setFilter(t){const e=this._opt.viewer;for(const i of t){if(i.layerId){const t=e.getLayerManager().getLayer(i.layerId);if(!t)continue;i.modelId=t.getModelId()}let t;i.modelId&&(t=e.getModel(i.modelId)),void 0!==t&&(i.objectIds?t.localClippingComponentsById(i.objectIds):i.objectData?t.localClippingComponentsByObjectData(i.objectData):t.localClippingComponentsByObjectData([]))}this._sectionBox.update(),this._opt.viewer.render()},clearFilter(){this.restoreObjects()},changeClipDirection(t){this._opt.viewer.getViewer().editorManager.getToolByName("clipByBox").changeDirection(t)},rotateByAxis(t,e){if(n.send(i,"rotateByAxis"),"XAxis"!==t&&"YAxis"!==t&&"ZAxis"!==t)return void console.warn("Rotate axis must be XAxis,YAxis or ZAxis.");if(isNaN(e))return void console.warn("the degree input is not a number");let o,s=THREE.Math.degToRad(e);switch(t){case"XAxis":o="x";break;case"YAxis":o="z",s=-s;break;case"ZAxis":o="y"}const r=this._opt.viewer;r.getViewer().editorManager.getToolByName("clipByBox").rotateSectionBox(o,s),r.render()},setBoxByVectors(t,e,o,s){n.send(i,"setBoxByVectors"),this.reset();let r=t=>void 0!==t.x&&void 0!==t.y&&void 0!==t.z;if(!(r(t)&&r(e)&&r(o)&&r(s)))return void console.warn("the object input is invalid.");const a=new THREE.Vector3(e.x,e.y,0),l=new THREE.Vector3(o.x,o.y,0),h=new THREE.Vector3(0,0,s.z),c=Math.sqrt(Math.pow(a.x,2)+Math.pow(a.y,2)),d=new THREE.Vector3(-a.y,a.x,0),u=Math.abs(l.dot(d)/d.length()),p=Math.abs(h.z);let g=new THREE.Box3;g.min=new THREE.Vector3(t.x-c,t.y-u,t.z-p),g.max=new THREE.Vector3(t.x+c,t.y+u,t.z+p),this.setBox(g),a.y<0&&(a.x=-a.x,a.y=-a.y);const m=THREE.Math.radToDeg(Math.acos(a.clone().normalize().dot(new THREE.Vector3(1,0,0))));this.rotateByAxis("ZAxis",m)},enableHatch(t){CLOUD$1.GlobalData.ClippingCapsType!=t&&CLOUD$1.GlobalData.ClippingCapsType!=CLOUD$1.EnumClippingCapsTypes.ClipPlane&&(CLOUD$1.GlobalData.ClippingCapsType=t?CLOUD$1.EnumClippingCapsTypes.ClipBox:CLOUD$1.EnumClippingCapsTypes.None,this._sectionBox&&this._sectionBox.visibleCapsWireframe(t),t&&this._sectionBox&&this._sectionBox.getEditor().clipPlanes.reCalculateClippingIds())},isHatchEnabled:()=>CLOUD$1.GlobalData.ClippingCapsType==CLOUD$1.EnumClippingCapsTypes.ClipBox},o.SectionBox=s}(),function(){let t=Object.freeze({Forward:"Forward",Reverse:"Reverse"});Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Section").SectionPlaneDirection=t}(),function(){let t=Object.freeze({X:"X",Y:"Y",Z:"Z"});Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Section").SectionPlanePlane=t}(),Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Section").SectionPlaneConfig=function(){return{viewer:null,progress:50,plane:Glodon$1.Bimface.Plugins.Section.SectionPlanePlane.X,direction:Glodon$1.Bimface.Plugins.Section.SectionPlaneDirection.Forward,hatchByMaterial:!1}},function(){var t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Section"),e=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.Dom");Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.HttpRequest");t.CoordinateDrawer=class{constructor(t,e){this.coordinateSystem=t,this.viewer=e,this.container=this.viewer.domElement,this.mapDrawables={},this.initialize()}initialize(){this.xmlns="http://www.w3.org/2000/svg";var t=e.create("div","bf-coordinate-drawer");t.style.left="0px",t.style.top="0px",t.style.width=this.container.offsetWidth+"px",t.style.height=this.container.offsetHeight+"px",t.style.position="absolute",t.style.zIndex=5,this.group=document.createElementNS(this.xmlns,"svg"),this.group.setAttribute("width",this.container.offsetWidth+""),this.group.setAttribute("height",this.container.offsetHeight+""),t.appendChild(this.group),this.container.appendChild(t)}makeCircle(t,e){var i=this.mapDrawables;null==i[t]&&(i[t]=document.createElementNS(this.xmlns,"circle"),this.group.appendChild(i[t]));var n=i[t];n.style.fill=e.color||"#FF0000",n.setAttribute("r",e.radius+""),n.setAttribute("transform","translate("+e.center.x+","+e.center.y+")")}show(t,e){var i=this.getDrawable(t);i&&(i.style.display=e?"block":"none")}fill(t,e){this.getDrawable(t).style.fill=e?"block":"none"}makeLine(t,e){var i=this.mapDrawables;null==i[t]&&(i[t]=document.createElementNS(this.xmlns,"line"),this.group.appendChild(i[t]));var n=i[t];n.setAttribute("stroke",e.color||"#000000"),n.setAttribute("stroke-width",e.width||3),n.setAttribute("x1",e.start.x+""),n.setAttribute("y1",e.start.y+""),n.setAttribute("x2",e.end.x+""),n.setAttribute("y2",e.end.y+"")}makeDashLine(t,e){this.makeLine(t,e),this.mapDrawables[t].setAttribute("stroke-dasharray",e.dashArray)}makePolyline(t,e){var i=null,n=this.mapDrawables;null==n[t]&&(n[t]=document.createElementNS(this.xmlns,"polyline"),this.group.appendChild(n[t])),(i=n[t]).setAttribute("stroke",e.color||"#A9A9A9"),i.setAttribute("stroke-width",e.width||3),i.style.fill="none",i.setAttribute("points",e.points)}makeDefs(t){var e=this.mapDrawables;null==e[t]&&(e[t]=document.createElementNS(this.xmlns,"defs"),null==e.marker&&(e.marker=this.makeMarker(),e[t].appendChild(e.marker)),this.group.appendChild(e[t]))}makeMarker(){var t=document.createElementNS(this.xmlns,"marker");t.setAttribute("id","arrow"),t.setAttribute("viewBox","0 0 10 10"),t.setAttribute("refX","5"),t.setAttribute("refY","5"),t.setAttribute("markerWidth","6"),t.setAttribute("markerHeight","6"),t.setAttribute("orient","auto-start-reverse");var e=document.createElementNS(this.xmlns,"path");return e.setAttribute("d","M 0 0 L 10 5 L 0 10 z"),e.style.fill="#11DAB7",this.mapDrawables.arrow=e,t.appendChild(e),t}getDrawable(t){return this.mapDrawables[t]}attach(){this.getDrawable("axisZ").setAttribute("marker-end","url(#arrow)")}setColor(t,e){this.getDrawable(t).setAttribute("stroke",e)}fill(t,e){this.getDrawable(t).style.fill=e}hideAll(t){let e=1==t?"none":"block";this.group.parentNode.style.display=e}destroy(){for(var t=this.group.children,e=0;e<t.length;e++)this.group.removeChild(t[e]);var i=this.group.parentNode;i&&i.removeChild(this.group)}}}(),function(){let t=Object.freeze({SectionPlaneUpdate:"SectionPlaneUpdate",SectionPlaneChanged:"SectionPlaneChanged"});Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Section").SectionPlaneEvent=t}(),function(){var t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Section");Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.Dom"),Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.HttpRequest");t.CoordinateAction=class{constructor(t,e){this.coordinateSystem=t,this.viewer=t.viewer.getViewer(),this.drawingImpl=e,this.viewportOffset=this.viewer.domElement.getBoundingClientRect(),this.cameraControl=this.viewer.cameraControl,this.fillClipPlane=CLOUD$1.FillClipPlaneManager.getInstance(this.viewer.getScene()),this.initialize(),this.eventManager=t.viewer.getEventManager()}initialize(){this.arrowMouseDown=!1,this.circleXMouseDown=!1,this.circleYMouseDown=!1,this.firstClickDown=!0,this.firstRotate=!0,this.lineOut=!0,this.arrowOut=!0,this.translateStartPt=new THREE.Vector2,this.translateEndPt=new THREE.Vector2,this.rotateAngleA=0,this.rotateAngleB=0,this.config=this.coordinateSystem.config,this.sectionPlaneEvent=Glodon$1.Bimface.Plugins.Section.SectionPlaneEvent}registerArrowEvents(){var t=this.drawingImpl.getDrawable("axisZ"),e=this,i=this.config.colors;t.onmouseover=function(){1!=e.circleXMouseDown&&1!=e.circleYMouseDown&&(e.drawingImpl.setColor("axisZ",i.highLight),e.drawingImpl.fill("arrow",i.highLight),e.drawingImpl.setColor("tipArcX",i.default),e.drawingImpl.fill("cubeX",i.default),e.drawingImpl.setColor("tipArcY",i.default),e.drawingImpl.fill("cubeY",i.default),e.lineOut=!1)},t.onmouseout=function(){1!=e.circleXMouseDown&&1!=e.circleYMouseDown&&0==e.arrowMouseDown&&1==e.arrowOut&&(e.drawingImpl.setColor("axisZ",i.arrow),e.drawingImpl.fill("arrow",i.arrow),e.drawingImpl.setColor("tipArcX",i.tipArcX),e.drawingImpl.fill("cubeX",i.cubeX),e.drawingImpl.setColor("tipArcY",i.tipArcY),e.drawingImpl.fill("cubeY",i.cubeY),e.lineOut=!0)},t.onmousedown=function(t){e.arrowMouseDown=!0,e.lineOut=!1;var i=e.config.colors;e.drawingImpl.setColor("axisZ",i.highLight),e.drawingImpl.fill("arrow",i.highLight),e.coordinateSystem.colorUpdate=!1,e.translateStartPt.set(t.clientX,t.clientY)};var n=this.drawingImpl.getDrawable("arrow");n.onmouseover=function(){if(1!=e.circleXMouseDown&&1!=e.circleYMouseDown){e.arrowOut=!1;var t=e.config.colors;e.drawingImpl.fill("arrow",t.highLight),e.drawingImpl.setColor("axisZ",t.highLight),e.drawingImpl.setColor("tipArcX",t.default),e.drawingImpl.fill("cubeX",t.default),e.drawingImpl.setColor("tipArcY",t.default),e.drawingImpl.fill("cubeY",t.default)}},n.onmouseout=function(){if(1!=e.circleXMouseDown&&1!=e.circleYMouseDown&&0==e.arrowMouseDown&&1==e.lineOut){e.arrowOut=!0;var t=e.config.colors;e.drawingImpl.setColor("axisZ",t.arrow),e.drawingImpl.fill("arrow",t.arrow),e.drawingImpl.setColor("tipArcX",t.tipArcX),e.drawingImpl.fill("cubeX",t.cubeX),e.drawingImpl.setColor("tipArcY",t.tipArcY),e.drawingImpl.fill("cubeY",t.cubeY)}},n.onmousedown=function(t){e.arrowMouseDown=!0,e.arrowOut=!1;var i=e.config.colors;e.drawingImpl.setColor("axisZ",i.highLight),e.drawingImpl.fill("arrow",i.highLight),e.translateStartPt.set(t.clientX,t.clientY)},document.onmousemove=function(t){if(1==e.arrowMouseDown){if(e.fillClipPlane.clearCapsWireframe(),CLOUD$1.GlobalData.ClippingCaps=!1,!(t.clientX==e.translateStartPt.x&&t.clientY==e.translateStartPt.y)){var i=e.fillClipPlane.renderClipPlane,n=i.normal.clone();n.w=i.constant;var o=e.cameraControl.movePlane(n,t,e.translateStartPt,!1,e.fillClipPlane.position.clone());null!=o&&e.fillClipPlane.offset(o),e.translateStartPt.set(t.clientX,t.clientY),e.cameraControl.setCameraChanging(!0),e.cameraControl.update(!0)}e.coordinateSystem.update();var s=e.config.colors;e.drawingImpl.setColor("axisZ",s.highLight),e.drawingImpl.fill("arrow",s.highLight),e.drawingImpl.setColor("tipArcX",s.default),e.drawingImpl.fill("cubeX",s.default),e.drawingImpl.setColor("tipArcY",s.default),e.drawingImpl.fill("cubeY",s.default),t.preventDefault(),t.stopPropagation(),e.fireSectionPlaneChangedEvent()}},document.onmouseup=function(){if(0!=e.arrowMouseDown){e.arrowMouseDown=!1,e.coordinateSystem.colorUpdate=!0;var t=e.config.colors;e.drawingImpl.setColor("axisZ",t.arrow),e.drawingImpl.fill("arrow",t.arrow),e.drawingImpl.setColor("tipArcX",t.tipArcX),e.drawingImpl.fill("cubeX",t.cubeX),e.drawingImpl.setColor("tipArcY",t.tipArcY),e.drawingImpl.fill("cubeY",t.cubeY),e.fillClipPlane.calculateClippingIds(),CLOUD$1.GlobalData.ClippingCaps=!0,e.viewer.render()}}}registerCircleXEvents(){var t=this,e=this.config.colors,i=this.drawingImpl.getDrawable("tipArcX");i.onmousedown=function(){t.circleXMouseDown=!0,t.drawingImpl.setColor("axisZ",e.default),t.drawingImpl.fill("arrow",e.default),t.enableCircleXMovement()},i.onmouseout=function(){0==t.circleXMouseDown&&(t.drawingImpl.setColor("axisZ",e.arrow),t.drawingImpl.fill("arrow",e.arrow),t.drawingImpl.setColor("tipArcY",e.tipArcY),t.drawingImpl.fill("cubeY",e.cubeY),t.coordinateSystem.circleToArc("tipArcX"))},document.addEventListener("mouseup",(function(){1==t.circleXMouseDown&&(t.fillClipPlane.calculateClippingIds(),CLOUD$1.GlobalData.ClippingCaps=!0,t.viewer.render()),t.circleXMouseDown=!1,t.circleXMouseDown=!1,t.firstClickDown=!0,t.firstRotate=!1,t.lastRotateX=0,t.lastRotateY=0,t.drawingImpl.show("tipArcY",!0),t.drawingImpl.show("axisY",!0),t.drawingImpl.show("axisZ",!0),t.drawingImpl.show("cubeY",!0),t.coordinateSystem.update(),t.drawingImpl.show("dashLineX",!1),t.drawingImpl.setColor("axisZ",e.arrow),t.drawingImpl.fill("arrow",e.arrow)}))}registerCircleYEvents(){var t=this,e=this.config.colors,i=this.drawingImpl.getDrawable("tipArcY");i.onmousedown=function(){t.circleYMouseDown=!0,t.drawingImpl.setColor("axisZ",e.default),t.drawingImpl.fill("arrow",e.default),t.enableCircleYMovement()},i.onmouseout=function(){0==t.circleYMouseDown&&(t.drawingImpl.setColor("axisZ",e.arrow),t.drawingImpl.fill("arrow",e.arrow),t.coordinateSystem.circleToArc("tipArcY"),t.drawingImpl.setColor("tipArcX",e.tipArcX),t.drawingImpl.fill("cubeX",e.cubeX))},document.addEventListener("mouseup",(function(){1==t.circleYMouseDown&&(t.fillClipPlane.calculateClippingIds(),CLOUD$1.GlobalData.ClippingCaps=!0,t.viewer.render()),t.circleYMouseDown=!1,t.drawingImpl.show("tipArcX",!0),t.drawingImpl.show("cubeX",!0),t.coordinateSystem.update(),t.drawingImpl.show("dashLineY",!1),t.drawingImpl.setColor("axisZ",e.arrow),t.drawingImpl.fill("arrow",e.arrow)}))}enableCircleXMovement(){var t=this,e=this.config.colors;document.addEventListener("mousemove",(function(i){if(1==t.circleXMouseDown){t.drawingImpl.show("dashLineX",!0),t.drawingImpl.setColor("axisZ",e.default),t.drawingImpl.fill("arrow",e.default),t.fillClipPlane.clearCapsWireframe(),CLOUD$1.GlobalData.ClippingCaps=!1;var n=t.fillClipPlane.normalIndex,o=t.viewportOffset,s=new THREE.Vector2(i.clientX-o.left,i.clientY-o.top),r=t.calcRotateAngleIndex(s,t.coordinateSystem.discretePointsX);1==t.firstClickDown&&(t.lastIndex=r);var a=2*(r-t.lastIndex);(n>3||"Reverse"==t.coordinateSystem.planeDirection)&&(a=-a),t.drawingImpl.show("tipArcY",!1),t.coordinateSystem.updateAxisZ();var l=t.fillClipPlane.renderClipPlane.normal.clone(),h=t.coordinateSystem.getCoordinateAxis(),c=t.config.styles;t.coordinateSystem.drawClipPlaneCircle("tipArcZ",h.start.clone(),c.auxCircleRadius,t.coordinateSystem.dirX,l);var d=t.coordinateSystem.drawingToCanvas(h.start.clone()),u=t.coordinateSystem.drawingToCanvas(h.endY.clone());t.coordinateSystem.drawAxisY(d,u,e.highLight),t.coordinateSystem.drawCubeX("cubeX",u,c.cubeRadius),t.drawingImpl.show("cubeY",!1);var p="x";n<2&&(p="y"),t.fillClipPlane.rotateAngleOffset(a,p),t.coordinateSystem.backwardCoordinate(),1==t.firstClickDown?t.firstClickDown=!1:t.lastIndex=r,t.translateStartPt.set(i.clientX,i.clientY),t.viewer.render(),i.preventDefault(),i.stopPropagation(),t.fireSectionPlaneChangedEvent()}}))}enableCircleYMovement(){var t=this,e=this.config.colors;document.addEventListener("mousemove",(function(i){if(1==t.circleYMouseDown){t.drawingImpl.show("dashLineY",!0),t.drawingImpl.setColor("axisZ",e.default),t.drawingImpl.fill("arrow",e.default),t.fillClipPlane.clearCapsWireframe(),CLOUD$1.GlobalData.ClippingCaps=!1;var n=t.fillClipPlane.normalIndex,o=t.viewportOffset,s=new THREE.Vector2(i.clientX-o.left,i.clientY-o.top),r=t.calcRotateAngleIndex(s,t.coordinateSystem.discretePointsY);1==t.firstClickDown&&(t.lastIndex=r);var a=2*(r-t.lastIndex);n>3&&(a=-a,"Reverse"==t.coordinateSystem.planeDirection&&(a=-a)),t.drawingImpl.show("tipArcX",!1),t.coordinateSystem.updateAxisZ();var l=t.fillClipPlane.renderClipPlane.normal.clone(),h=t.coordinateSystem.getCoordinateAxis(),c=t.config.styles;t.coordinateSystem.drawClipPlaneCircle("tipArcZ",h.start.clone(),c.auxCircleRadius,t.coordinateSystem.dirX.clone(),l.clone());var d=t.coordinateSystem.drawingToCanvas(h.start.clone()),u=t.coordinateSystem.drawingToCanvas(h.endX.clone());t.coordinateSystem.drawAxisX(d,u,e.highLight),t.coordinateSystem.drawCubeY("cubeY",u,c.cubeRadius),t.drawingImpl.show("cubeX",!1);var p="z";n>3&&(p="y"),t.fillClipPlane.rotateAngleOffset(a,p),t.coordinateSystem.backwardCoordinate(),1==t.firstClickDown?t.firstClickDown=!1:t.lastIndex=r,t.translateStartPt.set(i.clientX,i.clientY),t.viewer.render(),i.preventDefault(),i.stopPropagation(),t.fireSectionPlaneChangedEvent()}}))}registerTipArcXEvents(){var t=this,e=this.config.colors,i=this.drawingImpl.getDrawable("tipArcX");i.onmouseover=function(){0==t.circleYMouseDown&&(t.coordinateSystem.arcToCircle("tipArcX"),t.drawingImpl.setColor("tipArcY",e.default),t.drawingImpl.fill("cubeY",e.default),t.drawingImpl.setColor("axisZ",e.default),t.drawingImpl.fill("arrow",e.default),t.registerCircleXEvents())},i.onmouseout=function(){0==t.circleXMouseDown&&t.coordinateSystem.circleToArc("tipArcX")}}registerTipArcYEvents(){var t=this,e=this.config.colors,i=this.drawingImpl.getDrawable("tipArcY");i.onmouseover=function(){0==t.circleXMouseDown&&(t.coordinateSystem.arcToCircle("tipArcY"),t.drawingImpl.setColor("tipArcX",e.default),t.drawingImpl.fill("cubeX",e.default),t.drawingImpl.setColor("axisZ",e.default),t.drawingImpl.fill("arrow",e.default),t.registerCircleYEvents())},i.onmouseout=function(){0==t.circleYMouseDown&&t.coordinateSystem.circleToArc("tipArcY")}}calcRotateAngleIndex(t,e){for(var i=this.coordinateSystem.cOrigin,n=this.createLine(t,i),o=-1,s=Number.POSITIVE_INFINITY,r=0;r<90;r++){var a=e[r].clone(),l=this.disPointToLine(a,n);l<s&&(s=l,o=r)}var h=90+o;return e[o].clone().distanceTo(t)<e[h].clone().distanceTo(t)?o:h}createLine(t,e){var i={};if(t.x==e.x)i.A=1,i.B=0,i.C=-t.x;else{var n=(e.y-t.y)/(e.x-t.x),o=e.y-n*e.x;i.A=n,i.B=-1,i.C=o}return i}disPointToLine(t,e){return Math.abs(e.A*t.x+e.B*t.y+e.C)/Math.sqrt(e.A*e.A+e.B*e.B)}fireSectionPlaneChangedEvent(){const t=this.coordinateSystem.viewer._sectionPlane;this.eventManager.fireEvent(this.sectionPlaneEvent.SectionPlaneChanged,t.getSectionPlane())}}}(),Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Section").CoordinateSystemConfig=function(){return{colors:{tipArcX:"#0000FF",cubeX:"#0000FF",tipArcY:"#FF0000",cubeY:"#FF0000",highLight:"#FFFF00",tipLine:"#11DAB7",arrow:"#11DAB7",default:"#A9A9A9"},styles:{dashArray:"10 8",originRadius:5,auxCircleRadius:100,tipLineLength:500,cubeRadius:5,axisXWidth:2,axisYWidth:2,axisZWidth:3,axisXLength:100,axisYLength:100,axisZLength:165,segments:180,tipArcLeftCounts:15,tipArcRightCounts:60}}},function(){var t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Section");Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.Dom"),Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.HttpRequest");t.CoordinateSystem=class{constructor(t){this.viewer=t;let e=this.viewer.getViewer();this.cameraControl=e.cameraControl,this.fillClipPlane=CLOUD$1.FillClipPlaneManager.getInstance(e.getScene()),this.container=e.domElement,this.config=new Glodon$1.Bimface.Plugins.Section.CoordinateSystemConfig,this.drawingImpl=new Glodon$1.Bimface.Plugins.Section.CoordinateDrawer(this,e),this.coordinateAction=new Glodon$1.Bimface.Plugins.Section.CoordinateAction(this,this.drawingImpl),this.updateBinded=this.update.bind(this),this.initialize()}initialize(){this.enable=!0,this.boundingBox=new THREE.Box2,this.bRegisterArrowEvent=!1,this.bRegisterAuxCircleEvent=!1,this.mapDrawableName={ORIGIN:"origin",AXISX:"axisX",AXISY:"axisY",CUBEX:"cubeX",CUBEY:"cubeY",AXISZ:"axisZ",ARROW:"arrow",DASHLINE:"dashLine",TIPARC_X:"tipArcX",TIPARC_Y:"tipArcY",TIPARC_Z:"tipArcZ",DASHLINE_X:"dashLineX",DASHLINE_Y:"dashLineY"}}setDirection(t){this.planeDirection=t}saveTransform(t){this.savedCamera=t.clone()}drawingToCanvas(t,e){var i=this.getCoordinateAxis().start.clone(),n=this.cameraControl.camera,o=new THREE.Vector3,s=this.viewer.getViewer();if(null==this.cameraToCenter){var r=s.getCamera(),a=s.getScene().getOriginalBoundingBoxWorld().clone();a.applyMatrix4(s.getScene().geometryGroup.matrix),n.setStandardView(CLOUD$1.EnumStandardView.ISO,a),n.zoomToBBox(a),i=this.getCoordinateAxis().start.clone(),this.cameraToCenter=i.clone().sub(n.position.clone()).length(),this.defaultDistance=1500;var l=s.getScene().getMatrixGlobal(),h=CLOUD$1.CameraUtil.parseCameraInfo(r),c=CLOUD$1.Camera.worldToDrawing(h,l);(d=new THREE.Vector3).subVectors(c.target,c.position),n.LookAt(c.target,d,c.up),this.cameraControl.update(!0,!0)}else{var d=i.clone().sub(n.position.clone()).normalize(),u=n.position.clone().sub(i.clone()).length();o=d.multiplyScalar(this.defaultDistance-u)}var p=this.container.offsetWidth,g=this.container.offsetHeight;!1!==e&&n.isPerspective&&t.add(o);var m=CLOUD$1.CameraUtil.drawingToCanvas(n,t,p,g);return new THREE.Vector2(m.x,m.y)}getCoordinateAxis(){var t=this.fillClipPlane.renderClipPlane.normal.clone(),e=this.fillClipPlane.getCoordinate(),i=e.axisY.clone(),n=t.clone().cross(i.clone());this.fillClipPlane.normalIndex>3&&(i=(n=e.axisX.clone()).clone().cross(t.clone()));var o=this.config.styles,s=this.fillClipPlane.position.clone(),r=s.clone().add(n.clone().multiplyScalar(o.axisXLength)),a=s.clone().add(i.clone().multiplyScalar(o.axisYLength)),l=s.clone().add(t.clone().multiplyScalar(o.axisZLength));return this.dirX=n,this.dirY=i,{start:s,endX:r,endY:a,endZ:l}}drawOrigin(t,e){var i=this.mapDrawableName,n={center:t,radius:e,color:this.config.colors.default};this.drawingImpl.makeCircle(i.ORIGIN,n)}drawAxisX(t,e,i){var n=this.mapDrawableName,o={start:t,end:e,width:this.config.styles.axisXWidth,color:i||this.config.colors.default};this.drawingImpl.makeLine(n.AXISX,o)}drawAxisY(t,e,i){var n=this.mapDrawableName,o=this.config,s={start:t,end:e,width:o.styles.axisYWidth,color:i||o.colors.default};this.drawingImpl.makeLine(n.AXISY,s)}drawAxisZ(t,e){var i=this.mapDrawableName,n=this.config,o={start:t,end:e,width:n.styles.axisZWidth,color:n.colors.arrow};this.drawingImpl.makeLine(i.AXISZ,o),this.drawingImpl.attach(),0==this.bRegisterArrowEvent&&(this.coordinateAction.registerArrowEvents(),this.bRegisterArrowEvent)}updateAxisZ(){var t=this.getCoordinateAxis(),e=this.drawingToCanvas(t.start.clone()),i=this.drawingToCanvas(t.endZ.clone()),n=this.mapDrawableName,o={start:e,end:i,color:this.config.colors.default};this.drawingImpl.makeLine(n.AXISZ,o)}drawArrow(t,e){var i=this.mapDrawableName,n={start:t,end:e};this.drawingImpl.makeLine(i.AXISZ,n),this.drawingImpl.attach(),this.drawingImpl.setColor(i.AXISZ,this.config.colors.default),0==this.bRegisterArrowEvent&&(this.coordinateAction.registerArrowEvents(),this.bRegisterArrowEvent)}drawClipPlaneCircle(t,e,i,n,o){for(var s={center:e.clone(),radius:i,normal:n.clone(),rotateAxis:o.clone()},r=this.config.styles.segments,a=this.discreteCircle(s,r),l="",h=0;h<r;h++)l+=a[h].x+","+a[h].y,l+=" ";l+=a[0].x+","+a[0].y;var c={points:l+=" ",color:this.config.colors.default,width:2};this.drawingImpl.makePolyline(t,c)}drawTipArc(t,e,i,n,o){var s={center:e.clone(),radius:i,normal:n.clone(),rotateAxis:o.clone()},r=this.config.styles,a=r.tipArcRightCounts,l=r.tipArcLeftCounts,h=r.segments,c=this.discreteCircle(s,h);t==this.mapDrawableName.TIPARC_X?(this.discretePointsX=c,a=r.tipArcLeftCounts,l=r.tipArcRightCounts):this.discretePointsY=c;for(var d="",u=h-a-1;u<h;u++)d+=c[u].x+","+c[u].y,d+=" ";for(var p=0;p<=l;p++)d+=c[p].x+","+c[p].y,d+=" ";var g={points:d,color:this.config.colors.tipArcX};t==this.mapDrawableName.TIPARC_X?(this.drawingImpl.makePolyline(t,g),this.coordinateAction.registerTipArcXEvents()):t==this.mapDrawableName.TIPARC_Y&&(g.color=this.config.colors.tipArcY,this.drawingImpl.makePolyline(t,g),this.coordinateAction.registerTipArcYEvents())}drawTipLine(t,e,i){var n=this.drawingToCanvas(e.clone(),!1),o=this.drawingToCanvas(i.clone(),!1),s=this.config,r={start:n,end:o,color:s.colors.tipLine,dashArray:s.styles.dashArray};this.drawingImpl.makeDashLine(t,r),this.drawingImpl.show(t,!1)}drawCubeX(t,e,i){var n={center:e,radius:i,color:this.config.colors.cubeX};this.drawingImpl.makeCircle(t,n)}drawCubeY(t,e,i,n){var o={center:e,radius:i,color:n||this.config.colors.cubeY};this.drawingImpl.makeCircle(t,o)}discreteCircle(t,e){for(var i=t.center.clone(),n=t.radius,o=t.rotateAxis.clone(),s=t.normal.clone(),r=[],a=0;a<e;a++){s.applyAxisAngle(o,2*Math.PI/e);var l=i.clone().add(s.clone().multiplyScalar(n)),h=this.drawingToCanvas(l.clone());r.push(h)}return r}arcToCircle(t){var e="",i=this.discretePointsX;t==this.mapDrawableName.TIPARC_Y&&(i=this.discretePointsY);for(var n=0,o=i.length;n<o;n++)e+=i[n].x+","+i[n].y,e+=" ";e+=i[0].x+","+i[0].y;var s={points:e+=" ",color:this.config.colors.highLight};this.drawingImpl.makePolyline(t,s)}circleToArc(t){var e=this.config.styles,i=e.tipArcLeftCounts,n=e.tipArcRightCounts,o=e.segments,s=this.discretePointsX,r={color:this.config.colors.tipArcX};t==this.mapDrawableName.TIPARC_Y&&(s=this.discretePointsY,r.color=this.config.colors.tipArcY,i=e.tipArcRightCounts,n=e.tipArcLeftCounts);for(var a="",l=o-i-1;l<o;l++)a+=s[l].x+","+s[l].y,a+=" ";for(var h=0;h<=n;h++)a+=s[h].x+","+s[h].y,a+=" ";r.points=a,this.drawingImpl.makePolyline(t,r)}update(t){if(1==t||1!=this.bIsCoordinateHided){var e=this.getCoordinateAxis(),i=this.drawingToCanvas(e.start.clone()),n=this.drawingToCanvas(e.endX.clone()),o=this.drawingToCanvas(e.endY.clone()),s=this.drawingToCanvas(e.endZ.clone());null==this.createRefs&&(this.drawingImpl.makeDefs("refs"),this.createRefs=!0),this.cOrigin=i.clone(),this.drawAxisZ(i,s),this.drawAxisX(i,n),this.drawAxisY(i,o);var r=this.config.styles,a=this.mapDrawableName,l=this.fillClipPlane.renderClipPlane.normal.clone();this.drawClipPlaneCircle(a.TIPARC_Z,e.start.clone(),r.auxCircleRadius,this.dirX,l),this.drawTipArc(a.TIPARC_X,e.start.clone(),r.auxCircleRadius,l,this.dirX),this.drawTipArc(a.TIPARC_Y,e.start.clone(),r.auxCircleRadius,l,this.dirY);var h=this.fillClipPlane.getSideLength()/2,c=e.start.clone().add(this.dirX.clone().multiplyScalar(h)),d=e.start.clone().sub(this.dirX.clone().multiplyScalar(h));this.drawTipLine(a.DASHLINE_X,c,d);var u=e.start.clone().add(this.dirY.clone().multiplyScalar(h)),p=e.start.clone().sub(this.dirY.clone().multiplyScalar(h));this.drawTipLine(a.DASHLINE_Y,u,p),this.drawOrigin(i,r.originRadius);var g=this.discretePointsX[44].clone();this.drawCubeX(a.CUBEX,g,r.cubeRadius);var m=this.discretePointsY[134].clone();this.drawCubeY(a.CUBEY,m,r.cubeRadius),this.updateBbox()}}hide(t){this.drawingImpl.hideAll(t),this.bIsCoordinateHided=t}destroy(){this.drawingImpl.destroy()}updateBbox(){this.boundingBox.makeEmpty();for(var t=0;t<this.discretePointsX.length;t++){var e=this.discretePointsX[t].clone();this.boundingBox.expandByPoint(e)}for(t=0;t<this.discretePointsY.length;t++){e=this.discretePointsY[t].clone();this.boundingBox.expandByPoint(e)}var i=this.getCoordinateAxis(),n=this.drawingToCanvas(i.start.clone()),o=this.drawingToCanvas(i.endZ.clone());this.boundingBox.expandByPoint(n),this.boundingBox.expandByPoint(o),this.boundingBox.expandByScalar(5)}insideBoundingBox(t){return this.boundingBox.containsPoint(t.clone())}backwardCoordinate(){var t=this.cameraControl.camera.position,e=this.cameraControl.camera.target.clone().sub(t.clone()).normalize(),i=this.fillClipPlane.renderClipPlane.normal.clone();e.angleTo(i);Math.PI}}}(),function(){var t="Bimface.Plugins.Section.SectionPlane",e=Glodon$1.Bimface.Data.StatisticsDataManager.getInstance(),i=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Section");Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.Dom");let n=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility");var o={Forward:0,Reverse:1},s={X:0,Y:2,Z:4},r=function(t){var e=this,i=t.viewer;if(i)if("Viewer3D"===i.viewerType||i instanceof Glodon$1.Bimface.Viewer.ViewerGIS){if(i._sectionBox&&(i._sectionBox.hideBox(),!1!==t.exitSectionBox&&i._sectionBox.exit()),CLOUD$1.GlobalData.ClippingCapsType=CLOUD$1.EnumClippingCapsTypes.ClipPlane,t.hatchByMaterial&&i.getViewer().getClipCapsManager().enableHatchByMaterial(t.hatchByMaterial,!1),i._sectionPlane)return i._sectionPlane.showPlane(),i._sectionPlane;i._sectionPlane=this,e.id=t.id,e._opt=t,e.mode=t.mode,e._plane=t.plane,e._direction=t.direction,e._progress=-1,this.onFloorExplosionBinded=this.onFloorExplosion.bind(this),this.onClipMouseHoverBinded=this.onClipMouseHover.bind(this),this.onClipMouseMoveBinded=this.onClipMouseMove.bind(this),e.init(),e.setPlane(t.plane),this._boxSize=new THREE.Vector3}else console.log("viewer should be Viewer3D or ViewerGIS.");else console.log("domElement must not be empty.")};r.prototype={init:function(){e.send(t,"init"),this.enableCoordinate=!0;var i=this._opt.viewer,n=i.getViewer(),o=this;this.coordinateSystem=new Glodon$1.Bimface.Plugins.Section.CoordinateSystem(i),this.coordinateSystem.setDirection(this._direction),CLOUD$1.GlobalData.ClippingCaps=!0,n.editorManager.enableTool(n,CLOUD$1.EditToolMode.CLIP_FILL),this._sectionTool=CLOUD$1.FillClipPlaneManager.getInstance(n.getScene()),this._sectionTool.observer=function(){var t=Glodon$1.Bimface.Plugins.Section.SectionPlaneEvent;i.getEventManager().fireEvent(t.SectionPlaneUpdate,o)},this._sectionTool.enable(!0,!0),this.hookEvens()},hookEvens:function(){var t=this.coordinateSystem,e=this._opt.viewer.getViewer(),i=n.throttle;e.registerEventListener(CLOUD$1.EVENTS.ON_CLIP_HOVER,this.onClipMouseHoverBinded),e.registerEventListener(CLOUD$1.EVENTS.ON_CLIP_MOUSE_MOVE,this.onClipMouseMoveBinded),e.registerEventListener(CLOUD$1.EVENTS.ON_EDITOR_ZOOM,i(t.updateBinded,50)),e.registerEventListener(CLOUD$1.EVENTS.ON_CAMERA_ANIMATION_UPDATE,i(t.updateBinded,50)),e.registerEventListener(CLOUD$1.EVENTS.ON_EDITOR_END,(function(){t.update(!0)})),this._opt.viewer.addEventListener(Glodon$1.Bimface.Viewer.Viewer3DEvent.FloorExplosion,this.onFloorExplosionBinded)},onFloorExplosion:function(){this.resetSectionTool(),this._opt.viewer.render()},onClipMouseHover:function(t){var e=this.coordinateSystem,i=this._opt.viewer.getDomElement();if(0!=this.enableCoordinate)if(e.update(!0),t.onClipPlane)e.hide(!1);else{i.style.cursor="";var n=new THREE.Vector2(t.event.clientX,t.event.clientY);e.insideBoundingBox(n)?e.hide(!1):e.hide(!0)}},onClipMouseMove:function(){this.coordinateSystem.update()},exit:function(){var t=this._opt.viewer.getViewer(),e=CLOUD$1.FillClipPlaneManager.getInstance(t.getScene());this.borderParamWidth&&this.borderParamHeight&&this.setBorder(this.borderParamWidth,this.borderParamHeight,!1),this.clearFilter(),t.editorManager.disableTool(CLOUD$1.EditToolMode.CLIP_FILL),e.clearCapsWireframe(),CLOUD$1.GlobalData.ClippingCaps=!1,e.enable(!1,!1),this.coordinateSystem.destroy(),t.getScene().removeObjectGroup(e),t.getScene().fillClipPlane=null,t.getClipCapsManager().resetClippingCapsStatus();let i=Glodon$1.Bimface.Plugins.Section.SectionPlaneEvent;this._opt.viewer.getEventManager().fireEvent(i.SectionPlaneUpdate,null),this._sectionTool=null,this._opt.viewer._sectionPlane=null,t.unregisterEventListener(CLOUD$1.EVENTS.ON_CLIP_HOVER,this.onClipMouseHoverBinded),t.unregisterEventListener(CLOUD$1.EVENTS.ON_CLIP_MOUSE_MOVE,this.onClipMouseMoveBinded),this._opt.viewer.removeEventListener(Glodon$1.Bimface.Viewer.Viewer3DEvent.FloorExplosion,this.onFloorExplosionBinded)},setProgress:function(i){if(e.send(t,"setProgress"),!1!==this._sectionTool.isEnabled()){var n=1-i/50;this._progress=i,this._sectionTool.setProcess(n),this._sectionTool.clearCapsWireframe(),this._sectionTool.calculateClippingIds()}},setOriginProgress:function(t){var e=t/100;this._progress=t,this._sectionTool.setProcess(e),this._sectionTool.clearCapsWireframe(),this._sectionTool.calculateClippingIds()},getOriginProgress:function(){return 100*this._sectionTool.getProcess()},getProgress:function(){return 50*(1-this._sectionTool.getProcess())},setPlane:function(i){e.send(t,"setPlane");var n=o[this._direction]+s[i];this._plane=i,!1!==this._sectionTool.isEnabled()&&(this._sectionTool.changeNormal(n),this.setProgress(this._opt.progress))},getPlane:function(){return this._plane},setDirection:function(i){e.send(t,"setDirection");var n=o[i]+s[this._plane];this._direction=i,this._sectionTool.changeNormal(n),this.setProgress(this._opt.progress)},getDirection:function(){return this._direction},setRotateAngle:function(t,e){this._sectionTool.setRotateAngle(t,e)},getRotateAngle:function(){return this._sectionTool.getRotateAngle()},hidePlane:function(){e.send(t,"hidePlane"),this._sectionTool&&(this._sectionTool.visible=!1),this.enableCoordinate=!1,this.coordinateSystem.hide(!0)},showPlane:function(){e.send(t,"showPlane"),this._sectionTool&&!1===this._sectionTool.isEnabled()||(this._sectionTool&&(this._sectionTool.visible=!0),this.enableCoordinate=!0)},rotateByAxis:function(i,n){if(e.send(t,"rotateByAxis"),"YAxis"===i||"ZAxis"===i){var r="",a=0,l=o[this.getDirection()]+s[this._plane];0==l||1==l?(a="YAxis"===i?-n:n,r="YAxis"===i?"y":"z"):2==l||3==l?(a="YAxis"===i?-n:n,r="YAxis"===i?"x":"z"):4!=l&&5!=l||(a="YAxis"===i?n:-n,r="YAxis"===i?"x":"y"),a="Reverse"===this._direction?n:a,this._sectionTool&&(this._sectionTool.rotateAngleOffset(a,r),this._sectionTool.clearCapsWireframe(),this._sectionTool.calculateClippingIds())}else console.log("Rotate axis must be YAxis or ZAxis.")},reset:function(){e.send(t,"reset");var i=this;i.setPlane(i._opt.plane),i.setDirection(i._opt.direction),i.setProgress(i._opt.progress)},enable:function(i){e.send(t,"enable"),!i&&this._sectionTool.clearCapsWireframe(),this.borderParamWidth&&this.borderParamHeight&&this.setBorder(this.borderParamWidth,this.borderParamHeight,i),this._sectionTool.enable(i,i),i?this.showPlane():this.hidePlane()},getState:function(){return this._sectionTool.store()},isIncluded:function(t){var e=this._opt.viewer,i=e.getViewer().getScene(),n=CLOUD$1.FillClipPlaneManager.getInstance(i),o=n.renderClipPlane.normal.clone().normalize(),s=n.position,r=e.worldToScene(t),a=new THREE.Vector3;return a.subVectors(r,s).normalize(),o.angleTo(a)>Math.PI/2},setPositionByPlane:function(t,e,n){if(!1===this._sectionTool.isEnabled())return;var o=this._opt.viewer;t=o.worldToScene(t),e=o.worldToScene(e);var s=new THREE.Vector3(t.x,t.y,t.z),r=new THREE.Vector3(e.x,e.y,e.z),a=s.clone().add(r.clone().multiplyScalar(n));this._opt.plane=i.SectionPlanePlane.X,this._opt.direction=i.SectionPlaneDirection.Forward,this.reset(),this._sectionTool.update();var l=new THREE.Vector3(1,0,0),h=new THREE.Vector3(0,1,0);let c=1,d=r.clone().projectOnPlane(h);if(0!=d.length){d.normalize(),c=l.clone().cross(d).y>0?1:-1;let t=l.clone().angleTo(d);this.rotateByAxis("ZAxis",t*THREE.Math.RAD2DEG*c)}let u=d.clone().angleTo(r.clone());c=r.y<0?1:-1,this.rotateByAxis("YAxis",u*THREE.Math.RAD2DEG*c),this._sectionTool.position.copy(a),this._sectionTool.center.copy(a),this._sectionTool.update(),this._sectionTool.clearCapsWireframe()},setState:function(i){e.send(t,"setState"),this._sectionTool.restore(i)},restoreRotation:function(){this._sectionTool.restoreRotation()},getSectionPlane:function(){var t=this._opt.viewer,e=this._sectionTool.position.clone(),i=this._sectionTool.renderClipPlane.normal.clone();return e=t.sceneToWorld(e),i=t.sceneToWorld(i),(i=new THREE.Vector3(i.x,i.y,i.z)).normalize(),{position:e,normal:i}},setSectionPlane:function(t){var e=this._opt.viewer;this.reset();var i=e.worldToScene(t.position),n=e.worldToScene(t.normal);(n=new THREE.Vector3(n.x,n.y,n.z)).normalize();var o=new THREE.Vector3(1,0,0),s=new THREE.Quaternion;s.setFromUnitVectors(o,n);var r=new THREE.Euler;r.setFromQuaternion(s),r.x=0,s.setFromEuler(r),s.x=-s.x;var a=this._sectionTool.uniforms.vClipPlane.value[0].clone(),l=new THREE.Vector3(a.x,a.y,a.z);l.normalize();var h=new THREE.Vector3(i.x,i.y,i.z).sub(this._sectionTool.center);this._sectionTool.planeOffset=h.x/l.x,this._sectionTool.quaternion.copy(s),this._sectionTool.position.copy(i),this._sectionTool.update(),this._sectionTool.clearCapsWireframe(),this._sectionTool.calculateClippingIds()},resetSectionTool:function(){var t=this._opt.viewer.getViewer().getScene(),e=t.getBoundingBox();e.getSize(this._boxSize),this._sectionTool.resize(this._boxSize.multiplyScalar(t.expandScalar)),e.getCenter(this._sectionTool.center),e.getCenter(this._sectionTool.position),this._sectionTool.update(),this._sectionTool.clearCapsWireframe(),this._sectionTool.calculateClippingIds()},setObjectsById(t){this._opt.viewer.getModels().forEach((e=>{e.localClippingComponentsById(t)})),this._sectionTool.update(),this._opt.viewer.render()},setObjectsByObjectData(t){this._opt.viewer.getModels().forEach((e=>{e.localClippingComponentsByObjectData(t)})),this._sectionTool.update(),this._opt.viewer.render()},restoreObjects(){this._opt.viewer.getModels().forEach((t=>{t.clearLocalClipping()})),this._sectionTool.update(),this._opt.viewer.render()},setFilter(t){if(t&&t instanceof Array){var e=this._opt.viewer;if("Viewer3D"===e.viewerType)for(var i=0;i<t.length;i++){if((o=t[i]).modelId){var n=e.getModel(o.modelId);n?o.objectIds||o.objectData?o.objectIds?n.localClippingComponentsById(o.objectIds):o.objectData&&n.localClippingComponentsByObjectData(o.objectData):e.getViewer().modelManager.getModel(n.modelId).enableLocalClippingMode(!0):console.warn("invalid modelId.")}else console.warn("invalid modelId.")}else if(e instanceof Glodon$1.Bimface.Viewer.ViewerGIS)for(i=0;i<t.length;i++){var o;if(!(o=t[i]).layerId){console.warn("invalid layerId.");continue}var s=e.getLayerManager().getLayer(o.layerId);if(!s){console.warn("invalid layerId.");continue}const n=e.getModel(s.customId||s.modelId);n?o.objectIds||o.objectData?o.objectIds?n.localClippingComponentsById(o.objectIds):o.objectData&&n.localClippingComponentsByObjectData(o.objectData):e.getViewer().modelManager.getModel(n.modelId).enableLocalClippingMode(!0):console.warn("invalid layerId.")}this._sectionTool.update(),this._sectionTool.clearCapsWireframe(),this._sectionTool.calculateClippingIds(),this._opt.viewer.render()}else console.log("filter should be Array.")},clearFilter(){var t=this._opt.viewer;t.getModels().forEach((e=>{t.getViewer().modelManager.getModel(e.modelId).enableLocalClippingMode(!1)})),this.restoreObjects()},setBorder(t,e,i){this.borderParamWidth=t,this.borderParamHeight=e;var n=20,o=20;"Viewer3D"===this._opt.viewer.viewerType?(n=this._opt.viewer.getViewer().worldToDrawing({x:t,y:0,z:0}).x,o=this._opt.viewer.getViewer().worldToDrawing({x:e,y:0,z:0}).x):this._opt.viewer instanceof Glodon$1.Bimface.Viewer.ViewerGIS&&(n=t||n,o=e||o),n=Math.max(1,n),o=Math.max(1,o),this._sectionTool.setBorder(n,o,i)},drawComponentContours(){let t=this._opt.viewer.getViewer().getScene().getOrCreateObjectGroup(CLOUD$1.ObjectGroupType.CAPSWIREFRAME,{globalSpace:!0});const e=this._sectionTool.capsIntersectContour;for(const i in e){const n=e[i],o=this._opt.viewer.getModel(i).getModelTransformation();(new THREE.Matrix4).fromArray(o);for(const e in n){n[e].clippingContours.map((e=>{e.map((e=>{const i=new THREE.BufferGeometry;i.setFromPoints(e),i.computeBoundingSphere();let n=new THREE.Line(i,new THREE.LineBasicMaterial({color:16711680,depthTest:!1}));t.add(n),n.updateMatrixWorld(!0)}))}))}}},getComponentContours(t,e){if(!this._sectionTool)return void console.warn("The SectionPlane is unavailable");const i=this._opt.viewer;let n=t;if(i instanceof Glodon$1.Bimface.Viewer.ViewerGIS){const e=i.getLayerManager().getLayer(t);if(!e)return void console.warn("Parameter layerId is invalid.");n=e.getModelId()}const o=i.getModel(n);if(!o)return void console.warn("Parameter modelId is invalid.");let s=o.getComponentContours(e);if(i instanceof Glodon$1.Bimface.Viewer.ViewerGIS){const e=s.length;for(let i=0;i<e;++i)delete s[i].modelId,s[i].layerId=t}return s}},i.SectionPlane=r}();class SectionRegionConfig{constructor(){const t={viewer:null,boundary:null,height:0};for(let e in t)this[e]=t[e]}}Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Section").SectionRegionConfig=SectionRegionConfig;class SectionRegion{constructor(t){Glodon$1.Bimface.Data.StatisticsDataManager.getInstance().send("Bimface.Plugins.Section.SectionRegion","bf_c_SectionRegion_new");let e=t.viewer;if(!e)return void console.log("domElement must not be empty.");const i="Viewer3D"===e.viewerType,n=e instanceof Glodon$1.Bimface.Viewer.ViewerGIS;if(i||n){if(e._sectionPlane&&(e._sectionPlane.hidePlane(),e._sectionPlane.exit()),e._sectionBox&&(e._sectionBox.hideBox(),e._sectionBox.exit()),e._sectionRegion)return e._sectionRegion;e._sectionRegion=this,this.eventManager=e.getEventManager(),this._opt=t,this._viewer=e,this.cloudViewer=this._viewer.getViewer(),this.reset()}else console.log("Viewer2D is not supported.")}init(){let t=this.boundary[0].z;this.height<0&&(t+=this.height);let e=this.boundary.map((e=>new THREE.Vector3(e.x,e.y,t)));e.push(e[0]),SectionRegion.isClockwiseBoundary(e)||e.reverse(),CLOUD$1.ClipRegionManager.setClipRegion(this.cloudViewer,e,Math.abs(this.height)),this._viewer.render()}changeClipDirection(t){this.clipDirection=t,CLOUD$1.ClipRegionManager.changeClipDirection(this.cloudViewer,t),this._viewer.render()}reset(){this.boundary=this._opt.boundary,Glodon$1.Bimface.Plugins.Geometry.PlaneBufferGeometry.checkIntersect(this.boundary)?console.warn("Failed to create plane, the plane border is self-intersecting."):(this.height=this._opt.height,this.init(),this.changeClipDirection(!1))}enable(t){t?(this.init(),this.changeClipDirection(this.clipDirection)):this.exit()}exit(){CLOUD$1.ClipRegionManager.exit(this.cloudViewer),this._viewer.render(),this._viewer._sectionRegion=null}hide(){CLOUD$1.ClipRegionManager.hide(this.cloudViewer),this._viewer.render()}show(){CLOUD$1.ClipRegionManager.show(this.cloudViewer),this._viewer.render()}getBoundary(){return this.boundary}getHeight(){return this.height}setHeight(t){this.height=t,this.init()}setBoundary(t){Glodon$1.Bimface.Plugins.Geometry.PlaneBufferGeometry.checkIntersect(t)?console.warn("Failed to create plane, the plane border is self-intersecting."):(this.boundary=t,this.init())}static isClockwiseBoundary(t){let e=0;const i=t.length;for(let n=0;n<i-1;n++)e+=-.5*(t[n+1].y+t[n].y)*(t[n+1].x-t[n].x);return!(e>0)}}Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Section").SectionRegion=SectionRegion,Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Walkthrough").WalkthroughConfig=function(){return{viewer:null,time:10,stopCallback:null}},function(){var t="Bimface.Plugins.Walkthrough",e=Glodon$1.Bimface.Data.StatisticsDataManager.getInstance(),i=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Walkthrough");Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.Dom"),Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.HttpRequest");i.Walkthrough=class{constructor(t){var e=t.viewer,i=e.getViewer();e?"Viewer3D"===e.getViewerType()||"ViewerGIS"===e.getViewerType()?(this._viewer=e,this.bPause=!1,this.cameraStatus=null,this._walkthrough=new CLOUD$1.Walkthrough,this._player=new CLOUD$1.WalkthroughPlayer(i),this._player.setWalkthrough(this._walkthrough),t.stopCallback&&this._player.addStopPlayCallback(t.stopCallback),this.setWalkthroughTime(t.time)):console.log("ViewerType is not supported."):console.log("viewer must not be empty.")}addKeyFrame(i){e.send(t,"addKeyFrame");var n=this._viewer,o=n.getViewer().camera,s={id:Glodon$1.Web.Lang.Utility.UUID.createUUID(),position:o.position.clone(),target:o.target.clone(),name:i};if(this._walkthrough.addKeyFrame(s),this._walkthrough.checkFrameTimeMode()){const t=this._walkthrough.getKeyFrames();t.length>1&&void 0===t[t.length-2].timeBetweenFrames&&(t[t.length-2].timeBetweenFrames=5)}var r=Object.assign({},s);return r.position=n.sceneToWorld(s.position),r.target=n.sceneToWorld(s.target),r.coordinateSystem="world",r}setKeyFrameCallback(i){e.send(t,"setKeyFrameCallback"),this._player.setKeyFrameCallback(i)}removeKeyFrame(i){e.send(t,"removeKeyFrame"),this._walkthrough.removeKeyFrame(i)}clearKeyFrames(){e.send(t,"clearKeyFrames"),this._walkthrough.clearFrames()}setKeyFrames(i){e.send(t,"setKeyFrames"),"string"==typeof i&&(i=JSON.parse(i));var n=[];i.forEach((t=>{var e=Object.assign({},t);"world"===e.coordinateSystem&&(e.position=this._viewer.worldToScene(t.position),e.target=this._viewer.worldToScene(t.target)),n.push(e)})),this._walkthrough.setKeyFrameList(n)}getKeyFrames(){var t=this._walkthrough.getKeyFrames(),e=[];return t.forEach((t=>{var i=Object.assign({},t);i.position=this._viewer.sceneToWorld(t.position),i.target=this._viewer.sceneToWorld(t.target),i.coordinateSystem="world",e.push(i)})),e}setWalkthroughTime(i){e.send(t,"setWalkthroughTime"),DataUtil.assertType(i,"obj")?i.frameTime?this._walkthrough.setWalkthroughTime(i.frameTime):this._walkthrough.setWalkthroughTime(i.totalTime):this._walkthrough.setWalkthroughTime(i)}play(i){e.send(t,"play");var n=this._viewer.getViewer(),o=this._player,s=this.cameraStatus;if((r=n.cameraControl.camera).up.set(0,1,0),r.realUp.set(0,1,0),i&&o.startFrom(i),o.stop(!1),!0===this.bPause){var r=n.getCamera();s&&function(t){var e=(t=JSON.parse(t)).position,i=t.target,n={position:new THREE.Vector3(e.x,e.y,e.z),target:new THREE.Vector3(i.x,i.y,i.z)},o=s,r=n.position.clone().sub(o.position),a=n.target.clone().sub(o.target);return r.length()>0||a.length()>0}(r)&&(this._player.camera.position.copy(this._viewer.worldToScene(s.position)),this._player.camera.target.copy(this._viewer.worldToScene(s.target)))}o.play(),this.bPause=!1}pause(){e.send(t,"pause"),this.bPause=!0,this.cameraStatus=this._viewer.getCameraStatus(),this._player.pause()}stop(){e.send(t,"stop"),this._player.stop(!0),this.bPause=!1}stopCallback(i){e.send(t,"stopCallback"),i&&(this._stopCallback=i,this._player.addStopPlayCallback(i))}}}(),Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Segment").SegmentConfig=function(){return{viewer:null}},Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Segment").IsolateOption=Object.freeze({Hidden:"Hidden",Translucent:"Translucent",PartlyTranslucent:"PartlyTranslucent"}),function(){var t="Bimface.Plugins.Segment",e=Glodon$1.Bimface.Data.StatisticsDataManager.getInstance(),i=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Segment");i.Segment=class{constructor(t){this._viewer=t.viewer,this._segmentInfoMap=null,this._segmentInfoArray=null,this._segmentIdArray=null,this._elementIdMap={},this._loading=!1,this._segmentInfoAcquired=!1,this._segmentIdMapFromComponentId={},this._traversedSegmentIdMap={},this._fullElementIdsLoadEnabled=!0}destroy(){this._viewer=null,this._segmentInfoMap=null,this._segmentInfoArray=null,this._segmentIdArray=null,this._elementIdMap=null,this._segmentIdMapFromComponentId=null,this._traversedSegmentIdMap=null}_hasSegmentInfo(t){return!(!this._segmentInfoMap||!this._segmentInfoMap[t])}_getSegmentInfoById(t){return this._segmentInfoMap?this._segmentInfoMap[t]:null}_removeDuplication(t){for(var e={},i=0,n=t.length;i<n;i++)this._hasSegmentInfo(t[i])&&!e[t[i]]&&(e[t[i]]=!0);return Object.keys(e)}_getSegmentElementIdsByIdx(t,e,i){var n=this,o=this._viewer,s=t[e];n._elementIdMap[s]?i&&i():o.getSegmentElementIds(s,(function(t){t.data&&(n._elementIdMap[s]=t.data,n.segmentFileInfoMap[s].elementIds=n._elementIdMap[s]),i&&i()}),(function(){i&&i()}))}_getSegmentElementIds(t,e){t||(t=this._segmentIdArray);var i=t.length,n=this;i>0?requestAnimationFrame(function t(o,s){var r=s;return function(){n._getSegmentElementIdsByIdx(o,r,(function(){r<i-1?requestAnimationFrame(t(o,r+1)):e&&e()}))}}(t,0)):e&&e()}_getSegmentFullElementIds(t){const e=this;this._viewer.getSegmentElementIds("full",(function(i){const n=i.data;n&&n.forEach((t=>{e._elementIdMap[t.segmentId]=t.elementIds,e.segmentFileInfoMap[t.segmentId].elementIds=t.elementIds})),t&&t()}),(function(){t&&t()}))}_getSegmentMetadataByIdx(t,e,i){var n=this._viewer,o=t[e],s=this.segmentFilePathMap[o].metadata,r=this.segmentFilePathMap[o].databag;n.getSegmentManager().getSegmentMetadata(r,s,(function(){i&&i()}),(function(){i&&i()}))}_getSegmentMetadata(t){var e=Object.keys(this.segmentFilePathMap),i=e.length,n=this;i>0?requestAnimationFrame(function e(o,s){var r=s;return function(){n._getSegmentMetadataByIdx(o,r,(function(){r<i-1?requestAnimationFrame(e(o,r+1)):t&&t()}))}}(e,0)):t&&t()}_loadMetadata(t){for(var e=this._viewer,i=this._segmentIdArray,n=this.segmentFilePathMap={},o=this.segmentFileInfoMap={},s=0,r=i.length;s<r;s++){var a=i[s],l=this._getSegmentInfoById(a).partialElementFiles,h=[];if(l)for(var c=0,d=l.length;c<d;c++){var u=l[c].databagId;if(u){var p=null;n[u]?p=n[u]:(p={databag:e.getDatabagResource(u),metadata:e.getPartialElementsMetadataFile(u),fileId:l[c].fileId},n[u]=p),h.push(p)}}o[a]={id:a,paths:h}}this._getSegmentMetadata(t)}_loadSegments(t,e){if(t=t||this._segmentIdArray){for(var i=this._viewer,n=this._removeDuplication(t),o=[],s=0,r=n.length;s<r;s++){var a=this.segmentFileInfoMap[n[s]];a&&o.push(a)}0!==o.length?i.getSegmentManager().loadSegments(o,(function(){e&&e()})):e&&e()}else e&&e()}getSegmentInfo(i){function n(t,e){if(t.subGroups)for(var i=t.subGroups,o=0,s=i.length;o<s;o++)n(i[o],e);else if(t.segments)for(var r=0,a=t.segments.length;r<a;r++){var l=t.segments[r];e[l.id]=l}}if(e.send(t,"getSegmentInfo"),this._loading)return null;if(this._segmentInfoAcquired)return i&&i(this._segmentInfoArray),this._segmentInfoArray;var o=this;return this._loading=!0,this._viewer.getSegmentTree((function(t){for(var e=t.data,s=o._segmentInfoMap={},r=0,a=e.length;r<a;r++)n(e[r],s);o._segmentIdArray=Object.keys(o._segmentInfoMap),o._segmentInfoArray=[];for(var l=o._segmentInfoArray.length=o._segmentIdArray.length,h=0;h<l;h++)o._segmentInfoArray[h]=o._segmentInfoMap[o._segmentIdArray[h]];o._loadMetadata((function(){o._loading=!1,o._segmentInfoAcquired=!0,i&&i(o._segmentInfoArray)}))}),(function(t){console.error("request segment data error!")})),null}_loadSegmentsWithFullElementIds(t,e){this._fullElementIdsLoaded?this._loadSegments(t,e):this._getSegmentFullElementIds((()=>{this._fullElementIdsLoaded=!0,this._loadSegments(t,e)}))}loadSegments(i,n){e.send(t,"loadSegments");var o=this;this._fullElementIdsLoadEnabled?this._segmentInfoAcquired?this._loadSegmentsWithFullElementIds(i,n):this.getSegmentInfo((function(t){o._loadSegmentsWithFullElementIds(i,n)})):this._segmentInfoAcquired?o._getSegmentElementIds(i,(function(){o._loadSegments(i,n)})):this.getSegmentInfo((function(t){o._getSegmentElementIds(i,(function(){o._loadSegments(i,n)}))}))}unloadSegments(i){e.send(t,"unloadSegments"),(i=i||this._segmentIdArray)&&(this._viewer.getSegmentManager().unloadSegments(this._removeDuplication(i)),this._viewer.render())}hideComponentsBySegment(i){e.send(t,"hideComponentsBySegment"),this._viewer.getSegmentManager().hideComponentsBySegment(this._removeDuplication(i)),this._viewer.render()}showComponentsBySegment(i){e.send(t,"showComponentsBySegment"),this._viewer.getSegmentManager().showComponentsBySegment(this._removeDuplication(i)),this._viewer.render()}isolateComponentsBySegment(i,n){e.send(t,"isolateComponentsBySegment");var o=void 0,s=Glodon$1.Bimface.Plugins.Segment.IsolateOption;switch(n){case s.Hidden:o=this._viewer.getSegmentManager().getSegmentIsolateOption().HIDDEN;break;case s.Translucent:o=this._viewer.getSegmentManager().getSegmentIsolateOption().TRANSLUCENT;break;case s.PartlyTranslucent:o=this._viewer.getSegmentManager().getSegmentIsolateOption().PARTLYTRANSLUCENT}void 0!==o&&(this._viewer.getSegmentManager().isolateComponentsBySegment(this._removeDuplication(i),o),this._viewer.render())}disable(){this._viewer.getSegmentManager().disable(),this._viewer.render()}enable(){this._viewer.getSegmentManager().enable(),this._viewer.render()}getSegementIds(t){if(!this._segmentInfoAcquired)return console.error("Call the function getSegmentInfo() first!"),null;var e=this._segmentIdMapFromComponentId;if(e[t])return e[t];for(var i=Object.keys(this._elementIdMap),n=0,o=i.length;n<o;n++){var s=i[n];if(!this._traversedSegmentIdMap[s]){this._traversedSegmentIdMap[s]=!0;for(var r=this._elementIdMap[s],a=0,l=r.length;a<l;a++){var h=r[a];e[h]||(e[h]=[]),e[h].push(s)}}}var c=this._viewer.getSegmentManager().getSegmentIdsByPartialElementId(t);return c&&(e[t]=c),e[t]}}}(),function(){var t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.Dom"),e=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.AxisGrid");e.HighlightBorderLines=class{constructor(t){this.svgContainer=t,this.initialize(),this.visibility=!1}initialize(){var e=t.createNS("line","bf-axisgrid-line"),i=e.cloneNode();i.style.strokeWidth=1,i.style.stroke="#ffffff",i.style.opacity=.5,this.svgContainer.appendChild(i),this.lineLeft=i;var n=e.cloneNode();n.style.strokeWidth=1,n.style.stroke="#ffffff",n.style.opacity=.5,this.svgContainer.appendChild(n),this.lineRight=n}updateBorderLeft(t,e){var i=new THREE.Vector2(t.x,t.y),n=new THREE.Vector2(e.x,e.y);t.y==e.y?(i.y-=2,n.y-=2):(i.x-=2,n.x-=2),this.moveLineTo(this.lineLeft,i,n)}updateBorderRight(t,e){var i=new THREE.Vector2(t.x,t.y),n=new THREE.Vector2(e.x,e.y);t.y==e.y?(i.y+=2,n.y+=2):(i.x+=2,n.x+=2),this.moveLineTo(this.lineRight,i,n)}hide(){this.lineLeft.style.display="none",this.lineRight.style.display="none",this.visibility=!1}show(){this.lineLeft.style.display="block",this.lineRight.style.display="block",this.visibility=!0}update(t,e){0!=this.visibility&&(this.updateBorderLeft(t,e),this.updateBorderRight(t,e))}moveLineTo(t,e,i){t.setAttribute("x1",e.x),t.setAttribute("y1",e.y),t.setAttribute("x2",i.x),t.setAttribute("y2",i.y)}}}(),function(){var t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.Dom"),e=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.AxisGrid");e.HighlightLine=class{constructor(t,e){this.svgContainer=t,this.viewer=e,this.borderline=new Glodon$1.Bimface.Plugins.AxisGrid.HighlightBorderLines(t),this.initialize(),this.visibility=!1}initialize(){var e=t.createNS("line","bf-axisgrid-line");e.style.strokeWidth=2,e.style.stroke="#32D5A7",this.svgContainer.appendChild(e),this.line=e}hide(){this.line.style.display="none",this.borderline.hide(),this.visibility=!1}show(){this.line.style.display="block",this.borderline.show(),this.visibility=!0}setLine(t){this.highlightLine=t}setHeight(t){this.axisgridHeight=t}update(){if(0!=this.visibility){var t=this.highlightLine,e=new THREE.Vector3(t[0],t[1],this.axisgridHeight),i=new THREE.Vector3(t[3],t[4],this.axisgridHeight),n=this.worldPointsToClient(e,i);n&&(this.moveLineTo(this.line,n.start,n.end),this.borderline.update(n.start,n.end))}}worldPointsToClient(t,e){var i=this.viewer.getDomElement().getBoundingClientRect(),n=this.viewer.getViewer().worldPointsToClient(t,e);return n&&(n.start.x-=i.left,n.start.y-=i.top,n.end.x-=i.left,n.end.y-=i.top),n}moveLineTo(t,e,i){t.setAttribute("x1",e.x),t.setAttribute("y1",e.y),t.setAttribute("x2",i.x),t.setAttribute("y2",i.y)}}}(),function(){var t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.Dom"),e=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.AxisGrid");e.HighlightIntersectLines=class{constructor(t,e){this.svgContainer=t,this.viewer=e,this.horizBorderline=new Glodon$1.Bimface.Plugins.AxisGrid.HighlightBorderLines(t),this.verticalBorderline=new Glodon$1.Bimface.Plugins.AxisGrid.HighlightBorderLines(t),this.initialize(),this.visibility=!1}initialize(){var e=t.createNS("line","bf-axisgrid-line"),i=e.cloneNode();i.style.strokeWidth=2,i.style.stroke="#32D5A7",this.svgContainer.appendChild(i),this.svgHorizLine=i;var n=e.cloneNode();n.style.strokeWidth=2,n.style.stroke="#32D5A7",this.svgContainer.appendChild(n),this.svgVerticalLine=n;var o=t.createNS("circle","bf-axisgrid-point");o.setAttribute("r",3),o.setAttribute("fill","#32D5A7"),this.svgContainer.appendChild(o),this.hoverPoint=o,this.hide()}setLine(t,e){this.horizLine=t,this.verticalLine=e}setPoint(t){this.intersectPoint=t}setHeight(t){this.axisgridHeight=t}update(){if(0!=this.visibility){var t=this.horizLine,e=this.verticalLine,i=this.viewer.worldToClient(this.intersectPoint),n=new THREE.Vector3(t[0],t[1],this.axisgridHeight),o=new THREE.Vector3(t[3],t[4],this.axisgridHeight),s=new THREE.Vector3(e[0],e[1],this.axisgridHeight),r=new THREE.Vector3(e[3],e[4],this.axisgridHeight),a=this.worldPointsToClient(n,o);a&&(this.moveLineTo(this.svgHorizLine,a.start,a.end),this.horizBorderline.update(a.start,a.end));var l=this.worldPointsToClient(s,r);l&&(this.moveLineTo(this.svgVerticalLine,l.start,l.end),this.verticalBorderline.update(l.start,l.end)),this.movePointTo(this.hoverPoint,i.x,i.y)}}worldPointsToClient(t,e){var i=this.viewer.getDomElement().getBoundingClientRect(),n=this.viewer.getViewer().worldPointsToClient(t,e);return n&&(n.start.x-=i.left,n.start.y-=i.top,n.end.x-=i.left,n.end.y-=i.top),n}hide(){this.svgHorizLine.style.display="none",this.svgVerticalLine.style.display="none",this.hoverPoint.style.display="none",this.horizBorderline.hide(),this.verticalBorderline.hide(),this.visibility=!1}show(){this.svgHorizLine.style.display="block",this.svgVerticalLine.style.display="block",this.hoverPoint.style.display="block",this.horizBorderline.show(),this.verticalBorderline.show(),this.visibility=!0}moveLineTo(t,e,i){t.setAttribute("x1",e.x),t.setAttribute("y1",e.y),t.setAttribute("x2",i.x),t.setAttribute("y2",i.y)}movePointTo(t,e,i){t.setAttribute("cx",e),t.setAttribute("cy",i)}}}(),function(){var t=Glodon$1.Bimface.Data.StatisticsDataManager.getInstance(),e=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.Dom"),i=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.AxisGrid");i.AxisGridManager=class{constructor(i){t.send("Bimface.Plugins.AxisGrid","AxisGridManager"),this.snapMinDistance=5,this.viewer=i.viewer,this.registerEvent(),this.domContainer=e.create("div","bf-axisgrid-conext"),this.domContainer.style.position="absolute",this.domContainer.style.left=0,this.domContainer.style.top=0,this.domContainer.style.width="100%",this.domContainer.style.height="100%",this.svgContainer=e.createNS("svg","bf-axisgrid-svg"),this.svgContainer.style.width="100%",this.svgContainer.style.height="100%",this.domContainer.appendChild(this.svgContainer),this.viewer.getDomElement().appendChild(this.domContainer);var n=Glodon$1.Bimface.Plugins.AxisGrid;this.highlightLine=new n.HighlightLine(this.svgContainer,this.viewer),this.highlightIntersectLines=new n.HighlightIntersectLines(this.svgContainer,this.viewer)}registerEvent(){var t=Glodon$1.Bimface.Viewer.Viewer3DEvent,e=this,i=this.viewer.getEventManager(),n=null;const o="AxisGrids";function s(s){var r=!0,a=s.point,l=s.height,h=s.snapLines,c=s.nearestPoint,d=h.intersectLines,u=h.gridLine,p=e.viewer.worldToClient(a),g=e.viewer.worldToClient(c.toGridLine),m=e.viewer.worldToClient(c.toIntersection),f=e.distance(p,g),w=e.distance(p,m),v=null;if(w<=e.snapMinDistance&&void 0!==d){e.highlightIntersectLines.show(),e.highlightLine.hide();var y=d[0],b=d[1];v=y.name+"-"+b.name,e.highlightIntersectLines.setHeight(l),e.highlightIntersectLines.setLine(y,b),e.highlightIntersectLines.setPoint(c.toIntersection),e.highlightIntersectLines.update()}else f<=e.snapMinDistance?(v=u.name,e.highlightLine.show(),e.highlightIntersectLines.hide(),e.highlightLine.setHeight(l),e.highlightLine.setLine(u),e.highlightLine.update(l)):(n=null,e.highlightLine.hide(),e.highlightIntersectLines.hide(),r=!1);return n!=v&&(w<=e.snapMinDistance||f<=e.snapMinDistance)&&(i.fireEvent(t.Hover,{objectType:o,objectId:v,worldPosition:a}),n=v),r}this.viewer.addEventListener(t.AxisGridHover,(function(t){for(const e of t.snaps){if(s(e))break}})),this.viewer.addEventListener(t.Rendered,(function(){var t=t||window.event,i=e.viewer.getViewer(),n=i.getScene();if(!n.axisGridEnableHover)return e.highlightLine.hide(),void e.highlightIntersectLines.hide();e.viewer.getModels().forEach((o=>{let r=o.modelId;var a=CLOUD.AxisGridManager.getInstance(n,r);if(t&&"mousewheel"==t.type){var l=n.getMatrixGlobal(),h=new THREE.Vector2(t.clientX,t.clientY),c=i.cameraControl.getRaycaster(h.x,h.y),d=a.getIntersectPoints(c,l),u=a.snapOnFloors(d);if(u&&0==u.length)return e.highlightLine.hide(),void e.highlightIntersectLines.hide();for(const t of u){if(s(t))break}}})),e.highlightLine.update(),e.highlightIntersectLines.update()}))}distance(t,e){var i=t.x-e.x,n=t.y-e.y,o=t.z-e.z;return Math.sqrt(i*i+n*n+o*o)}}}(),Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.AxisGrid").AxisGridManagerConfig=function(){return{viewer:null}},function(){Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.Dom");var t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.RoomEditing");t.EditPoint=class{constructor(t,e,i){this.viewer3D=t,this.worldPosition=!0===i?null:e,this.clientPosition=!0===i?e:null,this.svgElement=null,this.xmlns="http://www.w3.org/2000/svg",this.glodonColor="#11DAB7",this.gridHighlightColor="#FF7F00",this.observer=function(){},this.uuid=-1,this.initialize()}initialize(){this.worldPosition?this.clientPosition=this.viewer3D.worldToClient(this.worldPosition):this.worldPosition=this.viewer3D.clientToWorld(this.clientPosition);let t=document.createElementNS(this.xmlns,"circle");t.setAttribute("r",3),t.setAttribute("style","stroke: "+this.glodonColor+"; stroke-width: 1; fill: #ffffff"),t.setAttribute("transform","translate("+this.clientPosition.x+","+this.clientPosition.y+")"),this.svgElement=t}setObserver(t){this.observer=t}hightlight(){this.svgElement.style.stroke=this.gridHighlightColor}cancelHightlight(){this.svgElement.style.stroke=this.glodonColor}distanceTo(t){let e=t.x-this.clientPosition.x,i=t.y-this.clientPosition.y;return Math.sqrt(e*e+i*i)}detach(){this.svgElement.parentNode.removeChild(this.svgElement)}update(t){1==t?this.worldPosition=this.viewer3D.clientToWorld(this.clientPosition):this.clientPosition=this.viewer3D.worldToClient(this.worldPosition),this.svgElement.setAttribute("transform","translate("+this.clientPosition.x+","+this.clientPosition.y+")")}isEqualWith(t){return t.uuid==this.uuid}getWorldPosition(){let t=this.worldPosition;return[t.x,t.y,t.z]}getClientPosition(){return new THREE.Vector2(this.clientPosition.x,this.clientPosition.y)}setClientPosition(t){this.clientPosition.x=t.x,this.clientPosition.y=t.y}getSvgElement(){return this.svgElement}}}(),function(){Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.Dom");var t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.RoomEditing");t.EditEdge=class{constructor(t){this.svgElement=null,this.xmlns="http://www.w3.org/2000/svg",this.gridHighlightColor="#FF7F00",this.editPoints=t,this.initialize(),this.hide()}initialize(){let t=this.editPoints[0],e=this.editPoints[1],i=document.createElementNS(this.xmlns,"line");i.setAttribute("stroke",this.gridHighlightColor),i.setAttribute("stroke-width",3),i.setAttribute("x1",t.getClientPosition().x+""),i.setAttribute("y1",t.getClientPosition().y+""),i.setAttribute("x2",e.getClientPosition().x+""),i.setAttribute("y2",e.getClientPosition().y+""),this.svgElement=i}show(){this.update(),this.svgElement.style.display="block"}hide(){this.svgElement.style.display="none"}update(){let t=this.editPoints[0],e=this.editPoints[1];this.svgElement.setAttribute("x1",t.getClientPosition().x+""),this.svgElement.setAttribute("y1",t.getClientPosition().y+""),this.svgElement.setAttribute("x2",e.getClientPosition().x+""),this.svgElement.setAttribute("y2",e.getClientPosition().y+"")}detach(){this.svgElement.parentNode.removeChild(this.svgElement)}startWithNull(){return null==this.editPoints[0]}endWith(t){return this.editPoints[1].isEqualWith(t)}distanceTo(t){let e=t.x-this.clientPosition.x,i=t.y-this.clientPosition.y;return Math.sqrt(e*e+i*i)}getSvgElement(){return this.svgElement}}}(),function(){Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.Dom");var t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.RoomEditing");t.Boundary=class{constructor(t){this.editPoints=t,this.polyline=null,this.xmlns="http://www.w3.org/2000/svg",this.glodonColor="#11DAB7",this.boundaryHighlightColor="#FF7F00",this.initialize()}initialize(){this.setObserver();let t=this.formatPolyline(this.editPoints),e=document.createElementNS(this.xmlns,"polyline");e.setAttribute("stroke",this.glodonColor),e.setAttribute("stroke-width",2),e.style.fill=this.glodonColor,e.style.fillOpacity="0.4",e.setAttribute("points",t),this.polyline=e}setObserver(){this.updateBinded=this.update.bind(this);for(const t of this.editPoints)t.setObserver(this.updateBinded)}formatPolyline(t){let e="";for(let i of t){let t=i.getClientPosition();e+=t.x+","+t.y,e+=" "}let i=t[0].getClientPosition();return e+=i.x+","+i.y,e+=" ",e}update(){let t=this.formatPolyline(this.editPoints);this.polyline.setAttribute("points",t)}rebuild(t){this.editPoints=t,this.initialize()}getSvgElement(){return this.polyline}}}();class RoomEditingUtil{constructor(){}}RoomEditingUtil.distanceToSegment=function(t,e,i){let n=this.nearestPointOnSegment(t,e,i);return t.distanceTo(n)},RoomEditingUtil.nearestPointOnSegment=function(t,e,i){var n=e.distanceToSquared(i);if(0==n)return t.distanceTo(e);var o=((t.x-e.x)*(i.x-e.x)+(t.y-e.y)*(i.y-e.y))/n;o=Math.max(0,Math.min(1,o));let s=new THREE.Vector2;return s.x=e.x+o*(i.x-e.x),s.y=e.y+o*(i.y-e.y),s};class Drawable{constructor(t){this.drawables=[],this.drawableStyle=t,this.style={},this.id="",this.hitTestEpsilon=10,this.highlightColor="#FFF227",this.grayColor="#BBBBBB"}attach(t){this.drawables.forEach((e=>{if(e instanceof Drawable)for(const i of e.getDrawables())t.appendChild(i);else t.appendChild(e)}))}detach(){for(const e of this.drawables){if(e instanceof Drawable)for(const i of e.getDrawables()){var t;(t=i.parentNode)&&t.removeChild(i)}else(t=e.parentNode)&&t.removeChild(e),this.drawables=[]}}hitTest(t){}setDefault(){}select(t){}setGray(){}magnify(){}resetSize(){}hide(){}show(){}isArrow(){return!1}getId(){return this.id}getDrawables(){return this.drawables}toVector2(t){return new THREE.Vector2(t.x,t.y)}toVector3(t){return new THREE.Vector3(t.x,t.y,t.z)}}class Arrow extends Drawable{constructor(t){super(),this.id=t.id,this.color=t.color,this.length=t.length||130,this.markerWidth=t.markerWidth||4,this.markerHeight=t.markerHeight||4,this.lineWidth=t.lineWidth||4,this.start=null,this.target=null}update(t,e){this.drawables=[];let i=MeasureUtil.makeMarker({id:this.id,color:this.color,markerWidth:this.markerWidth,markerHeight:this.markerHeight});this.drawables.push(i);let n={color:this.color,lineWidth:`${this.lineWidth}px`,start:t,end:e};this.start=t,this.target=e;let o=MeasureUtil.makeLine(n);o.setAttribute("marker-end","url(#"+this.id+")"),this.drawables.push(o)}setDefault(){this.drawables[1].style.stroke=this.color,document.getElementById(this.id).children[0].style.fill=this.color}setGray(){this.drawables[1].style.stroke=this.grayColor,document.getElementById(this.id).children[0].style.fill=this.grayColor}select(){this.drawables[1].style.stroke=this.highlightColor,document.getElementById(this.id).children[0].style.fill=this.highlightColor}hitTest(t){let e=this.hitTestEpsilon;const i=new THREE.Vector3(t.x,t.y,0),n=new THREE.Line3(new THREE.Vector3(this.start.x,this.start.y,0),new THREE.Vector3(this.target.x,this.target.y,0)),o=new THREE.Vector3;return n.closestPointToPoint(i,!0,o),o.distanceTo(i)<=e?this:null}hide(){document.getElementById(this.id).children[0].style.display="none",this.drawables[1].style.display="none"}show(){this.drawables[1].style.display="block",document.getElementById(this.id).children[0].style.display="block"}getDirection(){let t=this.target.clone().sub(this.start).normalize();return new THREE.Vector3(t.x,t.y,0)}magnify(){let t=document.getElementById(this.id);t.setAttribute("markerWidth",6),t.setAttribute("markerHeight",6)}resetSize(){let t=document.getElementById(this.id);t.setAttribute("markerWidth",4),t.setAttribute("markerHeight",4)}isArrow(){return!0}}class EditHeight{constructor(){this.glodonColor="#32D3A6",this.highlightColor="#F99D0B",this.hitTestEpsilon=5,this.drawables=[],this.upSegment=[],this.downSegment=[]}update(t){this.drawables=[],this.upSegment=[],this.downSegment=[],this.points=t;for(let e=0;e<t.length;e++){let i=MeasureUtil.makeLine({start:t[e],end:t[(e+1)%4],lineWidth:"2px",color:this.glodonColor});this.drawables.push(i)}let e={},i=[...t,t[0]];e.points=MeasureUtil.calcPolylinePoints(i),e.width="1px",e.color="rgba(0,0,0,0)",e.fillColor="rgba(50, 211, 166, 0.1)";let n=MeasureUtil.makePolyline(e);this.drawables.push(n),this.upSegment.push(this.drawables[3]),this.downSegment.push(this.drawables[1]);let o=[new THREE.Vector2((t[0].x+t[3].x)/2,(t[0].y+t[3].y)/2),new THREE.Vector2((t[1].x+t[2].x)/2,(t[1].y+t[2].y)/2)],s=10,r=0,a=["1","2","3","4"];for(const t of o){let e=new Arrow({id:a[r++],color:this.glodonColor,length:8,lineWidth:3,markerWidth:4,markerHeight:4});e.update(t,t.clone().add(new THREE.Vector2(0,s))),s*=-1,e.getDrawables().forEach((t=>{this.drawables.push(t),r<=2&&this.upSegment.push(t),r>2&&this.downSegment.push(t)})),e.id=a[r++],e.update(t,t.clone().add(new THREE.Vector2(0,s))),s*=-1,e.getDrawables().forEach((t=>{this.drawables.push(t),r<=2&&this.upSegment.push(t),r>2&&this.downSegment.push(t)}))}}hitTest(t){let e=new THREE.Vector2(t.x,t.y),i=this.points[0],n=this.points[3],o=this.points[1],s=this.points[2],r=[];r.push(new THREE.Vector2(i.x,i.y)),r.push(new THREE.Vector2(n.x,n.y));let a=[];a.push(new THREE.Vector2(o.x,o.y)),a.push(new THREE.Vector2(s.x,s.y));let l=RoomEditingUtil.distanceToSegment(e,r[0],r[1]);return l<=this.hitTestEpsilon?"up-segment":(l=RoomEditingUtil.distanceToSegment(e,a[0],a[1]),l<=this.hitTestEpsilon?"down-segment":null)}detach(){for(const e of this.drawables){var t=e.parentNode;t&&t.removeChild(e),this.drawables=[]}}getDrawables(){return this.drawables}highlight(t){let e="up-segment"==t?this.upSegment:this.downSegment;for(const t of[0,2,4])e[t].style.stroke=this.highlightColor;let i="up-segment"==t?["1","2"]:["3","4"];for(const t of i){document.getElementById(t).children[0].style.fill=this.highlightColor}}cancelHighlight(){for(const t of[0,2,4])this.upSegment[t].style.stroke=this.glodonColor,this.downSegment[t].style.stroke=this.glodonColor;for(const t of["1","2","3","4"]){document.getElementById(t).children[0].style.fill=this.glodonColor}}}!function(){var t=Glodon$1.Bimface.Data.StatisticsDataManager.getInstance(),e=(Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.Dom"),Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.RoomEditing"));e.RoomData=class{constructor(e,i){t.send("Bimface.Plugins.RoomEditing","RoomData"),this.viewer=e,this.roomBoundary=i,this.editHeight=null,this.editPoints=[],this.editEdges=[],this.boundary=null,this.editPointUuid=0,this.onEditPointDeletion=null,this.onEditPointAddition=null,this.isEditHeightEnabled=!1,this.roomHeightOffset={from:0,to:0}}build(){if(this.isEditHeightEnabled)!this.editHeight&&this.makeHeight();else{this.makeEditPoints(),this.makeEditEdges(),this.makeBoundary();let t=new Glodon$1.Bimface.Plugins.SpatialRelation.Room({viewer:this.viewer}).getRoomBoundingBoxById(this.editRoomId);this.roomHeightOffset.from=t.min.z,this.roomHeightOffset.to=t.max.z}}makeHeight(){this.editHeight=new EditHeight;let t=new Glodon$1.Bimface.Plugins.SpatialRelation.Room({viewer:this.viewer}).getRoomBoundingBoxById(this.editRoomId);this.roomHeightOffset.from=t.min.z,this.roomHeightOffset.to=t.max.z}makeEditPoints(){for(let t=0;t<this.roomBoundary.length-1;t++){const i=this.roomBoundary[t];let n=new THREE.Vector3(i[0],i[1]),o=new e.EditPoint(this.viewer,n);o.uuid=this.editPointUuid++,this.editPoints.push(o)}}deleteEditPoint(t){for(let e=0;e<this.editPoints.length;e++){let i=this.editPoints[e];if(i.isEqualWith(t)){i.detach(),this.editPoints.splice(e,1),this.onEditPointDeletion(i);break}}}addEditPoint(t,i){let n=t.editPoints[0],o=t.editPoints[1];t.detach();let s=this.editEdges.findIndex((t=>t.endWith(o)));this.editEdges.splice(s,1);let r=this.editPoints.findIndex((t=>t.isEqualWith(n))),a=new THREE.Vector2(i.x,i.y),l=new e.EditPoint(this.viewer,a,!0);l.uuid=this.editPointUuid++,this.editPoints.splice(r+1,0,l);let h=new e.EditEdge([n,l]);this.editEdges.splice(s,0,h);let c=new e.EditEdge([l,o]);this.editEdges.splice(s+1,0,c),this.onEditPointAddition()}getEditPointCounts(){return this.editPoints.length}makeEditEdges(){for(let t=0;t<this.editPoints.length;t++){let i=[];i.push(this.editPoints[t]);let n=t==this.editPoints.length-1?0:t+1;i.push(this.editPoints[n]);let o=new e.EditEdge(i);this.editEdges.push(o)}}mergeEditEdges(t,i){i=null==i?2:i;let n=this.editEdges[t],o=this.editEdges[(t+i-1)%this.editEdges.length],s=[];s.push(n.editPoints[0]),s.push(o.editPoints[1]);let r=new e.EditEdge(s);this.editEdges.splice(t,0,r),this.editEdges.splice(t+1,i)}makeBoundary(){let t=this.editPoints;this.boundary=new e.Boundary(t)}getEditPoints(){return this.editPoints}getEditEdges(){return this.editEdges}getBoundary(){return this.boundary}getEditHeight(){return this.editHeight}setEditRoomId(t){this.editRoomId=t}getRoomSectionPoints(){let t=new Glodon$1.Bimface.Plugins.SpatialRelation.Room({viewer:this.viewer}).getRoomBoundingBoxById(this.editRoomId),e=t.min,i=t.max,n=[],o=(e.y+i.y)/2;n.push(new THREE.Vector3(e.x,o,this.roomHeightOffset.to)),n.push(new THREE.Vector3(e.x,o,this.roomHeightOffset.from)),n.push(new THREE.Vector3(i.x,o,this.roomHeightOffset.from)),n.push(new THREE.Vector3(i.x,o,this.roomHeightOffset.to));let s=[];for(const t of n)s.push(this.viewer.worldToClient(t));return this.roomHeightOnCanvas=s[1].y-s[0].y,s}updateRoomHeightOffset(t,e){let i=this.roomHeightOnCanvas,n=(this.roomHeightOffset.to-this.roomHeightOffset.from)/i,o=100;"m"===this.viewer._defaultUnit&&(o/=1e3),"up-segment"===t?(this.roomHeightOffset.to-=e.y*n,this.roomHeightOffset.to<this.roomHeightOffset.from+o&&(this.roomHeightOffset.to=this.roomHeightOffset.from+o)):(this.roomHeightOffset.from-=e.y*n,this.roomHeightOffset.from>this.roomHeightOffset.to-o&&(this.roomHeightOffset.from=this.roomHeightOffset.to-o))}getRoomHeightOffset(){return[this.roomHeightOffset.from,this.roomHeightOffset.to]}}}(),function(){var t=Glodon$1.Bimface.Data.StatisticsDataManager.getInstance(),e=(Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.Dom"),Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.RoomEditing"));e.RoomView=class{constructor(e,i){t.send("Bimface.Plugins.RoomEditing","RoomView"),this.roomData=e,this.svgContainer=i,this.eventManager=null;let n=this;this.roomData.onEditPointDeletion=function(t){n.detachDrawables(),n.updateBoundary(),n.updateEditEdges(t),n.attachDrawables()},this.roomData.onEditPointAddition=function(){n.detachDrawables(),n.updateBoundary(),n.attachDrawables()}}setEventManager(t){this.eventManager=t}getEventManager(){return this.eventManager}getData(){return this.roomData}attachDrawables(){if(this.roomData.isEditHeightEnabled){let t=this.roomData.getEditHeight().getDrawables();for(const e of t)this.svgContainer.appendChild(e);return}let t=this.roomData.getBoundary().getSvgElement();this.svgContainer.appendChild(t);for(const t of this.roomData.getEditEdges())this.svgContainer.appendChild(t.getSvgElement());for(const t of this.roomData.getEditPoints())this.svgContainer.appendChild(t.getSvgElement())}detachDrawables(){let t=this.svgContainer.children;for(;t.length>0;){let e=t[0];this.svgContainer.removeChild(e)}}update(){if(this.roomData.isEditHeightEnabled){return this.roomData.getEditHeight().update(this.roomData.getRoomSectionPoints()),this.detachDrawables(),void this.attachDrawables()}for(const t of this.roomData.getEditPoints())t.update();for(const t of this.roomData.getEditEdges())t.update();this.roomData.getBoundary().update()}updateBoundary(){let t=this.roomData.getBoundary();t.setObserver(),t.update()}updateEditEdges(t){let e=this.roomData.getEditEdges().findIndex((e=>e.endWith(t)));this.roomData.mergeEditEdges(e,2)}addCloudViewerEvents(t){this.updateBinded=this.update.bind(this),t.registerEventListener(CLOUD.EVENTS.ON_EDITOR_ZOOM,this.updateBinded),t.registerEventListener(CLOUD.EVENTS.ON_EDITOR_PANING,this.updateBinded)}removeCloudViewerEvents(t){t.unregisterEventListener(CLOUD.EVENTS.ON_EDITOR_ZOOM,this.updateBinded),t.unregisterEventListener(CLOUD.EVENTS.ON_EDITOR_PANING,this.updateBinded)}}}(),function(){Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.Dom");var t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.RoomEditing");t.PickEditor=class{constructor(t){this.roomView=t,this.roomData=t.getData(),this.snapEditPoint=null}begin(t){let e=new THREE.Vector3(t.x,t.y),i=this.snaping(e);this.snapEditPoint=i}onEditing(t){let e=new THREE.Vector3(t.x,t.y);if(null!=this.snapEditPoint)this.snapEditPoint.setClientPosition(e),this.snapEditPoint.update(!0),this.snapEditPoint.observer();else{let t=this.snaping(e);t?t.hightlight():this.cancelHightlight()}}end(t){this.snapEditPoint=null}snaping(t){for(const e of this.roomData.getEditPoints())if(e.distanceTo(t)<=5)return e;return null}cancelHightlight(){for(const t of this.roomData.getEditPoints())t.cancelHightlight()}}}(),function(){Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.Dom");var t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.RoomEditing");t.AdditionEditor=class{constructor(t){this.roomView=t,this.roomData=t.getData(),this.snapEditEdge=null,this.beginPoint=new THREE.Vector2,this.eventManager=this.roomView.getEventManager()}begin(t){this.beginPoint.set(t.x,t.y),this.snapEditEdge=this.snaping(this.beginPoint)}onEditing(t){let e=new THREE.Vector2(t.x,t.y);if(null==this.snapEditEdge){let t=this.snaping(e);t?(this.hideAllEdges(),t.show(),this.eventManager.fireEvent("RoomEditorAddEnter")):(this.hideAllEdges(),this.eventManager.fireEvent("RoomEditorAddExit"))}else this.eventManager.fireEvent("RoomEditorAddExit")}end(t){if(null==this.snapEditEdge)return;let e=new THREE.Vector2(t.x,t.y);if(!1===e.equals(this.beginPoint))return void(this.snapEditEdge=null);let i=this.snapEditEdge.editPoints[0].getClientPosition(),n=this.snapEditEdge.editPoints[1].getClientPosition();this.roomData.addEditPoint(this.snapEditEdge,RoomEditingUtil.nearestPointOnSegment(e,i,n)),this.snapEditEdge=null}hideAllEdges(){for(const t of this.roomData.getEditEdges())t.hide()}snaping(t){let e=null,i=Number.MAX_SAFE_INTEGER;for(const n of this.roomData.getEditEdges()){let o=n.editPoints[0].getClientPosition(),s=n.editPoints[1].getClientPosition(),r=RoomEditingUtil.distanceToSegment(t,o,s);r<i&&(i=r,e=n)}return i<=5?e:null}}}(),function(){Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.Dom");var t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.RoomEditing");t.DeletionEditor=class{constructor(t){this.roomView=t,this.roomData=t.getData(),this.snapEditPoint=null,this.beginPoint=new THREE.Vector2,this.eventManager=this.roomView.getEventManager()}begin(t){this.beginPoint.set(t.x,t.y),this.snapEditPoint=this.snaping(this.beginPoint)}onEditing(t){let e=new THREE.Vector3(t.x,t.y);if(null==this.snapEditPoint){let t=this.snaping(e);t?(t.hightlight(),this.eventManager.fireEvent("RoomEditorDeleteEnter")):(this.cancelHightlight(),this.eventManager.fireEvent("RoomEditorDeleteExit"))}else this.eventManager.fireEvent("RoomEditorDeleteExit")}end(t){if(null==this.snapEditPoint)return;if(!1!==new THREE.Vector2(t.x,t.y).equals(this.beginPoint)){if(this.roomData.getEditPointCounts()<=3)return this.eventManager.fireEvent("DeletionError"),void(this.snapEditPoint=null);this.roomData.deleteEditPoint(this.snapEditPoint),this.snapEditPoint=null}else this.snapEditPoint=null}snaping(t){for(const e of this.roomData.getEditPoints())if(e.distanceTo(t)<=5)return e;return null}cancelHightlight(){for(const t of this.roomData.getEditPoints())t.cancelHightlight()}}}();class HeightAdjustmentEditor{constructor(t){this.roomView=t,this.roomData=t.getData(),this.snapSegmentId=null,this.lastPoint=new THREE.Vector2,this.beginPoint=new THREE.Vector2}begin(t){this.beginPoint.set(t.x,t.y),this.snapSegmentId=this.snaping(this.beginPoint),this.lastPoint.set(t.x,t.y)}onEditing(t){let e=new THREE.Vector2(t.x,t.y),i=this.roomData.getEditHeight();if(null==this.snapSegmentId){let t=this.snaping(e);t?i.highlight(t):i.cancelHighlight()}else{let t=e.clone().sub(this.lastPoint);this.roomData.updateRoomHeightOffset(this.snapSegmentId,t),this.roomView.update(),i.highlight(this.snapSegmentId),this.lastPoint.set(e.x,e.y)}}end(t){if(null==this.snapSegmentId)return;new THREE.Vector2(t.x,t.y).equals(this.beginPoint),this.snapSegmentId=null}snaping(t){return this.roomData.getEditHeight().hitTest(t)}cancelHightlight(){this.roomData.getEditHeight().cancelHightlight()}}!function(){var t=Glodon$1.Bimface.Data.StatisticsDataManager.getInstance(),e=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.Dom"),i=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.RoomEditing");i.RoomEditor=class{constructor(e){t.send("Bimface.Plugins.RoomEditing","RoomEditor"),this.bIsOnEditing=!1,this.viewer=e.viewer,this.lastAnimationState=null,this.restoreCameraStatus=null,this.roomInfo=this.viewer.mapCustomizedRoom[e.roomId],this.roomId=e.roomId,this.restoreStates={camera:null,sectionPlane:null},this.mapUIVisibility={"bf-tree-toolbar":"none","bf-modelTree-panel":"none","bf-toolbar-bottom":"none","bf-property-panel":"none","bf-measurement-panel":"none","bf-sectionPlane-panel":"none","bf-pickSectionPlane-panel":"none","bf-sectionBox-panel":"none","bf-settings-panel":"none","bf-basicInfo-panel":"none","bf-map-panel":"none"},this.initialize(),this.scratchVector=new THREE.Vector3,this.scratchVector_1=new THREE.Vector3}initialize(){this.domContainer=e.create("div","bf-RoomEditor-conext"),this.domContainer.style.position="absolute",this.domContainer.style.left=0,this.domContainer.style.top=0,this.domContainer.style.width="100%",this.domContainer.style.height="100%",this.svgContainer=e.createNS("svg","bf-RoomEditor-svg"),this.svgContainer.style.width="100%",this.svgContainer.style.height="100%",this.domContainer.appendChild(this.svgContainer),this.viewer.getDomElement().appendChild(this.domContainer),this.addDomEventListeners(),this.offset=this.viewer.getDomElement().getBoundingClientRect();let t=this.viewer.getEventManager(),n=new Glodon$1.Bimface.Plugins.SpatialRelation.Room({viewer:this.viewer,hasInitialized:!0}).getBoundaryByRoomId(this.roomId);const o=(new THREE.Matrix4).fromArray(this.viewer.getDefaultModel().getModelTransformation());for(let t=0;t<n.length;t++){let e=(new THREE.Vector3).fromArray(n[t]);e.applyMatrix4(o),n[t]=e.toArray()}this.roomData=new i.RoomData(this.viewer,n),this.roomData.setEditRoomId(this.roomId),this.roomView=new i.RoomView(this.roomData,this.svgContainer),this.roomView.setEventManager(t),this.activeEditor=new i.PickEditor(this.roomView)}onEnter(){let t=this.viewer.getViewer();this.bIsOnEditing=!0,this.restoreCameraStatus=this.viewer.getCameraStatus(),this.lastAnimationState=this.viewer.getCameraAnimation(),this.recordUIVisibility(),this.viewer.setCameraAnimation(!0);let e=this;this.viewer.setView(Glodon$1.Bimface.Viewer.ViewOption.Top,(()=>{e.viewHouseVisibility=e.viewer._getViewHouseVisibility(),e.viewHouseVisibility&&e.viewer.hideViewHouse(),e.viewer._enableCursor(!1),t.getFilter().deactivateAll(),e.viewer._enableSelectionChanged(!1),e.viewer.setCameraAnimation(!1),e.viewer.setCameraType("OrthographicCamera"),e.viewer.enableOrbit(!1),e.viewer.hideRoomsById([this.roomId]),e.roomData.build(),e.roomView.attachDrawables(),e.roomView.addCloudViewerEvents(t),e.viewer.render()}))}recordUIVisibility(){let t=Object.keys(this.mapUIVisibility);for(const e of t){let t=document.getElementsByClassName(e);t.length>0&&(this.mapUIVisibility[e]=t[0].style.display)}}save(){let t=this.roomInfo.boundary.offsetZ,e=(this.roomInfo.offset,[]),i=[];const n=(new THREE.Matrix4).fromArray(this.viewer.getDefaultModel().getModelTransformation()),o=(new THREE.Matrix4).copy(n).invert();for(const n of this.roomData.getEditPoints()){let s=n.getWorldPosition();s[2]=t;let r=(new THREE.Vector3).fromArray(s);r.applyMatrix4(o),s=r.toArray(),e.push(s),i.push({x:s[0],y:s[1],z:t})}let s=this.viewer.createBoundary(e),r=this.roomData.getRoomHeightOffset();return{boundary:s,outerBoundary:i,height:r[1]-r[0],id:this.roomId}}checkIntersect(){let t=new THREE.Vector3,e=new THREE.Vector3(10,10),i=[];i.push(t,new THREE.Vector3(10,0),e,new THREE.Vector3(0,10));new Glodon$1.Bimface.Plugins.Geometry.PlaneBufferGeometry(i);let n=[];for(const t of this.roomData.getEditPoints()){let e=t.getWorldPosition(),i=new THREE.Vector2(e[0],e[1]);n.push(i)}return Glodon$1.Bimface.Plugins.Geometry.PlaneBufferGeometry.checkIntersect(n)}onExit(t){let e=this.viewer.getViewer();if(this.roomView.removeCloudViewerEvents(e),this.removeDomEventListeners(),this.roomView.detachDrawables(),this.bIsOnEditing=!1,this.viewHouseVisibility&&this.viewer.showViewHouse(),this.viewer._enableCursor(!0),this.viewer.setCameraAnimation(this.lastAnimationState),e.getFilter().activateAll(),this.viewer._enableSelectionChanged(!0),this.viewer.enableOrbit(!0),!0!==t){let t=this.save(),e=this.roomInfo.faceColor,i=this.roomInfo.frameColor;this.viewer.createRoom(t.boundary,t.height,t.id,e,i);let n=this.roomData.getRoomHeightOffset(),o=new Glodon$1.Bimface.Plugins.SpatialRelation.Room({viewer:this.viewer});o.setBottomHeightByRoomId(this.roomId,n[0]),o.setTopHeightByRoomId(this.roomId,n[1])}else this.viewer.showRoomsById([this.roomId]);this.viewer.setCameraType("PerspectiveCamera");let i=this.viewer._sectionPlane;if(i){i.setPlane("Z"),i.setDirection("Forward");let t=this.roomData.getRoomHeightOffset(),e=this.viewer.getViewer().getBoundingBoxWorld(),n=this.viewer.getViewer().getScene().getExpandScalar(),o=(new THREE.Box3).setFromCenterAndSize(e.getCenter(this.scratchVector),e.getSize(this.scratchVector_1).multiplyScalar(n)),s=o.min.z,r=o.max.z,a=10;"m"===this.viewer._defaultUnit&&(a/=1e3);let l=this._calcSectionPlaneProgress(s,r,t[1]+a);i.setProgress(l)}this.isInHeightEditor=!1;let n=this;this.viewer.setCameraStatus(this.restoreCameraStatus,(function(){n.viewer.render()}))}makeSectionPlane(){let t=new Glodon$1.Bimface.Plugins.SpatialRelation.Room({viewer:this.viewer}).getRoomBoundingBoxById(this.roomId),e=(t.min.y+t.max.y)/2,i=this.viewer.getViewer().getBoundingBoxWorld(),n=this._calcSectionPlaneProgress(i.min.y,i.max.y,e),o=this.viewer._sectionPlane;o&&(o.setPlane("Y"),o.setDirection("Reverse"),o.setProgress(n))}_calcSectionPlaneProgress(t,e,i){return 100-(i-t)/(e-t)*100}destroySectionPlane(){this.sectionPlane.exit(),this.sectionPlane=null}getIsOnEditing(){return this.bIsOnEditing}setBimfaceUIVisibility(t){let e=Object.keys(this.mapUIVisibility);for(const i of e){let e=document.getElementsByClassName(i);0!=e.length&&(e[0].style.display=0==t?"none":this.mapUIVisibility[i])}}addDomEventListeners(){this.onMouseDownBinded=this.onMouseDown.bind(this),this.onMouseMoveBinded=this.onMouseMove.bind(this),this.onMouseUpBinded=this.onMouseUp.bind(this),this.onMouseDoubleClickBinded=this.onMouseDoubleClick.bind(this),this.onWindowResizeBinded=this.onWindowResize.bind(this);let t=this.svgContainer;t.addEventListener("mousemove",this.onMouseMoveBinded,!1),t.addEventListener("mousedown",this.onMouseDownBinded,!1),document.addEventListener("mouseup",this.onMouseUpBinded,!1),t.addEventListener("dblclick",this.onMouseDoubleClickBinded,!1),window.addEventListener("resize",this.onWindowResizeBinded,!1)}removeDomEventListeners(){let t=this.svgContainer;t.removeEventListener("mousemove",this.onMouseMoveBinded),t.removeEventListener("mousedown",this.onMouseDownBinded),document.removeEventListener("mouseup",this.onMouseUpBinded),t.removeEventListener("dblclick",this.onMouseDoubleClickBinded),window.removeEventListener("resize",this.onWindowResizeBinded)}destroySvgContainer(){this.roomView.detachDrawables(),this.domContainer.removeChild(this.svgContainer),this.svgContainer=null,this.viewer.getDomElement().removeChild(this.domContainer),this.domContainer=null}activateEditor(t){switch(t){case"Pick":this.roomData.isEditHeightEnabled=!1,this.activeEditor=new i.PickEditor(this.roomView),this._activateFromHeightEditor();break;case"Add":this.roomData.isEditHeightEnabled=!1,this.activeEditor=new i.AdditionEditor(this.roomView),this._activateFromHeightEditor();break;case"Delete":this.roomData.isEditHeightEnabled=!1,this.activeEditor=new i.DeletionEditor(this.roomView),this._activateFromHeightEditor();break;case"Height":this.roomData.isEditHeightEnabled=!0,this._activateHeightEditor(),this.activeEditor=new HeightAdjustmentEditor(this.roomView)}}_activateFromHeightEditor(){if(!this.isInHeightEditor)return;let t=this.viewer.getCameraAnimation();this.viewer.setCameraAnimation(!1),this.viewer.setCameraStatus(this.restoreCameraStatus2,(()=>requestAnimationFrame((()=>{let e=this.viewer._sectionPlane;e&&(e.setPlane("Z"),e.setDirection("Forward"),e.setProgress(this.restoreSectionPlaneProgress)),this.roomView.detachDrawables(),this.roomView.attachDrawables(),this.viewer.render(),this.viewer.setCameraAnimation(t),this.roomView.update()})))),this.isInHeightEditor=!1}_activateHeightEditor(){this.isInHeightEditor=!0,this.restoreCameraStatus2=this.viewer.getCameraStatus(),this.viewer._sectionPlane&&(this.restoreSectionPlaneProgress=this.viewer._sectionPlane.getProgress()),this.makeSectionPlane();let t=this.viewer,e=this.roomView,i=this.viewer.getCameraAnimation();this.viewer.setCameraAnimation(!1),t.setView(Glodon$1.Bimface.Viewer.ViewOption.South,(()=>{let n=new Glodon$1.Bimface.Plugins.SpatialRelation.Room({viewer:t}).getRoomBoundingBoxById(this.roomId);t.zoomToBoundingBox(n,(function(){})),t.setCameraType("OrthographicCamera"),e.getData().build(),e.update(),this.viewer.setCameraAnimation(i)}))}activateByRoomId(t){this.isInHeightEditor=!1,this.roomId=t,this.roomInfo=this.viewer.mapCustomizedRoom[t];let e=new Glodon$1.Bimface.Plugins.SpatialRelation.Room({viewer:this.viewer,hasInitialized:!0}).getBoundaryByRoomId(t);this.roomData=new i.RoomData(this.viewer,e),this.roomData.setEditRoomId(t),this.roomView=new i.RoomView(this.roomData,this.svgContainer),this.roomView.setEventManager(this.viewer.getEventManager()),this.viewer.enableOrbit(!1),this.viewer._enableCursor(!1),this.activateEditor("Pick"),this.addDomEventListeners()}onMouseDown(t){if(t.button===THREE.MOUSE.LEFT){let e={x:t.clientX-this.offset.left,y:t.clientY-this.offset.top};this.activeEditor.begin(e)}}onMouseMove(t){let e={x:t.clientX-this.offset.left,y:t.clientY-this.offset.top};this.activeEditor.onEditing(e)}onMouseUp(t){if(t.button===THREE.MOUSE.LEFT){let e={x:t.clientX-this.offset.left,y:t.clientY-this.offset.top};this.activeEditor.end(e),t.preventDefault(),t.stopPropagation()}}onMouseDoubleClick(t){t.preventDefault(),t.stopPropagation()}onWindowResize(){this.roomView.update()}}}(),Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.RoomEditing").RoomEidtorConfig=function(){return{viewer:null,roomId:null}},function(){let t=Glodon$1.Bimface.Data.StatisticsDataManager.getInstance(),e=(Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.Dom"),Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.RevitHelpers"));e.DrawingHelper=class{constructor(e){t.send("Bimface.Plugins.RevitHelpers","DrawingHelper"),this.viewer3D=e.viewer,this.databagId=e.viewer._data.databagId,this.dataViews=null,this.integrateDataViews={},this.drawingViews=[],this.drawingIds=[],this.drawingList=[],this.integrateDrawingList={},this._config=e,this.mapDrawingVisibility={},this.mapDrawingObject={},this.supportViewTypeMap={FloorPlan:!0,Elevation:!0,Section:!0};let i=e.viewer.getViewer().getScene();this.customPlaneManager=CLOUD.CustomPlaneManager.getInstance(i),this.initialize()}initialize(){let t=this;"integrateModel"==this.viewer3D._data.modelType&&null!=this.viewer3D._data.integrateDrawings?t._config.viewer.getLinksJson((function(e){e&&t.formatLinksData(e)})):"singleModel"==this.viewer3D._data.modelType&&this.getViews((function(i){let n=JSON.parse(i).viewList;for(let i=0;i<n.length;i++){const s=n[i];if(s.preview.path&&t.supportViewTypeMap[s.viewType]){t.drawingIds.push(s.id);var o=e.DrawingView.toObject(s.viewPoint);o.origin.z+=s.elevation,t.drawingList.push({id:s.id,name:s.name,viewPort:o}),t.drawingViews.push(s)}}}))}createDrawingView(){return new e.DrawingView(this.viewer3D,this.drawingViews)}formatLinksData(t){let e={},i=(t,o)=>{for(let s=0;s<t.length;s++){let r,a=t[s],{linkTransform:l,fileId:h,name:c,links:d}=a;l.indexOf("]")>0?r=n(l,h,c,o):e[h]?e[h]instanceof Array?e[h].push(o):e[h]=[o,e[h]]:e[h]=o,d.length>0&&i(d,r)}},n=(t,i,n,o)=>{let s=new THREE.Matrix4;return t&&s.set.apply(s,JSON.parse(t)),s.transpose(),o&&s.premultiply(o),e[i]?e[i]instanceof Array?e[i].push(s):e[i]=[s,e[i]]:e[i]=s,s};for(let e=0;e<t.length;e++){let o,s=t[e],{linkTransform:r,fileId:a,name:l,links:h}=s;o=r.indexOf("]")>0?n(r,a,l):new THREE.Matrix4,h.length>0&&i(h,o)}this.transforms=e}getViews(t){if(this.dataViews)return void(t&&t(this.dataViews));let e=this;this.viewer3D.getDefaultModel()._getMetaDataManager().dataManager.getViews((function(i){e.dataViews=i,t&&t(i.data)}))}getViewsById(t,i){if(this.integrateDrawingList[t])return void(i&&i(this.integrateDrawingList[t]));let n=this;this.viewer3D.getDefaultModel()._getMetaDataManager().dataManager.getViewsById(t,(function(o){if(!o.data)return i&&i([]);n.integrateDataViews[t]=o,n.integrateDataViews.resourceHost=o.resourceHost;let s=JSON.parse(o.data).viewList,r=[];for(let t=0;t<s.length;t++){const i=s[t];if(i.preview.path&&n.supportViewTypeMap[i.viewType]){n.drawingIds.push(i.id);var a=e.DrawingView.toObject(i.viewPoint);a.origin.z+=i.elevation;var l={id:i.id,name:i.name,viewPort:a};r.push(l),n.drawingViews.push(i)}}n.drawingList=n.drawingList.concat(r),n.integrateDrawingList[t]=r,i&&i(r)}))}isInclude(t){return this.drawingIds.indexOf(t)>=0}getDrawingList(t,e){if(!t)return this.drawingList;this.getViewsById(t,(function(t){e&&e(t)}))}addDrawingsById(t,e,i){let n=this,o=0;for(let s=0;s<t.length;s++){const r=t[s];if(this.isInclude(r)){this.mapDrawingObject.hasOwnProperty(r)&&(this.removeDrawingsById([r]),console.warn("Duplicate id."));let s=this.createDrawingView();s.activeViewById(r);let a=this.drawingIds.indexOf(r),l=this.drawingViews[a],h=(this.dataViews||this.integrateDataViews).resourceHost+"/"+n.databagId+"/"+l.preview.path;if(null==l.preview.path)return void console.warn("No thumbnail in databag.");if(++o,l.id.indexOf(".")>0){let n=l.id.split(".")[0];if(this.transforms&&this.transforms[n])if(this.transforms[n].slice)for(let s=0,a=this.transforms[n];s<a.length;s++){let n=this.createDrawingView();n.activeViewById(r),n.setLinkFileTranslation(a[s]);let l=n.getOutline3D();this.addPlane(l,e,h,t,o,r,i,s+1==a.length,n)}else{s.setLinkFileTranslation(this.transforms[n]);let a=s.getOutline3D();this.addPlane(a,e,h,t,o,r,i,!0,s)}else{let n=s.getOutline3D();this.addPlane(n,e,h,t,o,r,i,!0,s)}}else{let a=s.getOutline3D();this.addPlane(a,e,h,t,o,r,(function(){n.viewer3D.render(),i&&i()}),!0,s)}}}}addPlane(t,e,i,n,o,s,r,a,l){let h=this;this.customPlaneManager.addPlane(t.min,t.max,i,(function(t){h.mapDrawingObject[s]||(h.mapDrawingObject[s]=[]),"number"!=typeof e&&(e=0),l.update(t,e),l=null,h.mapDrawingObject[s].push(t),a&&o==n.length&&r&&r()}))}clearDrawings(){let t=this.drawingIds;this.removeDrawingsById(t)}hideAllDrawings(){let t=this.drawingIds;this.hideDrawingsById(t)}hideDrawingsById(t){for(let e=0;e<t.length;e++){const i=t[e];if(this.isInclude(i)&&this.mapDrawingObject[i]){let t=this;this.mapDrawingObject[i].forEach((function(e){t.customPlaneManager.hidePlane(e)}))}}this.viewer3D.render()}removeDrawingsById(t){for(let e=0;e<t.length;e++){const i=t[e];if(this.isInclude(i)&&this.mapDrawingObject[i]){let t=this;this.mapDrawingObject[i].forEach((function(e){t.customPlaneManager.removePlane(e)})),delete this.mapDrawingObject[i]}}this.viewer3D.render()}setDrawingsOpacityById(t,e){for(let i=0;i<t.length;i++){const n=t[i];if(this.isInclude(n)&&this.mapDrawingObject[n]){let t=this;this.mapDrawingObject[n].forEach((function(i){t.customPlaneManager.setPlaneOpacity(i,e)}))}}this.viewer3D.render()}showAllDrawings(){let t=this.drawingIds;this.showDrawingsById(t)}showDrawingsById(t){for(let e=0;e<t.length;e++){const i=t[e];if(this.isInclude(i)&&this.mapDrawingObject[i]){let t=this;this.mapDrawingObject[i].forEach((function(e){t.customPlaneManager.showPlane(e)}))}}this.viewer3D.render()}}}(),Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.RevitHelpers").DrawingHelperConfig=function(){return{viewer:null}};class Editor$2{constructor(t,e,i,n){this.viewer3D=t,this.objectType=e,this.name="Editor",this._eventManager=i,this.isEditing=!1,"ExternalObject"===e&&"Viewer3D"===this.viewer3D.viewerType&&(this.externalObjectManager=new Glodon.Bimface.Plugins.ExternalObject.ExternalObjectManager(t))}begin(t){this.isEditing=!0;let e=this.getCanvasPosition(new THREE.Vector2(t.clientX,t.clientY));this.mouseDownPoint=e.clone(),this.hitItem=this.hitTest(e),this.hitItem&&"Model"===this.objectType&&this._fireModelEvent("ModelTransformStart")}onEditing(t){}end(t){this.hitItem&&"Model"===this.objectType&&this._fireModelEvent("ModelTransformEnd"),this.isEditing=!1}hitTest(t){let e=[...this.dataDrawables.getAllDrawables()].reverse();for(const i of e){let e=i.hitTest(t);if(e)return e}return null}getCanvasPosition(t){let e=this.viewer3D.getDomElement().getBoundingClientRect(),i=new THREE.Vector3(t.x,t.y);return i.x-=e.left,i.y-=e.top,i}setEditedObjectId(t){if(this.editedObjectId=t,this.viewer3D instanceof Glodon.Bimface.Viewer.ViewerGIS){const e=this.viewer3D.getLayerManager().getLayerByType("ExternalObjectLayer");for(let i=0;i<e.length;i++){const n=e[i].getExternalObjectManager();if(n.getAllObjectIds().includes(t)){this.externalObjectManager=n;break}}}}getEditedObjectId(){return this.editedObjectId}setDrawables(t){this.dataDrawables=t}getDrawables(){return this.dataDrawables}getBoundingBoxWorld(){if("ExternalObject"===this.objectType)return this.viewer3D.getExternalComponentManager().getBoundingBoxById(this.editedObjectId);return this.viewer3D.getViewer().getModelManager().getModel(this.editedObjectId).getBoundingBoxWorld()}_fireModelEvent(t){const e=this.viewer3D.getModel(this.editedObjectId),i=this._eventManager;let n={modelId:this.editedObjectId,transformation:e.getModelTransformation()};i.fireEvent(t,n)}updateController(t){}}class TranslateEditor extends Editor$2{constructor(t,e,i,n){super(t,e,i,n),this.dataDrawables=null,this.isMouseDown=!1,this.mouseDownPoint=null,this.hitItem=null,this.lastHoveredItem=null,this.name="Translation",this.translationController=n,this._center=new THREE.Vector3}begin(t){super.begin(t),this.hitItem&&(t.preventDefault(),t.stopPropagation())}onEditing(t){let e=this.getCanvasPosition(new THREE.Vector2(t.clientX,t.clientY)),i=this.viewer3D.getViewer();if(this.getBoundingBoxWorld().getCenter(this._center),this.hitItem){let n,o,s=this.dataDrawables.getRotationMatrix(),r=this.viewer3D.sceneToWorld(i.camera.position.clone()),a=e.clone().sub(this.mouseDownPoint),l=t.clientX,h=t.clientY,c=i.cameraControl.getRaycaster(l,h),d=this.viewer3D.sceneToWorld(c.ray.direction).normalize();if(this.hitItem.isArrow()){if(0==a.length())return;let t;switch(this.hitItem.id){case"arrowX":if(!this.translationController.X)return;t=new THREE.Vector3(1,0,0).applyMatrix4(s).normalize();break;case"arrowY":if(!this.translationController.Y)return;t=new THREE.Vector3(0,-1,0).applyMatrix4(s).normalize();break;case"arrowZ":if(!this.translationController.Z)return;t=new THREE.Vector3(0,0,1).applyMatrix4(s).normalize()}n=new THREE.Ray(this._center.clone(),t);let e=d.clone().cross(d.clone().cross(t));o=new THREE.Plane(e);let i=-o.distanceToPoint(r);o.set(e,i),n.intersectsPlane(o)||n.set(n.origin.clone(),t.clone().negate())}else{if(0==a.length()||!this.checkTranslateEN(this.hitItem))return;let t;switch(this.hitItem.id){case"xy":t=new THREE.Vector3(0,0,-1);break;case"xz":t=new THREE.Vector3(0,1,0);break;case"yz":t=new THREE.Vector3(-1,0,0)}t.applyMatrix4(s).normalize(),o=new THREE.Plane(t);let e=-o.distanceToPoint(this._center);if(o.set(t,e),n=new THREE.Ray(r,d),!n.intersectsPlane(o))return}let u=new THREE.Vector3;n.intersectPlane(o,u),this.mouseDownOffset=this.mouseDownOffset||u.clone().sub(this._center);let p=u.clone().sub(this._center).sub(this.mouseDownOffset);this.setObjectTranslation(p),this.dataDrawables.update(),this.dataDrawables.setGray(),this.hitItem.select(),this.hitItem.magnify(),this.dataDrawables.hideAll(),this.hitItem.show(),this.mouseDownPoint.copy(e),t.preventDefault(),t.stopPropagation()}else{let t=this.hitTest(e);t?this.checkTranslateEN(t)&&(this.dataDrawables.setGray(),t.magnify(),t.select(),this.lastHoveredItem=t):(this.dataDrawables.setDefault(),this.lastHoveredItem&&this.lastHoveredItem.resetSize(),this.lastHoveredItem=null)}}end(t){super.end(t),this.hitItem&&(t.preventDefault(),t.stopPropagation(),this.dataDrawables.showAll(),this.hitItem=null),this.mouseDownOffset=null}setObjectTranslation(t){const e=this.objectType;if("ExternalObject"===e)this.externalObjectManager.translate(this.editedObjectId,t);else if("Model"===e){this.viewer3D.getModel(this.editedObjectId).setModelTranslation(t),this._fireModelEvent("ModelTransforming")}}updateController(t){null!=t.X&&(this.translationController.X=t.X),null!=t.Y&&(this.translationController.Y=t.Y),null!=t.Z&&(this.translationController.Z=t.Z)}checkTranslateEN(t){let e=!0,i=t.id;return t.isArrow()?("arrowY"!==i||this.translationController.Y||(e=!1),"arrowZ"!==i||this.translationController.Z||(e=!1),"arrowX"!==i||this.translationController.X||(e=!1)):("xz"!==i||this.translationController.X&&this.translationController.Z||(e=!1),"xy"!==i||this.translationController.X&&this.translationController.Y||(e=!1),"yz"!==i||this.translationController.Y&&this.translationController.Z||(e=!1)),e}}class ObjectEditorUtil{constructor(){}}ObjectEditorUtil.discreteCircle=function(t){let e=t.center.clone(),i=e.clone().distanceTo(t.arcStartPt),n=t.normal.clone(),o=t.arcStartPt.clone().sub(e).normalize(),s=[],r=t.rotateAngle/(Math.PI/180);for(let t=0;t<r;t++){o.applyAxisAngle(n,Math.PI/180);let t=e.clone().add(o.clone().multiplyScalar(i));s.push(t)}return t.rotateAngle==2*Math.PI&&s.push(s[0]),s},ObjectEditorUtil.drawingToCanvas=function(t,e){let i=this.getCoordinateAxis().start.clone(),n=this.cameraControl.camera,o=new THREE.Vector3;if(null==this.cameraToCenter){let t=this.viewer.getCamera(),e=this.viewer.getScene().getBoundingBox();n.setStandardView(CLOUD.EnumStandardView.ISO,e),n.zoomToBBox(e),i=this.getCoordinateAxis().start.clone(),this.cameraToCenter=i.clone().sub(n.position.clone()).length();let o=this.viewer.getScene().getMatrixGlobal(),s=CLOUD.CameraUtil.parseCameraInfo(t),r=CLOUD.Camera.worldToDrawing(s,o),a=new THREE.Vector3;a.subVectors(r.target,r.position),n.LookAt(r.target,a,r.up),this.cameraControl.update(!0,!0)}else{let t=i.clone().sub(n.position.clone()).normalize(),e=n.position.clone().sub(i.clone()).length();o=t.multiplyScalar(this.cameraToCenter-e)}let s=this.container.offsetWidth,r=this.container.offsetHeight;!1!==e&&n.isPerspective&&t.add(o);let a=CLOUD.CameraUtil.drawingToCanvas(n,t,s,r);return new THREE.Vector2(a.x,a.y)},ObjectEditorUtil.minDistanceToPoints=function(t,e,i){let n=-1,o=Number.POSITIVE_INFINITY;for(let a=0;a<i;a++){let i=(s=t,((r=e[a]).x-s.x)**2+(r.y-s.y)**2);i<o&&(o=i,n=a)}var s,r;return n},ObjectEditorUtil.computeSegmentsIntersect=function(t,e,i,n){var o=(t.x-i.x)*(e.y-i.y)-(t.y-i.y)*(e.x-i.x),s=(t.x-n.x)*(e.y-n.y)-(t.y-n.y)*(e.x-n.x);if(o*s>0)return!1;var r=(i.x-t.x)*(n.y-t.y)-(i.y-t.y)*(n.x-t.x);if(r*((i.x-e.x)*(n.y-e.y)-(i.y-e.y)*(n.x-e.x))>0)return!1;var a=r/(s-o),l=a*(e.x-t.x),h=a*(e.y-t.y);return{x:t.x+l,y:t.y+h}};class RotateEditor extends Editor$2{constructor(t,e,i,n){super(t,e,i,n),this.dataDrawables=null,this.isMouseDown=!1,this.mouseDownPoint=null,this.hitItem=null,this.rotateAngle=0,this.lastHoveredItem=null,this.name="Rotation",this.rotationController=n}begin(t){if(super.begin(t),this.hitItem){let e=this.getCanvasPosition(new THREE.Vector2(t.clientX,t.clientY)),i=this.hitItem.getId(),n=this.dataDrawables.quarterRings.getFullRingPts(i);this.lastHitIndex=ObjectEditorUtil.minDistanceToPoints(e,n,90),this.firstHitIndex=this.lastHitIndex,t.preventDefault(),t.stopPropagation()}}onEditing(t){let e=this.getCanvasPosition(new THREE.Vector2(t.clientX,t.clientY));if(this.hitItem){let i=this.hitItem.getId();if(!this.checkRotationEN(i))return;this.dataDrawables.isOnQuarterRing&&this.dataDrawables.toFullRing(i),this.dataDrawables.hideAll(),this.hitItem.show();let n=this.dataDrawables.quarterRings.getFullRingPts(i),o=ObjectEditorUtil.minDistanceToPoints(e,n,360),s=(o-this.lastHitIndex)*(Math.PI/180);if(this.rotateAngle+=s/(Math.PI/180),0===s)return;this.dataDrawables.updateRotationTips(i,this.firstHitIndex,o,this.rotateAngle),this.lastHitIndex=o,this.setRotation(s),this.dataDrawables.updateBoundingBox(),this.viewer3D.render(),this.mouseDownPoint.copy(e),t.preventDefault(),t.stopPropagation()}else{let t=this.hitTest(e);t?this.checkRotationEN(t.getId())&&(this.dataDrawables.setGray(),t.magnify(),t.select(),this.lastHoveredItem=t):(this.dataDrawables.setRotationEN(),this.lastHoveredItem&&this.lastHoveredItem.resetSize(),this.lastHoveredItem=null)}}end(t){super.end(t),this.hitItem&&(t.preventDefault(),t.stopPropagation(),this.dataDrawables.isOnQuarterRing||(this.dataDrawables.fromFullRing(this.hitItem.getId()),this.dataDrawables.removeRotationTips()),this.rotateAngle=0,this.dataDrawables.showAll(),this.hitItem=null)}setRotation(t){const e=this.objectType,i=this.hitItem.getId(),n=this.dataDrawables.getEditObjectCenter();if("ExternalObject"===e){if("xy"===i){if(!this.rotationController.Z)return;this.externalObjectManager.setRotationZ(this.editedObjectId,n,t)}if("xz"===i){if(!this.rotationController.Y)return;this.externalObjectManager.setRotationY(this.editedObjectId,n,-t)}if("yz"===i){if(!this.rotationController.X)return;this.externalObjectManager.setRotationX(this.editedObjectId,n,t)}}else if("Model"==e){const e=this.viewer3D.getModel(this.editedObjectId);if("xy"===i){if(!this.rotationController.Z)return;e.setModelRotationZ(n,t)}if("xz"===i){if(!this.rotationController.Y)return;e.setModelRotationY(n,-t)}if("yz"===i){if(!this.rotationController.X)return;e.setModelRotationX(n,t)}this._fireModelEvent("ModelTransforming")}}updateController(t){null!=t.X&&(this.rotationController.X=t.X),null!=t.Y&&(this.rotationController.Y=t.Y),null!=t.Z&&(this.rotationController.Z=t.Z)}checkRotationEN(t){let e=!0;return"xz"!==t||this.rotationController.Y||(e=!1),"xy"!==t||this.rotationController.Z||(e=!1),"yz"!==t||this.rotationController.X||(e=!1),e}}class ScaleEditor extends Editor$2{constructor(t,e,i,n){super(t,e,i,n),this.dataDrawables=null,this.isMouseDown=!1,this.mouseDownPoint=null,this.hitItem=null,this.lastHoveredItem=null,this.name="Scaling",this.scaleController=n,this.windowHight=this.viewer3D.getDomElement().getBoundingClientRect().height}begin(t){super.begin(t),this.hitItem&&(t.preventDefault(),t.stopPropagation())}onEditing(t){let e=this.getCanvasPosition(new THREE.Vector2(t.clientX,t.clientY));if(this.hitItem){let i=e.clone().sub(this.mouseDownPoint);if(0==i.length())return;let n=i.clone().projectOnVector(this.hitItem.getDirection()),o=i.clone().angleTo(this.hitItem.getDirection())<=Math.PI/2?1:-1,s=n.length();if(!this.checkScalerEnable(this.hitItem.id))return;let r=this.dataDrawables.getDirection(this.hitItem.id),a=1+o*(s/this.windowHight);r.multiplyScalar(a),0===r.x&&(r.x=1),0===r.y&&(r.y=1),0===r.z&&(r.z=1);let l=this.dataDrawables.getOppositeSideCenter(this.hitItem.id);this.setObjectScale(l,r),this.dataDrawables.update(this.hitItem.id),this.dataDrawables.hideAll(),this.hitItem.show(),this.hitItem.magnify(),this.mouseDownPoint.copy(e),t.preventDefault(),t.stopPropagation()}else{let t=this.hitTest(e);t?this.checkScalerEnable(t.id)&&(this.dataDrawables.update(t.id),this.dataDrawables.setGray(),t.magnify(),t.select(),this.lastHoveredItem=t):(this.dataDrawables.setDefault(),this.lastHoveredItem&&this.lastHoveredItem.resetSize(),this.dataDrawables.updateHighlightBBoxFace(),this.lastHoveredItem=null)}}end(t){super.end(t),this.hitItem&&(t.preventDefault(),t.stopPropagation(),this.dataDrawables.showAll(),this.hitItem=null)}setObjectScale(t,e){const i=this.objectType;"ExternalObject"===i?this.externalObjectManager.scaleOnBasePoint(this.getEditedObjectId(),t,e):"Model"===i&&(this.viewer3D.getModel(this.getEditedObjectId()).setModelScale(t,e),this._fireModelEvent("ModelTransforming"))}updateController(t){null!=t.X&&(this.scaleController.X=t.X),null!=t.Y&&(this.scaleController.Y=t.Y),null!=t.Z&&(this.scaleController.Z=t.Z),null!=t.Uniform&&(this.scaleController.Uniform=t.Uniform)}checkScalerEnable(t){let e=!0;switch(t){case"CoordOrigin":this.scaleController.Uniform||(e=!1);break;case"x+":case"x-":this.scaleController.X||(e=!1);break;case"y+":case"y-":this.scaleController.Y||(e=!1);break;case"z+":case"z-":this.scaleController.Z||(e=!1)}return e}}class FaceArray extends Drawable{constructor(t){super(),this.config=t,this.colors=["#FF2905","#1922FB","#32D3A6"]}update(t){if(this.drawables.length>0){let e=0;for(const i of this.drawables)i.update(t.slice(5*e,5*(e+1))),e++;return}let e=["xy","xz","yz"];for(let i=0;i<3;i++){let n=new Face({id:e[i]});n.update(t.slice(5*i,5*(i+1))),this.drawables.push(n)}}hitTest(t){for(const e of this.drawables){let i=new THREE.Vector2(t.x,t.y),n=e.hitTest(i);if(n)return n}return null}setGray(){for(const t of this.drawables)t.setGray()}setDefault(){for(const t of this.drawables)t.setDefault()}hide(){for(const t of this.drawables)t.hide()}show(){for(const t of this.drawables)t.show()}}class Face extends Drawable{constructor(t){super(),this.id=t.id}update(t){this.drawables=[];let e=this.makePolyline(t);this.drawables.push(e)}makePolyline(t){let e={};return e.points=MeasureUtil.calcPolylinePoints(t),e.width="3px",e.fillColor="#F99D0B",e.color="#F99D0B",this.position=new THREE.Vector2,t.forEach((t=>{this.position.x+=t.x,this.position.y+=t.y})),this.position.multiplyScalar(.2),MeasureUtil.makePolyline(e)}hitTest(t){return new THREE.Vector2(t.x,t.y).clone().distanceTo(this.position)<=this.hitTestEpsilon?this:null}setGray(){for(const t of this.drawables)t.style.fill=this.grayColor,t.style.stroke=this.grayColor}setDefault(){for(const t of this.drawables)t.style.fill="#F99D0B",t.style.stroke="#F99D0B"}select(){for(const t of this.drawables)t.style.fill=this.highlightColor,t.style.stroke=this.highlightColor}getDirection(){let t=new THREE.Vector3(1,0,0),e=new THREE.Vector3(0,-1,0),i=new THREE.Vector3(0,0,1),n=new THREE.Vector3;return"xy"==this.id?n.addVectors(t,e).normalize():"xz"==this.id?n.addVectors(t,i).normalize():"yz"==this.id&&n.addVectors(e,i).normalize(),n}getLocalCoordAxis(){let t=new THREE.Vector3(1,0,0),e=new THREE.Vector3(0,-1,0),i=new THREE.Vector3(0,0,1),n=[];return"xy"==this.id?n.push(t,e):"xz"==this.id?n.push(t,i):"yz"==this.id&&n.push(e,i),n}hide(){for(const t of this.drawables)t.style.display="none"}show(){for(const t of this.drawables)t.style.display="block"}}class Dashline extends Drawable{constructor(t){super(),this.config=t,this.start=null,this.target=null,this.isEffectedByOthers=!!t.isEffectedByOthers}update(t,e){this.drawables=[];let i={color:this.config.color,lineWidth:"1px",start:t,end:e},n=MeasureUtil.makeDashLine(i);this.drawables.push(n)}setGray(){if(this.isEffectedByOthers){this.drawables[0].setAttribute("stroke",this.grayColor)}}setDefault(){if(this.isEffectedByOthers){this.drawables[0].setAttribute("stroke",this.config.color)}}hide(){if(this.isEffectedByOthers){this.drawables[0].style.display="none"}}show(){if(this.isEffectedByOthers){this.drawables[0].style.display="block"}}}class DashlineArray extends Drawable{constructor(t){super(),this.config=t||{},this.colors=t.colors}update(t,e){if(this.drawables.length>0){let i=0;for(const n of this.drawables){let o=this.toVector2(t),s=this.toVector2(e[i]);n.update(o,s),i++}}else for(let i=0;i<e.length;i++){let n=new Dashline({color:this.colors[Math.floor(i)],isEffectedByOthers:this.config.isEffectedByOthers}),o=this.toVector2(t),s=this.toVector2(e[i]);n.update(o,s),this.drawables.push(n)}}hitTest(t){for(const e of this.drawables){let i=new THREE.Vector2(t.x,t.y),n=e.hitTest(i);if(n)return n}return null}setGray(){for(const t of this.drawables)t.setGray()}setDefault(){for(const t of this.drawables)t.setDefault()}hide(){for(const t of this.drawables)t.hide()}show(){for(const t of this.drawables)t.show()}}class CoordinateAxis extends Drawable{constructor(){super(),this.coordinateOrigin=new THREE.Vector3,this.style.length=130,this.style.axisX={},this.style.axisX.color="#FF2905",this.style.axisY={},this.style.axisY.color="#1922FB",this.style.axisZ={},this.style.axisZ.color="#32D3A6",this.axisColors=["#FF2905","#1922FB","#32D3A6"],this.markerIds=["arrowX","arrowY","arrowZ"],this.arrowTargets=[]}update(t,e){this.arrowTargets=[];let i=new THREE.Vector2(t.x,t.y);if(this.drawables.length>0){let t=0;for(const n of e){let e=new THREE.Vector2(n.x,n.y);this.drawables[t++].update(i,e)}return}let n=0;for(const t of e){let e=new THREE.Vector2(t.x,t.y),o=new Arrow({id:this.markerIds[n],color:this.axisColors[n++]});o.update(i,e),this.drawables.push(o)}}getDefaultStyle(){return{lineWidth:"4px",color:"#FF2905"}}hitTest(t){for(const e of this.drawables){let i=new THREE.Vector2(t.x,t.y),n=e.hitTest(i);if(n)return n}return null}setDefault(){for(const t of this.drawables)t.setDefault()}select(){for(const t of this.drawables)t.select()}setGray(){for(const t of this.drawables)t.setGray()}hide(){for(const t of this.drawables)t.hide()}show(){for(const t of this.drawables)t.show()}getOrigin(){return this.coordinateOrigin}setOrigin(t){this.coordinateOrigin.set(t.x,t.y,t.z)}}class BoundingBox extends Drawable{constructor(t){super(),this.domContainer=t,this.style.color="#11DAB7",this.style.backColor="#939E9C",this.style.border="1px"}update(t,e,i){this.drawables=[];const n=(n,o)=>{let s=!1;(i[n]||i[o])&&(s=!0),e.indexOf(n)<0&&e.indexOf(o)<0&&this.makePolyline([t[n],t[o]],s)};n(0,1),n(1,5),n(5,4),n(4,0),n(0,3),n(1,2),n(5,6),n(4,7),n(3,2),n(2,6),n(6,7),n(7,3)}getDrawables(){return this.drawables}makePolyline(t,e){let i,n,o=this.getDefaultStyle(e),s=this.domContainer.width.baseVal.value,r=this.domContainer.height.baseVal.value,a=[];const l=(t,e)=>{let i={x:0,y:0},n={x:0,y:r},o={x:s,y:r},a={x:s,y:0},l=[];const h=(i,n)=>{let o=ObjectEditorUtil.computeSegmentsIntersect(t,e,i,n);o&&l.push(o)};return h(i,n),h(n,o),h(o,a),h(a,i),l},h=t=>t.x>=0&&t.x<=s&&t.y>=0&&t.y<=r,c=()=>{if(a.length>0){if(i){let t=a[a.length-1];h(t);let e=l(t,i);1===e.length&&a.push(e[0])}o.points=MeasureUtil.calcPolylinePoints(a),this.drawables.push(MeasureUtil.makePolyline(o))}if(a=[],n<t.length-1){let e=l(i,t[n+1]);1===e.length?a.push(e[0]):2===e.length&&(o.points=MeasureUtil.calcPolylinePoints(e),this.drawables.push(MeasureUtil.makePolyline(o)))}i=void 0};for(n=0;n<t.length;n++){const e=t[n];h(e)?a.push(e):(i=e,c())}a.length>0&&c()}getDefaultStyle(t){return{color:!0===t?this.style.backColor:this.style.color,width:this.style.border}}}class DataDrawables{constructor(t,e,i,n,o){this.viewer3D=t,this.domContainer=e,this.objectId=i,this.objectType=n,this.controller=o,this.scratchVector=new THREE.Vector3,this._center=new THREE.Vector3,this._cCenter=new THREE.Vector3,this._quarterCenter=new THREE.Vector3,this._modelCenter=new THREE.Vector3,this._bCenter=new THREE.Vector3,this.updateFactor(),this.initialize()}initialize(){}updateFactor(){const t=this.getBoundingBoxWorld().getCenter(this.scratchVector),e=this.viewer3D.getViewer().camera,i=this.viewer3D.sceneToWorld(e.position),n=t.clone().sub(new THREE.Vector3(i.x,i.y,i.z)).length(),o=2*Math.tan(e.fov*Math.PI/360)*n,s=this.viewer3D.getDomElement().offsetHeight;this.factor=o/s}updateBoundingBox(){let t=this.viewer3D.getViewer(),e=[],i=this.getBoundaryPoints(),n=[],o=[],s={},r=new THREE.Vector3,a=new THREE.Plane(this.viewer3D.sceneToWorld(t.camera.getWorldDirection(r)).normalize()),l=this.viewer3D.sceneToWorld(t.camera.position),h=a.distanceToPoint(l);a.constant=-h;this.getBoundingBoxWorld().getCenter(this._center);let c=[];const d=this._center.clone().distanceTo(l);i.forEach((t=>{e.push(t);const i=e.length-1;a.distanceToPoint(t)<0&&n.push(i);let r=this.viewer3D.worldToClient(t);r.index=i;const h={distance:t.distanceTo(l),index:i,screenPoint:r};s[i]=!0,c.push(h.screenPoint),o.push(h)}));(t=>{if(n.length>0||c[0].x===c[4].x&&c[0].y===c[4].y||c[1].x===c[5].x&&c[1].y===c[5].y||c[2].x===c[6].x&&c[2].y===c[6].y||c[3].x===c[7].x&&c[3].y===c[7].y){for(let t=0;t<8;++t)s[t]=!1;return}let i=[];((t,e,i)=>{let n,o,s=(t,e,i)=>t&&e&&i?(e.x-t.x)*(i.y-t.y)-(i.x-t.x)*(e.y-t.y):-1,r=(t,e)=>(t.x-e.x)*(t.x-e.x)+(t.y-e.y)*(t.y-e.y),a=0,l=2,h=new Object;for(n=1;n<i;n++)(t[n].y<t[a].y||t[n].y==t[a].y&&t[n].x<t[a].x)&&(a=n);h=t[0],t[0]=t[a],t[a]=h;let c=i;for(n=1;n<c-1;n++){for(a=n,o=n+1;o<c;o++){let e=s(t[0],t[a],t[o]);if(e>0)a=o;else if(0==e){c--,r(t[0],t[o])-r(t[0],t[a])>0?(t[a]=t[o],t[o]=t[c],o--):(h=t[c],t[c]=t[o],t[o]=h)}}h=t[n],t[n]=t[a],t[a]=h}for(e.push(t[0]),e.push(t[1]),e.push(t[2]),n=3;n<c;n++){for(;!(s(t[n],e[l-1],e[l])<0);)l--,e.pop();l++,e.push(t[n])}})(c,i,8);for(let t=0;t<i.length;++t)s[i[t].index]=!1;for(let i=0;i<e.length;++i)!1!==s[t[i].index]&&d>t[i].distance&&(s[t[i].index]=!1)})(o);let u=[];for(const t of e)u.push(this.viewer3D.worldToClient(t));this.boundingBox||(this.boundingBox=new BoundingBox(this.domContainer),this.drawables.push(this.boundingBox)),this.boundingBox.detach(),this.boundingBox.update(u,n,s),this.boundingBox.attach(this.domContainer)}getBoundaryPoints(){if("ExternalObject"===this.objectType)return this.viewer3D.getExternalComponentManager().getBoundaryPoints(this.objectId);return this.viewer3D.getViewer().getModelManager().getModel(this.objectId).getBoundaryPoints()}getBoundingBoxWorld(){if("ExternalObject"===this.objectType)return this.viewer3D.getExternalComponentManager().getBoundingBoxById(this.objectId);return this.viewer3D.getViewer().getModelManager().getModel(this.objectId).getBoundingBoxWorld()}getTransformMatrix(){if("ExternalObject"===this.objectType){let t=this.viewer3D.getExternalComponentManager().getTransform(this.objectId);return(new THREE.Matrix4).compose(t.position,t.rotate,t.scale)}return this.viewer3D.getViewer().getModelManager().getModel(this.objectId).getTransformMatrix().clone()}getRotationMatrix(){let t=new THREE.Matrix4,e=this.getTransformMatrix();return t.extractRotation(e),t}}class TranslateDrawables extends DataDrawables{constructor(t,e,i,n,o){super(t,e,i,n,o)}initialize(){this.drawables=[],this.updateBoundingBox(),this.updateCoordinateAxis(),this.updateFaces(),this.addCloudViewerEvents()}updateFaces(){this.getBoundingBoxWorld().getCenter(this.scratchVector);let t=this.getRotationMatrix(),e=20*this.factor,i=new THREE.Vector3(e,0,0).applyMatrix4(t),n=new THREE.Vector3(0,-e,0).applyMatrix4(t),o=new THREE.Vector3(0,0,e).applyMatrix4(t),s=[];e*=.3;let r=this.scratchVector.clone().add(new THREE.Vector3(e,-e,0).applyMatrix4(t));s.push(r),s.push(r.clone().add(i)),s.push(r.clone().add(i).add(n)),s.push(r.clone().add(n)),s.push(r);let a=this.scratchVector.clone().add(new THREE.Vector3(e,0,e).applyMatrix4(t));s.push(a),s.push(a.clone().add(i)),s.push(a.clone().add(i).add(o)),s.push(a.clone().add(o)),s.push(a);let l=this.scratchVector.clone().add(new THREE.Vector3(0,-e,e).applyMatrix4(t));s.push(l),s.push(l.clone().add(n)),s.push(l.clone().add(n).add(o)),s.push(l.clone().add(o)),s.push(l);let h=[];for(const t of s)h.push(this.viewer3D.worldToClient(t));this.faceArray||(this.faceArray=new FaceArray,this.drawables.push(this.faceArray)),this.faceArray.detach(),this.faceArray.update(h),this.faceArray.attach(this.domContainer),this.setTranslateEN()}updateCoordinateAxis(){let t=this.getBoundingBoxWorld(),e=this.getRotationMatrix(),i=[];i.push(new THREE.Vector3(1,0,0).applyMatrix4(e)),i.push(new THREE.Vector3(0,-1,0).applyMatrix4(e)),i.push(new THREE.Vector3(0,0,1).applyMatrix4(e));let n=new THREE.Vector3;n=this.viewer3D.worldToClient(t.getCenter(n)),this.coordinateAxis||(this.coordinateAxis=new CoordinateAxis,this.drawables.push(this.coordinateAxis)),this.coordinateAxis.setOrigin(n);let o=[];for(const e of i){let i=e.clone().multiplyScalar(130*this.factor).add(t.getCenter(this.scratchVector)),n=this.viewer3D.worldToClient(i);o.push(n)}this.dashlineArray||(this.dashlineArray=new DashlineArray({length:116,colors:["#FF2905","#1922FB","#32D3A6"]}),this.drawables.push(this.dashlineArray)),this.dashlineArray.detach(),this.dashlineArray.update(n,o),this.dashlineArray.attach(this.domContainer),this.coordinateAxis.detach(),this.coordinateAxis.update(n,o),this.coordinateAxis.attach(this.domContainer),this.setTranslateEN()}getDirection(t){return"arrowX"===t?new THREE.Vector3(1,0,0):"arrowY"===t?new THREE.Vector3(0,-1,0):new THREE.Vector3(0,0,1)}attach(){this.boundingBox.attach(this.domContainer)}addCloudViewerEvents(){let t=this.viewer3D.getViewer();this.updateBinded=this.update.bind(this),t.registerEventListener(CLOUD.EVENTS.ON_EDITOR_ZOOM,this.updateBinded),t.registerEventListener(CLOUD.EVENTS.ON_EDITOR_ROTATING,this.updateBinded),t.registerEventListener(CLOUD.EVENTS.ON_EDITOR_PANING,this.updateBinded)}removeCloudViewerEvents(){let t=this.viewer3D.getViewer();t.unregisterEventListener(CLOUD.EVENTS.ON_EDITOR_ZOOM,this.updateBinded),t.unregisterEventListener(CLOUD.EVENTS.ON_EDITOR_ROTATING,this.updateBinded),t.unregisterEventListener(CLOUD.EVENTS.ON_EDITOR_PANING,this.updateBinded)}update(){document.getElementsByClassName("bf-ObjectEditor-svg")[0].setAttribute("transform","translate(0,0)"),this.updateFactor(),this.updateBoundingBox(),this.updateCoordinateAxis(),this.updateFaces()}getAllDrawables(){return this.drawables}setDefault(){for(const t of this.getAllDrawables())t.setDefault()}setGray(){for(const t of this.getAllDrawables())t.setGray()}select(t){for(const e of this.getAllDrawables())if(e.select(t))return}hideAll(){for(const t of this.getAllDrawables())t.hide()}showAll(){for(const t of this.getAllDrawables())t.show()}dispose(){this.domContainer.innerHTML="",this.boundingBox=null,this.CoordinateAxis=null,this.removeCloudViewerEvents()}updateController(t){null!=t.X&&(this.controller.X=t.X),null!=t.Y&&(this.controller.Y=t.Y),null!=t.Z&&(this.controller.Z=t.Z)}setTranslateEN(){!this.faceArray||this.faceArray.drawables.length<=0||(this.controller.Y?(this.coordinateAxis.drawables[1].show(),this.dashlineArray.drawables[1].hide()):(this.coordinateAxis.drawables[1].hide(),this.dashlineArray.drawables[1].show(),this.faceArray.drawables[0].hide(),this.faceArray.drawables[2].hide()),this.controller.Z?(this.coordinateAxis.drawables[2].show(),this.dashlineArray.drawables[2].hide()):(this.coordinateAxis.drawables[2].hide(),this.dashlineArray.drawables[2].show(),this.faceArray.drawables[2].hide(),this.faceArray.drawables[1].hide()),this.controller.X?(this.coordinateAxis.drawables[0].show(),this.dashlineArray.drawables[0].hide()):(this.coordinateAxis.drawables[0].hide(),this.dashlineArray.drawables[0].show(),this.faceArray.drawables[1].hide(),this.faceArray.drawables[0].hide()),this.controller.X&&this.controller.Y&&this.faceArray.drawables[0].show(),this.controller.X&&this.controller.Z&&this.faceArray.drawables[1].show(),this.controller.Z&&this.controller.Y&&this.faceArray.drawables[2].show())}}class CoordOrigin extends Drawable{constructor(){super(),this.hitTestEpsilon=18,this.id="CoordOrigin",this.style.color="#11DAB7",this.style.border="1px"}update(t,e,i=!0){this.drawables=[];let n=t;this.makePolyline([n[0],n[1],n[5],n[4],n[0]],i),this.makePolyline([n[3],n[2],n[6],n[7],n[3]],i),this.makePolyline([n[0],n[3],n[7],n[4],n[0]],i),this.makePolyline([n[1],n[2],n[6],n[5],n[1]],i),this.makePolyline([n[5],n[6],n[7],n[4],n[5]],i),this.makePolyline([n[1],n[2],n[3],n[0],n[1]],i),this.position=new THREE.Vector2(e.x,e.y)}getDrawables(){return this.drawables}makePolyline(t,e){let i=this.getDefaultStyle();i.points=MeasureUtil.calcPolylinePoints(t),e&&(i.width="0px",i.fillColor="#F99D0B"),this.drawables.push(MeasureUtil.makePolyline(i))}getDefaultStyle(){return{color:"#11DAB7",width:"1px"}}setGray(){for(const t of this.drawables)t.style.fill=this.grayColor}setDefault(){for(const t of this.drawables)t.style.fill="#F99D0B"}select(){for(const t of this.drawables)t.style.fill=this.highlightColor}hide(){for(const t of this.drawables)t.style.display="none"}show(){for(const t of this.drawables)t.style.display="block"}hitTest(t){return new THREE.Vector2(t.x,t.y).distanceTo(this.position)<=this.hitTestEpsilon?this:null}getDirection(){return new THREE.Vector3(1,0,0)}}class HighlightBBoxFace extends Drawable{constructor(t){super(),this.id="HighlightBBoxFace",this.update(t)}update(t){this.drawables=[],t&&this.makePolyline(t)}makePolyline(t){let e={width:"0px",fillColor:"#E3FFF7",opacity:.6};e.points=MeasureUtil.calcPolylinePoints(t),this.drawables.push(MeasureUtil.makePolyline(e))}setGray(){}}class ScaleDrawables extends DataDrawables{constructor(t,e,i,n,o){super(t,e,i,n,o)}initialize(){this.drawables=[],this.arrows=[],this.updateBoundingBox(),this.updateBboxArrow(),this.updateCoordOrigin(),this.addCloudViewerEvents()}updateCoordOrigin(){let t=this.getBoundingBoxWorld(),e=this.getRotationMatrix(),i=20*this.factor,n=new THREE.Vector3;t=(new THREE.Box3).setFromCenterAndSize(t.getCenter(n),new THREE.Vector3(i,i,i)),t.getCenter(this._bCenter);let o=[];o.push(new THREE.Vector3(t.max.x,t.max.y,t.max.z).sub(this._bCenter).applyMatrix4(e).add(this._bCenter)),o.push(new THREE.Vector3(t.min.x,t.max.y,t.max.z).sub(this._bCenter).applyMatrix4(e).add(this._bCenter)),o.push(new THREE.Vector3(t.min.x,t.min.y,t.max.z).sub(this._bCenter).applyMatrix4(e).add(this._bCenter)),o.push(new THREE.Vector3(t.max.x,t.min.y,t.max.z).sub(this._bCenter).applyMatrix4(e).add(this._bCenter)),o.push(new THREE.Vector3(t.max.x,t.max.y,t.min.z).sub(this._bCenter).applyMatrix4(e).add(this._bCenter)),o.push(new THREE.Vector3(t.min.x,t.max.y,t.min.z).sub(this._bCenter).applyMatrix4(e).add(this._bCenter)),o.push(new THREE.Vector3(t.min.x,t.min.y,t.min.z).sub(this._bCenter).applyMatrix4(e).add(this._bCenter)),o.push(new THREE.Vector3(t.max.x,t.min.y,t.min.z).sub(this._bCenter).applyMatrix4(e).add(this._bCenter));let s=[];for(const t of o)s.push(this.viewer3D.worldToClient(t));n=this.viewer3D.worldToClient(t.getCenter(n)),this.coordOrigin||(this.coordOrigin=new CoordOrigin,this.drawables.push(this.coordOrigin)),this.coordOrigin.detach(),this.coordOrigin.update(s,n),this.coordOrigin.attach(this.domContainer),this.setScaleEN()}updateBboxArrow(){let t=this.getBoundingBoxWorld(),e=[];e.push(this.getOppositeSideCenter("x+")),e.push(this.getOppositeSideCenter("x-")),e.push(this.getOppositeSideCenter("y+")),e.push(this.getOppositeSideCenter("y-")),e.push(this.getOppositeSideCenter("z+")),e.push(this.getOppositeSideCenter("z-"));let i=[];for(const t of e)i.push(this.viewer3D.worldToClient(t.clone()));let n=new THREE.Vector3;n=this.viewer3D.worldToClient(t.getCenter(n)),n=new THREE.Vector2(n.x,n.y);let o=[];for(const i of e){let e=i.clone(),n=new THREE.Vector3,s=e.clone().sub(t.getCenter(n).clone()).normalize().multiplyScalar(50*this.factor).add(e),r=this.viewer3D.worldToClient(s);o.push(r)}this.arrowArray||(this.arrowArray=new ArrowArray({id:1,color:"#FF0000"}),this.drawables.push(this.arrowArray)),this.arrowArray.detach(),this.arrowArray.update(i,o),this.arrowArray.attach(this.domContainer),this.dashlineArray||(this.dashlineArray=new DashlineArray({colors:["#FF2905","#1922FB","#32D3A6"]})),this.dashlineArray.detach(),this.dashlineArray.update(n,[i[1],i[2],i[5]]),this.dashlineArray.attach(this.domContainer),this.setScaleEN()}getDirection(t){return t.includes("x")?new THREE.Vector3(1,0,0):t.includes("y")?new THREE.Vector3(0,1,0):t.includes("z")?new THREE.Vector3(0,0,1):new THREE.Vector3(1,1,1)}addCloudViewerEvents(){let t=this.viewer3D.getViewer();this.updateBinded=this.update.bind(this),t.registerEventListener(CLOUD.EVENTS.ON_EDITOR_ZOOM,this.updateBinded),t.registerEventListener(CLOUD.EVENTS.ON_EDITOR_ROTATING,this.updateBinded),t.registerEventListener(CLOUD.EVENTS.ON_EDITOR_PANING,this.updateBinded)}removeCloudViewerEvents(){let t=this.viewer3D.getViewer();t.unregisterEventListener(CLOUD.EVENTS.ON_EDITOR_ZOOM,this.updateBinded),t.unregisterEventListener(CLOUD.EVENTS.ON_EDITOR_ROTATING,this.updateBinded),t.unregisterEventListener(CLOUD.EVENTS.ON_EDITOR_PANING,this.updateBinded)}update(t){document.getElementsByClassName("bf-ObjectEditor-svg")[0].setAttribute("transform","translate(0,0)"),this.updateFactor(),this.updateHighlightBBoxFace(t),this.updateBoundingBox(),this.updateBboxArrow(),this.updateCoordOrigin()}getOppositeSideCenter(t){let e=this.getBoundaryPoints(),i=null;const n=(t,i,n,o)=>{let s=e[t],r=e[i],a=e[n],l=e[o];return(new THREE.Vector3).add(s).add(r).add(a).add(l).multiplyScalar(.25)};switch(t){case"x+":i=n(0,3,7,4);break;case"x-":i=n(1,2,6,5);break;case"y+":i=n(0,1,5,4);break;case"y-":i=n(2,3,7,6);break;case"z+":i=n(0,1,2,3);break;case"z-":i=n(4,5,6,7);break;default:i=n(0,1,2,3).add(n(4,5,6,7)).multiplyScalar(.5)}return i}updateHighlightBBoxFace(t){if(!t&&this.highlightBBoxFace)return void this.highlightBBoxFace.detach();let e=this.getBoundaryPoints(),i=null;const n=(t,i,n,o)=>{let s=this.viewer3D.worldToClient(e[t]);return[s,this.viewer3D.worldToClient(e[i]),this.viewer3D.worldToClient(e[n]),this.viewer3D.worldToClient(e[o]),s]};switch(t){case"x-":i=n(0,3,7,4);break;case"x+":i=n(1,2,6,5);break;case"y-":i=n(0,1,5,4);break;case"y+":i=n(2,3,7,6);break;case"z-":i=n(0,1,2,3);break;case"z+":i=n(4,5,6,7)}this.highlightBBoxFace||(this.highlightBBoxFace=new HighlightBBoxFace,this.drawables.push(this.highlightBBoxFace)),this.highlightBBoxFace.detach(),this.highlightBBoxFace.update(i),this.highlightBBoxFace.attach(this.domContainer)}getAllDrawables(){return this.drawables}setDefault(){for(const t of this.getAllDrawables())t.setDefault()}setGray(){for(const t of this.getAllDrawables())t.setGray()}select(t){for(const e of this.getAllDrawables())if(e.select(t))return}hideAll(){for(const t of this.getAllDrawables())t.hide()}showAll(){for(const t of this.getAllDrawables())t.show()}dispose(){this.domContainer.innerHTML="",this.boundingBox=null,this.coordOrigin=null,this.arrowArray=null,this.removeCloudViewerEvents()}updateController(t){null!=t.X&&(this.controller.X=t.X),null!=t.Y&&(this.controller.Y=t.Y),null!=t.Z&&(this.controller.Z=t.Z),null!=t.Uniform&&(this.controller.Uniform=t.Uniform)}setScaleEN(){!this.coordOrigin||this.coordOrigin.drawables.length<=0||(this.controller.Y?(this.arrowArray.drawables[2].show(),this.arrowArray.drawables[3].show()):(this.arrowArray.drawables[2].hide(),this.arrowArray.drawables[3].hide()),this.controller.Z?(this.arrowArray.drawables[4].show(),this.arrowArray.drawables[5].show()):(this.arrowArray.drawables[4].hide(),this.arrowArray.drawables[5].hide()),this.controller.X?(this.arrowArray.drawables[0].show(),this.arrowArray.drawables[1].show()):(this.arrowArray.drawables[0].hide(),this.arrowArray.drawables[1].hide()),this.controller.Uniform?this.coordOrigin.show():this.coordOrigin.hide())}}class ArrowArray extends Drawable{constructor(t){super(),this.config=t,this.colors=["#FF2905","#1922FB","#32D3A6"]}update(t,e){if(this.drawables.length>0){let i=0;for(const n of this.drawables)n.update(this.toVector3(t[i]),this.toVector3(e[i])),i++;return}let i=["x-","x+","y-","y+","z-","z+"];for(let n=0;n<t.length;n++){let o=new Arrow({id:i[n],color:this.colors[Math.floor(n/2)],length:40});o.update(this.toVector3(t[n]),this.toVector3(e[n])),this.drawables.push(o)}}hitTest(t){for(const e of this.drawables){let i=new THREE.Vector2(t.x,t.y),n=e.hitTest(i);if(n)return n}return null}setGray(){for(const t of this.drawables)t.setGray()}setDefault(){for(const t of this.drawables)t.setDefault()}hide(){for(const t of this.drawables)t.hide()}show(){for(const t of this.drawables)t.show()}}class QuarterRing extends Drawable{constructor(t){super(),this.id=t.id,this.config=t,this.config.highlightWidth="2px"}update(t){this.drawables=[],this.boundaryPts=t;let e={};e.points=MeasureUtil.calcPolylinePoints(t),e.width="1px",e.color=this.config.color,e.fillColor=this.config.color,e.opacity=this.config.opacity;let i=MeasureUtil.makePolyline(e);this.drawables.push(i),delete e.fillColor,delete e.opacity;let n=MeasureUtil.makePolyline(e);this.drawables.push(n)}setGray(){let t=this.drawables[0];t.style.opacity=this.config.opacity,t.style.fill=this.grayColor;let e=this.drawables[1];e.setAttribute("stroke",this.grayColor),e.setAttribute("stroke-width","1px")}setDefault(){let t=this.drawables[0];t.style.opacity=this.config.opacity,t.style.fill=this.config.color;let e=this.drawables[1];e.setAttribute("stroke",this.config.color),e.setAttribute("stroke-width","1px")}select(){let t=this.drawables[0];t.style.opacity=this.config.opacity,t.style.fill=this.highlightColor;let e=this.drawables[1];e.setAttribute("stroke",this.highlightColor),e.setAttribute("stroke-width",this.config.highlightWidth)}hitTest(t){return MeasureUtil.isPointInPolygon(t,this.boundaryPts)?this:null}hide(){this.drawables[0].style.display="none",this.drawables[1].style.display="none"}show(){this.drawables[0].style.display="block",this.drawables[1].style.display="block"}getBoundaryPts(){return this.boundaryPts}}class QuarterRingArray extends Drawable{constructor(t){super(),this.config=t,this.colors=["#32D3A6","#1922FB","#FF2905"],this.ids=["xy","xz","yz"]}update(t){if(this.drawables.length>0){let e=0;for(const i of this.drawables)i.update(t[e++])}else for(let e=0;e<t.length;e++){let i=new QuarterRing({color:this.colors[e],opacity:.15,id:this.ids[e]});i.update(t[e]),this.drawables.push(i)}}hitTest(t){for(const e of this.drawables){let i=new THREE.Vector2(t.x,t.y),n=e.hitTest(i);if(n)return n}return null}setDefault(){for(const t of this.drawables)t.setDefault()}setGray(){for(const t of this.drawables)t.setGray()}hide(){for(const t of this.drawables)t.hide()}show(){for(const t of this.drawables)t.show()}getFullRingPts(t){let e=null;return"xy"===t&&(e=this.drawables[0]),"xz"===t&&(e=this.drawables[1]),"yz"===t&&(e=this.drawables[2]),e?e.getBoundaryPts():[]}}class RotationTips extends Drawable{constructor(t){super(),this.id=t.id,this.config=t,this.mapColors={xy:"#32D3A6",xz:"#1922FB",yz:"#FF2905"}}updateRingTip(t,e){this.drawables=[],this.boundaryPts=t;let i={};i.points=MeasureUtil.calcPolylinePoints(t),i.width="1px",i.color=this.mapColors[e],i.fillColor=this.mapColors[e];let n=MeasureUtil.makePolyline(i);this.drawables.push(n)}updateRotationAxis(t,e,i){let n=MeasureUtil.makeDashLine({color:this.mapColors[i],start:t,end:e});this.drawables.push(n)}updateRotationRangeLines(t,e,i,n){let o=MeasureUtil.makeLine({color:this.mapColors[n],start:t,end:e});this.drawables.push(o);let s=MeasureUtil.makeLine({color:this.mapColors[n],start:t,end:i});this.drawables.push(s)}hide(){for(const t of this.drawables)t.style.display="none"}show(){for(const t of this.drawables)t.style.display="block"}}class RotateNotation extends Drawable{constructor(){super(),this.backgroundColor="#111111",this.initialize()}initialize(){this.notationSegment={},this.notationOutline=null,this.annotationStyle={height:30,radius:3}}update(t,e){var i=this.calcAnnotationStyle(e,t),n=MeasureUtil.makeRectangle({x:i.offsetRect.x,y:i.offsetRect.y,width:i.width,height:this.annotationStyle.height,radius:this.annotationStyle.radius,fillColor:this.backgroundColor}),o=MeasureUtil.makeText({x:i.offsetText.x,y:i.offsetText.y,color:"#FFFFFF",fontsize:14,content:e});return this.drawables=[],this.drawables.push(n),this.drawables.push(o),this.drawables}calcAnnotationStyle(t,e){var i=0,n=new THREE.Vector2(e.x,e.y),o=new THREE.Vector2(e.x,e.y);return i=MeasureUtil.measureText(t),n.x-=i/2,n.y-=this.annotationStyle.height/2,o.x=n.x+15,o.y=n.y+20,{offsetRect:n,offsetText:o,width:i+=30}}}class RotateDrawables extends DataDrawables{constructor(t,e,i,n,o){super(t,e,i,n,o)}initialize(){this.drawables=[],this.isOnQuarterRing=!0,this.rotationAxisLength=400,this.updateBoundingBox(),this.updateCoordinateAxis(),this.updateQuarterRings(),this.addCloudViewerEvents()}updateQuarterRings(t){this.getBoundingBoxWorld().getCenter(this._quarterCenter);let e=55*this.factor,i=this.getRotationMatrix(),n=new THREE.Vector3(2*e,0,0).applyMatrix4(i),o=new THREE.Vector3(0,-2*e,0).applyMatrix4(i),s=new THREE.Vector3(0,0,2*e).applyMatrix4(i),r=22/19,a=[Math.PI/2,Math.PI/2,Math.PI/2];this.isOnQuarterRing||("xy"===t&&(a[0]=2*Math.PI),"xz"===t&&(a[1]=2*Math.PI),"yz"===t&&(a[2]=2*Math.PI));let l=.02,h=this._quarterCenter.clone().add(new THREE.Vector3(l*e,-.02*e,0).applyMatrix4(i)),c=h.clone().add(o),d=h.clone().add(o.clone().multiplyScalar(r)),u=this._calcRingPts(h,s,c,d,a[0]),p=this._quarterCenter.clone().add(new THREE.Vector3(l*e,0,l*e).applyMatrix4(i));c=p.clone().add(n),d=p.clone().add(n.clone().multiplyScalar(r));let g=this._calcRingPts(p,o,c,d,a[1]),m=this._quarterCenter.clone().add(new THREE.Vector3(0,-.02*e,l*e).applyMatrix4(i));c=m.clone().add(s),d=m.clone().add(s.clone().multiplyScalar(r));let f=this._calcRingPts(m,n,c,d,a[2]);this.quarterRings||(this.quarterRings=new QuarterRingArray,this.drawables.push(this.quarterRings)),this.quarterRings.detach(),this.quarterRings.update([u,g,f]),this.setRotationEN(),this.quarterRings.attach(this.domContainer)}updateRotationTips(t,e,i,n){let o=this.getRotationMatrix(),s=this.quarterRings.getFullRingPts(t),r=s[e],a=s[i],l=this.getEditObjectCenter();this.rotationTips||(this.rotationTips=new RotationTips({})),this.rotationTips.detach();let h=[],c=[],d=i-e>0?1:-1;Math.abs(i-e>180)&&(d=-d);for(let t=e;t!=i+d;t+=d){t>=360&&(t=0),t<0&&(t=359),h.push(s[t]);let e=720-t+1;c.push(s[e])}let u=h.concat(c.reverse());this.rotationTips.updateRingTip(u,t);let p=new THREE.Vector3(0,0,1).applyMatrix4(o);"xz"===t&&(p=new THREE.Vector3(0,1,0).applyMatrix4(o)),"yz"===t&&(p=new THREE.Vector3(1,0,0).applyMatrix4(o));let g=this.calcSegment(l,p,400);this._clientCenter||(this._clientCenter=this.viewer3D.worldToClient(l)),this.rotationTips.updateRotationAxis(g[0],g[1],t),this.rotationTips.updateRotationRangeLines(this._clientCenter,r,a,t),this.rotationTips.attach(this.domContainer),this.rotateNotation||(this.rotateNotation=new RotateNotation),this.rotateNotation.detach();let m=this._calcNotationPos(this._clientCenter,a,48),f=n;f>180&&(f-=360),this.rotateNotation.update(m,f+"°"),this.rotateNotation.attach(this.domContainer)}removeRotationTips(){this.rotationTips&&this.rotationTips.detach(),this.rotateNotation&&this.rotateNotation.detach(),delete this._clientCenter,delete this._clientAixsStart,delete this._clientAixsEnd}_calcRingPts(t,e,i,n,o){let s=[...ObjectEditorUtil.discreteCircle({center:t.clone(),arcStartPt:i,rotateAngle:o,normal:e.clone().normalize()}),...ObjectEditorUtil.discreteCircle({center:t.clone(),arcStartPt:n,rotateAngle:o,normal:e.clone().normalize()}).reverse()],r=[];for(const t of s)r.push(this.viewer3D.worldToClient(t));return this.isOnQuarterRing&&r.push(r[0]),r}_calcNotationPos(t,e,i){let n=new THREE.Vector2(t.x,t.y),o=new THREE.Vector2(e.x,e.y),s=o.clone().sub(n).normalize();return o.add(s.multiplyScalar(i))}getScale(t,e,i){let n=this.viewer3D.worldToClient(t),o=this.viewer3D.worldToClient(e),s=new THREE.Vector2(n.x,n.y),r=new THREE.Vector2(o.x,o.y);return i/s.distanceTo(r)}toFullRing(t){this.isOnQuarterRing=!1,this.updateQuarterRings(t)}fromFullRing(t){this.isOnQuarterRing=!0,this.updateQuarterRings(t)}updateCoordinateAxis(){let t=this.getBoundingBoxWorld(),e=this.getRotationMatrix(),i=[];i.push(new THREE.Vector3(1,0,0).applyMatrix4(e)),i.push(new THREE.Vector3(0,-1,0).applyMatrix4(e)),i.push(new THREE.Vector3(0,0,1).applyMatrix4(e));const n=this.viewer3D.worldToClient(t.getCenter(this._cCenter));let o=[];for(const e of i){let i=e.clone().multiplyScalar(130*this.factor).add(t.getCenter(this._center)),n=this.viewer3D.worldToClient(i);o.push(n)}this.dashlineArray||(this.dashlineArray=new DashlineArray({length:130,isEffectedByOthers:!0,colors:["#FF2905","#1922FB","#32D3A6"]}),this.drawables.push(this.dashlineArray)),this.dashlineArray.detach(),this.dashlineArray.update(n,o),this.setRotationEN(),this.dashlineArray.attach(this.domContainer)}getDirection(t){return"arrowX"===t?new THREE.Vector3(1,0,0):"arrowY"===t?new THREE.Vector3(0,-1,0):new THREE.Vector3(0,0,1)}calcSegment(t,e,i){if(!this._clientAixsStart||!this._clientAixsEnd){let n=e.clone().normalize().multiplyScalar(i*this.factor/2),o=t.clone().add(n),s=t.clone().sub(n);this._clientAixsStart=this.viewer3D.worldToClient(o.clone()),this._clientAixsEnd=this.viewer3D.worldToClient(s.clone())}return[this._clientAixsStart,this._clientAixsEnd]}addCloudViewerEvents(){let t=this.viewer3D.getViewer();this.updateBinded=this.update.bind(this),t.registerEventListener(CLOUD.EVENTS.ON_EDITOR_ZOOM,this.updateBinded),t.registerEventListener(CLOUD.EVENTS.ON_EDITOR_ROTATING,this.updateBinded),t.registerEventListener(CLOUD.EVENTS.ON_EDITOR_PANING,this.updateBinded)}removeCloudViewerEvents(){let t=this.viewer3D.getViewer();t.unregisterEventListener(CLOUD.EVENTS.ON_EDITOR_ZOOM,this.updateBinded),t.unregisterEventListener(CLOUD.EVENTS.ON_EDITOR_ROTATING,this.updateBinded),t.unregisterEventListener(CLOUD.EVENTS.ON_EDITOR_PANING,this.updateBinded)}update(){this.updateFactor(),this.updateBoundingBox(),this.updateCoordinateAxis(),this.updateQuarterRings()}getAllDrawables(){return this.drawables}setDefault(){for(const t of this.getAllDrawables())t.setDefault()}setGray(){for(const t of this.getAllDrawables())t.setGray()}select(){for(const t of this.getAllDrawables())if(t.select())return}hideAll(){for(const t of this.getAllDrawables())t.hide()}showAll(){for(const t of this.getAllDrawables())t.show()}dispose(){this.domContainer.innerHTML="",this.boundingBox=null,this.CoordinateAxis=null,this.removeCloudViewerEvents()}getEditObjectCenter(){return this.getBoundingBoxWorld().getCenter(this._modelCenter),this._modelCenter}updateController(t){null!=t.X&&(this.controller.X=t.X),null!=t.Y&&(this.controller.Y=t.Y),null!=t.Z&&(this.controller.Z=t.Z)}setRotationEN(){!this.quarterRings||this.quarterRings.drawables.length<=0||(this.controller.Y?(this.quarterRings.drawables[1].setDefault(),this.dashlineArray.drawables[1].setDefault()):(this.quarterRings.drawables[1].setGray(),this.dashlineArray.drawables[1].setGray()),this.controller.Z?(this.quarterRings.drawables[0].setDefault(),this.dashlineArray.drawables[2].setDefault()):(this.quarterRings.drawables[0].setGray(),this.dashlineArray.drawables[2].setGray()),this.controller.X?(this.quarterRings.drawables[2].setDefault(),this.dashlineArray.drawables[0].setDefault()):(this.quarterRings.drawables[2].setGray(),this.dashlineArray.drawables[0].setGray()))}}let DomNS$1=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Lang.Utility.Dom"),ObjectEditorNS=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Plugins.ObjectEditor");class ObjectEditorManager{constructor(t,e){this.viewer=t,this.editObjectType=e,this.activeEditors=[],this.rotationController={X:!0,Y:!0,Z:!0},this.translationController={X:!0,Y:!0,Z:!0},this.scaleController={Uniform:!0,X:!0,Y:!0,Z:!0},this.initilize()}initilize(){this.domContainer=DomNS$1.create("div","bf-ObjectEditor-conext"),this.domContainer.style.position="absolute",this.domContainer.style.left=0,this.domContainer.style.top=0,this.domContainer.style.width="100%",this.domContainer.style.height="100%",this.svgContainer=DomNS$1.createNS("svg","bf-ObjectEditor-svg"),this.svgContainer.style.width="100%",this.svgContainer.style.height="100%",this.domContainer.appendChild(this.svgContainer),this.viewer.getDomElement().appendChild(this.domContainer),this.addDomEventListeners(),this.offset=this.viewer.getDomElement().getBoundingClientRect();let t=new Glodon.Web.Lang.EventManager;this.getEventManager=function(){return t},this.activeEditor=new TranslateEditor(this.viewer,this.editObjectType,t,this.translationController),this._update=()=>this.activeEditor&&!this.activeEditor.isEditing&&this.updateController(),this.viewer.addEventListener("ModelTransformed",this._update),this.viewer.addEventListener("CameraPositionChanged",this._update)}setEditedObjectId(t){switch(this.editedObjectId=t,this.activeEditor.setEditedObjectId(t),this.dispose(),this.activeEditor.name){case"Translation":let t=new TranslateDrawables(this.viewer,this.svgContainer,this.editedObjectId,this.editObjectType,this.translationController);this.activeEditor.setDrawables(t);break;case"Scaling":let e=new ScaleDrawables(this.viewer,this.svgContainer,this.editedObjectId,this.editObjectType,this.scaleController);this.activeEditor.setDrawables(e)}}attachInitDrawables(){let t=new TranslateDrawables(this.viewer,this.svgContainer,this.editedObjectId,this.editObjectType,this.translationController);this.activeEditor.setDrawables(t)}getEditedObjectId(){return this.editedObjectId}activateEditor(t){switch(this.dispose(),t){case"Translation":this.activeEditor=new TranslateEditor(this.viewer,this.editObjectType,this.getEventManager(),this.translationController);let t=new TranslateDrawables(this.viewer,this.svgContainer,this.editedObjectId,this.editObjectType,this.translationController);this.activeEditor.setDrawables(t);break;case"Scaling":this.activeEditor=new ScaleEditor(this.viewer,this.editObjectType,this.getEventManager(),this.scaleController);let e=new ScaleDrawables(this.viewer,this.svgContainer,this.editedObjectId,this.editObjectType,this.scaleController);this.activeEditor.setDrawables(e);break;case"Rotation":this.activeEditor=new RotateEditor(this.viewer,this.editObjectType,this.getEventManager(),this.rotationController);let i=new RotateDrawables(this.viewer,this.svgContainer,this.editedObjectId,this.editObjectType,this.rotationController);this.activeEditor.setDrawables(i)}this.activeEditor.setEditedObjectId(this.editedObjectId)}dispose(){if(this.activateEditor){let t=this.activeEditor.getDrawables();t&&t.dispose()}}hide(){this.domContainer.style.display="none"}show(){this.domContainer.style.display=""}onExit(){this.viewer.removeEventListener("ModelTransformed",this._update),this.viewer.removeEventListener("CameraPositionChanged",this._update),this.dispose(),this.removeDomEventListeners(),this.destroySvgContainer(),this.isExitNow=!0}addDomEventListeners(){this.onMouseDownBinded=this.onMouseDown.bind(this),this.onMouseMoveBinded=this.onMouseMove.bind(this),this.onMouseUpBinded=this.onMouseUp.bind(this),this.onMouseDoubleClickBinded=this.onMouseDoubleClick.bind(this),this.onWindowResizeBinded=this.onWindowResize.bind(this);let t=this.svgContainer;t.addEventListener("mousemove",this.onMouseMoveBinded,!1),t.addEventListener("mousedown",this.onMouseDownBinded,!1),document.addEventListener("mouseup",this.onMouseUpBinded,!1),t.addEventListener("dblclick",this.onMouseDoubleClickBinded,!1),window.addEventListener("resize",this.onWindowResizeBinded,!1)}removeDomEventListeners(){let t=this.svgContainer;t.removeEventListener("mousemove",this.onMouseMoveBinded),t.removeEventListener("mousedown",this.onMouseDownBinded),document.removeEventListener("mouseup",this.onMouseUpBinded),t.removeEventListener("dblclick",this.onMouseDoubleClickBinded),window.removeEventListener("resize",this.onWindowResizeBinded)}destroySvgContainer(){this.domContainer.removeChild(this.svgContainer),this.svgContainer=null,this.viewer.getDomElement().removeChild(this.domContainer),this.domContainer=null}onMouseDown(t){this.isExitNow||t.button===THREE.MOUSE.LEFT&&this.activeEditor.begin(t)}onMouseMove(t){this.isExitNow||this.activeEditor.onEditing(t)}onMouseUp(t){this.isExitNow||t.button===THREE.MOUSE.LEFT&&(this.activeEditor.end(t),this.activeEditor.dataDrawables.update())}onMouseDoubleClick(t){this.isExitNow||(t.preventDefault(),t.stopPropagation())}onWindowResize(){this.activeEditor&&this.activeEditor.dataDrawables&&this.activeEditor.dataDrawables.update()}updateController(t,e){switch(e){case"Translation":null!=t.X&&(this.translationController.X=t.X),null!=t.Y&&(this.translationController.Y=t.Y),null!=t.Z&&(this.translationController.Z=t.Z);break;case"Rotation":null!=t.X&&(this.rotationController.X=t.X),null!=t.Y&&(this.rotationController.Y=t.Y),null!=t.Z&&(this.rotationController.Z=t.Z);break;case"Scaling":null!=t.X&&(this.scaleController.X=t.X),null!=t.Y&&(this.scaleController.Y=t.Y),null!=t.Z&&(this.scaleController.Z=t.Z),null!=t.Uniform&&(this.scaleController.Uniform=t.Uniform)}if(this.activeEditor.name===e){this.activeEditor.updateController(t);let e=this.activeEditor.getDrawables();e&&e.updateController(t)}this.onWindowResize()}}ObjectEditorNS.ObjectEditorManager=ObjectEditorManager;const ExternalObjectEditorToolbarEvent={Exit:"Exit",EditingModeChanged:"EditingModeChanged"};let DomNS$2=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.Dom");class ObjectEditorToolbar{constructor(t){this.viewer=t.viewer,this.objectId=t.objectId,this.viewer._objectEditorToolbar&&this.viewer._objectEditorToolbar.exit(),this.mode=null,this.toolBarButtons={translate:!t.buttonVisibility.hasOwnProperty("translate")||t.buttonVisibility.translate,rotate:!t.buttonVisibility.hasOwnProperty("rotate")||t.buttonVisibility.rotate,scale:!t.buttonVisibility.hasOwnProperty("scale")||t.buttonVisibility.scale},this.viewer._objectEditorToolbar=this,this.rotationController={X:!t.rotationController.hasOwnProperty("X")||t.rotationController.X,Y:!t.rotationController.hasOwnProperty("Y")||t.rotationController.Y,Z:!t.rotationController.hasOwnProperty("Z")||t.rotationController.Z},this.translationController={X:!t.translationController.hasOwnProperty("X")||t.translationController.X,Y:!t.translationController.hasOwnProperty("Y")||t.translationController.Y,Z:!t.translationController.hasOwnProperty("Z")||t.translationController.Z},this.scaleController={Uniform:!t.scaleController.hasOwnProperty("Uniform")||t.scaleController.Uniform,X:!t.scaleController.hasOwnProperty("X")||t.scaleController.X,Y:!t.scaleController.hasOwnProperty("Y")||t.scaleController.Y,Z:!t.scaleController.hasOwnProperty("Z")||t.scaleController.Z}}setRotationController(t){t&&(this.rotationController=t),this.objectEditorManager.updateController(this.rotationController,"Rotation")}getRotationController(){let t={};return t.X=!this.rotationController.hasOwnProperty("X")||this.rotationController.X,t.Y=!this.rotationController.hasOwnProperty("Y")||this.rotationController.Y,t.Z=!this.rotationController.hasOwnProperty("Z")||this.rotationController.Z,t}setTranslationController(t){t&&(this.translationController=t),this.objectEditorManager.updateController(this.translationController,"Translation")}getTranslationController(){let t={};return t.X=!this.translationController.hasOwnProperty("X")||this.translationController.X,t.Y=!this.translationController.hasOwnProperty("Y")||this.translationController.Y,t.Z=!this.translationController.hasOwnProperty("Z")||this.translationController.Z,t}setScaleController(t){t&&(this.scaleController=t),this.objectEditorManager.updateController(this.scaleController,"Scaling")}getScaleController(){let t={};return t.X=!this.scaleController.hasOwnProperty("X")||this.scaleController.X,t.Y=!this.scaleController.hasOwnProperty("Y")||this.scaleController.Y,t.Z=!this.scaleController.hasOwnProperty("Z")||this.scaleController.Z,t.Uniform=!this.scaleController.hasOwnProperty("Uniform")||this.scaleController.Uniform,t}setButtonVisibility(t){t&&(this.toolBarButtons=t,this._updateButtonsVisibility())}getButtonVisibility(){let t={};return t.translate=!this.toolBarButtons.hasOwnProperty("translate")||this.toolBarButtons.translate,t.rotate=!this.toolBarButtons.hasOwnProperty("rotate")||this.toolBarButtons.rotate,t.scale=!this.toolBarButtons.hasOwnProperty("scale")||this.toolBarButtons.scale,t}_updateButtonsVisibility(){this.toolBarButtons.scale||this.toolBarButtons.rotate||this.toolBarButtons.translate?(this.switchToolbarAllHide=!1,this.show()):(this.setBimfaceUIVisibility(!1),this.switchToolbar.hide(),this.switchToolbarAllHide=!0);let t=this.switchToolbar.getControls(),e=this.getButton("Translation",t),i=this.getButton("Rotation",t),n=this.getButton("Scaling",t);this.toolBarButtons.translate?e.show():e.hide(),this.toolBarButtons.rotate?i.show():i.hide(),this.toolBarButtons.scale?n.show():n.hide()}_updateController(){this.objectEditorManager&&(this.objectEditorManager.updateController(this.translationController,"Translation"),this.objectEditorManager.updateController(this.rotationController,"Rotation"),this.objectEditorManager.updateController(this.scaleController,"Scaling"))}setEditingMode(t){if(this.objectEditorManager){switch(t){case"rotation":this.mode="rotation",this.objectEditorManager.activateEditor("Rotation");break;case"translation":this.mode="translation",this.objectEditorManager.activateEditor("Translation");break;case"scale":this.mode="scale",this.objectEditorManager.activateEditor("Scaling")}this.objectEditorManager.show()}}getEditingMode(){return this.mode}setEditedObjectId(t){this.objectEditorManager.setEditedObjectId(t)}getEditedObjectId(){return this.objectEditorManager.getEditedObjectId()}show(){this._destroyed||("Viewer3D"===this.viewer.viewerType&&this.viewer.hideViewHouse(),this.setBimfaceUIVisibility(!1),this.modelEditor.show(),this.switchToolbarAllHide||this.switchToolbar.show(),this.objectEditorManager.show())}hide(){this._destroyed||("Viewer3D"===this.viewer.viewerType&&this.viewer.showViewHouse(),this.setBimfaceUIVisibility(!0),this.modelEditor.hide(),this.switchToolbar.hide(),this.objectEditorManager.hide())}exit(){this._destroyed||(this.hide(),this._getEventManager().fireEvent(ExternalObjectEditorToolbarEvent.Exit),this.objectEditorManager.onExit(),delete this.viewer._objectEditorToolbar,this.destroy())}destroy(){this.viewer.getDomElement().removeChild(this.domElement),this.domElement=null,this.viewer=null,this.objectId=null,this.objectEditorManager=null,this._destroyed=!0}update(){}updateManagerController(t,e){this.objectEditorManager.updateController(t,type)}initialize(){this.mapUIVisibility={"bf-tree-toolbar":"none","bf-modelTree-panel":"none","bf-toolbar-bottom":"none","bf-property-panel":"none","bf-measurement-panel":"none","bf-sectionPlane-panel":"none","bf-pickSectionPlane-panel":"none","bf-sectionBox-panel":"none","bf-settings-panel":"none","bf-basicInfo-panel":"none","bf-map-panel":"none"},this.recordUIVisibility()}toolBarDom(){const t=this;let e=[];const i=DomNS$2.create("div","bf-roomEditorToolbar");if(t.domElement=i,i.style.zIndex=1,i.addEventListener("mousedown",(t=>(t.stopPropagation(),!1))),void 0===this.switchToolbar){var n=Glodon$1.Bimface.UI.Toolbar.ToolbarConfig();n.className="bf-toolbar bf-toolbar-roomEditor",n.element=i,n.buttons=["ModelEditingTranslate","ModelEditingRotate","ModelEditingScale"],this.viewer.getDomElement().appendChild(i),this.switchToolbar=new Glodon$1.Bimface.Application.UI.Toolbar.Toolbar(n),e.push(this.switchToolbar)}let o=Glodon$1.Bimface.UI.Control.ControlEvent,s=this.switchToolbar.getControls();this.uncheckOthers("Translation",s);let r=["Translation","Rotation","Scaling"];t._editingMode="Translation";for(let e=0;e<s.length;e++){let i=s[e];i.addEventListener(o.Click,(function(){if(i.isChecked()){t.objectEditorManager.activateEditor(r[e]),t.uncheckOthers(i.getId(),s);let n="Scaling"===i.getId()?"Scale":i.getId();t._getEventManager().fireEvent(ExternalObjectEditorToolbarEvent.EditingModeChanged,{previousEditingMode:t._editingMode,followingEditingMode:n}),t._editingMode=n}else i.toggleCheckedState()}))}const a=new Glodon$1.Bimface.UI.Toolbar.ToolbarConfig;a.element=i,a.className="bf-toolbar bf-toolbar-roomEditor";let l=t.modelEditor=new Glodon$1.Bimface.UI.Toolbar.Toolbar(a);t.modelEditor=l,e.push(l);const h=new Glodon$1.Bimface.UI.Button.ButtonConfig;h.className="bf-modeleditor-cancel",h.title=BimfaceLanguage.bf_general_exit;const c=new Glodon$1.Bimface.UI.Button.SingleButton(h);c.setHtml("退出"===BimfaceLanguage.bf_general_exit?"退 出":BimfaceLanguage.bf_general_exit),c.addEventListener("Click",(()=>{this.exit()})),l.addControl(c),this.viewer.getDomElement().appendChild(i),this._updateButtonsVisibility(),this._updateController()}recordUIVisibility(){let t=Object.keys(this.mapUIVisibility);for(const e of t){let t=document.getElementsByClassName(e);t.length>0&&(this.mapUIVisibility[e]=t[0].style.display)}}uncheckOthers(t,e){for(const i of e)i.getId()===t?i.setCheckedState(!0):i.setCheckedState(!1)}getButton(t,e){for(let i=0;i<e.length;i++){let n=e[i];if(n.getId()===t)return n}}setBimfaceUIVisibility(t){let e=Object.keys(this.mapUIVisibility);for(const i of e){let e=document.getElementsByClassName(i);0!=e.length&&(e[0].style.display=0==t?"none":this.mapUIVisibility[i])}}_getEventManager(){return this.objectEditorManager.getEventManager()}addEventListener(t,e){this._getEventManager().addEvent(t,e)}removeEventListener(t,e){this._getEventManager().removeEvent(t,e)}}function getRealModelId(t){let e=t.modelId;if("ViewerGIS"===t.viewer.getViewerType()&&t.layerId){const i=t.viewer.getLayerManager().getLayer(t.layerId);i&&(e=i.getModelId())}return e}Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.ModelEditor").ModelEditorToolbarConfig=function(){return{viewer:null,modelId:null,layerId:null,app:null,buttonVisibility:{},translationController:{},rotationController:{},scaleController:{}}},function(){let t=Glodon$1.Bimface.Data.StatisticsDataManager.getInstance(),e=(Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.Dom"),Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.ModelEditor"));e.ModelEditorToolbar=class extends ObjectEditorToolbar{constructor(e){t.send("Bimface.Plugins.ModelEditor","ModelEditorToolbar"),e.objectId=getRealModelId(e),super(e),this.name="ModelEditorToolbar",this.editedId=e.objectId,this.initialize(),this.toolBarDom()}setButtonVisibility(t){super.setButtonVisibility(t)}getButtonVisibility(){return super.getButtonVisibility()}setEditedModelId(t){super.setEditedObjectId(t)}getEditedModelId(){return super.getEditedObjectId()}setEditedModel(t){const e=getRealModelId({viewer:this.viewer,modelId:t,layerId:t});super.setEditedObjectId(e),this.editedId=t}getEditedModel(){return this.editedId}show(){super.show()}hide(){super.hide()}exit(){super.exit()}setRotationController(t){super.setRotationController(t)}getRotationController(){return super.getRotationController()}setTranslationController(t){super.setTranslationController(t)}getTranslationController(){return super.getTranslationController()}setScaleController(t){super.setScaleController(t)}getScaleController(){return super.getScaleController()}setEditingMode(t){super.setEditingMode(t)}getEditingMode(){return super.getEditingMode()}addEventListener(t,e){super.addEventListener(t,e)}removeEventListener(t,e){super.removeEventListener(t,e)}initialize(){super.initialize(),this.objectEditorManager=new ObjectEditorManager(this.viewer,"Model"),this.objectEditorManager.setEditedObjectId(this.objectId)}}}(),function(){var t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.ModelEditor");let e=Object.freeze({ModelTransformStart:"ModelTransformStart",ModelTransforming:"ModelTransforming",ModelTransformEnd:"ModelTransformEnd",Exit:"Exit",EditingModeChanged:"EditingModeChanged"});t.ModelEditorToolbarEvent=e}(),Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.ExternalObject").loadersConfig=function(){return{"3DS":{loaderName:"TDSLoader",loaderFiles:["TDSLoader.js"]},FBX:{loaderName:"FBXLoader",loaderFiles:["fflate.min.js","FBXLoader.js"]},OBJ:{loaderName:"OBJLoader",loaderFiles:["OBJLoader.js"]},MTL:{loaderName:"MTLLoader",loaderFiles:["MTLLoader.js"]}}},function(){const t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Common");t.Console=class{constructor(){this.consoleType="log",this._enable=!0}formatData(t){return"."!==(t=t.toString())[t.length-1]&&(t+="."),t}setConsoleType(t){["log","warn","error","info"].indexOf(t)>=0&&(this.consoleType=t)}warn(t){this._enable&&console[this.consoleType](`[BIMFACE WARN]: ${this.formatData(t)}`)}info(t){this._enable&&console[this.consoleType](`[BIMFACE INFO]: ${this.formatData(t)}`)}error(t){this._enable&&console[this.consoleType](`[BIMFACE ERROR]: ${this.formatData(t)}`)}obsolete(t,e){if(!this._enable)return;const i=t=>(")"!==(t=t.toString())[t.length-1]&&(t+="()"),t),n=`${t=i(t)} is obsolete, please use ${e=i(e)} instead.`;this.setConsoleType("warn"),this.warn(n)}updateDataSource(t){this._enable&&console.error(`[BIMFACE ERROR]:${t} is not compatible with the data source. Please upgrade the data source and try again.`)}open(){this._enable=!0,this.info("Console opened")}close(){this.info("Console closed"),this._enable=!1}}}(),function(){var t="Bimface.Plugins.ExternalObject.ExternalObjectManager",e=Glodon$1.Bimface.Data.StatisticsDataManager.getInstance();let i=Glodon$1.Web.Lang.Utility.HttpRequest,n=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.ExternalObject");n.ExternalObjectManager=class{constructor(i){if(e.send(t,"bf_c_extObjMng_new"),i._plugins&&i._plugins.externalObjectManager)return i._plugins.externalObjectManager;i._plugins&&(i._plugins.externalObjectManager=this),this._viewer=i,i.externalComponentManager&&!i.externalComponentManager.isDestroyed()||(i.externalComponentManager=new CLOUD.ExternalComponentManager(i.getViewer()),i.externalComponentManager._objects={}),this._manager=i.externalComponentManager,this._objects=this._manager._objects,this.modelId="ExternalComponent";let n=new Glodon$1.Web.Lang.EventManager;return this.getEventManager=function(){return n},this.urlMap={},i.externalObjectManager=this,this.enableLight=!1,this.console=new Glodon$1.Web.Common.Console,this}addEventListener(t,e){this.getEventManager().addEvent(t,e)}removeEventListener(t,e){this.getEventManager().removeEvent(t,e)}addObject(i,n,o){return e.send(t,"bf_c_extObjMng_addObj"),console.warn("[BIMFACE WARN]: ExternalObjectManager.addObject(name, object, modelId) is obsolete, please use ExternalObjectManager.loadObject(option, successCallback, failureCallback) instead."),this._addObject(i,n,o)}_addObject(t,e,i,n){if(!this.getObjectIdByName(t)){if(!this.enableLight){let t=e.children.filter((t=>"AmbientLight"!==t.type));e.children=t}var o=Glodon$1.Web.Lang.Utility.UUID.createUUID();return this._manager.addNode(o,e),this._objects[o]=t,this._viewer.getViewer().render(),"Viewer3D"===this._viewer.getViewerType()&&this._manager.bindModel(o,i||e._modelId||this._viewer.getDefaultModel().modelId,n),o}console.warn(`[ExternalObjectManager.addObject] 已有名为 "${t}" 的ExternalObject，请更换名称后再执行ExternalObjectManager.addObject()`)}_isNameRepeated(t,e){const i=this.urlMap[t].optionList;for(const t of i)if(t.name===e)return!0;return!1}addObjectByUrl(t,e,i,n,o){console.warn("[BIMFACE WARN]: ExternalObjectManager.addObjectByUrl(name, objectUrl, callback, modelId) is obsolete, please use ExternalObjectManager.loadObject(option, successCallback, failureCallback) instead."),this.loadObject({name:t,url:{objectUrl:e.url,mtlUrl:e.mtlUrl},association:{modelId:n}},i,o)}loadObject(t,e,n){const o=t.name,s=t.url,r=s&&s.objectUrl;if(!o||!r&&!t.object)return console.warn("[BIMFACE WARN]: option.name and (option.url.objectUrl or option.object) must not be undefined"),void(n&&n());void 0!==t.enableLight&&(this.enableLight=t.enableLight);const a=t.association&&t.association.modelId,l=t.association&&t.association.objectId;let h=this;function c(){if(CLOUD.Utils.isDefined(t.objectData)){let e=h.getObjectIdByName(o);h.setObjectData(e,t.objectData)}e&&e()}if(CLOUD.Utils.isDefined(t.object)){const e=this._addObject(o,t.object,a,l);if(e)return c(),e;n&&n()}else if(CLOUD.Utils.isDefined(s)){if(this.urlMap[r]&&!0===this.urlMap[r].pending){this.urlMap[r].callbackList.push(c),n&&this.urlMap[r].errorCallbackList.push(n);const t={name:o,modelId:a,bindObjectId:l};if(this._isNameRepeated(r,o))return;return void this.urlMap[r].optionList.push(t)}if(this.urlMap[r]&&!1===this.urlMap[r].pending)return this.cloneWithModelId(this.urlMap[r].originId,o,a,l),void c();this.urlMap[r]={},this.urlMap[r].pending=!0,this.urlMap[r].callbackList=[],this.urlMap[r].callbackList.push(c),this.urlMap[r].errorCallbackList=[],n&&this.urlMap[r].errorCallbackList.push(n);const t={name:o,modelId:a,bindObjectId:l};this.urlMap[r].optionList=[t];new Promise(((t,e)=>{const n=window.BimfaceLoaderConfig.fullStaticHost,r=Glodon$1.Bimface.Plugins.ExternalObject.loadersConfig();let h=[];for(let t in s){if(void 0===s[t])continue;let e=s[t].split(".").pop().toUpperCase(),i=r[e]&&r[e].loaderFiles;if(void 0===i)return console.warn("File format not supported, currently supported formats: 3DS, FBX, OBJ."),!1;i.forEach((t=>{h.push(`${n}/lib/loaders/${t}`)}))}i.getScripts(h,(()=>{const{objectUrl:i,mtlUrl:n}=s,h=i.split(".").pop().toUpperCase(),c=r[h].loaderName;let d=new THREE[c];if(void 0===n)d.load(i,(e=>{const n=this._addObject(o,e,a,l);this.urlMap[i].originId=n,this.urlMap[i].pending=!1,t()}),(()=>{}),(()=>{e()}));else{(new THREE.MTLLoader).load(n,(n=>{n.preload(),d.setMaterials(n),d.load(i,(e=>{const n=this._addObject(o,e,a,l);this.urlMap[i].originId=n,this.urlMap[i].pending=!1,t()}),(()=>{}),(()=>{e()}))}),(()=>{}),(()=>{e()}))}}))})).then((()=>{this.urlMap[r].callbackList.map(((t,e)=>{const{name:i,modelId:n,bindObjectId:o}=this.urlMap[r].optionList[e];this.cloneWithModelId(this.urlMap[r].originId,i,n,o),t()}))})).catch((()=>{for(let t of this.urlMap[r].errorCallbackList)t();this.urlMap[r]=null}))}}cloneWithModelId(t,e,i,n){let o=this.clone(t,e);"Viewer3D"===this._viewer.getViewerType()&&this._manager.bindModel(o,i||this._viewer.getDefaultModel().modelId,n)}getAssociatedInfo(t){return this._manager.getBindedInfo(t)}clone(t,e){if(!this._objects[t])return void console.warn(`[ExternalObjectManager.clone] 没有id为 "${t}" 的ExternalObject，先执行ExternalObjectManager.addObject()`);if(this.getObjectIdByName(e))return;const i=Glodon$1.Web.Lang.Utility.UUID.createUUID();return this._manager.cloneNode(t,i),this._objects[i]=e,i}getObjectIdByName(t){for(var e in this._objects)if(this._objects[e]===t)return e}overrideColor(i,n){e.send(t,"overrideColor");const o=this._viewer.getViewer().getFilter(),s={color:parseInt(n.getHEX(),16),opacity:n.getAlpha()};i.all?o.addToOverrideListByConditions([],s,this.modelId):(i.ids&&o.addToOverrideListByColor(i.ids,s,this.modelId),i.objectData&&o.addToOverrideListByConditions(i.objectData,s,this.modelId))}restoreColor(i){e.send(t,"restoreColor"),i.all?this._viewer.getViewer().getFilter().addToOverrideListByConditions([],null,this.modelId):(i.ids&&this._viewer.getViewer().getFilter().addToOverrideListByColor(i.ids,null,this.modelId),i.objectData&&this._viewer.getViewer().getFilter().addToOverrideListByConditions(i.objectData,null,this.modelId))}getAllObjectIds(){return Object.keys(this._objects)}removeById(t){if(this._objects[t]){this.clearRelationshipById(t),this.removeGlowEffectById([t]),this._manager.removeNodeById(t),delete this._objects[t];const e=this._getCloneOriginUrlById(t);void 0!==e&&delete this.urlMap[e],this._viewer.getViewer().render()}}removeByIds(t){this.removeGlowEffectById(t);for(var e=0;e<t.length;e++){const i=t[e];if(this.clearRelationshipById(i),!this._objects[i])continue;this._manager.removeNodeById(i),delete this._objects[i];const n=this._getCloneOriginUrlById(i);void 0!==n&&delete this.urlMap[n]}this._viewer.getViewer().render()}clear(){var t=Object.keys(this._objects);t.length>0&&this.removeGlowEffectById(t),this._manager.clearNodes(),this._objects={},this._manager._objects={},this.urlMap={},this.relationshipsMap=null,this._viewer.getViewer().render()}hide(t){if(!CLOUD.Utils.isDefined(t))return;const e=this._manager.getFilter();if(!CLOUD.Utils.isDefined(e))return;if(CLOUD.Utils.isDefined(t.all)&&1==t.all)return void e.hideAll();let i=[];CLOUD.Utils.isDefined(t.objectData)&&(Array.isArray(t.objectData)||(t.objectData=[t.objectData]),i=i.concat(e.getMatchIds(t.objectData))),CLOUD.Utils.isDefined(t.ids)&&(i=i.concat(t.ids)),i=Array.from(new Set(i)),0!==i.length&&e.hideByIds(i)}show(t){if(!CLOUD.Utils.isDefined(t))return;const e=this._manager.getFilter();if(!CLOUD.Utils.isDefined(e))return;if(CLOUD.Utils.isDefined(t.all)&&1==t.all)return void e.showAll();let i=[];CLOUD.Utils.isDefined(t.objectData)&&(Array.isArray(t.objectData)||(t.objectData=[t.objectData]),i=i.concat(e.getMatchIds(t.objectData))),CLOUD.Utils.isDefined(t.ids)&&(i=i.concat(t.ids)),i=Array.from(new Set(i)),0!==i.length&&e.showByIds(i)}select(t){let e=this._viewer.getViewer();if(!CLOUD.Utils.isDefined(t))return;const i=this._manager.getFilter();if(!CLOUD.Utils.isDefined(i))return;if(CLOUD.Utils.isDefined(t.all)&&1==t.all)return e.addToSelection(this.getAllObjectIds(),this.modelId),void e.render();let n=[];CLOUD.Utils.isDefined(t.objectData)&&(Array.isArray(t.objectData)||(t.objectData=[t.objectData]),n=n.concat(i.getMatchIds(t.objectData))),CLOUD.Utils.isDefined(t.ids)&&(n=n.concat(t.ids)),n=Array.from(new Set(n)),0!==n.length&&(e.addToSelection(n,this.modelId),e.render())}removeSelection(t){let e=this._viewer.getViewer();if(!CLOUD.Utils.isDefined(t))return;const i=this._manager.getFilter();if(!CLOUD.Utils.isDefined(i))return;if(CLOUD.Utils.isDefined(t.all)&&1==t.all)return e.clearSelection(),void e.render();let n=[];CLOUD.Utils.isDefined(t.objectData)&&(Array.isArray(t.objectData)||(t.objectData=[t.objectData]),n=n.concat(i.getMatchIds(t.objectData))),CLOUD.Utils.isDefined(t.ids)&&(n=n.concat(t.ids)),n=Array.from(new Set(n)),0!==n.length&&(e.removeFromSelection(n,this.modelId),e.render())}convert(t,e){!1!==e&&(e=!0);const i=DataUtil.assertType(t,"obj")&&t.modelId?`${t.modelId}_${t.objectId}`:t;return this._viewer.getExternalObjectConverter().convertToExternalObject(i,t,e)}_fireTransformedEvent(t){this.getEventManager().fireEvent(Glodon$1.Bimface.Viewer.Viewer3DEvent.ExternalObjectTransformed,t,this.getPosition(t)),this._viewer.getViewer().updateGlowEffect(this.modelId,t),this._viewer.updateSceneBoundingBox(!1)}translate(t,e){let i=this.getAllChildrenId(t);i&&i.length>0&&i.forEach((t=>this._manager.setAccumulateTransform(t,e))),this._manager.setAccumulateTransform(t,e),this._viewer.getViewer().render(),this._fireTransformedEvent(t)}rotateOnBasePoint(t,e,i,n){let o=this.getAllChildrenId(t);o&&o.length>0&&o.forEach((t=>this._manager.rotateOnBasePoint(t,e,i,n))),this._manager.rotateOnBasePoint(t,e,i,n),this._viewer.getViewer().render(),this._fireTransformedEvent(t)}scaleOnBasePoint(t,e,i){this._manager.scaleOnBasePoint(t,e,i),this._viewer.getViewer().render(),this._fireTransformedEvent(t)}getBoundingBoxById(t){return this._manager.getBoundingBoxById(t)}_getValid3dParam(t){if("[object Object]"===Object.prototype.toString.call(t)&&t.hasOwnProperty("x")&&t.hasOwnProperty("y")&&t.hasOwnProperty("z"))return new THREE.Vector3(t.x,t.y,t.z)}setPosition(t,e){var i=this._getValid3dParam(e);i&&(this._manager.setTransform(t,i,void 0,void 0,void 0,!0),this._viewer.getViewer().render(),this._fireTransformedEvent(t))}getPosition(t){var e=this._manager.getTransform(t);if(e&&e.position){var i=e.position;return{x:i.x,y:i.y,z:i.z}}}offset(t,e){var i=this._getValid3dParam(e);if(!i)return;let n=this.getAllChildrenId(t);n&&n.length>0&&n.forEach((t=>this._manager.setAccumulateOffset(t,i))),this._manager.setAccumulateOffset(t,i),this._viewer.getViewer().render(),this._fireTransformedEvent(t)}offsetX(t,e){this.offset(t,{x:e,y:0,z:0})}offsetY(t,e){this.offset(t,{x:0,y:e,z:0})}offsetZ(t,e){this.offset(t,{x:0,y:0,z:e})}rotate(t,e){var i=this._getValid3dParam(e);if(!i)return;let n=this.getAllChildrenId(t);n&&n.length>0&&n.forEach((t=>this._manager.setAccumulateTransform(t,void 0,void 0,i))),this._manager.setAccumulateTransform(t,void 0,void 0,i),this._viewer.getViewer().render(),this._fireTransformedEvent(t)}rotateX(t,e){this.rotate(t,{x:e,y:0,z:0})}rotateY(t,e){this.rotate(t,{x:0,y:e,z:0})}rotateZ(t,e){this.rotate(t,{x:0,y:0,z:e})}setRotationX(t,e,i){let n=new THREE.Vector3(1,0,0);this.rotateOnBasePoint(t,e,n,i)}setRotationY(t,e,i){let n=new THREE.Vector3(0,1,0);this.rotateOnBasePoint(t,e,n,i)}setRotationZ(t,e,i){let n=new THREE.Vector3(0,0,1);this.rotateOnBasePoint(t,e,n,i)}scale(t,e){var i=this._getValid3dParam(e);i&&0!==i.x&&0!==i.y&&0!==i.z&&(this._manager.setAccumulateTransform(t,void 0,i),this._viewer.getViewer().render(),this._fireTransformedEvent(t))}scaleX(t,e){this.scale(t,{x:e,y:1,z:1})}scaleY(t,e){this.scale(t,{x:1,y:e,z:1})}scaleZ(t,e){this.scale(t,{x:1,y:1,z:e})}getTransformation(t){if(!this._manager._hasObjectId(t))return;const[e]=this._manager.meshes[t];if(e){return e.matrix.clone().elements}}setTransformation(t,e){if(!this._manager._hasObjectId(t))return;if(["[object Float32Array]","[object Array]"].indexOf(Object.prototype.toString.call(e))<0)return;const i=new THREE.Matrix4;i.fromArray(e),this._manager.applyTransformMatrix(t,i,!0),this._viewer.getViewer().render(),this._fireTransformedEvent(t)}setGlowEffectById(i,n){e.send(t,"setGlowEffectById");var o=new THREE.Color("#11DAB7"),s="body",r=.3,a=3,l=!1;null!=n&&(null!=n.type&&(s=n.type),null!=n.color&&n.color instanceof Glodon$1.Web.Graphics.Color&&(o=new THREE.Color(n.color.red/255,n.color.green/255,n.color.blue/255)),null!=n.intensity&&(r=n.intensity),null!=n.spread&&(a=n.spread),null!=n.isGis&&(l=n.isGis)),this._viewer.getViewer().setGlowEffectById(this.modelId,i,{color:o,type:s,intensity:r,spread:a,isGis:l}),this._viewer.render()}removeGlowEffectById(i){if(e.send(t,"removeGlowEffectById"),null==i||0==i.length)return void console.warn("没有发光效果被删除。");this._viewer.getViewer().removeGlowEffectById(this.modelId,i),this._viewer.render()}clearGlowEffect(){e.send(t,"clearGlowEffect"),this._viewer.getViewer().removeGlowEffectById(this.modelId),this._viewer.render()}play(t,e=0){this.isAnimatable(t)?this._manager.play(t,e):console.warn("there is no animation in the mesh")}pause(t){this._manager.pause(t)}stop(t){this._manager.stop(t)}isAnimatable(t){return this._manager.isAnimation(t)}getObjectByName(t){const e=this.getAllObjects(),i=this.getObjectIdByName(t);return e.find((t=>t.name===i))}removeByName(t){let e=this.getObjectIdByName(t);this.removeById(e)}getAllObjects(){return this._manager.getAllMeshes()}setObjectData(t,e){if(Array.isArray(e)){let i={};e.forEach((t=>{i=Object.assign({},i,t)})),this._manager.setObjectData(t,i)}else this._manager.setObjectData(t,e)}getObjectData(t){return this._manager.getObjectData(t)}_getCloneOriginUrlById(t){for(const e in this.urlMap)if(this.urlMap[e].originId===t)return e}toLocalPosition(t,e){if(3===arguments.length){console.warn("[BIMFACE WARN]: ExternalObjectManager.toLocalPosition(id, worldPosition, worldVector) is obsolete, please use ExternalObjectManager.toLocalPosition(id, option) instead.");const e=arguments[1],i=arguments[2];if(!this._manager._hasObjectId(t))return;const n=this._manager.getTransform(t),o=(new THREE.Matrix4).compose(n.position,n.rotate,n.scale).clone().invert();let s,r;if(e){s=new THREE.Vector3(e.x,e.y,e.z).applyMatrix4(o).toArray()}if(i){r=new THREE.Vector3(i.x,i.y,i.z).applyMatrix4(o),r=r.normalize().toArray()}return{localPosition:s,localVector:r}}const{worldPosition:i,worldVector:n}=e;if(!this._manager._hasObjectId(t))return;const o=this._manager.getTransform(t),s=(new THREE.Matrix4).compose(o.position,o.rotate,o.scale).clone().invert();let r,a;if(i){r=new THREE.Vector3(i.x,i.y,i.z).applyMatrix4(s),r={x:r.x,y:r.y,z:r.z}}if(n){a=new THREE.Vector4(n.x,n.y,n.z,0).applyMatrix4(s),a.normalize(),a={x:a.x,y:a.y,z:a.z}}return{localPosition:r,localVector:a}}toWorldPosition(t,e){if(3===arguments.length){console.warn("[BIMFACE WARN]: ExternalObjectManager.toWorldPosition(id, localPosition, localVector) is obsolete, please use ExternalObjectManager.toWorldPosition(id, option) instead.");const e=arguments[1],i=arguments[2];if(!this._manager._hasObjectId(t))return;const n=this._manager.getTransform(t),o=(new THREE.Matrix4).compose(n.position,n.rotate,n.scale);let s,r;if(e){s=new THREE.Vector3(e.x,e.y,e.z).applyMatrix4(o).toArray()}if(i){r=new THREE.Vector3(i.x,i.y,i.z).applyMatrix4(o),r=r.normalize().toArray()}return{worldPosition:s,worldVector:r}}const{localPosition:i,localVector:n}=e;if(!this._manager._hasObjectId(t))return;const o=this._manager.getTransform(t),s=(new THREE.Matrix4).compose(o.position,o.rotate,o.scale);let r,a;if(i){r=new THREE.Vector3(i.x,i.y,i.z).applyMatrix4(s),r={x:r.x,y:r.y,z:r.z}}if(n){a=new THREE.Vector4(n.x,n.y,n.z,0).applyMatrix4(s),a.normalize(),a={x:a.x,y:a.y,z:a.z}}return{worldPosition:r,worldVector:a}}setHierarchy(t){return this.temporaryMap=new Map,this.isCorrectRelationships=!0,this.getTemporaryMap(null,t.id,t.children),this.isCorrectRelationships?this.relationshipsMap?this.checkLegal()?(this.combineMap(),!0):(this.console.warn("The hierarchical structure was wrong due to the duplication of objects in different hierarchies."),!1):(this.relationshipsMap=this.temporaryMap,!0):(this.console.warn("The hierarchical structure was wrong due to the duplication of objects in different hierarchies."),!1)}getTemporaryMap(t,e,i){if(!this.isCorrectRelationships)return;let n=[];for(let t=0;t<i.length;t++)if(n.push(i[t].id),i[t].children&&i[t].children.length>0)this.getTemporaryMap(e,i[t].id,i[t].children);else{if(this.temporaryMap.has(i[t].id))return void(this.isCorrectRelationships=!1);this.temporaryMap.set(i[t].id,{father:e,children:[]})}this.temporaryMap.has(e)?this.isCorrectRelationships=!1:this.temporaryMap.set(e,{father:t,children:n})}checkLegal(){let t=!0,e={};return this.relationshipsMap.forEach(((t,i)=>{e[i]=this.getAncestors(i)})),this.temporaryMap.forEach(((i,n)=>{let o=i.children;for(let i=0;i<o.length;i++)if(e[n]&&e[n].indexOf(o[i])>-1)return void(t=!1)})),t}getAncestors(t){let e=[],i=this.relationshipsMap.get(t).father;return i&&(e.push(i),e=[...e,...this.getAncestors(i)]),e}combineMap(){this.relationshipsMap&&this.temporaryMap&&this.temporaryMap.forEach(((t,e)=>{if(this.relationshipsMap.has(e)){let i=t.children;for(let t=0;t<i.length;t++)if(this.relationshipsMap.has(i[t]))if(this.relationshipsMap.get(e).children.indexOf(i[t])>-1);else{if(this.relationshipsMap.get(i[t]).father!==e){if(this.relationshipsMap.get(i[t]).father){let e=this.relationshipsMap.get(this.relationshipsMap.get(i[t]).father).children.indexOf(i[t]);this.relationshipsMap.get(this.relationshipsMap.get(i[t]).father).children.splice(e,1)}this.relationshipsMap.get(i[t]).father=e}this.relationshipsMap.get(e).children.push(i[t])}else this.relationshipsMap.get(e).children.push(i[t])}else{this.relationshipsMap.set(e,t);let i=t.children;for(let t=0;t<i.length;t++)if(this.relationshipsMap.has(i[t])&&this.relationshipsMap.get(i[t]).father!==e){if(this.relationshipsMap.get(i[t]).father){let e=this.relationshipsMap.get(this.relationshipsMap.get(i[t]).father).children.indexOf(i[t]);this.relationshipsMap.get(this.relationshipsMap.get(i[t]).father).children.splice(e,1)}this.relationshipsMap.get(i[t]).father=e}}}))}getAllChildrenId(t){if(!this.relationshipsMap)return[];let e=[];if(this.relationshipsMap.has(t)){let i=this.relationshipsMap.get(t).children;e=[...e,...i];for(let t=0;t<i.length;t++)this.relationshipsMap.get(i[t])&&this.relationshipsMap.get(i[t]).children.length>0&&(e=[...e,...this.getAllChildrenId(i[t])])}return e}clearAllHierarchy(){this.relationshipsMap.clear()}clearHierarchy(t,e){let i=this.relationshipsMap.get(t).children,n=new Set,o=new Set;e.forEach((t=>{-1===i.indexOf(t)?o.add(t):n.add(t)})),o.size>0&&this.console.warn(`The relationships associated with childrenIds "${[...o].join("、")}" were not cleared because the parent-child relationships were not established.`),[...n].forEach((e=>this.clearCurrentIdToAncestorRelationship(t,e)))}clearCurrentIdToAncestorRelationship(t,e){let i=this.relationshipsMap.get(e).father;if(i){let n=this.relationshipsMap.get(i).children.indexOf(e);this.relationshipsMap.get(i).children.splice(n,1),i!=t?this.clearCurrentIdToAncestorRelationship(t,i):0===this.relationshipsMap.get(i).children.length&&null===this.relationshipsMap.get(i).father&&this.relationshipsMap.delete(i)}this.relationshipsMap.get(e).father=null,0===this.relationshipsMap.get(e).children.length&&this.relationshipsMap.delete(e)}clearRelationshipById(t){if(!this.relationshipsMap)return;if(!this.relationshipsMap.has(t))return;let e=this.relationshipsMap.get(t).father;e&&this.clearHierarchy(e,[t]);let i=this.relationshipsMap.get(t).children;i&&i.length>0&&this.clearHierarchy(t,i)}}}(),Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.ExternalObject").ExternalObjectEditorToolbarConfig=function(){return{viewer:null,id:null,app:null,buttonVisibility:{},translationController:{},rotationController:{},scaleController:{}}};const ExternalObjectEditorToolbarEvent$1=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.ExternalObject").ExternalObjectEditorToolbarEvent={Exit:"Exit",EditingModeChanged:"EditingModeChanged"};!function(){let t=Glodon$1.Bimface.Data.StatisticsDataManager.getInstance(),e=(Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.Dom"),Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.ExternalObject"));e.ExternalObjectEditorToolbar=class extends ObjectEditorToolbar{constructor(e){t.send("Bimface.Plugins.ExternalObject","ExternalObjectEditorToolbar"),e.objectId=e.id,super(e),this.name="ExternalObjectEditorToolbar",this.initialize(),this.toolBarDom()}setButtonVisibility(t){super.setButtonVisibility(t)}getButtonVisibility(){return super.getButtonVisibility()}setEditedExternalObjectId(t){super.setEditedObjectId(t)}getEditedExternalObjectId(){return super.getEditedObjectId()}show(){super.show()}hide(){super.hide()}exit(){super.exit()}setRotationController(t){super.setRotationController(t)}getRotationController(){return super.getRotationController()}setTranslationController(t){super.setTranslationController(t)}getTranslationController(){return super.getTranslationController()}setScaleController(t){super.setScaleController(t)}getScaleController(){return super.getScaleController()}setEditingMode(t){super.setEditingMode(t)}getEditingMode(){return super.getEditingMode()}initialize(){super.initialize(),this.objectEditorManager=new ObjectEditorManager(this.viewer,"ExternalObject"),this.objectEditorManager.setEditedObjectId(this.objectId)}addEventListener(t,e){super.addEventListener(t,e)}removeEventListener(t,e){super.removeEventListener(t,e)}}}(),function(){let t=Glodon$1.Bimface.Data.StatisticsDataManager.getInstance(),e=(Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.Dom"),Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.SpatialRelation"));e.Room=class{constructor(e){t.send("Bimface.Plugins.SpatialRelation","Room"),this.viewer3D=e.viewer,this.databagId=e.viewer._data.databagId,this.toleranceType={STRICT:"STRICT",ORDINARY:"ORDINARY",LENIENT:"LENIENT"},this.tolerence=.25,this.mapRoomBbox={},this.mapRoomBoundary={},this.mapRoomId={},this.mapArea={},this.allComponentIds=null,!0!==e.hasInitialized&&this.initialize()}initialize(){let t=this;"singleMode"===this.viewer3D._data.modelType&&this.getRooms((function(e){let i=JSON.parse(e);for(const e of i)t.mapRoomId[e.id]=!0,t.mapRoomBbox[e.id]=(new THREE.Box3).setFromPoints([e.bboxMin,e.bboxMax])}))}getRooms(t){this.viewer3D.getDefaultModel()._getMetaDataManager().dataManager.getRooms((function(e){t&&t(e)}))}getRoomBoundary(t,e){this.mapRoomId[t]&&this.viewer3D.getDefaultModel()._getMetaDataManager().dataManager.getRoomBoundary(t,(function(t){e&&e(t)}))}getAreaByRoomId(t){let e=this,i=new Array;for(const n of t){let t={id:n,unit:"m2",value:null};if(e.mapArea[n])t.value=e.mapArea[n];else{let i=e._getRoomBoundaryById(n);i?t.value=Math.abs(THREE.ShapeUtils.area(i))/1e6:console.warn(`Input room id ${n} is invalid.`)}i.push(t)}return i}getBoundaryByRoomId(t){let e=new Array,i=this.viewer3D.getCustomizedRoom();if(t in i){let n=this._getRoomBoundaryById(t);for(let o=0,s=n.length;o<s;o++){let s=new Array;s.push(n[o].x),s.push(n[o].y),s.push(i[t].offset[0]),e.push(s)}}else console.warn(`Input room id ${t} is not exist.`);return e}getHeightByRoomId(t){let e,i=this.viewer3D.getCustomizedRoom();return t in i?e=i[t].height:console.warn(`Input room id ${t} is not exist.`),e}setBoundaryByRoomId(t,e){let i,n=this.viewer3D.getCustomizedRoom();if(t in n){let o=n[t];if(this.viewer3D.clearRoomsById(t),"string"==typeof e&&(e=JSON.parse(e)),e instanceof Array)if(2==e.length)i=this.viewer3D.createBoundary(e[0],e[1]);else{if(!(e.length>0))return;i=this.viewer3D.createBoundary(1==e.length&&e[0]||e)}else i=e;if(!i)return void console.warn("The custom room data is not standard");i.offsetZ-=o.offset[0],this.viewer3D.createRoomByOffset(i,o.offset,t,o.faceColor,o.frameColor),this.viewer3D.render();let s={id:t,unit:"m2",value:null},r=this._getRoomBoundaryById(t);s.value=Math.abs(THREE.ShapeUtils.area(r))/1e6}else console.warn(`Input room id ${t} is not exist.`)}enableDepthTest(t,e){const i=this.viewer3D.getViewer();CLOUD.ExtrudeBodyManager.getInstance(i).enableDepthTest(t,e)}getModelComponentIds(){if(this.allComponentIds&&"ViewerGIS"!==this.viewer3D.viewerType)return this.allComponentIds;let t=this.viewer3D.getViewer();return this.allComponentIds=t.getAllModelUserIds(),this.allComponentIds}getComponentsByRoomId(t,e,i,n){null==e&&(e=this.toleranceType.ORDINARY),null==i&&(i=this.toleranceType.STRICT);let o=this;this.getRoomBoundary(t,(function(e){let i=JSON.parse(e);i.hasOwnProperty("loops")&&(i=i.loops[0]);let n=[];for(const t of i)n.push({x:t[0].x,y:t[0].y});o.mapRoomBoundary[t]=n}));let s=[],r=this.getModelComponentIds();for(const n in r)for(const o of r[n]){let r=this.viewer3D.getViewer().getComponentInfoByUserId(o,n).boundingBox;this.roomContains(t,r,e,i)&&s.push(o)}n&&n(s)}getRoomsByComponentId(t,e,i,n){null==e&&(e=this.toleranceType.ORDINARY),null==i&&(i=this.toleranceType.STRICT);let o=[],s=this.viewer3D.getCustomizedRoom(),r=Object.keys(s);for(let n=0;n<r.length;n++){let s=r[n],a=this.viewer3D.getViewer().getComponentInfoByUserId(t).boundingBox;this.roomContains(s,a,e,i)&&o.push(s)}n&&n(o)}roomContains(t,e,i,n){if(!this.viewer3D.getCustomizedRoom()[t]&&!this.mapRoomBoundary[t])return void console.warn("Input room id is invalid.");let o=this.isRoomContainBoundingBoxByZ(t,e,n);if(0==o)return o;let s=this.isRoomBoundingBoxContainBoundingBoxByXY(t,e,i);if(0==s)return s;let r=this.isRoomBoundaryContainBoundingBoxByXY(t,e,i);return 0!=r||r}getRoomBoundingBoxById(t){let e=this.getCustomizedRoom(t);if(e){let t=e.boundingBox,i=e.offset;return t.min.z=i[0],t.max.z=i[1],t}if(this.mapRoomBbox[t])return this.mapRoomBbox[t]}getCustomizedRoom(t){let e=this.viewer3D.getCustomizedRoom()[t];if(!e)return null;if(e.boundary&&"user"!=e.boundary.belong){let t=[],i=[],n=e.boundary;for(let e=0;e<n.loops.length;e++){let o=n.loops[e],s=[];for(const t of o)s.push([t[0].x,t[0].y,t[0].z]);0==e?t=s:s.length>2&&i.push(s)}let o=this.viewer3D.createBoundary(t,i);return o.offset=[...e.offset],o}return e.boundary.offset=e.offset,e.boundary}_getRoomBoundaryById(t){return this.viewer3D.getCustomizedRoom()[t]?this.getCustomizedRoom(t).roomBoundary:this.mapRoomBoundary[t]}isRoomContainBoundingBoxByZ(t,e,i){let n=this.getRoomBoundingBoxById(t),o=n.min.z,s=n.max.z,r=e.max.z,a=e.min.z,l=this.tolerence;if(i==this.toleranceType.STRICT)return a>=o-l&&r<=s+l;if(i==this.toleranceType.ORDINARY){let t=(a+r)/2;return this.isBetween(t,o,s)&&(this.isBetween(a,o,s)||this.isBetween(r,o,s))}return i==this.toleranceType.LENIENT?a<=s+l&&r>=o-l:void 0}setTopHeightByRoomId(t,e){let i=this.getCustomizedRoom(t);if(i){let n=this.viewer3D.getCustomizedRoom()[t];this.viewer3D.clearRoomsById([t]);let o=[];for(let t=0;t<i.roomBoundary.length-1;t++){let e=i.roomBoundary[t];o.push([e.x,e.y,0])}let s=this.viewer3D.createBoundary(o),r=[i.offset[0],e];this.viewer3D.createRoomByOffset(s,r,t,n.faceColor,n.frameColor)}else console.log("No room exists whose id is "+t)}setBottomHeightByRoomId(t,e){let i=this.getCustomizedRoom(t);if(i){let n=this.viewer3D.getCustomizedRoom()[t];this.viewer3D.clearRoomsById([t]);let o=[];for(let t=0;t<i.roomBoundary.length-1;t++){let e=i.roomBoundary[t];o.push([e.x,e.y,0])}let s=this.viewer3D.createBoundary(o),r=[e,i.offset[1]];this.viewer3D.createRoomByOffset(s,r,t,n.faceColor,n.frameColor)}else console.log("No room exists whose id is "+t)}isRoomBoundingBoxContainBoundingBoxByXY(t,e,i){let n=this.getRoomBoundingBoxById(t),o=n.min.x,s=n.max.x,r=n.min.y,a=n.max.y,l=e.min.x,h=e.max.x,c=e.min.y,d=e.max.y,u=this.tolerence;return i==this.toleranceType.STRICT?l>=o-u&&h<=s+u&&c>=r-u&&d<=a+u:i==this.toleranceType.ORDINARY||i==this.toleranceType.LENIENT?l<=s+u&&h>=o-u&&c<=a+u&&d>=r-u:void 0}isRoomBoundaryContainBoundingBoxByXY(t,e,i){let n=this.toFivePos(e),o=this._getRoomBoundaryById(t),s=0;for(let t=0;t<n.length;t++){const e=n[t];this.containsInBoundary(e,o)&&s++}let r=!1;return i==this.toleranceType.STRICT?r=5==s:i==this.toleranceType.ORDINARY?r=s>=3:i==this.toleranceType.LENIENT&&(r=s>=1),r}isBetween(t,e,i){let n=this.tolerence;return t<=i+n&&t>=e-n}toFivePos(t){let e=[];return e.push(new THREE.Vector2(t.min.x,t.min.y)),e.push(new THREE.Vector2(t.max.x,t.min.y)),e.push(new THREE.Vector2(t.max.x,t.max.y)),e.push(new THREE.Vector2(t.min.x,t.max.y)),e.push(new THREE.Vector2((t.min.x+t.max.x)/2,(t.min.y+t.max.y)/2)),e}containsInBoundary(t,e,i){let n=!1;for(let i=0;i<e.length-1;i++)if(this.isOnSegment(t,e[i],e[i+1])){n=!0;break}if(n)return!i;for(var o=t.x,s=t.y,r=!1,a=0,l=e.length-1;a<e.length;l=a++){var h=e[a].x||e[a][0],c=e[a].y||e[a][1],d=e[l].x||e[l][0],u=e[l].y||e[l][1];c>s!=u>s&&o<(d-h)*(s-c)/(u-c)+h&&(r=!r)}return r}isOnSegment(t,e,i){if(t.x>Math.max(e.x,i.x)||t.x<Math.min(e.x,i.x))return!1;if(t.y>Math.max(e.y,i.y)||t.y<Math.min(e.y,i.y))return!1;if(e.x!=i.x){let n=(i.y-e.y)/(i.x-e.x),o=i.y-n*i.x;if(n*t.x+o==t.y)return!0}else if(t.x==e.x)return!0;return!1}isPointInside(t,e,i){!1!==i&&(i=!0);let{roomBoundary:n,roomInnerBoundary:o}=this.getCustomizedRoom(e);if(!this.containsInBoundary(t,n,i))return!1;if(o&&o.find((e=>this.containsInBoundary(t,e,i))))return!1;let s=Number(t.z.toFixed(10)),r=this.getRoomBoundingBoxById(e),a=Number(r.min.z.toFixed(10)),l=Number(r.max.z.toFixed(10));return i?s>a&&s<l:s>=a&&s<=l}}}(),Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.SpatialRelation").RoomConfig=function(){return{viewer:null}},function(){var t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.SpatialRelation");let e=Object.freeze({Saved:"Saved",Cancelled:"Cancelled"});t.RoomEditorToolbarEvent=e}(),function(){let t=Glodon$1.Bimface.Data.StatisticsDataManager.getInstance(),e=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.Dom"),i=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.SpatialRelation"),n=(Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Application.UI.Button"),Glodon$1.Bimface.Plugins.SpatialRelation.RoomEditorToolbarEvent);i.RoomEditorToolbar=class{constructor(e){t.send("Bimface.Plugins.SpatialRelation","RoomEditorToolbar"),this.id="RoomEditorToolbar",this.viewer=e.viewer,this.roomId=e.roomId,this.databagId=e.viewer._data.databagId,this.eventManager=new Glodon$1.Web.Lang.EventManager,this.initialize(),this.toolBarDom()}initialize(){const t=Glodon$1.Bimface.Plugins.RoomEditing,e=new t.RoomEidtorConfig;e.viewer=this.viewer,e.roomId=this.roomId,this.roomEditor=new t.RoomEditor(e),this.roomEditor.onEnter(),this.registerRoomEditorEvents()}toolBarDom(){const t=this;let i=[];const o=e.create("div","bf-roomEditorToolbar");if(t.domElement=o,void 0===this.switchToolbar){var s=Glodon$1.Bimface.UI.Toolbar.ToolbarConfig();s.className="bf-toolbar bf-toolbar-roomEditor",s.element=o,s.buttons=["RoomEditingDrag","RoomEditingAdd","RoomEditingDelete","RoomEditingHeight"],this.viewer.getDomElement().appendChild(o),this.switchToolbar=new Glodon$1.Bimface.Application.UI.Toolbar.Toolbar(s),i.push(this.switchToolbar)}let r=Glodon$1.Bimface.UI.Control.ControlEvent,a=this.switchToolbar.getControls();this.uncheckOthers("Drag",a);let l=["Pick","Add","Delete","Height"];for(let e=0;e<a.length;e++){let i=a[e];i.addEventListener(r.Click,(function(){i.isChecked()?(t.roomEditor.activateEditor(l[e]),t.uncheckOthers(i.getId(),a)):i.toggleCheckedState()}))}const h=new Glodon$1.Bimface.UI.Toolbar.ToolbarConfig;h.element=o,h.className="bf-toolbar bf-toolbar-roomEditor";let c=t.roomToolbar=new Glodon$1.Bimface.UI.Toolbar.Toolbar(h);t.roomToolbar=c,i.push(c);const d=new Glodon$1.Bimface.UI.Button.ButtonConfig;d.className="bf-save",d.title=BimfaceLanguage.bf_general_save;const u=new Glodon$1.Bimface.UI.Button.SingleButton(d);u.setHtml(BimfaceLanguage.bf_general_save),u.addEventListener("Click",(function(){const e=t.roomEditor.save(),i={roomId:t.roomId,boundary:e.outerBoundary,height:e.height};t.eventManager.fireEvent(n.Saved,i),t.update()})),c.addControl(u);const p=new Glodon$1.Bimface.UI.Button.ButtonConfig;p.className="bf-cancel",p.title=BimfaceLanguage.bf_general_cancel;const g=new Glodon$1.Bimface.UI.Button.SingleButton(p);g.setHtml(BimfaceLanguage.bf_general_cancel),g.addEventListener("Click",(function(){t.eventManager.fireEvent(n.Cancelled),t.exit()})),c.addControl(g),this.viewer.getDomElement().appendChild(o)}registerRoomEditorEvents(){let t=this;this.viewer.addEventListener("DeletionError",(function(){if(!t.deletionErrorTips){const e=new Glodon$1.Bimface.UI.Tips.TipsConfig;e.element=t.viewer.getDomElement(),e.className="bf-tips bf-roomEditor-tips",e.timeOut=3e3,e.html=`<div><i class="icon-warning"></i>${BimfaceLanguage.bf_panel_roomEdit_insufficientNode}</div>`,t.deletionErrorTips=new Glodon$1.Bimface.UI.Tips.Tips(e)}t.deletionErrorTips.show()}));let e=this.viewer.getDomElement();this.viewer.addEventListener("RoomEditorAddEnter",(function(){e.addClass("roomEditor-addtion")})),this.viewer.addEventListener("RoomEditorAddExit",(function(){e.removeClass("roomEditor-addtion")})),this.viewer.addEventListener("RoomEditorDeleteEnter",(function(){e.addClass("roomEditor-deletion")})),this.viewer.addEventListener("RoomEditorDeleteExit",(function(){e.removeClass("roomEditor-deletion")}))}uncheckOthers(t,e){for(const i of e)i.getId()===t?i.setCheckedState(!0):i.setCheckedState(!1)}getEventManager(){return this.eventManager}addEventListener(t,e){this.getEventManager().addEvent(t,e)}removeEventListener(t,e){this.getEventManager().removeEvent(t,e)}show(){this.roomEditor.setBimfaceUIVisibility(!1),this.roomToolbar.show(),this.switchToolbar.show()}hide(){this.roomEditor.setBimfaceUIVisibility(!0),this.roomToolbar.hide(),this.switchToolbar.hide()}update(){if(!0!==this.roomEditor.checkIntersect())this.hide(),this.roomEditor.onExit();else{if(!this.intersectTips){const t=new Glodon$1.Bimface.UI.Tips.TipsConfig;t.element=this.viewer.getDomElement(),t.className="bf-tips bf-roomEditor-tips",t.timeOut=3e3,t.html=`<div><i class="icon-warning"></i>${BimfaceLanguage.bf_panel_roomEdit_selfIntersection}</div>`,this.intersectTips=new Glodon$1.Bimface.UI.Tips.Tips(t)}this.intersectTips.show()}}exit(){this.hide(),this.roomEditor.onExit(!0)}}}(),Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.SpatialRelation").RoomEditorToolbarConfig=function(){return{viewer:null,roomId:null,app:null}},function(){let t=Glodon$1.Bimface.Data.StatisticsDataManager.getInstance(),e=(Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.Dom"),Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.RevitHelpers"));e.MEPTopologyHelper=class{constructor(e){t.send("Bimface.Plugins.RevitHelpers","MEPTopologyHelper"),this.databagId=e.viewer._data.databagId,this.modelType=e.viewer._data.modelType}_findNetworkById(t,e){var i,n=this;n._FILEID_CACHE!=n.fileId&&(n._API_CACHE=null),"integrateModel"==n.modelType?(i=`${hostConfig.resourceHost}/${n.databagId}/metadata/${n.fileId}/mepsystem.json`,n._FILEID_CACHE=n.fileId):i=`${hostConfig.resourceHost}/${n.databagId}/metadata/mepsystem.json`,n._API_CACHE?n._getNetwork(t,n._API_CACHE,(function(t){e(t)})):Glodon$1.Web.Lang.Utility.HttpRequest.ajax({url:i,success:function(i){var o=JSON.parse(i);n._API_CACHE=o,n._getNetwork(t,o,(function(t){e(t)}))}})}_getNetwork(t,e,i){var n=this;n._NETWORK_LENGTH=0,e.systems.map((function(o,s){o.network[t]&&(n._NETWORK_LENGTH++,i(o.network)),s==e.systems.length-1&&0==n._NETWORK_LENGTH&&console.log("此ID不存在于Network中")}))}_transform(t){let e=[];for(let i in t)/^__STEP/.test(i)||(e[e.length]={type:i,id:t[i]});return e}_walk(t,e,i,n){let o="up"===i?"flowFrom":"flowInto",s=[e];for(;s.length;){let e=s.pop(),i=t[e];if(!i)continue;i.id=e,n(i,t);let r=i[o];r&&[].push.apply(s,[...r].reverse())}}_BFSwalk(t,e,i,n){let o="up"===i?"flowFrom":"flowInto",s=[e];for(;0!==s.length;){let e=s.shift(),i=t[e];i&&(i.id=e,n(i,i[o],t),[].push.apply(s,i[o]))}}_deduplicate(t){return t.map((function(t){return t.reduce((function(t,e,i){return i%2==0?-1===t.indexOf(e)&&t.push(e):/\d+/.test(t[t.length-1])||t.push(e),t}),[])}))}_formatToObj(t){var e,i=this,n={};return t.forEach((function(t){t.forEach((function(t,o){if(o%2==0)e=t,n[t]||(n[t]=[]);else{let o;o="integrateModel"==i.modelType?`${i.fileId}.${t}`:t,-1===n[e].indexOf(o)&&n[e].push(o)}}))})),n}_formatNewData(t,e){let i;for(let e in t){if(-1!=Object.keys(t[e]).indexOf("flowFrom")){i=t;break}{let n=[],o=[];t[e].neighbours.map((t=>{"bidirectional"!==t.direction&&("in"===t.direction?n.push(t.id):o.push(t.id))})),Object.assign(t[e],{flowFrom:n},{flowInto:o}),i=t}}return i}getDownstreamComponentsById(t,e){const i=this;"integrateModel"==i.modelType&&(i.fileId=t.split(".")[0],t=t.split(".")[1]),i._findNetworkById(t,(n=>{if(!n)return e();let o=i._formatNewData(n),s={};i._BFSwalk(o,t,"down",(function(e){e.id!==t&&("integrateModel"==i.modelType&&(e.id=`${i.fileId}.${e.id}`),s[e.type]?s[e.type].push(e.id):s[e.type]=[e.id])})),e(i._transform(s))}))}getConnectedComponentsById(t,e){var i=this;"integrateModel"==i.modelType&&(i.fileId=t.split(".")[0],t=t.split(".")[1]),i._findNetworkById(t,(n=>{if(!n)return e();let o=i._formatNewData(n),s={up:{routes:[[]]},down:{routes:[[]]}};["up","down"].forEach((e=>this._walk(o,t,e,(function(i,n){let o=s[e].routes,r=o.length-1;if("末端"===o[r].slice(-2,-1)[0]){if("末端"===i.type)return o[o.length]=o[r].slice(0,-1).concat(i.id);{let t=i["up"===e?"flowInto":"flowFrom"][0];o[o.length]=o[r].slice(0,o[r].indexOf(t)+1),r++}}t!=i.id&&(o[r].push(i.type),o[r].push(i.id))}))));let r=i._deduplicate(s.up.routes),a=i._deduplicate(s.down.routes),l=this._transform(i._formatToObj(r)),h=this._transform(i._formatToObj(a));e({up:l,down:h})}))}}}(),Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.RevitHelpers").MEPTopologyHelperConfig=function(){return{viewer:null}},function(){let t=Glodon$1.Bimface.Data.StatisticsDataManager.getInstance(),e=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.RevitHelpers");class i{constructor(e,i){t.send("Bimface.Plugins.RevitHelpers","DrawingView"),this.viewer3D=e,this.drawingViews=i,this.activeViewId=null,this.activeDrawingView=null,this.viewPoint=null,this.planTranslation=null,this.linkFileTranslation=new THREE.Vector3}activeViewById(t){this.activeViewId=t;for(const t of this.drawingViews)if(t.id==this.activeViewId){this.activeDrawingView=t;let e=t.viewPoint.origin;this.coordViewPoint=new THREE.Vector3(e[0],e[1],e[2])}}formatViewMatrix(t){let e=this.activeDrawingView.viewPoint.rightDirection,i=this.activeDrawingView.viewPoint.upDirection,n=new THREE.Vector3(e[0],e[1],e[2]),o=new THREE.Vector3(i[0],i[1],i[2]);t=null==t?new THREE.Vector3:t;let s=new THREE.Matrix4;return s.makeBasis(n,o,t),s}update(t,e){this.makeTranslation(t,e),"FloorPlan"==this.activeDrawingView.viewType?this.rotateFloorPlan(t):this.rotateElevation(t)}makeTranslation(t,e){let i=this.activeDrawingView.viewPoint.viewDirection,n=new THREE.Vector3(i[0],i[1],i[2]).multiplyScalar(e),o=this.planTranslation,s=this.linkFileTranslation;t.translateX(o.x+s.x+n.x),t.translateY(o.y+s.y+n.y),t.translateZ(o.z+s.z+n.z)}rotateFloorPlan(t){let e=this.activeDrawingView.viewPoint.upDirection,i=new THREE.Vector3(e[0],e[1],e[2]),n=new THREE.Vector3(0,1,0).angleTo(i);new THREE.Vector3(0,1,0).cross(i).length()>0&&(n=-n),t.rotateZ(n),t.updateMatrixWorld()}rotateElevation(t){let e=this.activeDrawingView.viewPoint.viewDirection,i=new THREE.Vector3(e[0],e[1],e[2]),n=i.angleTo(new THREE.Vector3(0,-1,0));i.cross(new THREE.Vector3(0,-1,0)).z>0&&(n=-n),t.rotateX(Math.PI/2),t.rotateY(n),t.updateMatrixWorld()}getOutline3D(){let t=this.activeDrawingView.outline,e=this.activeDrawingView.viewPoint.scale,i=this.activeDrawingView.elevation,n=new THREE.Vector3(t[0]*e,t[1]*e,0),o=new THREE.Vector3(t[0]*e,t[3]*e,0),s=new THREE.Vector3(t[2]*e,t[3]*e,0),r=new THREE.Vector3(t[2]*e,t[1]*e,0),a=this.formatViewMatrix(),l=n.applyMatrix4(a),h=o.applyMatrix4(a),c=s.applyMatrix4(a),d=r.applyMatrix4(a);this.planTranslation=l.clone().add(c).multiplyScalar(.5),this.planTranslation.add(this.coordViewPoint);let u=h.clone().sub(l).length(),p=d.clone().sub(l).length(),g=new THREE.Vector3(-p/2,-u/2,i),m=new THREE.Vector3(p/2,u/2,i);return new THREE.Box3(g,m)}setLinkFileTranslation(t){this.linkFileTranslation.x=t.elements[12],this.linkFileTranslation.y=t.elements[13],this.linkFileTranslation.z=t.elements[14]}}i.toObject=function(t){var e={};for(var i in t)if(t.hasOwnProperty(i)){var n=t[i];n instanceof Array&&(e[i]={x:n[0],y:n[1],z:n[2]})}return e},e.DrawingView=i}(),Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Snap").SnapConfig=function(){return{id:null,color:new Glodon$1.Web.Graphics.Color(249,157,11,1),hoverColor:new Glodon$1.Web.Graphics.Color(17,218,183,.2),objectColor:new Glodon$1.Web.Graphics.Color(17,218,183,.9),width:3,radius:25,viewer:null}},function(){let t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Snap"),e=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.Dom"),i=function(t){this.viewer=t.viewer,this.maxPointsNum=1;var i=new Glodon$1.Web.Graphics.Color(17,218,183,.2),n=e.createNS("circle","bf-snap-handle");n.setAttribute("r",t.width),n.setAttribute("fill",i.getRGB()),n.style.fill=i.getRGB();var o=e.createNS("line","bf-snap-line");o.style.strokeWidth=2,o.style.stroke=i.getRGB();var s=e.createNS("polygon","bf-snap-rect");s.setAttribute("fill",i.getRGBA()),s.setAttribute("stroke",i.getRGB()),s.setAttribute("stroke-width",1),this.hoverLine=o,this.hoverPoint=n,this.hoverPanel=s,this.hoverPanelSize={width:20,height:20}};i.prototype=Object.assign(i.prototype,{stretchOnDirection:function(t,e,i){var n=t.clone().add(e).multiplyScalar(.5),o=e.clone().sub(t).normalize();return[n.clone().sub(o.clone().multiplyScalar(i/2)),n.clone().add(o.clone().multiplyScalar(i/2))]},draw:function(t){var e=this.hoverLine,i=this.hoverPoint,n=this.hoverPanel,o=this.hoverPanelSize;switch(t.hoverObjectType){case"Point":i.setAttribute("cx",t.hoverPosition.x),i.setAttribute("cy",t.hoverPosition.y),t.svg.appendChild(i);break;case"Line":e.setAttribute("x1",t.lineStartPoint.x),e.setAttribute("y1",t.lineStartPoint.y),e.setAttribute("x2",t.lineEndPoint.x),e.setAttribute("y2",t.lineEndPoint.y),t.svg.appendChild(e);break;case"Panel":var s=t.clientPts,r=s[0].distanceTo(s[1]),a=s[0].distanceTo(s[3]),l=r/o.width,h=a/o.height;if(1!=l){var c=this.stretchOnDirection(s[0],s[1],o.width),d=this.stretchOnDirection(s[2],s[3],o.width);s=c.concat(d)}if(1!=h){c=this.stretchOnDirection(s[0],s[3],o.height),d=this.stretchOnDirection(s[1],s[2],o.height);s=[c[0],d[0],d[1],c[1]]}for(var u="",p=0;p<s.length;p++)u+=s[p].x+",",u+=s[p].y+" ";n.setAttribute("points",u),t.svg.appendChild(n)}}}),t.SnapItem=i}(),function(){var t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Snap"),e=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.Dom"),i=null,n=[],o=null,s=null,r=function(t){var i=t.viewer,n=this;this.snapMode=t.snapMode,n.isOpen=!1,this._p1=new THREE.Vector3,this._p2=new THREE.Vector3;var o=new Glodon$1.Web.Lang.EventManager,s=e.create("div","bf-snap-conext");this.context={rootDomElement:s},this._opt=t,this.getEventManager=function(){return o},n.init(t),i.addEventListener("Rendered",(function(){n.isOpen&&n.update()}))};r.prototype={init:function(t){var i=this,n=i.context,o=i._opt.viewer;i.isOpen=!0,o.getDomElement().appendChild(n.rootDomElement),o.getModels().forEach((t=>{t.setSelectedComponentsById()}));var s=e.createNS("svg","bf-snap-svg");n.rootDomElement.innerHTML="",n.rootDomElement.appendChild(s),n.svg=s;var r=new Glodon$1.Bimface.Plugins.Snap.SnapItem(t);i.snapItem=r,o.render()},snapByPoint:function(t){this.isNeedSnap(t)&&(i=t.pickPoint?t.pickPoint:null,t.pickPlane?(o="Panel",s=t.normal):t.pickLine?(o="Line",n=t.pickLine):o=t.pickPoint?"Point":null,this.update())},isNeedSnap:function(t){if(!this.snapMode)return!0;if(!t||!t.userId)return this.reset(),!1;let e=this.snapMode.getSnap3DList(),i="face",n="line",o="endpoint",s=!1;t.pickPlane?s=e.includes(i):t.pickLine?s=e.includes(n):t.pickPoint&&(s=e.includes(o));let r=this.snapMode.getSnapCondition(),a=this._opt.viewer.getViewer().getUserdataByUserId(t.userId),l=this.isMatchConditions(a,r.objectData),h=!0,c=!0;if("ViewerGIS"==this._opt.viewer.getViewerType())if(t.modelId){let e=this._opt.viewer.getModel(t.modelId)._layer.id;r.layerIds&&r.layerIds.length>0&&r.layerIds.indexOf(e)<0&&(h=!1)}else h=!1;"Viewer3D"==this._opt.viewer.getViewerType()&&r.modelIds&&r.modelIds.length>0&&r.modelIds.indexOf(t.modelId)<0&&(c=!1);let d=s&&l&&h&&c;return d||this.reset(),d},isMatchConditions:function(t,e){if(!t||!e)return!0;for(var i=!0,n=0,o=e.length;n<o;n++){var s=e[n];for(var r in s)if(t[r]!==s[r]){i=!1;break}if(i)break;n<e.length-1&&(i=!0)}return i},update:function(){var t=this.context,e=this._opt.viewer,r=e.getDomElement(),a=r.getBoundingClientRect(),l=e.getViewer(),h=[],c=[];if(this.context.svg.innerHTML="",i?(t.pickPoint=i,t.hoverPosition=e.worldToClient(i),t.hoverPositionDS=l.getScene().worldToDrawing(i)):t.hoverPosition=null,t.hoverObjectType=o,"Line"==o&&2==n.length){t.lineStartPoint=e.worldToClient(n[0]),t.lineEndPoint=e.worldToClient(n[1]);var d=new THREE.Vector2(t.lineStartPoint.x,t.lineStartPoint.y),u=new THREE.Vector2(t.lineEndPoint.x,t.lineEndPoint.y),p=new THREE.Box2;p.min.set(r.clientLeft,r.clientTop),p.max.set(p.min.x+r.clientWidth,p.min.y+r.clientHeight);var g=!p.containsPoint(d),m=!p.containsPoint(u),f={start:d,end:u},w=CLOUD$1.CameraUtil.lineIntersectWithRect(f,p);if(g&&m)2==w.length&&(t.lineStartPoint=w[0],t.lineEndPoint=w[1]);else if(g||m)for(var v=new THREE.Vector2(t.hoverPosition.x,t.hoverPosition.y),y=g?u.clone():d.clone(),b=y.clone().sub(v).normalize(),E=0;E<w.length;E++){if(y.clone().sub(w[E]).normalize().dot(b)>0){t.lineStartPoint=y,t.lineEndPoint=w[E];break}}}if("Panel"==t.hoverObjectType){t.normal=l.getScene().worldToDrawing(s),t.normal.normalize();var C=l.cameraControl,x=new THREE.Plane;x.setFromNormalAndCoplanarPoint(t.normal,t.hoverPositionDS);var M=new THREE.Vector2(t.hoverPosition.x-10,t.hoverPosition.y-10),P=new THREE.Vector2(t.hoverPosition.x+10,t.hoverPosition.y-10),I=t.hoverPositionDS,T=C.getRaycaster(M.x,M.y);if(this._p1=T.ray.intersectPlane(x,this._p1),T=C.getRaycaster(P.x,P.y),this._p2=T.ray.intersectPlane(x,this._p2),null==this._p1||null==this._p2)return this._p1=new THREE.Vector3,void(this._p2=new THREE.Vector3);var D=new THREE.Vector3(1,0,0),S=new THREE.Vector3(0,1,0),B=new THREE.Vector3(0,0,1),A=Math.abs(t.normal.clone().dot(D))<=.0025,_=Math.abs(t.normal.clone().dot(B))<=.0025;if(A&&_)var k=D.clone(),L=B.clone();else k=S.clone().cross(t.normal).normalize(),L=t.normal.clone().cross(k).normalize();var R=this._p1.distanceTo(this._p2)/2,G=k.clone().multiplyScalar(R),N=L.clone().multiplyScalar(R),V=I.clone().sub(G).add(N),$=I.clone().add(G).add(N),O=I.clone().sub(G).sub(N),U=I.clone().add(G).sub(N),H=[];H.push(V,$,U,O);for(var z=[],F=C.getContainerDimensions(),W=0;W<H.length;W++){var j=CLOUD$1.CameraUtil.drawingToCanvas(C.camera,H[W],F.width,F.height);z.push(new THREE.Vector3(j.x,j.y,0))}t.clientPts=z}for(E=0;E<h.length-1;E++){var Z=l.worldPointsToClient(h[E],h[E+1]);if(Z){var X={x:Z.start.x-a.left,y:Z.start.y-a.top};c.push(X)}}t.clientPoints=c,this.snapItem.draw(t)},reset:function(){o=null,this.context.svg.innerHTML=""},destroy:function(){var t=this.context.rootDomElement,e=this;e.reset(),t.remove(),e.snapItem=null,e.isOpen=!1}},t.Snap=r}(),Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Walkthrough").WalkthroughManagerConfig=function(){return{viewer:null}},function(){Glodon$1.Bimface.Data.StatisticsDataManager.getInstance();var t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Walkthrough");t.WalkthroughManager=class{constructor(t){var e=t.viewer;e?"Viewer3D"===e.getViewerType()||"ViewerGIS"===e.getViewerType()?(this._viewer=e,this._walkthroughMap={}):console.log("ViewerType is not supported."):console.log("viewer must not be empty.")}addWalkthrough(t,e){var i=Glodon$1.Web.Lang.Utility.UUID.createUUID(),n={id:i,walkthrough:e};return e._walkthrough.setName(t),this._walkthroughMap[i]=n,i}removeWalkthrough(t){"[object String]"===Object.prototype.toString.call(t)&&(t=[t]),"[object Array]"===Object.prototype.toString.call(t)&&t.forEach((t=>{delete this._walkthroughMap[t]}))}setWalkthroughList(t){if("[object Object]"===Object.prototype.toString.call(t)){var e=t.coordinate;t.data.forEach((t=>{var i=new Glodon$1.Bimface.Plugins.Walkthrough.WalkthroughConfig;i.viewer=this._viewer;var n=new Glodon$1.Bimface.Plugins.Walkthrough.Walkthrough(i),o=t.coordinateSystem||e;"world"===o&&t.keyFrames.forEach((t=>{t.coordinateSystem=o})),n.setKeyFrames(t.keyFrames),n.setWalkthroughTime(t.time),n._walkthrough.setName(t.name),this._walkthroughMap[t.id]={id:t.id,walkthrough:n}}))}}getWalkthroughList(){var t={data:[],version:1};for(var e in this._walkthroughMap){var i={id:e},n=this._walkthroughMap[e].walkthrough;i.keyFrames=n.getKeyFrames(),i.keyFrames.forEach((t=>{delete t.coordinateSystem})),i.name=n._walkthrough.getName(),i.time=n._walkthrough.walkthroughTime,i.coordinateSystem="world",t.data.push(i)}return t}}}(),Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins").NorthArrowConfig=function(){return{domElement:null,viewer:null,right:10,top:10}};class NorthArrowYaw{constructor(t,e,i){this.element=t,this.northArrowElement=e,this.textElement=t.lastElementChild,this._camera=i,this._rotate=0,this._minRadius=4,this._maxRadius=48,this.init()}init(){let t,e,i,n,o;this.isDragging=!1,this.events={mouseout:()=>{this.isDragging||this.element.firstElementChild.setAttribute("filter","")},mousedown:i=>{this.isDragging=!0,t=i.offsetX-50,e=i.offsetY-60,o=this._camera.getYawPitch().pitch,this.element.setAttribute("class","bf-northarrow-yawactive")},mouseover:function(){this.firstElementChild.setAttribute("filter","url(#bf-northarrow-dropshadow)")}};for(let t in this.events)this.element.addEventListener(t,this.events[t].bind(this.element));const s=()=>{this.isDragging=!1,this.element.firstElementChild.setAttribute("filter",""),this.element.setAttribute("class","bf-northarrow-yaw")},r=(i,n)=>{let s=i-t,r=n-e,a=Math.atan(n/i),l=Math.atan(e/t),h=180*Math.abs(a-l)/Math.PI;i>0&&i>Math.abs(n)&&t>0&&t>Math.abs(e)?r>0?this._rotate+=h:this._rotate-=h:i<0&&i<-Math.abs(n)&&t<0&&t<-Math.abs(e)?r>0?this._rotate-=h:this._rotate+=h:(a=Math.atan(i/n),l=Math.atan(t/e),h=180*Math.abs(a-l)/Math.PI,n>0&&e>0?s>0?this._rotate-=h:this._rotate+=h:s>0?this._rotate+=h:this._rotate-=h),this.element.setAttribute("transform",`rotate(${this._rotate}, 0, 0)`);let c=this._rotate*Math.PI/180;this._camera.setCameraFromYawPitch({yaw:c,pitch:o,target:!0},!0),t=i,e=n};this.northArrowEvents={mousemove:t=>{this.isDragging&&(i=t.offsetX-50,n=t.offsetY-60,r(i,n))},mouseup:t=>{this.isDragging&&s()}};for(let t in this.northArrowEvents)this.northArrowElement.addEventListener(t,this.northArrowEvents[t]);this.northArrowParentEvents={mousemove:t=>{this.isDragging&&(i=t.offsetX-50-this.northArrowElement.offsetLeft,n=t.offsetY-60-this.northArrowElement.offsetTop,r(i,n))},mouseup:t=>{this.isDragging&&s()}};for(let t in this.northArrowParentEvents)this.northArrowElement.parentElement.addEventListener(t,this.northArrowParentEvents[t]);this.textEvents={dblclick:t=>{o=this._camera.getYawPitch().pitch,this._camera.setCameraFromYawPitch({yaw:0,pitch:o,target:!0},!1)}};for(let t in this.textEvents)this.textElement.addEventListener(t,this.textEvents[t])}update(){if(this.isDragging)return;let{yaw:t}=this._camera.getYawPitch();this._rotate=180*t/Math.PI,this.element.setAttribute("transform",`rotate(${this._rotate}, 0, 0)`)}destroy(){if(this.events)for(let t in this.events)this.element.removeEventListener(t,this.events[t]);if(this.northArrowEvents)for(let t in this.northArrowEvents)this.northArrowElement.removeEventListener(t,this.northArrowEvents[t]);if(this.northArrowParentEvents)for(let t in this.northArrowParentEvents)this.northArrowElement.parentElement.removeEventListener(t,this.northArrowParentEvents[t]);if(this.textEvents)for(let t in this.textEvents)this.textElement.removeEventListener(t,this.textEvents[t])}}class NorthArrowPitch{constructor(t,e){this.elements=t,this._camera=e,this.minPitch=-Math.PI/2,this.maxPitch=Math.PI/2,this.init()}init(){const t=this._camera;let e,i,n=this,o=!1,s=!1;this.events={mousedown:function(){o=!0;let r=t.getYawPitch();i=r.yaw,e=r.pitch;let a=Math.PI/1e3;const l=()=>{if(e=-e,e>n.maxPitch&&(e=n.maxPitch),e<n.minPitch&&(e=n.minPitch),e>n.minPitch&&e-a>n.minPitch&&"bf-northarrow-pitchdown"===this.className.baseVal)e-=a,s=!0;else{if(!(e<n.maxPitch&&e+a<n.maxPitch&&"bf-northarrow-pitchup"===this.className.baseVal))return;e+=a,s=!1}e=-e,t.setCameraFromYawPitch({yaw:i,pitch:e,target:!0,isDownDirection:s},!0),o&&requestAnimationFrame(l)};l()},mouseup:()=>{o=!1},mouseover:function(){this.firstElementChild.setAttribute("filter","url(#bf-northarrow-dropshadow)")},mouseout:function(){this.firstElementChild.setAttribute("filter",""),o=!1}};for(let t in this.events)for(let e in this.elements)this.elements[e].addEventListener(t,this.events[t].bind(this.elements[e]))}destroy(){for(let t in this.events)for(let e in this.elements)this.elements[e].removeEventListener(t,this.events[t])}}class NorthArrowPan{constructor(t,e){this.elements=t,this._camera=e,this.init()}init(){const t=this._camera;let e=!1;this.events={mousedown:function(){e=!0;const i=()=>{switch(/bf-northarrow-pan(.*)/.exec(this.className.baseVal)[1]){case"up":t.panInDirection(!0);break;case"down":t.panInDirection(!1);break;case"left":t.panInHorizontal(!0);break;case"right":t.panInHorizontal(!1)}e&&requestAnimationFrame(i)};i()},mouseup:()=>{e=!1},mouseover:function(){this.setAttribute("filter","url(#bf-northarrow-dropshadow)")},mouseout:function(){this.setAttribute("filter",""),e=!1}};for(let t in this.events)for(let e in this.elements)this.elements[e].addEventListener(t,this.events[t].bind(this.elements[e]))}destroy(){for(let t in this.events)for(let e in this.elements)this.elements[e].removeEventListener(t,this.events[t])}}class NorthArrowZoom{constructor(t,e){this.elements=t,this._camera=e,this.init()}init(){const t=this._camera;let e=!1;this.events={mousedown:function(){e=!0;const i=()=>{"bf-northarrow-zoomin"===this.className.baseVal?t.zoomIn():t.zoomOut(),e&&requestAnimationFrame(i)};i()},mouseup:()=>{e=!1}},this.events.mouseout=this.events.mouseup;for(let t in this.events)for(let e in this.elements)this.elements[e].addEventListener(t,this.events[t].bind(this.elements[e]))}destroy(){for(let t in this.events)for(let e in this.elements)this.elements[e].removeEventListener(t,this.events[t])}}!function(){const t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins"),e=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.Dom");t.NorthArrow=class{constructor(t){this._opt=t;const i=t.domElement,n=e.create("div","bf-northarrow");n.style.top=`${t.top}px`,n.style.right=`${t.right}px`,i.appendChild(n),this.domElement=n,this._camera=t.viewer._camera,this.init()}init(){this.drawElements((()=>{this.addDomElementEvents(),this.northArrowYaw=new NorthArrowYaw(this.elements.yaw,this.domElement,this._camera),this.northArrowPitch=new NorthArrowPitch({pitchUp:this.elements.pitchUp,pitchDown:this.elements.pitchDown},this._camera),this.northArrowZoom=new NorthArrowZoom({zoomIn:this.elements.zoomIn,zoomOut:this.elements.zoomOut},this._camera),this.northArrowPan=new NorthArrowPan({panUp:this.elements.panUp,panDown:this.elements.panDown,panLeft:this.elements.panLeft,panRight:this.elements.panRight},this._camera),this.addRenderCallback()}))}drawElements(t){this.domElement.innerHTML='\n        <svg height="180" width="100" class="bf-northarrow-svg" onselectstart="return false;">\n          <defs>\n            <filter id="bf-northarrow-dropshadow" x="-10" y="-10" width="100" height="100">\n              <feDropShadow dx="0" dy="0" stdDeviation="0" \n              flood-color="cyan"/>\n            </filter>\n          </defs>\n          \n          <g class="bf-northarrow-pitchup" transform="translate(50, 12)" width="500" height="100">\n            <path d="M-15,0 A50,50 0 0,1 15,0 A3,3 0 0,1 14.5,8 A42,42 0 0,0 -14.5,8 A3,3 0 0,1 -15,0 Z" shape-rendering="geometricPrecision" />\n            <path d="M-4,3 L0,-1 4,3" shape-rendering="geometricPrecision" />\n          </g>\n\n          <g transform="translate(50, 60)">\n            <g class="bf-northarrow-yaw">\n              <path d="M39,0 A39,39 0 0,0 -39,0 L-29,0 A29,29 0 0,1 29,0 L39,0 A39,39 0 0,1 0,39 L0,29 A29,29 0 0,0 29,0 L39,0 M-39,0 A39,39 0 0,0 0,39 L0,29 A29,29 0 0,1 -29,0 L-39,0 Z" shape-rendering="geometricPrecision" />\n              <g transform="translate(-40, -40)">\n                <path />\n                <path d="M40,0 C62.09139,0 80,17.90861 80,40 C80,62.09139 62.09139,80 40,80 C17.90861,80 0,62.09139 0,40 C0,17.90861 17.90861,0 40,0 Z M40,1 C18.4608948,1 1,18.4608948 1,40 C1,61.5391052 18.4608948,79 40,79 C61.5391052,79 79,61.5391052 79,40 C79,18.4608948 61.5391052,1 40,1 Z" shape-rendering="geometricPrecision" />\n                <path d="M40,11 C56.0162577,11 69,23.9837423 69,40 C69,56.0162577 56.0162577,69 40,69 C23.9837423,69 11,56.0162577 11,40 C11,23.9837423 23.9837423,11 40,11 Z M40,12 C24.536027,12 12,24.536027 12,40 C12,55.463973 24.536027,68 40,68 C55.463973,68 68,55.463973 68,40 C68,24.536027 55.463973,12 40,12 Z" shape-rendering="geometricPrecision" />\n                <rect x="1" y="40" width="10" height="1" />\n                <rect x="69" y="40" width="10" height="1" />\n                <rect x="39" y="69" width="1" height="10" />\n                <path />\n              </g>\n              <text x="0" y="-30">N</text>\n            </g>\n          </g>\n\n          <g class="bf-northarrow-pitchdown" transform="translate(50, 108)">\n            <path d="M-15,0 A50,50 0 0,0 15,0 A3,3 0 0,0 14.5,-8 A42,42 0 0,1 -14.5,-8 A3,3 0 0,0 -15,0 Z" shape-rendering="geometricPrecision" />\n            <path d="M-4,-3 L0,1 4,-3" shape-rendering="geometricPrecision" />\n          </g>\n\n          <g transform="translate(50, 60)">\n            <g class="bf-northarrow-panup" transform="translate(-7, -24)">\n              <path d="M7,0 L14,10 0,10 Z" />\n              <path d="M7,0 L14,10 L0,10 L7,0 Z M7,1.745 L1.921,9 L12.078,9 L7,1.745 Z" />\n            </g>\n            <g class="bf-northarrow-pandown" transform="translate(-7, 14) rotate(180, 7 5)">\n              <path d="M7,0 L14,10 0,10 Z" />\n              <path d="M7,0 L14,10 L0,10 L7,0 Z M7,1.745 L1.921,9 L12.078,9 L7,1.745 Z" />\n            </g>\n            <g class="bf-northarrow-panleft" transform="translate(-24, -5) rotate(-90, 7 5)">\n              <path d="M7,0 L14,10 0,10 Z" />\n              <path d="M7,0 L14,10 L0,10 L7,0 Z M7,1.745 L1.921,9 L12.078,9 L7,1.745 Z" />\n            </g>\n            <g class="bf-northarrow-panright" transform="translate(10, -5) rotate(90, 7 5)">\n              <path d="M7,0 L14,10 0,10 Z" />\n              <path d="M7,0 L14,10 L0,10 L7,0 Z M7,1.745 L1.921,9 L12.078,9 L7,1.745 Z" />\n            </g>\n\n          </g>\n\n          <g transform="translate(50, 118)">\n            <g transform="translate(-13, 0)">\n              <rect id="Rectangle" fill="#2A313B" opacity="0.78" x="0" y="0" width="26" height="53" />\n              <path d="M26,0 L26,53 L0,53 L0,0 L26,0 Z M25,1 L1,1 L1,52 L25,52 L25,1 Z" fill="#969FAE" fill-rule="nonzero" />\n              <rect fill="#969FAE" x="3" y="26" width="20" height="1" />\n            </g>\n            <g class="bf-northarrow-zoomin">\n              <path d="M-13,0 L13,0 13,26 -13,26 Z" />\n              <polygon points="5 5 5 0 7 0 7 5 12 5 12 7 7 7 7 12 5 12 5 7 0 7 0 5" transform="translate(-6, 7)" />\n            </g>\n            <g class="bf-northarrow-zoomout">\n              <path d="M-13,26 L13,26 13,52 -13,52 Z" />\n              <rect x="0" y="0" width="12" height="2" transform="translate(-6, 39)" />\n            </g>\n          </g>\n        </svg>\n      ',this.elements={},["pitchUp","pitchDown","yaw","panUp","panDown","panLeft","panRight","zoomIn","zoomOut"].forEach((t=>{const e=this.domElement.querySelector(`.bf-northarrow-${t.toLowerCase()}`);this.elements[t]=e})),t()}addDomElementEvents(){this.domElementEvents={mouseover:()=>{this.elements.pitchUp.style.opacity=1,this.elements.pitchDown.style.opacity=1},mouseout:()=>{this.elements.pitchUp.style.opacity=0,this.elements.pitchDown.style.opacity=0},mousedown:t=>(t.stopPropagation(),!1)},this.domElementEvents.mousemove=this.domElementEvents.mouseup=this.domElementEvents.mousedown,this.domElementEvents.mouseout();for(let t in this.domElementEvents)this.domElement.addEventListener(t,this.domElementEvents[t])}addRenderCallback(){this.renderCallback=()=>{this.northArrowYaw&&this.northArrowYaw.update()},this._opt.viewer.getViewer().addRenderCallback(this.renderCallback)}destroy(){if(this.domElement&&this.domElementEvents)for(let t in this.domElementEvents)this.domElement.removeEventListener(t,this.domElementEvents[t]);this.northArrowYaw&&this.northArrowYaw.destroy(),this.northArrowPitch&&this.northArrowPitch.destroy(),this.northArrowPan&&this.northArrowPan.destroy(),this.northArrowZoom&&this.northArrowZoom.destroy(),this.renderCallback&&this._opt.viewer.getViewer().removeRenderCallback(this.renderCallback),this._opt.domElement.removeChild(this.domElement)}setLimitPitch(t=null,e=null){this.northArrowPitch.minPitch=null!=t?t:-Math.PI/2,this.northArrowPitch.maxPitch=null!=e?e:Math.PI/2}show(){this.domElement.style.display="block"}hide(){this.domElement.style.display="none"}}}(),Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins").ScaleBarConfig=function(){return{domElement:null,viewer:null,right:10,bottom:10}},function(){const t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins"),e=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.Dom"),i=[1,2,3,5,10,20,30,50,100,200,300,500,1e3,2e3,3e3,5e3,1e4,2e4,3e4,5e4,1e5,2e5,3e5,5e5,1e6,2e6,3e6,5e6,1e7,2e7,3e7,5e7];t.ScaleBar=class{constructor(t){this._opt=t;const i=t.domElement,n=e.create("div","bf-scale");n.style.bottom=`${t.bottom}px`,n.style.right=`${t.right}px`,i.appendChild(n),this.domElement=n,this.barElement=void 0,this.labelElement=void 0,this.lastUpdateTime=Date.now(),this.enableScale=!0,this._value=void 0,this.init()}init(){this.drawElements((()=>{this.addRenderCallback()}))}drawElements(t){this.domElement.innerHTML='\n            <svg height="36px" width="140px" class="bf-scale-svg" onselectstart="return false;">\n                <rect x="0" y="0" width="140px" height="36px" style="fill:#20262F;opacity:0.85;stroke-width:1px;stroke:#3B4554"/>\n                <path class="bf-scale-bar" fill="none"/>\n                <text class= "bf-scale-label" fill="#cccccc"></text>\n            </svg>\n          ',this.barElement=this.domElement.querySelector(".bf-scale-bar"),this.labelElement=this.domElement.querySelector(".bf-scale-label"),this.domElement.style.display="none",t()}addRenderCallback(){let t=()=>{if(this.enableScale&&!this._opt.viewer._isDestroyed){var t=this._opt.viewer.getViewer().camera,e=this._opt.viewer.getViewer().getViewportSize();if(t.position.y<0)this.domElement.style.display="none";else{var n=new THREE.Vector3(e.width/2,e.height-1),o=new THREE.Vector3(e.width/2+1,e.height-1),s=this._opt.viewer.getViewer().pickByPoint(n,!0),r=this._opt.viewer.getViewer().pickByPoint(o,!0);if(s&&r&&s.worldPosition&&r.worldPosition){var a=s.worldPosition.distanceTo(r.worldPosition);if(this._pixelDistance=a,a<0)this.domElement.style.display="none";else{for(var l,h=i.length-1;!l&&h>=0;--h)i[h]/a<=120&&(l=i[h]);if(l){var c;this._value=l,c=l>=1e3?(l/1e3).toString()+"km":l.toString()+"m",this.labelElement.textContent=c;var d=this.labelElement.getBoundingClientRect().width||43;this.labelElement.setAttribute("x",70-d/2),this.labelElement.setAttribute("y",23);var u=l/a,p="M"+(70-u/2).toString()+" 20 L"+(70-u/2).toString()+" 28 L"+(70+u/2).toString()+" 28 L"+(70+u/2).toString()+" 20";this.barElement.setAttribute("d",p),this.domElement.style.display="block"}else this._value=void 0,this._pixelDistance=void 0,this.domElement.style.display="none"}}else this.domElement.style.display="none"}}},e=null,n=null;this.renderCallback=()=>{n||(n=setTimeout((()=>{t(),n=null}),250)),e&&(clearTimeout(e),e=null),e=setTimeout((()=>{clearTimeout(n),n=null,t()}),250)},this._opt.viewer.getViewer().addRenderCallback(this.renderCallback)}destroy(){this.renderCallback&&this._opt.viewer.getViewer().removeRenderCallback(this.renderCallback),this._opt.domElement.removeChild(this.domElement)}show(){this.domElement.style.display="block",this.enableScale=!0}hide(){this.domElement.style.display="none",this.enableScale=!1}isVisible(){return this.enableScale}getValue(){return this._pixelDistance}}}(),Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins").InfoBarConfig=function(){return{domElement:null,viewer:null,right:0,bottom:0}},function(){const t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins"),e=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.Dom");t.InfoBar=class{constructor(t){this._opt=t;const i=t.domElement,n=e.create("div","bf-infobar");n.style.bottom=`${t.bottom}px`,n.style.right=`${t.right}px`,n.style.display="none",i.appendChild(n),this.domElement=n,this.enable=!0,this._info={},this._inited=!1,this.isMouseClicked=!1,this._mousemoveCallback=t=>{if(!this.enable)return;if(this.isMouseClicked)return;let e=this._opt.viewer.getViewer().pickByPoint(t);if(!e)return;let i=e.worldPosition,n=i.z,{lat:o,lon:s}=this._opt.viewer.worldToLatLon(i);this._info={latitude:o,longtitude:s,altitude:n};let r=`${o.toFixed(6)}${o>=0?"N":"S"}&nbsp;&nbsp;${s.toFixed(6)}${s>=0?"E":"W"}&nbsp;&nbsp;${"-0.000"===n.toFixed(3)?"0.000":n.toFixed(3)}m`;this.domElement.innerHTML=r,this._inited||(this.domElement.style.display="block",this._inited=!0)},this._mousedownCallback=()=>{this.isMouseClicked=!0},this._mouseupCallback=()=>{this.isMouseClicked=!1},this.init()}init(){this._opt.domElement.addEventListener("mousedown",this._mousedownCallback),this._opt.domElement.addEventListener("mouseup",this._mouseupCallback),this._opt.domElement.addEventListener("mousemove",this._mousemoveCallback)}destroy(){this._opt.domElement.removeEventListener("mousemove",this._mousemoveCallback),this._opt.domElement.removeEventListener("mousedown",this._mousedownCallback),this._opt.domElement.removeEventListener("mouseup",this._mouseupCallback),this._opt.domElement.removeChild(this.domElement)}show(){this.domElement.style.display="block",this.enable=!0}hide(){this.domElement.style.display="none",this.enable=!1}isVisible(){return this.enable}getValue(){return this._info}}}(),Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins").CreditConfig=function(){return{domElement:null,viewer:null,right:10,bottom:10}},function(){const t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins"),e=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.Dom");t.Credit=class{constructor(t){this._opt=t;const i=t.domElement,n=e.create("div",`bf-credit ${t.class||""}`);i.appendChild(n),this.domElement=n,this.barElement=void 0,this.labelElement=void 0}drawElements(){const{credit:t,text:e,link:i,copyright:n}=this._opt;switch(t){case Glodon$1.Bimface.Common.Credit.None:this.domElement.innerHTML="";break;case Glodon$1.Bimface.Common.Credit.OSM:this.domElement.innerHTML=`\n            <div class='copyright'>©<a class='text' href='${i}' target='_blank'>OpenStreetMap</a> contributors</div>\n          `;break;default:this.domElement.innerHTML=`\n            <div class='copyright'>${n}\n            <div class='divider'></div>\n            <a class='text' href='${i}' target='_blank'>${e}</a>         \n            </div>\n          `}}destroy(){this._opt.domElement.removeChild(this.domElement)}update(t){this._opt=Object.assign({},this._opt,t),this.drawElements()}show(){this.domElement.style.display="block"}hide(){this.domElement.style.display="none"}}}(),Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Search").SearchConfig=function(){return{wrapElement:null,viewer:null}},function(){var t="Bimface.Plugins.Search",e=Glodon$1.Bimface.Data.StatisticsDataManager.getInstance(),i=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Search"),n=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.Dom"),o=function(t){var e=t;if(this._opt=e,this.clear(),!e.viewer)return console.log("viewer is not defined."),!1;let i=new Glodon$1.Web.Lang.EventManager;this.getEventManager=function(){return i},this.element=n.create("div","bf-search-toolbar"),e.wrapElement.appendChild(this.element),this.init()};o.prototype={addEventListener:function(t,e){this.getEventManager().addEvent(t,e)},removeEventListener:function(t,e){this.getEventManager().removeEvent(t,e)},clickSearch(t){const e=this._opt.viewer,i=this.element.querySelector("input").value;return""==i?(this.clear(),void this.update(t)):i===this._data.text?this.clickArrow(!0,t):void e.search({text:i},(e=>{this._data.index=e.length>0?1:0;let n=this.formatResult(e);this._data.all=n.length,this._data.result=n,this._data.text=i,this._opt.UI.getToolbar("LeftSubToolbar")&&n.length>0&&this._opt.UI.getToolbar("LeftSubToolbar").getControl("LayoutList").setSelectedUiById(0==n[this._data.index-1].viewId?"Model":n[this._data.index-1].viewId),this.update(t),this._data.index&&this.zoomToBbox(n[this._data.index-1])}))},clickArrow(t,e){const i=t?this._data.index+1:this._data.index-1,n=this._data.result,o=this._opt.UI;n.length>0&&(this._data.index=t?i>n.length?1:i:i>0&&i||n.length,o.getToolbar("LeftSubToolbar")&&o.getToolbar("LeftSubToolbar").getControl("LayoutList").setSelectedUiById(0==n[this._data.index-1].viewId?"Model":n[this._data.index-1].viewId),this.update(e),this.zoomToBbox(n[this._data.index-1]))},init:function(){e.send(t,"init"),document.addEventListener("keyup",(t=>{t&&13==t.keyCode&&this.element.querySelector("input")==document.activeElement&&this.clickSearch(!0)})),this.element.addEventListener("click",(t=>{let e=t.target;e.hasClass("gld-bf-search")?this.clickSearch():e.hasClass("gld-bf-arrowup")?this.clickArrow():e.hasClass("gld-bf-arrowdown")&&this.clickArrow(!0)})),this.update()},formatResult(t){let e=[];for(let i=0;i<t.length;i++){const n=t[i];for(let t=0;t<n.data.length;t++){const i=n.data[t];e.push({viewId:n.viewId,content:n.content,modelId:n.modelId,boundingBox:i.boundingBox})}}return e},update:function(i){if(e.send(t,"update"),this.element.innerHTML=`<input value="${this._data.text||""}" placeholder="${BimfaceLanguage.bf_btn_search_textInput}" /><div title="${BimfaceLanguage.bf_btn_search_search}" class='bf-button gld-bf-search'></div><div class='line'></div><span class='count'>${this._data.index}/${this._data.all}</span><div  title="${BimfaceLanguage.bf_btn_search_previous}" class='bf-button gld-bf-arrowup'></div><div title="${BimfaceLanguage.bf_btn_search_next}" class='bf-button gld-bf-arrowdown'></div>`,i){let t=this.element.querySelector("input");t.focus();const e=this._data.text;t.value="",t.value=e}},clear:function(){this._data={index:0,all:0,text:"",text:"",result:[]}},zoomToBbox(t){const e=this._opt.viewer;e.showViewById(t.viewId),e.zoomToBoundingBox(t.boundingBox)}},i.Search=o}(),Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.SkyBox").SkyBoxStyle=Object.freeze({BlueSky:"BlueSky",CloudySky:"CloudySky",DarkNight:"DarkNight",Galaxy:"Galaxy",Customized:"Customized"}),function(){const t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.SkyBox");t.SkyBoxManagerConfig=class{constructor(){this.customizedImage=null,this.style=null,this.viewer=null}}}(),void 0===Object.assign&&(Object.assign=function(t){if(null==t)throw new TypeError("Cannot convert undefined or null to object");for(var e=Object(t),i=1;i<arguments.length;i++){var n=arguments[i];if(null!=n)for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(e[o]=n[o])}return e});let BimfaceConfigrationOption=Object.freeze({Release:"Release",Debug:"Debug"}),BimfaceViewTypeOption=Object.freeze({Normal:"Normal",DrawingView:"drawingView"}),BimfaceEnvOption=Object.freeze({BIMFACE:"BIMFACE",Local:"Local"}),BimfaceLanguageOption=Object.freeze({zh_CN:"zh_CN",en_GB:"en_GB",sv_SE:"sv_SE",zh_TW:"zh_TW"}),BimfaceVisualStyle=Object.freeze({Normal:"Normal",Bake:"Bake"});var BimfaceSDKLoaderConfig=function(){if(window.hostConfig){for(let t in window.hostConfig)hostConfig[t]=window.hostConfig[t];hostConfig.securityApi=window.hostConfig.securityApi}return{staticHost:`${hostConfig.staticHost}/api`,APIHost:hostConfig.APIHost,language:"zh_CN",viewToken:null,configuration:BimfaceConfigrationOption.Release,dataEnvType:hostConfig.dataEnvType||"BIMFACE",viewType:BimfaceViewTypeOption.Normal,visualStyle:BimfaceVisualStyle.Bake,version:"",securityApi:hostConfig.securityApi}};window.BimfaceSDKLoaderConfig=BimfaceSDKLoaderConfig,window.BimfaceEnvOption=BimfaceEnvOption,window.BimfaceLanguageOption=BimfaceLanguageOption,window.BimfaceConfigrationOption=BimfaceConfigrationOption,window.BimfaceViewTypeOption=BimfaceViewTypeOption,function(){var t=Glodon$1.Bimface.Data.StatisticsDataManager.getInstance();const e=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.SkyBox");e.SkyBoxManager=class{constructor(e){t.send("Bimface.Plugins.SkyBox.SkyBoxManager","bf_c_skyBoxMng_new"),this._customizedImage=e.customizedImage,this._style=e.style,this._viewer=e.viewer,this._enabled=!1,this.enableSkyBox(!0)}setCustomizedImage(t){this._customizedImage!=t&&(this._customizedImage=t,this._updateSkyBox())}getCustomizedImage(){return this._customizedImage}setStyle(t){this._style!=t&&(this._style=t,this._updateSkyBox())}getStyle(){return this._style}enableSkyBox(t){if(this._enabled!=t){if(this._enabled=t,!this._enabled)this._viewer.getViewer().IBLManager.removeSkyBox();this._updateSkyBox()}}getSenceType(){return Glodon$1.Bimface.Common.Type.EffectType.SkyBoxManager}show(){this.enableSkyBox(!0)}hide(){this.enableSkyBox(!1)}destroy(){this.enableSkyBox(!1),this._customizedImage=null,this._style=null,this._viewer=null}getParams(){return{customizedImage:this._customizedImage,style:this._style}}_updateSkyBox(){if(this._enabled){var t=this._viewer.getViewer().IBLManager,e=this._style,i=this._viewer._data,n=[];if(this._style==Glodon$1.Bimface.Plugins.SkyBox.SkyBoxStyle.Customized&&this._customizedImage?(n.push(this._customizedImage.right),n.push(this._customizedImage.left),n.push(this._customizedImage.top),n.push(this._customizedImage.bottom),n.push(this._customizedImage.front),n.push(this._customizedImage.back)):e=this._style==Glodon$1.Bimface.Plugins.SkyBox.SkyBoxStyle.Customized?Glodon$1.Bimface.Plugins.SkyBox.SkyBoxStyle.CloudySky:this._style,0==n.length&&e){var o=(i.dataEnvType==BimfaceEnvOption.Local?i.sdkPath:hostConfig.staticHost)+"/resources/SkyBox/Pics/"+e;const t=["posx.jpg","negx.jpg","posy.jpg","negy.jpg","posz.jpg","negz.jpg"];for(var s=0;s<6;++s)n.push(o+"/EnvMap_"+t[s])}t.loadSkyBox(n,!1),t.setSkyBoxType(e)}}}}(),function(){const t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Ground");t.GroundConfig=class{constructor(){this.elevation=0,this.viewer=null}}}(),function(){var t=Glodon$1.Bimface.Data.StatisticsDataManager.getInstance();const e=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.Ground");e.Ground=class{constructor(e){t.send("Bimface.Plugins.Ground.Ground","createGround"),this._color=e.color,this._viewer=e.viewer,this._elevation=e.elevation,this._ground=this._viewer.getViewer().createGround(e)}destroy(){this._viewer.getViewer().removeGround(),this._ground=null}setElevation(t){this._ground.setElevation(t)}getElevation(){return this._ground.getElevation()}show(){console.log("This function is not available now")}hide(){console.log("This function is not available now")}update(){console.log("This function is not available now")}setColor(){console.log("This function is not available now")}}}(),Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.AuxMobile").AuxMobileConfig=function(){return{editor:null,width:3,viewer:null}},function(){const t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.AuxMobile"),e=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Web.Lang.Utility.Dom");t.AuxMobile=class{constructor(t){this.viewer=t.viewer,this.touchEndCounts=0,this.editor=t.editor,this.showAuxBall=!1,this.outerCircleRadius=60,this.outerCircleFillStyle="rgba(255, 255, 255, 0.3)",this.outerCircleBorderWidth=2,this.outerCircleBorderColor="#999999",this.innerCircleRadius=50,this.innerCircleFillStyle="rgba(204, 204, 204, 0.5)",this.innerCircleBorderWidth=2,this.ballOuterCircleRadius=60,this.ballOuterCircleFillStyle="rgba(255, 255, 255, 0.3)",this.ballOuterCircleBorderWidth=1,this.ballOuterCircleBorderColor="#999999",this.ballInnerCircleRadius=30,this.ballInnerCircleFillStyle="rgba(255, 255, 255, 0.8)",this.ballInnerCircleBorderWidth=2,this.ballDirectionCircleRadius=6,this.ballDirectionCircleFillStyle="rgba(50, 211, 166, 1)",this.ballDirectionCircleBorderWidth=1,this.triangleWidth=20,this.triangleFillStyle="rgba(204, 204, 204, 0.5)",this.triangleBorderWidth=2,this.triangleBorderColor="#999999";let i=this.canvas=e.create("canvas","bf-aux-mobile"),n=this.viewer.getDomElement();i.width=n.offsetWidth,i.height=n.offsetHeight,this.ctx=i.getContext("2d"),n.append(i),this.initPos()}initPos(){let t={x:this.canvas.width/2,y:this.canvas.height/2};this.draw(this.updateAux(t))}setEditor(t){this.editor=t}updateAux(t){this.center=t;let e={outerCircle:{}};if(e.outerCircle.center=t,this.showAuxBall)e.outerCircle.radius=this.ballOuterCircleRadius,e.innerCircle={},e.innerCircle.center=t,e.innerCircle.radius=this.ballInnerCircleRadius;else{e.outerCircle.radius=this.outerCircleRadius,e.innerCircle={},e.innerCircle.center=t,e.innerCircle.radius=this.innerCircleRadius,e.triangle=[];let i={x:t.x-this.outerCircleRadius,y:t.y-this.outerCircleRadius};e.triangle.push({x:i.x,y:i.y}),e.triangle.push({x:i.x+this.triangleWidth,y:i.y}),e.triangle.push({x:i.x,y:i.y+this.triangleWidth})}return e}draw(t){let e=this.ctx;e.clearRect(0,0,this.canvas.width,this.canvas.height);let i=t.outerCircle;e.strokeStyle=this.outerCircleBorderColor,e.lineWidth=this.outerCircleBorderWidth,e.fillStyle=this.outerCircleFillStyle,e.beginPath(),e.arc(i.center.x,i.center.y,i.radius,0,2*Math.PI,!0),e.fill(),e.stroke();let n=t.innerCircle;e.fillStyle=this.innerCircleFillStyle,e.beginPath(),e.arc(n.center.x,n.center.y,n.radius,0,2*Math.PI,!0),e.fill();let o=t.triangle;e.lineWidth=this.triangleBorderWidth,e.fillStyle=this.triangleFillStyle,e.beginPath(),e.moveTo(o[0].x,o[0].y),e.lineTo(o[1].x,o[1].y),e.lineTo(o[2].x,o[2].y),e.closePath(),e.fill(),e.stroke()}drawBall(t){let e=this.ctx;e.clearRect(0,0,this.canvas.width,this.canvas.height);let i=t.outerCircle;e.strokeStyle=this.ballOuterCircleBorderColor,e.lineWidth=this.ballOuterCircleBorderWidth,e.fillStyle=this.ballOuterCircleFillStyle,e.beginPath(),e.arc(i.center.x,i.center.y,i.radius,0,2*Math.PI,!0),e.fill(),e.stroke();let n=t.innerCircle;e.fillStyle=this.ballInnerCircleFillStyle,e.beginPath(),e.arc(n.center.x,n.center.y,n.radius,0,2*Math.PI,!0),e.fill(),e.lineWidth=this.ballDirectionCircleBorderWidth,e.fillStyle=this.ballDirectionCircleFillStyle,e.beginPath(),e.arc(n.center.x,n.center.y,this.ballDirectionCircleRadius,0,2*Math.PI,!0),e.fill(),e.moveTo(n.center.x-this.ballDirectionCircleRadius-3,n.center.y-this.ballDirectionCircleRadius-2),e.lineTo(n.center.x-this.ballDirectionCircleRadius-13,n.center.y),e.lineTo(n.center.x-this.ballDirectionCircleRadius-3,n.center.y+this.ballDirectionCircleRadius+2),e.closePath(),e.fill(),e.beginPath(),e.moveTo(n.center.x+this.ballDirectionCircleRadius+3,n.center.y-this.ballDirectionCircleRadius-2),e.lineTo(n.center.x+this.ballDirectionCircleRadius+13,n.center.y),e.lineTo(n.center.x+this.ballDirectionCircleRadius+3,n.center.y+this.ballDirectionCircleRadius+2),e.closePath(),e.fill()}getRealPoint(t){let e=this.canvas.getBoundingClientRect(),i=this.outerCircleRadius,n=this.outerCircleRadius;return{x:t.x-i+e.left,y:t.y-n+e.top}}getBallRealPoint(t){let e=this.outerCircleRadius,i=this.outerCircleRadius;return{x:t.x-e,y:t.y-i}}showBall(){let t=this.getBallRealPoint(this.center);this.showAuxBall=!0,this.drawBall(this.updateAux(t))}showCanvas(){this.canvas.style.display="block"}hideCanvas(){this.canvas.style.display="none"}formatPoint(t){let e=this.canvas.getBoundingClientRect();return{x:t.x-e.left,y:t.y-e.top}}onTouchStart(t,e){if(e=this.formatPoint(e),!this.touchOnAux(e))return;this.startPoint=e,t.stopImmediatePropagation(),t.preventDefault(),this.editor.touchStartCallback(e)}onTouchMove(t,e){if(e=this.formatPoint(e),!this.touchOnAux(e))return;t.stopImmediatePropagation(),t.preventDefault();let i=this.editor,n=this.updateAux({x:e.x,y:e.y});if(this.showAuxBall){this.drawBall(n);let t=this.startPoint,o=this.getCoordinate(),s=[o.endZ.x-o.start.x,o.endZ.y-o.start.y],r=[e.x-t.x,e.y-t.y],a=this.vectorAngle(s,r);i.touchMoveCallback(this.center,Math.sqrt(Math.pow(r[0],2)+Math.pow(r[1],2))*Math.cos(a))}else{this.draw(n);let t=this.getRealPoint(e);i.touchMoveCallback(t)}}onTouchEnd(t,e,i){if(e=this.formatPoint(e),!this.touchOnAux(e))return;t.stopImmediatePropagation(),t.preventDefault();let n=this.editor;if(this.showAuxBall)n.touchEndCallback(this.center);else{let t=this.getRealPoint(e);n.touchEndCallback(t)}}vectorAngle(t,e){let i=Math.sqrt(t.reduce(((t,e)=>t+Math.pow(e,2)),0)),n=Math.sqrt(e.reduce(((t,e)=>t+Math.pow(e,2)),0));return Math.acos(t.reduce(((t,i,n)=>t+i*e[n]),0)/(i*n))}getNormal(){let t=this.viewer.getViewer().getScene();return CLOUD.FillClipPlaneManager.getInstance(t).renderClipPlane.normal}getCoordinate(){let t=this.viewer._sectionPlane.coordinateSystem,e=t.getCoordinateAxis();return{start:t.drawingToCanvas(e.start.clone()),endZ:t.drawingToCanvas(e.endZ.clone())}}hide(){this.canvas.style.display="none"}show(){this.canvas.style.display="",this.showAuxBall=!1,this.initPos()}destroy(){this.canvas.remove()}redraw(){if(this.center){let t=this.updateAux(this.center);this.draw(t)}}touchOnAux(t){const{center:e,outerCircleRadius:i,ballOuterCircleRadius:n,showAuxBall:o}=this,s=t;let r=e.x-s.x,a=e.y-s.y;return Math.sqrt(r*r+a*a)<=(o&&n||i)}}}(),function(){var t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.ClashDetective");t.ClashDetectivePanelConfig=class{constructor(){this.viewer=null}}}(),function(){var t=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.ClashDetective"),e=Glodon$1.Bimface.Data.StatisticsDataManager.getInstance();t.ClashDetectivePanel=class{constructor(t){e.send("Bimface.Plugins.ClashDetective.ClashDetectivePanel","bf_c_clashDetectivePanel_new");let i=this;if(this._console=new Glodon$1.Web.Common.Console,!t)return void this._console.error("clashDetectivePanelConfig must not be empty.");if(!t.viewer||"Viewer3D"===!t.viewer.viewerType)return void this._console.error("viewer must not be empty or viewer3d.");this.clashDetectivePanelConfig=t,this.viewer=t.viewer,this.unitType=this.viewer.getUnit(),this.modelUnit=this.unitType;const n=i.viewer.getModels();n.length&&(this.modelUnit="m"===n[0]._manifest.Metadata.Unit?"Meter":"Millimeter"),this.clashResult={},this.currentIndex=0,this.hasModelA=!1,this.hasModelB=!1,this.isIntegrateA=!1,this.isIntegrateB=!1,this.transMultiplyingMap={"Millimeter-Millimeter":1,"Millimeter-Centimeter":.1,"Millimeter-Meter":.001,"Millimeter-Kilometer":1e-7,"Meter-Millimeter":1e3,"Meter-Centimeter":100,"Meter-Meter":1,"Meter-Kilometer":.001},this.bBoxBorderMap={Millimeter:2e3,Centimeter:200,Meter:2,Kilometer:.002};var o=new Glodon$1.Bimface.UI.Panel.PanelConfig;o.title=BimfaceLanguage.bf_panel_clashDetective_clashDetective,o.className="bf-panel clash-detective-panel-wrapper",o.id="clashDetective";let s=Glodon$1.Web.Lang.Utility.ClientHelper.getIsDesktop();o.css=s?{right:"10px",top:"10px",width:"300px",height:"416px"}:{left:0,top:0,width:"100%",height:"100%"};var r=new Glodon$1.Bimface.UI.Panel.Panel(o);let a,l;r.addEventListener("Hide",(()=>{this.clearIsolation();let t=document.querySelector(`#itemId_${this.currentIndex}`);t&&t.setAttribute("class","cd-r-list-item"),this.currentIndex=0})),this.clashDetectivePanel=r,this.viewer.clashDetectivePanel=r,this.makeOthersTranslucent=Glodon$1.Bimface.Viewer.IsolateOption.MakeOthersTranslucent,i._updateModelName=function(t){l=i.viewer.getModels().find((t=>t._data.modelId==i.modelIdA)),!l||t!=i.modelIdA&&t!=l.modelId||(i.modelUnit="m"===l._manifest.Metadata.Unit?"Meter":"Millimeter",i.hasModelA=!0,a=document.getElementById("cdModelAName"),a&&(a.setAttribute("class","active"),a.removeAttribute("title"),a.innerText=`${l._data.name}${i.isIntegrateA?"（集成模型）":""}`)),l=i.viewer.getModels().find((t=>t._data.modelId==i.modelIdB)),!l||t!=i.modelIdB&&t!=l.modelId||(i.modelUnit="m"===l._manifest.Metadata.Unit?"Meter":"Millimeter",i.hasModelB=!0,a&&(a=document.getElementById("cdModelBName"),a.setAttribute("class","active"),a.removeAttribute("title"),a.innerText=`${l._data.name}${i.isIntegrateB?"（集成模型）":""}`))},this.viewer.addEventListener(Glodon$1.Bimface.Viewer.Viewer3DEvent.ModelAdded,this._updateModelName)}setActiveItem(t,e=!1){if(t<=0||this.clashResult&&this.clashResult.results.length&&t>this.clashResult.results.length)return;if(!e){let t=document.querySelector(`#itemId_${this.currentIndex}`);t&&t.setAttribute("class","cd-r-list-item")}let i=this.clashResult.results[t-1],n=document.querySelector(`#itemId_${t}`);n&&n.setAttribute("class","cd-r-list-item active"),this.currentIndex=t,(this.hasModelA||this.hasModelB)&&(this.isolateComponentsById(i),this.zoomToBoundingBox(i.position,this.unitType,this.modelUnit))}zoomToBoundingBox(t,e,i){let n=this.transformToBoundingBox(t,e,i);this.viewer.zoomToBoundingBox(n)}transformToBoundingBox(t,e,i){const n=this.transMultiplyingMap[`${i}-${e}`],o=this.bBoxBorderMap[e];return{max:{x:t.x*n+o,y:t.y*n+o,z:t.z*n+o},min:{x:t.x*n-o,y:t.y*n-o,z:t.z*n-o}}}destroy(){this.clashDetectivePanel.close(),this.clearIsolation(),this.viewer.removeEventListener(Glodon$1.Bimface.Viewer.Viewer3DEvent.ModelAdded,this._updateModelName)}show(){this.clashDetectivePanel.show()}hide(){this.clashDetectivePanel.hide(),this.clearIsolation();let t=document.querySelector(`#itemId_${this.currentIndex}`);t&&t.setAttribute("class","cd-r-list-item"),this.currentIndex=0}setData(t){let e=this;this.clashDetectivePanel.clear(),this.clashResult=t,this.modelIdA=t.selectionA.fileId||t.selectionA.integrateId,this.modelIdB=t.selectionB.fileId||t.selectionB.integrateId,t.selectionA.integrateId&&(this.isIntegrateA=!0),t.selectionB.integrateId&&(this.isIntegrateB=!0);let i=[],n="";t.results.forEach(((t,e)=>{n=`\n          <li class="cd-r-list-item" id="itemId_${e+1}">\n            <span class="cd-r-list-item-left">${BimfaceLanguage.bf_panel_clashDetective_clash_num}${e+1}：</span>\n            <div class="cd-r-list-item-right">\n              <p><span>${BimfaceLanguage.bf_panel_clashDetective_componentA}：</span><span>${t.objectIdA}</span></p>\n              <p><span>${BimfaceLanguage.bf_panel_clashDetective_componentB}：</span><span>${t.objectIdB}</span></p>\n            </div>\n          </li>`,i.push(n)}));let o=this.modelIdA,s=this.modelIdB,r=this.viewer.getModels().find((t=>t._data.modelId==this.modelIdA)),a=this.viewer.getModels().find((t=>t._data.modelId==this.modelIdB));r&&(this.hasModelA=!0,o=r._data.name),a&&(this.hasModelB=!0,s=a._data.name);let l=`\n          <section class="cd-r-title-wrapper">\n            <div class="cd-r-title-item">\n              <span>${BimfaceLanguage.bf_panel_clashDetective_modelA}：</span>\n              <span id="cdModelAName" class="${this.hasModelA?"active":""}" title="${this.hasModelA?"":"模型未加载"}">\n                ${o}${this.isIntegrateA?"（集成模型）":""}\n              </span>\n            </div>\n            <div class="cd-r-title-item">\n              <span>${BimfaceLanguage.bf_panel_clashDetective_modelB}：</span>\n              <span id="cdModelBName" class="${this.hasModelB?"active":""}" title="${this.hasModelB?"":"模型未加载"}">\n                ${s}${this.isIntegrateB?"（集成模型）":""}\n              </span>\n            </div>\n          </section>\n          <ul class="cd-r-list-wrapper">\n            ${i.join("")}\n          </ul>\n        `;this.clashDetectivePanel.setHtml(l),this.viewer._opt.domElement.appendChild(this.clashDetectivePanel.element);document.querySelectorAll(".cd-r-list-item").forEach(((t,i)=>{let n=i+1;t.addEventListener("click",(function(){0===e.currentIndex?e.setActiveItem(n,!0):e.currentIndex!==n&&e.setActiveItem(n,!1)}))}))}isolateComponentsById(t){this.clearIsolation();let e=this.viewer.getModels().find((t=>t._data.modelId==this.modelIdA));e&&(e.isolateComponentsById([t.objectIdA,t.objectIdB],this.makeOthersTranslucent),e.overrideComponentsColorById([t.objectIdA],new Glodon$1.Web.Graphics.Color(229,120,115,1)),e.overrideComponentsFrameColor({ids:[[t.objectIdA]]},new Glodon$1.Web.Graphics.Color(255,96,88,1)));let i=this.viewer.getModels().find((t=>t._data.modelId==this.modelIdB));i&&(i.isolateComponentsById([t.objectIdA,t.objectIdB],this.makeOthersTranslucent),i.overrideComponentsColorById([t.objectIdB],new Glodon$1.Web.Graphics.Color(105,205,112,1)),i.overrideComponentsFrameColor({ids:[[t.objectIdB]]},new Glodon$1.Web.Graphics.Color(75,217,82,1))),this.viewer.render()}clearIsolation(){let t=this.viewer.getModels().find((t=>t._data.modelId==this.modelIdA));t&&(t.clearOverrideColorComponents(),t.restoreComponentsFrameColor({all:!0}),t.clearIsolation());let e=this.viewer.getModels().find((t=>t._data.modelId==this.modelIdB));e&&(e.clearOverrideColorComponents(),e.restoreComponentsFrameColor({all:!0}),e.clearIsolation()),this.viewer.render()}}}(),function(){var t=Glodon$1.Bimface.Data.StatisticsDataManager.getInstance(),e=Glodon$1.Web.Lang.Utility.Namespace.ensureNamespace(Glodon$1,"Bimface.Plugins.ClashDetective");let i=Glodon$1.Web.Lang.Utility.HttpRequest;e.ClashDetectiveManager=class{constructor(e){t.send("Bimface.Plugins.ClashDetective.ClashDetectiveManager","bf_c_clashDetectiveMng_new"),this.viewer=e,this._console=new Glodon$1.Web.Common.Console}loadClashDetectiveResult(t,e){let n=this;function o(t){n._console.error(t.message)}i.ajax({url:`${n.viewer._opt.APIHost}/inside/databag?viewToken=${t}`,async:!0,success:function(s){const r=JSON.parse(s);if("success"==r.code){let s=r.data&&r.data.modelId;s&&i.ajax({url:`${n.viewer._opt.APIHost}/data/clashDetective/${s}/result?view_token=${t}`,async:!0,success:function(t){var i=JSON.parse(t);"success"==i.code?e&&e(i.data):o(i)},failure:t=>{o(JSON.parse(t))}})}else o(r)},failure:t=>{o(JSON.parse(t))}})}}}(),window.Glodon=Glodon$1;