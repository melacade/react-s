!function(){"use strict";var e,t,i,r=window.CLOUD=window.CLOUD||{};e=1,t=1,function(e){function t(r){if(i[r])return i[r].exports;var a=i[r]={exports:{},id:r,loaded:!1};return e[r].call(a.exports,a,a.exports,t),a.loaded=!0,a.exports}var i={};t.m=e,t.c=i,t.p="",t(0)}([function(e,t,i){i(1),i(50),i(51),i(52),i(54),i(55),i(58),i(59),i(60),i(61),i(62),i(63),i(64),i(65),i(66),i(68),i(70),i(72),i(74),i(77),i(78),i(79),i(83),i(86),i(87),i(88),i(89),i(91),i(92),i(93),i(94),i(95),i(97),i(99),i(100),i(101),i(103),i(104),i(105),i(107),i(108),i(109),i(111),i(112),i(113),i(114),i(115),i(116),i(117),i(118),i(119),i(120),i(121),i(122),i(123),i(124),i(126),i(130),i(131),i(132),i(133),i(137),i(139),i(140),i(141),i(142),i(143),i(144),i(145),i(146),i(147),i(148),i(149),i(150),i(151),i(152),i(158),i(159),i(161),i(162),i(163),i(167),i(168),i(169),i(170),i(171),i(173),i(174),i(175),i(176),i(179),i(181),i(182),i(183),i(185),i(187),i(189),i(190),i(191),i(193),i(194),i(195),i(196),i(203),i(206),i(207),i(209),i(210),i(211),i(212),i(213),i(214),i(215),i(216),i(217),i(218),i(219),i(220),i(222),i(223),i(224),i(225),i(226),i(227),i(228),i(229),i(231),i(234),i(235),i(237),i(238),i(239),i(240),i(241),i(242),i(243),i(244),i(245),i(246),i(247),i(249),i(250),i(251),i(252),i(253),i(254),i(255),i(256),i(258),i(259),i(261),i(262),i(263),i(264),i(267),i(268),i(269),i(270),i(271),i(272),i(273),i(274),i(276),i(277),i(278),i(279),i(280),i(281),i(282),i(283),i(284),i(285),i(286),i(287),i(288),i(291),i(156),i(293),i(292),i(294),i(295),i(296),i(297),i(298),i(300),i(301),i(302),i(304),e.exports=i(305)},function(e,t,r){var a=r(2),n=r(3),s=r(4),o=r(6),l=r(16),d=r(20).KEY,h=r(5),c=r(21),u=r(22),p=r(17),m=r(23),f=r(24),g=r(25),v=r(27),y=r(40),M=r(43),E=r(10),b=r(30),I=r(14),x=r(15),T=r(44),_=r(47),S=r(49),C=r(9),w=r(28),R=S.f,B=C.f,L=_.f,O=a.Symbol,P=a.JSON,D=P&&P.stringify,A="prototype",N=m("_hidden"),H=m("toPrimitive"),U={}.propertyIsEnumerable,F=c("symbol-registry"),k=c("symbols"),G=c("op-symbols"),V=Object[A],j="function"==typeof O,z=a.QObject,W=!z||!z[A]||!z[A].findChild,q=s&&h((function(){return 7!=T(B({},"a",{get:function(){return B(this,"a",{value:7}).a}})).a}))?function(e,t,i){var r=R(V,t);r&&delete V[t],B(e,t,i),r&&e!==V&&B(V,t,r)}:B,X=function(e){var t=k[e]=T(O[A]);return t._k=e,t},Y=j&&"symbol"==typeof O.iterator?function(e){return"symbol"==typeof e}:function(e){return e instanceof O},K=function(e,t,i){return e===V&&K(G,t,i),E(e),t=I(t,!0),E(i),n(k,t)?(i.enumerable?(n(e,N)&&e[N][t]&&(e[N][t]=!1),i=T(i,{enumerable:x(0,!1)})):(n(e,N)||B(e,N,x(1,{})),e[N][t]=!0),q(e,t,i)):B(e,t,i)},Z=function(e,t){E(e);for(var i,r=y(t=b(t)),a=0,n=r.length;n>a;)K(e,i=r[a++],t[i]);return e},$=function(e){var t=U.call(this,e=I(e,!0));return!(this===V&&n(k,e)&&!n(G,e))&&(!(t||!n(this,e)||!n(k,e)||n(this,N)&&this[N][e])||t)},Q=function(e,t){if(e=b(e),t=I(t,!0),e!==V||!n(k,t)||n(G,t)){var i=R(e,t);return!i||!n(k,t)||n(e,N)&&e[N][t]||(i.enumerable=!0),i}},J=function(e){for(var t,i=L(b(e)),r=[],a=0;i.length>a;)n(k,t=i[a++])||t==N||t==d||r.push(t);return r},ee=function(e){for(var t,i=e===V,r=L(i?G:b(e)),a=[],s=0;r.length>s;)!n(k,t=r[s++])||i&&!n(V,t)||a.push(k[t]);return a};j||(O=function(){if(this instanceof O)throw TypeError("Symbol is not a constructor!");var e=p(arguments.length>0?arguments[0]:i),t=function(i){this===V&&t.call(G,i),n(this,N)&&n(this[N],e)&&(this[N][e]=!1),q(this,e,x(1,i))};return s&&W&&q(V,e,{configurable:!0,set:t}),X(e)},l(O[A],"toString",(function(){return this._k})),S.f=Q,C.f=K,r(48).f=_.f=J,r(42).f=$,r(41).f=ee,s&&!r(26)&&l(V,"propertyIsEnumerable",$,!0),f.f=function(e){return X(m(e))}),o(o.G+o.W+o.F*!j,{Symbol:O});for(var te="hasInstance,isConcatSpreadable,iterator,match,replace,search,species,split,toPrimitive,toStringTag,unscopables".split(","),ie=0;te.length>ie;)m(te[ie++]);for(te=w(m.store),ie=0;te.length>ie;)g(te[ie++]);o(o.S+o.F*!j,"Symbol",{for:function(e){return n(F,e+="")?F[e]:F[e]=O(e)},keyFor:function(e){if(Y(e))return v(F,e);throw TypeError(e+" is not a symbol!")},useSetter:function(){W=!0},useSimple:function(){W=!1}}),o(o.S+o.F*!j,"Object",{create:function(e,t){return t===i?T(e):Z(T(e),t)},defineProperty:K,defineProperties:Z,getOwnPropertyDescriptor:Q,getOwnPropertyNames:J,getOwnPropertySymbols:ee}),P&&o(o.S+o.F*(!j||h((function(){var e=O();return"[null]"!=D([e])||"{}"!=D({a:e})||"{}"!=D(Object(e))}))),"JSON",{stringify:function(e){if(e!==i&&!Y(e)){for(var t,r,a=[e],n=1;arguments.length>n;)a.push(arguments[n++]);return"function"==typeof(t=a[1])&&(r=t),!r&&M(t)||(t=function(e,t){if(r&&(t=r.call(this,e,t)),!Y(t))return t}),a[1]=t,D.apply(P,a)}}}),O[A][H]||r(8)(O[A],H,O[A].valueOf),u(O,"Symbol"),u(Math,"Math",!0),u(a.JSON,"JSON",!0)},function(e,i){var r=e.exports="undefined"!=typeof window&&window.Math==Math?window:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")();"number"==typeof t&&(t=r)},function(e,t){var i={}.hasOwnProperty;e.exports=function(e,t){return i.call(e,t)}},function(e,t,i){e.exports=!i(5)((function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a}))},function(e,t){e.exports=function(e){try{return!!e()}catch(e){return!0}}},function(e,t,r){var a=r(2),n=r(7),s=r(8),o=r(16),l=r(18),d="prototype",h=function(e,t,r){var c,u,p,m,f=e&h.F,g=e&h.G,v=e&h.S,y=e&h.P,M=e&h.B,E=g?a:v?a[t]||(a[t]={}):(a[t]||{})[d],b=g?n:n[t]||(n[t]={}),I=b[d]||(b[d]={});for(c in g&&(r=t),r)p=((u=!f&&E&&E[c]!==i)?E:r)[c],m=M&&u?l(p,a):y&&"function"==typeof p?l(Function.call,p):p,E&&o(E,c,p,e&h.U),b[c]!=p&&s(b,c,m),y&&I[c]!=p&&(I[c]=p)};a.core=n,h.F=1,h.G=2,h.S=4,h.P=8,h.B=16,h.W=32,h.U=64,h.R=128,e.exports=h},function(t,i){var r=t.exports={version:"2.4.0"};"number"==typeof e&&(e=r)},function(e,t,i){var r=i(9),a=i(15);e.exports=i(4)?function(e,t,i){return r.f(e,t,a(1,i))}:function(e,t,i){return e[t]=i,e}},function(e,t,i){var r=i(10),a=i(12),n=i(14),s=Object.defineProperty;t.f=i(4)?Object.defineProperty:function(e,t,i){if(r(e),t=n(t,!0),r(i),a)try{return s(e,t,i)}catch(e){}if("get"in i||"set"in i)throw TypeError("Accessors not supported!");return"value"in i&&(e[t]=i.value),e}},function(e,t,i){var r=i(11);e.exports=function(e){if(!r(e))throw TypeError(e+" is not an object!");return e}},function(e,t){e.exports=function(e){return"object"==typeof e?null!==e:"function"==typeof e}},function(e,t,i){e.exports=!i(4)&&!i(5)((function(){return 7!=Object.defineProperty(i(13)("div"),"a",{get:function(){return 7}}).a}))},function(e,t,i){var r=i(11),a=i(2).document,n=r(a)&&r(a.createElement);e.exports=function(e){return n?a.createElement(e):{}}},function(e,t,i){var r=i(11);e.exports=function(e,t){if(!r(e))return e;var i,a;if(t&&"function"==typeof(i=e.toString)&&!r(a=i.call(e)))return a;if("function"==typeof(i=e.valueOf)&&!r(a=i.call(e)))return a;if(!t&&"function"==typeof(i=e.toString)&&!r(a=i.call(e)))return a;throw TypeError("Can't convert object to primitive value")}},function(e,t){e.exports=function(e,t){return{enumerable:!(1&e),configurable:!(2&e),writable:!(4&e),value:t}}},function(e,t,i){var r=i(2),a=i(8),n=i(3),s=i(17)("src"),o="toString",l=Function[o],d=(""+l).split(o);i(7).inspectSource=function(e){return l.call(e)},(e.exports=function(e,t,i,o){var l="function"==typeof i;l&&(n(i,"name")||a(i,"name",t)),e[t]!==i&&(l&&(n(i,s)||a(i,s,e[t]?""+e[t]:d.join(String(t)))),e===r?e[t]=i:o?e[t]?e[t]=i:a(e,t,i):(delete e[t],a(e,t,i)))})(Function.prototype,o,(function(){return"function"==typeof this&&this[s]||l.call(this)}))},function(e,t){var r=0,a=Math.random();e.exports=function(e){return"Symbol(".concat(e===i?"":e,")_",(++r+a).toString(36))}},function(e,t,r){var a=r(19);e.exports=function(e,t,r){if(a(e),t===i)return e;switch(r){case 1:return function(i){return e.call(t,i)};case 2:return function(i,r){return e.call(t,i,r)};case 3:return function(i,r,a){return e.call(t,i,r,a)}}return function(){return e.apply(t,arguments)}}},function(e,t){e.exports=function(e){if("function"!=typeof e)throw TypeError(e+" is not a function!");return e}},function(e,t,i){var r=i(17)("meta"),a=i(11),n=i(3),s=i(9).f,o=0,l=Object.isExtensible||function(){return!0},d=!i(5)((function(){return l(Object.preventExtensions({}))})),h=function(e){s(e,r,{value:{i:"O"+ ++o,w:{}}})},c=e.exports={KEY:r,NEED:!1,fastKey:function(e,t){if(!a(e))return"symbol"==typeof e?e:("string"==typeof e?"S":"P")+e;if(!n(e,r)){if(!l(e))return"F";if(!t)return"E";h(e)}return e[r].i},getWeak:function(e,t){if(!n(e,r)){if(!l(e))return!0;if(!t)return!1;h(e)}return e[r].w},onFreeze:function(e){return d&&c.NEED&&l(e)&&!n(e,r)&&h(e),e}}},function(e,t,i){var r=i(2),a="__core-js_shared__",n=r[a]||(r[a]={});e.exports=function(e){return n[e]||(n[e]={})}},function(e,t,i){var r=i(9).f,a=i(3),n=i(23)("toStringTag");e.exports=function(e,t,i){e&&!a(e=i?e:e.prototype,n)&&r(e,n,{configurable:!0,value:t})}},function(e,t,i){var r=i(21)("wks"),a=i(17),n=i(2).Symbol,s="function"==typeof n;(e.exports=function(e){return r[e]||(r[e]=s&&n[e]||(s?n:a)("Symbol."+e))}).store=r},function(e,t,i){t.f=i(23)},function(e,t,i){var r=i(2),a=i(7),n=i(26),s=i(24),o=i(9).f;e.exports=function(e){var t=a.Symbol||(a.Symbol=n?{}:r.Symbol||{});"_"==e.charAt(0)||e in t||o(t,e,{value:s.f(e)})}},function(e,t){e.exports=!1},function(e,t,i){var r=i(28),a=i(30);e.exports=function(e,t){for(var i,n=a(e),s=r(n),o=s.length,l=0;o>l;)if(n[i=s[l++]]===t)return i}},function(e,t,i){var r=i(29),a=i(39);e.exports=Object.keys||function(e){return r(e,a)}},function(e,t,i){var r=i(3),a=i(30),n=i(34)(!1),s=i(38)("IE_PROTO");e.exports=function(e,t){var i,o=a(e),l=0,d=[];for(i in o)i!=s&&r(o,i)&&d.push(i);for(;t.length>l;)r(o,i=t[l++])&&(~n(d,i)||d.push(i));return d}},function(e,t,i){var r=i(31),a=i(33);e.exports=function(e){return r(a(e))}},function(e,t,i){var r=i(32);e.exports=Object("z").propertyIsEnumerable(0)?Object:function(e){return"String"==r(e)?e.split(""):Object(e)}},function(e,t){var i={}.toString;e.exports=function(e){return i.call(e).slice(8,-1)}},function(e,t){e.exports=function(e){if(e==i)throw TypeError("Can't call method on  "+e);return e}},function(e,t,i){var r=i(30),a=i(35),n=i(37);e.exports=function(e){return function(t,i,s){var o,l=r(t),d=a(l.length),h=n(s,d);if(e&&i!=i){for(;d>h;)if((o=l[h++])!=o)return!0}else for(;d>h;h++)if((e||h in l)&&l[h]===i)return e||h||0;return!e&&-1}}},function(e,t,i){var r=i(36),a=Math.min;e.exports=function(e){return e>0?a(r(e),9007199254740991):0}},function(e,t){var i=Math.ceil,r=Math.floor;e.exports=function(e){return isNaN(e=+e)?0:(e>0?r:i)(e)}},function(e,t,i){var r=i(36),a=Math.max,n=Math.min;e.exports=function(e,t){return(e=r(e))<0?a(e+t,0):n(e,t)}},function(e,t,i){var r=i(21)("keys"),a=i(17);e.exports=function(e){return r[e]||(r[e]=a(e))}},function(e,t){e.exports="constructor,hasOwnProperty,isPrototypeOf,propertyIsEnumerable,toLocaleString,toString,valueOf".split(",")},function(e,t,i){var r=i(28),a=i(41),n=i(42);e.exports=function(e){var t=r(e),i=a.f;if(i)for(var s,o=i(e),l=n.f,d=0;o.length>d;)l.call(e,s=o[d++])&&t.push(s);return t}},function(e,t){t.f=Object.getOwnPropertySymbols},function(e,t){t.f={}.propertyIsEnumerable},function(e,t,i){var r=i(32);e.exports=Array.isArray||function(e){return"Array"==r(e)}},function(e,t,r){var a=r(10),n=r(45),s=r(39),o=r(38)("IE_PROTO"),l=function(){},d="prototype",h=function(){var e,t=r(13)("iframe"),i=s.length;for(t.style.display="none",r(46).appendChild(t),t.src="javascript:",(e=t.contentWindow.document).open(),e.write("<script>document.F=Object<\/script>"),e.close(),h=e.F;i--;)delete h[d][s[i]];return h()};e.exports=Object.create||function(e,t){var r;return null!==e?(l[d]=a(e),r=new l,l[d]=null,r[o]=e):r=h(),t===i?r:n(r,t)}},function(e,t,i){var r=i(9),a=i(10),n=i(28);e.exports=i(4)?Object.defineProperties:function(e,t){a(e);for(var i,s=n(t),o=s.length,l=0;o>l;)r.f(e,i=s[l++],t[i]);return e}},function(e,t,i){e.exports=i(2).document&&document.documentElement},function(e,t,i){var r=i(30),a=i(48).f,n={}.toString,s="object"==typeof window&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[];e.exports.f=function(e){return s&&"[object Window]"==n.call(e)?function(e){try{return a(e)}catch(e){return s.slice()}}(e):a(r(e))}},function(e,t,i){var r=i(29),a=i(39).concat("length","prototype");t.f=Object.getOwnPropertyNames||function(e){return r(e,a)}},function(e,t,i){var r=i(42),a=i(15),n=i(30),s=i(14),o=i(3),l=i(12),d=Object.getOwnPropertyDescriptor;t.f=i(4)?d:function(e,t){if(e=n(e),t=s(t,!0),l)try{return d(e,t)}catch(e){}if(o(e,t))return a(!r.f.call(e,t),e[t])}},function(e,t,i){var r=i(6);r(r.S+r.F*!i(4),"Object",{defineProperty:i(9).f})},function(e,t,i){var r=i(6);r(r.S+r.F*!i(4),"Object",{defineProperties:i(45)})},function(e,t,i){var r=i(30),a=i(49).f;i(53)("getOwnPropertyDescriptor",(function(){return function(e,t){return a(r(e),t)}}))},function(e,t,i){var r=i(6),a=i(7),n=i(5);e.exports=function(e,t){var i=(a.Object||{})[e]||Object[e],s={};s[e]=t(i),r(r.S+r.F*n((function(){i(1)})),"Object",s)}},function(e,t,i){var r=i(6);r(r.S,"Object",{create:i(44)})},function(e,t,i){var r=i(56),a=i(57);i(53)("getPrototypeOf",(function(){return function(e){return a(r(e))}}))},function(e,t,i){var r=i(33);e.exports=function(e){return Object(r(e))}},function(e,t,i){var r=i(3),a=i(56),n=i(38)("IE_PROTO"),s=Object.prototype;e.exports=Object.getPrototypeOf||function(e){return e=a(e),r(e,n)?e[n]:"function"==typeof e.constructor&&e instanceof e.constructor?e.constructor.prototype:e instanceof Object?s:null}},function(e,t,i){var r=i(56),a=i(28);i(53)("keys",(function(){return function(e){return a(r(e))}}))},function(e,t,i){i(53)("getOwnPropertyNames",(function(){return i(47).f}))},function(e,t,i){var r=i(11),a=i(20).onFreeze;i(53)("freeze",(function(e){return function(t){return e&&r(t)?e(a(t)):t}}))},function(e,t,i){var r=i(11),a=i(20).onFreeze;i(53)("seal",(function(e){return function(t){return e&&r(t)?e(a(t)):t}}))},function(e,t,i){var r=i(11),a=i(20).onFreeze;i(53)("preventExtensions",(function(e){return function(t){return e&&r(t)?e(a(t)):t}}))},function(e,t,i){var r=i(11);i(53)("isFrozen",(function(e){return function(t){return!r(t)||!!e&&e(t)}}))},function(e,t,i){var r=i(11);i(53)("isSealed",(function(e){return function(t){return!r(t)||!!e&&e(t)}}))},function(e,t,i){var r=i(11);i(53)("isExtensible",(function(e){return function(t){return!!r(t)&&(!e||e(t))}}))},function(e,t,i){var r=i(6);r(r.S+r.F,"Object",{assign:i(67)})},function(e,t,i){var r=i(28),a=i(41),n=i(42),s=i(56),o=i(31),l=Object.assign;e.exports=!l||i(5)((function(){var e={},t={},i=Symbol(),r="abcdefghijklmnopqrst";return e[i]=7,r.split("").forEach((function(e){t[e]=e})),7!=l({},e)[i]||Object.keys(l({},t)).join("")!=r}))?function(e,t){for(var i=s(e),l=arguments.length,d=1,h=a.f,c=n.f;l>d;)for(var u,p=o(arguments[d++]),m=h?r(p).concat(h(p)):r(p),f=m.length,g=0;f>g;)c.call(p,u=m[g++])&&(i[u]=p[u]);return i}:l},function(e,t,i){var r=i(6);r(r.S,"Object",{is:i(69)})},function(e,t){e.exports=Object.is||function(e,t){return e===t?0!==e||1/e==1/t:e!=e&&t!=t}},function(e,t,i){var r=i(6);r(r.S,"Object",{setPrototypeOf:i(71).set})},function(e,t,r){var a=r(11),n=r(10),s=function(e,t){if(n(e),!a(t)&&null!==t)throw TypeError(t+": can't set as prototype!")};e.exports={set:Object.setPrototypeOf||("__proto__"in{}?function(e,t,i){try{(i=r(18)(Function.call,r(49).f(Object.prototype,"__proto__").set,2))(e,[]),t=!(e instanceof Array)}catch(e){t=!0}return function(e,r){return s(e,r),t?e.__proto__=r:i(e,r),e}}({},!1):i),check:s}},function(e,t,i){var r=i(73),a={};a[i(23)("toStringTag")]="z",a+""!="[object z]"&&i(16)(Object.prototype,"toString",(function(){return"[object "+r(this)+"]"}),!0)},function(e,t,r){var a=r(32),n=r(23)("toStringTag"),s="Arguments"==a(function(){return arguments}());e.exports=function(e){var t,r,o;return e===i?"Undefined":null===e?"Null":"string"==typeof(r=function(e,t){try{return e[t]}catch(e){}}(t=Object(e),n))?r:s?a(t):"Object"==(o=a(t))&&"function"==typeof t.callee?"Arguments":o}},function(e,t,i){var r=i(6);r(r.P,"Function",{bind:i(75)})},function(e,t,i){var r=i(19),a=i(11),n=i(76),s=[].slice,o={},l=function(e,t,i){if(!(t in o)){for(var r=[],a=0;a<t;a++)r[a]="a["+a+"]";o[t]=Function("F,a","return new F("+r.join(",")+")")}return o[t](e,i)};e.exports=Function.bind||function(e){var t=r(this),i=s.call(arguments,1),o=function(){var r=i.concat(s.call(arguments));return this instanceof o?l(t,r.length,r):n(t,r,e)};return a(t.prototype)&&(o.prototype=t.prototype),o}},function(e,t){e.exports=function(e,t,r){var a=r===i;switch(t.length){case 0:return a?e():e.call(r);case 1:return a?e(t[0]):e.call(r,t[0]);case 2:return a?e(t[0],t[1]):e.call(r,t[0],t[1]);case 3:return a?e(t[0],t[1],t[2]):e.call(r,t[0],t[1],t[2]);case 4:return a?e(t[0],t[1],t[2],t[3]):e.call(r,t[0],t[1],t[2],t[3])}return e.apply(r,t)}},function(e,t,i){var r=i(9).f,a=i(15),n=i(3),s=Function.prototype,o=/^\s*function ([^ (]*)/,l="name",d=Object.isExtensible||function(){return!0};l in s||i(4)&&r(s,l,{configurable:!0,get:function(){try{var e=this,t=(""+e).match(o)[1];return n(e,l)||!d(e)||r(e,l,a(5,t)),t}catch(e){return""}}})},function(e,t,i){var r=i(11),a=i(57),n=i(23)("hasInstance"),s=Function.prototype;n in s||i(9).f(s,n,{value:function(e){if("function"!=typeof this||!r(e))return!1;if(!r(this.prototype))return e instanceof this;for(;e=a(e);)if(this.prototype===e)return!0;return!1}})},function(e,t,i){var r=i(2),a=i(3),n=i(32),s=i(80),o=i(14),l=i(5),d=i(48).f,h=i(49).f,c=i(9).f,u=i(81).trim,p="Number",m=r[p],f=m,g=m.prototype,v=n(i(44)(g))==p,y="trim"in String.prototype,M=function(e){var t=o(e,!1);if("string"==typeof t&&t.length>2){var i,r,a,n=(t=y?t.trim():u(t,3)).charCodeAt(0);if(43===n||45===n){if(88===(i=t.charCodeAt(2))||120===i)return NaN}else if(48===n){switch(t.charCodeAt(1)){case 66:case 98:r=2,a=49;break;case 79:case 111:r=8,a=55;break;default:return+t}for(var s,l=t.slice(2),d=0,h=l.length;d<h;d++)if((s=l.charCodeAt(d))<48||s>a)return NaN;return parseInt(l,r)}}return+t};if(!m(" 0o1")||!m("0b1")||m("+0x1")){m=function(e){var t=arguments.length<1?0:e,i=this;return i instanceof m&&(v?l((function(){g.valueOf.call(i)})):n(i)!=p)?s(new f(M(t)),i,m):M(t)};for(var E,b=i(4)?d(f):"MAX_VALUE,MIN_VALUE,NaN,NEGATIVE_INFINITY,POSITIVE_INFINITY,EPSILON,isFinite,isInteger,isNaN,isSafeInteger,MAX_SAFE_INTEGER,MIN_SAFE_INTEGER,parseFloat,parseInt,isInteger".split(","),I=0;b.length>I;I++)a(f,E=b[I])&&!a(m,E)&&c(m,E,h(f,E));m.prototype=g,g.constructor=m,i(16)(r,p,m)}},function(e,t,i){var r=i(11),a=i(71).set;e.exports=function(e,t,i){var n,s=t.constructor;return s!==i&&"function"==typeof s&&(n=s.prototype)!==i.prototype&&r(n)&&a&&a(e,n),e}},function(e,t,i){var r=i(6),a=i(33),n=i(5),s=i(82),o="["+s+"]",l=RegExp("^"+o+o+"*"),d=RegExp(o+o+"*$"),h=function(e,t,i){var a={},o=n((function(){return!!s[e]()||"​"!="​"[e]()})),l=a[e]=o?t(c):s[e];i&&(a[i]=l),r(r.P+r.F*o,"String",a)},c=h.trim=function(e,t){return e=String(a(e)),1&t&&(e=e.replace(l,"")),2&t&&(e=e.replace(d,"")),e};e.exports=h},function(e,t){e.exports="\t\n\v\f\r   ᠎             　\u2028\u2029\ufeff"},function(e,t,i){var r=i(6),a=i(36),n=i(84),s=i(85),o=1..toFixed,l=Math.floor,d=[0,0,0,0,0,0],h="Number.toFixed: incorrect invocation!",c="0",u=function(e,t){for(var i=-1,r=t;++i<6;)r+=e*d[i],d[i]=r%1e7,r=l(r/1e7)},p=function(e){for(var t=6,i=0;--t>=0;)i+=d[t],d[t]=l(i/e),i=i%e*1e7},m=function(){for(var e=6,t="";--e>=0;)if(""!==t||0===e||0!==d[e]){var i=String(d[e]);t=""===t?i:t+s.call(c,7-i.length)+i}return t},f=function(e,t,i){return 0===t?i:t%2==1?f(e,t-1,i*e):f(e*e,t/2,i)};r(r.P+r.F*(!!o&&("0.000"!==8e-5.toFixed(3)||"1"!==.9.toFixed(0)||"1.25"!==1.255.toFixed(2)||"1000000000000000128"!==(0xde0b6b3a7640080).toFixed(0))||!i(5)((function(){o.call({})}))),"Number",{toFixed:function(e){var t,i,r,o,l=n(this,h),d=a(e),g="",v=c;if(d<0||d>20)throw RangeError(h);if(l!=l)return"NaN";if(l<=-1e21||l>=1e21)return String(l);if(l<0&&(g="-",l=-l),l>1e-21)if(t=function(e){for(var t=0,i=e;i>=4096;)t+=12,i/=4096;for(;i>=2;)t+=1,i/=2;return t}(l*f(2,69,1))-69,i=t<0?l*f(2,-t,1):l/f(2,t,1),i*=4503599627370496,(t=52-t)>0){for(u(0,i),r=d;r>=7;)u(1e7,0),r-=7;for(u(f(10,r,1),0),r=t-1;r>=23;)p(1<<23),r-=23;p(1<<r),u(1,1),p(2),v=m()}else u(0,i),u(1<<-t,0),v=m()+s.call(c,d);return v=d>0?g+((o=v.length)<=d?"0."+s.call(c,d-o)+v:v.slice(0,o-d)+"."+v.slice(o-d)):g+v}})},function(e,t,i){var r=i(32);e.exports=function(e,t){if("number"!=typeof e&&"Number"!=r(e))throw TypeError(t);return+e}},function(e,t,i){var r=i(36),a=i(33);e.exports=function(e){var t=String(a(this)),i="",n=r(e);if(n<0||n==1/0)throw RangeError("Count can't be negative");for(;n>0;(n>>>=1)&&(t+=t))1&n&&(i+=t);return i}},function(e,t,r){var a=r(6),n=r(5),s=r(84),o=1..toPrecision;a(a.P+a.F*(n((function(){return"1"!==o.call(1,i)}))||!n((function(){o.call({})}))),"Number",{toPrecision:function(e){var t=s(this,"Number#toPrecision: incorrect invocation!");return e===i?o.call(t):o.call(t,e)}})},function(e,t,i){var r=i(6);r(r.S,"Number",{EPSILON:Math.pow(2,-52)})},function(e,t,i){var r=i(6),a=i(2).isFinite;r(r.S,"Number",{isFinite:function(e){return"number"==typeof e&&a(e)}})},function(e,t,i){var r=i(6);r(r.S,"Number",{isInteger:i(90)})},function(e,t,i){var r=i(11),a=Math.floor;e.exports=function(e){return!r(e)&&isFinite(e)&&a(e)===e}},function(e,t,i){var r=i(6);r(r.S,"Number",{isNaN:function(e){return e!=e}})},function(e,t,i){var r=i(6),a=i(90),n=Math.abs;r(r.S,"Number",{isSafeInteger:function(e){return a(e)&&n(e)<=9007199254740991}})},function(e,t,i){var r=i(6);r(r.S,"Number",{MAX_SAFE_INTEGER:9007199254740991})},function(e,t,i){var r=i(6);r(r.S,"Number",{MIN_SAFE_INTEGER:-9007199254740991})},function(e,t,i){var r=i(6),a=i(96);r(r.S+r.F*(Number.parseFloat!=a),"Number",{parseFloat:a})},function(e,t,i){var r=i(2).parseFloat,a=i(81).trim;e.exports=1/r(i(82)+"-0")!=-1/0?function(e){var t=a(String(e),3),i=r(t);return 0===i&&"-"==t.charAt(0)?-0:i}:r},function(e,t,i){var r=i(6),a=i(98);r(r.S+r.F*(Number.parseInt!=a),"Number",{parseInt:a})},function(e,t,i){var r=i(2).parseInt,a=i(81).trim,n=i(82),s=/^[\-+]?0[xX]/;e.exports=8!==r(n+"08")||22!==r(n+"0x16")?function(e,t){var i=a(String(e),3);return r(i,t>>>0||(s.test(i)?16:10))}:r},function(e,t,i){var r=i(6),a=i(98);r(r.G+r.F*(parseInt!=a),{parseInt:a})},function(e,t,i){var r=i(6),a=i(96);r(r.G+r.F*(parseFloat!=a),{parseFloat:a})},function(e,t,i){var r=i(6),a=i(102),n=Math.sqrt,s=Math.acosh;r(r.S+r.F*!(s&&710==Math.floor(s(Number.MAX_VALUE))&&s(1/0)==1/0),"Math",{acosh:function(e){return(e=+e)<1?NaN:e>94906265.62425156?Math.log(e)+Math.LN2:a(e-1+n(e-1)*n(e+1))}})},function(e,t){e.exports=Math.log1p||function(e){return(e=+e)>-1e-8&&e<1e-8?e-e*e/2:Math.log(1+e)}},function(e,t,i){var r=i(6),a=Math.asinh;r(r.S+r.F*!(a&&1/a(0)>0),"Math",{asinh:function e(t){return isFinite(t=+t)&&0!=t?t<0?-e(-t):Math.log(t+Math.sqrt(t*t+1)):t}})},function(e,t,i){var r=i(6),a=Math.atanh;r(r.S+r.F*!(a&&1/a(-0)<0),"Math",{atanh:function(e){return 0==(e=+e)?e:Math.log((1+e)/(1-e))/2}})},function(e,t,i){var r=i(6),a=i(106);r(r.S,"Math",{cbrt:function(e){return a(e=+e)*Math.pow(Math.abs(e),1/3)}})},function(e,t){e.exports=Math.sign||function(e){return 0==(e=+e)||e!=e?e:e<0?-1:1}},function(e,t,i){var r=i(6);r(r.S,"Math",{clz32:function(e){return(e>>>=0)?31-Math.floor(Math.log(e+.5)*Math.LOG2E):32}})},function(e,t,i){var r=i(6),a=Math.exp;r(r.S,"Math",{cosh:function(e){return(a(e=+e)+a(-e))/2}})},function(e,t,i){var r=i(6),a=i(110);r(r.S+r.F*(a!=Math.expm1),"Math",{expm1:a})},function(e,t){var i=Math.expm1;e.exports=!i||i(10)>22025.465794806718||i(10)<22025.465794806718||-2e-17!=i(-2e-17)?function(e){return 0==(e=+e)?e:e>-1e-6&&e<1e-6?e+e*e/2:Math.exp(e)-1}:i},function(e,t,i){var r=i(6),a=i(106),n=Math.pow,s=n(2,-52),o=n(2,-23),l=n(2,127)*(2-o),d=n(2,-126);r(r.S,"Math",{fround:function(e){var t,i,r=Math.abs(e),n=a(e);return r<d?n*function(e){return e+1/s-1/s}(r/d/o)*d*o:(i=(t=(1+o/s)*r)-(t-r))>l||i!=i?n*(1/0):n*i}})},function(e,t,i){var r=i(6),a=Math.abs;r(r.S,"Math",{hypot:function(e,t){for(var i,r,n=0,s=0,o=arguments.length,l=0;s<o;)l<(i=a(arguments[s++]))?(n=n*(r=l/i)*r+1,l=i):n+=i>0?(r=i/l)*r:i;return l===1/0?1/0:l*Math.sqrt(n)}})},function(e,t,i){var r=i(6),a=Math.imul;r(r.S+r.F*i(5)((function(){return-5!=a(4294967295,5)||2!=a.length})),"Math",{imul:function(e,t){var i=65535,r=+e,a=+t,n=i&r,s=i&a;return 0|n*s+((i&r>>>16)*s+n*(i&a>>>16)<<16>>>0)}})},function(e,t,i){var r=i(6);r(r.S,"Math",{log10:function(e){return Math.log(e)/Math.LN10}})},function(e,t,i){var r=i(6);r(r.S,"Math",{log1p:i(102)})},function(e,t,i){var r=i(6);r(r.S,"Math",{log2:function(e){return Math.log(e)/Math.LN2}})},function(e,t,i){var r=i(6);r(r.S,"Math",{sign:i(106)})},function(e,t,i){var r=i(6),a=i(110),n=Math.exp;r(r.S+r.F*i(5)((function(){return-2e-17!=!Math.sinh(-2e-17)})),"Math",{sinh:function(e){return Math.abs(e=+e)<1?(a(e)-a(-e))/2:(n(e-1)-n(-e-1))*(Math.E/2)}})},function(e,t,i){var r=i(6),a=i(110),n=Math.exp;r(r.S,"Math",{tanh:function(e){var t=a(e=+e),i=a(-e);return t==1/0?1:i==1/0?-1:(t-i)/(n(e)+n(-e))}})},function(e,t,i){var r=i(6);r(r.S,"Math",{trunc:function(e){return(e>0?Math.floor:Math.ceil)(e)}})},function(e,t,i){var r=i(6),a=i(37),n=String.fromCharCode,s=String.fromCodePoint;r(r.S+r.F*(!!s&&1!=s.length),"String",{fromCodePoint:function(e){for(var t,i=[],r=arguments.length,s=0;r>s;){if(t=+arguments[s++],a(t,1114111)!==t)throw RangeError(t+" is not a valid code point");i.push(t<65536?n(t):n(55296+((t-=65536)>>10),t%1024+56320))}return i.join("")}})},function(e,t,i){var r=i(6),a=i(30),n=i(35);r(r.S,"String",{raw:function(e){for(var t=a(e.raw),i=n(t.length),r=arguments.length,s=[],o=0;i>o;)s.push(String(t[o++])),o<r&&s.push(String(arguments[o]));return s.join("")}})},function(e,t,i){i(81)("trim",(function(e){return function(){return e(this,3)}}))},function(e,t,i){var r=i(6),a=i(125)(!1);r(r.P,"String",{codePointAt:function(e){return a(this,e)}})},function(e,t,r){var a=r(36),n=r(33);e.exports=function(e){return function(t,r){var s,o,l=String(n(t)),d=a(r),h=l.length;return d<0||d>=h?e?"":i:(s=l.charCodeAt(d))<55296||s>56319||d+1===h||(o=l.charCodeAt(d+1))<56320||o>57343?e?l.charAt(d):s:e?l.slice(d,d+2):o-56320+(s-55296<<10)+65536}}},function(e,t,r){var a=r(6),n=r(35),s=r(127),o="endsWith",l=""[o];a(a.P+a.F*r(129)(o),"String",{endsWith:function(e){var t=s(this,e,o),r=arguments.length>1?arguments[1]:i,a=n(t.length),d=r===i?a:Math.min(n(r),a),h=String(e);return l?l.call(t,h,d):t.slice(d-h.length,d)===h}})},function(e,t,i){var r=i(128),a=i(33);e.exports=function(e,t,i){if(r(t))throw TypeError("String#"+i+" doesn't accept regex!");return String(a(e))}},function(e,t,r){var a=r(11),n=r(32),s=r(23)("match");e.exports=function(e){var t;return a(e)&&((t=e[s])!==i?!!t:"RegExp"==n(e))}},function(e,t,i){var r=i(23)("match");e.exports=function(e){var t=/./;try{"/./"[e](t)}catch(i){try{return t[r]=!1,!"/./"[e](t)}catch(e){}}return!0}},function(e,t,r){var a=r(6),n=r(127),s="includes";a(a.P+a.F*r(129)(s),"String",{includes:function(e){return!!~n(this,e,s).indexOf(e,arguments.length>1?arguments[1]:i)}})},function(e,t,i){var r=i(6);r(r.P,"String",{repeat:i(85)})},function(e,t,r){var a=r(6),n=r(35),s=r(127),o="startsWith",l=""[o];a(a.P+a.F*r(129)(o),"String",{startsWith:function(e){var t=s(this,e,o),r=n(Math.min(arguments.length>1?arguments[1]:i,t.length)),a=String(e);return l?l.call(t,a,r):t.slice(r,r+a.length)===a}})},function(e,t,r){var a=r(125)(!0);r(134)(String,"String",(function(e){this._t=String(e),this._i=0}),(function(){var e,t=this._t,r=this._i;return r>=t.length?{value:i,done:!0}:(e=a(t,r),this._i+=e.length,{value:e,done:!1})}))},function(e,t,r){var a=r(26),n=r(6),s=r(16),o=r(8),l=r(3),d=r(135),h=r(136),c=r(22),u=r(57),p=r(23)("iterator"),m=!([].keys&&"next"in[].keys()),f="keys",g="values",v=function(){return this};e.exports=function(e,t,r,y,M,E,b){h(r,t,y);var I,x,T,_=function(e){if(!m&&e in R)return R[e];switch(e){case f:case g:return function(){return new r(this,e)}}return function(){return new r(this,e)}},S=t+" Iterator",C=M==g,w=!1,R=e.prototype,B=R[p]||R["@@iterator"]||M&&R[M],L=B||_(M),O=M?C?_("entries"):L:i,P="Array"==t&&R.entries||B;if(P&&(T=u(P.call(new e)))!==Object.prototype&&(c(T,S,!0),a||l(T,p)||o(T,p,v)),C&&B&&B.name!==g&&(w=!0,L=function(){return B.call(this)}),a&&!b||!m&&!w&&R[p]||o(R,p,L),d[t]=L,d[S]=v,M)if(I={values:C?L:_(g),keys:E?L:_(f),entries:O},b)for(x in I)x in R||s(R,x,I[x]);else n(n.P+n.F*(m||w),t,I);return I}},function(e,t){e.exports={}},function(e,t,i){var r=i(44),a=i(15),n=i(22),s={};i(8)(s,i(23)("iterator"),(function(){return this})),e.exports=function(e,t,i){e.prototype=r(s,{next:a(1,i)}),n(e,t+" Iterator")}},function(e,t,i){i(138)("anchor",(function(e){return function(t){return e(this,"a","name",t)}}))},function(e,t,i){var r=i(6),a=i(5),n=i(33),s=/"/g,o=function(e,t,i,r){var a=String(n(e)),o="<"+t;return""!==i&&(o+=" "+i+'="'+String(r).replace(s,"&quot;")+'"'),o+">"+a+"</"+t+">"};e.exports=function(e,t){var i={};i[e]=t(o),r(r.P+r.F*a((function(){var t=""[e]('"');return t!==t.toLowerCase()||t.split('"').length>3})),"String",i)}},function(e,t,i){i(138)("big",(function(e){return function(){return e(this,"big","","")}}))},function(e,t,i){i(138)("blink",(function(e){return function(){return e(this,"blink","","")}}))},function(e,t,i){i(138)("bold",(function(e){return function(){return e(this,"b","","")}}))},function(e,t,i){i(138)("fixed",(function(e){return function(){return e(this,"tt","","")}}))},function(e,t,i){i(138)("fontcolor",(function(e){return function(t){return e(this,"font","color",t)}}))},function(e,t,i){i(138)("fontsize",(function(e){return function(t){return e(this,"font","size",t)}}))},function(e,t,i){i(138)("italics",(function(e){return function(){return e(this,"i","","")}}))},function(e,t,i){i(138)("link",(function(e){return function(t){return e(this,"a","href",t)}}))},function(e,t,i){i(138)("small",(function(e){return function(){return e(this,"small","","")}}))},function(e,t,i){i(138)("strike",(function(e){return function(){return e(this,"strike","","")}}))},function(e,t,i){i(138)("sub",(function(e){return function(){return e(this,"sub","","")}}))},function(e,t,i){i(138)("sup",(function(e){return function(){return e(this,"sup","","")}}))},function(e,t,i){var r=i(6);r(r.S,"Array",{isArray:i(43)})},function(e,t,r){var a=r(18),n=r(6),s=r(56),o=r(153),l=r(154),d=r(35),h=r(155),c=r(156);n(n.S+n.F*!r(157)((function(e){})),"Array",{from:function(e){var t,r,n,u,p=s(e),m="function"==typeof this?this:Array,f=arguments.length,g=f>1?arguments[1]:i,v=g!==i,y=0,M=c(p);if(v&&(g=a(g,f>2?arguments[2]:i,2)),M==i||m==Array&&l(M))for(r=new m(t=d(p.length));t>y;y++)h(r,y,v?g(p[y],y):p[y]);else for(u=M.call(p),r=new m;!(n=u.next()).done;y++)h(r,y,v?o(u,g,[n.value,y],!0):n.value);return r.length=y,r}})},function(e,t,r){var a=r(10);e.exports=function(e,t,r,n){try{return n?t(a(r)[0],r[1]):t(r)}catch(t){var s=e.return;throw s!==i&&a(s.call(e)),t}}},function(e,t,r){var a=r(135),n=r(23)("iterator"),s=Array.prototype;e.exports=function(e){return e!==i&&(a.Array===e||s[n]===e)}},function(e,t,i){var r=i(9),a=i(15);e.exports=function(e,t,i){t in e?r.f(e,t,a(0,i)):e[t]=i}},function(e,t,r){var a=r(73),n=r(23)("iterator"),s=r(135);e.exports=r(7).getIteratorMethod=function(e){if(e!=i)return e[n]||e["@@iterator"]||s[a(e)]}},function(e,t,i){var r=i(23)("iterator"),a=!1;try{var n=[7][r]();n.return=function(){a=!0},Array.from(n,(function(){throw 2}))}catch(e){}e.exports=function(e,t){if(!t&&!a)return!1;var i=!1;try{var n=[7],s=n[r]();s.next=function(){return{done:i=!0}},n[r]=function(){return s},e(n)}catch(e){}return i}},function(e,t,i){var r=i(6),a=i(155);r(r.S+r.F*i(5)((function(){function e(){}return!(Array.of.call(e)instanceof e)})),"Array",{of:function(){for(var e=0,t=arguments.length,i=new("function"==typeof this?this:Array)(t);t>e;)a(i,e,arguments[e++]);return i.length=t,i}})},function(e,t,r){var a=r(6),n=r(30),s=[].join;a(a.P+a.F*(r(31)!=Object||!r(160)(s)),"Array",{join:function(e){return s.call(n(this),e===i?",":e)}})},function(e,t,i){var r=i(5);e.exports=function(e,t){return!!e&&r((function(){t?e.call(null,(function(){}),1):e.call(null)}))}},function(e,t,r){var a=r(6),n=r(46),s=r(32),o=r(37),l=r(35),d=[].slice;a(a.P+a.F*r(5)((function(){n&&d.call(n)})),"Array",{slice:function(e,t){var r=l(this.length),a=s(this);if(t=t===i?r:t,"Array"==a)return d.call(this,e,t);for(var n=o(e,r),h=o(t,r),c=l(h-n),u=Array(c),p=0;p<c;p++)u[p]="String"==a?this.charAt(n+p):this[n+p];return u}})},function(e,t,r){var a=r(6),n=r(19),s=r(56),o=r(5),l=[].sort,d=[1,2,3];a(a.P+a.F*(o((function(){d.sort(i)}))||!o((function(){d.sort(null)}))||!r(160)(l)),"Array",{sort:function(e){return e===i?l.call(s(this)):l.call(s(this),n(e))}})},function(e,t,i){var r=i(6),a=i(164)(0),n=i(160)([].forEach,!0);r(r.P+r.F*!n,"Array",{forEach:function(e){return a(this,e,arguments[1])}})},function(e,t,r){var a=r(18),n=r(31),s=r(56),o=r(35),l=r(165);e.exports=function(e,t){var r=1==e,d=2==e,h=3==e,c=4==e,u=6==e,p=5==e||u,m=t||l;return function(t,l,f){for(var g,v,y=s(t),M=n(y),E=a(l,f,3),b=o(M.length),I=0,x=r?m(t,b):d?m(t,0):i;b>I;I++)if((p||I in M)&&(v=E(g=M[I],I,y),e))if(r)x[I]=v;else if(v)switch(e){case 3:return!0;case 5:return g;case 6:return I;case 2:x.push(g)}else if(c)return!1;return u?-1:h||c?c:x}}},function(e,t,i){var r=i(166);e.exports=function(e,t){return new(r(e))(t)}},function(e,t,r){var a=r(11),n=r(43),s=r(23)("species");e.exports=function(e){var t;return n(e)&&("function"!=typeof(t=e.constructor)||t!==Array&&!n(t.prototype)||(t=i),a(t)&&null===(t=t[s])&&(t=i)),t===i?Array:t}},function(e,t,i){var r=i(6),a=i(164)(1);r(r.P+r.F*!i(160)([].map,!0),"Array",{map:function(e){return a(this,e,arguments[1])}})},function(e,t,i){var r=i(6),a=i(164)(2);r(r.P+r.F*!i(160)([].filter,!0),"Array",{filter:function(e){return a(this,e,arguments[1])}})},function(e,t,i){var r=i(6),a=i(164)(3);r(r.P+r.F*!i(160)([].some,!0),"Array",{some:function(e){return a(this,e,arguments[1])}})},function(e,t,i){var r=i(6),a=i(164)(4);r(r.P+r.F*!i(160)([].every,!0),"Array",{every:function(e){return a(this,e,arguments[1])}})},function(e,t,i){var r=i(6),a=i(172);r(r.P+r.F*!i(160)([].reduce,!0),"Array",{reduce:function(e){return a(this,e,arguments.length,arguments[1],!1)}})},function(e,t,i){var r=i(19),a=i(56),n=i(31),s=i(35);e.exports=function(e,t,i,o,l){r(t);var d=a(e),h=n(d),c=s(d.length),u=l?c-1:0,p=l?-1:1;if(i<2)for(;;){if(u in h){o=h[u],u+=p;break}if(u+=p,l?u<0:c<=u)throw TypeError("Reduce of empty array with no initial value")}for(;l?u>=0:c>u;u+=p)u in h&&(o=t(o,h[u],u,d));return o}},function(e,t,i){var r=i(6),a=i(172);r(r.P+r.F*!i(160)([].reduceRight,!0),"Array",{reduceRight:function(e){return a(this,e,arguments.length,arguments[1],!0)}})},function(e,t,i){var r=i(6),a=i(34)(!1),n=[].indexOf,s=!!n&&1/[1].indexOf(1,-0)<0;r(r.P+r.F*(s||!i(160)(n)),"Array",{indexOf:function(e){return s?n.apply(this,arguments)||0:a(this,e,arguments[1])}})},function(e,t,i){var r=i(6),a=i(30),n=i(36),s=i(35),o=[].lastIndexOf,l=!!o&&1/[1].lastIndexOf(1,-0)<0;r(r.P+r.F*(l||!i(160)(o)),"Array",{lastIndexOf:function(e){if(l)return o.apply(this,arguments)||0;var t=a(this),i=s(t.length),r=i-1;for(arguments.length>1&&(r=Math.min(r,n(arguments[1]))),r<0&&(r=i+r);r>=0;r--)if(r in t&&t[r]===e)return r||0;return-1}})},function(e,t,i){var r=i(6);r(r.P,"Array",{copyWithin:i(177)}),i(178)("copyWithin")},function(e,t,r){var a=r(56),n=r(37),s=r(35);e.exports=[].copyWithin||function(e,t){var r=a(this),o=s(r.length),l=n(e,o),d=n(t,o),h=arguments.length>2?arguments[2]:i,c=Math.min((h===i?o:n(h,o))-d,o-l),u=1;for(d<l&&l<d+c&&(u=-1,d+=c-1,l+=c-1);c-- >0;)d in r?r[l]=r[d]:delete r[l],l+=u,d+=u;return r}},function(e,t,r){var a=r(23)("unscopables"),n=Array.prototype;n[a]==i&&r(8)(n,a,{}),e.exports=function(e){n[a][e]=!0}},function(e,t,i){var r=i(6);r(r.P,"Array",{fill:i(180)}),i(178)("fill")},function(e,t,r){var a=r(56),n=r(37),s=r(35);e.exports=function(e){for(var t=a(this),r=s(t.length),o=arguments.length,l=n(o>1?arguments[1]:i,r),d=o>2?arguments[2]:i,h=d===i?r:n(d,r);h>l;)t[l++]=e;return t}},function(e,t,r){var a=r(6),n=r(164)(5),s="find",o=!0;s in[]&&Array(1)[s]((function(){o=!1})),a(a.P+a.F*o,"Array",{find:function(e){return n(this,e,arguments.length>1?arguments[1]:i)}}),r(178)(s)},function(e,t,r){var a=r(6),n=r(164)(6),s="findIndex",o=!0;s in[]&&Array(1)[s]((function(){o=!1})),a(a.P+a.F*o,"Array",{findIndex:function(e){return n(this,e,arguments.length>1?arguments[1]:i)}}),r(178)(s)},function(e,t,r){var a=r(178),n=r(184),s=r(135),o=r(30);e.exports=r(134)(Array,"Array",(function(e,t){this._t=o(e),this._i=0,this._k=t}),(function(){var e=this._t,t=this._k,r=this._i++;return!e||r>=e.length?(this._t=i,n(1)):n(0,"keys"==t?r:"values"==t?e[r]:[r,e[r]])}),"values"),s.Arguments=s.Array,a("keys"),a("values"),a("entries")},function(e,t){e.exports=function(e,t){return{value:t,done:!!e}}},function(e,t,i){i(186)("Array")},function(e,t,i){var r=i(2),a=i(9),n=i(4),s=i(23)("species");e.exports=function(e){var t=r[e];n&&t&&!t[s]&&a.f(t,s,{configurable:!0,get:function(){return this}})}},function(e,t,r){var a=r(2),n=r(80),s=r(9).f,o=r(48).f,l=r(128),d=r(188),h=a.RegExp,c=h,u=h.prototype,p=/a/g,m=/a/g,f=new h(p)!==p;if(r(4)&&(!f||r(5)((function(){return m[r(23)("match")]=!1,h(p)!=p||h(m)==m||"/a/i"!=h(p,"i")})))){h=function(e,t){var r=this instanceof h,a=l(e),s=t===i;return!r&&a&&e.constructor===h&&s?e:n(f?new c(a&&!s?e.source:e,t):c((a=e instanceof h)?e.source:e,a&&s?d.call(e):t),r?this:u,h)};for(var g=function(e){e in h||s(h,e,{configurable:!0,get:function(){return c[e]},set:function(t){c[e]=t}})},v=o(c),y=0;v.length>y;)g(v[y++]);u.constructor=h,h.prototype=u,r(16)(a,"RegExp",h)}r(186)("RegExp")},function(e,t,i){var r=i(10);e.exports=function(){var e=r(this),t="";return e.global&&(t+="g"),e.ignoreCase&&(t+="i"),e.multiline&&(t+="m"),e.unicode&&(t+="u"),e.sticky&&(t+="y"),t}},function(e,t,r){r(190);var a=r(10),n=r(188),s=r(4),o="toString",l=/./[o],d=function(e){r(16)(RegExp.prototype,o,e,!0)};r(5)((function(){return"/a/b"!=l.call({source:"a",flags:"b"})}))?d((function(){var e=a(this);return"/".concat(e.source,"/","flags"in e?e.flags:!s&&e instanceof RegExp?n.call(e):i)})):l.name!=o&&d((function(){return l.call(this)}))},function(e,t,i){i(4)&&"g"!=/./g.flags&&i(9).f(RegExp.prototype,"flags",{configurable:!0,get:i(188)})},function(e,t,r){r(192)("match",1,(function(e,t,r){return[function(r){var a=e(this),n=r==i?i:r[t];return n!==i?n.call(r,a):new RegExp(r)[t](String(a))},r]}))},function(e,t,i){var r=i(8),a=i(16),n=i(5),s=i(33),o=i(23);e.exports=function(e,t,i){var l=o(e),d=i(s,l,""[e]),h=d[0],c=d[1];n((function(){var t={};return t[l]=function(){return 7},7!=""[e](t)}))&&(a(String.prototype,e,h),r(RegExp.prototype,l,2==t?function(e,t){return c.call(e,this,t)}:function(e){return c.call(e,this)}))}},function(e,t,r){r(192)("replace",2,(function(e,t,r){return[function(a,n){var s=e(this),o=a==i?i:a[t];return o!==i?o.call(a,s,n):r.call(String(s),a,n)},r]}))},function(e,t,r){r(192)("search",1,(function(e,t,r){return[function(r){var a=e(this),n=r==i?i:r[t];return n!==i?n.call(r,a):new RegExp(r)[t](String(a))},r]}))},function(e,t,r){r(192)("split",2,(function(e,t,a){var n=r(128),s=a,o=[].push,l="split",d="length",h="lastIndex";if("c"=="abbc"[l](/(b)*/)[1]||4!="test"[l](/(?:)/,-1)[d]||2!="ab"[l](/(?:ab)*/)[d]||4!="."[l](/(.?)(.?)/)[d]||"."[l](/()()/)[d]>1||""[l](/.?/)[d]){var c=/()??/.exec("")[1]===i;a=function(e,t){var r=String(this);if(e===i&&0===t)return[];if(!n(e))return s.call(r,e,t);var a,l,u,p,m,f=[],g=(e.ignoreCase?"i":"")+(e.multiline?"m":"")+(e.unicode?"u":"")+(e.sticky?"y":""),v=0,y=t===i?4294967295:t>>>0,M=new RegExp(e.source,g+"g");for(c||(a=new RegExp("^"+M.source+"$(?!\\s)",g));(l=M.exec(r))&&!((u=l.index+l[0][d])>v&&(f.push(r.slice(v,l.index)),!c&&l[d]>1&&l[0].replace(a,(function(){for(m=1;m<arguments[d]-2;m++)arguments[m]===i&&(l[m]=i)})),l[d]>1&&l.index<r[d]&&o.apply(f,l.slice(1)),p=l[0][d],v=u,f[d]>=y));)M[h]===l.index&&M[h]++;return v===r[d]?!p&&M.test("")||f.push(""):f.push(r.slice(v)),f[d]>y?f.slice(0,y):f}}else"0"[l](i,0)[d]&&(a=function(e,t){return e===i&&0===t?[]:s.call(this,e,t)});return[function(r,n){var s=e(this),o=r==i?i:r[t];return o!==i?o.call(r,s,n):a.call(String(s),r,n)},a]}))},function(e,t,r){var a,n,s,o=r(26),l=r(2),d=r(18),h=r(73),c=r(6),u=r(11),p=r(19),m=r(197),f=r(198),g=r(199),v=r(200).set,y=r(201)(),M="Promise",E=l.TypeError,b=l.process,I=l[M],x="process"==h(b=l.process),T=function(){},_=!!function(){try{var e=I.resolve(1),t=(e.constructor={})[r(23)("species")]=function(e){e(T,T)};return(x||"function"==typeof PromiseRejectionEvent)&&e.then(T)instanceof t}catch(e){}}(),S=function(e,t){return e===t||e===I&&t===s},C=function(e){var t;return!(!u(e)||"function"!=typeof(t=e.then))&&t},w=function(e){return S(I,e)?new R(e):new n(e)},R=n=function(e){var t,r;this.promise=new e((function(e,a){if(t!==i||r!==i)throw E("Bad Promise constructor");t=e,r=a})),this.resolve=p(t),this.reject=p(r)},B=function(e){try{e()}catch(e){return{error:e}}},L=function(e,t){if(!e._n){e._n=!0;var i=e._c;y((function(){for(var r=e._v,a=1==e._s,n=0,s=function(t){var i,n,s=a?t.ok:t.fail,o=t.resolve,l=t.reject,d=t.domain;try{s?(a||(2==e._h&&D(e),e._h=1),!0===s?i=r:(d&&d.enter(),i=s(r),d&&d.exit()),i===t.promise?l(E("Promise-chain cycle")):(n=C(i))?n.call(i,o,l):o(i)):l(r)}catch(e){l(e)}};i.length>n;)s(i[n++]);e._c=[],e._n=!1,t&&!e._h&&O(e)}))}},O=function(e){v.call(l,(function(){var t,r,a,n=e._v;if(P(e)&&(t=B((function(){x?b.emit("unhandledRejection",n,e):(r=l.onunhandledrejection)?r({promise:e,reason:n}):(a=l.console)&&a.error&&a.error("Unhandled promise rejection",n)})),e._h=x||P(e)?2:1),e._a=i,t)throw t.error}))},P=function(e){if(1==e._h)return!1;for(var t,i=e._a||e._c,r=0;i.length>r;)if((t=i[r++]).fail||!P(t.promise))return!1;return!0},D=function(e){v.call(l,(function(){var t;x?b.emit("rejectionHandled",e):(t=l.onrejectionhandled)&&t({promise:e,reason:e._v})}))},A=function(e){var t=this;t._d||(t._d=!0,(t=t._w||t)._v=e,t._s=2,t._a||(t._a=t._c.slice()),L(t,!0))},N=function(e){var t,i=this;if(!i._d){i._d=!0,i=i._w||i;try{if(i===e)throw E("Promise can't be resolved itself");(t=C(e))?y((function(){var r={_w:i,_d:!1};try{t.call(e,d(N,r,1),d(A,r,1))}catch(e){A.call(r,e)}})):(i._v=e,i._s=1,L(i,!1))}catch(e){A.call({_w:i,_d:!1},e)}}};_||(I=function(e){m(this,I,M,"_h"),p(e),a.call(this);try{e(d(N,this,1),d(A,this,1))}catch(e){A.call(this,e)}},(a=function(e){this._c=[],this._a=i,this._s=0,this._d=!1,this._v=i,this._h=0,this._n=!1}).prototype=r(202)(I.prototype,{then:function(e,t){var r=w(g(this,I));return r.ok="function"!=typeof e||e,r.fail="function"==typeof t&&t,r.domain=x?b.domain:i,this._c.push(r),this._a&&this._a.push(r),this._s&&L(this,!1),r.promise},catch:function(e){return this.then(i,e)}}),R=function(){var e=new a;this.promise=e,this.resolve=d(N,e,1),this.reject=d(A,e,1)}),c(c.G+c.W+c.F*!_,{Promise:I}),r(22)(I,M),r(186)(M),s=r(7)[M],c(c.S+c.F*!_,M,{reject:function(e){var t=w(this);return(0,t.reject)(e),t.promise}}),c(c.S+c.F*(o||!_),M,{resolve:function(e){if(e instanceof I&&S(e.constructor,this))return e;var t=w(this);return(0,t.resolve)(e),t.promise}}),c(c.S+c.F*!(_&&r(157)((function(e){I.all(e).catch(T)}))),M,{all:function(e){var t=this,r=w(t),a=r.resolve,n=r.reject,s=B((function(){var r=[],s=0,o=1;f(e,!1,(function(e){var l=s++,d=!1;r.push(i),o++,t.resolve(e).then((function(e){d||(d=!0,r[l]=e,--o||a(r))}),n)})),--o||a(r)}));return s&&n(s.error),r.promise},race:function(e){var t=this,i=w(t),r=i.reject,a=B((function(){f(e,!1,(function(e){t.resolve(e).then(i.resolve,r)}))}));return a&&r(a.error),i.promise}})},function(e,t){e.exports=function(e,t,r,a){if(!(e instanceof t)||a!==i&&a in e)throw TypeError(r+": incorrect invocation!");return e}},function(e,t,i){var r=i(18),a=i(153),n=i(154),s=i(10),o=i(35),l=i(156),d={},h={};t=e.exports=function(e,t,i,c,u){var p,m,f,g,v=u?function(){return e}:l(e),y=r(i,c,t?2:1),M=0;if("function"!=typeof v)throw TypeError(e+" is not iterable!");if(n(v)){for(p=o(e.length);p>M;M++)if((g=t?y(s(m=e[M])[0],m[1]):y(e[M]))===d||g===h)return g}else for(f=v.call(e);!(m=f.next()).done;)if((g=a(f,y,m.value,t))===d||g===h)return g},t.BREAK=d,t.RETURN=h},function(e,t,r){var a=r(10),n=r(19),s=r(23)("species");e.exports=function(e,t){var r,o=a(e).constructor;return o===i||(r=a(o)[s])==i?t:n(r)}},function(e,t,i){var r,a,n,s=i(18),o=i(76),l=i(46),d=i(13),h=i(2),c=h.process,u=h.setImmediate,p=h.clearImmediate,m=h.MessageChannel,f=0,g={},v="onreadystatechange",y=function(){var e=+this;if(g.hasOwnProperty(e)){var t=g[e];delete g[e],t()}},M=function(e){y.call(e.data)};u&&p||(u=function(e){for(var t=[],i=1;arguments.length>i;)t.push(arguments[i++]);return g[++f]=function(){o("function"==typeof e?e:Function(e),t)},r(f),f},p=function(e){delete g[e]},"process"==i(32)(c)?r=function(e){c.nextTick(s(y,e,1))}:m?(n=(a=new m).port2,a.port1.onmessage=M,r=s(n.postMessage,n,1)):h.addEventListener&&"function"==typeof postMessage&&!h.importScripts?(r=function(e){h.postMessage(e+"","*")},h.addEventListener("message",M,!1)):r=v in d("script")?function(e){l.appendChild(d("script"))[v]=function(){l.removeChild(this),y.call(e)}}:function(e){setTimeout(s(y,e,1),0)}),e.exports={set:u,clear:p}},function(e,t,r){var a=r(2),n=r(200).set,s=a.MutationObserver||a.WebKitMutationObserver,o=a.process,l=a.Promise,d="process"==r(32)(o);e.exports=function(){var e,t,r,h=function(){var a,n;for(d&&(a=o.domain)&&a.exit();e;){n=e.fn,e=e.next;try{n()}catch(a){throw e?r():t=i,a}}t=i,a&&a.enter()};if(d)r=function(){o.nextTick(h)};else if(s){var c=!0,u=document.createTextNode("");new s(h).observe(u,{characterData:!0}),r=function(){u.data=c=!c}}else if(l&&l.resolve){var p=l.resolve();r=function(){p.then(h)}}else r=function(){n.call(a,h)};return function(a){var n={fn:a,next:i};t&&(t.next=n),e||(e=n,r()),t=n}}},function(e,t,i){var r=i(16);e.exports=function(e,t,i){for(var a in t)r(e,a,t[a],i);return e}},function(e,t,r){var a=r(204);e.exports=r(205)("Map",(function(e){return function(){return e(this,arguments.length>0?arguments[0]:i)}}),{get:function(e){var t=a.getEntry(this,e);return t&&t.v},set:function(e,t){return a.def(this,0===e?0:e,t)}},a,!0)},function(e,t,r){var a=r(9).f,n=r(44),s=r(202),o=r(18),l=r(197),d=r(33),h=r(198),c=r(134),u=r(184),p=r(186),m=r(4),f=r(20).fastKey,g=m?"_s":"size",v=function(e,t){var i,r=f(t);if("F"!==r)return e._i[r];for(i=e._f;i;i=i.n)if(i.k==t)return i};e.exports={getConstructor:function(e,t,r,c){var u=e((function(e,a){l(e,u,t,"_i"),e._i=n(null),e._f=i,e._l=i,e[g]=0,a!=i&&h(a,r,e[c],e)}));return s(u.prototype,{clear:function(){for(var e=this,t=e._i,r=e._f;r;r=r.n)r.r=!0,r.p&&(r.p=r.p.n=i),delete t[r.i];e._f=e._l=i,e[g]=0},delete:function(e){var t=this,i=v(t,e);if(i){var r=i.n,a=i.p;delete t._i[i.i],i.r=!0,a&&(a.n=r),r&&(r.p=a),t._f==i&&(t._f=r),t._l==i&&(t._l=a),t[g]--}return!!i},forEach:function(e){l(this,u,"forEach");for(var t,r=o(e,arguments.length>1?arguments[1]:i,3);t=t?t.n:this._f;)for(r(t.v,t.k,this);t&&t.r;)t=t.p},has:function(e){return!!v(this,e)}}),m&&a(u.prototype,"size",{get:function(){return d(this[g])}}),u},def:function(e,t,r){var a,n,s=v(e,t);return s?s.v=r:(e._l=s={i:n=f(t,!0),k:t,v:r,p:a=e._l,n:i,r:!1},e._f||(e._f=s),a&&(a.n=s),e[g]++,"F"!==n&&(e._i[n]=s)),e},getEntry:v,setStrong:function(e,t,r){c(e,t,(function(e,t){this._t=e,this._k=t,this._l=i}),(function(){for(var e=this,t=e._k,r=e._l;r&&r.r;)r=r.p;return e._t&&(e._l=r=r?r.n:e._t._f)?u(0,"keys"==t?r.k:"values"==t?r.v:[r.k,r.v]):(e._t=i,u(1))}),r?"entries":"values",!r,!0),p(t)}}},function(e,t,r){var a=r(2),n=r(6),s=r(16),o=r(202),l=r(20),d=r(198),h=r(197),c=r(11),u=r(5),p=r(157),m=r(22),f=r(80);e.exports=function(e,t,r,g,v,y){var M=a[e],E=M,b=v?"set":"add",I=E&&E.prototype,x={},T=function(e){var t=I[e];s(I,e,"delete"==e||"has"==e?function(e){return!(y&&!c(e))&&t.call(this,0===e?0:e)}:"get"==e?function(e){return y&&!c(e)?i:t.call(this,0===e?0:e)}:"add"==e?function(e){return t.call(this,0===e?0:e),this}:function(e,i){return t.call(this,0===e?0:e,i),this})};if("function"==typeof E&&(y||I.forEach&&!u((function(){(new E).entries().next()})))){var _=new E,S=_[b](y?{}:-0,1)!=_,C=u((function(){_.has(1)})),w=p((function(e){new E(e)})),R=!y&&u((function(){for(var e=new E,t=5;t--;)e[b](t,t);return!e.has(-0)}));w||(E=t((function(t,r){h(t,E,e);var a=f(new M,t,E);return r!=i&&d(r,v,a[b],a),a})),E.prototype=I,I.constructor=E),(C||R)&&(T("delete"),T("has"),v&&T("get")),(R||S)&&T(b),y&&I.clear&&delete I.clear}else E=g.getConstructor(t,e,v,b),o(E.prototype,r),l.NEED=!0;return m(E,e),x[e]=E,n(n.G+n.W+n.F*(E!=M),x),y||g.setStrong(E,e,v),E}},function(e,t,r){var a=r(204);e.exports=r(205)("Set",(function(e){return function(){return e(this,arguments.length>0?arguments[0]:i)}}),{add:function(e){return a.def(this,e=0===e?0:e,e)}},a)},function(e,t,r){var a,n=r(164)(0),s=r(16),o=r(20),l=r(67),d=r(208),h=r(11),c=o.getWeak,u=Object.isExtensible,p=d.ufstore,m={},f=function(e){return function(){return e(this,arguments.length>0?arguments[0]:i)}},g={get:function(e){if(h(e)){var t=c(e);return!0===t?p(this).get(e):t?t[this._i]:i}},set:function(e,t){return d.def(this,e,t)}},v=e.exports=r(205)("WeakMap",f,g,d,!0,!0);7!=(new v).set((Object.freeze||Object)(m),7).get(m)&&(l((a=d.getConstructor(f)).prototype,g),o.NEED=!0,n(["delete","has","get","set"],(function(e){var t=v.prototype,i=t[e];s(t,e,(function(t,r){if(h(t)&&!u(t)){this._f||(this._f=new a);var n=this._f[e](t,r);return"set"==e?this:n}return i.call(this,t,r)}))})))},function(e,t,r){var a=r(202),n=r(20).getWeak,s=r(10),o=r(11),l=r(197),d=r(198),h=r(164),c=r(3),u=h(5),p=h(6),m=0,f=function(e){return e._l||(e._l=new g)},g=function(){this.a=[]},v=function(e,t){return u(e.a,(function(e){return e[0]===t}))};g.prototype={get:function(e){var t=v(this,e);if(t)return t[1]},has:function(e){return!!v(this,e)},set:function(e,t){var i=v(this,e);i?i[1]=t:this.a.push([e,t])},delete:function(e){var t=p(this.a,(function(t){return t[0]===e}));return~t&&this.a.splice(t,1),!!~t}},e.exports={getConstructor:function(e,t,r,s){var h=e((function(e,a){l(e,h,t,"_i"),e._i=m++,e._l=i,a!=i&&d(a,r,e[s],e)}));return a(h.prototype,{delete:function(e){if(!o(e))return!1;var t=n(e);return!0===t?f(this).delete(e):t&&c(t,this._i)&&delete t[this._i]},has:function(e){if(!o(e))return!1;var t=n(e);return!0===t?f(this).has(e):t&&c(t,this._i)}}),h},def:function(e,t,i){var r=n(s(t),!0);return!0===r?f(e).set(t,i):r[e._i]=i,e},ufstore:f}},function(e,t,r){var a=r(208);r(205)("WeakSet",(function(e){return function(){return e(this,arguments.length>0?arguments[0]:i)}}),{add:function(e){return a.def(this,e,!0)}},a,!1,!0)},function(e,t,i){var r=i(6),a=i(19),n=i(10),s=(i(2).Reflect||{}).apply,o=Function.apply;r(r.S+r.F*!i(5)((function(){s((function(){}))})),"Reflect",{apply:function(e,t,i){var r=a(e),l=n(i);return s?s(r,t,l):o.call(r,t,l)}})},function(e,t,i){var r=i(6),a=i(44),n=i(19),s=i(10),o=i(11),l=i(5),d=i(75),h=(i(2).Reflect||{}).construct,c=l((function(){function e(){}return!(h((function(){}),[],e)instanceof e)})),u=!l((function(){h((function(){}))}));r(r.S+r.F*(c||u),"Reflect",{construct:function(e,t){n(e),s(t);var i=arguments.length<3?e:n(arguments[2]);if(u&&!c)return h(e,t,i);if(e==i){switch(t.length){case 0:return new e;case 1:return new e(t[0]);case 2:return new e(t[0],t[1]);case 3:return new e(t[0],t[1],t[2]);case 4:return new e(t[0],t[1],t[2],t[3])}var r=[null];return r.push.apply(r,t),new(d.apply(e,r))}var l=i.prototype,p=a(o(l)?l:Object.prototype),m=Function.apply.call(e,p,t);return o(m)?m:p}})},function(e,t,i){var r=i(9),a=i(6),n=i(10),s=i(14);a(a.S+a.F*i(5)((function(){Reflect.defineProperty(r.f({},1,{value:1}),1,{value:2})})),"Reflect",{defineProperty:function(e,t,i){n(e),t=s(t,!0),n(i);try{return r.f(e,t,i),!0}catch(e){return!1}}})},function(e,t,i){var r=i(6),a=i(49).f,n=i(10);r(r.S,"Reflect",{deleteProperty:function(e,t){var i=a(n(e),t);return!(i&&!i.configurable)&&delete e[t]}})},function(e,t,r){var a=r(6),n=r(10),s=function(e){this._t=n(e),this._i=0;var t,i=this._k=[];for(t in e)i.push(t)};r(136)(s,"Object",(function(){var e,t=this,r=t._k;do{if(t._i>=r.length)return{value:i,done:!0}}while(!((e=r[t._i++])in t._t));return{value:e,done:!1}})),a(a.S,"Reflect",{enumerate:function(e){return new s(e)}})},function(e,t,r){var a=r(49),n=r(57),s=r(3),o=r(6),l=r(11),d=r(10);o(o.S,"Reflect",{get:function e(t,r){var o,h,c=arguments.length<3?t:arguments[2];return d(t)===c?t[r]:(o=a.f(t,r))?s(o,"value")?o.value:o.get!==i?o.get.call(c):i:l(h=n(t))?e(h,r,c):void 0}})},function(e,t,i){var r=i(49),a=i(6),n=i(10);a(a.S,"Reflect",{getOwnPropertyDescriptor:function(e,t){return r.f(n(e),t)}})},function(e,t,i){var r=i(6),a=i(57),n=i(10);r(r.S,"Reflect",{getPrototypeOf:function(e){return a(n(e))}})},function(e,t,i){var r=i(6);r(r.S,"Reflect",{has:function(e,t){return t in e}})},function(e,t,i){var r=i(6),a=i(10),n=Object.isExtensible;r(r.S,"Reflect",{isExtensible:function(e){return a(e),!n||n(e)}})},function(e,t,i){var r=i(6);r(r.S,"Reflect",{ownKeys:i(221)})},function(e,t,i){var r=i(48),a=i(41),n=i(10),s=i(2).Reflect;e.exports=s&&s.ownKeys||function(e){var t=r.f(n(e)),i=a.f;return i?t.concat(i(e)):t}},function(e,t,i){var r=i(6),a=i(10),n=Object.preventExtensions;r(r.S,"Reflect",{preventExtensions:function(e){a(e);try{return n&&n(e),!0}catch(e){return!1}}})},function(e,t,r){var a=r(9),n=r(49),s=r(57),o=r(3),l=r(6),d=r(15),h=r(10),c=r(11);l(l.S,"Reflect",{set:function e(t,r,l){var u,p,m=arguments.length<4?t:arguments[3],f=n.f(h(t),r);if(!f){if(c(p=s(t)))return e(p,r,l,m);f=d(0)}return o(f,"value")?!(!1===f.writable||!c(m)||(u=n.f(m,r)||d(0),u.value=l,a.f(m,r,u),0)):f.set!==i&&(f.set.call(m,l),!0)}})},function(e,t,i){var r=i(6),a=i(71);a&&r(r.S,"Reflect",{setPrototypeOf:function(e,t){a.check(e,t);try{return a.set(e,t),!0}catch(e){return!1}}})},function(e,t,i){var r=i(6);r(r.S,"Date",{now:function(){return(new Date).getTime()}})},function(e,t,i){var r=i(6),a=i(56),n=i(14);r(r.P+r.F*i(5)((function(){return null!==new Date(NaN).toJSON()||1!==Date.prototype.toJSON.call({toISOString:function(){return 1}})})),"Date",{toJSON:function(e){var t=a(this),i=n(t);return"number"!=typeof i||isFinite(i)?t.toISOString():null}})},function(e,t,i){var r=i(6),a=i(5),n=Date.prototype.getTime,s=function(e){return e>9?e:"0"+e};r(r.P+r.F*(a((function(){return"0385-07-25T07:06:39.999Z"!=new Date(-50000000000001).toISOString()}))||!a((function(){new Date(NaN).toISOString()}))),"Date",{toISOString:function(){if(!isFinite(n.call(this)))throw RangeError("Invalid time value");var e=this,t=e.getUTCFullYear(),i=e.getUTCMilliseconds(),r=t<0?"-":t>9999?"+":"";return r+("00000"+Math.abs(t)).slice(r?-6:-4)+"-"+s(e.getUTCMonth()+1)+"-"+s(e.getUTCDate())+"T"+s(e.getUTCHours())+":"+s(e.getUTCMinutes())+":"+s(e.getUTCSeconds())+"."+(i>99?i:"0"+s(i))+"Z"}})},function(e,t,i){var r=Date.prototype,a="Invalid Date",n="toString",s=r[n],o=r.getTime;new Date(NaN)+""!=a&&i(16)(r,n,(function(){var e=o.call(this);return e==e?s.call(this):a}))},function(e,t,i){var r=i(23)("toPrimitive"),a=Date.prototype;r in a||i(8)(a,r,i(230))},function(e,t,i){var r=i(10),a=i(14),n="number";e.exports=function(e){if("string"!==e&&e!==n&&"default"!==e)throw TypeError("Incorrect hint");return a(r(this),e!=n)}},function(e,t,r){var a=r(6),n=r(232),s=r(233),o=r(10),l=r(37),d=r(35),h=r(11),c=r(2).ArrayBuffer,u=r(199),p=s.ArrayBuffer,m=s.DataView,f=n.ABV&&c.isView,g=p.prototype.slice,v=n.VIEW,y="ArrayBuffer";a(a.G+a.W+a.F*(c!==p),{ArrayBuffer:p}),a(a.S+a.F*!n.CONSTR,y,{isView:function(e){return f&&f(e)||h(e)&&v in e}}),a(a.P+a.U+a.F*r(5)((function(){return!new p(2).slice(1,i).byteLength})),y,{slice:function(e,t){if(g!==i&&t===i)return g.call(o(this),e);for(var r=o(this).byteLength,a=l(e,r),n=l(t===i?r:t,r),s=new(u(this,p))(d(n-a)),h=new m(this),c=new m(s),f=0;a<n;)c.setUint8(f++,h.getUint8(a++));return s}}),r(186)(y)},function(e,t,i){for(var r,a=i(2),n=i(8),s=i(17),o=s("typed_array"),l=s("view"),d=!(!a.ArrayBuffer||!a.DataView),h=d,c=0,u="Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array".split(",");c<9;)(r=a[u[c++]])?(n(r.prototype,o,!0),n(r.prototype,l,!0)):h=!1;e.exports={ABV:d,CONSTR:h,TYPED:o,VIEW:l}},function(e,t,r){var a=r(2),n=r(4),s=r(26),o=r(232),l=r(8),d=r(202),h=r(5),c=r(197),u=r(36),p=r(35),m=r(48).f,f=r(9).f,g=r(180),v=r(22),y="ArrayBuffer",M="DataView",E="prototype",b="Wrong length!",I="Wrong index!",x=a[y],T=a[M],_=a.Math,S=a.RangeError,C=a.Infinity,w=x,R=_.abs,B=_.pow,L=_.floor,O=_.log,P=_.LN2,D="buffer",A="byteLength",N="byteOffset",H=n?"_b":D,U=n?"_l":A,F=n?"_o":N,k=function(e,t,i){var r,a,n,s=Array(i),o=8*i-t-1,l=(1<<o)-1,d=l>>1,h=23===t?B(2,-24)-B(2,-77):0,c=0,u=e<0||0===e&&1/e<0?1:0;for((e=R(e))!=e||e===C?(a=e!=e?1:0,r=l):(r=L(O(e)/P),e*(n=B(2,-r))<1&&(r--,n*=2),(e+=r+d>=1?h/n:h*B(2,1-d))*n>=2&&(r++,n/=2),r+d>=l?(a=0,r=l):r+d>=1?(a=(e*n-1)*B(2,t),r+=d):(a=e*B(2,d-1)*B(2,t),r=0));t>=8;s[c++]=255&a,a/=256,t-=8);for(r=r<<t|a,o+=t;o>0;s[c++]=255&r,r/=256,o-=8);return s[--c]|=128*u,s},G=function(e,t,i){var r,a=8*i-t-1,n=(1<<a)-1,s=n>>1,o=a-7,l=i-1,d=e[l--],h=127&d;for(d>>=7;o>0;h=256*h+e[l],l--,o-=8);for(r=h&(1<<-o)-1,h>>=-o,o+=t;o>0;r=256*r+e[l],l--,o-=8);if(0===h)h=1-s;else{if(h===n)return r?NaN:d?-C:C;r+=B(2,t),h-=s}return(d?-1:1)*r*B(2,h-t)},V=function(e){return e[3]<<24|e[2]<<16|e[1]<<8|e[0]},j=function(e){return[255&e]},z=function(e){return[255&e,e>>8&255]},W=function(e){return[255&e,e>>8&255,e>>16&255,e>>24&255]},q=function(e){return k(e,52,8)},X=function(e){return k(e,23,4)},Y=function(e,t,i){f(e[E],t,{get:function(){return this[i]}})},K=function(e,t,i,r){var a=+i,n=u(a);if(a!=n||n<0||n+t>e[U])throw S(I);var s=e[H]._b,o=n+e[F],l=s.slice(o,o+t);return r?l:l.reverse()},Z=function(e,t,i,r,a,n){var s=+i,o=u(s);if(s!=o||o<0||o+t>e[U])throw S(I);for(var l=e[H]._b,d=o+e[F],h=r(+a),c=0;c<t;c++)l[d+c]=h[n?c:t-c-1]},$=function(e,t){c(e,x,y);var i=+t,r=p(i);if(i!=r)throw S(b);return r};if(o.ABV){if(!h((function(){new x}))||!h((function(){new x(.5)}))){x=function(e){return new w($(this,e))};for(var Q,J=x[E]=w[E],ee=m(w),te=0;ee.length>te;)(Q=ee[te++])in x||l(x,Q,w[Q]);s||(J.constructor=x)}var ie=new T(new x(2)),re=T[E].setInt8;ie.setInt8(0,2147483648),ie.setInt8(1,2147483649),!ie.getInt8(0)&&ie.getInt8(1)||d(T[E],{setInt8:function(e,t){re.call(this,e,t<<24>>24)},setUint8:function(e,t){re.call(this,e,t<<24>>24)}},!0)}else x=function(e){var t=$(this,e);this._b=g.call(Array(t),0),this[U]=t},T=function(e,t,r){c(this,T,M),c(e,x,M);var a=e[U],n=u(t);if(n<0||n>a)throw S("Wrong offset!");if(n+(r=r===i?a-n:p(r))>a)throw S(b);this[H]=e,this[F]=n,this[U]=r},n&&(Y(x,A,"_l"),Y(T,D,"_b"),Y(T,A,"_l"),Y(T,N,"_o")),d(T[E],{getInt8:function(e){return K(this,1,e)[0]<<24>>24},getUint8:function(e){return K(this,1,e)[0]},getInt16:function(e){var t=K(this,2,e,arguments[1]);return(t[1]<<8|t[0])<<16>>16},getUint16:function(e){var t=K(this,2,e,arguments[1]);return t[1]<<8|t[0]},getInt32:function(e){return V(K(this,4,e,arguments[1]))},getUint32:function(e){return V(K(this,4,e,arguments[1]))>>>0},getFloat32:function(e){return G(K(this,4,e,arguments[1]),23,4)},getFloat64:function(e){return G(K(this,8,e,arguments[1]),52,8)},setInt8:function(e,t){Z(this,1,e,j,t)},setUint8:function(e,t){Z(this,1,e,j,t)},setInt16:function(e,t){Z(this,2,e,z,t,arguments[2])},setUint16:function(e,t){Z(this,2,e,z,t,arguments[2])},setInt32:function(e,t){Z(this,4,e,W,t,arguments[2])},setUint32:function(e,t){Z(this,4,e,W,t,arguments[2])},setFloat32:function(e,t){Z(this,4,e,X,t,arguments[2])},setFloat64:function(e,t){Z(this,8,e,q,t,arguments[2])}});v(x,y),v(T,M),l(T[E],o.VIEW,!0),t[y]=x,t[M]=T},function(e,t,i){var r=i(6);r(r.G+r.W+r.F*!i(232).ABV,{DataView:i(233).DataView})},function(e,t,i){i(236)("Int8",1,(function(e){return function(t,i,r){return e(this,t,i,r)}}))},function(e,t,r){if(r(4)){var a=r(26),n=r(2),s=r(5),o=r(6),l=r(232),d=r(233),h=r(18),c=r(197),u=r(15),p=r(8),m=r(202),f=r(36),g=r(35),v=r(37),y=r(14),M=r(3),E=r(69),b=r(73),I=r(11),x=r(56),T=r(154),_=r(44),S=r(57),C=r(48).f,w=r(156),R=r(17),B=r(23),L=r(164),O=r(34),P=r(199),D=r(183),A=r(135),N=r(157),H=r(186),U=r(180),F=r(177),k=r(9),G=r(49),V=k.f,j=G.f,z=n.RangeError,W=n.TypeError,q=n.Uint8Array,X="ArrayBuffer",Y="Shared"+X,K="BYTES_PER_ELEMENT",Z="prototype",$=Array[Z],Q=d.ArrayBuffer,J=d.DataView,ee=L(0),te=L(2),ie=L(3),re=L(4),ae=L(5),ne=L(6),se=O(!0),oe=O(!1),le=D.values,de=D.keys,he=D.entries,ce=$.lastIndexOf,ue=$.reduce,pe=$.reduceRight,me=$.join,fe=$.sort,ge=$.slice,ve=$.toString,ye=$.toLocaleString,Me=B("iterator"),Ee=B("toStringTag"),be=R("typed_constructor"),Ie=R("def_constructor"),xe=l.CONSTR,Te=l.TYPED,_e=l.VIEW,Se="Wrong length!",Ce=L(1,(function(e,t){return Pe(P(e,e[Ie]),t)})),we=s((function(){return 1===new q(new Uint16Array([1]).buffer)[0]})),Re=!!q&&!!q[Z].set&&s((function(){new q(1).set({})})),Be=function(e,t){if(e===i)throw W(Se);var r=+e,a=g(e);if(t&&!E(r,a))throw z(Se);return a},Le=function(e,t){var i=f(e);if(i<0||i%t)throw z("Wrong offset!");return i},Oe=function(e){if(I(e)&&Te in e)return e;throw W(e+" is not a typed array!")},Pe=function(e,t){if(!I(e)||!(be in e))throw W("It is not a typed array constructor!");return new e(t)},De=function(e,t){return Ae(P(e,e[Ie]),t)},Ae=function(e,t){for(var i=0,r=t.length,a=Pe(e,r);r>i;)a[i]=t[i++];return a},Ne=function(e,t,i){V(e,t,{get:function(){return this._d[i]}})},He=function(e){var t,r,a,n,s,o,l=x(e),d=arguments.length,c=d>1?arguments[1]:i,u=c!==i,p=w(l);if(p!=i&&!T(p)){for(o=p.call(l),a=[],t=0;!(s=o.next()).done;t++)a.push(s.value);l=a}for(u&&d>2&&(c=h(c,arguments[2],2)),t=0,r=g(l.length),n=Pe(this,r);r>t;t++)n[t]=u?c(l[t],t):l[t];return n},Ue=function(){for(var e=0,t=arguments.length,i=Pe(this,t);t>e;)i[e]=arguments[e++];return i},Fe=!!q&&s((function(){ye.call(new q(1))})),ke=function(){return ye.apply(Fe?ge.call(Oe(this)):Oe(this),arguments)},Ge={copyWithin:function(e,t){return F.call(Oe(this),e,t,arguments.length>2?arguments[2]:i)},every:function(e){return re(Oe(this),e,arguments.length>1?arguments[1]:i)},fill:function(e){return U.apply(Oe(this),arguments)},filter:function(e){return De(this,te(Oe(this),e,arguments.length>1?arguments[1]:i))},find:function(e){return ae(Oe(this),e,arguments.length>1?arguments[1]:i)},findIndex:function(e){return ne(Oe(this),e,arguments.length>1?arguments[1]:i)},forEach:function(e){ee(Oe(this),e,arguments.length>1?arguments[1]:i)},indexOf:function(e){return oe(Oe(this),e,arguments.length>1?arguments[1]:i)},includes:function(e){return se(Oe(this),e,arguments.length>1?arguments[1]:i)},join:function(e){return me.apply(Oe(this),arguments)},lastIndexOf:function(e){return ce.apply(Oe(this),arguments)},map:function(e){return Ce(Oe(this),e,arguments.length>1?arguments[1]:i)},reduce:function(e){return ue.apply(Oe(this),arguments)},reduceRight:function(e){return pe.apply(Oe(this),arguments)},reverse:function(){for(var e,t=this,i=Oe(t).length,r=Math.floor(i/2),a=0;a<r;)e=t[a],t[a++]=t[--i],t[i]=e;return t},some:function(e){return ie(Oe(this),e,arguments.length>1?arguments[1]:i)},sort:function(e){return fe.call(Oe(this),e)},subarray:function(e,t){var r=Oe(this),a=r.length,n=v(e,a);return new(P(r,r[Ie]))(r.buffer,r.byteOffset+n*r.BYTES_PER_ELEMENT,g((t===i?a:v(t,a))-n))}},Ve=function(e,t){return De(this,ge.call(Oe(this),e,t))},je=function(e){Oe(this);var t=Le(arguments[1],1),i=this.length,r=x(e),a=g(r.length),n=0;if(a+t>i)throw z(Se);for(;n<a;)this[t+n]=r[n++]},ze={entries:function(){return he.call(Oe(this))},keys:function(){return de.call(Oe(this))},values:function(){return le.call(Oe(this))}},We=function(e,t){return I(e)&&e[Te]&&"symbol"!=typeof t&&t in e&&String(+t)==String(t)},qe=function(e,t){return We(e,t=y(t,!0))?u(2,e[t]):j(e,t)},Xe=function(e,t,i){return!(We(e,t=y(t,!0))&&I(i)&&M(i,"value"))||M(i,"get")||M(i,"set")||i.configurable||M(i,"writable")&&!i.writable||M(i,"enumerable")&&!i.enumerable?V(e,t,i):(e[t]=i.value,e)};xe||(G.f=qe,k.f=Xe),o(o.S+o.F*!xe,"Object",{getOwnPropertyDescriptor:qe,defineProperty:Xe}),s((function(){ve.call({})}))&&(ve=ye=function(){return me.call(this)});var Ye=m({},Ge);m(Ye,ze),p(Ye,Me,ze.values),m(Ye,{slice:Ve,set:je,constructor:function(){},toString:ve,toLocaleString:ke}),Ne(Ye,"buffer","b"),Ne(Ye,"byteOffset","o"),Ne(Ye,"byteLength","l"),Ne(Ye,"length","e"),V(Ye,Ee,{get:function(){return this[Te]}}),e.exports=function(e,t,r,d){var h=e+((d=!!d)?"Clamped":"")+"Array",u="Uint8Array"!=h,m="get"+e,f="set"+e,v=n[h],y=v||{},M=v&&S(v),E=!v||!l.ABV,x={},T=v&&v[Z],w=function(e,i){var r=e._d;return r.v[m](i*t+r.o,we)},R=function(e,i,r){var a=e._d;d&&(r=(r=Math.round(r))<0?0:r>255?255:255&r),a.v[f](i*t+a.o,r,we)},B=function(e,t){V(e,t,{get:function(){return w(this,t)},set:function(e){return R(this,t,e)},enumerable:!0})};E?(v=r((function(e,r,a,n){c(e,v,h,"_d");var s,o,l,d,u=0,m=0;if(I(r)){if(!(r instanceof Q||(d=b(r))==X||d==Y))return Te in r?Ae(v,r):He.call(v,r);s=r,m=Le(a,t);var f=r.byteLength;if(n===i){if(f%t)throw z(Se);if((o=f-m)<0)throw z(Se)}else if((o=g(n)*t)+m>f)throw z(Se);l=o/t}else l=Be(r,!0),s=new Q(o=l*t);for(p(e,"_d",{b:s,o:m,l:o,e:l,v:new J(s)});u<l;)B(e,u++)})),T=v[Z]=_(Ye),p(T,"constructor",v)):N((function(e){new v(null),new v(e)}),!0)||(v=r((function(e,r,a,n){var s;return c(e,v,h),I(r)?r instanceof Q||(s=b(r))==X||s==Y?n!==i?new y(r,Le(a,t),n):a!==i?new y(r,Le(a,t)):new y(r):Te in r?Ae(v,r):He.call(v,r):new y(Be(r,u))})),ee(M!==Function.prototype?C(y).concat(C(M)):C(y),(function(e){e in v||p(v,e,y[e])})),v[Z]=T,a||(T.constructor=v));var L=T[Me],O=!!L&&("values"==L.name||L.name==i),P=ze.values;p(v,be,!0),p(T,Te,h),p(T,_e,!0),p(T,Ie,v),(d?new v(1)[Ee]==h:Ee in T)||V(T,Ee,{get:function(){return h}}),x[h]=v,o(o.G+o.W+o.F*(v!=y),x),o(o.S,h,{BYTES_PER_ELEMENT:t,from:He,of:Ue}),K in T||p(T,K,t),o(o.P,h,Ge),H(h),o(o.P+o.F*Re,h,{set:je}),o(o.P+o.F*!O,h,ze),o(o.P+o.F*(T.toString!=ve),h,{toString:ve}),o(o.P+o.F*s((function(){new v(1).slice()})),h,{slice:Ve}),o(o.P+o.F*(s((function(){return[1,2].toLocaleString()!=new v([1,2]).toLocaleString()}))||!s((function(){T.toLocaleString.call([1,2])}))),h,{toLocaleString:ke}),A[h]=O?L:P,a||O||p(T,Me,P)}}else e.exports=function(){}},function(e,t,i){i(236)("Uint8",1,(function(e){return function(t,i,r){return e(this,t,i,r)}}))},function(e,t,i){i(236)("Uint8",1,(function(e){return function(t,i,r){return e(this,t,i,r)}}),!0)},function(e,t,i){i(236)("Int16",2,(function(e){return function(t,i,r){return e(this,t,i,r)}}))},function(e,t,i){i(236)("Uint16",2,(function(e){return function(t,i,r){return e(this,t,i,r)}}))},function(e,t,i){i(236)("Int32",4,(function(e){return function(t,i,r){return e(this,t,i,r)}}))},function(e,t,i){i(236)("Uint32",4,(function(e){return function(t,i,r){return e(this,t,i,r)}}))},function(e,t,i){i(236)("Float32",4,(function(e){return function(t,i,r){return e(this,t,i,r)}}))},function(e,t,i){i(236)("Float64",8,(function(e){return function(t,i,r){return e(this,t,i,r)}}))},function(e,t,r){var a=r(6),n=r(34)(!0);a(a.P,"Array",{includes:function(e){return n(this,e,arguments.length>1?arguments[1]:i)}}),r(178)("includes")},function(e,t,i){var r=i(6),a=i(125)(!0);r(r.P,"String",{at:function(e){return a(this,e)}})},function(e,t,r){var a=r(6),n=r(248);a(a.P,"String",{padStart:function(e){return n(this,e,arguments.length>1?arguments[1]:i,!0)}})},function(e,t,r){var a=r(35),n=r(85),s=r(33);e.exports=function(e,t,r,o){var l=String(s(e)),d=l.length,h=r===i?" ":String(r),c=a(t);if(c<=d||""==h)return l;var u=c-d,p=n.call(h,Math.ceil(u/h.length));return p.length>u&&(p=p.slice(0,u)),o?p+l:l+p}},function(e,t,r){var a=r(6),n=r(248);a(a.P,"String",{padEnd:function(e){return n(this,e,arguments.length>1?arguments[1]:i,!1)}})},function(e,t,i){i(81)("trimLeft",(function(e){return function(){return e(this,1)}}),"trimStart")},function(e,t,i){i(81)("trimRight",(function(e){return function(){return e(this,2)}}),"trimEnd")},function(e,t,i){var r=i(6),a=i(33),n=i(35),s=i(128),o=i(188),l=RegExp.prototype,d=function(e,t){this._r=e,this._s=t};i(136)(d,"RegExp String",(function(){var e=this._r.exec(this._s);return{value:e,done:null===e}})),r(r.P,"String",{matchAll:function(e){if(a(this),!s(e))throw TypeError(e+" is not a regexp!");var t=String(this),i="flags"in l?String(e.flags):o.call(e),r=new RegExp(e.source,~i.indexOf("g")?i:"g"+i);return r.lastIndex=n(e.lastIndex),new d(r,t)}})},function(e,t,i){i(25)("asyncIterator")},function(e,t,i){i(25)("observable")},function(e,t,i){var r=i(6),a=i(221),n=i(30),s=i(49),o=i(155);r(r.S,"Object",{getOwnPropertyDescriptors:function(e){for(var t,i=n(e),r=s.f,l=a(i),d={},h=0;l.length>h;)o(d,t=l[h++],r(i,t));return d}})},function(e,t,i){var r=i(6),a=i(257)(!1);r(r.S,"Object",{values:function(e){return a(e)}})},function(e,t,i){var r=i(28),a=i(30),n=i(42).f;e.exports=function(e){return function(t){for(var i,s=a(t),o=r(s),l=o.length,d=0,h=[];l>d;)n.call(s,i=o[d++])&&h.push(e?[i,s[i]]:s[i]);return h}}},function(e,t,i){var r=i(6),a=i(257)(!0);r(r.S,"Object",{entries:function(e){return a(e)}})},function(e,t,i){var r=i(6),a=i(56),n=i(19),s=i(9);i(4)&&r(r.P+i(260),"Object",{__defineGetter__:function(e,t){s.f(a(this),e,{get:n(t),enumerable:!0,configurable:!0})}})},function(e,t,i){e.exports=i(26)||!i(5)((function(){var e=Math.random();__defineSetter__.call(null,e,(function(){})),delete i(2)[e]}))},function(e,t,i){var r=i(6),a=i(56),n=i(19),s=i(9);i(4)&&r(r.P+i(260),"Object",{__defineSetter__:function(e,t){s.f(a(this),e,{set:n(t),enumerable:!0,configurable:!0})}})},function(e,t,i){var r=i(6),a=i(56),n=i(14),s=i(57),o=i(49).f;i(4)&&r(r.P+i(260),"Object",{__lookupGetter__:function(e){var t,i=a(this),r=n(e,!0);do{if(t=o(i,r))return t.get}while(i=s(i))}})},function(e,t,i){var r=i(6),a=i(56),n=i(14),s=i(57),o=i(49).f;i(4)&&r(r.P+i(260),"Object",{__lookupSetter__:function(e){var t,i=a(this),r=n(e,!0);do{if(t=o(i,r))return t.set}while(i=s(i))}})},function(e,t,i){var r=i(6);r(r.P+r.R,"Map",{toJSON:i(265)("Map")})},function(e,t,i){var r=i(73),a=i(266);e.exports=function(e){return function(){if(r(this)!=e)throw TypeError(e+"#toJSON isn't generic");return a(this)}}},function(e,t,i){var r=i(198);e.exports=function(e,t){var i=[];return r(e,!1,i.push,i,t),i}},function(e,t,i){var r=i(6);r(r.P+r.R,"Set",{toJSON:i(265)("Set")})},function(e,t,i){var r=i(6);r(r.S,"System",{global:i(2)})},function(e,t,i){var r=i(6),a=i(32);r(r.S,"Error",{isError:function(e){return"Error"===a(e)}})},function(e,t,i){var r=i(6);r(r.S,"Math",{iaddh:function(e,t,i,r){var a=e>>>0,n=i>>>0;return(t>>>0)+(r>>>0)+((a&n|(a|n)&~(a+n>>>0))>>>31)|0}})},function(e,t,i){var r=i(6);r(r.S,"Math",{isubh:function(e,t,i,r){var a=e>>>0,n=i>>>0;return(t>>>0)-(r>>>0)-((~a&n|~(a^n)&a-n>>>0)>>>31)|0}})},function(e,t,i){var r=i(6);r(r.S,"Math",{imulh:function(e,t){var i=65535,r=+e,a=+t,n=r&i,s=a&i,o=r>>16,l=a>>16,d=(o*s>>>0)+(n*s>>>16);return o*l+(d>>16)+((n*l>>>0)+(d&i)>>16)}})},function(e,t,i){var r=i(6);r(r.S,"Math",{umulh:function(e,t){var i=65535,r=+e,a=+t,n=r&i,s=a&i,o=r>>>16,l=a>>>16,d=(o*s>>>0)+(n*s>>>16);return o*l+(d>>>16)+((n*l>>>0)+(d&i)>>>16)}})},function(e,t,i){var r=i(275),a=i(10),n=r.key,s=r.set;r.exp({defineMetadata:function(e,t,i,r){s(e,t,a(i),n(r))}})},function(e,t,r){var a=r(203),n=r(6),s=r(21)("metadata"),o=s.store||(s.store=new(r(207))),l=function(e,t,r){var n=o.get(e);if(!n){if(!r)return i;o.set(e,n=new a)}var s=n.get(t);if(!s){if(!r)return i;n.set(t,s=new a)}return s};e.exports={store:o,map:l,has:function(e,t,r){var a=l(t,r,!1);return a!==i&&a.has(e)},get:function(e,t,r){var a=l(t,r,!1);return a===i?i:a.get(e)},set:function(e,t,i,r){l(i,r,!0).set(e,t)},keys:function(e,t){var i=l(e,t,!1),r=[];return i&&i.forEach((function(e,t){r.push(t)})),r},key:function(e){return e===i||"symbol"==typeof e?e:String(e)},exp:function(e){n(n.S,"Reflect",e)}}},function(e,t,r){var a=r(275),n=r(10),s=a.key,o=a.map,l=a.store;a.exp({deleteMetadata:function(e,t){var r=arguments.length<3?i:s(arguments[2]),a=o(n(t),r,!1);if(a===i||!a.delete(e))return!1;if(a.size)return!0;var d=l.get(t);return d.delete(r),!!d.size||l.delete(t)}})},function(e,t,r){var a=r(275),n=r(10),s=r(57),o=a.has,l=a.get,d=a.key,h=function(e,t,r){if(o(e,t,r))return l(e,t,r);var a=s(t);return null!==a?h(e,a,r):i};a.exp({getMetadata:function(e,t){return h(e,n(t),arguments.length<3?i:d(arguments[2]))}})},function(e,t,r){var a=r(206),n=r(266),s=r(275),o=r(10),l=r(57),d=s.keys,h=s.key,c=function(e,t){var i=d(e,t),r=l(e);if(null===r)return i;var s=c(r,t);return s.length?i.length?n(new a(i.concat(s))):s:i};s.exp({getMetadataKeys:function(e){return c(o(e),arguments.length<2?i:h(arguments[1]))}})},function(e,t,r){var a=r(275),n=r(10),s=a.get,o=a.key;a.exp({getOwnMetadata:function(e,t){return s(e,n(t),arguments.length<3?i:o(arguments[2]))}})},function(e,t,r){var a=r(275),n=r(10),s=a.keys,o=a.key;a.exp({getOwnMetadataKeys:function(e){return s(n(e),arguments.length<2?i:o(arguments[1]))}})},function(e,t,r){var a=r(275),n=r(10),s=r(57),o=a.has,l=a.key,d=function(e,t,i){if(o(e,t,i))return!0;var r=s(t);return null!==r&&d(e,r,i)};a.exp({hasMetadata:function(e,t){return d(e,n(t),arguments.length<3?i:l(arguments[2]))}})},function(e,t,r){var a=r(275),n=r(10),s=a.has,o=a.key;a.exp({hasOwnMetadata:function(e,t){return s(e,n(t),arguments.length<3?i:o(arguments[2]))}})},function(e,t,r){var a=r(275),n=r(10),s=r(19),o=a.key,l=a.set;a.exp({metadata:function(e,t){return function(r,a){l(e,t,(a!==i?n:s)(r),o(a))}}})},function(e,t,i){var r=i(6),a=i(201)(),n=i(2).process,s="process"==i(32)(n);r(r.G,{asap:function(e){var t=s&&n.domain;a(t?t.bind(e):e)}})},function(e,t,r){var a=r(6),n=r(2),s=r(7),o=r(201)(),l=r(23)("observable"),d=r(19),h=r(10),c=r(197),u=r(202),p=r(8),m=r(198),f=m.RETURN,g=function(e){return null==e?i:d(e)},v=function(e){var t=e._c;t&&(e._c=i,t())},y=function(e){return e._o===i},M=function(e){y(e)||(e._o=i,v(e))},E=function(e,t){h(e),this._c=i,this._o=e,e=new b(this);try{var r=t(e),a=r;null!=r&&("function"==typeof r.unsubscribe?r=function(){a.unsubscribe()}:d(r),this._c=r)}catch(t){return void e.error(t)}y(this)&&v(this)};E.prototype=u({},{unsubscribe:function(){M(this)}});var b=function(e){this._s=e};b.prototype=u({},{next:function(e){var t=this._s;if(!y(t)){var i=t._o;try{var r=g(i.next);if(r)return r.call(i,e)}catch(e){try{M(t)}finally{throw e}}}},error:function(e){var t=this._s;if(y(t))throw e;var r=t._o;t._o=i;try{var a=g(r.error);if(!a)throw e;e=a.call(r,e)}catch(e){try{v(t)}finally{throw e}}return v(t),e},complete:function(e){var t=this._s;if(!y(t)){var r=t._o;t._o=i;try{var a=g(r.complete);e=a?a.call(r,e):i}catch(e){try{v(t)}finally{throw e}}return v(t),e}}});var I=function(e){c(this,I,"Observable","_f")._f=d(e)};u(I.prototype,{subscribe:function(e){return new E(e,this._f)},forEach:function(e){var t=this;return new(s.Promise||n.Promise)((function(i,r){d(e);var a=t.subscribe({next:function(t){try{return e(t)}catch(e){r(e),a.unsubscribe()}},error:r,complete:i})}))}}),u(I,{from:function(e){var t="function"==typeof this?this:I,i=g(h(e)[l]);if(i){var r=h(i.call(e));return r.constructor===t?r:new t((function(e){return r.subscribe(e)}))}return new t((function(t){var i=!1;return o((function(){if(!i){try{if(m(e,!1,(function(e){if(t.next(e),i)return f}))===f)return}catch(e){if(i)throw e;return void t.error(e)}t.complete()}})),function(){i=!0}}))},of:function(){for(var e=0,t=arguments.length,i=Array(t);e<t;)i[e]=arguments[e++];return new("function"==typeof this?this:I)((function(e){var t=!1;return o((function(){if(!t){for(var r=0;r<i.length;++r)if(e.next(i[r]),t)return;e.complete()}})),function(){t=!0}}))}}),p(I.prototype,l,(function(){return this})),a(a.G,{Observable:I}),r(186)("Observable")},function(e,t,i){var r=i(6),a=i(200);r(r.G+r.B,{setImmediate:a.set,clearImmediate:a.clear})},function(e,t,i){for(var r=i(183),a=i(16),n=i(2),s=i(8),o=i(135),l=i(23),d=l("iterator"),h=l("toStringTag"),c=o.Array,u=["NodeList","DOMTokenList","MediaList","StyleSheetList","CSSRuleList"],p=0;p<5;p++){var m,f=u[p],g=n[f],v=g&&g.prototype;if(v)for(m in v[d]||s(v,d,c),v[h]||s(v,h,f),o[f]=c,r)v[m]||a(v,m,r[m],!0)}},function(e,t,i){var r=i(2),a=i(6),n=i(76),s=i(289),o=r.navigator,l=!!o&&/MSIE .\./.test(o.userAgent),d=function(e){return l?function(t,i){return e(n(s,[].slice.call(arguments,2),"function"==typeof t?t:Function(t)),i)}:e};a(a.G+a.B+a.F*l,{setTimeout:d(r.setTimeout),setInterval:d(r.setInterval)})},function(e,t,i){var r=i(290),a=i(76),n=i(19);e.exports=function(){for(var e=n(this),t=arguments.length,i=Array(t),s=0,o=r._,l=!1;t>s;)(i[s]=arguments[s++])===o&&(l=!0);return function(){var r,n=this,s=arguments.length,d=0,h=0;if(!l&&!s)return a(e,i,n);if(r=i.slice(),l)for(;t>d;d++)r[d]===o&&(r[d]=arguments[h++]);for(;s>h;)r.push(arguments[h++]);return a(e,r,n)}}},function(e,t,i){e.exports=i(2)},function(e,t,r){function a(e){var t=d(null);return e!=i&&(g(e)?f(e,!0,(function(e,i){t[e]=i})):l(t,e)),t}var n=r(18),s=r(6),o=r(15),l=r(67),d=r(44),h=r(57),c=r(28),u=r(9),p=r(27),m=r(19),f=r(198),g=r(292),v=r(136),y=r(184),M=r(11),E=r(30),b=r(4),I=r(3),x=function(e){var t=1==e,r=4==e;return function(s,o,l){var d,h,c,u=n(o,l,3),p=E(s),m=t||7==e||2==e?new("function"==typeof this?this:a):i;for(d in p)if(I(p,d)&&(c=u(h=p[d],d,s),e))if(t)m[d]=c;else if(c)switch(e){case 2:m[d]=h;break;case 3:return!0;case 5:return h;case 6:return d;case 7:m[c[0]]=c[1]}else if(r)return!1;return 3==e||r?r:m}},T=x(6),_=function(e){return function(t){return new S(t,e)}},S=function(e,t){this._t=E(e),this._a=c(e),this._i=0,this._k=t};v(S,"Dict",(function(){var e,t=this,r=t._t,a=t._a,n=t._k;do{if(t._i>=a.length)return t._t=i,y(1)}while(!I(r,e=a[t._i++]));return y(0,"keys"==n?e:"values"==n?r[e]:[e,r[e]])})),a.prototype=null,s(s.G+s.F,{Dict:a}),s(s.S,"Dict",{keys:_("keys"),values:_("values"),entries:_("entries"),forEach:x(0),map:x(1),filter:x(2),some:x(3),every:x(4),find:x(5),findKey:T,mapPairs:x(7),reduce:function(e,t,i){m(t);var r,a,n=E(e),s=c(n),o=s.length,l=0;if(arguments.length<3){if(!o)throw TypeError("Reduce of empty object with no initial value");r=n[s[l++]]}else r=Object(i);for(;o>l;)I(n,a=s[l++])&&(r=t(r,n[a],a,e));return r},keyOf:p,includes:function(e,t){return(t==t?p(e,t):T(e,(function(e){return e!=e})))!==i},has:I,get:function(e,t){if(I(e,t))return e[t]},set:function(e,t,i){return b&&t in Object?u.f(e,t,o(0,i)):e[t]=i,e},isDict:function(e){return M(e)&&h(e)===a.prototype}})},function(e,t,r){var a=r(73),n=r(23)("iterator"),s=r(135);e.exports=r(7).isIterable=function(e){var t=Object(e);return t[n]!==i||"@@iterator"in t||s.hasOwnProperty(a(t))}},function(e,t,i){var r=i(10),a=i(156);e.exports=i(7).getIterator=function(e){var t=a(e);if("function"!=typeof t)throw TypeError(e+" is not iterable!");return r(t.call(e))}},function(e,t,i){var r=i(2),a=i(7),n=i(6),s=i(289);n(n.G+n.F,{delay:function(e){return new(a.Promise||r.Promise)((function(t){setTimeout(s.call(t,!0),e)}))}})},function(e,t,i){var r=i(290),a=i(6);i(7)._=r._=r._||{},a(a.P+a.F,"Function",{part:i(289)})},function(e,t,i){var r=i(6);r(r.S+r.F,"Object",{isObject:i(11)})},function(e,t,i){var r=i(6);r(r.S+r.F,"Object",{classof:i(73)})},function(e,t,i){var r=i(6),a=i(299);r(r.S+r.F,"Object",{define:a})},function(e,t,i){var r=i(9),a=i(49),n=i(221),s=i(30);e.exports=function(e,t){for(var i,o=n(s(t)),l=o.length,d=0;l>d;)r.f(e,i=o[d++],a.f(t,i));return e}},function(e,t,i){var r=i(6),a=i(299),n=i(44);r(r.S+r.F,"Object",{make:function(e,t){return a(n(e),t)}})},function(e,t,r){r(134)(Number,"Number",(function(e){this._l=+e,this._i=0}),(function(){var e=this._i++,t=!(e<this._l);return{done:t,value:t?i:e}}))},function(e,t,i){var r=i(6),a=i(303)(/[\\^$*+?.()|[\]{}]/g,"\\$&");r(r.S,"RegExp",{escape:function(e){return a(e)}})},function(e,t){e.exports=function(e,t){var i=t===Object(t)?function(e){return t[e]}:t;return function(t){return String(t).replace(e,i)}}},function(e,t,i){var r=i(6),a=i(303)(/[&<>"']/g,{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&apos;"});r(r.P+r.F,"String",{escapeHTML:function(){return a(this)}})},function(e,t,i){var r=i(6),a=i(303)(/&(?:amp|lt|gt|quot|apos);/g,{"&amp;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&apos;":"'"});r(r.P+r.F,"String",{unescapeHTML:function(){return a(this)}})}]),"undefined"!=typeof module&&module.exports?module.exports=e:"function"==typeof define&&define.amd?define((function(){return e})):t.core=e;r.CollisionManager=class{constructor(){this.condition=[{categoryId:"-2000011"}],this.distance=15}setCondition(e){e instanceof Array&&(this.condition=e)}getCondition(){return this.condition}getDistance(){return this.distance}setDistance(e){this.distance=e}matchConditions(e){var t=this.condition;if(0==t.length)return!1;for(var i=!0,r=0,a=t.length;r<a;r++){var n=t[r];for(var s in n)if(!e.hasOwnProperty(s)||e[s]!=n[s]){i=!1;break}if(1==i)break;r<t.length-1&&(i=!0)}return i}hasCollision(e,t){if(!e)return!1;var i=this.matchConditions(e),r=t<=this.distance;return!(!i||!r)}},function(){let e=new THREE.Vector3,t=new THREE.Vector3,i=new THREE.Vector2,a=new THREE.Vector3,n=new THREE.Vector3,s=new THREE.Plane,o=new THREE.Vector3,l=new THREE.Vector3,d=new THREE.Vector3,h=!1,c=new THREE.Vector3,u=new THREE.Matrix4;r.UserInputHelper=class{constructor(e,t){this.camera=e.camera,this.cameraControl=e,this.domElement=t,this.intersectContext=new r.IntersectContext,this.rayCaster=new r.Raycaster,this._lastTrackingPoint=new THREE.Vector3,this.viewer=e.viewer,this._rotatePivot=new THREE.Vector3,this.pivot=null,this._assistGroundPlane=new r.Ground,this.boundaryLimitFactor=2,this._planIntersect=new THREE.Vector3,this.intersectHelper=e.intersector,this._minObjectOffset=.5}getWorldDimension(t,i,a){var s=this.camera.position,o=this.camera.direction(n).normalize(),l=this.getTrackingPoint(t,i,!0),d=e.subVectors(l,s),h=Math.abs(o.dot(d)),c=r.DomUtil.getContainerOffsetToClient(this.domElement),u=c.width/c.height,p=2*h*Math.tan(THREE.Math.degToRad(.5*this.camera.fov)),m=p*u;return r.Utils.isDefined(a)||(console.warn("result is needed for function UserInputHelper.getWorldDimension()"),a=new THREE.Vector2),a.set(m,p),a}getTrackingPoint(t,i,a){e.set(t,i),this.getIntersectContext(e);let o=null;if(o=!0===a&&r.GlobalData.ZoomHitByBox?this.intersectHelper.hitTestByBox(this.intersectContext):this.intersectHelper.hitTest(this.intersectContext),o)this._lastTrackingPoint.copy(o),h=!0;else{const e=this.getRayCaster(t,i).ray;if(h){const t=this.camera.direction(n).normalize();if(s.setFromNormalAndCoplanarPoint(t,this._lastTrackingPoint),o=e.intersectPlane(s,this._planIntersect),o){const t=this.camera.position;o.distanceTo(t)<r.Math.EPSILON1&&(o=this._getTrackingPointFromScene(e),h=!1)}else o=this._getTrackingPointFromScene(e),h=!1}else o=this._getTrackingPointFromScene(e)}return o}getRotatePivot(t,i){var a=null;let n=this.viewer.getRotationCenter();if(r.Utils.isDefined(n))return n;switch(t){case r.RotatePivotMode.SELECTION:a=this._getRotatePivotFromSelection(i,this._rotatePivot);break;case r.RotatePivotMode.CENTER:a=this.viewer.getScene().getBoundingBox().getCenter(e);break;case r.RotatePivotMode.CAMERA:a=null;break;default:a=this._getRotatePivotFromIntersect(i)}return this.cameraControl.dirtyCamera(!0),this.cameraControl.setCameraChanging(!0),this.pivot=a,a}getPanOffset(e,t,i,a){var n=r.DomUtil.getContainerOffsetToClient(this.domElement),s=e.x-n.left,h=e.y-n.top;o.x=s/n.width,o.y=h/n.height,s=t.x-n.left,h=t.y-n.top,l.x=s/n.width,l.y=h/n.height,d.subVectors(l,o);var c=-d.x*i.x,u=d.y*i.y,p=this.cameraControl.getWorldRight().multiplyScalar(c),m=this.cameraControl.getWorldUp().multiplyScalar(u);return this.cameraControl.dirtyCamera(!0),this.cameraControl.setCameraChanging(!0),a.addVectors(p,m),a}adjustCameraForPan(t){if(!this.lockPan){var i=this.camera;if(e.copy(i.position),e.add(t),!(null!=i.minimumElevation&&t.y<0&&e.y<i.minimumElevation)){if(this._limitWorldScalar&&this.cameraControl._checkZoomNearBoundary(e,-1)){if(e.x<0&&t.x<0||e.z<0&&t.z<0)return;if(e.x>0&&t.x>0||e.z>0&&t.z>0)return}this.cameraControl.dirtyCamera(!0),this.cameraControl.setCameraChanging(!0),i.target.add(t),i.position.add(t)}}}adjustCameraForZoom(i,a){if(Math.abs(i)<r.Math.EPSILON6)return!1;const s=this.camera,o=s.position,l=s.direction(n);if(a?t.subVectors(a,o):t.copy(l),e.copy(t),t.multiplyScalar(i),s.isPerspective){const r=e.length()*(1-i),a=this.viewer.modelManager.isMeterUnit()?1:.001;var d=this.viewer.getScene().getMatrixGlobal();u.copy(d).invert(),e.applyMatrix4(u);const n=e.length()*(1-i)*a;let s=this._minObjectOffset;this.viewer.getBoundingBoxWorld().getSize(e),!this.viewer.modelManager.isMeterUnit()&&e.x<1e3&&e.y<1e3&&e.z<1e3&&(s=this._minObjectOffset/1e3),n<s&&(this.cameraControl.setTrackPointChanging(!0),t.normalize().multiplyScalar(r+.1))}else s.orthoScale*=i+1,s.setZoom(s.orthoScale);t.add(o),r.Utils.isDefined(s.minimumElevation)&&t.y<s.minimumElevation||this._checkCameraLimitBoundary(s,t,i)||(s.position.copy(t),s.target.copy(l.add(t)),this.cameraControl.dirtyCamera(!0),this.cameraControl.setCameraChanging(!0))}clientToViewport(e,t,i){var a=r.DomUtil.getContainerOffsetToClient(this.domElement),n=i||new THREE.Vector2;return n.x=(e-a.left)/a.width*2-1,n.y=-(t-a.top)/a.height*2+1,n}viewportToClient(e,t,i){var a=r.DomUtil.getContainerOffsetToClient(this.domElement),n=i||new THREE.Vector2;return n.x=(e+1)/2*a.width+a.left,n.y=(1-t)/2*a.height+a.top,n}getIntersectContext(e){var t=this.viewer.modelManager;return this.intersectContext.scene=this.viewer.getScene(),this.intersectContext.camera=this.camera,r.Utils.isDefined(e)&&(this.clientToViewport(e.x,e.y,this.intersectContext.mouse),this.intersectContext.pointer={x:e.x,y:e.y}),this.intersectContext.viewportSize=this.viewer.getViewportSize(),this.intersectContext.octreeRoots=t.getOctreeRoots(),this.intersectContext.octantMap=t.getOctantMap(),this.intersectContext}getRayCaster(e,t){return this.clientToViewport(e,t,i),this.rayCaster.setFromCamera(i,this.camera),this.rayCaster}_getTrackingPointFromScene(t){let i=1/0;const r=t.origin,n=this.viewer.getScene().getBoundingBox();if(t.intersectBox(n,a))return a;e.set(0,0,-1),s.setFromNormalAndCoplanarPoint(e,n.max);let o=0;return t.intersectPlane(s,this._planIntersect)&&(o=r.distanceTo(this._planIntersect),o<i&&(i=o,a.copy(this._planIntersect))),e.set(0,-1,0),s.setFromNormalAndCoplanarPoint(e,n.max),t.intersectPlane(s,this._planIntersect)&&(o=r.distanceTo(this._planIntersect),o<i&&(i=o,a.copy(this._planIntersect))),e.set(-1,0,0),s.setFromNormalAndCoplanarPoint(e,n.max),t.intersectPlane(s,this._planIntersect)&&(o=r.distanceTo(this._planIntersect),o<i&&(i=o,a.copy(this._planIntersect))),e.set(0,0,-1),s.setFromNormalAndCoplanarPoint(e,n.min),t.intersectPlane(s,this._planIntersect)&&(o=r.distanceTo(this._planIntersect),o<i&&(i=o,a.copy(this._planIntersect))),e.set(0,-1,0),s.setFromNormalAndCoplanarPoint(e,n.min),t.intersectPlane(s,this._planIntersect)&&(o=r.distanceTo(this._planIntersect),o<i&&(i=o,a.copy(this._planIntersect))),e.set(0,0,-1),s.setFromNormalAndCoplanarPoint(e,n.min),t.intersectPlane(s,this._planIntersect)&&(o=r.distanceTo(this._planIntersect),o<i&&(i=o,a.copy(this._planIntersect))),a}_getRotatePivotFromIntersect(t,i){var a=this.getIntersectContext(t);let n;if(n=r.GlobalData.ZoomHitByBox?this.intersectHelper.hitTestByBox(a):this.intersectHelper.hitTest(a),t&&n)return n;if(i&&!i.isEmpty())return i.getCenter(c),c;{const t=this.viewer.getFilter();if(t._hasVisibleFilter()){const i=t.getVisibleComponentsBbox();return i.applyMatrix4(this.viewer.getScene().getMatrixGlobal()),i.getCenter(e),e.clone()}return this.viewer.getScene().getBoundingBox().getCenter(c)}}_getRotatePivotFromSelection(t,i){const a=this.viewer,n=a.getScene();let s;if(n.hasClipPlanes()){const e=r.ClipPlaneManager.getInstance(n);if(e.isEnabled()&&(s=e.getClipBoundingBox(),r.Utils.isDefined(s)&&!s.isEmpty()&&e.isVisible()))return i.copy(s.getCenter(c)),i}const o=a.getFilter().getVisibleComponentSet(a.modelManager.sceneState.getSelectionSet());let l=a.getBoundingBoxByIds(o),d=null;if(!l||l.isEmpty()){if(n.hasFillClipPlanes()){const e=r.FillClipPlaneManager.getInstance(n).getFillClipBoundingBox();r.Utils.isDefined(e)&&(d=e)}i.copy(this._getRotatePivotFromIntersect(t,d))}else{if(r.Utils.isDefined(s))l.intersect(s);else if(n.hasFillClipPlanes()){const e=r.FillClipPlaneManager.getInstance(n);if(e.isEnabled()){const t=e.getFillClipBoundingBox();r.Utils.isDefined(t)&&l.intersect(t)}}i.copy(l.getCenter(e))}return i}_checkCameraLimitBoundary(t,i,a){if(!t.isPerspective||!r.GlobalData.ConstraintZoom)return!1;const n=this.viewer.getScene().getBoundingBox();if(r.Utils.isDefined(a)&&a>0)return!t.getFrustum().intersectsBox(n);const s=.5*n.getSize(e).length()/Math.tan(THREE.Math.degToRad(.5*t.fov))*this.boundaryLimitFactor,o=n.getCenter(e);return!(i.distanceTo(o)<s)}}}(),function(){const e=new THREE.Vector3(0,1,0);let t=new THREE.Vector3(0,0,1),i=new THREE.Vector3,a=new THREE.Quaternion,n=new THREE.Matrix4,s=new THREE.Vector3,o=new THREE.Quaternion,l=new THREE.Vector3,d=new THREE.Vector3,h=new THREE.Vector3,c=new THREE.Matrix4,u=new THREE.Matrix4,p=new THREE.Box3,m=new THREE.Vector3,f=!1;function g(e,t,i,r){n.copy(t).invert();var a=new THREE.Vector3(e.position.x,e.position.y,e.position.z),s=a.clone();s.applyMatrix4(n);var o=new THREE.Vector3(i.x,i.y,i.z);o.add(a),o.applyMatrix4(n),o.sub(s).normalize().multiplyScalar(r);var l=o.clone();return o.add(s),o.applyMatrix4(t),o.sub(a),{stepDiffWorld:l,stepDiffDrawing:o}}function v(e){if(e.viewer.getRotationCenter())return e.viewer.getRotationCenter();var t=e.viewer.modelManager.sceneState;if(t.hasSelection()){var i=e.viewer.getFilter().getVisibleComponentSet(t.getSelectionSet()),r=viewer.getBoundingBoxByIds(i);if(r&&!r.isEmpty())return r.getCenter(d)}return e.pivot?e.pivot:e.scene.getBoundingBox().getCenter(d)}function y(i,r,a,n){if(null==n||void 0===n)return!0;const s=n[0],o=n[1];var l=i.position;let d=new THREE.Vector3;i.getWorldDirection(d);var h=i.realUp||i.up,c=d.clone().cross(h).normalize(),u=(new THREE.Quaternion).setFromAxisAngle(c,r);l.clone().sub(a).normalize();var p=d.clone().negate(),m=p.angleTo(e.clone()),f=p.clone().projectOnPlane(e.clone()),g=f.angleTo(t.clone());f.x<0&&(g=2*Math.PI-g),d.applyQuaternion(u).normalize();var v=d.clone().negate(),y=v.angleTo(e.clone()),M=v.clone().projectOnPlane(e.clone()),E=M.angleTo(t.clone());if(M.x<0&&(E=2*Math.PI-E),Math.abs(E-g)>.001)return!1;if(m>s&&m<o){if(y>o||y<s)return!1}else if((m>o?y-m:m-y)>0)return!1;return!0}r.CameraControl=class{constructor(e,t,i,a,n,s){this.viewer=e,this.camera=i,this.domElement=a,this.scene=t,this.intersector=new r.IntersectHelper(e),this._ground=new r.Ground,this.collisionManager=new r.CollisionManager,this.pivotBallGroup=null,this.minDollyDistance=5,this.gravity=0,this.farFactor=2,this.maxPitch=void 0,this.minPitch=void 0,this._cameraChanging=!1,s=r.Utils.defaultValue(s,{}),this._enableDamping=r.Utils.defaultValue(s.enableDamping,!1),this._dynamicDampingFactor=r.Utils.defaultValue(s.dynamicDampingFactor,.1),this._limitWorldScalar=!0,this.lockPan=!1,this.userInputWorking=!1,this._changeCallBack=n,this._planIntersect=new THREE.Vector3,this.userInputHelper=new r.UserInputHelper(this,a),this._lastTrackPoint=new THREE.Vector3,this._lastZoomCxy=new THREE.Vector2}destroy(){this.viewer=null,this.camera=null,this.domElement=null,this.scene=null,this.intersector.destroy(),this.intersector=null,this.collisionManager=null,this.pivotBallGroup=null}enableDamping(){this._enableDamping=!0;const e=this.viewer.editorManager.userInputEditor;r.Utils.isDefined(e)&&e.resetDynamicMoving()}disableDamping(){this._enableDamping=!1;const e=this.viewer.editorManager.userInputEditor;r.Utils.isDefined(e)&&e.resetDynamicMoving()}isEnableDamping(){return this._enableDamping}dynamicDampingFactor(e){return r.Utils.isDefined(e)&&(this._dynamicDampingFactor=e),this._dynamicDampingFactor}enableLimitWorldScalar(e){this._limitWorldScalar=e}isCameraChanging(){return this._cameraChanging}setCameraChanging(e){this._cameraChanging=e,this.camera.dirty=e}setCamera(e){this.camera=e}getCamera(){return this.camera.updateMVP(),this.camera}dirtyCamera(e){this.camera.dirty=e}getFrustum(){return this.camera.getFrustum()}lockAxisZ(e){r.EditorConfig.LockAxisZ=e}isLockedAxisZ(){return r.EditorConfig.LockAxisZ}setLockAxisZRange(e){r.EditorConfig.LockAxisZRange=e}getLockAxisZRange(){return r.EditorConfig.LockAxisZRange}updateMaxPitch(e){this.maxPitch=e}updateMinPitch(e){this.minPitch=e}processRotate(e,t){var i=this.viewer.getClientSize(),r=-2*Math.PI*e.x/i.x,a=-2*Math.PI*e.y/i.y;this.handleRotation(r,a,t)}handleRotation(t,i,a){var n=this.camera,s=n.position,o=n.target;n.getWorldDirection(l);var d,h=o.clone().sub(s),c=h.length(),u=null,p=function(e,t=!1){var i,r,d,u=new THREE.Vector3;if(a){if(r=(i=s.clone().sub(a)).length(),i.normalize(),d=i.clone().applyQuaternion(e).normalize(),t&&null!=n.minimumElevation){let e=s.clone();if(e.copy(a).add(d.clone().multiplyScalar(r)),e.y<n.minimumElevation)return!1}s.copy(a).add(d.multiplyScalar(r)),l.applyQuaternion(e).normalize(),u.copy(s).add(l.multiplyScalar(c)),o.copy(u)}else i=h.clone(),r=c,i.normalize(),d=i.clone().applyQuaternion(e).normalize(),u.copy(s).add(d.multiplyScalar(r)),o.copy(u);return!0},m=n.up,f=l.clone().cross(m).normalize().clone().cross(l).normalize();if(n.realUp.copy(f),r.EditorConfig.LockAxisZ){if(Math.abs(t)>Math.abs(i))d=e,p(u=(new THREE.Quaternion).setFromAxisAngle(d,t)),n.realUp.applyQuaternion(u).normalize(),this.adjustCameraUp();else if(null!=r.EditorConfig.LockAxisZRange&&Math.abs(i)>1e-4){const e=r.EditorConfig.LockAxisZRange;y(this.camera,i,a,e)&&(d=l.clone().cross(m).normalize(),p(u=(new THREE.Quaternion).setFromAxisAngle(d,i)),n.realUp.applyQuaternion(u).normalize(),this.adjustCameraUp())}}else if(Math.abs(t)>Math.abs(i))(Math.abs(l.y+1)<1e-4||Math.abs(l.y-1)<1e-4)&&(d=l.clone().cross(n.realUp).normalize(),p(u=(new THREE.Quaternion).setFromAxisAngle(d,.1)),n.realUp.applyQuaternion(u).normalize(),this.adjustCameraUp()),d=l.y>0&&n.realUp.y<0?new THREE.Vector3(0,-1,0):new THREE.Vector3(0,1,0),p(u=(new THREE.Quaternion).setFromAxisAngle(d,t)),n.realUp.applyQuaternion(u).normalize();else if(Math.abs(i)>1e-4){if(null!=this.maxPitch&&null!=this.minPitch){const e=n.target.clone().sub(n.position);let t=new THREE.Vector2(Math.sqrt(e.x*e.x+e.z*e.z)*(n.realUp.y>0?1:-1),e.y).angle();if(t-Math.PI>0&&(t-=2*Math.PI),t=-t,i<0){if(t-i*(n.realUp.y>0?1:-1)>=this.maxPitch)return}else if(null!=n.minimumElevation&&n.position.y<n.minimumElevation||t-i<=this.minPitch)return}if(d=l.clone().cross(n.realUp).normalize(),!p(u=(new THREE.Quaternion).setFromAxisAngle(d,i),i>0))return;n.realUp.applyQuaternion(u).normalize(),this.adjustCameraUp()}this.updateCamera(),this.dirtyCamera(!0),this.setCameraChanging(!0)}updateCamera(){var e=this.camera;e.dirty&&(e.lookAt(e.target),e.updateMVP())}update(e,t){this.updateCamera();var n=this.camera;e?(void 0!==t&&this.needUpdateRenderList(t),!1!==r.GlobalData.BatchMergeEnabled&&r.GlobalData.Renderer!==r.EnumRendererType.INCREMENT||this.viewer.render(),i.copy(n.position),a.copy(n.quaternion)):(i.distanceToSquared(n.position)>r.Math.EPSILON6||8*(1-a.dot(n.quaternion))>r.Math.EPSILON6)&&(i.copy(n.position),a.copy(n.quaternion))}updateView(e){void 0!==e&&this.needUpdateRenderList(e),this._changeCallBack()}updateHighlight(){this._changeCallBack(!0)}needUpdateRenderList(e){this.viewer.editorManager.isUpdateRenderList=e,this.setCameraChanging(e)}pan(e,t){var i=this.domElement===document?this.domElement.body:this.domElement,a=new THREE.Vector3;const n=this;function s(e){var t=n.camera.matrix.elements;a.set(t[0],t[1],t[2]),a.multiplyScalar(-e),n.camera.target.add(a),n.camera.position.add(a)}function o(e){var t=n.camera.matrix.elements;a.set(t[4],t[5],t[6]),a.multiplyScalar(e),n.camera.target.add(a),n.camera.position.add(a)}if(this.camera.isPerspective){var l=this.camera.position.clone().sub(this.camera.target).length();s(2*e*(l*=Math.tan(this.camera.fov/2*Math.PI/180))/i.clientHeight),o(2*t*l/i.clientHeight)}else void 0!==this.camera.top?(s(e*(this.camera.right-this.camera.left)/i.clientWidth),o(t*(this.camera.top-this.camera.bottom)/i.clientHeight)):r.Logger.warn("WARNING: CloudPickEditor.js encountered an unknown camera type - pan disabled.")}_checkZoomNearBoundary(e,t){if(t<0){d.copy(e);var i=this.scene.getOriginalBoundingBoxWorld(),r=.5*i.getSize(d).length()/Math.tan(THREE.Math.degToRad(.5*this.camera.fov)),a=this.scene.getMatrixWorldGlobal();n.copy(a).invert(),d.applyMatrix4(n);var s=20*r,o=i.getCenter(d);if(d.distanceTo(o)>s)return!0}return!1}endOperation(){this.intersector.lastIntersect=null}onUserInputFinished(){this.userInputWorking=!1,this.viewer.render()}setTrackPointChanging(e){this._trackPointChanging=e}isTrackPointChanging(){return this._trackPointChanging}zoom(e,t,i){let a=null;this._lastZoomCxy.x!==t||this._lastZoomCxy.y!==i||this.isTrackPointChanging()?r.Utils.isDefined(t)&&r.Utils.isDefined(i)&&(a=this.userInputHelper.getTrackingPoint(t,i,!0),this._lastZoomCxy.x=t,this._lastZoomCxy.y=i,this._lastTrackPoint=a,this.setTrackPointChanging(!1)):a=this._lastTrackPoint,this.userInputHelper.adjustCameraForZoom(e,a),this.update()}touchDolly(e,t,i){const r=.5*i;var a=new THREE.Vector2(e,t),n=this.getIntersectContext(a),s=this.intersector.hitTest(n);null!=s?this.userInputHelper.adjustCameraForZoom(r,s):this.userInputHelper.adjustCameraForZoom(r,null)}zoomWithCenter(e,t){let i=e>0?e/(1-e):e;this.userInputHelper.adjustCameraForZoom(i,this.scene.worldToDrawing(t)),this.update()}getContainerDimensions(){return r.DomUtil.getContainerOffsetToClient(this.domElement)}screenToCanvas(e,t){var i=this.getContainerDimensions();return{x:e-i.left,y:t-i.top}}calculatePivot(e,t){return this.userInputHelper.getRotatePivot(e,t)}mapWindowToViewport(e,t,i){var r=this.getContainerDimensions(),a=i||new THREE.Vector2;return a.x=(e-r.left)/r.width*2-1,a.y=-(t-r.top)/r.height*2+1,a}mapViewportToWindow(e,t,i){var r=this.getContainerDimensions(),a=i||new THREE.Vector2;return a.x=(e+1)/2*r.width+r.left,a.y=(1-t)/2*r.height+r.top,a}computeFrustum(e,t,i,r,a,n){var s=this.camera,o=s.near*Math.tan(THREE.Math.degToRad(.5*s.fov)),l=o*s.aspect,d=(e-n.left)/n.width*2-1,h=(t-n.left)/n.width*2-1,p=-(i-n.top)/n.height*2+1,m=-(r-n.top)/n.height*2+1;if(s.isPerspective?c.makePerspective(d*l,h*l,p*o,m*o,s.near,s.far):c.makeOrthographic(d*l,h*l,p*o,m*o,s.near,s.far),s.updateMatrixWorld(),s.matrixWorldInverse.copy(s.matrixWorld).invert(),u.multiplyMatrices(c,s.matrixWorldInverse),a.setFromProjectionMatrix(u),!s.isPerspective){const n=(e,t,i,r,n)=>{const s=[this.viewer.worldToDrawing(this.viewer.clientToWorld({x:t,y:i,z:0})),this.viewer.worldToDrawing(this.viewer.clientToWorld({x:r,y:n,z:0})),this.viewer.worldToDrawing(this.viewer.clientToWorld({x:r,y:n,z:1}))];a.planes[e].setFromCoplanarPoints(...s)};n(0,e,i,e,r),n(1,t,r,t,i),n(2,e,r,t,r),n(3,t,i,e,i)}}getCameraName(){return this.camera===this.viewer.defaultCamera?this.camera.isPerspective?"persp":"orth":this.camera.name}getCameraInfo(){var e=new r.CameraInfo(this.getCameraName(),this.camera.position,this.camera.target,this.camera.up);return JSON.stringify(e)}adjustCameraUp(){this.camera.realUp.y>0?this.camera.up.set(0,1,0):this.camera.realUp.y<0?this.camera.up.set(0,-1,0):this.camera.realUp.x>0?this.camera.up.set(1,0,0):this.camera.realUp.x<0?this.camera.up.set(-1,0,0):this.camera.realUp.z>0?this.camera.up.set(0,0,1):this.camera.realUp.z<0&&this.camera.up.set(0,0,-1)}getWorldRight(){var e=new THREE.Vector3,t=this.camera.up,i=this.camera.direction(h);return e.crossVectors(i,t),0===e.lengthSq()&&(t.z>t.y?i.y-=1e-4:i.z+=1e-4,e.crossVectors(i,t)),e.normalize()}getWorldRightByRealUp(){var e=new THREE.Vector3,t=this.camera.realUp,i=this.camera.direction(h);return e.crossVectors(i,t),0===e.lengthSq()&&(t.z>t.y?i.y-=1e-4:i.z+=1e-4,e.crossVectors(i,t)),e.normalize()}getWorldUp(){var e=this.getWorldRight(),t=this.camera.direction(h);return e.cross(t).normalize()}getWorldPointFromNearPlane(e,t){var i=new THREE.Vector3(e,t,0);return i.unproject(this.camera),i}setCameraPosition(e){var t=this.camera,i=this.camera.direction(),r=i.length(),a=i.clone();a.normalize(),a.setLength(r),t.position.copy(e),t.target.addVectors(t.position,a),this.dirtyCamera(!0),this.setCameraChanging(!0)}moveStraight(e,t){var i=this.camera.position,r=this.camera.target;if(t){var a=new THREE.Vector3(r.x-i.x,0,r.z-i.z),n=e/a.length(),s=new THREE.Vector3(a.x*n,0,a.z*n);i.add(s),r.add(s)}else{var o=r.clone().sub(i);this.camera.translateZ(-e),r.addVectors(i,o)}}getIntersectContext(e){return this.userInputHelper.getIntersectContext(e)}getLastIntersect(){return this.intersector.lastIntersect}touchUpdateRotationInPersonView(t,i){this.dirtyCamera(!0),this.setCameraChanging(!0);var a=this,n=this.camera.position,s=this.camera.target.clone().sub(n).length();this.camera.getWorldDirection(l);var o=this.camera.realUp||this.camera.up,d=l.clone().cross(o).normalize(),h=d.clone().cross(l).normalize();this.camera.realUp.copy(h);const c=r.EditorConfig.LockAxisZRange;var u,p;if(Math.abs(t)>Math.abs(i))u=e,p=t;else{if(r.EditorConfig.LockAxisZ&&!y(this.camera,i,this.camera.target,c))return;u=d;var m=new THREE.Vector3(0,1,0).clone().cross(o),f=m.dot(d),g=Math.asin(m.length());f<0&&(g=-g),g+i>Math.PI/4-r.Math.EPSILON6?i=Math.PI/4-r.Math.EPSILON6-g:g+i<-Math.PI/4+r.Math.EPSILON6&&(i=-Math.PI/4+r.Math.EPSILON6-g),p=i}var v,M,E=(new THREE.Quaternion).setFromAxisAngle(u,p);v=E,M=new THREE.Vector3,l.applyQuaternion(v).normalize(),M.copy(n).add(l.multiplyScalar(s)),a.camera.target.copy(M),this.camera.realUp.applyQuaternion(E).normalize()}touchUpdateRotationInModelView(t,i,a){this.dirtyCamera(!0),this.setCameraChanging(!0);var n=a||this.scene.getBoundingBox().getCenter(d),s=this.camera.position,o=this.camera.target.clone().sub(s).length(),h=s.clone().sub(n),c=h.length(),u=null;this.camera.getWorldDirection(l),h.normalize();const p=this;var m,f=function(e){var t=new THREE.Vector3,i=h.clone().applyQuaternion(e).normalize();s.copy(n).add(i.multiplyScalar(c)),l.applyQuaternion(e).normalize(),t.copy(s).add(l.multiplyScalar(o)),p.camera.target.copy(t)},g=this.camera.up,M=l.clone().cross(g).normalize(),E=M.clone().cross(l).normalize();if(this.camera.realUp.copy(E),r.EditorConfig.LockAxisZ){if(Math.abs(t)>Math.abs(i))m=e,f(u=(new THREE.Quaternion).setFromAxisAngle(m,t)),this.camera.realUp.applyQuaternion(u).normalize();else if(null!=r.EditorConfig.LockAxisZRange&&Math.abs(i)>1e-4){const e=r.EditorConfig.LockAxisZRange;y(this.camera,i,n,e)&&(m=l.clone().cross(g).normalize(),f(u=(new THREE.Quaternion).setFromAxisAngle(m,i)),this.camera.realUp.applyQuaternion(u).normalize(),this.adjustCameraUp())}}else if(Math.abs(t)>Math.abs(i))(Math.abs(l.y+1)<1e-4||Math.abs(l.y-1)<1e-4)&&(m=l.clone().cross(this.camera.realUp).normalize(),f(u=(new THREE.Quaternion).setFromAxisAngle(m,.1)),this.camera.realUp.applyQuaternion(u).normalize(),this.adjustCameraUp()),m=l.y>0&&this.camera.realUp.y<0?new THREE.Vector3(0,-1,0):new THREE.Vector3(0,1,0),f(u=(new THREE.Quaternion).setFromAxisAngle(m,t)),this.camera.realUp.applyQuaternion(u).normalize();else if(Math.abs(i)>.01){m=l.clone().cross(this.camera.realUp).normalize();var b=new THREE.Vector3(0,1,0).clone().cross(g),I=b.dot(M),x=Math.asin(b.length());I<0&&(x=-x),x+i>Math.PI/2-r.Math.EPSILON6?i=Math.PI/2-r.Math.EPSILON6-x:x+i<-Math.PI/2+r.Math.EPSILON6&&(i=-Math.PI/2+r.Math.EPSILON6-x),f(u=(new THREE.Quaternion).setFromAxisAngle(m,i)),this.camera.realUp.applyQuaternion(u).normalize(),this.adjustCameraUp()}this.pivotBallGroup||function(e){e.pivotBallGroup=e.scene.getOrCreateObjectGroup(r.ObjectGroupType.PIVOTBALL,{priority:10,globalSpace:!1});var t=new THREE.SphereBufferGeometry(15,64,64),i=new THREE.Mesh(t,new r.PhongLightingMaterial({color:16777215,depthTest:!1,opacity:.5,transparent:!0,side:THREE.DoubleSide}));t=new THREE.SphereBufferGeometry(1,64,64);var a=new THREE.Mesh(t,new r.PhongLightingMaterial({color:16711680,depthTest:!1,opacity:.5,transparent:!0,side:THREE.DoubleSide}));e.pivotBallGroup.add(i),e.pivotBallGroup.add(a)}(this),this.pivotBallGroup.visible=!0;for(var T=function(e){var t=e.camera,i=t.position,r=e.camera.target.clone().sub(i);r.normalize();var a=new THREE.Plane;a.setFromNormalAndCoplanarPoint(r.clone().negate(),v(e)),a.normalize();var n=a.distanceToPoint(i)*Math.tan(.5*t.fov),s=e.getContainerDimensions();return 2*n/(s.height-s.top)}(this),_=v(this),S=0;S<this.pivotBallGroup.children.length;S++){var C=this.pivotBallGroup.children[S];C.position.copy(_),C.scale.set(T,T,T),C.updateMatrixWorld()}}touchUpdateRotation(e,t){var i=this.camera.position;this.scene.getBoundingBox().containsPoint(i)?this.touchUpdateRotationInPersonView(e,t):this.touchUpdateRotationInModelView(e,t,v(this))}clearTouchRotateState(){this.pivotBallGroup&&(this.pivotBallGroup.visible=!1)}touchEndHandler(){this.viewer.editorManager.cameraChange=!1,this.clearTouchRotateState(),this.touchUpdate()}touchUpdate(){var e=new THREE.Vector3;e.copy(this.camera.up),this.camera.up.copy(this.camera.realUp),this.camera.lookAt(this.camera.target),this.camera.up.copy(e),this.camera.updateMVP(),(s.distanceToSquared(this.camera.position)>r.Math.EPSILON6||8*(1-o.dot(this.camera.quaternion))>r.Math.EPSILON6)&&(this._changeCallBack(),this.dirtyCamera(!1),s.copy(this.camera.position),o.copy(this.camera.quaternion))}goTurnForWalk(e){var t=this.getCamera(),i=t.position,r=t.target,a=new THREE.Vector3(r.x-i.x,0,r.z-i.z),n=Math.cos(e),s=Math.sin(e),o=new THREE.Vector3(a.x*n-a.z*s,0,a.x*s+a.z*n);r.x=i.x+o.x,r.z=i.z+o.z,this.dirtyCamera(!0),this.setCameraChanging(!0)}goPitchForWalk(e){var t=this.getCamera(),i=t.position,r=t.target,a=r.x-i.x,n=r.z-i.z,s=Math.sqrt(a*a+n*n),o=new THREE.Vector3(s,r.y-i.y,0),l=Math.cos(e),d=Math.sin(e),h=new THREE.Vector3(o.x*l-o.y*d,o.x*d+o.y*l,0);r.y=i.y+h.y,this.dirtyCamera(!0),this.setCameraChanging(!0)}goUpDownForWalk(e,t){var i=this.getCamera(),r=i.position,a=i.target,n=i.up,s=g(i,this.scene.getMatrixGlobal(),n,e);t&&(t.position.z+=s.stepDiffWorld.z,t.box.min.z+=s.stepDiffWorld.z,t.box.max.z+=s.stepDiffWorld.z),r.y+=s.stepDiffDrawing.y,a.y+=s.stepDiffDrawing.y,this.dirtyCamera(!0),this.setCameraChanging(!0)}stepCameraForWalk(e,t,i){var a,n=this.getCamera(),s=n.position,o=n.target,l=new THREE.Vector3(o.x-s.x,0,o.z-s.z).normalize(),d=new THREE.Vector3(0,1,0),h=l.clone().cross(d),c=this.scene.getMatrixGlobal();switch(e){case r.MoveDirection.FORWARD:a=g(n,c,l,t);break;case r.MoveDirection.BACK:l.multiplyScalar(-1),a=g(n,c,l,t);break;case r.MoveDirection.LEFT:h.multiplyScalar(-1),a=g(n,c,h,t);break;case r.MoveDirection.RIGHT:a=g(n,c,h,t)}if(a.stepDiffDrawing.y=0,a.stepDiffWorld.z=0,i)return a;s.add(a.stepDiffDrawing),o.add(a.stepDiffDrawing),this.dirtyCamera(!0),this.setCameraChanging(!0)}hitTestWithGround(e){var t=this.getCamera(),i=t.up.clone().multiplyScalar(-1);if(e){let t=e.position;d.set(t.x,t.y,e.box.max.z)}var r=e?this.scene.worldToDrawing(d):t.position.clone(),a=new THREE.Ray(r,i),n=this.getIntersectContext(null),s=this.intersector.byGravity;this.intersector.byGravity=!0;var o=this.intersector.intersect(n,a,!1);return this.intersector.byGravity=s,o}hitTestForward(e,t){var i=this.getCamera(),r=this.camera.direction();r.normalize(),r=r.multiplyScalar(e);let a,n=[];const s=this.getIntersectContext(null);if(t)n=this.intersector.intersectByBox(s,t);else{a=i.position.clone();const e=new THREE.Ray(a,r),t=this.intersector.intersect(s,e,!1);t&&n.push(t)}return n}hitTestRight(e,t){//!!
var i=this.getCamera(),r=this.camera.direction();r.normalize();var a=i.up,n=r.cross(a).normalize();let s;n=n.multiplyScalar(e);let o=[];var l=this.getIntersectContext(null);if(t)o=this.intersector.intersectByBox(l,t);else{s=i.position.clone();const e=new THREE.Ray(s,n),t=this.intersector.intersect(l,e,!1);t&&o.push(t)}return o}computeGravity(e){this.gravity=0;var t=this.hitTestWithGround(e);if(null==t){var i=this.scene.getMatrixGlobal();n.copy(i).invert();var r=this.camera.position.clone();r.applyMatrix4(n),r.z=0,r.applyMatrix4(i),this.distanceToGround=Math.abs(this.camera.position.y-r.y),null!=this.hitNullCount&&0!=this.hitNullCount||(this.hitNullCount=1)}else this.hitNullCount=0;if(1!=this.hitNullCount)if(void 0===this.manHeight)this.computeManHeight(e);else{var a=t?t.distance-this.manHeight:this.distanceToGround-this.manHeight;if(a/=this.scene.getGlobalScaleFactor(),Math.abs(a)<.1)return;this.gravity=a}else this.gravity=0}computeManHeight(e){let t;if(t=this.viewer.modelManager.isMeterUnit()?.001:1,!this.manHeight){var i=this.hitTestWithGround(e),r=e?.94*e.box.getSize(d).z:1650*t,a=this.scene.getMatrixGlobal();if(n.copy(a).invert(),null!=i){var s=i.point.clone();s.applyMatrix4(n),s.z+=r,s.applyMatrix4(a),this.manHeight=Math.abs(i.point.y-s.y)}else{var o=e?e.box.min.clone():this.camera.position.clone();o.applyMatrix4(n),o.z=0;var l=o.clone();l.z+=r,o.applyMatrix4(a),l.applyMatrix4(a),this.manHeight=Math.abs(l.y-o.y)}}}walkWithParallelEye(){var e=this.camera,t=this.camera.direction().length(),i=this.scene.getBoundingBox().getCenter(d),r=new THREE.Vector3;r.subVectors(i,e.position);var a=r.length();r.y=0,r.normalize(),r.multiplyScalar(a),e.position.subVectors(i,r),e.target.addVectors(e.position,r.normalize().multiplyScalar(t));var n=new THREE.Vector3(0,1,0);e.up.copy(n),e.realUp.copy(n),this.dirtyCamera(!0),this.setCameraChanging(!0),this.update(!0)}updateFlyMove(e,t){var i=this.camera;this.dirtyCamera(!0),this.setCameraChanging(!0);var a=r.MoveDirection;e&a.FORWARD&&i.translateZ(-t),e&a.BACK&&i.translateZ(t),e&a.LEFT&&i.translateX(-t),e&a.RIGHT&&i.translateX(t),e&a.UP&&i.translateY(t),e&a.DOWN&&i.translateY(-t),this.flyOnWorld()}flyOnWorld(e){var t=this.camera,r=t.up.clone();(e=!1!==e)&&t.realUp&&(t.up.copy(t.realUp),t.lookAt(t.target),t.up.copy(r)),this._changeCallBack(),this.dirtyCamera(!1),i.copy(t.position),a.copy(t.quaternion)}rotateForFly(e,t,i,a){var n=this.camera,s=n.position,o=n.target,l=o.clone().sub(s),d=new THREE.Vector3(0,1,0),h=n.realUp||n.up,c=l.clone().cross(h).normalize();if(this.dirtyCamera(!0),this.setCameraChanging(!0),r.EditorConfig.LockAxisZ&&(t=0),0!=t){var u=(new THREE.Quaternion).setFromAxisAngle(c,-t),p=l.clone();p.applyQuaternion(u);var m=p.angleTo(d);(m-=.5*Math.PI)>=i&&m<=a&&l.applyQuaternion(u)}if(0!=e){var f=(new THREE.Quaternion).setFromAxisAngle(d,-e);l.applyQuaternion(f)}o.addVectors(s,l),this.flyOnWorld()}fitAndRotateBySelection(){this.viewer.zoomToSelection()}flyToPointWithParallelEye(e){var t=this.camera.direction(),i=t.length(),r=t.clone();r.y=0,r.normalize(),r.setLength(i);var a=new THREE.Vector3(0,1,0);this.camera.up=a,this.camera.realUp=a.clone(),this.camera.position.copy(e),this.camera.target.addVectors(this.camera.position,r),this.update(!0)}flyToPoint(e){var t=this.camera.direction();this.camera.position.copy(e),this.camera.target.addVectors(this.camera.position,t),this.update(!0)}setCameraHeight(e,t){this.cameraAbsoluteHeightEnabled=!1,this.cameraRelativeHeight=t,void 0===this.cameraConstraintHeights?this.cameraConstraintHeights=[]:this.cameraConstraintHeights.length=0;for(var i=0,r=e.length;i<r;++i)this.cameraConstraintHeights[i]=e[i]}updateCameraHeight(){var e,t,i=this.scene,a=this.getCamera(),n=i.drawingToWorld(a.position),s=n.z;if(this.cameraAbsoluteHeightEnabled)void 0===this.cameraAbsoluteHeight&&(this.cameraAbsoluteHeight=s),e=this.cameraAbsoluteHeight;else if(void 0===this.cameraConstraintHeights)e=s;else{var o=r.Utils.findRange(this.cameraConstraintHeights,s);if(e=this.cameraConstraintHeights[o],e+=this.cameraRelativeHeight,o<this.cameraConstraintHeights.length-1){var l=this.cameraConstraintHeights[o+1];e>l&&(e=l)}}e!==s&&(t=i.worldToDrawing({x:n.x,y:n.y,z:e}),this.setCameraPosition(t))}getRaycaster(e,t){var i=new r.Raycaster,a=new THREE.Vector2;return this.userInputHelper.clientToViewport(e,t,a),i.setFromCamera(a,this.camera),i}translateCameraForWalk(e,t){var i=this.collisionManager;if(0!==e.x){if(!1===r.GlobalData.EnableHitDetection)return void this.stepCameraForWalk(r.MoveDirection.RIGHT,e.x*t);var a=1;e.x<0&&(a=-1);var n=this.hitTestRight(a);if(0==n.length)this.stepCameraForWalk(r.MoveDirection.RIGHT,e.x*t);else{var s=(h=this.viewer.modelManager.getNodeInfosByUserId(n[0].userId))?h[0].userData:null;0==i.hasCollision(s,n[0].distance)&&this.stepCameraForWalk(r.MoveDirection.RIGHT,e.x*t)}}if(0!==e.y)this.goUpDownForWalk(e.y*t*.5);else if(r.GlobalData.WalkingWithGravity){var o=t;if(0!=this.gravity){var l=Math.abs(this.gravity);o=o>=l?l:.2*l}this.gravity>0?this.goUpDownForWalk(-o):this.gravity<0&&this.goUpDownForWalk(o)}if(0!==e.z){if(!1===r.GlobalData.EnableHitDetection)return void this.stepCameraForWalk(r.MoveDirection.BACK,e.z*t);a=1;e.z>0&&(a=-1);var d=this.hitTestForward(a);if(0==d.length)this.stepCameraForWalk(r.MoveDirection.BACK,e.z*t);else{var h;s=(h=this.viewer.modelManager.getNodeInfosByUserId(d[0].userId))?h[0].userData:null;0==i.hasCollision(s,d[0].distance)&&this.stepCameraForWalk(r.MoveDirection.BACK,e.z*t)}}}translateCameraForThirdpersonWalk(e,t,i,a){var n=this.collisionManager;if(i.box.getSize(m),p.set(i.box.min,i.box.max),p.min.z+=.5*m.z,p.max.z-=.2*m.z,0!==e.x){let d=this.stepCameraForWalk(r.MoveDirection.RIGHT,e.x*t,i);var s=1;if(e.x<0&&(s=-1),p.min.add(d.stepDiffWorld),p.max.add(d.stepDiffWorld),!1===r.GlobalData.EnableHitDetection)return void this.stepObjectForWalk(d,i,p,a,0);var o=this.hitTestRight(s,p);let h=!1;for(let e=0;e<o.length;e++){let t=o[e];var l=(u=this.viewer.modelManager.getNodeInfosByUserId(t))?u[0].userData:null;if(h=n.hasCollision(l,0),h)break}h||this.stepObjectForWalk(d,i,p,a,0)}if(0!==e.y)this.goUpDownForWalk(e.y*t*.5,i);else if(r.GlobalData.WalkingWithGravity){var d=t;if(0!=this.gravity){var h=Math.abs(this.gravity);d=d>=h?h:.2*h}this.gravity>0?this.goUpDownForWalk(-d,i):this.gravity<0&&this.goUpDownForWalk(d,i)}if(0!==e.z){let o=this.stepCameraForWalk(r.MoveDirection.BACK,e.z*t,i);s=1;if(e.z>0&&(s=-1),p.min.add(o.stepDiffWorld),p.max.add(o.stepDiffWorld),!1===r.GlobalData.EnableHitDetection)return void this.stepObjectForWalk(o,i,p,a,s);var c=this.hitTestForward(s,p);let d=!1;for(let e=0;e<c.length;e++){let t=c[e];var u;l=(u=this.viewer.modelManager.getNodeInfosByUserId(t))?u[0].userData:null;if(d=n.hasCollision(l,0),d)break}d||this.stepObjectForWalk(o,i,p,a,s)}}checkCollisionInCameraAndObject(e){if(!e)return null;var t=this.getCamera();let i=e.position;d.set(i.x,i.y,i.z);var r=this.scene.worldToDrawing(d);let a=new THREE.Vector3;a.subVectors(t.position,r),a.normalize();const n=this.getIntersectContext(null),s=new THREE.Ray(r,a),o=this.intersector.intersect(n,s,!1);if(o){var l=t.position.distanceTo(r);if(o.distance<l&&o.userId!=e.name)return o.point.addVectors(o.point,a.multiplyScalar(-1))}return null}stepObjectForWalk(e,t,i,r,a){function n(e,t){return!(t.x<e.min.x||t.x>e.max.x||t.y<e.min.y||t.y>e.max.y)}var s=this.scene.getBoundingBoxWorld();if(!n(s,i.min)||!n(s,i.max))return;t.box.min.add(e.stepDiffWorld),t.box.max.add(e.stepDiffWorld),t.position.add(e.stepDiffWorld);var o=this.getCamera(),l=o.position,h=o.target;let c=0,u=t.position;switch(a>=0?(this.checkCollisionInCameraAndObject(t)?c=1:1==a&&(d.set(u.x,u.y,t.box.max.z),o.getDistanceByPos(d,this.scene.getMatrixGlobal())<r&&(c=2)),f=!1):(l.add(e.stepDiffDrawing),h.add(e.stepDiffDrawing),c=2,this.checkCollisionInCameraAndObject(t)?(c=-1,f=!0):f&&(f=!1,c=3)),c){case 0:l.add(e.stepDiffDrawing),h.add(e.stepDiffDrawing);break;case 1:var p=this.camera.direction();d.set(u.x,u.y,t.box.max.z);var m=this.scene.worldToDrawing(d);l.set(m.x,m.y,m.z),h.addVectors(l,p);break;case 2:break;case 3:d.set(u.x,u.y,t.box.max.z);let i=new THREE.Vector3;i.copy(e.stepDiffWorld),i.normalize();let a=this.scene.worldToDrawing(d),n=this.scene.worldToDrawing(d.addVectors(d,i.multiplyScalar(r)));l.set(n.x,n.y,n.z),h.set(a.x,a.y,a.z);this.checkCollisionInCameraAndObject(t);break;case-1:l.sub(e.stepDiffDrawing),h.sub(e.stepDiffDrawing)}this.dirtyCamera(!0),this.setCameraChanging(!0)}rotateCameraForWalk(e,t){0!==e.y&&(this.goTurnForWalk(-e.y*Math.PI*t),e.y=0),0!==e.x&&(this.goPitchForWalk(e.x*Math.PI),e.x=0)}movePlane(e,t,i,r,a){if(null==a){var n=new THREE.Plane;n.setComponents(e.x,e.y,e.z,e.w),a=new THREE.Vector3,n.coplanarPoint(a)}var s=new THREE.Vector3(e.x,e.y,e.z),o=this.camera.getWorldDirection(d),l=new THREE.Plane;l.setFromNormalAndCoplanarPoint(o,a);var h=this.getRaycaster(t.clientX,t.clientY),c=new THREE.Vector3,u=this.getRaycaster(i.x,i.y),p=new THREE.Vector3;if(h.ray.intersectPlane(l,c)&&u.ray.intersectPlane(l,p)){c.subVectors(c,p),c.projectOnVector(s);var m=c.length();if(c.dot(s)<0&&(m=-m),0!=m)return r&&(s.multiplyScalar(m),m=s.x+s.y+s.z),m}return null}getZenith(){var t=this.camera.position,i=this.viewer.getBoundingBox().getCenter(d);return t.clone().sub(i.clone()).clone().angleTo(e.clone())}getAzimuth(){var i=camera.position,r=this.viewer.getBoundingBox().getCenter(d),a=i.clone().sub(r.clone()).clone().projectOnPlane(e.clone()),n=a.angleTo(t.clone());return a.x<0&&(n=360-n),n}getCurrentRangeofCamera(){var e=this.viewer,t=this.camera,i=e.getBoundingBox(),r=t.position,a=.5*i.getSize(d).length()/Math.tan(THREE.Math.degToRad(.5*t.fov));return i.getCenter(d).distanceTo(r)/a}setMaximalRangeofCamera(e=2){this.farFactor=e,this.userInputHelper.boundaryLimitFactor=e}getMaximalRangeofCamera(){return this.farFactor}cameraWithinMaximumRange(e){var t=e||this.farFactor;return!(this.getCurrentRangeofCamera()>t)}resetCameraToMaximumRange(e){const t=this.viewer,i=this.camera,r=t.getBoundingBox(),a=i.position;var n=e||this.farFactor,s=.5*r.getSize(d).length()/Math.tan(THREE.Math.degToRad(.5*i.fov));const o=r.getCenter(d);var l=(new THREE.Vector3).subVectors(o,a);l.setLength(n*s);var h=o.clone().sub(l),c=this.camera.direction();this.camera.position.copy(h),this.camera.target.copy(c.add(h)),this.updateView(!0)}zoomToHeight(e){const t=e.destination;if(!r.Utils.isDefined(t))return void console.log("destination is required");if(!r.Utils.isDefined(e.globe))return void console.log("globe object is required");const i=r.Tile.TileMath.fromDegreesYUp(t.lon,t.lat,t.height,e.globe.radius),a=this.camera;var n={position:a.position.clone(),target:a.target.clone(),up:a.realUp.clone()||a.up.clone(),zoom:a.zoom};const s={position:i,target:a.target.clone(),up:a.realUp.clone()||a.up.clone(),zoom:a.zoom},o=this.viewer,l=this;return new Promise(((e,t)=>{const i=new r.CameraAnimator;i.setDuration(2e3),i.active(n,s,o,(function(e){l.update(!0,!0)}),(function(){e()}))}))}setObjectOffset(e){if(!r.Utils.isDefined(e))return void console.warn("The parameter offset is undefined.");if("number"!=typeof e)return void console.warn("The parameter offset is not a number.");let t=r.Math.clamp(e,.2,100);this.userInputHelper._minObjectOffset=t}getObjectOffset(){return this.userInputHelper._minObjectOffset}}}(),(()=>{let e=new THREE.Matrix4;new THREE.Matrix4;r.PickUtil=class{constructor(){}static pickByRect(e,t,i,a,n,s,o){var l;if(!s&&!o)return[];l=s&&o?o.x>s.x?"window":"cross":"window";var d={},h=a.modelManager,c=h.getOctreeRoots(),u=h.getOctantMap(),p=h.getSceneState(),m=e.getMatrixGlobal(),f=new THREE.Box3,g=new THREE.Vector3(Math.min(s.x,o.x),Math.min(s.y,o.y),0),v=new THREE.Vector3(Math.max(s.x,o.x),Math.max(s.y,o.y),0),y=new THREE.Box3(g,v);function M(e){for(var t=new THREE.Vector3,i=0;i<8;++i)if(t.x=i<4?e.min.x:e.max.x,t.y=i/2<2?e.min.y:e.max.y,t.z=i%2==0?e.min.z:e.max.z,!a.clipPoint(t))return!1;return!0}function E(e,i){if(f.set(e.min,e.max),t.intersectsBox(f)){i.push(e);for(var r=0,a=e.childOctants.length;r<a;++r){E(e.childOctants[r],i)}}}function b(e,i){if(n=i,s=h.isHiddenSourceObjectUserId(n.userId),C&&!S._isVisible(n)||w&&!S._isPickable(n)||s)return;var n,s;let o=new THREE.Box3;o.copy(i.boundingBox),o.applyMatrix4(A).applyMatrix4(m),M(o)||("window"!==l||N[i.userId]?"cross"!==l||H[i.userId]||("in"===r.GeomUtil.intersectBox(t,o)||"intersect"===r.GeomUtil.intersectBox(t,o)&&function(e,t){var i=[];a.modelManager.traverseModels((function(t){i=i.concat(t.getGeometryBuffersByUserId(e))})),i.sort(((e,t)=>e.index.length-t.index.length));for(var n=0;n<i.length;n++)for(var s=i[n].position,o=i[n].index,l=i[n].matrix,d=0;d<o.length;d+=3){var h=new THREE.Vector3(s[3*o[d]],s[3*o[d]+1],s[3*o[d]+2]),c=new THREE.Vector3(s[3*o[d+1]],s[3*o[d+1]+1],s[3*o[d+1]+2]),u=new THREE.Vector3(s[3*o[d+2]],s[3*o[d+2]+1],s[3*o[d+2]+2]);l&&(h.applyMatrix4(l),c.applyMatrix4(l),u.applyMatrix4(l)),t&&(h.applyMatrix4(t),c.applyMatrix4(t),u.applyMatrix4(t));var p=a.worldToClient(h),m=a.worldToClient(c),f=a.worldToClient(u),g=new THREE.Vector3(p.x,p.y,0),v=new THREE.Vector3(m.x,m.y,0),M=new THREE.Vector3(f.x,f.y,0),E=new THREE.Triangle(g,v,M);if(r.GeomUtil.boxIntersectsTriangle(y,E))return!0}return!1}(i.userId,A))&&(e[i.userId]=!0,H[i.userId]=!0):"in"===r.GeomUtil.intersectBox(t,o)||"intersect"===r.GeomUtil.intersectBox(t,o)&&function(e,i){var r=[],n=[];a.modelManager.traverseModels((function(t){r=r.concat(t.getGeometryBuffersByUserId(e))}));for(var s=0;s<r.length;s++)for(var o=r[s].position,l=r[s].matrix,d=0;d<o.length;d+=3){var h=new THREE.Vector3(o[d],o[d+1],o[d+2]);l&&h.applyMatrix4(l),i&&h.applyMatrix4(i),h.applyMatrix4(m),n.push(h)}var c=!0;return n.every((e=>(t.containsPoint(e)||(c=!1),c))),c}(i.userId,A)?e[i.userId]=!0:(N[i.userId]=!0,delete e[i.userId]))}function I(e,t,a){let s=[];return Object.keys(t).map((t=>{const i=e.getRealUserId(t);i&&s.push(i)})),s.length>0&&!1!==n&&(r.OPSELECTIONTYPE.Remove===i&&a.removeSelection(s,e.id),r.OPSELECTIONTYPE.Add===i&&a.addSelection(s,e.id)),s}var x,T,_,S=h.getFilter(),C=S._hasVisibleFilter(),w=S._hasPickableFilter();function R(e){const i=e.getUserIdMapByFrustum(t),r=e.getDescriptor();for(const e in i)r.getNodeInfoByUserIdCallback(e,(e=>{const t=e.nodeInfo;b(d,t)}));return I(e,d,p)}if(i===r.OPSELECTIONTYPE.Clear)return void p.clearSelection();let B=[];for(var L in c){x=[],d={},_=u[L],T=c[L];var O=a.modelManager.modelCollection.getById(L);if(O){var P,D,A=O.transformMatrix.clone(),N={},H={};for(O.tilesLoader&&R(O),P=0,D=T.length;P<D;P++)E(T[P],x);for(P=0,D=x.length;P<D;P++){var U=_.info[x[P].octantId];if(U)for(var F=0,k=U.length;F<k;F++){var G=U[F];b(d,G)}}B=B.concat(I(O,d,p))}}function V(e){for(var t=e.geometry.attributes.position.array,i=e.matrix,n=0;n<t.length;n+=9){var s=new THREE.Vector3(t[n],t[n+1],t[n+2]),o=new THREE.Vector3(t[n+3],t[n+4],t[n+5]),l=new THREE.Vector3(t[n+6],t[n+7],t[n+8]);i&&(s.applyMatrix4(i),o.applyMatrix4(i),l.applyMatrix4(i));var d=a.worldToClient(s),h=a.worldToClient(o),c=a.worldToClient(l),u=new THREE.Vector3(d.x,d.y,0),p=new THREE.Vector3(h.x,h.y,0),m=new THREE.Vector3(c.x,c.y,0),f=new THREE.Triangle(u,p,m);if(r.GeomUtil.boxIntersectsTriangle(y,f))return!0}return!1}function j(e){for(var i=[],r=e.geometry.attributes.position.array,a=e.matrix,n=0;n<r.length;n+=3){var s=new THREE.Vector3(r[n],r[n+1],r[n+2]);a&&s.applyMatrix4(a),s.applyMatrix4(m),i.push(s)}var o=!0;return i.every((e=>(t.containsPoint(e)||(o=!1),o))),o}const z=a.getScene().getObjectGroup(r.ObjectGroupType.EXTRUDEBODYMANAGER),W=[];if(z){for(let e=0;e<z.children.length;e++){let i=z.children[e];if(i.name.indexOf("wireframe_")<0&&i.visible){let e=new THREE.Box3;if(e.copy(i.geometry.boundingBox),e.applyMatrix4(i.matrix).applyMatrix4(m),M(e))return;"window"===l?("in"===r.GeomUtil.intersectBox(t,e)||"intersect"===r.GeomUtil.intersectBox(t,e)&&j(i))&&W.push(i.name):"cross"===l&&("in"===r.GeomUtil.intersectBox(t,e)||"intersect"===r.GeomUtil.intersectBox(t,e)&&V(i))&&W.push(i.name)}}W.length>0&&!1!==n&&(r.OPSELECTIONTYPE.Remove===i&&p.removeSelection(W),r.OPSELECTIONTYPE.Add===i&&p.addSelection(W)),B=[...B,...W]}return B}static getObjectsInBox(e,t,i,r){var a={},n=i.getOctreeRoots(),s=i.getOctantMap(),o=e.getMatrixGlobal(),l=new THREE.Box3;function d(e){for(var t=new THREE.Vector3,i=0;i<8;++i)if(t.x=i<4?e.min.x:e.max.x,t.y=i/2<2?e.min.y:e.max.y,t.z=i%2==0?e.min.z:e.max.z,!r.clipPoint(t))return!1;return!0}function h(e){return!(e.max.x<t.min.x||e.min.x>t.max.x||e.max.y<t.min.y||e.min.y>t.max.y||e.max.z<t.min.z||e.min.z>t.max.z)}function c(e){return e.max.x>=t.max.x&&e.min.x<=t.min.x&&e.max.y>=t.max.y&&e.min.y<=t.min.y&&e.max.z>=t.max.z&&e.min.z<=t.min.z}function u(e,t){if(l.set(e.min,e.max),h(l)){t.push(e);for(var i=0,r=e.childOctants.length;i<r;++i){u(e.childOctants[i],t)}}}var p,m,f=i.getFilter(),g=f._hasVisibleFilter(),v=f._hasPickableFilter();for(var y in n){var M,E,b=[],I=s[y],x=n[y],T=r.modelManager.modelCollection.getById(y).transformMatrix.clone();for(M=0,E=x.length;M<E;M++)u(x[M],b);for(M=0,E=b.length;M<E;M++){var _=I.info[b[M].octantId];if(_)for(var S=0,C=_.length;S<C;S++){var w=_[S];(p=w,m=void 0,m=i.isHiddenSourceObjectUserId(p.userId),g&&!f._isVisible(p)||v&&!f._isPickable(p)||m)||(l.copy(w.boundingBox),l.applyMatrix4(T).applyMatrix4(o),!h(l)||c(l)||d(l)||(a[w.userId]=!0))}}const e=r.modelManager.getModel(y);if(e.tilesLoader){if(!e.isUserIdDataReady())return;e.tilesLoader.tileReader.searchTreeManager.getObjectsInBoxByBimtile(a,e,t,o,c)}}return Object.keys(a)}},r.IntersectContext=class{constructor(){this.scene=null,this.camera=null,this.octreeRoots=null,this.octantMap=null,this.mouse=new THREE.Vector2}},r.IntersectHelper=class{constructor(e){this.viewer=e,this.filter=e.getFilter(),this.raycaster=new r.Raycaster,this.lastIntersect=null,this.highPriorities=[r.ObjectGroupType.EXTRUDEBODYMANAGER],this._ground=null,this._pickedLocalPos=null,this._pickedWorldPos=null}destroy(){this.viewer=null,this.filter=null,this.raycaster=null,this.lastIntersect=null,this.highPriorities=null,this._ground=null,this._pickedLocalPos=null,this._pickedWorldPos=null}defaultIntersect(e,t,i,a,n){if(e.visible||n){var s=[];e.raycast(this.raycaster,s);var o=[];if(s.length>0)for(var l=0;l<s.length;l++)s[l].distance<=i.far&&s[l].distance>=i.near&&(e.name==r.GlobalData.TilePlaneGroupName||!this.viewer.clipPoint(s[l].point))&&null!=s[l]&&o.push(s[l]);return a?o:(o.sort((function(e,t){return e.distance-t.distance})),o.length>0?o[0]:null)}}intersectMeshesWithDistance(e,t,i){const{pickable:a,distanceScope:n,isExploded:s,bIsGetAllIntersects:o,modelTransform:l,modelId:d,hitBox:h}=i;if(!t||!t.mesh)return null;var c,u=r.Utils.MinusEpsilon,p=this.raycaster,m=[];const f=this.viewer.modelManager,g=f.getModel(d).filter,v=g._hasVisibleFilter(),y=g._hasPickableFilter(),M=f.getSceneUnit()===r.EnumLengthlUnits.Meter?.001:1,E=r.GlobalData.LineSelectRange/2*M;var b=function(e,t){var i=f.isHiddenSourceObjectUserId(e.userId,d);if(t){if(v&&!g._isVisible(e)||y&&!g._isPickable(e)||i)return!0}else if(v&&!g._isVisible(e)||i)return!0;return!1};1==this.byGravity?n.near=0:n.near+=u;var I,x,T=t.info,_=t.mesh,S=[],C=this.viewer.modelManager.getMatrixWorldGlobal();if(s){function k(e,t){if(t.push(e),e.childOctants)for(var i=0,r=e.childOctants.length;i<r;i++)k(e.childOctants[i],t)}for(I=0,x=e.length;I<x;I++)k(e[I],S)}else for(I=0,x=e.length;I<x;I++)p.intersectOctantForNode(e[I],S);for(I=0,x=S.length;I<x;I++){var w=T[S[I].octantId];if(w)for(var R=0,B=w.length;R<B;R++){var L=w[R];if(!b(L,a)){var O=L.boundingBox.clone();if("string"==typeof L.nodeId&&L.nodeId.indexOf("line")>-1&&O.expandByScalar(E),O.applyMatrix4(l),O.applyMatrix4(C),!((c=p.ray.intersectBoxWithDistance(O))<n.near||c>n.far)){var P=_[r.ModelView.BaseDescriptor.getMeshIdFromOctantMap(L)];if(P)for(var D=0,A=P.length;D<A;D++)m.push({object:P[D],distance:c,nodeInfo:L})}}}}if(m.sort((function(e,t){return e.distance-t.distance})),h){let G=p.ray.origin.clone(),V=p.ray.direction.clone();if(0===m.length)return null;let j=m[0].distance;return j=0===j?3:j,m[0].point=G.add(V.multiplyScalar(j)),m[0].object=m[0].object.object,m[0]}var N=[];const H=g.getLocalClippingList();for(I=0;I<m.length;I++)m[I].distance>n.far||m[I].distance<n.near||m[I].object.raycast(p,m[I].nodeInfo,n,this.viewer,N,o,H);if(N.sort((function(e,t){return e.distance-t.distance})),o){var U=[];for(I=0,x=N.length;I<x;I++){var F=N[I];U.push({object:F.object,distance:F.distance,matrix:F.object.matrix,userId:F.userId,face:F.face,point:F.point})}return U}return N.length>0?N[0]:null}intersect(e,t,i,a,n){var s=this.raycaster;if(a=!0===a,n=!0===n,null===t)s.setFromCamera(e.mouse,e.camera);else{var o=t.origin,l=t.direction;s.set(o,l)}s.camera=e.camera,s.viewportSize=e.viewportSize;var d={near:0,far:1/0};e.scene.shrinkScopeByClipPlane(s,d);var h=[],c=e.scene.getObjectGroups();this.viewer.terrainOperationManager;const u=this.viewer.holesManager;var p=new THREE.Vector2;this.viewer.cameraControl.mapViewportToWindow(e.mouse.x,e.mouse.y,p);let m=!1;u.pickExcavation(p)&&(m=!0);for(var f=0;f<c.length;f++){if(!c[f].isPickable()||0===c[f].children.length)continue;if(m)break;var g=null,v=e.scene.getObjectGroupType(c[f].name);if(this.highPriorities.indexOf(v.groupType)>-1){let e=this.defaultIntersect(c[f],i,d,!0,!0);e=e.filter((e=>{if(!0===e.object.isMesh)return e})),e.sort(((e,t)=>e.distance-t.distance)),(g=e[0])&&(g.databagId=v.databagId,g.objectType=c[f].pickableType,g.hoverEnabled=c[f].hoverEnabled,h.push(g));continue}const t=this.viewer.modelManager;let s=t.getModel(v.databagId),o=s?s.getTransformMatrix():new THREE.Matrix4,l=!1;switch(l=!!(s&&s.id&&t.explosionManager.isExploded(s.id)),v.groupType){case r.ObjectGroupType.MODEL:var y=v.databagId;if(e.octreeRoots[y]&&e.octantMap[y]){const t={pickable:i,distanceScope:d,isExploded:l,bIsGetAllIntersects:n,modelTransform:o,modelId:s.id,hitBox:a};g=this.intersectMeshesWithDistance(e.octreeRoots[y],e.octantMap[y],t)}break;case r.ObjectGroupType.GEOMETRY:for(var y in e.octreeRoots){const t={pickable:i,distanceScope:d,isExploded:l,bIsGetAllIntersects:n,modelTransform:o,modelId:y,hitBox:a};g=this.intersectMeshesWithDistance(e.octreeRoots[y],e.octantMap[y],t)}break;case r.ObjectGroupType.BIMTILESGROUP:if(s){const h=s.config.metadata.content,u=s.config.metadata.enableSelect;if(r.BimTilesVersionControl.isVersion_3(s.dataVersion)){const i=this.viewer.getRenderer();let r={};if(t.traverseValidModels((e=>{e.id!==s.id&&(r[e.id]=e.visible,e.visible=!1)})),g=s.pickHelper.render(i,e.scene,e.camera,e.pointer),t.traverseValidModels((e=>{void 0!==r[e.id]&&(e.visible=r[e.id])})),r=null,g)if(Array.isArray(g))for(var M of g){M.fileId=s.fileId,M.databagId=s.databagId;const e=this.viewer.drawingToWorld(M.point),t=this.raycaster.ray.origin.distanceTo(e);M.distance=t}else{g.fileId=s.fileId,g.databagId=s.databagId;const e=this.viewer.drawingToWorld(g.point),t=this.raycaster.ray.origin.distanceTo(e);g.distance=t}}else if(!0===r.TilesUtil.PICK_EFFECT_MODEL_TYPE[h]||u){const e={pickable:i,distanceScope:d,isExploded:l,bIsGetAllIntersects:n,modelTransform:o,hitBox:a};g=this.intersectBimTile(s,e)}else g=this.defaultIntersect(c[f],i,d);if(g){const e=s.tilesLoader.tileReader;if(Array.isArray(g))for(var M of g){const t=e.getUserIdByIndex(M.userId);M.userId=t}else{const t=e.getUserIdByIndex(g.userId);g.userId=t}}}break;default:g=this.defaultIntersect(c[f],i,d)}if(g)if(Array.isArray(g))for(var M of g)M.databagId=v.databagId,M.objectType=c[f].pickableType,M.hoverEnabled=c[f].hoverEnabled,h.push(M);else g.databagId=v.databagId,g.objectType=c[f].pickableType,g.hoverEnabled=c[f].hoverEnabled,h.push(g)}h.sort((function(e,t){return e.distance-t.distance}));var E=h.length;if(E>0){let e=null;for(var b=0;b<E;++b){var I=(g=h[b]).object;if(null==I&&g.face)return this.lastIntersect={intersect:g,pickable:i},g;if(I.geometry){if(g.objectType===r.PICKABLETYPE.Marker3d?g.userId=g.id:void 0===g.userId&&(g.userId=I.userId||I.name),void 0!==I.databagId&&(g.databagId=I.databagId),void 0!==I.fileId&&(g.fileId=I.fileId),e)return e.intersectWithoutMap=g,e;if(this.lastIntersect={intersect:g,pickable:i},g.objectType===r.PICKABLETYPE.Map&&b<E-1)e=g;else if(!n)return g}}return h}return this.lastIntersect=null,null}_intersectOctantForNodeByBox(e,t,i){var r=new THREE.Box3;!function t(a){var n,s;if(r.set(a.min,a.max),e.intersectsBox(r)&&(i.push(a),a.childOctants))for(n=0,s=a.childOctants.length;n<s;n++)t(a.childOctants[n])}(t)}intersectMeshByBox(e,t,i,a,n,s){if(!t||!t.mesh)return null;r.Utils.MinusEpsilon,this.raycaster;var o,l,d=[],h=this.filter,c=h._hasVisibleFilter(),u=(h._hasPickableFilter(),this.viewer.modelManager),p=function(e){var t=u.isHiddenSourceObjectUserId(e.userId,s);return!!(c&&!h._isVisible(e)||t)},m=t.info,f=t.mesh,g=[],v=this.viewer.modelManager.getMatrixWorldGlobal();if(i){function C(e,t){if(t.push(e),e.childOctants)for(var i=0,r=e.childOctants.length;i<r;i++)C(e.childOctants[i],t)}for(o=0,l=e.length;o<l;o++)C(e[o],g)}else{var y=n.clone().applyMatrix4(v);for(o=0,l=e.length;o<l;o++)this._intersectOctantForNodeByBox(y,e[o],g)}for(o=0,l=g.length;o<l;o++){var M=m[g[o].octantId];if(M)for(var E=0,b=M.length;E<b;E++){var I=M[E];if(p(I))continue;var x=I.boundingBox.clone();if(x.applyMatrix4(a),n.intersectsBox(x)){var T=f[r.ModelView.BaseDescriptor.getMeshIdFromOctantMap(I)];if(T)for(var _=0,S=T.length;_<S;_++)T[_].intersectByBox(n,d,I)&&(d[d.length-1].userId=I.userId)}}}return d}intersectByBox(e,t){var i={},a=e.scene.getObjectGroups(),n=this.viewer.terrainOperationManager,s=new THREE.Vector2;this.viewer.cameraControl.mapViewportToWindow(e.mouse.x,e.mouse.y,s);for(var o=0;o<a.length;o++){if(!a[o].isPickable()||0===a[o].children.length)continue;if(a[o].name==r.GlobalData.TilePlaneGroupName&&n.pickExcavation(s))continue;var l=null,d=e.scene.getObjectGroupType(a[o].name);const c=this.viewer.modelManager;let u=c.getModel(d.databagId),p=u?u.getTransformMatrix():new THREE.Matrix4,m=!1;switch(m=!!(u&&u.id&&c.explosionManager.isExploded(u.id)),d.groupType){case r.ObjectGroupType.MODEL:var h=d.databagId;if(e.octreeRoots[h]&&e.octantMap[h]){if(!(l=this.intersectMeshByBox(e.octreeRoots[h],e.octantMap[h],m,p,t,u.id)))break;l.forEach((e=>{i[e.userId]=!0}))}break;case r.ObjectGroupType.GEOMETRY:for(var h in e.octreeRoots){if(!(l=this.intersectMeshByBox(e.octreeRoots[h],e.octantMap[h],m,p,t,u.id)))break;l.forEach((e=>{i[e.userId]=!0}))}break;case r.ObjectGroupType.BIMTILESGROUP:if(u){const e=u.config.metadata.content,a=u.config.metadata.enableSelect;if(!0===r.TilesUtil.PICK_EFFECT_MODEL_TYPE[e]||a){const e={pickable:!1,distanceScope:{near:0,far:1/0},isExploded:m,bIsGetAllIntersects:!0,modelTransform:p,intersectBox:t};l=this.intersectBimTile(u,e)}if(!l)break;const n=u.tilesLoader.tileReader;l.forEach((e=>{const t=n.getUserIdByIndex(e.userId);i[t]=!0}))}}}return Object.keys(i)}getObjectsByClientCoordinates(e){var t=this.viewer.cameraControl.getIntersectContext(e),i=this.raycaster;return i.setFromCamera(t.mouse,t.camera),i.camera=t.camera,i.viewportSize=t.viewportSize,this.getObjectsByRaycaster(t,i)}getObjectsByRaycaster(e,t,i){this.raycaster=t;var a={near:i?0:e.camera.near,far:Infinity};e.scene.shrinkScopeByClipPlane(t,a);for(var n=[],s=e.scene.getObjectGroups(),o=0;o<s.length;o++){if(!s[o].isPickable()||0===s[o].children.length)continue;var l=[],d=e.scene.getObjectGroupType(s[o].name);const t=this.viewer.modelManager;let i=t.getModel(d.databagId),c=i?i.getTransformMatrix():new THREE.Matrix4,u=!1;switch(u=!!(i&&i.id&&t.explosionManager.isExploded(i.id)),d.groupType){case r.ObjectGroupType.MODEL:var h=d.databagId;if(e.octreeRoots[h]&&e.octantMap[h]){const t={pickable:!1,distanceScope:a,isExploded:u,bIsGetAllIntersects:!0,modelTransform:c,modelId:i.id};null!=(l=this.intersectMeshesWithDistance(e.octreeRoots[h],e.octantMap[h],t))&&(l.forEach((e=>e.modelId=i.id)),n=n.concat(l))}break;case r.ObjectGroupType.GEOMETRY:for(var h in e.octreeRoots){const t={pickable:!1,distanceScope:a,isExploded:u,bIsGetAllIntersects:!0,modelTransform:c,modelId:h};null!=(l=this.intersectMeshesWithDistance(e.octreeRoots[h],e.octantMap[h],t))&&(n=n.concat(l))}break;case r.ObjectGroupType.BIMTILESGROUP:const t=i.config.metadata.content;if(!0===r.TilesUtil.PICK_EFFECT_MODEL_TYPE[t]){const e={pickable:!0,distanceScope:a,isExploded:u,bIsGetAllIntersects:!0,modelTransform:c};let t=(l=this.intersectBimTile(i,e)).length;for(let e=0;e<t;++e){let t=l[e];const r=i.tilesLoader.tileReader.getUserIdByIndex(t.userId);t.userId=r}}else l=this.defaultIntersect(s[o],!1,a,!0);null!=l&&(l.forEach((e=>e.modelId=i.id)),n=n.concat(l));break;default:null!=(l=this.defaultIntersect(s[o],!1,a,!0))&&(n=n.concat(l))}}n.sort((function(e,t){return e.distance-t.distance}));let c=new Map;for(let e of n){const t=`${e.modelId}${e.userId}`;c.has(t)||c.set(t,e)}return n=[...c.values()]}hitTest(e){var t=this.intersect(e,null,!1);return null!==t?t.point:null}hitTestByBox(e){const t=this.intersect(e,null,!1,!0);return null!==t?t.point:null}pick(e,t,i){var r=this.intersect(e,null,!0,null,i);return t&&t(r),r}pickGlobe(e,t){var i=this.raycaster,a=e.scene.getObjectGroup(r.GlobalData.TilePlaneGroupName);if(!a||!a.visible)return null;i.setFromCamera(e.mouse,e.camera),i.camera=e.camera,i.viewportSize=e.viewportSize;var n={near:0,far:1/0};e.scene.shrinkScopeByClipPlane(i,n);var s=[];a.raycast(this.raycaster,s),s.sort((function(e,t){return e.distance-t.distance}));var o=s.length>0?s[0]:null;return o&&(o.objectType=a.pickableType,o.hoverEnabled=a.hoverEnabled),o}pickGround(t,i){const r=t.viewer.ground;if(!r)return console.log("there is no ground in current viewer"),null;if(!t.camera)return console.log("camera have not been initialized"),null;const a=this.raycaster;let n;a.setFromCamera(t.mouse,t.camera),a.camera=t.camera,a.viewportSize=t.viewportSize;const s=r.intersect(a.ray);if(s){const i=t.scene.getMatrixGlobal();this._pickedWorldPos||(this._pickedWorldPos=new THREE.Vector3),e.copy(i).invert(),this._pickedWorldPos.setX(s.x),this._pickedWorldPos.setY(s.y),this._pickedWorldPos.setZ(s.z),this._pickedWorldPos.applyMatrix4(e),n={point:s,worldPosition:this._pickedWorldPos.setZ(r.elevation),pickFromReferencePlane:!0}}return i&&i(n),n}getIntersectByRay(e,t){return this.intersect(e,t,!0)}intersectBimTile(e,t){const{pickable:i,distanceScope:r,isExploded:a,bIsGetAllIntersects:n,modelTransform:s,intersectBox:o,hitBox:l}=t;let d=this.raycaster;const h=e.getDescriptor(),c=this.viewer.modelManager.getMatrixWorldGlobal(),u=this.viewer.getScene().getInverseMatrixGlobal(),p=this.viewer.modelManager,m=e.getFilter(),f=m._hasVisibleFilter(),g=m._hasPickableFilter(),v="Meter"===p.getSceneUnit()?.001:1;let y=new THREE.Vector3,M=o?function(e,t,i){let r=e.clone();return r.applyMatrix4(t),o.intersectsBox(r)?1:-1}:function(e,t,i,r,a){let n=e.clone();return!0===r&&(n.getSize(y),y.x<.001||y.y<.001?n.expandByScalar(a):(n.min.z-=a,n.max.z+=a)),n.applyMatrix4(t),n.applyMatrix4(i),d.ray.intersectBoxWithDistance(n)},E=e=>!e||!e.parent||!1===e.visible||!1===e.parent.visible;function b(t,i){let r=p.isHiddenSourceObjectUserId(t.userId,e.id);if(i){if(f&&!m._isVisible(t)||g&&!m._isPickable(t)||r)return!0}else if(f&&!m._isVisible(t)||r)return!0;return!1}if(!e.isUserIdDataReady())return n?[]:void 0;const I=e.tilesLoader.tileReader.searchTreeManager;let x=I.intersect(d,o,u,s,c,a),T=[];for(const t in x)h.getNodeInfoByUserIdCallback(t,(a=>{const n=a.nodeInfo;if(b(n,i))return;let o=M(n.boundingBox,s,c,I.is2D,I.lineBoxScale);if(o<r.near||o>r.far)return;if(0==a.instanceOrNot){const i=n.parent,r=e.tilesLoader.getMeshNodeById(i);if(E(r))return;const a=r.indexGroups.get(parseInt(t)).get(n.nodeId);if(!a)return;const s=a;return s.userId=t,void T.push({meshNode:r,distance:o,nodeInfo:s,meshId:i})}const l=n.nodeId,d=e.tilesLoader.getInstanceMeshNodeById(l);if(d&&void 0!==n.matrix)for(const e in d){d[e].matrix;const t=d[e].mesh;if(E(t))return;let i=Object.create(n),r=i.matrix.clone();i.matrix=r,T.push({meshNode:t,distance:o,nodeInfo:i,meshId:l})}}));if(T.sort(((e,t)=>e.distance-t.distance)),l){let e=d.ray.origin.clone(),t=d.ray.direction.clone();if(0===T.length)return null;let i=T[0].distance;return i=0===i?3:i,T[0].point=e.add(t.multiplyScalar(i)),T[0].object=T[0].meshNode,T[0]}let _=[],S=this,C=o?function(e,t,i,r){return e.intersectByBox(o,t,i,r),t}:function(e,t,i,r){return e.raycastByIndices(d,t,i,r,v),(t=t.filter((e=>!S.viewer.clipPoint(e.point)&&e))).sort(((e,t)=>e.distance-t.distance)),t};for(let e=0;e<T.length&&null!==T[e];e++){let t=[],i=T[e].nodeInfo,r=null,a=i;if(i.instanceOrNot&&(r=i.matrix,a=null),t=C(T[e].meshNode,t,a,r),0===t.length)continue;if(t[0].userId=i.userId,t[0].indexInfo=i,t[0].meshId=T[e].meshId,_.push(t[0]),n)continue;let s=t[0].distance;t.map((e=>{e.distance<s&&(s=e.distance)}));for(let t=e+1;t<T.length&&null!==T[t];t++)T[t].distance<=s||(T[t]=null)}return _.sort(((e,t)=>e.distance-t.distance)),n?_:_[0]}}})(),function(){let e=new THREE.Matrix4,t=new THREE.Vector3,i=new THREE.Vector3,a=new THREE.Vector3,n=new THREE.Vector3,s=new THREE.Vector3;r.PickHelper=class{constructor(e){this.cameraControl=e,this.scene=e.scene,this.timerId=null,this.lastIntersected=null,this._pickObjectByHover=!1}destroy(){this.cameraControl=null,this.scene=null,this.lastIntersected=null,this.timerId&&(clearTimeout(this.timerId),this.timerId=null)}click(e,t){var i=this;function r(){t&&!1===t.pickable&&(t=null),i.handleMousePick(e,!1,t)}e.button!==THREE.MOUSE.RIGHT?(this.timerId&&clearTimeout(this.timerId),this.timerId=setTimeout(r,500)):r()}doubleClick(e){e.preventDefault(),this.timerId&&clearTimeout(this.timerId),this.handleMousePick(e,!0,null)}handleMousePick(e,t,i){if(this._canPick()||e.button!==THREE.MOUSE.LEFT){var a=this.cameraControl,n=a.viewer.modelManager.sceneState,s=new THREE.Vector2(e.clientX,e.clientY),o=a.screenToCanvas(e.clientX,e.clientY),l=a.viewer.modelManager,d=null;if(i)i.pickable&&(d=i.intersect);else{var h=a.getIntersectContext(s);d=a.intersector.pick(h,null)}if(d){var c=d.userId;if(r.Utils.isMobileDevice()&&(a.pivot=d.point),this.scene.intersectToWorld(d,a.viewer),d.intersectWithoutMap&&this.scene.intersectToWorld(d.intersectWithoutMap,a.viewer),d.innnerDebugging=e.altKey,d.cx=s.x,d.cy=s.y,d.face&&d.face.normal){var u=d.face.normal;for(var p in u)u[p]=u[p]==-u[p]?Math.abs(u[p]):u[p]}if(e.button!==THREE.MOUSE.RIGHT)if(t)r.GlobalData.EnableDemolishByDClick?(n.setSelection([c],d.databagId),g(d,!0),a.updateView(!0)):(n.setSelection([c],d.databagId),a.fitAndRotateBySelection(),g(d,!0));else{const t=n.isSelected(c,d.databagId);if(e.ctrlKey)t?n.removeSelection([c],d.databagId):n.addSelection([c],d.databagId);else if(t)a.pivot=null,n.clearSelection();else{const e=d.objectType===r.PICKABLETYPE.Map;n.clearSelection(void 0,e),n.setSelection([c],d.databagId)}g(d,!0),a.updateView(!0)}else g(d,!1)}else{a.pivot=null;var m=n.getSelection();if(e.ctrlKey)return;if(e.button!=THREE.MOUSE.RIGHT&&m.length>0&&(n.clearSelection(),a.updateView(!0)),i&&!i.pickable)(d=i.intersect).cx=s.x,d.cy=s.y,g(d,!1);else{var f=a.getIntersectContext(s);a.viewer.ground?(f.viewer=a.viewer,g(d=a.intersector.pickGround(f))):g(null)}}}function g(i,a){var n=null;if(i&&i.objectType==r.PICKABLETYPE.Room){var s=i.face.contourIndex,d=i.object.geometry.contour;n=s?{startPoint:d[s.st],endPoint:d[s.ed]}:null}const h=e=>e?{selectedObjectId:r.Utils.isDefined(e.userId)?e.userId:null,objectType:r.Utils.isDefined(e.objectType)?e.objectType:null,selectable:r.Utils.isDefined(e.selectable)?a:null,modelId:r.Utils.isDefined(e.databagId)?e.databagId:null,fileId:r.Utils.isDefined(e.fileId)?e.fileId:null,unit:r.Utils.isDefined(e.unit)?e.unit:null,worldPosition:r.Utils.isDefined(e.worldPosition)?e.worldPosition:null,worldBoundingBox:r.Utils.isDefined(e.worldBoundingBox)?e.worldBoundingBox:null,point:r.Utils.isDefined(e.point)?e.point:null,innnerDebugging:r.Utils.isDefined(e.innnerDebugging)?e.innnerDebugging:null,normal:r.Utils.isDefined(e.face)&&r.Utils.isDefined(e.face.normal)?e.face.normal:null,boundaryPoints:r.Utils.isDefined(e.boundaryPoints)?n:null}:null;l.dispatchEvent({type:i&&i.objectType===r.PICKABLETYPE.Marker3d?r.EVENTS.ON_CLICK_MARKER3D_PICK:r.EVENTS.ON_CLICK_PICK,event:e,doubleClick:t,canvasPos:{x:o.x,y:o.y},intersectInfo:h(i),intersectInfoWithoutMap:i&&h(i.intersectWithoutMap)})}}handleMouseMeasure(e,t,i,a){if(this._canPick()){var n=this.cameraControl,s=n.scene,o=a||r.EVENTS.ON_MEASURE_PICK,l={x:e.clientX,y:e.clientY},d=this.pickToPoint(l,5,!0);null!=d?(t&&i.copy(d.pickPoint),h(d.pickPoint,d.pickLine,d.pickPlane,d.face?d.face.normal:null,d.userId,d.modelId)):(s.hasObjectGroup(r.ObjectGroupType.MEASUREPLANE)&&s.removeObjectGroupByName(r.ObjectGroupType.MEASUREPLANE),h(null,null,!1))}function h(i,r,a,s,l,d){var h=n.viewer.modelManager;if(null!=i){var c=n.scene.drawingToWorld(i);i.copy(c)}if(null!=r){var u=n.scene.drawingToWorld(r[0]),p=n.scene.drawingToWorld(r[1]);r[0].copy(u),r[1].copy(p)}h.dispatchEvent({type:o,event:e,pick:t,pickPoint:i,pickLine:r,pickPlane:a,normal:s,userId:l,modelId:d})}}handleMouseMovePick(e){if(!r.GlobalData.MouseMovePick)return;if(!this._canPick())return;const t=this.cameraControl,i=t.screenToCanvas(e.clientX,e.clientY),a=this,n=new THREE.Vector2(e.clientX,e.clientY),s=t.getIntersectContext(n);if(s.viewer=t.viewer,this._pickObjectByHover){if(this.lastIntersected)o(this.lastIntersected,!0,!1);else if(t.viewer.ground){o(t.intersector.pickGround(s),!1,!0)}}else t.intersector.pick(s,(e=>{if(e)a.scene.intersectToWorld(e,t.viewer),o(e,!0,!1);else if(t.viewer.ground){o(t.intersector.pickGround(s),!1,!0)}}));function o(a,n,s){if(null==a)return;const o=t.viewer.modelManager,l={type:r.EVENTS.ON_MOUSE_MOVE_PICK,event:e,selectable:n,canvasPos:{x:i.x,y:i.y},intersectInfo:{}};l.intersectInfo.pickFromReferencePlane=s,void 0!==a.userId&&(l.intersectInfo.selectedObjectId=a.userId),void 0!==a.objectType&&(l.intersectInfo.objectType=a.objectType),void 0!==a.databagId&&(l.intersectInfo.modelId=a.databagId),void 0!==a.worldPosition&&(l.intersectInfo.worldPosition=a.worldPosition),void 0!==a.worldBoundingBox&&(l.intersectInfo.worldBoundingBox=a.worldBoundingBox),void 0!==a.point&&(l.intersectInfo.point=a.point),void 0!==a.innnerDebugging&&(l.intersectInfo.innnerDebugging=a.innnerDebugging),l.intersectInfo.fileId=r.Utils.isDefined(a.fileId)?a.fileId:null,l.intersectInfo.unit=r.Utils.isDefined(a.unit)?a.unit:null,o.dispatchEvent(l)}this._pickObjectByHover=!1}handleMouseHover(e){if(this._canPick()){var t=this.cameraControl,i=t.viewer.modelManager.sceneState,a=this;if(function(){if(0==a.scene.hasObjectGroup(r.ObjectGroupType.AXISGRIDMANAGER))return!1;var e=0,t=a.scene.axisGridEnableHover;if(t){for(var i in a.scene.axisGridManagerMap){e+=r.AxisGridManager.getInstance(a.scene,i).getElements().length}0===e&&(t=!1)}return t}()){var n=this.scene.getMatrixGlobal(),s=new THREE.Vector2(e.clientX,e.clientY),o=t.getRaycaster(s.x,s.y),l=[];for(var d in this.scene.axisGridManagerMap){var h=r.AxisGridManager.getInstance(this.scene,d),c=h.getIntersectPoints(o,n);h.snapOnFloors(c).forEach((e=>{e.modelId=d,l.push(e)}))}t.viewer.modelManager.dispatchEvent({type:r.EVENTS.ON_AXIS_GRID_HOVER,snaps:l})}if(r.GlobalData.Hover||function(){let e=!1;return a.scene.children[0].children.some((t=>{if(t.name&&t.name.indexOf(r.ObjectGroupType.MARKER3D)>=0&&t.children.length>0)return e=!0})),e}()){var u=t.screenToCanvas(e.clientX,e.clientY),p=new THREE.Vector2(e.clientX,e.clientY),m=t.getIntersectContext(p);t.intersector.pick(m,(function(e){function n(e){if(e.objectType===r.PICKABLETYPE.Marker3d)e.object.setAttributeSize(e.index,e.object.initSize||e.currentSize);else i.clearHover()}if(a._pickObjectByHover=!0,e){var s=r.GlobalData.Hover||e.hoverEnabled;a.lastIntersected&&(a.lastIntersected.userId!=e.userId&&n(a.lastIntersected),a.lastIntersected.hoverEnabled&&f(null)),s?(a.lastIntersected&&a.lastIntersected.userId==e.userId||(!function(e){if(e.objectType===r.PICKABLETYPE.Marker3d){var t=e.object;e.currentSize=t.getAttributeSize(e.index),t.initSize=t.initSize||e.currentSize,t.getAttributeHoverAnimation(e.index)&&e.currentSize===t.initSize&&t.setAttributeSize(e.index,Math.floor(1.5*e.currentSize))}else i.setHoverId(e.userId)}(e),a.lastIntersected=e),f(e,!0)):a.lastIntersected=e,t.updateHighlight()}else a.lastIntersected&&(n(a.lastIntersected),a.lastIntersected=null,f(null),t.updateHighlight())}))}}function f(i,n){var s=t.viewer.modelManager;null!=i&&a.scene.intersectToWorld(i,t.viewer),s.dispatchEvent({type:r.EVENTS.ON_HOVER_PICK,event:e,canvasPos:{x:u.x,y:u.y},intersectInfo:i?{selectedObjectId:i.userId,objectType:i.objectType,selectable:n,modelId:i.databagId,fileId:i.fileId,unit:i.unit,worldPosition:i.worldPosition,worldBoundingBox:i.worldBoundingBox,point:i.point,innnerDebugging:i.innnerDebugging}:null})}}_canPick(){return!!this.cameraControl.viewer.modelManager.hasModelDataReady()}_pointToLine(e,n,s){if(r.Math.equalsEpsilonVec3(e,n,1e-5))return e.clone();t.subVectors(n,e),i.subVectors(s,e);var o=t.dot(i);if(o<0)return e;var l=t.dot(t);return o>l?n:(o/=l,a.copy(e),a.addScaledVector(t,o),a)}_getLineIntersectionPt(e,t,i,a,o){if(!e)return null;o=o||20;for(var l=[],d=0;d<e.length;++d){var h=e[d];if("LineSegmentsEx"!==h.object.type)continue;var c=h.point,u=h.object.geometry,p=h.object.matrixWorld.clone();let r=u.attributes?u:u._bufferGeometry,M=r.index.array,E=r.attributes.position.array;for(let e=0;e<M.length;e+=2){n.set(E[3*M[e]],E[3*M[e]+1],E[3*M[e]+2]),n.applyMatrix4(p),s.set(E[3*M[e+1]],E[3*M[e+1]+1],E[3*M[e+1]+2]),s.applyMatrix4(p);var m=this._pointToLine(n,s,c).clone();m.applyMatrix4(t);var f=.5*(m.x-a.x)*i.width,g=.5*(m.y-a.y)*i.height,v=Math.sqrt(f*f+g*g);if(!(v>o)){var y={};y.point1=n.clone(),y.point2=s.clone(),l.push(y)}}}if(l.length>1e3)return null;var M=[];for(d=0;d<l.length;++d)for(var E=l[d],b=d+1;b<l.length;++b){var I=l[b],x=r.Utils.lineLineIntersection3d(E.point1,E.point2,I.point1,I.point2);x&&M.push(x.clone())}if(0===M.length)return null;function T(e){var r=e.clone();r.applyMatrix4(t);var n=.5*(r.x-a.x)*i.width,s=.5*(r.y-a.y)*i.height;return v=Math.sqrt(n*n+s*s)}return M.sort(((e,t)=>T(e)-T(t))),M[0]}pickToPoint(t,i,a){r.Utils.defaultValue(i,5);var o=this.cameraControl,l=o.scene,d=new THREE.Vector2(t.x,t.y),h=o.getIntersectContext(d),c=o.intersector.pick(h,null,!0),u=o.camera.projScreenMatrix,p=h.mouse,m=h.viewportSize,f=null;if(f=Array.isArray(c)?c[0]:c){if(f.object.parent instanceof r.ExtrudeBodyManager)return null;if(a){var g=this._getLineIntersectionPt(c,u,m,p,20);if(g)return(S={}).pickPoint=g,S.pickLine=null,S.pickPlane=null,S.type="Point",S.pointType="IntersectionPoint",S.face=f.face,S.userId=f.userId,S.modelId=f.databagId,S.fileId=f.fileId,S.unit=x,S.sceneUnit=I,S.unitScalar=T,S}var v,y=f.point,M=f.object.geometry,E=f.object.matrixWorld.clone();u=o.camera.projScreenMatrix,p=h.mouse,m=h.viewportSize;if(void 0!==f.indexInfo&&(v=f.indexInfo),!M.attributes&&!M._bufferGeometry)return null;var b=o.viewer.getModelManager(),I=b.getSceneUnit(),x=b.getModelUnit(f.databagId),T=I===x?1:I===r.EnumLengthlUnits.Meter?.001:1e3,_=M.attributes?M:M._bufferGeometry;if("MeshLineGeometry"===_.type){var S={};e.copy(E).invert();var C=new THREE.Vector3(y.x,y.y,y.z);return S.pickPoint=C,S.pickLine=null,S.pickPlane=null,S.type="Line",S.pointType=null,S.face=f.face,S.userId=f.userId,S.modelId=f.databagId,S.fileId=f.fileId,S.unit=x,S.sceneUnit=I,S.unitScalar=T,S}if(!_.index)return null;var w=_.attributes.position.array,R=[],B=0,L=0;v?(R=_.index.array,B=v.indexStart,L=v.indexStart+v.indexCount):(r.GlobalData.BatchMergeEnabled&&f.matrix&&E.multiply(f.matrix),L=(R=r.RemoveDuplicateVertex(_.attributes.position.array,_.index.array)).length);for(var O=1/0,P=new THREE.Vector3,D=[],A=[],N=r.Utils.getMin(R.slice(B,L)),H=B;H<L;++H){var U=new THREE.Vector3(w[3*R[H]],w[3*R[H]+1],w[3*R[H]+2]);U.applyMatrix4(E),(d=U.clone()).applyMatrix4(u);var F=.5*(d.x-p.x)*m.width,k=.5*(d.y-p.y)*m.height;(K=Math.sqrt(F*F+k*k))<O&&(O=K,P.copy(U)),v&&A.push(R[H]-N)}var G=y.clone(),V=null,j=!1,z="EndPoint";if(O<i)l.hasObjectGroup(r.ObjectGroupType.MEASUREPICKPLANE)&&l.removeObjectGroupByName(r.ObjectGroupType.MEASUREPICKPLANE),G=P.clone();else{O=1/0;var W=new THREE.Vector3,q=new THREE.Vector3,X=(P=new THREE.Vector3,[]);const t=!r.Utils.isDefined(_.attributes.normal)&&!r.Utils.isDefined(_.attributes.cNormal);if(v)D=w.slice(v.positionStart,v.positionStart+v.positionCount),X=t?A:r.BuildEdge(D,A);else{D=w;const e=_.index.array;X=t?e:r.BuildEdge(_.attributes.position.array,e)}for(H=0;H<X.length;H+=2){n.set(D[3*X[H]],D[3*X[H]+1],D[3*X[H]+2]),n.applyMatrix4(E),s.set(D[3*X[H+1]],D[3*X[H+1]+1],D[3*X[H+1]+2]),s.applyMatrix4(E);var Y=this._pointToLine(n,s,y);(d=Y.clone()).applyMatrix4(u);F=.5*(d.x-p.x)*m.width,k=.5*(d.y-p.y)*m.height;(K=Math.sqrt(F*F+k*k))<O&&(O=K,W.copy(n),q.copy(s),P.copy(Y))}if(D=null,A=null,O<i){l.hasObjectGroup(r.ObjectGroupType.MEASUREPLANE)&&l.removeObjectGroupByName(r.ObjectGroupType.MEASUREPLANE),(V=new Array).push(W),V.push(q),G=P.clone(),(d=new THREE.Vector3((W.x+q.x)/2,(W.y+q.y)/2,(W.z+q.z)/2)).applyMatrix4(u);var K;F=.5*(d.x-p.x)*m.width,k=.5*(d.y-p.y)*m.height;(K=Math.sqrt(F*F+k*k))<3&&(z="MidPoint")}else if(!t){if(r.GlobalData.MeasureHighlightPlane){R=_.index.array,e.copy(E).invert();var Z=new THREE.Vector3(y.x,y.y,y.z);let t;Z.applyMatrix4(e);let i=!1;r.Utils.isDefined(_.attributes.cNormal)?(t=_.attributes.cNormal.array,i=!0):r.Utils.isDefined(_.attributes.normal)&&(t=_.attributes.normal.array);var $=r.GetFaceIndex(w,t,R,Z,f.face?f.face.normal:null,i),Q=new THREE.BufferGeometry;Q.setIndex($),Q.setAttribute("position",_.attributes.position,3);var J=r.BuildEdge(w,$),ee=new THREE.BufferGeometry;ee.setIndex(J),ee.setAttribute("position",_.attributes.position,3),l.hasObjectGroup(r.ObjectGroupType.MEASUREPLANE)&&l.removeObjectGroupByName(r.ObjectGroupType.MEASUREPLANE);var te=l.getOrCreateObjectGroup(r.ObjectGroupType.MEASUREPLANE,{priority:1,globalSpace:!0}),ie=new THREE.Mesh(Q,new THREE.MeshBasicMaterial({color:1170103,opacity:.1,transparent:!0}));ie.applyMatrix4(f.object.matrix),te.add(ie);var re=new THREE.LineSegments(ee,new THREE.LineBasicMaterial({color:1170103}));re.applyMatrix4(f.object.matrix),te.add(re),te.updateMatrixWorld(!0),o.updateHighlight()}j=!0}}var ae=null;return j?ae="Plane":V?ae="Line":G&&(ae="Point"),(S={}).pickPoint=G,S.pickLine=V,S.pickPlane=j,S.type=ae,S.pointType=z,S.face=f.face,S.userId=f.userId,S.modelId=f.databagId,S.fileId=f.fileId,S.unit=x,S.sceneUnit=I,S.unitScalar=T,S}return null}handleTabs(e){var t=this.cameraControl.viewer.modelManager.sceneState;null!=e&&null!=e.userId&&t.setSelection([e.userId],e.databagId)}pickAllObjectsByPosition(e){var t=new THREE.Vector2(e.clientX,e.clientY);return this.cameraControl.intersector.getObjectsByClientCoordinates(t)}}}(),r.EditTool=class{constructor(e){this.name=e,this._mousePressed=!1}getName(){return this.name}onExit(){}destroy(){}processMouseDown(e){return!1}processMouseMove(e){return!1}processMouseUp(e){return!1}processMouseWheel(e){return!1}processMouseDoubleClick(e){return!1}processKeyDown(e){return!1}processKeyUp(e){return e.keyCode===r.Keys.ESC&&(this._mousePressed=!1),!1}processTouchstart(e){return!1}processTouchmove(e){return!1}processTouchend(e){return!1}processHover(e){return!1}onEvent(e){var t=!1;switch(e.type){case"touchmove":t=this.processTouchmove(e);break;case"touchstart":t=this.processTouchstart(e);break;case"touchend":t=this.processTouchend(e);break;case"keydown":t=this.processKeyDown(e);break;case"keyup":t=this.processKeyUp(e);break;case"mousewheel":case"DOMMouseScroll":t=this.processMouseWheel(e);break;case"mousedown":this._mousePressed=!0,t=this.processMouseDown(e);break;case"mousemove":t=this._mousePressed?this.processMouseMove(e):this.processHover(e);break;case"mouseup":this._mousePressed=!1,t=this.processMouseUp(e);break;case"dblclick":t=this.processMouseDoubleClick(e)}return t}},(()=>{class e extends r.EditTool{constructor(e,t,i){super(e),this.cameraControl=t,this.frustum=new THREE.Frustum,this.startPt=new THREE.Vector2,this.endPt=new THREE.Vector2,this.eventDispatcher=i}destroy(){super.destroy(),this.cameraControl=null,this.frustum=null,this.startPt=null,this.endPt=null,this.eventDispatcher=null}onUpdateUI(e){this.eventDispatcher.dispatchEvent({type:r.EVENTS.ON_EDITOR_UPDATEUI,data:e,editor:this.name})}updateFrustum(e,t){var i=this.startPt.x,r=this.endPt.x,a=this.startPt.y,n=this.endPt.y;if(i>r){var s=i;i=r,r=s}if(a>n){var o=a;a=n,n=o}if(r-i==0||n-a==0)return!1;var l=this.cameraControl,d=l.getContainerDimensions();return e&&l.computeFrustum(i,r,a,n,this.frustum,d),t&&this.onUpdateUI({visible:!0,dir:this.startPt.x<this.endPt.x,left:i-d.left,top:a-d.top,width:r-i,height:n-a}),!0}computeFrustum(){var e=this.startPt.x,t=this.endPt.x,i=this.startPt.y,r=this.endPt.y;let a=new THREE.Vector3(e,i),n=new THREE.Vector3(e,r),s=new THREE.Vector3(t,r),o=new THREE.Vector3(t,i),l=[];l.push(a,n,s,o);let d=this.cameraControl.viewer,h=[];for(let e=0;e<l.length;e++){let t=[];t.push(l[e]),t.push(l[(e+1)%l.length]),t.push(l[e].clone().setZ(1)),h.push(m(p(d,t)))}let c=[];c.push(a,o,s),h.push(m(p(d,c)));let u=[];function p(e,t){let i=[];for(const r of t){let t=e.clientToWorld(r.clone()),a=e.worldToDrawing(t);i.push(new THREE.Vector3(a.x,a.y,a.z))}return i}function m(e){return(new THREE.Plane).setFromCoplanarPoints(e[0],e[1],e[2])}u.push(a.setZ(1),n.setZ(1),s.setZ(1)),h.push(m(p(d,u)));let f=new THREE.Frustum;for(let e=0;e<h.length;e++)f.planes[e].copy(h[e]);return f}}r.RectOpTool=e})(),(()=>{class e extends r.RectOpTool{constructor(e){super(r.EditToolMode.PICK_BY_RECT,e.cameraControl,e.modelManager),this.viewer=e,this.scene=e.getScene(),this.pickHelper=new r.PickHelper(this.cameraControl),this.activatePick=!1,this.pickPoint=new THREE.Vector3,this.snapIsEnabled=!1,this._triggerByCtrlKey=!0}destroy(){super.destroy(),this.pickHelper.destroy(),this.pickHelper=null,this.viewer=null,this.scene=null,this.pickPoint=null}processMouseDown(e){if(!r.EditorConfig.NoKey){e.preventDefault();var t=["pickByMeasure"],i=this.viewer.editorManager.tools,a=!0;return i.some((e=>{if(t.indexOf(e.name)>=0)return a=!1,!0})),this.activatePick=a&&(e.ctrlKey||e.altKey||!this._triggerByCtrlKey),this.activatePick&&e.button===THREE.MOUSE.LEFT?(this.startPt.set(e.clientX,e.clientY),!0):super.processMouseDown(e)}}processMouseMove(e){if(!r.EditorConfig.NoKey)return this.activatePick&&e.button===THREE.MOUSE.LEFT?(this.endPt.set(e.clientX,e.clientY),this.updateFrustum(!1,!0),!0):super.processMouseMove(e)}processMouseUp(e){if(!r.EditorConfig.NoKey){if(this.onUpdateUI({visible:!1}),this.activatePick&&e.button===THREE.MOUSE.LEFT){if(this.activatePick=!1,Math.abs(this.startPt.x-e.clientX)<2&&Math.abs(this.startPt.y-e.clientY)<2)return this.pickHelper.click(e,null),!0;if(this.endPt.set(e.clientX,e.clientY),!this.updateFrustum(!0,!1))return this.pickHelper.click(e),!0;var t=r.OPSELECTIONTYPE.Clear;return e.ctrlKey||!this._triggerByCtrlKey&&!e.altKey?t=r.OPSELECTIONTYPE.Add:e.altKey&&(t=r.OPSELECTIONTYPE.Remove),r.PickUtil.pickByRect(this.scene,this.frustum,t,this.viewer,void 0,this.startPt,this.endPt),this.pickHelper.lastPickedUserId="",this.cameraControl.updateView(!0),!0}return super.processMouseUp(e)}}processHover(e){if(this.snapIsEnabled)return r.GlobalData.IsMobile||this.pickHelper.handleMouseMeasure(e,!1,this.pickPoint,r.EVENTS.ON_HOVER_SNAP),!0}enableSnap(e){this.snapIsEnabled=e}triggerByCtrlKey(e){this._triggerByCtrlKey=e}onExit(e){this.destroy()}}r.RectPickTool=e})(),(()=>{let e=new THREE.Vector3;class t extends r.RectOpTool{constructor(e){super(r.EditToolMode.ZOOM_BY_RECT,e.cameraControl,e.modelManager),this.scene=e.getScene(),this.camera=e.camera,this.activateZoom=!1}destroy(){super.destroy(),this.scene=null}processTouchstart(e){if(1===e.touches.length){const t=e.touches[0].clientX,i=e.touches[0].clientY;return this.startPt.set(t,i),this.activateZoom=!0,!0}return super.processTouchstart(e)}processTouchmove(e){if(this.activateZoom){e.preventDefault();const t=e.touches[0].clientX,i=e.touches[0].clientY;return this.endPt.set(t,i),this.updateFrustum(!1,!0),!0}return super.processTouchmove(e)}processTouchend(e){if(this.activateZoom){this.activateZoom=!1,this.onUpdateUI({visible:!1});const t=e.changedTouches[0].clientX,i=e.changedTouches[0].clientY;if(this.endPt.set(t,i),this.updateFrustum(!0,!1)){this.zoomToRectangle()&&!0!==this.camera.isPerspective&&this.orthoCameraZoom()}return!0}return super.processTouchend(e)}processMouseDown(e){return e.button===THREE.MOUSE.LEFT?(this.startPt.set(e.clientX,e.clientY),this.activateZoom=!0,!0):super.processMouseDown(e)}processMouseMove(e){return this.activateZoom?(this.endPt.set(e.clientX,e.clientY),this.updateFrustum(!1,!0),!0):super.processMouseMove(e)}processMouseUp(e){if(this.activateZoom){if(this.activateZoom=!1,this.onUpdateUI({visible:!1}),this.endPt.set(e.clientX,e.clientY),this.updateFrustum(!0,!1)){this.zoomToRectangle()&&!0!==this.camera.isPerspective&&this.orthoCameraZoom()}return!0}return super.processMouseUp(e)}orthoCameraZoom(){let e=this.cameraControl.getContainerDimensions(),t=e.width/e.height;var i=Math.abs(this.endPt.x-this.startPt.x),r=Math.abs(this.endPt.y-this.startPt.y);let a=1;a=t<i/r?i/e.width:r/e.height;let n=this.cameraControl.camera;n.orthoScale/=a,this.cameraControl.dirtyCamera(!0),n.setZoom(n.orthoScale),this.cameraControl.setCameraChanging(!0),this.cameraControl.update(!0,!0)}zoomToRectangle(){var t=this.cameraControl.camera,i=this.cameraControl.camera.target,a=this.cameraControl.getContainerDimensions(),n=this.startPt.x,s=this.startPt.y,o=this.endPt.x,l=this.endPt.y,d=Math.abs(o-n),h=Math.abs(s-l);if(0===d||0===h)return;var c=new THREE.Vector2((n+o)/2,(s+l)/2),u=this.cameraControl.getIntersectContext(c),p=this.cameraControl.intersector.hitTest(u);if(!p){let t=this.cameraControl.viewer,i=new r.RectPickTool(t);i.startPt.set(n,o),i.endPt.set(s,l);let a=r.PickUtil.pickByRect(this.scene,this.computeFrustum(),r.OPSELECTIONTYPE.Add,t,!1);var m=new THREE.Box3;for(const e of a){const i=t.getComponentInfoByUserId(e);if(!i)continue;const r=i.boundingBox;m.expandByPoint(r.min),m.expandByPoint(r.max)}if(!1===m.isEmpty()){let i=t.worldToDrawing(m.getCenter(e));p=new THREE.Vector3(i.x,i.y,i.z)}}if(!p)return!1;let f=t.position.clone();var g=d/h>a.width/a.height?d/a.width:h/a.height,v=p.distanceTo(f)*g,y=i.clone().sub(f),M=y.length();y.normalize();let E=y.clone().negate().multiplyScalar(v);return f=p.clone().add(E),t.position.copy(f),i.copy(f).sub(E.clone().normalize().multiplyScalar(M)),this.cameraControl.updateView(!0),!0}worldToClient(e){var t=this.cameraControl.camera,i=new THREE.Vector3(e.x,e.y,e.z);return i.project(t),i}clientToWorld(e){var t=this.cameraControl.getContainerDimensions(),i=this.cameraControl.camera,r=new THREE.Vector3;return r.x=e.x/t.width*2-1,r.y=-e.y/t.height*2+1,r.z=e.z,r.unproject(i),r}}r.RectZoomTool=t})(),(()=>{class e extends r.EditTool{constructor(e){super(r.EditToolMode.PICK_BY_MEASURE),this.editorManager=e.editorManager,this.viewer=e,this.pickHelper=new r.PickHelper(e.cameraControl),this.mouseDown=new THREE.Vector2,this.lastEvent=null,this.pick=!1,this.pickPoint=new THREE.Vector3}destroy(){super.destroy(),this.editorManager=null,this.mouseDown=null,this.lastEvent=null,this.pickPoint=null,this.pickHelper.destroy(),this.pickHelper=null}processMouseDown(e){return!!r.GlobalData.IsMobile||(e.button===THREE.MOUSE.LEFT||e.button===THREE.MOUSE.RIGHT?(this.mouseDown.x=e.clientX,this.mouseDown.y=e.clientY,!1):super.processMouseDown(e))}processMouseMove(e){return!1}processMouseUp(e){if(r.GlobalData.IsMobile)return!0;var t=new THREE.Vector2(e.clientX,e.clientY).distanceTo(this.mouseDown);if(e.button===THREE.MOUSE.LEFT){if(t<=2){this.editorManager.isUpdateRenderList=!0;var i=this.pickPoint.clone();e.shiftKey?this.pickHelper.handleShiftMeasure(e,!0,i):this.pickHelper.handleMouseMeasure(e,!0,i),i.equals(this.pickPoint)||(this.pick=!this.pick,this.pickPoint.copy(i))}return this.dispatchEvent({type:r.EVENTS.ON_TOOL_END}),!0}if(e.button===THREE.MOUSE.RIGHT){if(t<=2){i=this.pickPoint.clone();this.pickHelper.handleMouseMeasure(e,!0,i,r.EVENTS.ON_MEASURE_RESET)}return!0}return super.processMouseUp(e)}processHover(e){return r.GlobalData.IsMobile||(e.shiftKey?this.pickHelper.handleShiftMeasure(e,!1,this.pickPoint):this.pickHelper.handleMouseMeasure(e,!1,this.pickPoint)),!0}processTouchstart(e){return this.mouseDown.x=e.touches[0].clientX,this.mouseDown.y=e.touches[0].clientY,e.clientX=e.touches[0].clientX,e.clientY=e.touches[0].clientY,this.lastEvent=e,super.processTouchstart(e)}processTouchmove(e){const t=this.mouseDown.x,i=this.mouseDown.y,r=e.touches[0].clientX,a=e.touches[0].clientY;return Math.pow(r-t,2)+Math.pow(a-i,2)>25&&(this.lastEvent=null),super.processTouchmove(e)}processTouchend(e){return null!=this.lastEvent&&(this.pickHelper.handleMouseMeasure(this.lastEvent,!0,this.pickPoint),this.editorManager.isUpdateRenderList=!0),super.processTouchend(e)}onExit(e){var t=this.pickHelper.scene;t.hasObjectGroup(r.ObjectGroupType.MEASUREPICKPLANE)&&t.removeObjectGroupByName(r.ObjectGroupType.MEASUREPICKPLANE)}dispatchEvent(e){this.viewer.modelManager.dispatchEvent(e)}}r.MeasureTool=e})(),r.ActionTool=class{constructor(e){this.cameraControl=e,this.action=[],this.editorMap={}}destroy(){}addEditor(e,t,i){this.editorMap[t]||(this.editorMap[t]=[]);const a={editor:e,event:i};this.editorMap[t].push(a),this.cameraControl.setCameraChanging(!0),!1!==r.GlobalData.BatchMergeEnabled&&r.GlobalData.Renderer!==r.EnumRendererType.INCREMENT||(e[t](i),this.cameraControl.updateCamera(!0),this.cameraControl.viewer.render())}clearEditorMap(){this.editorMap={}}setEvent(e){this.event=e}MethodToEditorMethod(){for(const e in this.editorMap){const t=this.editorMap[e].pop(),{editor:i,event:r}=t;i[e](r)}}execute(){this.MethodToEditorMethod(),this.clearEditorMap()}isProcessingMouse(){return Object.keys(this.editorMap).length>0}},(()=>{r.Keys={ALT:18,BACKSPACE:8,LEFT:37,UP:38,RIGHT:39,DOWN:40,A:65,D:68,E:69,Q:81,S:83,W:87,PLUS:187,SUB:189,ZERO:48,ESC:27,TAB:9},r.EditorConfig={ReverseWheelDirection:!1,MovementSpeedRate:1,WalkSpeedRate:1,RotatePivotMode:0,NoPan:!1,NoRotate:!1,NoZoom:!1,NoKey:!1,LockAxisZ:!1,LockAxisZRange:null};r.BaseEditor=class{constructor(e,t){this.name=e,this.cameraControl=t,this.mouseButtons={ORBIT:THREE.MOUSE.RIGHT,PAN2:THREE.MOUSE.MIDDLE,PAN:THREE.MOUSE.LEFT},this.StateType={NONE:-1,ROTATE:0,DOLLY:1,PAN:2},this.state=this.StateType.NONE,this.zoomSpeed=Math.pow(.95,.2),this.defaultMovementSpeed=.005*r.GlobalData.SceneSize,this.movementSpeed=this.defaultMovementSpeed,this.minMovementSpeed=.001,this.defaultKeyPanSpeed=2,this.keyPanSpeed=this.defaultKeyPanSpeed,this.minKeyPanSpeed=.01,this.wheelZoomFactor=45e-5}getName(){return this.name}destroy(){this.scene=null,this.cameraControl=null,this.mouseButtons=null,this.StateType=null}onExit(){}onEnter(){}processMouseDown(e){}processMouseMove(e){}processMouseUp(e){}processMouseWheel(e){}processMouseDoubleClick(e){}processKeyDown(e){}processKeyUp(e){}processTouchstart(e){}processTouchmove(e){}processTouchend(e){}processHover(e){}update(){}moveTo(e,t,i){}rotateTo(e){}dispatchEvent(e){this.cameraControl.viewer.modelManager.dispatchEvent(e)}updateButtons(e){void 0!==e.ORBIT&&(this.mouseButtons.ORBIT=e.ORBIT),void 0!==e.PAN&&(this.mouseButtons.PAN=e.PAN),void 0!==e.PAN2&&(this.mouseButtons.PAN2=e.PAN2),void 0!==e.ZOOM&&(this.mouseButtons.ZOOM=e.ZOOM)}isUserInputEditor(){return this.name===r.EditorMode.PAN||this.name===r.EditorMode.ZOOM||this.name===r.EditorMode.ORBIT}}})(),(()=>{class e extends r.BaseEditor{constructor(e,t){super(e,t),this.oldMouseX=-1,this.oldMouseY=-1,this.modelManager=t.viewer.modelManager,this._worldDimension=new THREE.Vector2,this.pickHelper=new r.PickHelper(t),this.longTapFlag=!1,r.Utils.isMobileDevice()?this.selectPad=new r.SelectPad(this):this.selectPad=null,this.startPt=new THREE.Vector2,this.viewer=t.viewer,this._timeHandle=null}destroy(){super.destroy(),this.modelManager=null,this._worldDimension=null,this.startPt=null,this.pickHelper.destroy(),this.pickHelper=null,this.selectPad&&(this.selectPad.destroy(),this.selectPad=null),this._timeHandle=null,this.viewer=null}longTap(){this.longTapFlag=!0,r.Logger.log("long tap"),this.selectPad&&this.selectPad.showOverlay(this.startPt)}beginPan(e,t){this._panStart.set(e,t),this.cameraControl.userInputHelper.getWorldDimension(e,t,this._worldDimension)}moveTo(e){if(void 0!==e){var t=this.cameraControl;if(!r.EditorConfig.NoKey&&!r.EditorConfig.NoPan){var i=this.movementSpeed*r.EditorConfig.MovementSpeedRate,a=this.keyPanSpeed*r.EditorConfig.MovementSpeedRate,n=r.MoveDirection;switch(e){case n.FORWARD:t.moveForward(i,!0);break;case n.BACK:t.moveBackward(i,!0);break;case n.LEFT:t.pan(a,0);break;case n.RIGHT:t.pan(-a,0);break;case n.UP:t.pan(0,a);break;case n.DOWN:t.pan(0,-a);break;default:e=n.NONE}e!==n.NONE&&t.update(!0,!0)}}}onExit(){r.GlobalData.BatchMergeEnabled&&this.animationStarted&&(this._stop(),this.animationStarted=!1)}}r.NormalEditor=e})(),function(){class e extends r.NormalEditor{constructor(e,t=r.EditorMode.ORBIT){super(t,e),this.mouseButtons={ORBIT:THREE.MOUSE.RIGHT,PAN2:THREE.MOUSE.MIDDLE,PAN:THREE.MOUSE.LEFT},this._rotateStart=new THREE.Vector2,this._rotateEnd=new THREE.Vector2,this._rotateDelta=new THREE.Vector2,this._lastDampingOffset=new THREE.Vector2,this._curDampingOffset=new THREE.Vector2,this.rotatePivot=null,this.enable=!0,this.rotateSpeed=.2;"windows"===r.Utils.getOS()&&(this.rotateSpeed=.8),this._rotateMoving=!1}processMouseDown(e,t){e.preventDefault(),e.button===this.mouseButtons.ORBIT&&!r.EditorConfig.NoRotate&&this.enable&&(this.oldMouseX=e.clientX,this.oldMouseY=e.clientY,t.addEditor(this,"processMouseDownOnRender",e))}processMouseDownOnRender(e){const t=this.cameraControl;this.rotatePivot=t.userInputHelper.getRotatePivot(r.EditorConfig.RotatePivotMode,{x:e.clientX,y:e.clientY}),this._rotateStart.set(e.clientX,e.clientY),this._rotateEnd.set(e.clientX,e.clientY),this.resetDynamicRotate(),this.dispatchEvent({type:r.EVENTS.ON_EDITOR_BEGIN,name:r.EditorMode.ORBIT,editor:this.name,startPt:this._rotateStart}),this.state=this.StateType.ROTATE}processMouseMove(e,t){if(this.state!==this.StateType.ROTATE)return!1;r.Utils.isDefined(this._timeHandle)&&(clearTimeout(this._timeHandle),this._timeHandle=null),this._rotateMoving=!0,this._timeHandle=setTimeout((()=>{this._rotateMoving=!1}),r.GlobalData.InputDelayTimeInterval),t.addEditor(this,"processMouseMoveOnRender",e)}get mouseMoving(){return this._rotateMoving}processMouseMoveOnRender(e){const t=this.cameraControl;if(e.preventDefault(),t.userInputWorking||(t.userInputWorking=!0),this._rotateEnd.set(e.clientX,e.clientY),!(this.cameraControl.isEnableDamping()||(this._rotateDelta.subVectors(this._rotateEnd,this._rotateStart),Math.abs(this._rotateDelta.x)<r.Math.EPSILON2&&Math.abs(this._rotateDelta.y)<r.Math.EPSILON2))){if(this._rotateStart.copy(this._rotateEnd),!0===this.viewer.gisMode){var i=new THREE.Vector3,a=this.cameraControl.camera.position;this.viewer.getScene().getBoundingBox().getCenter(i),(r.Math.equalsEpsilonVec3(this.rotatePivot,i,1e-5)||a.y<2e4&&this.rotatePivot.distanceTo(a)>15e4)&&this.rotatePivot.set(a.x+1e-5,a.y+1e-5,a.z+1e-5)}this._processRotate(this._rotateDelta,this.rotatePivot),this.dispatchEvent({type:r.EVENTS.ON_EDITOR_ROTATING,editor:this.name})}}processMouseUp(e,t){if(this.state!==this.StateType.ROTATE)return!1;t.addEditor(this,"processMouseMoveUpRender",e)}processMouseMoveUpRender(e){const t=this.cameraControl;return this.state=this.StateType.NONE,t.endOperation(),t.onUserInputFinished(),this.dispatchEvent({type:r.EVENTS.ON_EDITOR_END,name:r.EditorMode.ORBIT,editor:this.name}),!0}processTouchstart(e,t){1===e.touches.length&&t.addEditor(this,"processOrbitTouchstartOnRender",e)}processOrbitTouchstartOnRender(e){const t=this.cameraControl;r.EditorConfig.NoRotate||(this.rotatePivot=t.userInputHelper.getRotatePivot(r.EditorConfig.RotatePivotMode,{x:e.touches[0].clientX,y:e.touches[0].clientY}),this._rotateStart.set(e.touches[0].clientX,e.touches[0].clientY),this.state=this.StateType.ROTATE)}processTouchmove(e,t){if(this.state!==this.StateType.ROTATE)return!1;1===e.touches.length&&(e.preventDefault(),r.Utils.isDefined(this._timeHandle)&&(clearTimeout(this._timeHandle),this._timeHandle=null),this._rotateMoving=!0,this._timeHandle=setTimeout((()=>{this._rotateMoving=!1}),r.GlobalData.InputDelayTimeInterval),t.addEditor(this,"processOrbitTouchmoveOnRender",e))}processOrbitTouchmoveOnRender(e){this._rotateEnd.set(e.touches[0].clientX,e.touches[0].clientY),this._rotateDelta.subVectors(this._rotateStart,this._rotateEnd);const t=this.viewer.getClientSize(),i=2*Math.PI*this._rotateDelta.x/t.x*this.rotateSpeed,a=2*Math.PI*this._rotateDelta.y/t.y*this.rotateSpeed,n=this.cameraControl;n.touchUpdateRotation(i,a),this._rotateStart.copy(this._rotateEnd),this.modelManager.dispatchEvent({type:r.EVENTS.ON_EDITOR_ROTATING}),n.touchUpdate()}processTouchend(e,t){if(this.state!==this.StateType.ROTATE)return!1;t.addEditor(this,"processOrbitTouchendOnRender",e)}processOrbitTouchendOnRender(e){const t=this.cameraControl;switch(e.touches.length){case 0:this.state=this.StateType.NONE,t.touchEndHandler(e);break;case 1:if(r.EditorConfig.NoRotate)return;this._rotateStart.set(e.touches[0].clientX,e.touches[0].clientY),this.state=this.StateType.ROTATE}this.dispatchEvent({type:r.EVENTS.ON_EDITOR_END,name:r.EditorMode.ORBIT,editor:this.name})}dynamicRotate(){this._rotateDelta.subVectors(this._rotateEnd,this._rotateStart);let e=!1;if((Math.abs(this._rotateDelta.x)>r.Math.EPSILON4||Math.abs(this._rotateDelta.y)>r.Math.EPSILON4)&&(e=!0),this._lastDampingOffset.length()>r.Math.EPSILON4&&(e=!0),e){const e=this.viewer.getClientSize(),t=-2*Math.PI*this._rotateDelta.x/e.x,i=-2*Math.PI*this._rotateDelta.y/e.y;this._lastDampingOffset.add(new THREE.Vector2(t,i)),this._curDampingOffset.copy(this._lastDampingOffset);const r=this._curDampingOffset.multiplyScalar(this.cameraControl.dynamicDampingFactor());this.cameraControl.handleRotation(r.x,r.y,this.rotatePivot),this._rotateStart.copy(this._rotateEnd),this._lastDampingOffset.multiplyScalar(1-this.cameraControl.dynamicDampingFactor())}}resetDynamicRotate(){this._lastDampingOffset.set(0,0),this._curDampingOffset.set(0,0)}_processRotate(e,t){var i=this.viewer.getClientSize(),r=-2*Math.PI*e.x/i.x,a=-2*Math.PI*e.y/i.y;this.cameraControl.handleRotation(r,a,t)}}r.OrbitEditor=e}(),(()=>{class e extends r.NormalEditor{constructor(e){super(r.EditorMode.PICK,e),this.tabIndex=0,this.intersectOfMouseDown=null,this.pickObjects=[],this._touchStartTime=null}destroy(){super.destroy(),this.pickObjects=null}processMouseDown(e){this.intersectOfMouseDown=null,e.preventDefault();Math.abs(this.oldMouseX-e.clientX)<=1&&Math.abs(this.oldMouseY-e.clientY)<=1&&(this.intersectOfMouseDown=this.cameraControl.getLastIntersect()),this.oldMouseX=e.clientX,this.oldMouseY=e.clientY}processMouseUp(e){e.preventDefault();const t=Math.abs(this.oldMouseX-e.clientX)<=1&&Math.abs(this.oldMouseY-e.clientY)<=1,i=t;return e.button!==THREE.MOUSE.LEFT&&e.button!==THREE.MOUSE.RIGHT||!t?(this.intersectOfMouseDown=null,this.oldMouseX=e.clientX,this.oldMouseY=e.clientY,!1):(this.viewer.hasBimtilesModel()||(this.pickObjects=this.pickHelper.pickAllObjectsByPosition(e)),this.pickHelper.click(e,this.intersectOfMouseDown),this.cameraControl.update(!0),this.intersectOfMouseDown=null,i)}processMouseDoubleClick(e){e.button===THREE.MOUSE.LEFT&&this.pickHelper.doubleClick(e)}processMouseMove(){this.pickObjects=[]}processMouseWheel(){this.pickObjects=[]}processKeyDown(e){if(super.processKeyDown(e),e.preventDefault(),this.state=this.StateType.NONE,!(r.EditorConfig.NoKey||this.pickObjects.length<=0)){var t=r.Keys;if(e.keyCode===t.TAB)e.shiftKey?(--this.tabIndex,this.tabIndex<0?(this.tabIndex=this.pickObjects.length+this.tabIndex,this.pickHelper.handleTabs(this.pickObjects[this.tabIndex])):this.pickHelper.handleTabs(this.pickObjects[this.tabIndex])):(++this.tabIndex,this.tabIndex>=this.pickObjects.length&&(this.tabIndex=0),this.pickHelper.handleTabs(this.pickObjects[this.tabIndex]));this.cameraControl.update(!0)}}processKeyUp(e){if(e.keyCode===r.Keys.ESC)this.cameraControl.viewer.clearSelection(),this.pickHelper.lastPickedUserId=void 0,this.cameraControl.updateView(!0)}processHover(e){this.pickHelper.handleMouseHover(e),this.pickHelper.handleMouseMovePick(e)}processTouchstart(e){if(1!==e.touches.length)return;this.intersectOfMouseDown=null,e.preventDefault();const t=e.touches[0].clientX,i=e.touches[0].clientY;Math.abs(this.oldMouseX-t)<=1&&Math.abs(this.oldMouseY-i)<=1&&(this.intersectOfMouseDown=this.cameraControl.getLastIntersect()),this.oldMouseX=t,this.oldMouseY=i;const r=new Date;this._touchStartTime=r.getTime()}processTouchend(e){if(0!==e.touches.length)return;if((new Date).getTime()-this._touchStartTime>400)return;e.preventDefault();const t=e.changedTouches[0].clientX,i=e.changedTouches[0].clientY;if(Math.abs(this.oldMouseX-t)<=1&&Math.abs(this.oldMouseY-i)<=1){let e={clientX:t,clientY:i,button:THREE.MOUSE.LEFT};return this.pickHelper.click(e,this.intersectOfMouseDown),this.cameraControl.update(!0),this.intersectOfMouseDown=null,!0}return this.intersectOfMouseDown=null,this.oldMouseX=t,this.oldMouseY=i,!1}}r.PickEditor=e})(),function(){class e extends r.EditTool{constructor(e){super(r.EditToolMode.VOLUME_MEASURE),this._viewer=e,this._externalObjectConverter=new r.ExternalObjectConverter(this._viewer),this._measuredObject={},this._lastMousePos=new THREE.Vector2,this._pickHelper=new r.PickHelper(e.cameraControl),this._pickPoint=new THREE.Vector3,this._touchMoved=!1}destroy(){super.destroy(),this._measuredObject=null,this._externalObjectConverter=null,this._viewer=null,this._pickHelper=null}processMouseDown(e){return!!r.GlobalData.IsMobile||(e.button===THREE.MOUSE.LEFT?(this._lastMousePos.x=e.clientX,this._lastMousePos.y=e.clientY,!1):super.processMouseDown(e))}processMouseUp(e){if(r.GlobalData.IsMobile)return!0;const i=new THREE.Vector2(e.clientX,e.clientY).distanceTo(this._lastMousePos);if(e.button===THREE.MOUSE.LEFT){if(i<=2){let i={x:e.clientX,y:e.clientY},a=t.call(this,i);r.Utils.isDefined(a)&&this.dispatchEvent(a)}return!0}}processTouchstart(e){return this._touchMoved=!1,this._lastMousePos.x=e.touches[0].clientX,this._lastMousePos.y=e.touches[0].clientY,super.processTouchstart(e)}processTouchmove(e){return this._touchMoved=!0,super.processTouchmove(e)}processTouchend(e){if(!this._touchMoved){let e=t.call(this,this.s);r.Utils.isDefined(e)&&this.dispatchEvent(e)}return super.processTouchend(e)}onExit(e){this.destroy()}dispatchEvent(e){this._viewer.modelManager.dispatchEvent(e)}}function t(e){var t=this._pickHelper.pickToPoint(e,5);if(!r.Utils.isDefined(t))return null;if(!t.userId||!t.modelId)return null;let i=0;const a=`volumeMeasureObject_${t.userId}`;let n;if(void 0!==this._measuredObject[a])i=this._measuredObject[a].volume,n="m"===this._measuredObject[a].unit?"m³":"mm³";else{const e=this._externalObjectConverter.convertToExternalObject(a,t.userId,!1),s=r.GeomUtil.geometryVolume(e,this._viewer);s.volume=s.volume*Math.pow(t.unitScalar,3),s.unit="Meter"===t.sceneUnit?"m":"mm",i=s.volume,this._measuredObject[a]=s,n="m"===s.unit?"m³":"mm³"}return{volume:i,position:t.pickPoint,unit:n,objectId:t.userId,modelId:t.modelId,type:r.EVENTS.ON_VOLUME_MEASURE_END}}r.VolumeMeasureTool=e}(),function(){class e extends r.NormalEditor{constructor(e){super(r.EditorMode.ZOOM,e),this.mouseButtons={},this.enable=!0,this._dollyStart=new THREE.Vector2,this._dollyEnd=new THREE.Vector2,this._dollyDelta=new THREE.Vector2,this.zoomSpeed=Math.pow(.95,.2),this.touchZoomSpeed=.24,this._curZoomFactor={},this._isZooming=!1}destroy(){super.destroy(),this.mouseButtons=null,this._dollyStart=null,this._dollyEnd=null,this._dollyDelta=null,this._curZoomFactor=null}processMouseWheel(e,t){if(!r.EditorConfig.NoZoom&&this.enable){r.Utils.isDefined(this._timeHandle)&&(clearTimeout(this._timeHandle),this._timeHandle=null),e.preventDefault(),e.stopPropagation();var i=0;e.wheelDelta?i=e.wheelDelta:e.detail&&(i=40*-e.detail),Math.abs(i)>720&&(i=i>0?720:-720),i*=this.wheelZoomFactor,((i=r.EditorConfig.ReverseWheelDirection?-i:i)>0&&this._curZoomFactor.scale<0||i<0&&this._curZoomFactor.scale>0)&&this.cameraControl.setTrackPointChanging(!0),this._curZoomFactor.scale=i,this._curZoomFactor.clientX=e.clientX,this._curZoomFactor.clientY=e.clientY,t.addEditor(this,"processMouseWheelOnRender",e),this._isZooming=!0,this._timeHandle=setTimeout((()=>{this.modelManager.dispatchEvent({type:r.EVENTS.ON_EDITOR_ZOOM_END}),this._isZooming=!1}),r.GlobalData.InputDelayTimeInterval)}}get isZooming(){return this._isZooming}processMouseWheelOnRender(e){this.cameraControl.isEnableDamping()||this._zoom(this._curZoomFactor.scale)}processMouseDown(e,t){e.preventDefault(),e.button!==this.mouseButtons.ZOOM||r.EditorConfig.NoZoom||t.addEditor(this,"processMouseDownOnRender",e)}processMouseDownOnRender(e){this.state=this.StateType.NONE,this.state=this.StateType.DOLLY,this._dollyStart.set(e.clientX,e.clientY),this._dollyEnd.set(e.clientX,e.clientY),this.dispatchEvent({type:r.EVENTS.ON_EDITOR_BEGIN,name:r.EditorMode.ZOOM,editor:this.name,startPt:this._dollyStart})}processMouseMove(e,t){this.state===this.StateType.DOLLY&&t.addEditor(this,"processMouseMoveOnRender",e)}processMouseMoveOnRender(e){const t=this.cameraControl;if(e.preventDefault(),t.userInputWorking||(t.userInputWorking=!0),this._dollyEnd.set(e.clientX,e.clientY),this.cameraControl.isEnableDamping())return;if(this._dollyDelta.subVectors(this._dollyEnd,this._dollyStart),Math.abs(this._dollyDelta.y)<r.Math.EPSILON2)return;let i=this._dollyDelta.y>0?this.zoomSpeed:1/this.zoomSpeed;this._zoom(i-1),this._dollyStart.copy(this._dollyEnd),this.dispatchEvent({type:r.EVENTS.ON_EDITOR_ZOOM,editor:this.name})}processMouseUp(e,t){this.state===this.StateType.DOLLY&&t.addEditor(this,"processMouseMoveUpRender",e)}processMouseMoveUpRender(e){const t=this.cameraControl;return this.state=this.StateType.NONE,t.onUserInputFinished(),this.dispatchEvent({type:r.EVENTS.ON_EDITOR_END,name:r.EditorMode.ZOOM,editor:this.name}),!0}processTouchstart(e,t){2===e.touches.length&&(r.EditorConfig.NoZoom||2===e.touches.length&&t.addEditor(this,"processZoomTouchstartOnRender",e))}processZoomTouchstartOnRender(e){const t=e.touches[0].clientX-e.touches[1].clientX,i=e.touches[0].clientY-e.touches[1].clientY;this._dollyStart.set(0,Math.sqrt(t*t+i*i)),this.state=this.StateType.DOLLY}processTouchmove(e,t){this.state===this.StateType.DOLLY&&(r.Utils.isDefined(this._timeHandle)&&(clearTimeout(this._timeHandle),this._timeHandle=null),e.preventDefault(),2===e.touches.length&&(this._isZooming=!0,this._timeHandle=setTimeout((()=>{this.modelManager.dispatchEvent({type:r.EVENTS.ON_EDITOR_ZOOM_END}),this._isZooming=!1}),r.GlobalData.InputDelayTimeInterval),t.addEditor(this,"processZoomTouchmoveOnRender",e)))}processZoomTouchmoveOnRender(e){const t=this.cameraControl,i=e.touches[0].clientX-e.touches[1].clientX,a=e.touches[0].clientY-e.touches[1].clientY,n=Math.sqrt(i*i+a*a);if(this._dollyEnd.set(0,n),this._dollyDelta.subVectors(this._dollyEnd,this._dollyStart),Math.abs(this._dollyDelta.y)>3){const i=(.01*this.touchZoomSpeed+1e-4)*this._dollyDelta.y;this._dollyStart.copy(this._dollyEnd);const a=.5*(e.touches[0].clientX+e.touches[1].clientX),n=.5*(e.touches[0].clientY+e.touches[1].clientY);t.touchDolly(a,n,i),this.state=this.StateType.DOLLY,this.modelManager.dispatchEvent({type:r.EVENTS.ON_EDITOR_ZOOM})}t.touchUpdate()}processTouchend(e,t){if(this.state!==this.StateType.DOLLY)return!1;t.addEditor(this,"processZoomTouchendOnRender",e)}processZoomTouchendOnRender(e){this.state=this.StateType.NONE,this.cameraControl.viewer.editorManager.cameraChange=!1,this.cameraControl.touchUpdate()}dynamicZoom(){let e=!1;Math.abs(this._curZoomFactor.scale)>r.Math.EPSILON2?e=!0:this._curZoomFactor.scale=0,e&&(this._curZoomFactor.scale*=1-this.cameraControl.dynamicDampingFactor(),this._zoom(this._curZoomFactor.scale))}resetDynamicZoom(){this._curZoomFactor.scale=0}resetMobileParamsByBox(e){if(!r.GlobalData.IsMobile)return;let t=new THREE.Vector3;e.getSize(t);let i=this.cameraControl.viewer.modelManager.isMeterUnit()?100:1e5;(t.x>i||t.y>i)&&(this.touchZoomSpeed=.3)}setZoomSpeed(e){if(!r.Utils.isDefined(e))return void console.warn("The parameter speed is undefined.");if("number"!=typeof e)return void console.warn("The parameter speed is not a number.");let t=r.Math.clamp(e,0,1);return r.GlobalData.IsMobile?(this.touchZoomSpeed=t,t):(this.wheelZoomFactor=t/1e3,t)}getZoomSpeed(){return r.GlobalData.IsMobile?this.touchZoomSpeed:1e3*this.wheelZoomFactor}_zoom(e){this.cameraControl.zoom(e,this._curZoomFactor.clientX,this._curZoomFactor.clientY),this.modelManager.dispatchEvent({type:r.EVENTS.ON_EDITOR_ZOOM})}}r.ZoomEditor=e}(),function(){class e extends r.NormalEditor{constructor(e){super(r.EditorMode.PAN,e),this.mouseButtons={PAN2:THREE.MOUSE.MIDDLE,PAN:THREE.MOUSE.LEFT},this._panStart=new THREE.Vector3,this._panEnd=new THREE.Vector3,this._panDelta=new THREE.Vector3,this._panOffset=new THREE.Vector3,this._lastDampingOffset=new THREE.Vector3,this._curDampingOffset=new THREE.Vector3,this._worldDimension=new THREE.Vector3,this.enable=!0,this._moving=!1,this._panMoving=!1}destroy(){super.destroy(),this.mouseButtons=null,this._panStart=null,this._panEnd=null,this._panDelta=null,this._panOffset=null,this._lastDampingOffset=null,this._curDampingOffset=null,this._worldDimension=null}processMouseDown(e,t){e.button!==this.mouseButtons.PAN&&e.button!==this.mouseButtons.PAN2||r.EditorConfig.NoPan||!this.enable||t.addEditor(this,"processMouseDownOnRender",e)}processMouseDownOnRender(e){const t=this.cameraControl;t.userInputWorking||(t.userInputWorking=!0),this.oldMouseX=e.clientX,this.oldMouseY=e.clientY,this._panStart.set(e.clientX,e.clientY),this._panEnd.set(e.clientX,e.clientY),this._panOffset.set(0,0,0),this.resetDynamicPan();let i=this._panStart;t.userInputHelper.getWorldDimension(e.clientX,e.clientY,this._worldDimension);let a=r.EditorMode.PAN;this.dispatchEvent({type:r.EVENTS.ON_EDITOR_BEGIN,name:a,editor:this.name,startPt:i}),this.state=this.StateType.PAN}processMouseUp(e,t){if(this.state!==this.StateType.PAN)return!1;t.addEditor(this,"processMouseMoveUpOnRender",e)}processMouseMoveUpOnRender(e){return this.cameraControl.endOperation(),this.cameraControl.onUserInputFinished(),this.dispatchEvent({type:r.EVENTS.ON_EDITOR_END,name:r.EditorMode.PAN,editor:this.name}),this.state=this.StateType.NONE,!0}processMouseMove(e,t){if(this.state!==this.StateType.PAN)return!1;r.Utils.isDefined(this._timeHandle)&&(clearTimeout(this._timeHandle),this._timeHandle=null),this._panMoving=!0,this._timeHandle=setTimeout((()=>{this._panMoving=!1}),r.GlobalData.InputDelayTimeInterval),t.addEditor(this,"processMouseMoveOnRender",e)}processMouseMoveOnRender(e){this._panEnd.set(e.clientX,e.clientY),this.cameraControl.isEnableDamping()||(this._panDelta.subVectors(this._panEnd,this._panStart),Math.abs(this._panDelta.x)<r.Math.EPSILON2&&Math.abs(this._panDelta.y)<r.Math.EPSILON2||(this.cameraControl.userInputHelper.getPanOffset(this._panStart,this._panEnd,this._worldDimension,this._panOffset),this.cameraControl.userInputHelper.adjustCameraForPan(this._panOffset),this._panStart.copy(this._panEnd),this.dispatchEvent({type:r.EVENTS.ON_EDITOR_PANING,editor:this.name})))}processKeyDown(e,t){r.EditorConfig.NoKey||r.EditorConfig.NoPan||t.addEditor(this,"processKeyDownOnRender",e)}processKeyDownOnRender(e){const t=this.cameraControl;this._moving=!0;let i=!1,a=this.movementSpeed*r.EditorConfig.MovementSpeedRate,n=this.keyPanSpeed*r.EditorConfig.MovementSpeedRate;switch(e.keyCode){case r.Keys.ZERO:this.keyPanSpeed=this.defaultKeyPanSpeed,this.movementSpeed=this.defaultMovementSpeed;break;case r.Keys.PLUS:this.keyPanSpeed*=1.1,this.movementSpeed*=1.1;break;case r.Keys.SUB:this.keyPanSpeed*=.9,this.keyPanSpeed=this.keyPanSpeed<this.minKeyPanSpeed?this.minKeyPanSpeed:this.keyPanSpeed,this.movementSpeed*=.9,this.movementSpeed=this.movementSpeed<this.minMovementSpeed?this.minMovementSpeed:this.movementSpeed;break;case r.Keys.Q:t.pan(0,n),i=!0;break;case r.Keys.E:t.pan(0,-n),i=!0;break;case r.Keys.LEFT:case r.Keys.A:t.pan(n,0),i=!0;break;case r.Keys.RIGHT:case r.Keys.D:t.pan(-n,0),i=!0;break;case r.Keys.UP:case r.Keys.W:t.moveStraight(a,!e.shiftKey),i=!0;break;case r.Keys.DOWN:case r.Keys.S:t.moveStraight(-a,!e.shiftKey),i=!0}i&&(this.cameraControl.userInputWorking||(this.cameraControl.userInputWorking=!0))}processKeyUp(e){if(!r.EditorConfig.NoKey&&!r.EditorConfig.NoPan)switch(e.keyCode){case r.Keys.Q:case r.Keys.E:case r.Keys.LEFT:case r.Keys.A:case r.Keys.RIGHT:case r.Keys.D:case r.Keys.UP:case r.Keys.W:case r.Keys.DOWN:case r.Keys.S:this.cameraControl.onUserInputFinished()}}processTouchstart(e,t){this.startPt.set(e.touches[0].clientX,e.touches[0].clientY),this.timeId&&clearTimeout(this.timeId),this.timeId=setTimeout(this.longTap,400),this.selectPad&&this.selectPad.hideOverlay(),2===e.touches.length&&t.addEditor(this,"processPanTouchstartOnRender",e)}processPanTouchstartOnRender(e){if(r.EditorConfig.NoPan)return;let t=.5*(e.touches[0].clientX+e.touches[1].clientX),i=.5*(e.touches[0].clientY+e.touches[1].clientY);this.cameraControl.userInputHelper.getWorldDimension(t,i,this._worldDimension),this._panStart.set(t,i),this.state=this.StateType.PAN}processTouchmove(e,t){if(this.state!==this.StateType.PAN)return!1;this.timeId&&clearTimeout(this.timeId),e.preventDefault(),2===e.touches.length&&(r.Utils.isDefined(this._timeHandle)&&(clearTimeout(this._timeHandle),this._timeHandle=null),this._panMoving=!0,this._timeHandle=setTimeout((()=>{this._panMoving=!1}),r.GlobalData.InputDelayTimeInterval),t.addEditor(this,"processPanTouchmoveOnRender",e))}get mouseMoving(){return this._panMoving}processPanTouchmoveOnRender(e){const t=this.cameraControl;let i=.5*(e.touches[0].clientX+e.touches[1].clientX),a=.5*(e.touches[0].clientY+e.touches[1].clientY);if(this._panEnd.set(i,a),this._panDelta.subVectors(this._panEnd,this._panStart),Math.abs(this._panDelta.x)<r.Math.EPSILON1&&Math.abs(this._panDelta.y)<r.Math.EPSILON1)return!1;t.userInputHelper.getPanOffset(this._panStart,this._panEnd,this._worldDimension,this._panOffset),t.userInputHelper.adjustCameraForPan(this._panOffset),this._panStart.copy(this._panEnd),this.state=this.StateType.PAN,this.modelManager.dispatchEvent({type:r.EVENTS.ON_EDITOR_PANING}),t.touchUpdate()}processTouchend(e,t){if(this.state!==this.StateType.PAN)return!1;this.timeId&&clearTimeout(this.timeId),this.longTapFlag&&(this.longTapFlag=!1,e.preventDefault()),t.addEditor(this,"processPanTouchendOnRender",e)}processPanTouchendOnRender(e){this.state=this.StateType.NONE,this.cameraControl.viewer.editorManager.cameraChange=!1,this.cameraControl.touchUpdate()}dynamicPan(){this._panDelta.subVectors(this._panEnd,this._panStart);let e=!1;if((Math.abs(this._panDelta.x)>r.Math.EPSILON2||Math.abs(this._panDelta.y)>r.Math.EPSILON2)&&(e=!0),this._lastDampingOffset.length()>r.Math.EPSILON2&&(e=!0),e){this._lastDampingOffset.add(this._panOffset),this._curDampingOffset.copy(this._lastDampingOffset);const e=this._curDampingOffset.multiplyScalar(this.cameraControl.dynamicDampingFactor());this.cameraControl.userInputHelper.adjustCameraForPan(e),this.cameraControl.userInputHelper.getPanOffset(this._panStart,this._panEnd,this._worldDimension,this._panOffset),this._panStart.copy(this._panEnd),this._lastDampingOffset.multiplyScalar(1-this.cameraControl.dynamicDampingFactor())}}resetDynamicPan(){this._lastDampingOffset.set(0,0,0),this._curDampingOffset.set(0,0,0)}}r.PanEditor=e}(),(()=>{class e extends r.BaseEditor{constructor(e){super(r.EditorMode.FLY,e),this.lookSpeed=.001,this.constrainPitch=!0,this.pitchMin=THREE.Math.degToRad(5)-.5*Math.PI,this.pitchMax=.5*Math.PI-this.pitchMin,this.pitchDeltaTotal=0,this.moveState=r.MoveDirection.NONE,this.rotateStart=new THREE.Vector2,this.rotateEnd=new THREE.Vector2,this.rotateDelta=new THREE.Vector2,this._panStart=new THREE.Vector2,this._panEnd=new THREE.Vector2,this._panDelta=new THREE.Vector2,this._pan=new THREE.Vector3,this._worldDimension=new THREE.Vector2,this.lastMousePoint=new THREE.Vector2,this.isLockHeight=!1,this.lockedHeight=0,this.pickHelper=new r.PickHelper(e),this.intersectOfMouseDown=null}destroy(){super.destroy(),this.rotateStart=null,this.rotateEnd=null,this.rotateDelta=null,this._panStart=null,this._panEnd=null,this._panDelta=null,this._pan=null,this._worldDimension=null,this.lastMousePoint=null,this.intersectOfMouseDown=null,this.pickHelper.destroy(),this.pickHelper=null}processMouseDown(e){e.preventDefault(),e.stopPropagation(),this.lastMousePoint.set(e.clientX,e.clientY);const t=this.cameraControl;if(this.intersectOfMouseDown=null,e.button===this.mouseButtons.ORBIT){if(r.EditorConfig.NoRotate)return;this.rotateStart.set(e.clientX,e.clientY),this.state=this.StateType.ROTATE,this.dispatchEvent({type:r.EVENTS.ON_EDITOR_BEGIN,name:"look",editor:this.name})}else if(e.button===this.mouseButtons.PAN||e.button===this.mouseButtons.PAN2){if(r.EditorConfig.NoPan)return;this._panStart.set(e.clientX,e.clientY),t.userInputHelper.getWorldDimension(e.clientX,e.clientY,this._worldDimension),this.intersectOfMouseDown=t.getLastIntersect(),this.state=this.StateType.PAN,this.isLockHeight&&(this.lockedHeight=e.clientY)}}doPan(e,t){var i=this.cameraControl;this._panEnd.set(e,this.isLockHeight?this.lockedHeight:t),this._panDelta.subVectors(this._panEnd,this._panStart),0===this._panDelta.x&&0===this._panDelta.y||(i.userInputHelper.getPanOffset(this._panStart,this._panEnd,this._worldDimension,this._pan),i.userInputHelper.adjustCameraForPan(this._pan),this._panStart.copy(this._panEnd),i.update(!0))}processMouseMove(e){var t=this.cameraControl;if(e.preventDefault(),this.state===this.StateType.ROTATE){if(this.rotateEnd.set(e.clientX,e.clientY),this.rotateDelta.subVectors(this.rotateEnd,this.rotateStart),this.rotateStart.copy(this.rotateEnd),0!=this.rotateDelta.x||0!=this.rotateDelta.y){var i=this.rotateDelta.x*this.lookSpeed,r=this.rotateDelta.y*this.lookSpeed;t.rotateForFly(i,r,this.pitchMin,this.pitchMax)}}else this.state===this.StateType.PAN&&this.doPan(e.clientX,e.clientY)}processMouseUp(e){if(e.preventDefault(),e.stopPropagation(),e.button!==THREE.MOUSE.LEFT||this.lastMousePoint.x!==e.clientX||this.lastMousePoint.y!==e.clientY){this.intersectOfMouseDown=null;var t=this.cameraControl;switch(this.state){case this.StateType.ROTATE:this.rotateDelta.set(0,0);t.rotateForFly(0,0,this.pitchMin,this.pitchMax),this.dispatchEvent({type:r.EVENTS.ON_EDITOR_END,name:"look",editor:this.name});break;case this.StateType.PAN:this.doPan(e.clientX,e.clientY)}t.endOperation(),this.state=this.StateType.NONE}else this.pickHelper.click(e,this.intersectOfMouseDown)}processHover(e){this.pickHelper.handleMouseHover(e)}processMouseWheel(e){e.preventDefault(),e.stopPropagation();var t=this.cameraControl;if(!r.EditorConfig.NoZoom){var i=e.wheelDelta||e.detail;i=Math.abs(i)>10?i:40*-i,i*=5e-4,r.EditorConfig.ReverseWheelDirection&&(i*=-1);var a=t.getContainerDimensions(),n=a.left+.5*a.width,s=a.top+.5*a.height;t.zoom(i,n,s)}}processKeyDown(e){if(!r.EditorConfig.NoKey&&!e.altKey){var t=r.MoveDirection,i=t.NONE;switch(e.keyCode){case r.Keys.ZERO:this.movementSpeed=this.defaultMovementSpeed;break;case r.Keys.PLUS:this.movementSpeed*=1.1;break;case r.Keys.SUB:this.movementSpeed*=.9,this.movementSpeed<this.minMovementSpeed&&(this.movementSpeed=this.minMovementSpeed);break;case r.Keys.UP:case r.Keys.W:i=t.FORWARD;break;case r.Keys.DOWN:case r.Keys.S:i=t.BACK;break;case r.Keys.LEFT:case r.Keys.A:i=t.LEFT;break;case r.Keys.RIGHT:case r.Keys.D:i=t.RIGHT;break;case r.Keys.Q:i=t.UP;break;case r.Keys.E:i=t.DOWN}i!==t.NONE&&(this.moveState|=i,this.dispatchEvent({type:r.EVENTS.ON_EDITOR_KEYDOWN,event:e,state:i,direction:t,editor:this.name}),this.cameraControl.updateFlyMove(this.moveState,this.movementSpeed*r.EditorConfig.MovementSpeedRate))}}processKeyUp(e){if(!r.EditorConfig.NoKey){var t=r.MoveDirection,i=t.NONE;switch(e.keyCode){case r.Keys.UP:case r.Keys.W:i=t.FORWARD;break;case r.Keys.DOWN:case r.Keys.S:i=t.BACK;break;case r.Keys.LEFT:case r.Keys.A:i=t.LEFT;break;case r.Keys.RIGHT:case r.Keys.D:i=t.RIGHT;break;case r.Keys.Q:i=t.UP;break;case r.Keys.E:i=t.DOWN}i!==t.NONE&&(this.dispatchEvent({type:r.EVENTS.ON_EDITOR_KEYUP,event:e,state:i,direction:t,editor:this.name}),this.moveState&=~i)}}moveTo(e){this.cameraControl.updateFlyMove(e,this.movementSpeed*r.EditorConfig.MovementSpeedRate)}}r.FlyEditor=e})(),(()=>{class e extends r.BaseEditor{constructor(e){super(r.EditorMode.WALK,e),this.mouseButtons={ORBIT:THREE.MOUSE.LEFT,PAN2:THREE.MOUSE.MIDDLE,PAN:THREE.MOUSE.RIGHT},this.pickHelper=new r.PickHelper(e),this.lastMousePoint=new THREE.Vector2,this._reqid=0,this._animateBinded=this._animate.bind(this),this._clock=new THREE.Clock,this.moveState={up:0,down:0,left:0,right:0,forward:0,back:0,pitchUp:0,pitchDown:0,yawLeft:0,yawRight:0,rollLeft:0,rollRight:0},this.startPt=new THREE.Vector2,this.timeId=null,this.rotateSpeed=1,this._rotateStart=new THREE.Vector2,this._rotateEnd=new THREE.Vector2,this._rotateDelta=new THREE.Vector2,this._dollyStart=new THREE.Vector2,this._dollyEnd=new THREE.Vector2,this._dollyDelta=new THREE.Vector2,this._dollyCenter=new THREE.Vector2,this.zoomSpeed=Math.pow(.95,.2),this._panStart=new THREE.Vector2,this._panEnd=new THREE.Vector2,this._panDelta=new THREE.Vector2,this._pan=new THREE.Vector3,this._worldDimension=new THREE.Vector2,r.Utils.isMobileDevice()?this.selectPad=new r.SelectPad(this):this.selectPad=null,this.moveVector=new THREE.Vector3(0,0,0),this.rotationVector=new THREE.Vector3(0,0,0),this.zoomDelta=0,this.rotateStart=new THREE.Vector2,this.rotateEnd=new THREE.Vector2,this.rotateDelta=new THREE.Vector2,this.firstRotate=!0,this.dragLook=!0,this.lockHeightEnabled=!1,this.isLockHeight=!1,this.lockedHeight=0,this.pickEnabled=!0,this._keyboardRotationDegree=7,this.defaultMovementSpeed=750,this.movementSpeed=this.defaultMovementSpeed}destroy(){super.destroy(),this.pickHelper.destroy(),this.pickHelper=null,this.selectPad&&(this.selectPad.destroy(),this.selectPad=null),this.timeId&&(clearTimeout(this.timeId),this.timeId=null),this._clock=null,this._animateBinded=null,this.mouseButtons=null,this.moveState=null,this.startPt=null,this.lastMousePoint=null,this.rotateStart=null,this.rotateEnd=null,this.rotateDelta=null,this._rotateStart=null,this._rotateEnd=null,this._rotateDelta=null,this._dollyStart=null,this._dollyEnd=null,this._dollyDelta=null,this._dollyCenter=null,this._panStart=null,this._panEnd=null,this._panDelta=null,this._pan=null,this._worldDimension=null,this.moveVector=null,this.rotationVector=null,this.rotateStart=null,this.rotateEnd=null,this.rotateDelta=null}_animate(){this._reqid=requestAnimationFrame(this._animateBinded),this.updateWalkMove()}_start(){this._animate()}_stop(){cancelAnimationFrame(this._reqid)}_updateMovement(){this.moveVector.x=-this.moveState.left+this.moveState.right,this.isLockHeight?this.moveVector.y=0:this.moveVector.y=-this.moveState.down+this.moveState.up,this.moveVector.z=-this.moveState.forward+this.moveState.back}_updateRotation(){r.EditorConfig.LockAxisZ?this.rotationVector.x=0:this.rotationVector.x=-this.moveState.pitchDown+this.moveState.pitchUp,this.rotationVector.y=-this.moveState.yawRight+this.moveState.yawLeft,this.rotationVector.z=-this.moveState.rollRight+this.moveState.rollLeft}_doRotate(e){e.x*=r.GlobalData.WalkRotationSpeed,e.y*=r.GlobalData.WalkRotationSpeed;var t=this.cameraControl.getContainerDimensions(),i=t.width/2,a=t.height/2;this.moveState.yawLeft=-e.x/i,this.moveState.pitchDown=e.y/a,this._updateRotation()}processMouseDown(e){if(e.preventDefault(),e.stopPropagation(),this.lastMousePoint.set(e.clientX,e.clientY),this.firstRotate=!1,e.button===this.mouseButtons.ORBIT){if(r.EditorConfig.NoRotate)return;this.rotateStart.set(e.clientX,e.clientY),this.state=this.StateType.ROTATE,this.dispatchEvent({type:r.EVENTS.ON_EDITOR_BEGIN,name:"look",editor:this.name})}}processMouseUp(e){return e.preventDefault(),e.stopPropagation(),this.pickEnabled&&(e.button===THREE.MOUSE.LEFT||e.button===THREE.MOUSE.RIGHT)&&Math.abs(this.lastMousePoint.x-e.clientX)<2&&Math.abs(this.lastMousePoint.y-e.clientY)<2?(this.state=this.StateType.NONE,void this.pickHelper.click(e)):(this.state===this.StateType.ROTATE&&(this.moveState.yawLeft=this.moveState.pitchDown=0,this.dispatchEvent({type:r.EVENTS.ON_EDITOR_END,name:"look",editor:this.name})),this.state=this.StateType.NONE,!0)}processMouseMove(e){e.preventDefault(),this.dragLook&&this.state===this.StateType.ROTATE&&(this.rotateEnd.set(e.clientX,e.clientY),this.rotateDelta.subVectors(this.rotateEnd,this.rotateStart),this.rotateStart.copy(this.rotateEnd),this._doRotate(this.rotateDelta))}processTouchstart(e){this.startPt.set(e.touches[0].clientX,e.touches[0].clientY),this.timeId&&clearTimeout(this.timeId);switch(this.timeId=setTimeout(this.longTap,400),this.selectPad&&this.selectPad.hideOverlay(),e.touches.length){case 1:if(r.EditorConfig.NoRotate)return;this._rotateStart.set(e.touches[0].clientX,e.touches[0].clientY),this.state=this.StateType.ROTATE;break;case 2:if(!r.EditorConfig.NoPan){var t=.5*(e.touches[0].clientX+e.touches[1].clientX),i=.5*(e.touches[0].clientY+e.touches[1].clientY);this._panStart.set(t,i)}break;default:this.state=this.StateType.NONE}}processTouchmove(e){this.timeId&&clearTimeout(this.timeId);var t=this.cameraControl;switch(e.preventDefault(),e.touches.length){case 1:this.dragLook&&this.state===this.StateType.ROTATE&&(this._rotateEnd.set(e.touches[0].clientX,e.touches[0].clientY),this._rotateDelta.subVectors(this._rotateEnd,this._rotateStart),this._rotateStart.copy(this._rotateEnd),this._doRotate(this._rotateDelta));break;case 2:if(t.clearTouchRotateState(),!r.EditorConfig.NoPan){var i=.5*(e.touches[0].clientX+e.touches[1].clientX),a=.5*(e.touches[0].clientY+e.touches[1].clientY);if(this._panEnd.set(i,a),this._panDelta.subVectors(this._panEnd,this._panStart),Math.abs(this._panDelta.x)<3&&Math.abs(this._panDelta.y)<3)return;t.userInputHelper.getWorldDimension(i,a,this._worldDimension),t.userInputHelper.getPanOffset(this._panStart,this._panEnd,this._worldDimension,this._pan),t.userInputHelper.adjustCameraForPan(this._pan),this._panStart.copy(this._panEnd),this.state=this.StateType.PAN}}t.touchUpdate()}processTouchend(e){this.timeId&&clearTimeout(this.timeId),this.longTapFlag&&(this.longTapFlag=!1,e.preventDefault());var t=this.cameraControl;switch(e.touches.length){case 0:this.state=this.StateType.NONE,t.touchEndHandler(e);break;case 1:if(r.EditorConfig.NoRotate)return;this._rotateStart.set(e.touches[0].clientX,e.touches[0].clientY),this.state=this.StateType.ROTATE}}processHover(e){e.preventDefault(),this.dragLook||(this.firstRotate&&(this.firstRotate=!1,this.rotateStart.set(e.clientX,e.clientY)),this.rotateEnd.set(e.clientX,e.clientY),this.rotateDelta.subVectors(this.rotateEnd,this.rotateStart),this.rotateStart.copy(this.rotateEnd),this._doRotate(this.rotateDelta))}_rotateDegree(e){this.rotateStart||(this.rotateStart=new THREE.Vector2),this.rotateEnd.set(e.x,e.y),this.rotateDelta.subVectors(this.rotateEnd,this.rotateStart),this.rotateStart.copy(this.rotateEnd),this._doRotate(this.rotateDelta)}processKeyDown(e){if(r.EditorConfig.NoKey)return;if(e.altKey)return;var t=r.MoveDirection.NONE,i=r.Keys;let a=!0;switch(e.keyCode){case i.ZERO:this.movementSpeed=this.defaultMovementSpeed;break;case i.PLUS:this.movementSpeed*=1.1;break;case i.SUB:this.movementSpeed*=.9,this.movementSpeed<this.minMovementSpeed&&(this.movementSpeed=this.minMovementSpeed);break;case i.UP:a=!1,this._rotateDegree({x:this.rotateStart.x,y:this.rotateStart.y-this._keyboardRotationDegree});break;case i.W:t=r.MoveDirection.FORWARD,this.moveState.forward=1;break;case i.DOWN:a=!1,this._rotateDegree({x:this.rotateStart.x,y:this.rotateStart.y+this._keyboardRotationDegree});break;case i.S:t=r.MoveDirection.BACK,this.moveState.back=1;break;case i.LEFT:a=!1,this._rotateDegree({x:this.rotateStart.x-this._keyboardRotationDegree,y:this.rotateStart.y});break;case i.A:t=r.MoveDirection.LEFT,this.moveState.left=1;break;case i.RIGHT:a=!1,this._rotateDegree({x:this.rotateStart.x+this._keyboardRotationDegree,y:this.rotateStart.y});break;case i.D:t=r.MoveDirection.RIGHT,this.moveState.right=1;break;case i.Q:t=r.MoveDirection.UP,this.moveState.up=1;break;case i.E:t=r.MoveDirection.DOWN,this.moveState.down=1;break;case i.TAB:return this.moveVector.set(0,0,0),this.moveState.forward=0,this.moveState.back=0,this.moveState.left=0,this.moveState.right=0,this.moveState.up=0,void(this.moveState.down=0);default:return}a&&(this._updateMovement(),this._updateRotation(),t!==r.MoveDirection.NONE&&this.dispatchEvent({type:r.EVENTS.ON_EDITOR_KEYDOWN,event:e,direction:t,editor:this.name}))}processKeyUp(e){if(r.EditorConfig.NoKey)return;var t=r.MoveDirection.NONE,i=r.Keys;let a=!0;switch(e.keyCode){case i.UP:a=!1,this.moveState.yawLeft=this.moveState.pitchDown=0;break;case i.W:t=r.MoveDirection.FORWARD,this.moveState.forward=0;break;case i.DOWN:a=!1,this.moveState.yawLeft=this.moveState.pitchDown=0;break;case i.S:t=r.MoveDirection.BACK,this.moveState.back=0;break;case i.LEFT:a=!1,this.moveState.yawLeft=this.moveState.pitchDown=0;break;case i.A:t=r.MoveDirection.LEFT,this.moveState.left=0;break;case i.RIGHT:a=!1,this.moveState.yawLeft=this.moveState.pitchDown=0;break;case i.D:t=r.MoveDirection.RIGHT,this.moveState.right=0;break;case i.Q:t=r.MoveDirection.UP,this.moveState.up=0;break;case i.E:t=r.MoveDirection.DOWN,this.moveState.down=0;break;default:return}a&&(this._updateMovement(),this._updateRotation(),t!==r.MoveDirection.NONE&&this.dispatchEvent({type:r.EVENTS.ON_EDITOR_KEYUP,event:e,direction:t,editor:this.name}))}updateWalkMove(){var e=this._clock.getDelta(),t=this.cameraControl,i=t.camera.position.y;if(0===this.moveVector.x&&0===this.moveVector.y&&0===this.moveVector.z&&0===this.rotationVector.x&&0===this.rotationVector.y&&0===this.rotationVector.z&&0===this.zoomDelta&&0===t.gravity)return;var a=this.movementSpeed*r.EditorConfig.WalkSpeedRate*e;if(1==r.GlobalData.WalkingWithGravity&&(this.moveVector.y=0,t.computeManHeight(),t.computeGravity()),t.dirtyCamera(!0),0!==this.zoomDelta){var n=this.zoomDelta*e;t.userInputHelper.adjustCameraForZoom(n),this.zoomDelta=0}t.translateCameraForWalk(this.moveVector,a),this.dragLook?t.rotateCameraForWalk(this.rotationVector,1):t.rotateCameraForWalk(this.rotationVector,2),t.flyOnWorld(!1);let s=t.viewer.modelManager;i!==t.camera.position.y&&s.dispatchEvent({type:r.EVENTS.ON_CAMERA_HEIGHT_CHANGED,cameraPosition:t.camera.position.clone()}),s.dispatchEvent({type:r.EVENTS.ON_EDITOR_WALKING})}onEnter(){var e=this.cameraControl.scene,t=this.cameraControl.getCamera();t.isPerspective||(console.log("Current camera is Orthographic"),t.toPerspective()),e.getBoundingBox().containsPoint(t.position)&&t.position.y!=t.target.y&&function(e){var t=e.target.clone().sub(e.position),i=t.length(),r=t.clone();r.y=0,r.normalize(),r.multiplyScalar(i),e.target.addVectors(e.position,r)}(t),this._start()}onExit(){this._stop(),this.moveVector=new THREE.Vector3(0,0,0),this.moveState={up:0,down:0,left:0,right:0,forward:0,back:0,pitchUp:0,pitchDown:0,yawLeft:0,yawRight:0,rollLeft:0,rollRight:0}}rotateTo(e){this._doRotate(e)}moveTo(e,t,i){if(void 0===i&&(i=!0),void 0===t&&(t=1),i)switch(e){case r.MoveDirection.FORWARD:this.moveState.forward=t;break;case r.MoveDirection.BACK:this.moveState.back=t;break;case r.MoveDirection.LEFT:this.moveState.left=t;break;case r.MoveDirection.RIGHT:this.moveState.right=t;break;case r.MoveDirection.UP:this.moveState.up=t;break;case r.MoveDirection.DOWN:this.moveState.down=t}else switch(e){case r.MoveDirection.FORWARD:this.moveState.forward=0;break;case r.MoveDirection.BACK:this.moveState.back=0;break;case r.MoveDirection.LEFT:this.moveState.left=0;break;case r.MoveDirection.RIGHT:this.moveState.right=0;break;case r.MoveDirection.UP:this.moveState.up=0;break;case r.MoveDirection.DOWN:this.moveState.down=0}this._updateMovement()}setHeightLocked(e){this.lockHeightEnabled&&this.isLockHeight!==e&&(this.isLockHeight=e)}setDragLook(e){this.dragLook!==e&&(this.firstRotate=!0,this.dragLook=e)}}r.WalkEditor=e})(),(()=>{let e=new THREE.Vector3;class t extends r.WalkEditor{constructor(e){super(e),this.isMeterUnit=e.viewer.modelManager.isMeterUnit(),this.object=null,this.unitRate=this.isMeterUnit?.001:1,this.cameraDis=5e3*this.unitRate,this.minCameraDis=3e3*this.unitRate,this.rotatePivot=new THREE.Vector3,this.objectId=null,this.externalObjectManager=null,this.mixer=null,this.actions=[],this.prepared=!1,this.rotating=!1,this.poseEnum={walk:0,run:1,stand:2},this.poseIndex=0,this.walkIndex=3,this.rotateQuaternion=new THREE.Quaternion,this.tmpVec=new THREE.Vector3,this.objectDirection=new THREE.Vector3(0,-1,0),this.zoomWithCollision=!1}destroy(){super.destroy(),this.object=null,this.rotatePivot=null,this.objectId=null,this.externalObjectManager=null,this.mixer=null,this.actions=null}_doRotate(t){let i=this.cameraControl,r=i.camera,a=r.target.clone(),n=r.position.clone();i.processRotate(t,i.viewer.worldToDrawing(this.rotatePivot));var s=i.checkCollisionInCameraAndObject(this.object);if(s){r.position.copy(s);let t=this.object.position;e.set(t.x,t.y,this.object.box.max.z);let a=i.scene.worldToDrawing(e);r.target.set(a.x,a.y,a.z)}let o=i.viewer.drawingToWorld(r.position);this.object.box.containsPoint(o)&&(r.target.copy(a),r.position.copy(n)),this.updateRotateForObject(),i.updateCamera(),this.rotating=!0}processMouseUp(e){return e.preventDefault(),e.stopPropagation(),this.rotating=!1,this.pickEnabled&&(e.button===THREE.MOUSE.LEFT||e.button===THREE.MOUSE.RIGHT)&&Math.abs(this.lastMousePoint.x-e.clientX)<2&&Math.abs(this.lastMousePoint.y-e.clientY)<2?(this.state=this.StateType.NONE,void this.pickHelper.click(e)):(this.state===this.StateType.ROTATE&&(this.moveState.yawLeft=this.moveState.pitchDown=0),this.state=this.StateType.NONE,!0)}processMouseWheel(t){var i=this.cameraControl;if(t.preventDefault(),t.stopPropagation(),!r.EditorConfig.NoZoom){var a=t.wheelDelta||t.detail;if(a=Math.abs(a)>10?a:40*-a,a*=this.wheelZoomFactor,r.EditorConfig.ReverseWheelDirection&&(a*=-1),!r.GlobalData.ConstraintZoom||i.cameraWithinMaximumRange())if(this.prepared){this.zoomDelta*a<0&&(this.zoomWithCollision=!1);let t=this.object.position;if(e.set(t.x,t.y,this.object.box.max.z),!this.zoomWithCollision&&(a<0||a>0&&i.camera.getDistanceByPos(e,i.scene.getMatrixGlobal())>this.minCameraDis)){let t=i.camera,r=t.position.clone(),n=t.target.clone();i.zoomWithCenter(a,e),i.checkCollisionInCameraAndObject(this.object)&&(t.position.set(r.x,r.y,r.z),t.target.set(n.x,n.y,n.z),this.zoomWithCollision=!0)}}else i.zoom(a,t.clientX,t.clientY);else i.resetCameraToMaximumRange();this.zoomDelta=a,i.viewer.modelManager.dispatchEvent({type:r.EVENTS.ON_EDITOR_ZOOM})}}updateWalkMove(){if(!this.prepared)return;var e=this._clock.getDelta();this.mixer.update(e),this.object.updateMatrixWorld();var t=this.cameraControl,i=t.camera.position.y;if(0===this.moveVector.x&&0===this.moveVector.y&&0===this.moveVector.z&&!this.rotating&&0===t.gravity)return this.changePose(this.poseEnum.stand),void t.flyOnWorld(!1);this.object.visible&&this.changePose(this.walkIndex),this.zoomWithCollision=!1;var a=this.movementSpeed*r.EditorConfig.WalkSpeedRate*e;const n=this.object.visible;this.object.visible=!1,1==r.GlobalData.WalkingWithGravity&&(this.moveVector.y=0,t.computeManHeight(this.object),t.computeGravity(this.object)),t.dirtyCamera(!0),t.translateCameraForThirdpersonWalk(this.moveVector,a,this.object,this.cameraDis),this.object.visible=n;var s=this.object.position;this.rotatePivot.set(s.x,s.y,s.z),this.externalObjectManager.setTransform(this.objectId,void 0,void 0,this.rotateQuaternion),t.flyOnWorld(!1);let o=t.viewer.modelManager;i!==t.camera.position.y&&o.dispatchEvent({type:r.EVENTS.ON_CAMERA_HEIGHT_CHANGED,cameraPosition:t.camera.position.clone()}),o.dispatchEvent({type:r.EVENTS.ON_EDITOR_WALKING})}updateRotateForObject(e,t){var i=this.cameraControl;this.tmpVec.subVectors(t||i.camera.target,e||i.camera.position);var r=i.viewer.drawingToWorld(this.tmpVec);r.z=0,r.normalize(),this.rotateQuaternion.setFromUnitVectors(this.objectDirection,r)}setThirdPerson(t,i,r,a,n){this.object=t,this.object.visible=!1,this.object.traverse((function(e){e.frustumCulled=!1}));let s=new THREE.Vector3;this.object.originBox.getSize(s),this.object.originBox.max.z-=.45*s.z,this.object.originBox.min.z-=.5*s.z,this.object.originBox.min.y-=.3*(s.x-s.y),this.objectId=i,this.externalObjectManager=r,this.mixer=new THREE.AnimationMixer(this.object);var o=THREE.AnimationUtils.subclip(this.object.animations[0],"walk",0,30,30),l=THREE.AnimationUtils.subclip(this.object.animations[0],"run",141,200,30),d=THREE.AnimationUtils.subclip(this.object.animations[0],"stand",65,66,30);this.actions=[],this.actions[this.poseEnum.walk]=this.mixer.clipAction(o),this.actions[this.poseEnum.run]=this.mixer.clipAction(l),this.actions[this.poseEnum.stand]=this.mixer.clipAction(d),this.actions[this.poseEnum.stand].play(),this.prepare(a,n);var h=new THREE.Vector3(0,.5*t.box.getSize(e).y,0);this.distanceTol=Math.abs(this.cameraControl.scene.worldToDrawing(h).z)}_initializeObject(){var e=this.cameraControl,t=this.object;t.visible=!0,t.disPickable=!0,this.changePose(this.poseEnum.stand),this.object.updateMatrixWorld(),e.flyOnWorld(!1)}prepare(e,t){var i=this;this.object.visible=!1,this._initializeCamera(t,(function(){i.walkIndex=e?i.poseEnum.run:i.poseEnum.walk,i._initializeObject(),i.prepared=!0,i.oldHitDetection=r.GlobalData.EnableHitDetection,i.oldGravity=r.GlobalData.WalkingWithGravity,r.GlobalData.EnableHitDetection=!0,r.GlobalData.WalkingWithGravity=!0,i.oldCollisionDis=i.cameraControl.collisionManager.getDistance(),i.cameraControl.collisionManager.setDistance((e?8:1)+i.distanceTol),i.oldMinPitch=i.cameraControl.minPitch,i.oldMaxPitch=i.cameraControl.maxPitch,i.cameraControl.minPitch=-Math.PI/3,i.cameraControl.maxPitch=Math.PI/3}))}onExit(){super.onExit(),this.prepared=!1,this.object.visible=!1,r.GlobalData.EnableHitDetection=this.oldHitDetection,r.GlobalData.WalkingWithGravity=this.oldGravity,this.cameraControl.collisionManager.setDistance(this.oldCollisionDis),this.cameraControl.minPitch=this.oldMinPitch,this.cameraControl.maxPitch=this.oldMaxPitch,this.cameraControl.flyOnWorld(!1)}changePose(e){if(this.poseIndex!=e){var t=this.actions[this.poseIndex],i=this.actions[e],a=1*this.unitRate/r.EditorConfig.WalkSpeedRate;t.fadeOut(a),i.reset(),i.setEffectiveTimeScale(1),i.setEffectiveWeight(1),i.fadeIn(a),i.play(),this.poseIndex=e}}_getCameraPositionByPos(e,t){let i=e.clone();const r=this.cameraControl.scene.getMatrixGlobal();let a=new THREE.Matrix4;a.copy(r).invert(),i.applyMatrix4(a);var n=i.distanceTo(t),s=this.cameraDis/n,o=new THREE.Vector3;return o.subVectors(i,t),o.multiplyScalar(s),o.addVectors(t,o),o.applyMatrix4(r),o}_initializeCamera(e,t){e&&null!=e.x&&null!=e.y&&null!=e.z?this._initializeCameraWithPosition(e,t):this._initializeCameraWithoutPosition(t)}_initializeCameraWithPosition(e,t){var i=this.cameraControl.camera,r=this.cameraControl.viewer,a=i.position,n=1e3*this.unitRate;this.externalObjectManager.setTransform(this.objectId,void 0,new THREE.Vector3(n,n,n));let s=new THREE.Vector3;this.object.box.getSize(s);let o=new THREE.Vector3(0,0,.5*s.z);if(o.addVectors(o,e),o.equals(this.object.position))return void(t&&t());let l=new THREE.Vector3(0,0,s.z);l.addVectors(l,e);let d=this._getCameraPositionByPos(a,l);var h=r.worldToDrawing(l);this.updateRotateForObject(d,h),this.externalObjectManager.setTransform(this.objectId,o,void 0,this.rotateQuaternion),this.rotatePivot.set(o.x,o.y,o.z);var c={position:i.position.clone(),target:i.target.clone(),up:i.realUp.clone()||i.up.clone(),zoom:i.zoom},u={position:d,target:h,up:new THREE.Vector3(0,1,0),zoom:i.zoom};r.animator.active(c,u,r,(function(e){r.cameraControl.update(!0,!0)}),(function(){t&&t()}))}_initializeCameraWithoutPosition(t){if(this.prepared)t&&t();else{var i=this.cameraControl.camera,r=this.cameraControl.viewer,a=i.position,n=this.cameraControl.scene.getBoundingBox(),s=(this.cameraControl.scene.getBoundingBoxWorld(),new THREE.Vector3(a.x,n.max.y,a.z)),o=function(e,t){var i=e.x<t.min.x?0:1,r=e.x<t.max.x?0:2,a=e.z<t.min.z?0:4,n=e.z<t.max.z?0:8,s=t.max.y,o=e;switch(i|r|a|n){case 0:o=new THREE.Vector3(t.min.x,s,t.min.z);break;case 1:o=new THREE.Vector3(e.x,s,t.min.z);break;case 3:o=new THREE.Vector3(t.max.x,s,t.min.z);break;case 4:o=new THREE.Vector3(t.min.x,s,e.z);break;case 7:o=new THREE.Vector3(t.max.x,s,e.z);break;case 12:o=new THREE.Vector3(t.min.x,s,t.max.z);break;case 13:o=new THREE.Vector3(e.x,s,t.max.z);break;case 15:o=new THREE.Vector3(t.max.x,s,t.max.z)}return o}(s,n),l=o.equals(s)?i.target.clone():n.getCenter(e);l.y=o.y;var d=this.cameraControl.scene.getMatrixGlobal(),h=i.getPositionByDis(this.cameraDis,d,o,l);h.z=r.drawingToWorld(o).z,this.updateRotateForObject(o,l);var c=1e3*this.unitRate;this.externalObjectManager.setTransform(this.objectId,h,new THREE.Vector3(c,c,c),this.rotateQuaternion),this.cameraControl.computeManHeight(this.object),this.cameraControl.computeGravity(this.object),o.y-=this.cameraControl.gravity*r.getScene().getGlobalScaleFactor(),l.y=o.y,this.cameraControl.gravity=0;var u=i.getPositionByDis(this.cameraDis,d,o,l);this.externalObjectManager.setTransform(this.objectId,u),this.rotatePivot.set(u.x,u.y,u.z);var p={position:i.position.clone(),target:i.target.clone(),up:i.realUp.clone()||i.up.clone(),zoom:i.zoom},m={position:o,target:l,up:new THREE.Vector3(0,1,0),zoom:i.zoom};r.animator.active(p,m,r,(function(e){r.cameraControl.update(!0,!0)}),(function(){t&&t()}))}}getObjectPosition(){if(this.object){let e=this.object.position,t=new THREE.Vector3;return this.object.box.getSize(t),{x:e.x,y:e.y,z:e.z-.5*t.z}}return null}}r.ThirdPersonWalkEditor=t})(),r.EditorManager=function(){this.editor=null,this.editors={},this.tools=[],this.domElement=null,this.enabled=!0,this.isUpdateRenderList=!0,this._mousePressed=!1,this.userInputEditor=null,this._pressedKeys=[];var e=this;function t(t){if(!function(e,t){if(e==t)return!0;if(!t||!t.nodeType||1!==t.nodeType)return!1;if(e.contains)return e.contains(t);if(e.compareDocumentPosition)return!!(16&e.compareDocumentPosition(t));for(var i=t.parentNode;i&&i!=window.document.body;){if(i==e)return!0;i=i.parentNode}return!1}(e.domElement,t.target)&&(e.editor.name==r.EditorMode.THIRDPERSONWALK||e.editor.name==r.EditorMode.WALK)&&e._pressedKeys.length>0){for(let t=0;t<e._pressedKeys.length;t++){let i=new KeyboardEvent("keyup",{keyCode:e._pressedKeys[t]});e.editor.processKeyUp(i)}e._pressedKeys.length=0}}function i(t){if(!e.enabled)return void(e.cameraChange=!1);const i=e.tools;for(var r=i.length-1;r>=0;r--)if(i[r].onEvent(t)){if("mouseup"===t.type)e.userInputEditor.processMouseUp(t),e._mousePressed=!1;return}switch(t.type){case"touchmove":!function(t){e.editor.isUserInputEditor()||e.editor.processTouchmove(t),e.userInputEditor.processTouchmove(t)}(t);break;case"touchstart":!function(t){e.editor.isUserInputEditor()||e.editor.processTouchstart(t),e.userInputEditor.processTouchstart(t)}(t);break;case"touchend":!function(t){e.editor.isUserInputEditor()||e.editor.processTouchend(t),e.userInputEditor.processTouchend(t)}(t);break;case"keydown":!function(t){e._pressedKeys.indexOf(t.keyCode)<=-1&&e._pressedKeys.push(t.keyCode),e.editor.isUserInputEditor()||e.editor.processKeyDown(t),e.userInputEditor.processKeyDown(t)}(t);break;case"keyup":!function(t){var i=e._pressedKeys.indexOf(t.keyCode);i>-1&&e._pressedKeys.splice(i,1),e.editor.isUserInputEditor()||e.editor.processKeyUp(t),e.userInputEditor.processKeyUp(t)}(t);break;case"mousewheel":case"DOMMouseScroll":!function(t){e.cameraChange=!0,e.editor.isUserInputEditor()||e.editor.processMouseWheel(t),e.userInputEditor.processMouseWheel(t)}(t);break;case"mousedown":!function(t){a(),e._mousePressed=!0,e.isUpdateRenderList=!1,e.editor.isUserInputEditor()||e.editor.processMouseDown(t),e.userInputEditor.processMouseDown(t)}(t);break;case"mousemove":!function(t){e._mousePressed?(e.isUpdateRenderList=!1,e.cameraChange=!0,e.editor.isUserInputEditor()||e.editor.processMouseMove(t),e.userInputEditor.processMouseMove(t)):e.editor.processHover(t)}(t);break;case"mouseup":!function(t){e.isUpdateRenderList=!0,e._mousePressed&&(e.editor.isUserInputEditor()||e.editor.processMouseUp(t),e.userInputEditor.processMouseUp(t),e._mousePressed=!1)}(t);break;case"dblclick":e.editor.processMouseDoubleClick(t)}}function a(){if(e.domElement){var t=e.domElement.querySelector("#cloud-main-canvas");t&&t.focus&&t.focus()}}function n(e){e.preventDefault()}this.registerDomEventListeners=function(e){this.domElement=e;let s=()=>{e.addEventListener("touchstart",i,!1),e.addEventListener("touchend",i,!1),e.addEventListener("touchmove",i,!1)},o=()=>{e.addEventListener("contextmenu",n,!1),e.addEventListener("mousedown",i,!1),e.addEventListener("mousewheel",i,!1),e.addEventListener("DOMMouseScroll",i,!1),e.addEventListener("dblclick",i,!1),window.addEventListener("mousemove",i,!1),window.addEventListener("mouseup",i,!1),e.addEventListener("keydown",i,!1),e.addEventListener("keyup",i,!1),window.addEventListener("mousedown",t,!1)};"windows"===r.Utils.getOS()?(s(),o()):r.GlobalData.IsMobile?s():o(),a()},this.unregisterDomEventListeners=function(e){let a=()=>{e.removeEventListener("touchstart",i,!1),e.removeEventListener("touchend",i,!1),e.removeEventListener("touchmove",i,!1)},s=()=>{e.removeEventListener("contextmenu",n,!1),e.removeEventListener("mousedown",i,!1),e.removeEventListener("mousewheel",i,!1),e.removeEventListener("DOMMouseScroll",i,!1),e.removeEventListener("dblclick",i,!1),window.removeEventListener("mousemove",i,!1),window.removeEventListener("mouseup",i,!1),e.removeEventListener("keydown",i,!1),e.removeEventListener("keyup",i,!1),window.removeEventListener("mousedown",t,!1)};"windows"===r.Utils.getOS()?(a(),s()):r.GlobalData.IsMobile?a():s()}},r.EditorManager.prototype={constructor:r.EditorManager,destroy:function(){for(var e in this.editors){this.editors[e].destroy()}this.editors=null,this.editor=null;for(var t=0,i=this.tools.length;t<i;t++)this.tools[t].destroy();this.tools=null,this.unregisterDomEventListeners(this.domElement),this.domElement=null},getCurrentEditorName:function(){return this.editor?this.editor.name:""},_getEditorByName:function(e,t){let i=this.editors[t];const a=r.EditorMode;this.viewer=e;const n=e.cameraControl;switch(t){case a.ORBIT:this.userInputEditor.setOrbitEditorMode(),i=this.userInputEditor.orbitEditor;break;case a.PAN:this.userInputEditor.setPanEditorMode(),i=this.userInputEditor.panEditor;break;case a.ZOOM:this.userInputEditor.setZoomEditorMode(),i=this.userInputEditor.zoomEditor;break;case a.PICK:this.userInputEditor.setDefaultEditorMode(),i=r.Utils.isDefined(i)?i:new r.PickEditor(n);break;case a.FLY:this.userInputEditor.enable=!1,i=r.Utils.isDefined(i)?i:new r.FlyEditor(n);break;case a.WALK:this.userInputEditor.enable=!1,i=r.Utils.isDefined(i)?i:new r.WalkEditor(n);break;case a.THIRDPERSONWALK:this.userInputEditor.enable=!1,i=r.Utils.isDefined(i)?i:new r.ThirdPersonWalkEditor(n);break;default:i=null,console.error("invalid editor name")}return i&&(i.name=t,this.editors[t]=i),i},getCurrentEditor:function(){return this.editor},getUserInputEditor(){return this.userInputEditor},setupUserInputEditor(e){this.userInputEditor=new r.UserInputEditor(e)},setEditorMode:function(e,t){var i=this._getEditorByName(e,t);i&&this.editor!==i&&(null!==this.editor&&(this.editor.dispatchEvent({type:r.EVENTS.ON_EDITOR_EXIST,name:this.editor.getName()}),this.editor.onExit()),this.editor=i,this.editor.onEnter(),this.editor.dispatchEvent({type:r.EVENTS.ON_EDITOR_ENTER,name:this.editor.getName()}))},getToolByName:function(e){for(var t=this.tools.length,i=0;i<t;++i)if(this.tools[i].name==e)return this.tools[i];return null},enableTool:function(e,t){var i=r.EditToolMode,a=null;if(a=this.getToolByName(t))return a;switch(t){case i.PICK_BY_RECT:a=new r.RectPickTool(e);break;case i.ZOOM_BY_RECT:a=new r.RectZoomTool(e);break;case i.CLIP_BY_BOX:a=new r.ClipPlanesTool(e);break;case i.CLIP_FILL:a=new r.FillClipPlaneTool(e);break;case i.PICK_BY_MEASURE:a=new r.MeasureTool(e);break;case i.VIEW_SHED_ANALYSIS:a=new r.ViewshedTool(e);break;case i.VOLUME_MEASURE:a=new r.VolumeMeasureTool(e)}return a&&this.tools.push(a),a},disableTool:function(e){for(var t=this.tools,i=0,r=t.length;i<r;i++)if(t[i].name==e){t[i].onExit(),t.splice(i,1);break}},setInteractiveState:function(e){this.enabled=e},update:function(){this.userInputEditor.update()},onRender:function(){this.userInputEditor.onRender()}},r.SelectPad=class{constructor(e){this.editor=e,this.cameraControl=e.cameraControl,this.dim=this.cameraControl.getContainerDimensions(),this.pad=null,this.padSize=96,this.startPt=new THREE.Vector2,this.position=new THREE.Vector2,this.callback=null,this.intersect=null,this.init(),this.padInitBind=this.padInit.bind(this),this.padOnTouchStartBind=this.onTouchStart.bind(this),this.padOnTouchEndBind=this.onTouchEnd.bind(this),this.padOnTouchMoveBind=this.onTouchMove.bind(this)}destroy(){this.editor=null,this.cameraControl=null,this.dim=null,this.pad=null,this.startPt=null,this.position=null,this.callback=null,this.intersect=null}init(){window.addEventListener("resize",this.padInitBind,!1),this.pad=document.createElement("div"),this.padInit(),this.cameraControl.domElement.appendChild(this.pad),this.addEventListener()}addEventListener(){this.pad.addEventListener("touchstart",this.padOnTouchStartBind,!1),this.pad.addEventListener("touchmove",this.padOnTouchMoveBind,!1),this.pad.addEventListener("touchend",this.padOnTouchEndBind,!1)}padInit(){null!=this.pad&&(this.pad.style.backgroundImage="url(images/selectPad.png)",this.pad.style.backgroundSize="100%",this.pad.style.position="absolute",this.pad.style.width=this.padSize.toString()+"px",this.pad.style.height=this.padSize.toString()+"px",this.pad.style.zIndex="10",this.pad.style.display="none")}showOverlay(e){this.position=e,this.pad.style.left=this.position.x.toString()+"px",this.pad.style.top=(this.position.y-this.dim.top).toString()+"px",this.pad.style.display=""}hideOverlay(){this.pad.style.display="none"}pick(){var e=this.position.x,t=this.position.y,i=this.cameraControl,r=(this.editor.pickHelper,i.viewer.modelManager.sceneState),a=this,n=new THREE.Vector2(e,t),s=i.getIntersectContext(n);i.intersector.pick(s,(function(e){if(r.clearSelection(),!e)return i.updateView(!0),void(a.intersect=null);var t=e.userId;i.viewer.getScene().intersectToWorld(e,i.viewer),r.addSelection([t]),a.intersect=e,i.updateView(!0)})),null!=a.intersect&&(a.intersect.cx=e,a.intersect.cy=t)}onTouchStart(e){1===e.touches.length&&(e.stopPropagation(),e.preventDefault(),this.startPt.set(e.touches[0].clientX,e.touches[0].clientY))}onTouchMove(e){if(1===e.touches.length){e.stopPropagation(),e.preventDefault();var t=e.touches[0].clientX-this.startPt.x,i=e.touches[0].clientY-this.startPt.y;this.position.x+=t,this.position.y+=i,this.pad.style.left=this.position.x.toString()+"px",this.pad.style.top=(this.position.y-this.dim.top).toString()+"px",this.startPt.set(e.touches[0].clientX,e.touches[0].clientY),this.pick(e)}}onTouchEnd(e){e.stopPropagation(),null!=this.callback?this.callback(this.intersect):console.log("selectPad click",this.intersect)}},r.UserInputEditor=class{constructor(e){this.viewer=e,this.cameraControl=e.cameraControl,this.panEditor=new r.PanEditor(this.cameraControl),this.orbitEditor=new r.OrbitEditor(this.cameraControl),this.zoomEditor=new r.ZoomEditor(this.cameraControl),this.enable=!0,this.currentMouseMode="right",this.actionTool=new r.ActionTool(this.cameraControl)}setDefaultEditorMode(){this.enable=!0,this.panEditor.enable=!0,this.orbitEditor.enable=!0,this.zoomEditor.enable=!0,this.switchHandMode(this.currentMouseMode)}setPanEditorMode(){this.enable=!0,this.panEditor.enable=!0,this.orbitEditor.enable=!1,this.zoomEditor.enable=!0,this.panEditor.mouseButtons={PAN2:THREE.MOUSE.RIGHT,PAN:THREE.MOUSE.LEFT},this.zoomEditor.mouseButtons={}}setOrbitEditorMode(){this.enable=!0,this.panEditor.enable=!0,this.orbitEditor.enable=!0,this.zoomEditor.enable=!0,this.setDefaultEditorMode()}setZoomEditorMode(){this.enable=!0,this.panEditor.enable=!0,this.orbitEditor.enable=!1,this.zoomEditor.enable=!0,this.panEditor.mouseButtons={PAN2:THREE.MOUSE.MIDDLE,PAN:THREE.MOUSE.RIGHT},this.zoomEditor.mouseButtons={ZOOM:THREE.MOUSE.LEFT}}switchHandMode(e){this.currentMouseMode=e,"left"===e?(this.panEditor.mouseButtons={PAN2:THREE.MOUSE.MIDDLE,PAN:THREE.MOUSE.RIGHT},this.orbitEditor.mouseButtons={ORBIT:THREE.MOUSE.LEFT}):"right"===e&&(this.panEditor.mouseButtons={PAN2:THREE.MOUSE.MIDDLE,PAN:THREE.MOUSE.LEFT},this.orbitEditor.mouseButtons={ORBIT:THREE.MOUSE.RIGHT})}update(){this.cameraControl.isEnableDamping()&&this.enable&&(this.panEditor.dynamicPan(),this.orbitEditor.dynamicRotate(),this.zoomEditor.dynamicZoom())}onRender(){this.actionTool.isProcessingMouse()&&this.actionTool.execute()}processMouseDown(e){this.enable&&(this.actionEditorList=[],this.cameraControl.isEnableDamping()&&this.resetDynamicMoving(),this.panEditor.processMouseDown(e,this.actionTool),this.orbitEditor.processMouseDown(e,this.actionTool),this.zoomEditor.processMouseDown(e,this.actionTool))}processMouseMove(e){this.enable&&(this.panEditor.processMouseMove(e,this.actionTool),this.orbitEditor.processMouseMove(e,this.actionTool),this.zoomEditor.processMouseMove(e,this.actionTool))}processMouseUp(e){this.enable&&(this.panEditor.processMouseUp(e,this.actionTool),this.orbitEditor.processMouseUp(e,this.actionTool),this.zoomEditor.processMouseUp(e,this.actionTool))}processMouseWheel(e){this.enable&&(this.cameraControl.isEnableDamping()&&this.resetDynamicMoving(),this.zoomEditor.processMouseWheel(e,this.actionTool))}processKeyDown(e){this.enable&&this.panEditor.processKeyDown(e,this.actionTool)}processTouchmove(e){this.enable&&(this.panEditor.processTouchmove(e,this.actionTool),this.orbitEditor.processTouchmove(e,this.actionTool),this.zoomEditor.processTouchmove(e,this.actionTool))}processTouchstart(e){this.enable&&(this.panEditor.processTouchstart(e,this.actionTool),this.orbitEditor.processTouchstart(e,this.actionTool),this.zoomEditor.processTouchstart(e,this.actionTool))}processTouchend(e){this.enable&&(this.panEditor.processTouchend(e,this.actionTool),this.orbitEditor.processTouchend(e,this.actionTool),this.zoomEditor.processTouchend(e,this.actionTool))}processKeyUp(e){this.enable&&this.panEditor.processKeyUp(e,this.actionTool)}resetDynamicMoving(){this.enable&&(this.orbitEditor.resetDynamicRotate(),this.panEditor.resetDynamicPan(),this.zoomEditor.resetDynamicZoom())}resetMobileParamsByBox(e){this.zoomEditor.resetMobileParamsByBox(e)}setZoomSpeed(e){this.zoomEditor.setZoomSpeed(e)}getZoomSpeed(){return this.zoomEditor.getZoomSpeed()}},r.InputStatusMonitor=class{constructor(e){this._cameraChanging=!1,this.editorManager=e,this._isEnable=!0,this.isZooming=void 0,this.isRotating=void 0,this.isMoving=void 0}destroy(){this._cameraChanging=void 0,this.editorManager=null,this.isZooming=void 0,this.isRotating=void 0,this.isMoving=void 0}needsStopUpdateScene(){if(!1===this._isEnable)return!1;this.editorManager._mousePressed;const e=this.editorManager.userInputEditor.zoomEditor.isZooming,t=this.editorManager.userInputEditor.orbitEditor.mouseMoving,i=this.editorManager.userInputEditor.panEditor.mouseMoving;return!0===e||!0===t||!0===i}get isCameraChanging(){return this._cameraChanging}set isCameraChanging(e){this._cameraChanging=e}enableStopUpdateScene(e){this._isEnable=e}forceShouldRender(){if(!1===this._isEnable)return!1;const e=this.editorManager.userInputEditor.zoomEditor.isZooming,t=this.editorManager.userInputEditor.orbitEditor.mouseMoving,i=this.editorManager.userInputEditor.panEditor.mouseMoving;let r=!1;return(!0===this.isZooming&&!1===e||!0===this.isRotating&&!1===t||!0===this.isMoving&&!1===i)&&(r=!0),this.isZooming=e,this.isRotating=t,this.isMoving=i,r}},function(){function e(e,t,i){return t<=e&&e<=i}function t(e){if(void 0===e)return{};if(e===Object(e))return e;throw TypeError("Could not convert argument to dictionary")}function i(e){this.tokens=[].slice.call(e)}i.prototype={endOfStream:function(){return!this.tokens.length},read:function(){return this.tokens.length?this.tokens.shift():-1},prepend:function(e){if(Array.isArray(e))for(var t=e;t.length;)this.tokens.unshift(t.pop());else this.tokens.unshift(e)},push:function(e){if(Array.isArray(e))for(var t=e;t.length;)this.tokens.push(t.shift());else this.tokens.push(e)}};var r=-1;function a(e,t){if(e)throw TypeError("Decoder error");return t||65533}var n="utf-8";function s(e,i){if(!(this instanceof s))return new s(e,i);if((e=void 0!==e?String(e).toLowerCase():n)!==n)throw new Error("Encoding not supported. Only utf-8 is supported");i=t(i),this._streaming=!1,this._BOMseen=!1,this._decoder=null,this._fatal=Boolean(i.fatal),this._ignoreBOM=Boolean(i.ignoreBOM),Object.defineProperty(this,"encoding",{value:"utf-8"}),Object.defineProperty(this,"fatal",{value:this._fatal}),Object.defineProperty(this,"ignoreBOM",{value:this._ignoreBOM})}function o(e,i){if(!(this instanceof o))return new o(e,i);if((e=void 0!==e?String(e).toLowerCase():n)!==n)throw new Error("Encoding not supported. Only utf-8 is supported");i=t(i),this._streaming=!1,this._encoder=null,this._options={fatal:Boolean(i.fatal)},Object.defineProperty(this,"encoding",{value:"utf-8"})}function l(t){var i=t.fatal,n=0,s=0,o=0,l=128,d=191;this.handler=function(t,h){if(-1===h&&0!==o)return o=0,a(i);if(-1===h)return r;if(0===o){if(e(h,0,127))return h;if(e(h,194,223))o=1,n=h-192;else if(e(h,224,239))224===h&&(l=160),237===h&&(d=159),o=2,n=h-224;else{if(!e(h,240,244))return a(i);240===h&&(l=144),244===h&&(d=143),o=3,n=h-240}return n<<=6*o,null}if(!e(h,l,d))return n=o=s=0,l=128,d=191,t.prepend(h),a(i);if(l=128,d=191,n+=h-128<<6*(o-(s+=1)),s!==o)return null;var c=n;return n=o=s=0,c}}function d(t){t.fatal;this.handler=function(t,i){if(-1===i)return r;if(e(i,0,127))return i;var a,n;e(i,128,2047)?(a=1,n=192):e(i,2048,65535)?(a=2,n=224):e(i,65536,1114111)&&(a=3,n=240);for(var s=[(i>>6*a)+n];a>0;){var o=i>>6*(a-1);s.push(128|63&o),a-=1}return s}}function h(){if("undefined"!=typeof self)return self;if("undefined"!=typeof global)return global;throw new Error("No global found")}s.prototype={decode:function(e,a){var n;n="object"==typeof e&&e instanceof ArrayBuffer?new Uint8Array(e):"object"==typeof e&&"buffer"in e&&e.buffer instanceof ArrayBuffer?new Uint8Array(e.buffer,e.byteOffset,e.byteLength):new Uint8Array(0),a=t(a),this._streaming||(this._decoder=new l({fatal:this._fatal}),this._BOMseen=!1),this._streaming=Boolean(a.stream);for(var s,o=new i(n),d=[];!o.endOfStream()&&(s=this._decoder.handler(o,o.read()))!==r;)null!==s&&(Array.isArray(s)?d.push.apply(d,s):d.push(s));if(!this._streaming){do{if((s=this._decoder.handler(o,o.read()))===r)break;null!==s&&(Array.isArray(s)?d.push.apply(d,s):d.push(s))}while(!o.endOfStream());this._decoder=null}return d.length&&(-1===["utf-8"].indexOf(this.encoding)||this._ignoreBOM||this._BOMseen||(65279===d[0]?(this._BOMseen=!0,d.shift()):this._BOMseen=!0)),function(e){for(var t="",i=0;i<e.length;++i){var r=e[i];r<=65535?t+=String.fromCharCode(r):(r-=65536,t+=String.fromCharCode(55296+(r>>10),56320+(1023&r)))}return t}(d)}},o.prototype={encode:function(e,a){e=e?String(e):"",a=t(a),this._streaming||(this._encoder=new d(this._options)),this._streaming=Boolean(a.stream);for(var n,s=[],o=new i(function(e){for(var t=String(e),i=t.length,r=0,a=[];r<i;){var n=t.charCodeAt(r);if(n<55296||n>57343)a.push(n);else if(56320<=n&&n<=57343)a.push(65533);else if(55296<=n&&n<=56319)if(r===i-1)a.push(65533);else{var s=e.charCodeAt(r+1);if(56320<=s&&s<=57343){var o=1023&n,l=1023&s;a.push(65536+(o<<10)+l),r+=1}else a.push(65533)}r+=1}return a}(e));!o.endOfStream()&&(n=this._encoder.handler(o,o.read()))!==r;)Array.isArray(n)?s.push.apply(s,n):s.push(n);if(!this._streaming){for(;(n=this._encoder.handler(o,o.read()))!==r;)Array.isArray(n)?s.push.apply(s,n):s.push(n);this._encoder=null}return new Uint8Array(s)}},"function"!=typeof TextDecoder&&(h().TextDecoder=s),"function"!=typeof TextEncoder&&(h().TextEncoder=o)}();class a{constructor(){this.utf8Decoder=new TextDecoder("utf-8")}parse(e){if(!e)return Promise.reject(e);const t=new DataView(e);let i=0;const r={};let a={},n={};if(r.magic=this.utf8Decoder.decode(new Uint8Array(e,i,4)),i+=4,r.magic){if(r.version=t.getUint32(i,!0),i+=Uint32Array.BYTES_PER_ELEMENT,r.byteLength=t.getUint32(i,!0),i+=Uint32Array.BYTES_PER_ELEMENT,r.FTJSONLength=t.getUint32(i,!0),i+=Uint32Array.BYTES_PER_ELEMENT,r.FTBinaryLength=t.getUint32(i,!0),i+=Uint32Array.BYTES_PER_ELEMENT,r.BTJSONLength=t.getUint32(i,!0),i+=Uint32Array.BYTES_PER_ELEMENT,r.BTBinaryLength=t.getUint32(i,!0),i+=Uint32Array.BYTES_PER_ELEMENT,r.FTBinaryLength>0&&(n=this.parseFeatureBinary(e,i,r.FTJSONLength)),r.BTJSONLength>0){const t=28+r.FTJSONLength+r.FTBinaryLength;a=BatchTableParser.parse(e.slice(t,r.BTJSONLength+t))}const s={point:n,batchTable:a};return Promise.resolve(s)}throw new Error("Invalid pnts file.")}parseFeatureBinary(e,t,i){const r=new THREE.BufferGeometry,a=this.utf8Decoder.decode(new Uint8Array(e,t,i)),n=JSON.parse(a);let s;if(n.POINTS_LENGTH&&(s=n.POINTS_LENGTH),n.POSITION){const i=n.POSITION.byteOffset+a.length+t,o=new Float32Array(e,i,3*s);r.setAttribute("position",new THREE.BufferAttribute(o,3))}if(n.RGB){const i=n.RGB.byteOffset+a.length+t,o=new Uint8Array(e,i,3*s);r.setAttribute("color",new THREE.BufferAttribute(o,3,!0))}if(n.POSITION_QUANTIZED)throw new Error("For pnts loader, POSITION_QUANTIZED: not yet managed");if(n.RGBA)throw new Error("For pnts loader, RGBA: not yet managed");if(n.RGB565)throw new Error("For pnts loader, RGB565: not yet managed");if(n.NORMAL){const i=n.RGB.byteOffset+a.length+t,o=new Float32Array(e,i,3*s);r.setAttribute("normal",new THREE.BufferAttribute(o,3))}if(n.NORMAL_OCT16P)throw new Error("For pnts loader, NORMAL_OCT16P: not yet managed");if(n.BATCH_ID)throw new Error("For pnts loader, BATCH_ID: not yet managed");return{geometry:r,offset:n.RTC_CENTER?(new THREE.Vector3).fromArray(n.RTC_CENTER):void 0}}}r.PntsParser=a;r.PntLoader=class{constructor(e,t){this.unitScale=t,this.pntParser=new a,this.utf8Decoder=new TextDecoder("utf-8"),this.tileIndexMap={},this.rootPntUrl=void 0,this.maximumScreenSpaceError=void 0===e?5:e,this.loadPromises=[],this.camera=void 0,this.globalInverseMatrix=new THREE.Matrix4,this.box=null,this.loadJsonPromises=[],this.pntFileList={}}loadPntTotalJson(e,t){let i=this;i.loadPromises=[],this.rootPntUrl=e.slice(0,e.lastIndexOf("/")+1);return new Promise((function(a,n){(new THREE.FileLoader).load(e,(function(e){let n=JSON.parse(e);i.box=n.root.boundingVolume.box,t&&t(i.box),i.parseTilesJson(n.root);var s=Promise.all(i.loadJsonPromises.map((function(e){return e.catch((function(e){return e}))}))),o=new r.TaskManager;s.then((e=>{let t=0;for(let e in i.tileIndexMap){let r=i.tileIndexMap[e];const a=e.slice(0,e.lastIndexOf("/")+1);for(let n in r.index){let s=a+r.index[n].content.url;o.addTask(t),i.pntFileList[t]={},i.pntFileList[t].jsonUrl=e,i.pntFileList[t].pntUrl=s,i.pntFileList[t].index=n,t++}}o.processTasks(i.loadPnt.bind(i),void 0,(function(e){var t={};for(let e in i.pntFileList){if(!((s=i.pntFileList[e].jsonUrl)in t)){let e=new r.ObjectGroup(r.ObjectGroupType.EXTRUDEBODYMANAGER,{pickableType:r.PICKABLETYPE.Geometry,globalSpace:!0});t[s]=e}i.tileIndexMap[s].index[i.pntFileList[e].index].points=i.pntFileList[e].result,t[s].add(i.pntFileList[e].result)}var n=[];for(var s in t)n.push(t[s]);a(n)}))}))}))}))}parseTilesJson(e){let t=this;if(e.content&&e.content.url){let i=this.rootPntUrl+e.content.url;t.loadTileSetJson(i)}if(e.children)for(let t of e.children)this.parseTilesJson(t)}loadTileSetJson(e){let t=this;const i=new Promise((function(i,r){var a=new THREE.FileLoader;a.setResponseType("json"),a.load(e,(function(a){if(null==a)r(a);else{let r=new ExtendTileset(a,"");t.tileIndexMap[e]=r;r.index[1],e.slice(0,e.lastIndexOf("/")+1);i(r)}}),void 0,(function(t){r(data),console.error(`Load ${e} failed, ${t}`)}))}));return t.loadJsonPromises.push(i),i}ProcessTileIndexs(e,t){this.camera=e,this.globalInverseMatrix=t;for(let e in this.tileIndexMap){const t=this.tileIndexMap[e].index[1];this.ProcessNode(t,e)}}ProcessNode(e,t,i){e.visible=!1;let r=this.tileIndexMap[t].index[e.tileId].points;if(null!=r){if(r.visible=!1,this.$3dTilesSubdivisionControl(this.camera,e)&&(r.visible=!0,e.visible=!0),null!=i)if("ADD"===i.refine.toUpperCase());else{i.visible=!1,this.tileIndexMap[t].index[i.tileId].visible=!1}if(e.children)for(let i of e.children)this.ProcessNode(i,t,e)}}$3dTilesSubdivisionControl(e,t){return this.computeNodeSSE(e,t)>this.maximumScreenSpaceError}computeNodeSSE(e,t){const i=new THREE.Box3,r=new THREE.Sphere;let a=e.position.clone();if(a.multiplyScalar(1/this.unitScale),a.applyMatrix4(this.globalInverseMatrix),t.distance=0,t.boundingVolume.region)i.copy(t.boundingVolume.region.box3D),i.applyMatrix4(t.boundingVolume.region.matrixWorld),t.distance=i.distanceToPoint(a);else if(t.boundingVolume.box)i.copy(t.boundingVolume.box),t.matrixWorld&&i.applyMatrix4(t.matrixWorld),t.distance=i.distanceToPoint(a);else{if(!t.boundingVolume.sphere)return 1/0;r.copy(t.boundingVolume.sphere),r.applyMatrix4(t.matrixWorld),t.distance=Math.max(0,r.distanceToPoint(a))}return 0===t.distance?1/0:(t.geometricError-0<1e-4&&(t.geometricError=1),e._preSSE*(t.geometricError/t.distance))}updatePreSse(e,t){const i=e.fov,r=THREE.Math.degToRad(i),a=t/(2*Math.tan(.5*r));e._preSSE=a}loadPnt(e,t){let i=this;var r=i.pntFileList[e].pntUrl;return new Promise((function(a,n){var s=new THREE.FileLoader;s.setResponseType("arraybuffer"),s.load(r,(function(a){if(void 0!==a){const n=i.utf8Decoder.decode(new Uint8Array(a,0,4));if("{"===n[0]){a=JSON.parse(i.utf8Decoder.decode(new Uint8Array(a)));r.slice(0,r.lastIndexOf("/")+1)}else if("b3dm"==n)console.log("b3dm is load");else{if("pnts"!=n)return Promise.reject(`Unsupported magic code ${n}`);console.log("pnts is load")}i.pntParser.parse(a).then((a=>{const n=new THREE.PointsMaterial({size:.05,vertexColors:THREE.VertexColors}),s=new THREE.Points(a.point.geometry,n);a.point.offset&&s.position.copy(a.point.offset),s.visible=!1,s.name=r,i.pntFileList[e].result=s,t()}))}}),void 0,(function(e){n(void 0)}))}))}loadPntByPromise(e){let t=this;return new Promise((function(i,r){var a=new THREE.FileLoader;a.setResponseType("arraybuffer"),a.load(e,(function(r){if(void 0!==r){const a=t.utf8Decoder.decode(new Uint8Array(r,0,4));if("{"===a[0]){r=JSON.parse(t.utf8Decoder.decode(new Uint8Array(r)));e.slice(0,e.lastIndexOf("/")+1)}else if("b3dm"==a)console.log("b3dm is load");else{if("pnts"!=a)return Promise.reject(`Unsupported magic code ${a}`);console.log("pnts is load")}t.pntParser.parse(r).then((t=>{const r=new THREE.PointsMaterial({size:.05,vertexColors:THREE.VertexColors}),a=new THREE.Points(t.point.geometry,r);t.point.offset&&a.position.copy(t.point.offset),a.visible=!1,a.name=e,i(a)}))}}),void 0,(function(e){r(void 0)}))}))}loadPntTotalJsonByPromise(e,t){let i=this;i.loadPromises=[],this.rootPntUrl=e.slice(0,e.lastIndexOf("/")+1);return new Promise((function(a,n){(new THREE.FileLoader).load(e,(function(e){let n=JSON.parse(e);i.box=n.root.boundingVolume.box,t&&t(i.box),i.parseTilesJson(n.root),Promise.all(i.loadJsonPromises.map((function(e){return e.catch((function(e){return e}))}))).then((e=>{var t=[];for(let e in i.tileIndexMap){i.urlPointGroupMap[e]={};let r=i.tileIndexMap[e];const a=e.slice(0,e.lastIndexOf("/")+1);for(let n in r.index){let s=a+r.index[n].content.url;t.push(i.loadPnt(s).then((t=>({url:e,context:{index:n,result:t}}))))}}Promise.all(t.map((function(e){return e.catch((function(e){return e}))}))).then((e=>{for(let e in i.urlPointGroupMap){let t=new r.ObjectGroup(r.ObjectGroupType.EXTRUDEBODYMANAGER,{pickableType:r.PICKABLETYPE.Geometry,globalSpace:!0});i.urlPointGroupMap[e]=t}for(const t of e){if(void 0!==t)i.tileIndexMap[t.url].index[t.context.index].points=t.context.result,i.urlPointGroupMap[t.url].add(t.context.result)}var t=[];for(var n in i.urlPointGroupMap)t.push(i.urlPointGroupMap[n]);a(t)}))})).catch((function(e){console.log("promise reject failed reason",e)}))}))}))}},r.Version="1.0.0.20200210",r.BuildVersion="2022-9-14 5:51:26 PM",r.GlobalData={SceneSize:1e3,TextureResRoot:"images/",EnableTextureMapping:!1,EnableTextureLoading:!0,MaxTexturePixels:25e4,EnableLightmap:!1,LightmapIntensity:1,ClippingCaps:!0,ClippingCapsType:0,SelectionColor:{color:1170103,side:THREE.DoubleSide},DisableAntialias:!1,EnableDemolishByDClick:!1,IsMobile:!1,WorkersRoot:"../libs/",WorkerEnabled:!1,ZipResourcePostfix:".gz",JsonResourcePostfix:".json",HasLayerData:!1,Instance:!0,InstanceAsyncProcessing:!1,InstanceAsyncProcessingStep:500,InstanceSharedMeshEnabled:!0,InstanceSharedMeshThreshold:10,BatchAsyncProcessingFrequency:10,DataProvider:0,Renderer:0,MaxMemeorySizeToFullRender:1500,BatchMergeEnabled:!1,SegmentedBatchMergeEnable:!1,maxIndicesNumberPerBathSegment:65535,IncrementRender:!0,LimitFrameTime:250,maxObjectNumInPool:6e4,maxDrawCacheNum:4e4,OctantDepth:15,MaximumDepth:0,ConcurrencyRequestCount:8,ShowOctant:!1,EnableOctant:!0,LightPreset:3,IBL:!1,ToneMapping:1,LightIntensityFactor:1.5,Hover:!1,MouseMovePick:!1,OcclusionTranslucentEnabled:!1,OcclusionOpacity:.5,OcclusionDistanceToCamera:1e3,LineSelectRange:30,DrawingStyle:0,DrawingBoardlineEnabled:!0,DrawingBoardlineLimit:!0,DrawingBoardlineLimitThreshold:2e5,CanUseWireframeFromData:!0,BorderLineBatched:!1,BorderLineDelayLoaded:!1,InitWireframeData:!1,SSAO:!1,EnableGlow:!1,GlowCount:0,HighLightOutlineCount:0,BloomCount:0,EnableShadowMap:!1,MeasureHighlightPlane:!1,WalkingWithGravity:!1,EnableHitDetection:!1,TranslucentDepthDisabled:!1,LoadMpkOnDemand:!1,EnableLoadOnDemand:!0,EnableSnowPass:!1,EnableFogPass:!1,EnableRainPass:!1,EnableSkylinePass:!1,ScanRingCount:0,FanScanCount:0,EnableDisposeBufferAfterVbo:!0,OrganizeNodesByCameraView:!1,CanUseCompressedTexture:!1,CanUseSmallTexture:!0,DEBUG:!1,EnableExplosion:!1,EnableLogarithmicDepthBuffer:!1,ConstraintZoom:!1,PickingEffect:!0,PickingLineWidthEnabled:!1,EnableGisMap:!1,TerrainScale:1,TerrainResourceFileName:"terrain.bin",TerrainZipResourceFileName:"terrain.gz",TilePlaneGroupName:"TilePlaneGroup",TileGlobalGroupName:"TileGlobalGroup",TdTileGroupName:"3dTilesGroup",BimTilesGroupName:"BimTilesGroup",DracoLibUrl:void 0,DynamicScheduling:!1,EnableSplitComponent:!1,DelayLoadTexture:!1,EnableLodDemDom:!1,EnableCSM:!1,SceneUnit:void 0,ForcedUseWebgl1:!1,EnableDomainDiversion:!0,WalkRotationSpeed:1,InputDelayTimeInterval:1e3},r.EnumStandardView={ISO:0,Top:1,Bottom:2,Front:3,Back:4,Right:5,Left:6,SouthEast:7,SouthWest:8,NorthEast:9,NorthWest:10,BottomFront:11,BottomBack:12,BottomRight:13,BottomLeft:14,BottomSouthEast:15,BottomSouthWest:16,BottomNorthEast:17,BottomNorthWest:18,RoofFront:19,RoofBack:20,RoofRight:21,RoofLeft:22,RoofSouthEast:23,RoofSouthWest:24,RoofNorthEast:25,RoofNorthWest:26,TopTurnRight:27,TopTurnBack:28,TopTurnLeft:29,BottomTurnRight:30,BottomTurnBack:31,BottomTurnLeft:32,FrontTurnRight:33,FrontTurnTop:34,FrontTurnLeft:35,RightTurnBack:36,RightTurnTop:37,RightTurnFront:38,BackTurnRight:39,BackTurnTop:40,BackTurnLeft:41,LeftTurnFront:42,LeftTurnTop:43,LeftTurnBack:44},r.CAMERATYPE={ORTHOGRAPHIC:0,PERSPECTIVE:1},r.OPSELECTIONTYPE={Clear:0,Add:1,Remove:2},r.PICKABLETYPE={Geometry:1,Marker3d:2,Room:3,ExternalComponent:4,Axis:5,Map:6,UnPickable:0},r.LOADERROREVENTS={LOAD_ERROR:1e3,LOAD_SCENE_ERROR:1001,LOAD_MATERIAL_ERROR:1002,LOAD_SYMBOL_ERROR:1003,LOAD_OCTREEINNER_ERROR:1004,LOAD_OCTREEOUTER_ERROR:1005,LOAD_USERID_ERROR:1006,LOAD_USERDATA_ERROR:1007,LOAD_CAMERA_ERROR:1008,LOAD_TEXTURE_ERROR:1009,LOAD_MPK_ERROR:1010,LOAD_IBLCONFIG_ERROR:1011},r.EnumRenderType={RENDER:0,RENDER_FINISHED:1,RESIZE:2},r.PrimitiveCount={vertexCount:0,triangleCount:0},r.RotatePivotMode={MOUSEPOINT:0,SELECTION:1,CENTER:2,CAMERA:3},r.EditorMode={ORBIT:"orbit",PICK:"pick",PAN:"pan",ZOOM:"zoom",FLY:"fly",WALK:"walk",THIRDPERSONWALK:"ThirdPersonWalk"},r.EditToolMode={PICK_BY_RECT:"pickByRect",ZOOM_BY_RECT:"zoomByRect",CLIP_BY_BOX:"clipByBox",CLIP_FILL:"fillClip",PICK_BY_MEASURE:"pickByMeasure",EDIT_CONTROL:"editControl",VIEW_SHED_ANALYSIS:"viewshedAnalysis",VOLUME_MEASURE:"volumeMeasure"},r.MoveDirection={NONE:0,UP:1,DOWN:2,LEFT:4,RIGHT:8,FORWARD:16,BACK:32},r.DrawingStyle={SHADING:0,BOARDLINE:1,SHADINGWITHLINE:2},r.EnumInstanceState={HIDDEN:-1,NONE:0,HOVER:1,SELECTED:2,OVERRIDED:3,TRANSPARENT:4,BLINK:5,CLIPPING:6},r.EnumDataProvider={AUTO:0,DEFAULT:1,MERGED:2,LAYER:3,LAYER_SCENE:4},r.EnumRendererType={AUTO:0,FULL:1,INCREMENT:2},r.EnumShaderColorState={NONE:0,BLINK:1,SELECT:2},r.EnumCesiumImageryLayerType={AUTO:0,BAIDU:1,GAODE:2,MAPBOX:3,ARCGIS:4,GOOGLE:5},r.EnumRenderOrder={BeforeComponent:-1,Component:0,AfterComponent:1,Increment:1e4,WireFrame:10090,ClipPlane:10100,Effect:10200},r.EnumLayerBaseRenderOrder={MODEL:0,MAP:-100},r.EnumRenderCallbackType=Object.freeze({PRE_RENDER:"preRender",RENDER:"render",POST_RENDER:"postRender",FINISH_RENDER:"renderFinished"}),r.EnumLengthlUnits=Object.freeze({Meter:"Meter",Millimeter:"Millimeter"}),r.EnumClippingCapsTypes=Object.freeze({None:0,ClipPlane:1,ClipBox:2}),r.FILLPATTERN={fullFill:[255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255],noFill:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],horizontalLine:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255],verticalLine:[128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128],rightDiagonalLine:[0,128,0,128,0,64,0,64,0,32,0,32,0,16,0,16,0,8,0,8,0,4,0,4,0,2,0,2,0,1,0,1,128,0,128,0,64,0,64,0,32,0,32,0,16,0,16,0,8,0,8,0,4,0,4,0,2,0,2,0,1,0,1,0,0,128,0,128,0,64,0,64,0,32,0,32,0,16,0,16,0,8,0,8,0,4,0,4,0,2,0,2,0,1,0,1,128,0,128,0,64,0,64,0,32,0,32,0,16,0,16,0,8,0,8,0,4,0,4,0,2,0,2,0,1,0,1,0],leftDiagonalLine:[1,0,1,0,2,0,2,0,4,0,4,0,8,0,8,0,16,0,16,0,32,0,32,0,64,0,64,0,128,0,128,0,0,1,0,1,0,2,0,2,0,4,0,4,0,8,0,8,0,16,0,16,0,32,0,32,0,64,0,64,0,128,0,128,1,0,1,0,2,0,2,0,4,0,4,0,8,0,8,0,16,0,16,0,32,0,32,0,64,0,64,0,128,0,128,0,0,1,0,1,0,2,0,2,0,4,0,4,0,8,0,8,0,16,0,16,0,32,0,32,0,64,0,64,0,128,0,128],orthogonalCrossLine:[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,255,255,255,255,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,255,255,255,255,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,255,255,255,255,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,255,255,255,255],skewCrossLine:[65,65,65,65,34,34,34,34,20,20,20,20,8,8,8,8,20,20,20,20,34,34,34,34,65,65,65,65,128,128,128,128,65,65,65,65,34,34,34,34,20,20,20,20,8,8,8,8,20,20,20,20,34,34,34,34,65,65,65,65,128,128,128,128,65,65,65,65,34,34,34,34,20,20,20,20,8,8,8,8,20,20,20,20,34,34,34,34,65,65,65,65,128,128,128,128,65,65,65,65,34,34,34,34,20,20,20,20,8,8,8,8,20,20,20,20,34,34,34,34,65,65,65,65,128,128,128,128],halftone:[136,136,136,136,34,34,34,34,136,136,136,136,34,34,34,34,136,136,136,136,34,34,34,34,136,136,136,136,34,34,34,34,136,136,136,136,34,34,34,34,136,136,136,136,34,34,34,34,136,136,136,136,34,34,34,34,136,136,136,136,34,34,34,34,136,136,136,136,34,34,34,34,136,136,136,136,34,34,34,34,136,136,136,136,34,34,34,34,136,136,136,136,34,34,34,34,136,136,136,136,34,34,34,34,136,136,136,136,34,34,34,34,136,136,136,136,34,34,34,34,136,136,136,136,34,34,34,34],doubleCross:[65,65,65,65,34,34,34,34,21,21,21,21,9,9,9,9,21,21,21,21,35,35,35,35,66,66,66,66,255,255,255,255,65,65,65,65,34,34,34,34,21,21,21,21,9,9,9,9,21,21,21,21,35,35,35,35,66,66,66,66,255,255,255,255,65,65,65,65,34,34,34,34,21,21,21,21,9,9,9,9,21,21,21,21,35,35,35,35,66,66,66,66,255,255,255,255,65,65,65,65,34,34,34,34,21,21,21,21,9,9,9,9,21,21,21,21,35,35,35,35,66,66,66,66,255,255,255,255]},r.EnumShowTileType=Object.freeze({All:0,OnlyInstance:1,ExceptInstance:2}),r.EnumSubBimTileType=Object.freeze({SubBt_unknown:0,SubBt_instance:1,SubBt_visibility:2}),r.Layer={},r.Workers={},function(){class e{static isAvailable(t){return("WGS84"===t||"CGCS2000"==t)&&(e.setupCoordinateSystem(t),!0)}static setupCoordinateSystem(e){if(!proj4.testDef(e))switch(e){case"WGS84":proj4.defs("WGS84","+proj=longlat +datum=WGS84 +no_defs");break;case"CGCS2000":proj4.defs("CGCS2000","+proj=longlat +ellps=GRS80 +no_defs")}}static setupMercator(){proj4.testDef("WEB_MERCATOR")||proj4.defs("WEB_MERCATOR","+title=WGS 84 / Pseudo-Mercator +proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +no_defs")}}e.WGS84="WGS84",e.CGCS2000="CGCS2000",r.geoCoordinateSystem=e}(),function(){class e{constructor(){}static lonLatToWebMercator(e,t,i){if(!r.geoCoordinateSystem.isAvailable(t))return void console.log("unknown coordinate system ");r.geoCoordinateSystem.setupMercator();const a=proj4(proj4(t),proj4("WEB_MERCATOR"),proj4.toPoint([e.x,e.y]));if("object"==typeof i)return i.x=a.x,i.y=a.y,i;{const e=new THREE.Vector2;return e.x=a.x,e.y=a.y,e}}static webMercatorToLonLat(e,t,i){if(!r.geoCoordinateSystem.isAvailable(t))return void console.log("unknown coordinate system ");r.geoCoordinateSystem.setupMercator();const a=proj4(proj4("WEB_MERCATOR"),proj4(t),proj4.toPoint([e.x,e.y]));if("object"==typeof i)return i.x=a.x,i.y=a.y,i;{const e=new THREE.Vector2;return e.x=a.x,e.y=a.y,e}}static lonLatToGauss(t,i,a,n){if(!r.geoCoordinateSystem.isAvailable(i))return void console.log("unknown coordinate system ");const s=void 0!==n.span?n.span:3,o=void 0===n.withLineCode||n.withLineCode,l=e.gaussInfo(t.x,s),d=void 0!==n.lineCode?n.lineCode:l.lineCode;let h;if(o){if(h=`CGCS_GAUSS_${s}_ZONE_${d}`,!proj4.testDef(h)){const e=`+proj=tmerc +lat_0=0 +lon_0=${l.centerLng} +k=1 +x_0=${d}500000 +y_0=0 +ellps=GRS80 +units=m +no_defs`;proj4.defs(h,e)}}else if(h=`CGCS_GAUSS_${s}_${l.centerLng}E`,!proj4.testDef(h)){const e=`+proj=tmerc +lat_0=0 +lon_0=${l.centerLng} +k=1 +x_0=500000 +y_0=0 +ellps=GRS80 +units=m +no_defs`;proj4.defs(h,e)}const c=proj4(proj4(i),proj4(h),proj4.toPoint([t.x,t.y]));if("object"==typeof a)return a.x=c.x,a.y=c.y,a;{const e=new THREE.Vector2;return e.x=c.x,e.y=c.y,e}}static guassToLonLat(e,t,i,a){if(!r.geoCoordinateSystem.isAvailable(t))return void console.log("unknown coordinate system ");if(void 0===a.span)return void console.log("unknown projection info");let n,s=Math.floor(e.x/1e6);if(s<0&&!a.lineCode)return void console.log("error projection coordinate");if(a.lineCode&&a.lineCode!=s&&s>0)return void console.log("error projection coordinate");s<=0?(n=proj4.toPoint([e.x+1e6*a.lineCode,e.y]),s=a.lineCode):n=proj4.toPoint([e.x,e.y]);const o=`CGCS_GAUSS_${a.span}_ZONE_${s}`;if(!proj4.testDef(o)){let e=s*a.span;Math.abs(a.span-6)<Math.abs(r.Utils.MinusEpsilon)&&(e-=6);const t=`+proj=tmerc +lat_0=0 +lon_0=${e} +k=1 +x_0=${s}500000 +y_0=0 +ellps=GRS80 +units=m +no_defs`;proj4.defs(o,t)}const l=proj4(proj4(o),proj4(t),n);if("object"==typeof i)return i.x=l.x,i.y=l.y,i;{const e=new THREE.Vector2;return e.x=l.x,e.y=l.y,e}}static gaussInfo(e,t){let i=0,a=0;return Math.abs(t-3)<Math.abs(r.Utils.MinusEpsilon)?(i=Math.floor((e+t/2)/t),a=3*i):Math.abs(t-6)<Math.abs(r.Utils.MinusEpsilon)&&(i=Math.floor((e+t)/t),a=6*i-3),{lineCode:i,centerLng:a}}}r.Projection=e}(),function(e){function t(e,t){var i=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(i>>16)<<16|65535&i}function i(e,i,r,a,n,s){return t((o=t(t(i,e),t(a,s)))<<(l=n)|o>>>32-l,r);var o,l}function a(e,t,r,a,n,s,o){return i(t&r|~t&a,e,t,n,s,o)}function n(e,t,r,a,n,s,o){return i(t&a|r&~a,e,t,n,s,o)}function s(e,t,r,a,n,s,o){return i(t^r^a,e,t,n,s,o)}function o(e,t,r,a,n,s,o){return i(r^(t|~a),e,t,n,s,o)}function l(e,i){var r,l,d,h,c;e[i>>5]|=128<<i%32,e[14+(i+64>>>9<<4)]=i;var u=1732584193,p=-271733879,m=-1732584194,f=271733878;for(r=0;r<e.length;r+=16)l=u,d=p,h=m,c=f,u=a(u,p,m,f,e[r],7,-680876936),f=a(f,u,p,m,e[r+1],12,-389564586),m=a(m,f,u,p,e[r+2],17,606105819),p=a(p,m,f,u,e[r+3],22,-1044525330),u=a(u,p,m,f,e[r+4],7,-176418897),f=a(f,u,p,m,e[r+5],12,1200080426),m=a(m,f,u,p,e[r+6],17,-1473231341),p=a(p,m,f,u,e[r+7],22,-45705983),u=a(u,p,m,f,e[r+8],7,1770035416),f=a(f,u,p,m,e[r+9],12,-1958414417),m=a(m,f,u,p,e[r+10],17,-42063),p=a(p,m,f,u,e[r+11],22,-1990404162),u=a(u,p,m,f,e[r+12],7,1804603682),f=a(f,u,p,m,e[r+13],12,-40341101),m=a(m,f,u,p,e[r+14],17,-1502002290),u=n(u,p=a(p,m,f,u,e[r+15],22,1236535329),m,f,e[r+1],5,-165796510),f=n(f,u,p,m,e[r+6],9,-1069501632),m=n(m,f,u,p,e[r+11],14,643717713),p=n(p,m,f,u,e[r],20,-373897302),u=n(u,p,m,f,e[r+5],5,-701558691),f=n(f,u,p,m,e[r+10],9,38016083),m=n(m,f,u,p,e[r+15],14,-660478335),p=n(p,m,f,u,e[r+4],20,-405537848),u=n(u,p,m,f,e[r+9],5,568446438),f=n(f,u,p,m,e[r+14],9,-1019803690),m=n(m,f,u,p,e[r+3],14,-187363961),p=n(p,m,f,u,e[r+8],20,1163531501),u=n(u,p,m,f,e[r+13],5,-1444681467),f=n(f,u,p,m,e[r+2],9,-51403784),m=n(m,f,u,p,e[r+7],14,1735328473),u=s(u,p=n(p,m,f,u,e[r+12],20,-1926607734),m,f,e[r+5],4,-378558),f=s(f,u,p,m,e[r+8],11,-2022574463),m=s(m,f,u,p,e[r+11],16,1839030562),p=s(p,m,f,u,e[r+14],23,-35309556),u=s(u,p,m,f,e[r+1],4,-1530992060),f=s(f,u,p,m,e[r+4],11,1272893353),m=s(m,f,u,p,e[r+7],16,-155497632),p=s(p,m,f,u,e[r+10],23,-1094730640),u=s(u,p,m,f,e[r+13],4,681279174),f=s(f,u,p,m,e[r],11,-358537222),m=s(m,f,u,p,e[r+3],16,-722521979),p=s(p,m,f,u,e[r+6],23,76029189),u=s(u,p,m,f,e[r+9],4,-640364487),f=s(f,u,p,m,e[r+12],11,-421815835),m=s(m,f,u,p,e[r+15],16,530742520),u=o(u,p=s(p,m,f,u,e[r+2],23,-995338651),m,f,e[r],6,-198630844),f=o(f,u,p,m,e[r+7],10,1126891415),m=o(m,f,u,p,e[r+14],15,-1416354905),p=o(p,m,f,u,e[r+5],21,-57434055),u=o(u,p,m,f,e[r+12],6,1700485571),f=o(f,u,p,m,e[r+3],10,-1894986606),m=o(m,f,u,p,e[r+10],15,-1051523),p=o(p,m,f,u,e[r+1],21,-2054922799),u=o(u,p,m,f,e[r+8],6,1873313359),f=o(f,u,p,m,e[r+15],10,-30611744),m=o(m,f,u,p,e[r+6],15,-1560198380),p=o(p,m,f,u,e[r+13],21,1309151649),u=o(u,p,m,f,e[r+4],6,-145523070),f=o(f,u,p,m,e[r+11],10,-1120210379),m=o(m,f,u,p,e[r+2],15,718787259),p=o(p,m,f,u,e[r+9],21,-343485551),u=t(u,l),p=t(p,d),m=t(m,h),f=t(f,c);return[u,p,m,f]}function d(e){var t,i="",r=32*e.length;for(t=0;t<r;t+=8)i+=String.fromCharCode(e[t>>5]>>>t%32&255);return i}function h(e){var t,i=[];for(i[(e.length>>2)-1]=void 0,t=0;t<i.length;t+=1)i[t]=0;var r=8*e.length;for(t=0;t<r;t+=8)i[t>>5]|=(255&e.charCodeAt(t/8))<<t%32;return i}function c(e){var t,i,r="0123456789abcdef",a="";for(i=0;i<e.length;i+=1)t=e.charCodeAt(i),a+=r.charAt(t>>>4&15)+r.charAt(15&t);return a}function u(e){return unescape(encodeURIComponent(e))}function p(e){return function(e){return d(l(h(e),8*e.length))}(u(e))}function m(e,t){return function(e,t){var i,r,a=h(e),n=[],s=[];for(n[15]=s[15]=void 0,a.length>16&&(a=l(a,8*e.length)),i=0;i<16;i+=1)n[i]=909522486^a[i],s[i]=1549556828^a[i];return r=l(n.concat(h(t)),512+8*t.length),d(l(s.concat(r),640))}(u(e),u(t))}r.md5=function(e,t,i){return t?i?m(t,e):c(m(t,e)):i?p(e):c(p(e))}}(),r.Utils={scratchVector_1:new THREE.Vector3,scratchVector_2:new THREE.Vector3,scratchVector_3:new THREE.Vector3,scratchMatrix3:new THREE.Matrix3,scratchMatrix4_1:new THREE.Matrix4,scratchMatrix4_2:new THREE.Matrix4,scratchQuaternion_1:new THREE.Quaternion,scratchBoundingBox:new THREE.Box3,TemporaryMatrix:new THREE.Matrix4,MinusEpsilon:-1e-6,MatrixFromMillimeterToMeter:(new THREE.Matrix4).makeScale(.001,.001,.001),MatrixFromMeterToMillimeter:(new THREE.Matrix4).makeScale(1e3,1e3,1e3),isDefined:function(e){return null!=e},isDesktop:function(){var e=navigator.userAgent,t=/(?:Windows Phone)/.test(e),i=/(?:SymbianOS)/.test(e)||t,r=/(?:Android)/.test(e),a=/(?:Firefox)/.test(e),n=(/(?:Chrome|CriOS)/.test(e),/(?:iPad|PlayBook)/.test(e)||r&&!/(?:Mobile)/.test(e)||a&&/(?:Tablet)/.test(e));return!(/(?:iPhone)/.test(e)&&!n||r||i||n)},getOS:function(){var e=navigator.userAgent;return e.match(/compatible/i)||e.match(/Windows/i)?"windows":e.match(/Macintosh/i)||e.match(/MacIntel/i)?"macOS":e.match(/iphone/i)||e.match(/Ipad/i)?"ios":e.match(/android/i)?"android":"other"},supportWorker:function(){return"undefined"!=typeof Worker||(console.log("Sorry! Web Worker is not supported."),!1)},supportsBlobArrayBuffer:function(e){return"function"==typeof e.arrayBuffer},supportsImageBitmap:function(){return"function"==typeof createImageBitmap},box3FromArray:function(e,t){if(e instanceof Array){var i=t||new THREE.Box3;return i.min.fromArray(e,0),i.max.fromArray(e,3),i}return null},box3FromSize:function(e,t,i){return r.Utils.isDefined(i)||(i=new THREE.Box3),i.min.set(-t.x/2,-t.y/2,-t.z/2),i.max.set(t.x/2,t.y/2,t.z/2),i.translate(e),i},box3FromArrayRange:function(e,t,i){for(var r=new THREE.Box3,a=1/0,n=1/0,s=1/0,o=-1/0,l=-1/0,d=-1/0,h=t,c=i;h<c;h+=3){var u=e[h],p=e[h+1],m=e[h+2];u<a&&(a=u),p<n&&(n=p),m<s&&(s=m),u>o&&(o=u),p>l&&(l=p),m>d&&(d=m)}return r.min.set(a,n,s),r.max.set(o,l,d),r},computeBBox:function(e){for(var t=new THREE.Box3,i=new THREE.Vector3,r=0,a=e.length;r<a;++r)i.fromArray(e[r],0),t.expandByPoint(i);return t},mergeBBox:function(e){if(e.length<1)return null;for(var t=new THREE.Box3,i=new THREE.Vector3,r=new THREE.Vector3,a=new THREE.Box3,n=0,s=e.length;n<s;n++)i.set(e[n].max.x,e[n].max.y,e[n].max.z),r.set(e[n].min.x,e[n].min.y,e[n].min.z),a.set(r,i),t.union(a);return t},parseTransform:function(e,t,i){var a=!1;if(t.rotation&&(e.rotation.fromArray(t.rotation),a=!0),t.position&&(e.position.fromArray(t.position),a=!0),t.scale&&(e.scale.fromArray(t.scale),a=!0),t.quaternion&&(e.quaternion.fromArray(t.quaternion),a=!0),a&&e.updateMatrix(),t.matrix&&e.matrix.fromArray(t.matrix),i){var n=e.matrix.clone();n.multiplyMatrices(i,e.matrix),e.matrix=n}e.matrixAutoUpdate=!1,void 0!==e.boundingBox&&(e.boundingBox=r.Utils.box3FromArray(t.bbox))},isMobileDevice:function(){var e=navigator.platform;return 0!==e.indexOf("Win")&&0!==e.indexOf("Mac")},findRange:function(e,t){if(t<Math.min.apply(null,e))return 0;if(t>Math.max.apply(null,e))return e.length-1;for(var i=0,r=0,a=e.length;r<a;++r)if(e[r]>t){i=r-1;break}return i},stringToByte:function(e){var t,i,r=new Array;t=e.length;for(var a=0;a<t;a++)(i=e.charCodeAt(a))>=65536&&i<=1114111?(r.push(i>>18&7|240),r.push(i>>12&63|128),r.push(i>>6&63|128),r.push(63&i|128)):i>=2048&&i<=65535?(r.push(i>>12&15|224),r.push(i>>6&63|128),r.push(63&i|128)):i>=128&&i<=2047?(r.push(i>>6&31|192),r.push(63&i|128)):r.push(255&i);return r},byteToString:function(e){if("string"==typeof e)return e;for(var t="",i=e,r=0;r<i.length;r++){var a=i[r].toString(2),n=a.match(/^1+?(?=0)/);if(n&&8==a.length){for(var s=n[0].length,o=i[r].toString(2).slice(7-s),l=1;l<s;l++)o+=i[l+r].toString(2).slice(2);t+=String.fromCharCode(parseInt(o,2)),r+=s-1}else t+=String.fromCharCode(i[r])}return t},strToBinary:function(e){for(var t=[],i=e.split(""),r=0;r<i.length;r++){0!=r&&t.push(" ");var a=i[r].charCodeAt().toString(2);t.push(a)}return t.join("")},binaryToStr:function(e){for(var t=[],i=e.split(" "),r=0;r<i.length;r++){var a=i[r],n=parseInt(a,2),s=String.fromCharCode(n);t.push(s)}return t.join("")},byteArr2Int:function(e){return(255&e[0])<<24|(255&e[1])<<16|(255&e[2])<<8|(255&e[3])<<0},int2ByteArr:function(e){var t=[];return t[0]=e>>24,t[1]=e>>16,t[2]=e>>8,t[3]=e>>0,t},checkVersionMatch:function(e,t){var i=e.split(".");if(i.length>1){var r=parseInt(i[0]),a=parseInt(i[1]),n=t.toLowerCase();if((n=parseFloat(n))<.04&&0===r&&a<7)return!0;if(n>=.04&&(r>0||0===r&&a>=7))return!0}return!1},isEmptyObject:function(e){if(!e)return!0;if(e.length>0)return!1;if(0===e.length)return!0;for(var t in e)if(e.hasOwnProperty(t))return!1;return!0},isEmptyObjectSimple:function(e){for(var t in e)return!1;return!0},isOwnEmptyObject:function(e){for(var t in e)if(e.hasOwnProperty(t))return!1;return!0},hexStrToRgb:function(e){var t=e.replace("#",""),i=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return i?{r:parseInt(i[1],16)/255,g:parseInt(i[2],16)/255,b:parseInt(i[3],16)/255}:null},hexToRgb:function(e){var t={};return t.r=(e>>16&255)/255,t.g=(e>>8&255)/255,t.b=(255&e)/255,t},getMin:function(e){for(var t=e.length,i=1/0;t--;)i=e[t]<i?e[t]:i;return i},getMax:function(e){for(var t=e.length,i=-1/0;t--;)i=e[t]>i?e[t]:i;return i},freezeObject:function(e){return Object.freeze?Object.freeze(e):e},getEncodedId:function(e){return r.md5&&"function"==typeof r.md5?r.md5(e):e},arrayToMap:function(e,t){t=t||{};for(var i=0,r=e.length;i<r;i++)t[e[i]]=!0;return t},mapToArray:function(e){let t=[];for(const i in e)t.push(i);return t},getDifferentialIdxs:function(e,t){var i,r={},a={},n={};if(t)if(this.isEmptyObject(e))a=t;else{for(i in t)e[i]&&(n[i]=!0);if(this.isEmptyObject(n))r=e,a=t;else{for(i in t)n[i]||(a[i]=!0);for(i in e)n[i]||(r[i]=!0)}}else this.isEmptyObject(e)||(r=e);return{objCurrUsedIdxs:e,addIdxs:Object.keys(r),removeIdxs:Object.keys(a)}},getCombinedKeyString:function(e,t){return t=t||"&",e.join(t)},splitCombinedKeyString:function(e,t){return t=t||"&",e.split(t)},isGroupObject:function(e){return!(!e.children||!e.children.length)},isMeshObject:function(e){return!!(e.isMesh||e.isLine||e.isPoints)},extendObject:function(e,t,i){if(i)for(var a in t)"object"==typeof t[a]?r.Utils.extendObject(e[a],t[a],!0):e[a]=t[a];else for(var a in t)null!==e[a]&&void 0!==e[a]?"object"==typeof t[a]&&r.Utils.extendObject(e[a],t[a],!1):e[a]=t[a];return e},computeExplodeTranslation:function(e,t,i){let r=new THREE.Vector3;var a=t.getCenter(r),n=i*e.distanceTo(a),s=new THREE.Vector3;return s.subVectors(a,e),0!=s.length()&&s.normalize(),s.multiplyScalar(n),s},computeAfterExplodeTranslation:function(e,t,i){let r=new THREE.Vector3;if(0===i)return r;var a=t.getCenter(r),n=e.distanceTo(a),s=new THREE.Vector3;return s.subVectors(a,e),0!=s.length()&&s.normalize(),s.multiplyScalar(n/(i+1)),s},minDistanceBetweenTriToMesh:function(e,t,i,r){function a(e,t){return new THREE.Vector3(e.x-t.x,e.y-t.y,e.z-t.z)}function n(e,t){return new THREE.Vector3(e.x+t.x,e.y+t.y,e.z+t.z)}function s(e,t,i){return new THREE.Vector3(e.x+t.x*i,e.y+t.y*i,e.z+t.z*i)}function o(e,t){return e.x*t.x+e.y*t.y+e.z*t.z}function l(e,t){return new THREE.Vector3(e.y*t.z-e.z*t.y,e.z*t.x-e.x*t.z,e.x*t.y-e.y*t.x)}function d(e,t,i,r){var d,h,c,u,p,m,f=o(t,r),g=o(t,t),v=o(r,r),y=a(i,e),M=o(t,y),E=o(r,y);return(d=(M*v-E*f)/(g*v-f*f))<0||isNaN(d)?d=0:d>1&&(d=1),(h=(d*f-E)/v)<=0||isNaN(h)?(u=i,(d=M/g)<=0||isNaN(d)?(c=e,p=a(i,e)):d>=1?p=a(i,c=n(e,t)):(c=s(e,t,d),m=l(y,t),p=l(t,m))):h>=1?(u=n(i,r),(d=(f+M)/g)<=0||isNaN(d)?(c=e,p=a(u,e)):d>=1?p=a(u,c=n(e,t)):(c=s(e,t,d),m=l(y=a(u,e),t),p=l(t,m))):(u=s(i,r,h),d<=0||isNaN(d)?(c=e,m=l(y,r),p=l(r,m)):d>=1?(m=l(y=a(i,c=n(e,t)),r),p=l(r,m)):(c=s(e,t,d),o(p=l(t,r),y)<0&&p.multiplyScalar(-1))),{vec:p,closestP:c,closestQ:u}}function h(e,t){var i,r,n,h,c,u,p=[],m=[];p[0]=a(e[1],e[0]),p[1]=a(e[2],e[1]),p[2]=a(e[0],e[2]),m[0]=a(t[1],t[0]),m[1]=a(t[2],t[1]),m[2]=a(t[0],t[2]);for(var f=0,g=e[0].distanceToSquared(t[0])+1,v=0;v<3;v++)for(var y=0;y<3;y++){var M=d(e[v],p[v],t[y],m[y]);n=M.vec,i=M.closestP;var E=o(h=a(r=M.closestQ,i),h);if(E<=g){c=i.clone(),u=r.clone(),g=E;var b=o(a(e[(v+2)%3],i),n),I=o(a(t[(y+2)%3],r),n);if(b<=0&&I>=0)return{start:i.clone(),end:r.clone(),minDistance:Math.sqrt(E)};b<0&&(b=0),I>0&&(I=0),o(h,n)-b+I>0&&(f=1)}}var x=l(p[0],p[1]),T=o(x,x);if(T>1e-15){var _=[];h=a(e[0],t[0]),_[0]=o(h,x),h=a(e[0],t[1]),_[1]=o(h,x),h=a(e[0],t[2]),_[2]=o(h,x);var S=-1;if(_[0]>0&&_[1]>0&&_[2]>0?(S=_[0]<_[1]?0:1,_[2]<_[S]&&(S=2)):_[0]<0&&_[1]<0&&_[2]<0&&(S=_[0]>_[1]?0:1,_[2]>_[S]&&(S=2)),S>=0&&(f=1,o(h=a(t[S],e[0]),l(x,p[0]))>0&&o(h=a(t[S],e[1]),l(x,p[1]))>0&&o(h=a(t[S],e[2]),l(x,p[2]))>0))return i=s(t[S],x,_[S]/T),r=t[S].clone(),{start:i.clone(),end:r,minDistance:i.distanceTo(r)}}var C=l(m[0],m[1]),w=o(C,C);if(w>1e-15){var R=[];h=a(t[0],e[0]),R[0]=o(h,C),h=a(t[0],e[1]),R[1]=o(h,C),h=a(t[0],e[2]),R[2]=o(h,C);S=-1;if(R[0]>0&&R[1]>0&&R[2]>0?(S=R[0]<R[1]?0:1,R[2]<R[S]&&(S=2)):R[0]<0&&R[1]<0&&R[2]<0&&(S=R[0]>R[1]?0:1,R[2]>R[S]&&(S=2)),S>=0&&(f=1,o(h=a(e[S],t[0]),l(C,m[0]))>0&&o(h=a(e[S],t[1]),l(C,m[1]))>0&&o(h=a(e[S],t[2]),l(C,m[2]))>0))return{start:i=e[S].clone(),end:(r=s(e[S],C,R[S]/w)).clone(),minDistance:i.distanceTo(r)}}return f?(i=c,r=u,{start:c.clone(),end:u.clone(),minDistance:Math.sqrt(g)}):{start:c.clone(),end:u.clone(),minDistance:0}}var c=new THREE.Vector3,u=new THREE.Vector3,p=new THREE.Vector3;function m(e,t,i,r,a,n){c.fromBufferAttribute(t,i),u.fromBufferAttribute(t,r),p.fromBufferAttribute(t,a),n&&(c.applyMatrix4(n),u.applyMatrix4(n),p.applyMatrix4(n)),e.push(c),e.push(u),e.push(p)}for(var f={start:null,end:null,minDistance:Number.POSITIVE_INFINITY},g=t.geometry,v=g.attributes.position,y=i?i.indexStart:0,M=g.getIndex().array,E=y,b=i?i.indexStart+i.indexCount:M.length;E<b;E+=3){var I=[];m(I,v,M[E],M[E+1],M[E+2],r);var x=h(e,I);if(f.minDistance>x.minDistance&&(f.minDistance=x.minDistance,f.start=x.start.clone(),f.end=x.end.clone()),x.minDistance<=0)return f}return f},asyncProcess(e,t,i,r,a){requestAnimationFrame(function n(s){var o=s;return function(){var s,l;for(l=o+i>t?t:o+i,s=o;s<l;s++){r&&r(e,s),s===l-1&&(l!==t?requestAnimationFrame(n(s+1)):a&&a(e))}}}(0))},hasSimilarProperty:function(e,t){if(!(e instanceof Object&&t instanceof Object))return!1;for(var i in e)if(e.hasOwnProperty(i)&&!t.hasOwnProperty(i))return!1;return!0},arrayMax:function(e){if(0===e.length)return-1/0;for(var t=e[0],i=1,r=e.length;i<r;++i)e[i]>t&&(t=e[i]);return t},arrayMin:function(e){if(0===e.length)return 1/0;for(var t=e[0],i=1,r=e.length;i<r;++i)e[i]<t&&(t=e[i]);return t},ab2str:function(e){return(new TextDecoder).decode(new Uint8Array(e))},str2ab:function(e){return(new TextEncoder).encode(e).buffer},getEncodedString:function(e){return r.md5&&"function"==typeof r.md5?r.md5(e):e},toMemoryString(e){var t=e/1048576;return t<1?t.toLocaleString(void 0,{maximumFractionDigits:3}):Math.round(t).toLocaleString()},defined:e=>null!=e,defaultValue:(e,t)=>null!=e?e:t,clone:function(e,t){if(null===e||"object"!=typeof e)return e;t=r.Utils.defaultValue(t,!1);var i=new e.constructor;for(var a in e)if(e.hasOwnProperty(a)){var n=e[a];t&&(n=r.Utils.clone(n,t)),i[a]=n}return i},binarySearch(e,t,i){for(var r,a,n=0,s=e.length-1;n<=s;)if((a=i(e[r=~~((n+s)/2)],t))<0)n=r+1;else{if(!(a>0))return r;s=r-1}return~(s+1)},unpackRGBAToDepth(e){if(!r.Utils.UnpackFactors){var t=255/256,i=new THREE.Vector3(16777216,65536,256);r.Utils.UnpackFactors=new THREE.Vector4(t/i.x,t/i.y,t/i.z,t)}return e.dot(r.Utils.UnpackFactors)},computeViewportTransformation(e,t,i,a){var n=r.Utils.defaultValue(e.x,0),s=r.Utils.defaultValue(e.y,0),o=r.Utils.defaultValue(e.width,0),l=r.Utils.defaultValue(e.height,0);t=r.Utils.defaultValue(t,0);var d=.5*o,h=.5*l,c=.5*((i=r.Utils.defaultValue(i,1))-t),u=d,p=h,m=c,f=n+d,g=s+h,v=t+c;return r.Utils.defined(a)||(a=new THREE.Matrix4),a.elements[0]=u,a.elements[1]=0,a.elements[2]=0,a.elements[3]=0,a.elements[4]=0,a.elements[5]=p,a.elements[6]=0,a.elements[7]=0,a.elements[8]=0,a.elements[9]=0,a.elements[10]=m,a.elements[11]=0,a.elements[12]=f,a.elements[13]=g,a.elements[14]=v,a.elements[15]=1,a},computeView:(e,t,i,a,n)=>(r.Utils.defined(n)||(n=new THREE.Matrix4),n.elements[0]=a.x,n.elements[1]=i.x,n.elements[2]=-t.x,n.elements[3]=0,n.elements[4]=a.y,n.elements[5]=i.y,n.elements[6]=-t.y,n.elements[7]=0,n.elements[8]=a.z,n.elements[9]=i.z,n.elements[10]=-t.z,n.elements[11]=0,n.elements[12]=-a.dot(e),n.elements[13]=-i.dot(e),n.elements[14]=t.dot(e),n.elements[15]=1,n),getTranslationFromMatrix4:(e,t)=>(r.Utils.defined(t)||(t=new THREE.Vector3),t.x=e.elements[12],t.y=e.elements[13],t.z=e.elements[14],t),pointInPolygon(e,t){for(var i=e.x,r=e.y,a=!1,n=0,s=t.length-1;n<t.length;s=n++){var o=t[n].x,l=t[n].y,d=t[s].x,h=t[s].y;l>r!=h>r&&i<(d-o)*(r-l)/(h-l)+o&&(a=!a)}return a},area(e){for(var t=e.length,i=0,r=t-1,a=0;a<t;r=a++)i+=e[r].x*e[a].y-e[a].x*e[r].y;return.5*i},isClockWise:e=>r.Utils.area(e)<0,lineLineIntersection(e,t,i,r){const a=(r.y-i.y)*(t.x-e.x)-(r.x-i.x)*(t.y-e.y),n=(r.x-i.x)*(e.y-i.y)-(r.y-i.y)*(e.x-i.x),s=(t.x-e.x)*(e.y-i.y)-(t.y-e.y)*(e.x-i.x);if(0==a)return void 0;const o=n/a,l=s/a;return o>=0&&o<=1&&l>=0&&l<=1?new THREE.Vector2(e.x+o*(t.x-e.x),e.y+o*(t.y-e.y)):void 0},lineLineIntersection3d(e,t,i,a){const n=1e-5;function s(e,t,i){return!!(r.Math.lessThanOrEquals(i.x,Math.max(e.x,t.x),n)&&r.Math.lessThanOrEquals(Math.min(e.x,t.x),i.x,n)&&r.Math.lessThanOrEquals(i.y,Math.max(e.y,t.y),n)&&r.Math.lessThanOrEquals(Math.min(e.y,t.y),i.y,n)&&r.Math.lessThanOrEquals(i.z,Math.max(e.z,t.z),n)&&r.Math.lessThanOrEquals(Math.min(e.z,t.z),i.z,n))}var o=(new THREE.Vector3).subVectors(t,e),l=(new THREE.Vector3).subVectors(a,i);if(r.Math.equalsEpsilon(o.dot(l),n))return!1;var d=(new THREE.Vector3).subVectors(i,e),h=(new THREE.Vector3).crossVectors(o,l),c=(new THREE.Vector3).crossVectors(d,l),u=d.dot(h);if(r.Math.equalsEpsilon(u,0,n)&&!r.Math.equalsEpsilon(h.lengthSq(),n)){var p=c.dot(h)/h.lengthSq();if(!r.Math.lessThan(1,p,n)&&!r.Math.lessThan(u,0,n)){var m=e.add(new THREE.Vector3(o.x*p,o.y*p,o.z*p));return s(e,t,m)&&s(i,a,m)?m:void 0}}},lineStartScratch:new THREE.Vector2,lineEndScratch:new THREE.Vector2,linePolygonIntersection(e,t,i){for(var a,n=0;n<i.length;n++)if(r.Utils.lineStartScratch.set(i[n].x,i[n].y),r.Utils.lineEndScratch.set(i[(n+1)%i.length].x,i[(n+1)%i.length].y),a=r.Utils.lineLineIntersection(e,t,r.Utils.lineStartScratch,r.Utils.lineEndScratch))return a},linePolygonIntersection2(e,t,i){for(var a,n=0;n<i.length;n++)if(r.Utils.lineStartScratch.set(i[n].x,i[n].y),r.Utils.lineEndScratch.set(i[(n+1)%i.length].x,i[(n+1)%i.length].y),a=r.Utils.lineLineIntersection(e,t,r.Utils.lineStartScratch,r.Utils.lineEndScratch))return a.index=n,a},delaunay(e){var t=1/1048576;let i=function(e,i,r,a){var n,s,o,l,d,h,c,u,p,m,f=e[i][0],g=e[i][1],v=e[r][0],y=e[r][1],M=e[a][0],E=e[a][1],b=Math.abs(g-y),I=Math.abs(y-E);if(b<t&&I<t)throw new Error("Eek! Coincident points!");return b<t?s=(l=-(M-v)/(E-y))*((n=(v+f)/2)-(h=(v+M)/2))+(u=(y+E)/2):I<t?s=(o=-(v-f)/(y-g))*((n=(M+v)/2)-(d=(f+v)/2))+(c=(g+y)/2):(n=((o=-(v-f)/(y-g))*(d=(f+v)/2)-(l=-(M-v)/(E-y))*(h=(v+M)/2)+(u=(y+E)/2)-(c=(g+y)/2))/(o-l),s=b>I?o*(n-d)+c:l*(n-h)+u),{i:i,j:r,k:a,x:n,y:s,r:(p=v-n)*p+(m=y-s)*m}},r=function(e){var t,i,r,a,n,s;for(i=e.length;i;)for(a=e[--i],r=e[--i],t=i;t;)if(s=e[--t],r===(n=e[--t])&&a===s||r===s&&a===n){e.splice(i,2),e.splice(t,2);break}};var a,n,s,o,l,d,h,c,u,p,m,f,g=e.length;if(g<3)return[];for(e=e.slice(0),s=new Array(g),a=g;a--;)s[a]=a;for(s.sort((function(t,i){var r=e[i][0]-e[t][0];return 0!==r?r:t-i})),o=function(e){var t,i,r,a,n,s,o=Number.POSITIVE_INFINITY,l=Number.POSITIVE_INFINITY,d=Number.NEGATIVE_INFINITY,h=Number.NEGATIVE_INFINITY;for(t=e.length;t--;)e[t][0]<o&&(o=e[t][0]),e[t][0]>d&&(d=e[t][0]),e[t][1]<l&&(l=e[t][1]),e[t][1]>h&&(h=e[t][1]);return r=h-l,[[(n=o+.5*(i=d-o))-20*(a=Math.max(i,r)),(s=l+.5*r)-a],[n,s+20*a],[n+20*a,s-a]]}(e),e.push(o[0],o[1],o[2]),l=[i(e,g+0,g+1,g+2)],d=[],h=[],a=s.length;a--;h.length=0){for(f=s[a],n=l.length;n--;)(c=e[f][0]-l[n].x)>0&&c*c>l[n].r?(d.push(l[n]),l.splice(n,1)):c*c+(u=e[f][1]-l[n].y)*u-l[n].r>t||(h.push(l[n].i,l[n].j,l[n].j,l[n].k,l[n].k,l[n].i),l.splice(n,1));for(r(h),n=h.length;n;)m=h[--n],p=h[--n],l.push(i(e,p,m,f))}for(a=l.length;a--;)d.push(l[a]);for(l.length=0,a=d.length;a--;)d[a].i<g&&d[a].j<g&&d[a].k<g&&l.push(d[a].i,d[a].j,d[a].k);return l},bestdim(e,t){const i=1e-4*t.length();let r=Math.floor(1*e);r=Math.max(r,1);let a=[1,1,1];if(t.x>i)if(t.y>i)if(t.z>i){const e=Math.pow(r/(t.x*t.y*t.z),1/3);a[0]=Math.floor(t.x*e),a[1]=Math.floor(t.y*e),a[2]=Math.floor(t.z*e)}else a[0]=Math.floor(Math.sqrt(r*t.x/t.y)),a[1]=Math.floor(Math.sqrt(r*t.y/t.x));else t.z>i?(a[0]=Math.floor(Math.sqrt(r*t.x/t.z)),a[2]=Math.floor(Math.sqrt(r*t.z/t.x))):a[0]=Math.floor(r);else t.y>i?t.z>i?(a[1]=Math.floor(Math.sqrt(r*t.y/t.z)),a[2]=Math.floor(Math.sqrt(r*t.z/t.y))):a[1]=Math.floor(r):t.z>i&&(a[2]=Math.floor(r));return a[0]=Math.max(a[0],1),a[1]=Math.max(a[1],1),a[2]=Math.max(a[2],1),a},charCodeUrl(e){let t=4;e.endsWith(".json.gz")?t=9:e.endsWith("bimtiles.json.gz")&&(t=17);let i=e.length,r=0;for(let a=i-t;a>=i-t-6;a--)r+=e[a].charCodeAt(0);return r},getPickPointByPixel(e,t,i){const r=e.getRenderer(),a=e.camera,n=e.rendererManager.renderer,s=e.getViewportSize();let o=s.width,l=s.height;i=s.height-i;var d=window.devicePixelRatio||1;o*=d,l*=d;const h=new THREE.WebGLRenderTarget(o,l,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter});n.renderCustomDepth&&n.renderCustomDepth(r,e.getScene(),a,h,!0);let c=new Uint8Array(4);r.readRenderTargetPixels(h,t*d,i*d,1,1,c);const u=a.near,p=a.far,m=2/(Math.log(p+1)/Math.LN2),f=a.projectionMatrix;this.TemporaryMatrix.copy(f).invert();const g=a.matrixWorld,v=new THREE.Vector4;let y=new THREE.Vector4;const M=c[0],E=c[1],b=c[2],I=c[3];v.set(M,E,b,I);let x=this.unpackRGBAToDepth(v);if(0==x)return;x/=255;const T=2*x/m,_=Math.pow(2,T)-1;let S=p*(1-u/_)/(p-u);const C=2*t/o-1,w=2*i/l-1;return S=2*S-1,y.set(C,w,S,1),y.multiplyScalar(_),y.applyMatrix4(this.TemporaryMatrix),y.applyMatrix4(g),this.scratchVector_1.set(y.x,y.y,y.z),this.scratchVector_1}},THREE.Math=THREE.MathUtils,r.Compatibility={convertAnnotationsToV3:function(e,t){var i=JSON.parse(t);function a(e,t,i){var a;a="string"==typeof e?JSON.parse(window.atob(e)):{position:{x:e.position.x,y:e.position.y,z:e.position.z},target:{x:e.target.x,y:e.target.y,z:e.target.z},up:{x:e.up.x,y:e.up.y,z:e.up.z}};var n=new THREE.Vector3(a.position.x,a.position.y,a.position.z),s=new THREE.Vector3(a.target.x,a.target.y,a.target.z),o=new THREE.Vector3(a.up.x,a.up.y,a.up.z),l=new r.CameraInfo("persp",n,s,o);return l=r.Camera.drawingToWorld(l,t),l=new r.CameraInfo("persp",l.position,l.target,l.up),l=r.Camera.worldToDrawing(l,i),a.position.x=l.position.x,a.position.y=l.position.y,a.position.z=l.position.z,a.target.x=l.target.x,a.target.y=l.target.y,a.target.z=l.target.z,a.up.x=l.up.x,a.up.y=l.up.y,a.up.z=l.up.z,"string"==typeof e&&(a=window.btoa(JSON.stringify(a))),a}if(i.filter){var n=JSON.parse(i.filter);if(n.filter||n.basicIds){var s=e.getScene(),o=s.getTransformMatrixGlobal();(new THREE.Matrix4).copy(o).invert();var l=s.getMatrixGlobal();(new THREE.Matrix4).copy(l).invert();var d=e.getFilter().getFilterType(),h={state:{}};n.filter?(n.fileFilter&&(h.state[d.FILE_HIDDEN]=n.fileFilter),n.selectionSet&&(h.state[d.SELECTED]=n.selectionSet),n.filter.visibleIds&&(h.state[d.VISIBLE]=n.filter.visibleIds),n.filter.invisibleIds&&(h.state[d.HIDDEN]=n.filter.invisibleIds),n.filter.conditions&&(h.state[d.CONDITION_HIDDEN_OTHERS]=n.filter.conditions),n.filter.filters&&(h.state[d.USER_HIDDEN]=n.filter.filters),n.frozenSet&&(h.state[d.FROZENFILTER]=n.frozenSet),n.isolateSet&&(h.state[d.ISOLATE_HIDDEN_OTHERS]=n.isolateSet),n.overriderByIds&&(h.state[d.OVERRIDEFILTER]=n.overriderByIds),n.overriderByData&&(h.state[d.USER_OVERRIDE]=n.overriderByData),n.overriderCondition&&(h.state[d.CONDITION_OVERRIDE]=n.overriderCondition),n.isolateCondition&&(h.state[d.ISOLATE_CONDITION_HIDDEN_OTHERS]=n.isolateCondition),h.state.sceneState=n.overriderByScene):n.basicIds&&(n.basicIds[1]&&(h.state[d.FILE_HIDDEN]=n.basicIds[1]),n.basicIds[2]&&(h.state[d.SELECTED]=n.basicIds[2]),n.basicIds[3]&&(h.state[d.VISIBLE]=n.basicIds[3]),n.basicIds[4]&&(h.state[d.HIDDEN]=n.basicIds[4]),n.conditions[0]&&(h.state[d.CONDITION_HIDDEN_OTHERS]=n.conditions[0]),n.userHiddenIds&&(h.state[d.USER_HIDDEN]=n.userHiddenIds),n.frozenIds&&(h.state[d.FROZENFILTER]=n.frozenIds),n.isolateIds&&(h.state[d.ISOLATE_HIDDEN_OTHERS]=n.isolateIds),n.overrideByIds&&(h.state[d.OVERRIDEFILTER]=n.overrideByIds),n.overrideByData&&(h.state[d.USER_OVERRIDE]=n.overrideByData),n.conditions[2]&&(h.state[d.CONDITION_OVERRIDE]=n.conditions[2]),n.isolateConditions&&(n.isolateConditions[0]&&(h.state[d.ISOLATE_CONDITION_HIDDEN]=n.isolateConditions[0]),n.isolateConditions[1]&&(h.state[d.ISOLATE_CONDITION_HIDDEN_OTHERS]=n.isolateConditions[1]),n.isolateConditions[2]&&(h.state[d.ISOLATE_CONDITION_TRANSLUCENT]=n.isolateConditions[2]),n.isolateConditions[3]&&(h.state[d.ISOLATE_CONDITION_TRANSLUCENT_OTHERS]=n.isolateConditions[3])),h.state.sceneState=n.sceneState),n.camera?h.camera=a(n.camera,o,l):h.camera=a(i.camera,o,l),n=h,i.filter=JSON.stringify(n)}}return i},isLoadLinesEnabled:function(e){return!(parseFloat(e)<=.12)},isLoadBMpkEnabled:function(e){return!(parseFloat(e)<.13)},isLoadLayerSceneEnabled:function(e){return!(parseFloat(e)<.15)},isUse32MpkData:function(e){return!(parseFloat(e)<.15)},use32MpkData:!1,isUseMergeTexturePkg:function(e){return!(parseFloat(e)<.16)},isUseMergeTextureOptimize:function(e){return parseFloat(e)>.17},isUseDoubleMatrix:function(e){return parseFloat(e)>=.2},isUseDoubleMatrixMPKHeader:function(e){return parseFloat(e)>=.21},isUseINCREMENTByBmpkCount:function(e,t){return 0===e&&t>0},getMatrixSize:function(e){return this.isUseDoubleMatrix(e)?128:64},getMatrixDatatype:function(e){return this.isUseDoubleMatrix(e)?Float64Array:Float32Array},useMergeTexturePkg:!1},r.DomUtil={getContainerOffsetToClient:function(e){var t,i;if(e!=document){var r=(i=e).getBoundingClientRect?function(e){var t=e.getBoundingClientRect(),i=document.body,r=document.documentElement,a=r.clientTop||i.clientTop,n=r.clientLeft||i.clientLeft,s=t.top-a,o=t.left-n;return{top:Math.round(s),left:Math.round(o)}}(i):function(e){for(var t=0,i=0;e;)t+=e.offsetTop,i+=e.offsetLeft,e=e.offsetParent;var r=document.body,a=document.documentElement;return{top:t-=window.pageYOffset||a.scrollTop||r.scrollTop,left:i-=window.pageXOffset||a.scrollLeft||r.scrollLeft}}(i);t={width:e.offsetWidth,height:e.offsetHeight,left:r.left,top:r.top}}else t={width:window.innerWidth,height:window.innerHeight,left:0,top:0};return t},loadXML:function(e,t){let i;if(window.ActiveXObject){const e=["MSXML2.DOMDocument.6.0","MSXML2.DOMDocument.5.0","MSXML2.DOMDocument.4.0","MSXML2.DOMDocument.3.0","MSXML2.DOMDocument","Microsoft.XMLDOM","MSXML.DOMDocument"];for(let t=0,r=e.length;t<r;++t){try{i=new ActiveXObject(e[t])}catch(e){continue}if(i)break}}else{if(!document.implementation||!document.implementation.createDocument)return console.log("不能创建 XML DOM对象，请更新你的浏览器……"),null;i=document.implementation.createDocument("","",null)}return i.async=t,i.load(e),i},loadXMLDoc:function(e){let t;return t=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP"),t.open("GET",e,!1),t.send(),t.responseXML},getXMLAttributeValues:function(e,t){const i=e.getElementsByTagName(t);if(0===i.length)return;const r=i[0],a={};for(let e=0,t=r.attributes.length;e<t;++e){const t=r.attributes[e].nodeName;a[t]=r.getAttribute(t)}return a},getXMLAttributeValuesByAttrName:function(e,t,i){const r=e.getElementsByTagName(t);if(0===r.length)return;const a=[];for(let e=0,t=r.length;e<t;++e){const t=r[e].getAttribute(i);t&&a.push(t)}return a}},(()=>{const e=new THREE.Vector3,t=new THREE.Vector3,i=new THREE.Vector3,a=new THREE.Vector3,n=new THREE.Vector3(0,0,1),s=new THREE.Matrix4,o=new THREE.Matrix3;var l;function d(e){let t=[];for(let i of e){const e=i.clone();e.z=0,t.push(e)}return t}function h(e){let t=[],i=-1/0,r=0;e.forEach(((e,a)=>{const n=e.clone();n.z>i&&(i=n.z,r=a),t.push(n)}));for(let e of t)e.z=i;return{topPoints:t,maxIndex:r}}function c(e){a.set(0,0,0);for(let t of e)a.add(t);const t=a.angleTo(n);return t>-Math.PI/2&&t<Math.PI/2}r.GeomUtil={EmptyGeometry:new THREE.BufferGeometry,UnitCylinderInstance:new THREE.CylinderBufferGeometry(1,1,1,32,1,!1),UnitBoxInstance:new THREE.BoxBufferGeometry(1,1,1),UnitTextureCylinder:null,UnitTextureBox:null,initializeUnitInstances:function(){r.GeomUtil.UnitCylinderInstance.boundingBox||r.GeomUtil.UnitCylinderInstance.computeBoundingBox(),r.GeomUtil.UnitBoxInstance.boundingBox||r.GeomUtil.UnitBoxInstance.computeBoundingBox()},destroyUnitInstances:function(){r.GeomUtil.UnitCylinderInstance.dispose(),r.GeomUtil.UnitBoxInstance.dispose()},getBoxData:function(e){for(var t=[[],[],[],[],[],[]],i=0;i<4;++i)t[0].push(-1,0,0);for(i=0;i<4;++i)t[1].push(0,-1,0);for(i=0;i<4;++i)t[2].push(0,0,-1);for(i=0;i<4;++i)t[3].push(0,0,1);for(i=0;i<4;++i)t[4].push(0,1,0);for(i=0;i<4;++i)t[5].push(1,0,0);var r=[[],[],[],[],[],[]];return r[0]=r[2]=r[4]=[-.5,-.5,-.5,.5,.5,-.5,.5,.5],r[1]=r[3]=r[5]=[-.5,-.5,-.5,.5,.5,-.5,.5,.5],{vertex:[[-.5,-.5,-.5,-.5,-.5,.5,-.5,.5,-.5,-.5,.5,.5],[-.5,-.5,-.5,-.5,-.5,.5,.5,-.5,-.5,.5,-.5,.5],[-.5,-.5,-.5,-.5,.5,-.5,.5,-.5,-.5,.5,.5,-.5],[-.5,-.5,.5,-.5,.5,.5,.5,-.5,.5,.5,.5,.5],[-.5,.5,-.5,-.5,.5,.5,.5,.5,-.5,.5,.5,.5],[.5,-.5,-.5,.5,-.5,.5,.5,.5,-.5,.5,.5,.5]][e],normal:t[e],uv:r[e],index:[[0,1,2,3,2,1],[2,1,0,1,2,3],[0,1,2,3,2,1],[2,1,0,1,2,3],[0,1,2,3,2,1],[2,1,0,1,2,3]][e]}},getPipeData2:function(){var e=[.5,0,.5,.353530875,.353530875,.5,0,.5,.5,-.353530875,.353530875,.5,-.5,0,.5,-.353530875,-.353530875,.5,0,-.5,.5,.353530875,-.353530875,.5,.5,0,.5,.5,0,-.5,.353530875,.353530875,-.5,0,.5,-.5,-.353530875,.353530875,-.5,-.5,0,-.5,-.353530875,-.353530875,-.5,0,-.5,-.5,.353530875,-.353530875,-.5,.5,0,-.5,.5,0,.5,.353530875,.353530875,.5,0,.5,.5,-.353530875,.353530875,.5,-.5,0,.5,-.353530875,-.353530875,.5,0,-.5,.5,.353530875,-.353530875,.5,.5,0,-.5,.353530875,.353530875,-.5,0,.5,-.5,-.353530875,.353530875,-.5,-.5,0,-.5,-.353530875,-.353530875,-.5,0,-.5,-.5,.353530875,-.353530875,-.5],t=[0,9,1,1,9,10,1,10,2,2,10,11,2,11,3,3,11,12,3,12,4,4,12,13,4,13,5,5,13,14,5,14,6,6,14,15,6,15,7,7,15,16,7,16,8,8,16,17,18,19,20,18,20,21,18,21,22,18,22,23,18,23,24,18,24,25,26,28,27,26,29,28,26,30,29,26,31,30,26,32,31,26,33,32],i=[1,0,0,.7,.7,0,0,1,0,-.7,.7,0,-1,0,0,-.7,-.7,0,0,-1,0,.7,-.7,0,1,0,0,1,0,0,.7,.7,0,0,1,0,-.7,.7,0,-1,0,0,-.7,-.7,0,0,-1,0,.7,-.7,0,1,0,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1],r=[-.5,.5,-.375,.5,-.25,.5,-.125,.5,0,.5,.125,.5,.25,.5,.375,.5,.5,.5,-.5,-.5,-.375,-.5,-.25,-.5,-.125,-.5,0,-.5,.125,-.5,.25,-.5,.375,-.5,.5,-.5,.5,0,.353530875,.353530875,0,.5,-.353530875,.353530875,-.5,0,-.353530875,-.353530875,0,-.5,.353530875,-.353530875,.5,0,.353530875,.353530875,0,.5,-.353530875,.353530875,-.5,0,-.353530875,-.353530875,0,-.5,.353530875,-.353530875];return function(){return{vertex:e,normal:i,uv:r,index:t}}}(),getPipeData:function(e){(void 0===e||e<8)&&(e=8),e>256&&(e=256);var t,i,r=.5,a=4*e+2,n=3*(4*e-4),s=e+1,o=1/e,l=6.28318530714/e,d=[];for(t=0;t<e;++t)d.push(r*Math.cos(t*l)),d.push(r*Math.sin(t*l));d.push(r),d.push(0);var h=[];for(i=2*s,t=0;t<i;t+=2)h.push(d[t]),h.push(d[t+1]),h.push(r);for(t=0;t<i;t+=2)h.push(d[t]),h.push(d[t+1]),h.push(-.5);for(i=2*e,t=0;t<i;t+=2)h.push(d[t]),h.push(d[t+1]),h.push(r);for(t=i;t>0;t-=2)h.push(d[t]),h.push(d[t+1]),h.push(-.5);var c=[],u=e+1;for(t=0;t<e;++t)c.push(t),c.push(t+u),c.push(t+1),c.push(t+1),c.push(t+u),c.push(t+u+1);var p=2*s;for(t=1;t<e-1;++t)c.push(p),c.push(p+t),c.push(p+t+1);for(p+=e,t=1;t<e-1;++t)c.push(p),c.push(p+t),c.push(p+t+1);var m=[];for(t=e;t>=0;--t)m.push(t*o-r),m.push(-.5);for(t=e;t>=0;--t)m.push(t*o-r),m.push(r);for(i=2*e,t=0;t<i;t+=2)m.push(d[t]),m.push(d[t+1]);for(t=i;t>0;t-=2)m.push(d[t]),m.push(d[t+1]);i=3*a;var f,g,v,y=[];for(t=0;t<i;++t)y.push(0);var M=new THREE.Vector3,E=new THREE.Vector3,b=new THREE.Vector3,I=new THREE.Vector3,x=new THREE.Vector3;for(t=0;t<n;t+=3)f=3*c[t],g=3*c[t+1],v=3*c[t+2],M.fromArray(h,f),E.fromArray(h,g),b.fromArray(h,v),I.subVectors(b,E),x.subVectors(M,E),I.cross(x),y[f]+=I.x,y[f+1]+=I.y,y[f+2]+=I.z,y[g]+=I.x,y[g+1]+=I.y,y[g+2]+=I.z,y[v]+=I.x,y[v+1]+=I.y,y[v+2]+=I.z;var T=new THREE.Vector3;for(i=3*a,t=0;t<i;t+=3)T.fromArray(y,t),T.normalize(),y[t]=T.x,y[t+1]=T.y,y[t+2]=T.z;return{vertex:h,normal:y,uv:m,index:c,edges:e}},getInstancePipeData:function(e,t){var i=this.getPipeData(e);(void 0===e||e<8)&&(e=8),e>256&&(e=256);var r=2*(e+1),a=r+e,n=4*e+2,s=[[],[],[]];s[0]=i.vertex.slice(0,3*r),s[1]=i.vertex.slice(3*r,3*a),s[2]=i.vertex.slice(3*a,3*n);var o=[[],[],[]],l=e+1,d=0;for(d=0;d<e;++d)o[0].push(d),o[0].push(d+l),o[0].push(d+1),o[0].push(d+1),o[0].push(d+l),o[0].push(d+l+1);for(d=1;d<e-1;++d)o[1].push(0),o[1].push(d),o[1].push(d+1);for(d=1;d<e-1;++d)o[2].push(0),o[2].push(d),o[2].push(d+1);var h=[[],[],[]];h[0]=i.uv.slice(0,2*r),h[1]=i.uv.slice(2*r,2*a),h[2]=i.uv.slice(2*a,2*n);var c=[[],[],[]];return c[0]=i.normal.slice(0,3*r),c[1]=i.normal.slice(3*r,3*a),c[2]=i.normal.slice(3*a,3*n),{vertex:s[t],normal:c[t],uv:h[t],index:o[t]}},getUnitTextureCylinder:function(){if(null==r.GeomUtil.UnitTextureCylinder){r.GeomUtil.UnitTextureCylinder=new Array(3);for(var e=0;e<3;++e){var t=r.GeomUtil.getInstancePipeData(32,e);r.GeomUtil.UnitTextureCylinder[e]=new THREE.BufferGeometry,r.GeomUtil.UnitTextureCylinder[e].setIndex(t.index),r.GeomUtil.UnitTextureCylinder[e].setAttribute("position",new THREE.Float32BufferAttribute(t.vertex,3)),r.GeomUtil.UnitTextureCylinder[e].setAttribute("normal",new THREE.Float32BufferAttribute(t.normal,3)),r.GeomUtil.UnitTextureCylinder[e].setAttribute("uv",new THREE.Float32BufferAttribute(t.uv,2))}}return r.GeomUtil.UnitTextureCylinder},getUnitTextureBox:function(){if(null===r.GeomUtil.UnitTextureBox){r.GeomUtil.UnitTextureBox=new Array(6);for(var e=0;e<6;++e){var t=r.GeomUtil.getBoxData(e);r.GeomUtil.UnitTextureBox[e]=new THREE.BufferGeometry,r.GeomUtil.UnitTextureBox[e].setIndex(t.index),r.GeomUtil.UnitTextureBox[e].setAttribute("position",new THREE.Float32BufferAttribute(t.vertex,3)),r.GeomUtil.UnitTextureBox[e].setAttribute("normal",new THREE.Float32BufferAttribute(t.normal,3)),r.GeomUtil.UnitTextureBox[e].setAttribute("uv",new THREE.Float32BufferAttribute(t.uv,2))}}return r.GeomUtil.UnitTextureBox},getBoxBufferGeometryWithUvMatrices:function(e){for(var t,i=[],a=new THREE.Matrix3,n=new THREE.Vector3,s=!!e,o=0;o<6;++o){t=new THREE.BufferGeometry;var l=r.GeomUtil.getBoxData(o);if(s){var d=[];a.set(e[6*o],e[6*o+2],e[6*o+4],e[6*o+1],e[6*o+3],e[6*o+5],0,0,1);for(var h=0,c=l.uv.length;h<c;h+=2)n.set(l.uv[h],l.uv[h+1],1),n.applyMatrix3(a),d.push(n.x),d.push(n.y);t.setAttribute("uv",new THREE.Float32BufferAttribute(d,2))}t.setIndex(new THREE.BufferAttribute(Uint32Array.from(l.index),1)),t.setAttribute("position",new THREE.Float32BufferAttribute(l.vertex,3)),t.setAttribute("normal",new THREE.Float32BufferAttribute(l.normal,3)),i.push(t)}return r.GeomUtil.mergeBufferGeometries2(i)},getPipeBufferGeometryWithUvMatrices:function(e){var t=r.GeomUtil.getPipeData(32),i=t.edges,a=!(!e||18!==e.length),n=new THREE.BufferGeometry;if(a){for(var s=[],o=0,l=e.length;o<l;o+=6){var d=new THREE.Matrix3;d.set(e[6*o],e[6*o+2],e[6*o+4],e[6*o+1],e[6*o+3],e[6*o+5],0,0,1),s.push(d)}for(var h=[],c=new THREE.Vector3,u=4*(i+1),p=u+2*i,m=0,f=t.uv.length;m<f;m+=2)c.set(t.uv[m],t.uv[m+1],1),m<u?c.applyMatrix3(s[0]):m<p?c.applyMatrix3(s[1]):c.applyMatrix3(s[2]),h.push(c.x),h.push(c.y);n.setAttribute("uv",new THREE.Float32BufferAttribute(h,2))}return n.setIndex(new THREE.Uint32BufferAttribute(t.index,1)),n.setAttribute("position",new THREE.Float32BufferAttribute(t.vertex,3)),n.setAttribute("normal",new THREE.Float32BufferAttribute(t.normal,3)),n},getWorldMatrixOfMesh:function(e){for(var t=[],i=e.parent;i;)t.push(i.matrix),i=i.parent;var r=new THREE.Matrix4;if(t.length>0){r=t[t.length-1];for(var a=t.length-2;a>=0;--a)r.multiply(t[a])}var n=new THREE.Matrix4;return n.multiplyMatrices(r,e.matrix),n},getWorldPositionOfMesh:function(e,t){t||(t=new THREE.Matrix4),s.copy(t).invert();var i=e.clone();return i.applyMatrix4(s),i},getBoundingBoxWorldOfMesh:function(e){var t=e.boundingBox;return t||(e.geometry.boundingBox||e.geometry.computeBoundingBox(),t=e.geometry.boundingBox),t.clone()},getBoundingBoxWorldOfGeometry:function(e){return e.boundingBox||e.computeBoundingBox(),e.boundingBox.clone()},mergeBufferGeometries:function(e,t){for(var i=null!==e[0].geometry.index,r=new Set(Object.keys(e[0].geometry.attributes)),a=new Set(Object.keys(e[0].geometry.morphAttributes)),n={},s={},o=new THREE.BufferGeometry,l=0;l<e.length;++l){var d=e[l].geometry;if(i!==(null!==d.index))return null;for(var h in d.attributes){if(!r.has(h))return console.log("attributes not Used: ",h),null;void 0===n[h]&&(n[h]=[]),n[h].push(d.attributes[h])}for(var h in d.morphAttributes){if(!a.has(h))return null;void 0===s[h]&&(s[h]=[]),s[h].push(d.morphAttributes[h])}void 0!==d.userData&&(o.userData=o.userData||{},o.userData.mergedUserData=o.userData.mergedUserData||[],o.userData.mergedUserData.push(d.userData))}if(i){var c=0,u=[],p=0;for(l=0;l<e.length;++l){var m=e[l].geometry.index;if(c>0){m=m.clone();for(var f=0;f<m.count;++f)m.setX(f,m.getX(f)+c)}u.push(m),c+=e[l].geometry.attributes.position.count,void 0===t[e[l].name]&&(t[e[l].name]=[]),t[e[l].name].push({nodeId:e[l].nodeId,indexStart:p,indexCount:m.count,materialId:e[l].materialId}),p+=m.count}var g=this.mergeBufferAttributes(u);if(!g)return null;o.index=g}for(var h in n){var v=this.mergeBufferAttributes(n[h]);if(!v)return null;o.setAttribute(h,v)}for(var h in s){var y=s[h][0].length;if(0===y)break;o.morphAttributes=o.morphAttributes||{},o.morphAttributes[h]=[];for(l=0;l<y;++l){var M=[];for(f=0;f<s[h].length;++f)M.push(s[h][f][l]);var E=this.mergeBufferAttributes(M);if(!E)return null;o.morphAttributes[h].push(E)}}return o},mergeBufferGeometries2:function(e){for(var t=null!==e[0].index,i=new Set(Object.keys(e[0].attributes)),r={},a=new THREE.BufferGeometry,n=0;n<e.length;++n){var s=e[n];if(t!==(null!==s.index))return null;for(var o in s.attributes){if(!i.has(o))return null;void 0===r[o]&&(r[o]=[]),r[o].push(s.attributes[o])}}if(t){var l=0,d=[];for(n=0;n<e.length;++n){var h=e[n].index;if(l>0){h=h.clone();for(var c=0;c<h.count;++c)h.setX(c,h.getX(c)+l)}d.push(h),l+=e[n].attributes.position.count}var u=this.mergeBufferAttributes(d);if(!u)return null;a.index=u}for(var o in r){var p=this.mergeBufferAttributes(r[o]);if(!p)return null;a.setAttribute(o,p)}return a},mergeBufferAttributes:function(e){for(var t,i,r,a=0,n=0;n<e.length;++n){var s=e[n];if(s.isInterleavedBufferAttribute)return null;if(void 0===t&&(t=s.array.constructor),t!==s.array.constructor)return null;if(void 0===i&&(i=s.itemSize),i!==s.itemSize)return null;if(void 0===r&&(r=s.normalized),r!==s.normalized)return null;a+=s.array.length}for(var o=new t(a),l=0,d=0;d<e.length;++d)o.set(e[d].array,l),l+=e[d].array.length;return new THREE.BufferAttribute(o,i,r)},applyMatrix3ToBuffer:(l=new THREE.Vector3,function(e,t){for(var i=0,r=t.length;i<r;i+=3)l.x=t[i+0],l.y=t[i+1],l.z=t[i+2],l.applyMatrix3(e),t[i+0]=l.x,t[i+1]=l.y,t[i+2]=l.z;return t}),applyMatrix4ToBuffer:function(){var e=new THREE.Vector3;return function(t,i){for(var r=0,a=i.length;r<a;r+=3)e.x=i[r+0],e.y=i[r+1],e.z=i[r+2],e.applyMatrix4(t),i[r+0]=e.x,i[r+1]=e.y,i[r+2]=e.z;return i}}(),normalizeBuffer:function(e){for(var t,i,r,a,n=0,s=e.length;n<s;n+=3)t=e[n],i=e[n+1],r=e[n+2],a=1/Math.sqrt(t*t+i*i+r*r),e[n+0]=t*a,e[n+1]=i*a,e[n+2]=r*a},disposeBufferFromGeometry:function(e,t){for(var i=0,r=t.length;i<r;i++){var a=e.getAttribute(t[i]);a&&(a.array=null)}},disposeIndexBufferFromGeometry:function(e){e.index&&(e.index.array=null)},copyMeshProperties:function(e,t){e.name=t.name,e.up.copy(t.up),e.position.copy(t.position),e.quaternion.copy(t.quaternion),e.scale.copy(t.scale),e.matrix.copy(t.matrix),e.matrixWorld.copy(t.matrixWorld),e.matrixAutoUpdate=t.matrixAutoUpdate,e.matrixWorldNeedsUpdate=t.matrixWorldNeedsUpdate},createBufferGeometryWithPosAndSkin:function(e,t){var i=new THREE.BufferGeometry;if(e.isBufferGeometry||e._bufferGeometry){var r=e.isBufferGeometry?e:e._bufferGeometry;if(!r.getAttribute("position"))return null;i.setAttribute("position",r.getAttribute("position")),r.getAttribute("skinIndex")&&i.setAttribute("skinIndex",r.getAttribute("skinIndex")),r.getAttribute("skinWeight")&&i.setAttribute("skinWeight",r.getAttribute("skinWeight"));var a=r.getIndex();a&&i.setIndex(a),t&&r.getAttribute("uv")&&i.setAttribute("uv",r.getAttribute("uv")),r.getAttribute("previous")&&(i.setAttribute("previous",r.getAttribute("previous")),i.setAttribute("next",r.getAttribute("next")),i.setAttribute("uv",r.getAttribute("uv")))}else if(e.isGeometry){if(0===e.vertices.length)return null;var n=new THREE.Float32BufferAttribute(3*e.vertices.length,3);if(i.setAttribute("position",n.copyVector3sArray(e.vertices)),e.skinIndices.length>0){var s=new THREE.Float32BufferAttribute(4*e.skinIndices.length,4);i.setAttribute("skinIndex",s.copyVector4sArray(e.skinIndices))}if(e.skinWeights.length>0){var o=new THREE.Float32BufferAttribute(4*e.skinWeights.length,4);this.setAttribute("skinWeight",o.copyVector4sArray(e.skinWeights))}if(e.faces.length){for(var l=e.faces,d=[],h=0;h<l.length;h++){var c=l[h];d.push(c.a,c.b,c.c)}i.setIndex(d)}}if(!i.getIndex()){for(var u,p=[],m=Math.floor(i.attributes.position.count/3),f=0;f<m;f++)u=3*f,p.push(u,u+1,u+2);i.setIndex(p)}return i},limitGeometryBufferSize:function(e){var t,i,r,a,n,s,o=45e6;if(e.groups.length){var l=e.groups,d=!1;for(i=0,r=l.length;i<r;i++)if(l[i].count>o){d=!0;break}if(!d)return;for(e.clearGroups(),i=0,r=l.length;i<r;i++){var h=l[i];if((a=h.count)>o){for(n=Math.floor(a/o),s=a%o,t=0;t<n;t++)e.addGroup(h.start+t*o,o,h.materialIndex);s&&e.addGroup(h.start+n*o,s,h.materialIndex)}else e.addGroup(h.start,h.count,h.materialIndex)}}else if((a=e.index?e.index.count:0)>o){for(n=Math.floor(a/o),s=a%o,t=0;t<n;t++)e.addGroup(t*o,o,0);s&&e.addGroup(n*o,s,0)}},getUnitLightmapBox:function(){if(void 0===r.GeomUtil.UnitLightmapBoxGeometry){for(var e,t,i=[],a=[],n=[],s=[],o=0,l=0;l<6;++l){var d=r.GeomUtil.getBoxData(l);for(e=0,t=d.index.length;e<t;e++){var h=d.index[e];i.push(d.vertex[3*h]),i.push(d.vertex[3*h+1]),i.push(d.vertex[3*h+2]),a.push(d.normal[3*h]),a.push(d.normal[3*h+1]),a.push(d.normal[3*h+2]),n.push(d.uv[2*h]),n.push(d.uv[2*h+1]),s.push(e+o)}o+=d.index.length}r.GeomUtil.UnitLightmapBoxGeometry=new THREE.BufferGeometry,r.GeomUtil.UnitLightmapBoxGeometry.setIndex(s),r.GeomUtil.UnitLightmapBoxGeometry.setAttribute("position",new THREE.Float32BufferAttribute(i,3)),r.GeomUtil.UnitLightmapBoxGeometry.setAttribute("normal",new THREE.Float32BufferAttribute(a,3)),r.GeomUtil.UnitLightmapBoxGeometry.setAttribute("uv",new THREE.Float32BufferAttribute(n,2))}return r.GeomUtil.UnitLightmapBoxGeometry},getUnitLightmapBoxM:function(){if(void 0===r.GeomUtil.UnitLightmapBoxMGeometry){r.GeomUtil.UnitLightmapBoxMGeometry=new Array(6);for(var e=0;e<6;++e){for(var t=r.GeomUtil.getBoxData(e),i=[],a=[],n=[],s=[],o=0,l=t.index.length;o<l;o++){var d=t.index[o];a.push(t.vertex[3*d]),a.push(t.vertex[3*d+1]),a.push(t.vertex[3*d+2]),n.push(t.normal[3*d]),n.push(t.normal[3*d+1]),n.push(t.normal[3*d+2]),s.push(t.uv[2*d]),s.push(t.uv[2*d+1]),i.push(o)}r.GeomUtil.UnitLightmapBoxMGeometry[e]=new THREE.BufferGeometry,r.GeomUtil.UnitLightmapBoxMGeometry[e].setIndex(i),r.GeomUtil.UnitLightmapBoxMGeometry[e].setAttribute("position",new THREE.Float32BufferAttribute(a,3)),r.GeomUtil.UnitLightmapBoxMGeometry[e].setAttribute("normal",new THREE.Float32BufferAttribute(n,3)),r.GeomUtil.UnitLightmapBoxMGeometry[e].setAttribute("uv",new THREE.Float32BufferAttribute(s,2))}}return r.GeomUtil.UnitLightmapBoxMGeometry},getUnitLightmapPipeM:function(){if(void 0===r.GeomUtil.UnitLightmapPipeMGeometry){var e,t,i=[],a=[],n=[],s=[],o=r.GeomUtil.getPipeData(32);for(e=0,t=o.index.length;e<t;e++){var l=o.index[e];i.push(o.vertex[3*l]),i.push(o.vertex[3*l+1]),i.push(o.vertex[3*l+2]),a.push(o.normal[3*l]),a.push(o.normal[3*l+1]),a.push(o.normal[3*l+2]),n.push(o.uv[2*l]),n.push(o.uv[2*l+1]),s.push(e)}r.GeomUtil.UnitLightmapPipeMGeometry=new THREE.BufferGeometry,r.GeomUtil.UnitLightmapPipeMGeometry.setIndex(s),r.GeomUtil.UnitLightmapPipeMGeometry.setAttribute("position",new THREE.Float32BufferAttribute(i,3)),r.GeomUtil.UnitLightmapPipeMGeometry.setAttribute("normal",new THREE.Float32BufferAttribute(a,3)),r.GeomUtil.UnitLightmapPipeMGeometry.setAttribute("uv",new THREE.Float32BufferAttribute(n,2))}return r.GeomUtil.UnitLightmapPipeMGeometry},getUnitLightmapPipe:function(){if(void 0===r.GeomUtil.UnitLightmapPipeGeometry){var e,t,i=[],a=[],n=[],s=[],o=r.GeomUtil.UnitCylinderInstance,l=o.getAttribute("position").array,d=o.getAttribute("normal").array,h=o.getAttribute("uv").array,c=o.getIndex().array;for(e=0,t=c.length;e<t;e++){var u=c[e];i.push(l[3*u]),i.push(l[3*u+1]),i.push(l[3*u+2]),a.push(d[3*u]),a.push(d[3*u+1]),a.push(d[3*u+2]),n.push(h[2*u]),n.push(h[2*u+1]),s.push(e)}r.GeomUtil.UnitLightmapPipeGeometry=new THREE.BufferGeometry,r.GeomUtil.UnitLightmapPipeGeometry.setIndex(s),r.GeomUtil.UnitLightmapPipeGeometry.setAttribute("position",new THREE.Float32BufferAttribute(i,3)),r.GeomUtil.UnitLightmapPipeGeometry.setAttribute("normal",new THREE.Float32BufferAttribute(a,3)),r.GeomUtil.UnitLightmapPipeGeometry.setAttribute("uv",new THREE.Float32BufferAttribute(n,2))}return r.GeomUtil.UnitLightmapPipeGeometry},getGeometrySplitByPlane:function(e,t){var i=function(e){return e<0?s:e>0?n:o},a=function(e,t){return t.distanceToPoint(e)},n="front",s="back",o="on",l=["a","b","c"];if("BufferGeometry"!=e.type){var d=new THREE.BufferGeometry;d.fromGeometry(e),e=d}for(var h=new r.SplitGeometryBuilder(e,t),c=[],u=[],p=e.attributes.position.array,m=new THREE.Vector3,f=0;f<p.length;f+=3){m.set(p[f],p[f+1],p[f+2]);var g=a(m,t),v=i(g);c.push(g),u.push(v)}var y=e.index.array,M=0;for(y.length,f=0;f<y.length;f+=3){for(var E=[],b=f;b<f+3;b++)E.push(u[y[b]]);if(-1!==E.indexOf(n)||-1===E.indexOf(s)){var I={a:y[f],b:y[f+1],c:y[f+2]};h.startFace(M,I);var x=l[l.length-1],T=y[f+2],_=c[T],S=u[T];l.map((function(e){var t=I[e],i=c[t],r=u[t];r===n&&(S===s?(h.addIntersection(x,e,_,i),h.addVertex(e)):h.addVertex(e)),r===o&&h.addVertex(e),r===s&&S===n&&h.addIntersection(x,e,_,i),x=e,T=t,S=r,_=i})),h.endFace(),M++}}var C=new THREE.BufferGeometry;return C.setAttribute("position",new THREE.Float32BufferAttribute(h.targetPositions,3)),C.setAttribute("normal",new THREE.Float32BufferAttribute(h.targetNormals,3)),C.setAttribute("uv",new THREE.Float32BufferAttribute(h.targetUvs,2)),h.targetColors&&C.setAttribute("color",new THREE.Float32BufferAttribute(h.targetColors,4)),C.setIndex(new THREE.Uint32BufferAttribute(h.targetIndices,1)),C},getGeometrySplitByMultiPlane:function(e,t){let i=0,a=[],n=[],s=[],o=[],l=[];for(let t=0,r=e.length;t<r;t++){const r=e[t].object.matrix;let d=e[t].object.geometry;if("BufferGeometry"!=e[t].object.geometry.type){let e=new THREE.BufferGeometry;e.fromGeometry(d),d=e}let h=Array.from(d.attributes.position.array),c=Array.from(d.index.array),u=null==d.attributes.normal?void 0:Array.from(d.attributes.normal.array),p=null==d.attributes.uv?void 0:Array.from(d.attributes.uv.array);for(let e=0,t=h.length;e<t;e+=3){const t=[0,1,2].map((t=>h[e+t]));let i=new THREE.Vector3(t[0],t[1],t[2]);i.applyMatrix4(r),h[e+0]=i.x,h[e+1]=i.y,h[e+2]=i.z}if(a=a.concat(h),c=c.map((e=>e+i)),n=n.concat(c),l=l.concat(Array.from({length:c.length/3},((e,i)=>t))),u)for(let e=0,t=u.length;e<t;e+=3){const t=[0,1,2].map((t=>u[e+t]));let i=new THREE.Vector4(t[0],t[1],t[2],1);i.applyMatrix4(r.clone().invert().transpose()),u[e+0]=i.x,u[e+1]=i.y,u[e+2]=i.z}s=s.concat(u||Array.from({length:h.length},((e,t)=>{}))),o=o.concat(p||Array.from({length:2*h.length/3},((e,t)=>{}))),i+=h.length/3}let d={vertices:a,indices:n,normal:s,uvs:o},h=function(e,t,i,r){const a=t.clone().sub(e),n=i.clone().sub(e),s=n.length()/a.length();return!r&&(r=1e-8),a.clone().cross(n).length()<r&&s>0-r&&s<1+r},c=function(e,t,i,r){const a=[0,1,2].map((e=>i[e])),n=[0,1,2].map((i=>function(e,t,i,r,a){const n=e,s=t.clone().sub(e),o=i,l=r.clone().sub(i);let d=o.clone().sub(n).cross(l),h=s.clone().cross(l),c=d.dot(h)/(d.length()*h.length());const u=c*d.length()/h.length();d=o.clone().sub(n).cross(s),h=s.clone().cross(l),c=d.dot(h)/(d.length()*h.length());const p=c*d.length()/h.length();return!a&&(a=1e-8),!(s.clone().cross(l).length()<a&&o.clone().sub(n).cross(s).length()<a)&&!(s.clone().cross(l).length()<a&&o.clone().sub(n).cross(s).length()>a)&&s.clone().cross(l).length()>a&&u>0-a&&u<1+a&&p>0-a&&p<1+a&&n.clone().add(s.clone().multiplyScalar(u))}(e,t,a[i],a[(i+1)%3],r)));return n.filter((e=>e))},u=function(e,t,i,r){const a=e.clone().sub(r),n=a.dot(t),s=a.dot(i);return new THREE.Vector3(n,s,0)},p=function(e,t,i,r){const a=t.clone().multiplyScalar(e.x),n=i.clone().multiplyScalar(e.y);return a.clone().add(n).add(r)},m=function(e,t,i){let r=new THREE.Triangle;return r.a=e,r.b=t,r.c=i,r.getArea()},f=function(e,t){const i=t[0],r=t[1],a=t[2],n=r.clone().sub(i),s=e.clone().sub(i),o=a.clone().sub(r),l=e.clone().sub(r),d=i.clone().sub(a),h=e.clone().sub(a);return n.clone().cross(s).z>=0&&o.clone().cross(l).z>=0&&d.clone().cross(h).z>=0},g=function(e,i,a){const n=e[0],s=e[1],o=e[2],l=s.clone().sub(n),d=o.clone().sub(n),g=s.clone().sub(o);let v=1e-7*Math.max(l.length(),g.length(),d.length());if(l.length()<v||g.length()<v||d.length()<v)return;v=1e-7*Math.min(l.length(),g.length(),d.length());const y=l.clone().cross(d).normalize(),M=l.clone().normalize(),E=y.clone().cross(M).normalize();let b=[].concat(t.points);const I=t.points.map((e=>{const i=function(e,t,i,r,a){!a&&(a=1e-8);let n=r.clone();for(;Math.abs(t.dot(n))<a;)n=n.clone().multiplyScalar(.99).add(t.clone().multiplyScalar(.01));const s=i.clone().sub(e).dot(n)/t.dot(n);return e.clone().add(t.clone().multiplyScalar(s))}(e,t.stretch,n,y,v);return u(i,M,E,n)}));let x=[u(n,M,E,n),u(s,M,E,n),u(o,M,E,n)],T=[];if(I.length<2)return;const _=I[0].clone().sub(I[I.length-1]).length()<v;if(_){if(2==I.length)return;I.pop(),b.pop();let e=I.length;for(;f(I[0],x)&&e--;)I.push(I.shift()),b.push(b.shift());f(I[0],x)?T=T.concat(I):(I.push(I[0].clone()),b.push(b[0].clone()))}let S,C,w="INITIAL";for(let e=0,t=I.length;e<t;e++)if("INITIAL"!=w||f(I[e],x))if("OUT"==w&&f(I[e],x)){w="IN",C=I[e];const t=c(S,C,x,v).filter((e=>{for(let t of x)if(!e||e.clone().sub(t).length()<v)return!1;return!0}));if(T=T.concat(t),T.push(C),t.length>0)break;S=I[e]}else if("OUT"!=w||f(I[e],x))if("IN"!=w||f(I[e],x))if("IN"==w&&f(I[e],x)){C=I[e];const t=c(S,C,x,v);T=T.concat(t),T.push(C),S=I[e]}else;else{w="OUT",C=I[e];const t=c(S,C,x,v);T=T.concat(t),S=I[e]}else{C=I[e];const t=c(S,C,x,v).filter((e=>{for(let t of x)if(!e||e.clone().sub(t).length()<v)return!1;return!0}));if(T=T.concat(t),t.length>0)break;S=I[e]}else w="OUT",S=I[e];T=T.filter((e=>{for(let t of x)if(!e||e.clone().sub(t).length()<v)return!1;return!0}));const R=T.map((e=>{for(let t=0;t<3;t++){const i=x[(t+0)%3],r=x[(t+1)%3],a=new THREE.Vector3;(new THREE.Line3).set(i,r).closestPointToPoint(e,!1,a);if(e.distanceTo(a)<v)return i.clone().add(r).multiplyScalar(.5)}return x[0].clone().add(x[1].clone()).add(x[2].clone()).multiplyScalar(1/3)})),B=x.concat(R).map((e=>[e.x,e.y]));let L;try{L=r.Utils.delaunay(B)}catch(e){return}const O=x.concat(T).map((e=>p(e,M,E,n)));let P=[],D=[];O.forEach((e=>{const t=O[0],r=O[1],n=O[2],s=m(t,r,n),o=m(e,r,n)/s,l=m(e,n,t)/s,d=m(e,t,r)/s;i&&P.push(i[0].clone().multiplyScalar(o).add(i[1].clone().multiplyScalar(l)).add(i[2].clone().multiplyScalar(d))),a&&D.push(a[0].clone().multiplyScalar(o).add(a[1].clone().multiplyScalar(l)).add(a[2].clone().multiplyScalar(d)))}));for(let e=0,t=L.length;e<t;e+=3){const t=[0,1,2].map((t=>L[e+t])).map((e=>O[e])),i=t[1].clone().sub(t[0]),r=t[2].clone().sub(t[0]);i.clone().cross(r).dot(y)<0&&([L[e+1],L[e+2]]=[L[e+2],L[e+1]])}let A=[];for(let e=0,i=L.length;e<i&&3==L.length;e+=3){const i=[0,1,2].map((t=>L[e+t])).map((e=>new THREE.Vector3(B[e][0],B[e][1],0)));if(_){const a=function(e){return 1==t.stretch.x?new THREE.Vector2(e.y,e.z):1==t.stretch.y?new THREE.Vector2(e.x,e.z):1==t.stretch.z?new THREE.Vector2(e.x,e.y):void 0},s=b.map((e=>a(e))),o=[0,1,2].map((e=>i[e].clone().add(i[(e+1)%3]).multiplyScalar(.5))),l=i[0].clone().add(i[1]).add(i[2]).multiplyScalar(1/3);if(-1==i.concat(o).concat([l]).map((e=>{const t=r.Utils.pointInPolygon(a(p(e,M,E,n)),s);let i=!1;for(let t=0,r=I.length-1;t<r;t++)S=I[t],C=I[t+1],h(S,C,e,v)&&(i=!0);return t||i})).indexOf(!1)){A.push(e/3);continue}}else for(let r=0,a=I.length-1;r<a;r++){S=I[r],C=I[r+1];let a=i.map((e=>e.clone())).filter((e=>!h(S,C,e,v)));const s=new THREE.Plane;if(s.setFromNormalAndCoplanarPoint(b[r+1].clone().sub(b[r]).cross(t.stretch),b[r+1]),1==a.length){if(s.distanceToPoint(p(a[0],M,E,n))>0){A.push(e/3);break}}else if(0==a.length){A.push(e/3);break}}}let N=[];for(let e=0,t=B.length;e<t&&3==L.length;e++){const t=new THREE.Vector3(B[e][0],B[e][1],0);for(let i=0,r=I.length-1;i<r;i++)if(S=I[i],C=I[i+1],h(S,C,t,v)){N.push(e);break}}return{vertices:O,normal:P,uvs:D,indices:L,positive:A,onMultiline:N}},v=[],y=[];for(let e=0;e<d.indices.length;){const t=[0,1,2].map((t=>d.indices[e+t])),i=t.map((e=>new THREE.Vector3(d.vertices[3*e+0],d.vertices[3*e+1],d.vertices[3*e+2])));let r=!1,a=!1;t.forEach((e=>{[0,1,2].forEach((t=>{null==d.normal[3*e+t]&&(r=!0)})),[0,1].forEach((t=>{null==d.uvs[2*e+t]&&(a=!0)}))}));const n=r?void 0:t.map((e=>new THREE.Vector3(d.normal[3*e+0],d.normal[3*e+1],d.normal[3*e+2]))),s=a?void 0:t.map((e=>new THREE.Vector2(d.uvs[2*e+0],d.uvs[2*e+1]))),o=g(i,n,s),h=d.vertices.length/3,c=d.indices.length/3;if(o){for(let t=0;t<o.positive.length;t++)v.push(0==o.positive[t]?e/3:o.positive[t]-1+c);o.onMultiline.forEach((e=>{e<3&&(y[t[e]]=!0),e>=3&&(y[e-3+h]=!0)}))}if(o&&3!=o.vertices.length){for(let e=3;e<o.vertices.length;e++){const t=o.vertices[e],i=o.normal[e],n=o.uvs[e];d.vertices.push(t.x,t.y,t.z),!r&&d.normal.push(i.x,i.y,i.z),r&&d.normal.push(void 0,void 0,void 0),!a&&d.uvs.push(n.x,n.y),a&&d.uvs.push(void 0,void 0)}o.indices=o.indices.map((t=>t<3?d.indices[e+t]:t-3+h)),[0,1,2].forEach((t=>d.indices[e+t]=o.indices[t]));for(let e=3;e<o.indices.length;e++)d.indices.push(o.indices[e]);l=l.concat(Array.from({length:o.indices.length/3-1},((t,i)=>l[e/3])))}else e+=3}let M=[];({vertices:a,indices:n,normal:s,uvs:o}=d);let E=new THREE.Box3;for(let e=0,t=a.length;e<t;e+=3)E.expandByPoint(new THREE.Vector3(a[e+0],a[e+1],a[e+2]));E.expandByScalar(.01);const b=E.max.clone().sub(E.min),I=r.Utils.bestdim(a.length/3,b),x=new THREE.Vector3(b.x/I[0],b.y/I[1],b.z/I[2]);let T=function(e){return 73856093*Math.floor(e.x)^19349663*Math.floor(e.y)^83492791*Math.floor(e.z)},_={};for(let e=0,t=n.length;e<t;e+=3){[0,1,2].map((t=>n[e+t])).forEach((t=>{null==_[t]&&(_[t]=[]),_[t].push(e/3)}))}let S={};for(let e=0,t=a.length;e<t;e+=3){const t=new THREE.Vector3(a[e+0],a[e+1],a[e+2]),i=new THREE.Vector3(t.x/x.x,t.y/x.y,t.z/x.z),r=T(i);null==S[r]&&(S[r]=[]),S[r].push(e/3)}for(v=Array.from(new Set(v)),v.forEach((e=>M[e]=1));0!=v.length;){const e=v.shift();M[e]=1;const t=[0,1,2].map((t=>n[3*e+t])),i=t.map((e=>new THREE.Vector3(a[3*e+0],a[3*e+1],a[3*e+2]))).map((e=>new THREE.Vector3(e.x/x.x,e.y/x.y,e.z/x.z)));let r=[];i.forEach((e=>r=r.concat(S[T(e)]))),r=Array.from(new Set(r));let s=[];r.forEach((e=>{e&&_[e]&&(s=s.concat(_[e]))})),s=Array.from(new Set(s));for(let e=0,i=s.length;e<i;e++){const i=s[e];if(M[i])continue;let r=!1;const o=[0,1,2].map((e=>n[3*i+e])),l=o.map((e=>new THREE.Vector3(a[3*e+0],a[3*e+1],a[3*e+2]))),d=t.filter((e=>-1!=o.indexOf(e))),h=1e-5*Math.max(b.x,b.y,b.z),c=t.filter((e=>{const t=new THREE.Vector3(a[3*e+0],a[3*e+1],a[3*e+2]);for(let e of l)if(Math.abs(e.clone().sub(t).length()-0)<h)return!0}));d.concat(c).forEach((e=>r=r||!y[e])),r&&(M[i]=1,v.push(i))}}let C=function(e){let t={},i=[],r=[],n=[],l=!1,d=!1;[...new Set(e)].forEach((e=>{[0,1,2].forEach((t=>{i.push(a[3*e+t]),r.push(s[3*e+t]),isNaN(s[3*e+t])&&(l=!0)})),[0,1].forEach((t=>{n.push(o[2*e+t]),isNaN(o[2*e+t])&&(d=!0)})),t[e]=i.length/3-1}));let h=new THREE.BufferGeometry;const c=e.map((e=>t[e]));return h.setAttribute("position",new THREE.Float32BufferAttribute(i,3)),!l&&h.setAttribute("normal",new THREE.Float32BufferAttribute(r,3)),!d&&h.setAttribute("uv",new THREE.Float32BufferAttribute(n,2)),h.setIndex(new THREE.Uint32BufferAttribute(c,1)),h},w=[];for(let t=0,i=e.length;t<i;t++){let e=[],i=[];for(let r=0;r<n.length;r+=3)l[r/3]==t&&(M[r/3]&&e.push(n[r+0],n[r+1],n[r+2]),!M[r/3]&&i.push(n[r+0],n[r+1],n[r+2]));w.push([C(e),C(i)])}return w},getGeometrySplitByFinitePlane:function(e,t){let i=function(e,i){if(0==e.clone().sub(i).length())return-1;if(0==e.clone().sub(i).dot(t.normal))return-1;const r=-e.clone().sub(t.center).dot(t.normal)/i.clone().sub(e).dot(t.normal),a=e.clone().add(i.clone().sub(e).multiplyScalar(r)).clone().sub(t.center);return Math.abs(a.clone().dot(t.x))>t.x.length()*t.x.length()||Math.abs(a.clone().dot(t.y))>t.y.length()*t.y.length()?-1:r},a=function(e,i){const r=new THREE.Plane;r.setFromNormalAndCoplanarPoint(t.normal,t.center);const a=r.distanceToPoint(e);if(Math.abs(a)>i)return!1;const n=e.clone().sub(t.center);return!(Math.abs(n.clone().dot(t.x))>t.x.length()*t.x.length())&&!(Math.abs(n.clone().dot(t.y))>t.y.length()*t.y.length())},n=function(e,t,i,r){let a=function(e,a){const n=Array.from(Array(a),((e,t)=>t)),s=n.map((i=>e[a*t+i])),o=n.map((t=>e[a*i+t]));if(new Set(s.concat(o)).has(void 0))n.forEach((t=>e.push(void 0)));else{n.map((e=>s[e]+r*(o[e]-s[e]))).forEach((t=>e.push(t)))}};a(e.vertices,3),a(e.normal,3),a(e.uvs,2)},s=0,o=[],l=[],d=[],h=[],c=[];for(let t=0,i=e.length;t<i;t++){const i=e[t].object.matrix;let r=e[t].object.geometry;if("BufferGeometry"!=e[t].object.geometry.type){let e=new THREE.BufferGeometry;e.fromGeometry(r),r=e}let a=Array.from(r.attributes.position.array),n=Array.from(r.index.array),u=null==r.attributes.normal?void 0:Array.from(r.attributes.normal.array),p=null==r.attributes.uv?void 0:Array.from(r.attributes.uv.array);for(let e=0,t=a.length;e<t;e+=3){const t=[0,1,2].map((t=>a[e+t]));let r=new THREE.Vector3(t[0],t[1],t[2]);r.applyMatrix4(i),a[e+0]=r.x,a[e+1]=r.y,a[e+2]=r.z}if(o=o.concat(a),n=n.map((e=>e+s)),l=l.concat(n),c=c.concat(Array.from({length:n.length/3},((e,i)=>t))),u)for(let e=0,t=u.length;e<t;e+=3){const t=[0,1,2].map((t=>u[e+t]));let r=new THREE.Vector4(t[0],t[1],t[2],1);r.applyMatrix4(i.clone().invert().transpose()),u[e+0]=r.x,u[e+1]=r.y,u[e+2]=r.z}d=d.concat(u||Array.from({length:a.length},((e,t)=>{}))),h=h.concat(p||Array.from({length:2*a.length/3},((e,t)=>{}))),s+=a.length/3}let u={vertices:o,indices:l,normal:d,uvs:h};const p=new THREE.Plane;p.setFromNormalAndCoplanarPoint(t.normal,t.center);let m=[],f=[];for(let e=0,t=l.length;e<t;e+=3){const t=l[e+0],r=l[e+1],a=l[e+2],s=new THREE.Vector3(o[3*t+0],o[3*t+1],o[3*t+2]),d=new THREE.Vector3(o[3*r+0],o[3*r+1],o[3*r+2]),h=new THREE.Vector3(o[3*a+0],o[3*a+1],o[3*a+2]),m=i(s,d),g=i(d,h),v=i(h,s);if(m>0&&m<1&&g>0&&g<1){n(u,t,r,m),n(u,r,a,g);const i=u.vertices.length/3-2;u.indices[e+0]=i+0,u.indices[e+2]=i+1,u.indices.push(t,i+0,i+1,t,i+1,a),c.push(c[e/3],c[e/3]);if(p.distanceToPoint(d)<0)f.push(e);else{const e=u.indices.length;f.push(e-6,e-3)}}else if(m>0&&m<1&&v>0&&v<1){n(u,t,r,m),n(u,a,t,v);const i=u.vertices.length/3-2;u.indices[e+1]=i+0,u.indices[e+2]=i+1,u.indices.push(i+0,r,a,i+1,i+0,a),c.push(c[e/3],c[e/3]);if(p.distanceToPoint(s)<0)f.push(e);else{const e=u.indices.length;f.push(e-6,e-3)}}else if(g>0&&g<1&&v>0&&v<1){n(u,r,a,g),n(u,a,t,v);const i=u.vertices.length/3-2;u.indices[e+0]=i+1,u.indices[e+1]=i+0,u.indices.push(t,r,i+1,i+1,r,i+0),c.push(c[e/3],c[e/3]);if(p.distanceToPoint(h)<0)f.push(e);else{const e=u.indices.length;f.push(e-6,e-3)}}else if(0==m&&1==v&&g>0&&g<1){n(u,r,a,g);const i=u.vertices.length/3-1;u.indices[e+2]=i,u.indices.push(t,i,a),c.push(c[e/3]);if(p.distanceToPoint(d)<0)f.push(e);else{const e=u.indices.length;f.push(e-3)}}else if(1==m&&0==g&&v>0&&v<1){n(u,a,t,v);const i=u.vertices.length/3-1;u.indices[e+2]=i,u.indices.push(i,r,a),c.push(c[e/3]);if(p.distanceToPoint(s)<0)f.push(e);else{const e=u.indices.length;f.push(e-3)}}else if(1==g&&0==v&&m>0&&m<1){n(u,t,r,m);const i=u.vertices.length/3-1;u.indices[e+1]=i,u.indices.push(i,r,a),c.push(c[e/3]);if(p.distanceToPoint(s)<0)f.push(e);else{const e=u.indices.length;f.push(e-3)}}}({vertices:o,indices:l,normal:d,uvs:h}=u);let g=new THREE.Box3;for(let e=0,t=o.length;e<t;e+=3)g.expandByPoint(new THREE.Vector3(o[e+0],o[e+1],o[e+2]));g.expandByScalar(.01);const v=g.max.clone().sub(g.min),y=r.Utils.bestdim(o.length/3,v),M=new THREE.Vector3(v.x/y[0],v.y/y[1],v.z/y[2]);let E=function(e){return 73856093*Math.floor(e.x)^19349663*Math.floor(e.y)^83492791*Math.floor(e.z)},b={};for(let e=0,t=l.length;e<t;e+=3){[0,1,2].map((t=>l[e+t])).forEach((t=>{!b[t]&&(b[t]=[]),b[t].push(e/3)}))}let I={};for(let e=0,t=o.length;e<t;e+=3){const t=new THREE.Vector3(o[e+0],o[e+1],o[e+2]),i=new THREE.Vector3(t.x/M.x,t.y/M.y,t.z/M.z),r=E(i);!I[r]&&(I[r]=[]),I[r].push(e/3)}for(;0!=f.length;){const e=f.shift();m[e]=1;const t=[0,1,2].map((t=>l[e+t])),i=t.map((e=>new THREE.Vector3(o[3*e+0],o[3*e+1],o[3*e+2]))),r=i.map((e=>new THREE.Vector3(e.x/M.x,e.y/M.y,e.z/M.z)));let n=[];r.forEach((e=>n=n.concat(I[E(e)]))),n=Array.from(new Set(n));let s=[];n.forEach((function(e){null!=e&&null!=b[e]&&(s=s.concat(b[e]))})),s=Array.from(new Set(s));for(let e=0,r=s.length;e<r;e++){const r=3*s[e];if(null!=m[r])continue;let n=!1;const d=[0,1,2].map((e=>l[r+e])),h=d.map((e=>new THREE.Vector3(o[3*e+0],o[3*e+1],o[3*e+2]))),c=t.filter((e=>-1!=d.indexOf(e))).map((e=>new THREE.Vector3(o[3*e+0],o[3*e+1],o[3*e+2]))),u=1e-6*Math.max(v.x,v.y,v.z),p=i.filter((e=>{for(let t of h)if(Math.abs(t.clone().sub(e).length()-0)<u)return!0}));c.concat(p).forEach((e=>n=n||!a(e,u))),n&&(m[r+0]=1,f.push(r))}}let x=function(e){let t={},i=[],r=[],a=[],n=!1,s=!1;[...new Set(e)].forEach((e=>{[0,1,2].forEach((t=>{i.push(o[3*e+t]),r.push(d[3*e+t]),isNaN(d[3*e+t])&&(n=!0)})),[0,1].forEach((t=>{a.push(h[2*e+t]),isNaN(h[2*e+t])&&(s=!0)})),t[e]=i.length/3-1}));let l=new THREE.BufferGeometry;const c=e.map((e=>t[e]));return l.setAttribute("position",new THREE.Float32BufferAttribute(i,3)),!n&&l.setAttribute("normal",new THREE.Float32BufferAttribute(r,3)),!s&&l.setAttribute("uv",new THREE.Float32BufferAttribute(a,2)),l.setIndex(new THREE.Uint32BufferAttribute(c,1)),l},T=[];for(let t=0,i=e.length;t<i;t++){let e=[],i=[];for(let r=0;r<l.length;r+=3)c[r/3]==t&&(m[r]&&e.push(l[r+0],l[r+1],l[r+2]),!m[r]&&i.push(l[r+0],l[r+1],l[r+2]));T.push([x(e),x(i)])}return T},intersectBox:function(e,t){for(var i=new THREE.Vector3,r=new THREE.Vector3,a=0,n=e.planes,s=0;s<6;s++){var o=n[s];i.x=o.normal.x>0?t.min.x:t.max.x,r.x=o.normal.x>0?t.max.x:t.min.x,i.y=o.normal.y>0?t.min.y:t.max.y,r.y=o.normal.y>0?t.max.y:t.min.y,i.z=o.normal.z>0?t.min.z:t.max.z,r.z=o.normal.z>0?t.max.z:t.min.z;var l=o.distanceToPoint(i),d=o.distanceToPoint(r);if(l<0&&d<0)return!1;l*d>=0&&++a}return 6===a?"in":"intersect"},satForAxes:function(e,t,i,r,a){var n,s;for(n=0,s=e.length-3;n<=s;n+=3){var o=new THREE.Vector3(e[n],e[n+1],e[n+2]),l=a.x*Math.abs(o.x)+a.y*Math.abs(o.y)+a.z*Math.abs(o.z),d=t.dot(o),h=i.dot(o),c=r.dot(o);if(Math.max(-Math.max(d,h,c),Math.min(d,h,c))>l)return!1}return!0},boxIntersectsTriangle:function(e,t){var i=new THREE.Vector3,n=new THREE.Vector3,s=new THREE.Vector3,o=new THREE.Vector3,l=new THREE.Vector3,d=new THREE.Vector3,h=new THREE.Vector3,c=new THREE.Vector3,u=new THREE.Vector3;h.copy(e.getCenter(a)),c=e.max.clone().sub(h),i=t.a.clone().sub(h),n=t.b.clone().sub(h),s=t.c.clone().sub(h),o=n.clone().sub(i),l=s.clone().sub(n),d=i.clone().sub(s);var p=[0,-o.z,o.y,0,-l.z,l.y,0,-d.z,d.y,o.z,0,-o.x,l.z,0,-l.x,d.z,0,-d.x,-o.y,o.x,0,-l.y,l.x,0,-d.y,d.x,0];return!!r.GeomUtil.satForAxes(p,i,n,s,c)&&(p=[1,0,0,0,1,0,0,0,1],!!r.GeomUtil.satForAxes(p,i,n,s,c)&&(p=[(u=o.clone().cross(l)).x,u.y,u.z],r.GeomUtil.satForAxes(p,i,n,s,c)))},geometryVolume(e,t){const i=f(e);if(!r.Utils.isDefined(f))return{volume:null,boundingBox:null,unit:unit};const n=i.position,s=i.index,o=i.normal;if(!this.isGeometryClosed(s))return console.log("object is not closed"),0;const l=new THREE.Vector3,u=new THREE.Vector3,p=new THREE.Vector3,m=new THREE.Vector3,g=new THREE.Vector3,v=new THREE.Vector3;let y=0;for(let e=0;e<s.length;e+=3){const t=3*s[e],i=3*s[e+1],a=3*s[e+2];l.set(n[t],n[t+1],n[t+2]),u.set(n[i],n[i+1],n[i+2]),p.set(n[a],n[a+1],n[a+2]),m.set(o[t],o[t+1],o[t+2]),g.set(o[i],o[i+1],o[i+2]),v.set(o[a],o[a+1],o[a+2]);const f=[l,u,p],M=d(f),E=h(f),b=this.triangleArea(M);if(b<r.Math.EPSILON12)continue;const I=b*E.topPoints[0].z,{maxIndex:x}=E,T=[...E.topPoints];T.splice(x,1);const _=[...f];_.splice(x,1),T.push(_[0]),T.push(f[x]),_.push(T[1]),_.push(f[x]);let S=this.mitsubishiConeVolume(T);S+=this.mitsubishiConeVolume(_),S=I-S,S=c([m,g,v])?S:-S,y+=S}const M=i.boundingBox;return y=function(e,t){const i=t.getSize(a);return e>i.x*i.y*i.z||e<r.Math.EPSILON4?null:e}(y,M),{volume:y,boundingBox:M}},isGeometryClosed(e){const t={};return e.forEach(((i,a)=>{let n=(a+1)%3==0?a-2:a+1;n=e[n];const s=i>n?`${i}_${n}`:`${n}_${i}`;let o=t[s];r.Utils.isDefined(o)?o&&(t[s]=!1):t[s]=!0})),!0},triangleArea:i=>!!Array.isArray(i)&&(3===i.length&&(e.subVectors(i[1],i[0]),t.subVectors(i[2],i[0]),a.crossVectors(e,t),a.length()/2)),mitsubishiConeVolume(r){if(!Array.isArray(r))return!1;if(4!==r.length)return!1;return e.subVectors(r[1],r[0]),t.subVectors(r[2],r[0]),i.subVectors(r[3],r[0]),a.crossVectors(e,t),Math.abs(a.dot(i))/6},applyMatrix4ToNormalBuffer(e,t){t&&(o.getNormalMatrix(e),r.GeomUtil.applyMatrix3ToBuffer(o,t),r.GeomUtil.normalizeBuffer(t))},swapGeometryIndex(e){let t;for(let i=0,r=e.length;i<r;i+=3)t=e[i+1],e[i+1]=e[i+2],e[i+2]=t},sliceGeometryBuffer(e,t){if(!t)return;let{position:i,index:r,normal:a,uv:n}=e;r=r.slice(t.indexStart,t.indexStart+t.indexCount),i=i.slice(t.positionStart,t.positionStart+t.positionCount),a=a?a.slice(t.positionStart,t.positionStart+t.positionCount):null,n=n&&t.uvCount?n.slice(t.uvStart,t.uvStart+t.uvCount):null;const s=t.positionStart/3;r.forEach((function(e,t,i){i[t]-=s})),e.index=r,e.position=i,e.normal=a,e.uv=n},getGeometryBuffer(e,t,i,a,n){if(!e||!e.buffer)return null;let s=null,o=null,l=null,d=null;e.isDataView?(o=Uint32Array.from(e.buffer.I),s=Float32Array.from(e.buffer.P),l=Float32Array.from(e.buffer.N),d=e.buffer.UV&&e.buffer.UV.length?Float32Array.from(e.buffer.UV):null):(o=new Uint32Array(e.buffer.I),s=new Float32Array(e.buffer.P),l=new Float32Array(e.buffer.N),d=e.buffer.UV&&e.buffer.UV.byteLength?new Float32Array(e.buffer.UV):null);const h={index:o,position:s,normal:l,uv:d};return e.indexInfo&&r.GeomUtil.sliceGeometryBuffer(h,e.indexInfo),i&&r.GeomUtil.swapGeometryIndex(h.index),(a=r.Utils.defaultValue(a,!0))&&(r.GeomUtil.applyMatrix4ToBuffer(t,h.position),r.GeomUtil.applyMatrix4ToNormalBuffer(t,h.normal)),h},getLineGeometryBuffer(e,t,i,a,n){if(!e||!e.buffer)return null;let s=e.isDataView?Float32Array.from(e.buffer.P):new Float32Array(e.buffer.P);const o={index:e.isDataView?Uint32Array.from(e.buffer.I):new Uint32Array(e.buffer.I),position:s,normal:null,uv:null};return e.indexInfo&&r.GeomUtil.sliceGeometryBuffer(o,e.indexInfo),(a=r.Utils.defaultValue(a,!0))&&r.GeomUtil.applyMatrix4ToBuffer(t,o.position),o},getPipeGeometryBuffer(e,t,i){const a=r.GeomUtil.UnitCylinderInstance;let n=Float32Array.from(a.attributes.position.array);const s={index:Uint32Array.from(a.index.array),position:n,normal:Float32Array.from(a.attributes.normal.array),uv:null};return t&&r.GeomUtil.swapGeometryIndex(s.index),(i=r.Utils.defaultValue(i,!0))&&(r.GeomUtil.applyMatrix4ToBuffer(e,s.position),r.GeomUtil.applyMatrix4ToNormalBuffer(e,s.normal)),s},getPipeMGeometryBuffer(e,t,i,a){let n=r.GeomUtil.getPipeMBuffer(e),s=Float32Array.from(n.vertex);const o={index:Uint32Array.from(n.index),position:s,normal:Float32Array.from(n.normal),uv:n.uv?Float32Array.from(n.uv):null};return i&&r.GeomUtil.swapGeometryIndex(o.index),(a=r.Utils.defaultValue(a,!0))&&(r.GeomUtil.applyMatrix4ToBuffer(t,o.position),r.GeomUtil.applyMatrix4ToNormalBuffer(t,o.normal)),o},getBoxMGeometryBuffer(e,t,i,a){let n=r.GeomUtil.getBoxMBuffer(e),s=Float32Array.from(n.vertex);const o={index:Uint32Array.from(n.index),position:s,normal:Float32Array.from(n.normal),uv:n.uv?Float32Array.from(n.uv):null};return i&&r.GeomUtil.swapGeometryIndex(o.index),(a=r.Utils.defaultValue(a,!0))&&(r.GeomUtil.applyMatrix4ToBuffer(t,o.position),r.GeomUtil.applyMatrix4ToNormalBuffer(t,o.normal)),o},getBufferGeometry(e,t){if(!e)return null;const i=new THREE.BufferGeometry;let a;return t?(a=Uint32Array.from(e.I),r.GeomUtil.swapGeometryIndex(a)):a=e.I,i.setIndex(new THREE.BufferAttribute(a,1)),i.setAttribute("position",new THREE.BufferAttribute(e.P,3)),e.N?i.setAttribute("normal",new THREE.BufferAttribute(e.N,3)):i.computeVertexNormals(),e.UV&&i.setAttribute("uv",new THREE.BufferAttribute(e.UV,2)),i},getLineBufferGeometry(e,t){if(!e)return null;const i=new THREE.BufferGeometry;return i.setIndex(new THREE.BufferAttribute(e.I,1)),i.setAttribute("position",new THREE.BufferAttribute(e.P,3)),i},getPipeBufferGeometry(e,t){const i=t?r.GeomUtil.getUnitLightmapPipe():r.GeomUtil.UnitCylinderInstance;return e?r.GeomUtil.copyGeometryIndexOnly(i,!0):i},getPipeMBufferGeometry(e,t){const i=t?r.GeomUtil.getUnitLightmapPipeM():r.GeomUtil.getUnitTextureCylinder();return e?r.GeomUtil.copyGeometryIndexOnly(i,!0):i},getBoxBufferGeometry(e,t){const i=t?r.GeomUtil.getUnitLightmapBox():r.GeomUtil.UnitBoxInstance;return e?r.GeomUtil.copyGeometryIndexOnly(i,!0):i},getBoxMBufferGeometry(e,t){const i=t?r.GeomUtil.getUnitLightmapBoxM():r.GeomUtil.getUnitTextureBox();return e?r.GeomUtil.copyGeometryIndexOnly(i,!0):i},copyGeometryIndexOnly(e,t){if(Array.isArray(e)){let i=[];return e.forEach((e=>{const a=new THREE.BufferGeometry,n=Uint32Array.from(e.getIndex().array);t&&r.GeomUtil.swapGeometryIndex(n),a.setIndex(new THREE.BufferAttribute(n,1)),a.setAttribute("position",e.getAttribute("position"));const s=e.getAttribute("normal");s?a.setAttribute("normal",s):a.computeVertexNormals();const o=e.getAttribute("uv");o&&a.setAttribute("uv",o),i.push(a)})),i}let i=new THREE.BufferGeometry;const a=Uint32Array.from(e.getIndex().array);t&&r.GeomUtil.swapGeometryIndex(a),i.setIndex(new THREE.BufferAttribute(a,1)),i.setAttribute("position",e.getAttribute("position"));const n=e.getAttribute("normal");n?i.setAttribute("normal",n):i.computeVertexNormals();const s=e.getAttribute("uv");return s&&i.setAttribute("uv",s),i}},r.GeomUtil.getBoxMBuffer=function(){for(var e,t,i=[],a=[],n=[],s=0,o=0;o<6;++o){var l=r.GeomUtil.getBoxData(o);for(e=0,t=l.vertex.length;e<t;e++)i.push(l.vertex[e]);for(e=0,t=l.index.length;e<t;e++)n.push(l.index[e]+s);for(s+=l.vertex.length/3,e=0,t=l.normal.length;e<t;e++)a.push(l.normal[e])}return function(e){var t=null;if(e){var s=new THREE.Matrix3,o=new THREE.Vector3;t=[];for(var l=0;l<6;++l){var d=r.GeomUtil.getBoxData(l);s.set(e[6*l],e[6*l+2],e[6*l+4],e[6*l+1],e[6*l+3],e[6*l+5],0,0,1);for(var h=0,c=d.uv.length;h<c;h+=2)o.set(d.uv[h],d.uv[h+1],1),o.applyMatrix3(s),t.push(o.x),t.push(o.y)}}return{vertex:i,normal:a,uv:t,index:n}}}(),r.GeomUtil.getPipeMBuffer=function(){var e=r.GeomUtil.getPipeData(32),t=e.edges,i=e.vertex,a=e.normal,n=e.index;return function(e){var s=null;if(!(!e||18!==e.length)){s=[];for(var o=[],l=0,d=e.length/6;l<d;l++){var h=new THREE.Matrix3;h.set(e[6*l],e[6*l+2],e[6*l+4],e[6*l+1],e[6*l+3],e[6*l+5],0,0,1),o.push(h)}for(var c=r.GeomUtil.getPipeData(32),u=4*(t+1),p=u+2*t,m=new THREE.Vector3,f=0,g=c.uv.length;f<g;f+=2)m.set(c.uv[f],c.uv[f+1],1),f<u?m.applyMatrix3(o[0]):f<p?m.applyMatrix3(o[1]):m.applyMatrix3(o[2]),s.push(m.x),s.push(m.y)}return{vertex:i,normal:a,uv:s,index:n}}}(),r.GeomUtil.isVector3Equal=function(e,t,i){return void 0===i?t.x===e.x&&t.y===e.y&&t.z===e.z:Math.abs(t.x-e.x)<i&&Math.abs(t.y-e.y)<i&&Math.abs(t.z-e.z)<i},r.GeomUtil.getMatrixFromGeometry=function(e,t){e.boundingBox||e.computeBoundingBox(),e.boundingBox.getCenter(a);let i=null,r=e.attributes.position.array;if(!(a.x>16777216||a.x<-16777216||a.y>16777216||a.y<-16777216||a.z>16777216||a.z<-16777216)){if(r instanceof Float64Array){const t=new Float32Array(r);e.setAttribute("position",new THREE.BufferAttribute(t,3))}return}i=(new THREE.Matrix4).setPosition(a.x,a.y,a.z);const n=r.length;for(let e=0;e<n;e+=3)r[e]=r[e]-a.x,r[e+1]=r[e+1]-a.y,r[e+2]=r[e+2]-a.z;if(r instanceof Float64Array){const t=new Float32Array(r);e.setAttribute("position",new THREE.BufferAttribute(t,3))}return i},r.GeomUtil.getMatrixFromInstancedBufferAttribute=function(e){if(e.array instanceof Float32Array)return e.originMatrix;const t=e.array;e.array=new Float32Array(t)},r.GeomUtil.getPositionArrayFromFloat64=function(e){let t=new THREE.Box3;const i=e.length;for(let r=0;r<i;r+=3)t.expandByPoint({x:e[r],y:e[r+1],z:e[r+2]});return t.getCenter(a),a.x>16777216||a.x<-16777216||a.y>16777216||a.y<-16777216||a.z>16777216||a.z<-16777216?e:new Float32Array(e)},r.GeomUtil.boxIntersectsPlaneWithMatrix=function(e,t,i){const r=t.clone();return r.applyMatrix4(i),r.intersectsPlane(e)},r.GeomUtil.applyMatrix4ToList=function(e,t){let i=[];for(let r=0,a=e.length;r<a;r+=3){let a=new THREE.Vector3(e[r],e[r+1],e[r+2]);a.applyMatrix4(t),i.push(a.x,a.y,a.z)}return i};const u=new THREE.Vector3,p=new THREE.Quaternion,m=new THREE.Vector3;function f(e){const t=e.children;if(t.length<=0)return null;let i=[],n=[],o=[];const l=new THREE.Box3;let d=0;return t.forEach((e=>{e.matrix.decompose(u,p,m),u.set(0,0,0),s.compose(u,p,m);const t=e.geometry;if(l.union(r.GeomUtil.getBoundingBoxWorldOfMesh(e).applyMatrix4(e.matrix)),!r.Utils.isDefined(t.getAttribute("normal")))return;let h=t.getAttribute("normal").array;if(!r.Utils.isDefined(t.getAttribute("position")))return;let c,f=t.getAttribute("position").array;if(r.Utils.isDefined(t.getIndex()))c=t.getIndex().array,c=Array.from(c),c.forEach(((e,t)=>{c[t]=e+d}));else{c=[];for(let e=0;e<f.length/3;++e)c.push(e+d)}h=Array.from(h),n=n.concat(c),f=Array.from(f);for(let t=0;t<f.length;t+=3)a.set(f[t],f[t+1],f[t+2]),a.applyMatrix4(e.matrix),o.push(a.x),o.push(a.y),o.push(a.z),a.set(h[t],h[t+1],h[t+2]),a.applyMatrix4(s),a.normalize(),i.push(a.x),i.push(a.y),i.push(a.z);d=o.length/3})),{position:o,normal:i,index:n,boundingBox:l}}})(),r.Logger={log:function(){r.GlobalData.DEBUG&&console.log.apply(console,arguments)},debug:function(){r.GlobalData.DEBUG&&console.debug.apply(console,arguments)},warn:function(){r.GlobalData.DEBUG&&console.warn.apply(console,arguments)},error:function(){r.GlobalData.DEBUG&&console.error.apply(console,arguments)},time:function(){r.GlobalData.DEBUG&&console.time.apply(console,arguments)},timeEnd:function(){r.GlobalData.DEBUG&&console.timeEnd.apply(console,arguments)}},function(){const e=new WeakMap;class t extends THREE.Loader{constructor(e){super(e),this.transcoderPath="",this.transcoderBinary=null,this.transcoderPending=null,this.workerLimit=4,this.workerPool=[],this.workerNextTaskID=1,this.workerSourceURL="",this.workerConfig=null,this.detectedSupport=!1}setTranscoderPath(e){return this.transcoderPath=e,this}setWorkerLimit(e){return this.workerLimit=e,this}detectSupport(e){return this.workerConfig={astcSupported:e.extensions.has("WEBGL_compressed_texture_astc"),etc1Supported:e.extensions.has("WEBGL_compressed_texture_etc1"),etc2Supported:e.extensions.has("WEBGL_compressed_texture_etc"),dxtSupported:e.extensions.has("WEBGL_compressed_texture_s3tc"),bptcSupported:e.extensions.has("EXT_texture_compression_bptc"),pvrtcSupported:e.extensions.has("WEBGL_compressed_texture_pvrtc")||e.extensions.has("WEBKIT_WEBGL_compressed_texture_pvrtc")},this.detectedSupport=!0,this}supportsImageBitmap(e){return"function"==typeof e.arrayBuffer}loadFromBlob(t,i,r,a){var n=new THREE.CompressedTexture;i.arrayBuffer().then((t=>{if(e.has(t))return e.get(t).promise.then(r).catch(a);this._createTexture([t]).then((function(e){n.copy(e),n.needsUpdate=!0,r&&r(n)})).catch(a)}))}load(t,i,r,a){const n=new THREE.FileLoader(this.manager);n.setResponseType("arraybuffer"),n.setWithCredentials(this.withCredentials);const s=new THREE.CompressedTexture;return n.load(t,(t=>{if(e.has(t)){return e.get(t).promise.then(i).catch(a)}this._createTexture([t]).then((function(e){s.copy(e),s.needsUpdate=!0,i&&i(s)})).catch(a)}),r,a),s}parseInternalAsync(t){const{levels:i}=t,r=new Set;for(let e=0;e<i.length;e++)r.add(i[e].data.buffer);let a=Array.from(r);return e.has(a[0])?e.get(a[0]).promise:this._createTexture(Array.from(r),{...t,lowLevel:!0})}_createTexture(t,i={}){let r,a;const n=i;let s=0;for(let e=0;e<t.length;e++)s+=t[e].byteLength;const o=this._allocateWorker(s).then((e=>(r=e,a=this.workerNextTaskID++,new Promise(((e,i)=>{r._callbacks[a]={resolve:e,reject:i},r.postMessage({type:"transcode",id:a,buffers:t,taskConfig:n},t)}))))).then((e=>{const{mipmaps:t,width:i,height:r,format:a}=e,n=new THREE.CompressedTexture(t,i,r,a,THREE.UnsignedByteType);return n.minFilter=1===t.length?THREE.LinearFilter:THREE.LinearMipmapLinearFilter,n.magFilter=THREE.LinearFilter,n.generateMipmaps=!1,n.needsUpdate=!0,n}));return o.catch((()=>!0)).then((()=>{r&&a&&(r._taskLoad-=s,delete r._callbacks[a])})),e.set(t[0],{promise:o}),o}_initTranscoder(){if(!this.transcoderPending){const e=new THREE.FileLoader(this.manager);e.setPath(this.transcoderPath),e.setWithCredentials(this.withCredentials);const i=new Promise(((t,i)=>{e.load("basis_transcoder.js",t,void 0,i)})),r=new THREE.FileLoader(this.manager);r.setPath(this.transcoderPath),r.setResponseType("arraybuffer"),r.setWithCredentials(this.withCredentials);const a=new Promise(((e,t)=>{r.load("basis_transcoder.wasm",e,void 0,t)}));this.transcoderPending=Promise.all([i,a]).then((([e,i])=>{const r=t.BasisWorker.toString(),a=["/* constants */","let _EngineFormat = "+JSON.stringify(t.EngineFormat),"let _TranscoderFormat = "+JSON.stringify(t.TranscoderFormat),"let _BasisFormat = "+JSON.stringify(t.BasisFormat),"/* basis_transcoder.js */",e,"/* worker */",r.substring(r.indexOf("{")+1,r.lastIndexOf("}"))].join("\n");this.workerSourceURL=URL.createObjectURL(new Blob([a])),this.transcoderBinary=i}))}return this.transcoderPending}_allocateWorker(e){return this._initTranscoder().then((()=>{if(this.workerPool.length<this.workerLimit){const e=new Worker(this.workerSourceURL);e._callbacks={},e._taskLoad=0,e.postMessage({type:"init",config:this.workerConfig,transcoderBinary:this.transcoderBinary}),e.onmessage=function(t){const i=t.data;switch(i.type){case"transcode":e._callbacks[i.id].resolve(i);break;case"error":e._callbacks[i.id].reject(i);break;default:console.error('THREE.BasisTextureLoader: Unexpected message, "'+i.type+'"')}},this.workerPool.push(e)}else this.workerPool.sort((function(e,t){return e._taskLoad>t._taskLoad?-1:1}));const t=this.workerPool[this.workerPool.length-1];return t._taskLoad+=e,t}))}dispose(){for(let e=0;e<this.workerPool.length;e++)this.workerPool[e].terminate();return this.workerPool.length=0,this}}t.BasisFormat={ETC1S:0,UASTC_4x4:1},t.TranscoderFormat={ETC1:0,ETC2:1,BC1:2,BC3:3,BC4:4,BC5:5,BC7_M6_OPAQUE_ONLY:6,BC7_M5:7,PVRTC1_4_RGB:8,PVRTC1_4_RGBA:9,ASTC_4x4:10,ATC_RGB:11,ATC_RGBA_INTERPOLATED_ALPHA:12,RGBA32:13,RGB565:14,BGR565:15,RGBA4444:16},t.EngineFormat={RGBAFormat:THREE.RGBAFormat,RGBA_ASTC_4x4_Format:THREE.RGBA_ASTC_4x4_Format,RGBA_BPTC_Format:THREE.RGBA_BPTC_Format,RGBA_ETC2_EAC_Format:THREE.RGBA_ETC2_EAC_Format,RGBA_PVRTC_4BPPV1_Format:THREE.RGBA_PVRTC_4BPPV1_Format,RGBA_S3TC_DXT5_Format:THREE.RGBA_S3TC_DXT5_Format,RGB_ETC1_Format:THREE.RGB_ETC1_Format,RGB_ETC2_Format:THREE.RGB_ETC2_Format,RGB_PVRTC_4BPPV1_Format:THREE.RGB_PVRTC_4BPPV1_Format,RGB_S3TC_DXT1_Format:THREE.RGB_S3TC_DXT1_Format},t.BasisWorker=function(){let e,t,i;const r=_EngineFormat,a=_TranscoderFormat,n=_BasisFormat;onmessage=function(r){const a=r.data;switch(a.type){case"init":e=a.config,s=a.transcoderBinary,t=new Promise((e=>{i={wasmBinary:s,onRuntimeInitialized:e},BASIS(i)})).then((()=>{i.initializeBasis()}));break;case"transcode":t.then((()=>{try{const{width:e,height:t,hasAlpha:r,mipmaps:s,format:o}=a.taskConfig.lowLevel?function(e){const{basisFormat:t,width:r,height:a,hasAlpha:s}=e,{transcoderFormat:o,engineFormat:l}=d(t,r,a,s),m=i.getBytesPerBlockOrPixel(o);h(i.isFormatSupported(o),"THREE.BasisTextureLoader: Unsupported format.");const f=[];if(t===n.ETC1S){const t=new i.LowLevelETC1SImageTranscoder,{endpointCount:r,endpointsData:a,selectorCount:n,selectorsData:l,tablesData:d}=e.globalData;try{let i;i=t.decodePalettes(r,a,n,l),h(i,"THREE.BasisTextureLoader: decodePalettes() failed."),i=t.decodeTables(d),h(i,"THREE.BasisTextureLoader: decodeTables() failed.");for(let r=0;r<e.levels.length;r++){const a=e.levels[r],n=e.globalData.imageDescs[r],l=p(o,a.width,a.height),d=new Uint8Array(l);i=t.transcodeImage(o,d,l/m,a.data,c(o,a.width),u(o,a.height),a.width,a.height,a.index,n.rgbSliceByteOffset,n.rgbSliceByteLength,n.alphaSliceByteOffset,n.alphaSliceByteLength,n.imageFlags,s,!1,0,0),h(i,"THREE.BasisTextureLoader: transcodeImage() failed for level "+a.index+"."),f.push({data:d,width:a.width,height:a.height})}}finally{t.delete()}}else for(let t=0;t<e.levels.length;t++){const r=e.levels[t],a=p(o,r.width,r.height),n=new Uint8Array(a);h(i.transcodeUASTCImage(o,n,a/m,r.data,c(o,r.width),u(o,r.height),r.width,r.height,r.index,0,r.data.byteLength,0,s,!1,0,0,-1,-1),"THREE.BasisTextureLoader: transcodeUASTCImage() failed for level "+r.index+"."),f.push({data:n,width:r.width,height:r.height})}return{width:r,height:a,hasAlpha:s,mipmaps:f,format:l}}(a.taskConfig):function(e){const t=new i.BasisFile(new Uint8Array(e)),r=t.isUASTC()?n.UASTC_4x4:n.ETC1S,a=t.getImageWidth(0,0),s=t.getImageHeight(0,0),o=t.getNumLevels(0),l=t.getHasAlpha();function h(){t.close(),t.delete()}const{transcoderFormat:c,engineFormat:u}=d(r,a,s,l);if(!a||!s||!o)throw h(),new Error("THREE.BasisTextureLoader:\tInvalid texture");if(!t.startTranscoding())throw h(),new Error("THREE.BasisTextureLoader: .startTranscoding failed");const p=[];for(let e=0;e<o;e++){const i=t.getImageWidth(0,e),r=t.getImageHeight(0,e),a=new Uint8Array(t.getImageTranscodedSizeInBytes(0,e,c));if(!t.transcodeImage(a,0,e,c,0,l))throw h(),new Error("THREE.BasisTextureLoader: .transcodeImage failed.");p.push({data:a,width:i,height:r})}return h(),{width:a,height:s,hasAlpha:l,mipmaps:p,format:u}}(a.buffers[0]),l=[];for(let e=0;e<s.length;++e)l.push(s[e].data.buffer);self.postMessage({type:"transcode",id:a.id,width:e,height:t,hasAlpha:r,mipmaps:s,format:o},l)}catch(e){console.error(e),self.postMessage({type:"error",id:a.id,error:e.message})}}))}var s};const s=[{if:"astcSupported",basisFormat:[n.UASTC_4x4],transcoderFormat:[a.ASTC_4x4,a.ASTC_4x4],engineFormat:[r.RGBA_ASTC_4x4_Format,r.RGBA_ASTC_4x4_Format],priorityETC1S:1/0,priorityUASTC:1,needsPowerOfTwo:!1},{if:"bptcSupported",basisFormat:[n.ETC1S,n.UASTC_4x4],transcoderFormat:[a.BC7_M5,a.BC7_M5],engineFormat:[r.RGBA_BPTC_Format,r.RGBA_BPTC_Format],priorityETC1S:3,priorityUASTC:2,needsPowerOfTwo:!1},{if:"dxtSupported",basisFormat:[n.ETC1S,n.UASTC_4x4],transcoderFormat:[a.BC1,a.BC3],engineFormat:[r.RGB_S3TC_DXT1_Format,r.RGBA_S3TC_DXT5_Format],priorityETC1S:4,priorityUASTC:5,needsPowerOfTwo:!1},{if:"etc2Supported",basisFormat:[n.ETC1S,n.UASTC_4x4],transcoderFormat:[a.ETC1,a.ETC2],engineFormat:[r.RGB_ETC2_Format,r.RGBA_ETC2_EAC_Format],priorityETC1S:1,priorityUASTC:3,needsPowerOfTwo:!1},{if:"etc1Supported",basisFormat:[n.ETC1S,n.UASTC_4x4],transcoderFormat:[a.ETC1,a.ETC1],engineFormat:[r.RGB_ETC1_Format,r.RGB_ETC1_Format],priorityETC1S:2,priorityUASTC:4,needsPowerOfTwo:!1},{if:"pvrtcSupported",basisFormat:[n.ETC1S,n.UASTC_4x4],transcoderFormat:[a.PVRTC1_4_RGB,a.PVRTC1_4_RGBA],engineFormat:[r.RGB_PVRTC_4BPPV1_Format,r.RGBA_PVRTC_4BPPV1_Format],priorityETC1S:5,priorityUASTC:6,needsPowerOfTwo:!0}],o=s.sort((function(e,t){return e.priorityETC1S-t.priorityETC1S})),l=s.sort((function(e,t){return e.priorityUASTC-t.priorityUASTC}));function d(t,i,s,d){let h,c;const u=t===n.ETC1S?o:l;for(let r=0;r<u.length;r++){const a=u[r];if(e[a.if]&&(a.basisFormat.includes(t)&&(!a.needsPowerOfTwo||m(i)&&m(s))))return h=a.transcoderFormat[d?1:0],c=a.engineFormat[d?1:0],{transcoderFormat:h,engineFormat:c}}return console.warn("THREE.BasisTextureLoader: No suitable compressed texture format found. Decoding to RGBA32."),h=a.RGBA32,c=r.RGBAFormat,{transcoderFormat:h,engineFormat:c}}function h(e,t){if(!e)throw new Error(t)}function c(e,t){return Math.ceil(t/i.getFormatBlockWidth(e))}function u(e,t){return Math.ceil(t/i.getFormatBlockHeight(e))}function p(e,t,r){const n=i.getBytesPerBlockOrPixel(e);if(i.formatIsUncompressed(e))return t*r*n;if(e===a.PVRTC1_4_RGB||e===a.PVRTC1_4_RGBA){const e=t+3&-4,i=r+3&-4;return(Math.max(8,e)*Math.max(8,i)*4+7)/8}return c(e,t)*u(e,r)*n}function m(e){return e<=2||0==(e&e-1)&&0!==e}},THREE.BasisTextureLoader=t}(),function(){class e extends THREE.TextureLoader{constructor(e){super(e),this.options={imageOrientation:"none",premultiplyAlpha:"none",colorSpaceConversion:"none"}}setOptions(e){return this.options=e,this}supportsImageBitmap(){return"function"==typeof createImageBitmap}loadFromBlob(e,t,i,r){void 0===e&&(e=""),void 0!==this.path&&(e=this.path+e),e=this.manager.resolveURL(e);const a=this,n=THREE.Cache.get(e);if(void 0!==n)return a.manager.itemStart(e),setTimeout((()=>{i&&i(n),a.manager.itemEnd(e)}),0),n;Promise.resolve().then((()=>createImageBitmap(t,a.options))).then((t=>{const r=new THREE.CanvasTexture(t);THREE.Cache.add(e,r),i&&i(r),a.manager.itemEnd(e)})).catch((t=>{r&&r(t),a.manager.itemError(e),a.manager.itemEnd(e)})),a.manager.itemStart(e)}}r.TextureLoader=e}();var n=166,s={RGB:0,RRR:3,GGG:4,AAA:15},o={RGB:0,RGBA:3,RRR:4,RRRG:5},l=2,d=2;class h extends THREE.CompressedTextureLoader{constructor(e){super(e),this.basisLoader=new THREE.BasisTextureLoader(e),this.zstd=new ZSTDDecoder,this.zstd.init(),"undefined"!=typeof MSC_TRANSCODER&&console.warn('THREE.KTX2Loader: Please update to latest "basis_transcoder". "msc_basis_transcoder" is no longer supported in three.js r125+.')}setTranscoderPath(e){return this.basisLoader.setTranscoderPath(e),this}setWorkerLimit(e){return this.basisLoader.setWorkerLimit(e),this}detectSupport(e){return this.basisLoader.detectSupport(e),this}dispose(){return this.basisLoader.dispose(),this}load(e,t,i,r){var a=this,n=new THREE.CompressedTexture;return new Promise((function(t,r){new THREE.FileLoader(a.manager).setPath(a.path).setResponseType("arraybuffer").load(e,t,i,r)})).then((function(e){a.parse(e,(function(e){n.copy(e),n.needsUpdate=!0,t&&t(n)}),r)})).catch(r),n}parse(e,t,i){var r=this,a=readKTX(new Uint8Array(e));if(a.pixelDepth>0)throw new Error("THREE.KTX2Loader: Only 2D textures are currently supported.");if(a.layerCount>1)throw new Error("THREE.KTX2Loader: Array textures are not currently supported.");if(a.faceCount>1)throw new Error("THREE.KTX2Loader: Cube textures are not currently supported.");var s=T.getBasicDFD(a);return T.createLevels(a,this.zstd).then((function(e){var t=s.colorModel===n?THREE.BasisTextureLoader.BasisFormat.UASTC_4x4:THREE.BasisTextureLoader.BasisFormat.ETC1S,i={levels:e,width:a.pixelWidth,height:a.pixelHeight,basisFormat:t,hasAlpha:T.getAlpha(a)};return t===THREE.BasisTextureLoader.BasisFormat.ETC1S&&(i.globalData=a.globalData),r.basisLoader.parseInternalAsync(i)})).then((function(e){e.encoding=s.transferFunction===d?THREE.sRGBEncoding:THREE.LinearEncoding,e.premultiplyAlpha=T.getPremultiplyAlpha(a),t(e)})).catch(i),this}}THREE.KTX2Loader=h;var c,u,p,m,f,g,v,y,M,E,b,I,x,T={createLevels:async function(e,t){e.supercompressionScheme===l&&await t.init();for(var i=[],r=e.pixelWidth,a=e.pixelHeight,n=0;n<e.levels.length;n++){var s=Math.max(1,Math.floor(r/Math.pow(2,n))),o=Math.max(1,Math.floor(a/Math.pow(2,n))),d=e.levels[n].levelData;e.supercompressionScheme===l&&(d=t.decode(d,e.levels[n].uncompressedByteLength)),i.push({index:n,width:s,height:o,data:d})}return i},getBasicDFD:function(e){return e.dataFormatDescriptor[0]},getAlpha:function(e){var t=this.getBasicDFD(e);return t.colorModel===n?(15&t.samples[0].channelID)===o.RGBA:2===t.samples.length&&(15&t.samples[1].channelID)===s.AAA},getPremultiplyAlpha:function(e){return!!(1&this.getBasicDFD(e).flags)}};(()=>{let e=null,t=null,i=null,a=null,n=null,s=null;class o{constructor(){}}o.DefaultMaterial=new THREE.MeshPhongMaterial({color:255,side:THREE.DoubleSide}),o.DefaultWireframeColor={color:new THREE.Color(0,0,0),opacity:.4},o.SetDefaultWireframeColor=e=>{o.DefaultWireframeColor.color.setRGB(e.red/255,e.green/255,e.blue/255),o.DefaultWireframeColor.opacity=e.alpha},o.getBasisLibUrl=()=>(a||(a=window.BimfaceLoaderConfig&&window.BimfaceLoaderConfig.fullStaticHost?window.BimfaceLoaderConfig.fullStaticHost+"/lib/basis/":"../../lib/basis/"),a),o.getBasisTextureLoader=()=>(n||(n=new THREE.BasisTextureLoader,n.setTranscoderPath(r.MaterialUtil.getBasisLibUrl())),n),o.getKTX2TextureLoader=()=>(s||(s=new THREE.KTX2Loader,s.setTranscoderPath(r.MaterialUtil.getBasisLibUrl())),s),o.getDefaultStandardMaterial=()=>(e||(e=new r.CloudStandardMaterial({color:13024187,side:THREE.DoubleSide})),e),o.getDefaultInstanceMaterial=()=>(t||(t=new r.CloudStandardMaterial({color:13024187,side:THREE.DoubleSide}),t.forInstance=!0,t.defines.USE_INSTANCE="",t.defines.USE_INSTANCE_NORMAL="",t.colorState=r.EnumShaderColorState.BLINK,t.refreshUniforms()),t),o.getDefaultSelectedMaterial=()=>(i||(i=new r.MeshBasicClipMaterial({color:1170103,opacity:.3,transparent:!0})),i),o.createInstancePhongMaterial=e=>e.clone(),o.updateBasicMaterial=(e,t)=>{e.needsUpdate=!0},o.setMatrixUniform=e=>{r.ShaderMaterial.ShaderLib.base_cust_clip.uniforms.transformMatrix.value=e},o.createPhongMaterial=e=>{let t=new THREE.MeshPhongMaterial(e);return t.type="FillFacePhong",t.uniforms=THREE.UniformsUtils.merge([THREE.ShaderLib.fillFacePhong.uniforms]),t.vertexShader=THREE.ShaderLib.fillFacePhong.vertexShader,t.fragmentShader=THREE.ShaderLib.fillFacePhong.fragmentShader,t.side=THREE.DoubleSide,t},o.createStandardMaterial=(e,t)=>{let i;return t?(i=new V.IBLMaterial(e),i.type="IBL"):i=new r.CloudStandardMaterial(e),e.fillMap&&(i.defines.USE_FILLPATTERN=""),i},o.createInstanceMaterial=(e,t,i)=>{let a=r.MaterialUtil.createStandardMaterial(e,i);return a.forInstance=!0,a.defines.USE_INSTANCE="",t&&(a.defines.USE_INSTANCE_NORMAL=""),a.colorState=r.EnumShaderColorState.BLINK,a.refreshUniforms(),a},o.createNewStyleMaterial=e=>{let t=new THREE.MeshStandardMaterial(e);return t.type="NewStyle",t.uniforms=THREE.UniformsUtils.merge([THREE.ShaderLib.standard.uniforms]),t.vertexShader=THREE.ShaderLib.newStyle.vertexShader,t.fragmentShader=THREE.ShaderLib.newStyle.fragmentShader,t.metalness=0,t},o.createHighlightMaterial=()=>o.createStandardMaterial(r.GlobalData.SelectionColor),o.getBlinkMaterial=(e,t)=>{const i=r.MaterialUtil.getMaterialParameters(e);let a=r.MaterialUtil.createStandardMaterial(i);return a.blinkColor.copy(t),a.colorState=r.EnumShaderColorState.BLINK,a.refreshUniforms(),a},o.getBlinkMaterialV3=(e,t)=>{const i=r.MaterialUtil.getMaterialParameters(e);let a=new r.CloudStandardMaterialV3(i);return a.blinkColor.copy(t),a.colorState=r.EnumShaderColorState.BLINK,a.refreshUniforms(),a},o.resetCompressParm=(e,t)=>{let i=!1;if(r.Utils.isDefined(t.useCompressedNormal)&&e.useCompressedNormal!==t.useCompressedNormal&&(i=!0),r.Utils.isDefined(t.useCompressedColor)&&e.useCompressedColor!==t.useCompressedColor&&(i=!0),r.Utils.isDefined(t.useCompressedUv)&&e.useCompressedUv!==t.useCompressedUv&&(i=!0),i){const i=e.clone();return i.useCompressedColor=t.useCompressedColor,delete i.defines.CCOLOR,i.useCompressedNormal=t.useCompressedNormal,delete i.defines.CNORMAL,r.Utils.isDefined(t.useCompressedUv)&&(i.useCompressedUv=t.useCompressedUv,i.uvCenter=t.uvCenter,i.uvHalfExtent=t.uvHalfExtent),delete i.defines.USE_COMPRESS_UV,r.MaterialUtil.setCompressParm(i,t),i}return e},o.setCompressParm=(e,t)=>{r.Utils.isDefined(t.useCompressedNormal)&&!0===t.useCompressedNormal&&(null!=e.defines&&(e.defines.CNORMAL=""),e.useCompressedNormal=!0),r.Utils.isDefined(t.useCompressedColor)&&!0===t.useCompressedColor&&(e.defines.CCOLOR="",e.useCompressedColor=!0),r.Utils.isDefined(t.useCompressedUv)&&!0===t.useCompressedUv&&(e.defines.USE_COMPRESS_UV="",e.useCompressedUv=!0)},o.getMaterialParameters=e=>{let t={};return e.hasOwnProperty("color")&&(t.color=e.color),t.opacity=1,t.transparent=!1,e.hasOwnProperty("opacity")&&(t.opacity=e.opacity,e.opacity<1&&(t.transparent=!0)),e.hasOwnProperty("side")&&(t.side=e.side),e.hasOwnProperty("emissive")&&(t.emissive=e.emissive),e.hasOwnProperty("specular")&&(t.specular=e.specular),e.hasOwnProperty("shininess")&&(t.shininess=e.shininess),e.hasOwnProperty("map")&&(t.map=e.map),e.useAlphaMap&&(t.useAlphaMap=e.useAlphaMap),e.hasOwnProperty("bumpMap")&&(t.bumpMap=e.bumpMap),e.hasOwnProperty("bumpScale")&&(t.bumpScale=e.bumpScale),e.hasOwnProperty("normalMap")&&(t.normalMap=e.normalMap),e.hasOwnProperty("normalScale")&&(t.normalScale=e.normalScale),e.hasOwnProperty("alphaMap")&&(t.alphaMap=e.alphaMap),e.hasOwnProperty("alphaTest")&&(t.alphaTest=e.alphaTest),e.hasOwnProperty("transparent")&&(t.transparent=e.transparent),e.hasOwnProperty("emissiveMap")&&(t.emissiveMap=e.emissiveMap),e.hasOwnProperty("envMap")&&(t.envMap=e.envMap),e.hasOwnProperty("envMapIntensity")&&(t.envMapIntensity=e.envMapIntensity),e.hasOwnProperty("roughness")&&(t.roughness=e.roughness),e.hasOwnProperty("metalness")&&(t.metalness=e.metalness),e.hasOwnProperty("originRoughness")&&(t.originRoughness=e.originRoughness),e.hasOwnProperty("originMetalness")&&(t.originMetalness=e.originMetalness),r.GlobalData.IBL&&e.hasOwnProperty("iblProbe")&&(t.iblProbe=e.iblProbe),e.hasOwnProperty("shift")&&(t.shift=e.shift),e.hasOwnProperty("pureColor")&&(t.pureColor=e.pureColor),e.hasOwnProperty("tag")&&(t.tag=e.tag),e.hasOwnProperty("textureColor")&&(t.textureColor=e.textureColor),e.hasOwnProperty("imageFade")&&(t.imageFade=e.imageFade),e.hasOwnProperty("tintColor")&&(t.tintColor=e.tintColor),"cloudStandard"==e.type&&e.hasOwnProperty("lights")&&(t.lights=e.lights),e.hasOwnProperty("lightMap")&&(t.lightMap=e.lightMap),e.hasOwnProperty("lightMapIntensity")&&(t.lightMapIntensity=e.lightMapIntensity),e.hasOwnProperty("viewportSize")&&(t.viewportSize=e.viewportSize),e.hasOwnProperty("fillMap")&&(t.fillMap=e.fillMap),e.hasOwnProperty("heightLimitSampler")&&(t.heightLimitSampler=e.heightLimitSampler),e.hasOwnProperty("heightColorSampler")&&(t.heightColorSampler=e.heightColorSampler),e.hasOwnProperty("heightLimitOrthoMatrix")&&(t.heightLimitOrthoMatrix=e.heightLimitOrthoMatrix),e.hasOwnProperty("receiveIBL")&&(t.receiveIBL=e.receiveIBL),e.hasOwnProperty("localClipping")&&(t.localClipping=e.localClipping),e.hasOwnProperty("clippingPlanes")&&(t.clippingPlanes=e.clippingPlanes),e.hasOwnProperty("useCompressedColor")&&(t.useCompressedColor=e.useCompressedColor),e.hasOwnProperty("useCompressedNormal")&&(t.useCompressedNormal=e.useCompressedNormal),e.hasOwnProperty("vertexColors")&&(t.vertexColors=e.vertexColors),e.hasOwnProperty("useClampToBorder")&&(t.useClampToBorder=e.useClampToBorder),e.hasOwnProperty("useCompressedUv")&&(t.useCompressedUv=e.useCompressedUv,t.uvCenter=e.uvCenter,t.uvHalfExtent=e.uvHalfExtent),e.hasOwnProperty("clipIntersection")&&(t.clipIntersection=e.clipIntersection),t},o.nextHighestPowerOfTwo=e=>{--e;for(let t=1;t<32;t<<=1)e|=e>>t;return e+1},o.getImageByteSize=e=>e.width*e.height*4,o.ensurePowerOfTwo=e=>{if(0==e.width||0==e.height)return e;if(!THREE.Math.isPowerOfTwo(e.width)||!THREE.Math.isPowerOfTwo(e.height)){let t=document.createElement("canvas");t.width=r.MaterialUtil.nextHighestPowerOfTwo(e.width),t.height=r.MaterialUtil.nextHighestPowerOfTwo(e.height);return t.getContext("2d").drawImage(e,0,0,e.width,e.height,0,0,t.width,t.height),t}return e},o.ensureQuadrate=e=>{let t=e.width,i=e.height;if(0==t||0==i||THREE.Math.isPowerOfTwo(t)&&THREE.Math.isPowerOfTwo(i)&&t===i)return e;THREE.Math.isPowerOfTwo(t)||(t=r.MaterialUtil.nextHighestPowerOfTwo(t)),THREE.Math.isPowerOfTwo(i)||(i=r.MaterialUtil.nextHighestPowerOfTwo(i));let a=0,n=0,s=e.width,o=e.height,l=Math.max(t,i);if(s>=o){o*=l/s,s=l,n=.5*(l-o)}else{s*=l/o,o=l,a=.5*(l-s)}let d=document.createElement("canvas");d.width=d.height=l;return d.getContext("2d").drawImage(e,a,n,s,o),d},o.getColorParamsByMaterial=e=>({rgbaColor:[e.color.r,e.color.g,e.color.b,e.opacity],transparent:e.transparent}),o.getHoverColorByColor=e=>{let t={};return t.r=e.r,t.g=e.g,t.b=e.b,t.a=r.MaterialUtil.getHoverOpacity(e.a),t},o.getHoverOpacity=e=>e>=.4?e-.3:e+.3,o.cloneMaterialBaseOnColor=(e,t)=>{if(!e.color&&!e.diffuse)return e;let i=e.clone();return i.opacity=t.opacity,i.transparent=t.transparent,i.color&&i.color.isColor&&t.color&&t.color.isColor&&i.color.copy(t.color),i.diffuse&&i.diffuse.isColor&&t.diffuse&&t.diffuse.isColor&&i.diffuse.copy(t.diffuse),void 0!==i.map&&t.map&&(i.map=t.map,i.alphaMap=t.alphaMap,i.alphaTest=t.alphaTest),i},o.updateUVMatrix=e=>{e.matrixAutoUpdate=!1,o.setUvTransform(e.offset.x,e.offset.y,e.repeat.x,e.repeat.y,e.rotation,e.center.x,e.center.y,e.matrix)},o.setUvTransform=(e,t,i,r,a,n,s,o)=>{const l=Math.cos(a),d=Math.sin(a);return o.set(i*l,-i*d,-i*l*e+d*i*t,r*d,r*l,-r*d*e-r*l*t,0,0,1),o},o.updateUVMatrix2=e=>{e.matrixAutoUpdate=!1,o.setUvTransform2(e.offset.x,e.offset.y,e.repeat.x,e.repeat.y,e.rotation,e.center.x,e.center.y,e.matrix)},o.setUvTransform2=(e,t,i,r,a,n,s,o)=>{const l=Math.cos(a),d=Math.sin(a);return o.set(i*l,-i*d,-.5*i*l+.5*i*d+.5*i-i*e,r*d,r*l,-.5*r*d-.5*r*l+.5*r-r*t,0,0,1),o},o.loadFillMap=(e,t)=>{let i=[];const r=o.createFillPatternByWidth(e,t);if(!r)return;for(let e=0;e<1024;e++){let t=r[Math.floor(e/8)];const a=Math.floor(Math.pow(2,e%8));t=Math.floor(t&a),0===t?(i.push(0),i.push(0),i.push(0),i.push(0)):(i.push(255),i.push(255),i.push(255),i.push(255))}let a=new THREE.DataTexture(new Uint8Array(i),32,32,THREE.RGBAFormat,THREE.UnsignedByteType);return a.minFilter=THREE.NearestFilter,a.magFilter=THREE.NearestFilter,a.wrapS=THREE.RepeatWrapping,a.wrapT=THREE.RepeatWrapping,a.needsUpdate=!0,a},o.createFillPatternByWidth=(e,t)=>{if(void 0===t)return r.FILLPATTERN[e];let i=[...r.FILLPATTERN[e]];if("horizontalLine"===e)for(let e=0;e<128;e++)i[e]=e%32<24?0:255;if("verticalLine"===e)for(let e=0;e<128;e++)i[e]=192;if("orthogonalCrossLine"===e)for(let e=0;e<32;e++)for(let t=0;t<4;t++)i[4*e+t]=192,e%8>5&&(i[4*e+t]=255);if("rightDiagonalLine"===e){let e=192;const t=8;for(let r=0;r<32;r++){let a=e>>r%t;1==a&&(a=129),i[4*r]=a,i[4*r+1]=a,i[4*r+2]=a,i[4*r+3]=a}}if("leftDiagonalLine"===e){let e=3;const t=8;for(let r=0;r<32;r++){let a=e<<r%t;384==a&&(a=129),i[4*r]=a,i[4*r+1]=a,i[4*r+2]=a,i[4*r+3]=a}}if("skewCrossLine"===e){const e=[195,102,60,24,60,102,195,129],t=8;for(let r=0;r<32;r++){const a=r%t;i[4*r]=e[a],i[4*r+1]=e[a],i[4*r+2]=e[a],i[4*r+3]=e[a]}}return i},o.loadTexture=(e,t,i)=>{(new TEST.CryptoResourceLoader).loadURL(e,(e=>{var a=new Blob([e],{type:"jpeg"});let n=new Image;n.onload=function(){!function(e){var i=new THREE.Texture;i.image=r.MaterialUtil.ensurePowerOfTwo(e),i.needsUpdate=!0,i.encoding=THREE.GammaEncoding,r.MaterialUtil.updateUVMatrix(i),i.wrapS=THREE.RepeatWrapping,i.wrapT=THREE.RepeatWrapping,t&&t(i)}(n)},n.onerror=e=>{console.log("ERROR: image load error!!"),console.log(e),i&&i(e)},n.src=URL.createObjectURL(a)}),null,(e=>{console.log("ERROR: image load error!!"),console.log(e),i&&i(e)}))},r.MaterialUtil=o})(),r.UIHelper={debugInfoDiv:null,lastDebugInfoDivShow:null,showPickedInformation:function(e){var t=340,i=320,r=this;function a(){var e=r.debugInfoDiv;e&&"none"!==e.style.display&&(e.style.display="none",r.lastDebugInfoDivShow&&(e.removeEventListener("dblclick",a,!1),r.lastDebugInfoDivShow=!1))}if(e&&e.intersectInfo){var n=e.intersectInfo,s=e.canvasPos.x,o=e.canvasPos.y;this.debugInfoDiv||(this.debugInfoDiv=document.createElement("div"),this.debugInfoDiv.id="debugPickedInfo",this.debugInfoDiv.style.display="block",this.debugInfoDiv.style.position="absolute",this.debugInfoDiv.style.width="340px",this.debugInfoDiv.style.height="320px",this.debugInfoDiv.style.backgroundColor="#ffffdd",this.debugInfoDiv.style.borderWidth="2px",this.debugInfoDiv.style.borderStyle="solid",this.debugInfoDiv.style.opacity="0.8",document.body.appendChild(this.debugInfoDiv)),this.debugInfoDiv.style.display="",this.lastDebugInfoDivShow||(this.lastDebugInfoDivShow=!0,this.debugInfoDiv.addEventListener("dblclick",a,!1));var l=n.axisGridInfo,d=n.worldPosition,h="";h+="<span>&#9830;&nbsp;&nbsp;Base Information</span><ul style='width:340px;list-style:none'>",h+="<li style='border-left:1px solid #ccc;border-top:1px solid #ccc;border-bottom: 1px solid #ccc;float:left;width:80px;height:66px;text-align:left;line-height:66px'>ID</li>",h+="<li style='border:1px solid #ccc;float:left;width:200px;height:66px;text-align:left;'>"+n.selectedObjectId+"</li>",h+="</ul>",h+="</br><span>&#9830;&nbsp;&nbsp;Position</span><ul style='width:340px;list-style:none'>",h+="<li style='border-left:1px solid #ccc;border-top:1px solid #ccc;float:left;width:80px;height:33px;text-align:left;line-height:33px'>X</li>",h+="<li style='border-left:1px solid #ccc;border-top:1px solid #ccc;float:left;width:200px;height:33px;text-align:left;line-height:33px;border-right: 1px solid #ccc'>"+d.x+"</li>",h+="<li style='border-left:1px solid #ccc;border-top:1px solid #ccc;float:left;width:80px;height:33px;text-align:left;line-height:33px'>Y</li>",h+="<li style='border-left:1px solid #ccc;border-top:1px solid #ccc;float:left;width:200px;height:33px;text-align:left;line-height:33px;border-right: 1px solid #ccc'>"+d.y+"</li>",h+="<li style='border-left:1px solid #ccc;border-top:1px solid #ccc;float:left;width:80px;height:33px;text-align:left;line-height:33px;border-bottom: 1px solid #ccc'>Z</li>",h+="<li style='border:1px solid #ccc;float:left;width:200px;height:33px;text-align:left;line-height:33px'>"+d.z+"</li>",h+="</ul>",l?(h+="</br><span>&#9830;&nbsp;&nbsp;Axis Grid Information</span><ul style='width:340px;list-style:none'>",h+="<li style='border-left:1px solid #ccc;border-top:1px solid #ccc;float:left;width:80px;height:33px;text-align:left;line-height:33px'>distanceX</li>",h+="<li style='border-left:1px solid #ccc;border-top:1px solid #ccc;float:left;width:200px;height:33px;text-align:left;line-height:33px;border-right: 1px solid #ccc'>("+l.numeralName+", "+l.offsetX+")</li>",h+="<li style='border-left:1px solid #ccc;border-top:1px solid #ccc;float:left;width:80px;height:33px;text-align:left;line-height:33px;border-bottom: 1px solid #ccc'>distanceY</li>",h+="<li style='border:1px solid #ccc;float:left;width:200px;height:33px;text-align:left;line-height:33px'>("+l.abcName+", "+l.offsetY+")</li>",h+="</ul>"):(h+="</br><span>&#9830;&nbsp;&nbsp;Axis Grid Information</span><ul style='width:340px;list-style:none'>",h+="<li style='border-left:1px solid #ccc;border-top:1px solid #ccc;float:left;width:80px;height:33px;text-align:left;line-height:33px;border-bottom: 1px solid #ccc'>message</li>",h+="<li style='border:1px solid #ccc;float:left;width:200px;height:33px;text-align:left;line-height:33px'><span style='color: red'> not exist axis grid!!!</span></li>",h+="</ul>"),this.debugInfoDiv.innerHTML=h+"<br /><br />",function(e,r,a){if(e&&"none"!=e.style.display){var n,s,o,l=r+t,d=a+i;if(void 0!==r&&void 0!==a)if(window.innerWidth)n=l>window.innerWidth?window.pageXOffset+(r-t)+"px":window.pageXOffset+r+"px",s=d>window.innerHeight?window.pageYOffset+(a-i)+"px":window.pageYOffset+a+"px";else n=(o=document.documentElement).scrollLeft+r+"px",s=o.scrollTop+a+"px";else if(window.innerWidth)n=window.pageXOffset+(window.innerWidth-t)/2+"px",s=window.pageYOffset+(window.innerHeight-i)/2+"px";else n=(o=document.documentElement).scrollLeft+(o.offsetWidth-t)/2+"px",s=o.scrollTop+(o.offsetHeight-i)/2+"px";e.style.left=n,e.style.top=s}}(this.debugInfoDiv,s,o)}else a()}},function(){let e=new THREE.Vector3,t=new THREE.Vector2;r.Edge=function(){this.vertexIndex=new Array(2),this.faceIndex=new Array(2)},r.RemoveDuplicateIndex=function(e,t){var i=e.length/3,r=new Array(i),a=new Array(i);function n(e,t){var i=r[e],a=r[t];return i.x!=a.x?i.x-a.x:i.y!=a.y?i.y-a.y:i.z-a.z}for(var s=0;s<i;++s)r[s]=new THREE.Vector3(e[3*s],e[3*s+1],e[3*s+2]),a[s]=s;a.sort((function(e,t){var i=n(e,t);return 0==i?e-t:i}));var o={},l=a[0];for(s=1;s<i;++s)0==n(l,a[s])?o[a[s]]=l:l=a[s];var d=new Array(t.length);for(s=0;s<t.length;++s)o.hasOwnProperty(t[s])?d[s]=o[t[s]]:d[s]=t[s];return d},r.RemoveDuplicateVertex=function(e,t){function i(e,t){return e-t}var a=r.RemoveDuplicateIndex(e,t);a.sort(i);var n=new Array,s=a[0];n.push(s);for(var o=1;o<a.length;++o)a[o]!=s&&(s=a[o],n.push(s));return n.sort(i)},r.BuildEdge=function(e,t,i){i=null==i?Math.PI/4:i;for(var a=r.RemoveDuplicateIndex(e,t),n=a.length,s=e.length/3,o=new Array(s+n),l=s,d=a.length/3,h=0;h<s;++h)o[h]=-1;var c=new Array(n),u=0;for(h=0;h<d;++h)for(var p=a[3*h+2],m=0;m<3;++m){var f=!1,g=a[3*h+m];if(p>g){f=!0;var v=p;p=g,g=v}var y=new r.Edge;y.vertexIndex[0]=p,y.vertexIndex[1]=g,y.faceIndex[0]=h,y.faceIndex[1]=h;var M=o[p];if(-1==M)o[p]=u,c[u]=y,o[l+u]=-1,u++;else for(;;){if((I=c[M]).vertexIndex[1]==g){I.faceIndex[1]=h;break}var E=o[l+M];if(-1==E){o[l+M]=u,c[u]=y,o[l+u]=-1,u++;break}M=E}f||(p=g)}var b=[];for(h=0;h<u;++h){var I;if((I=c[h]).faceIndex[0]==I.faceIndex[1])b.push(I.vertexIndex[0]),b.push(I.vertexIndex[1]);else{var x=I.faceIndex[0],T=a[3*x],_=a[3*x+1],S=a[3*x+2],C=new THREE.Vector3(e[3*T],e[3*T+1],e[3*T+2]),w=new THREE.Vector3(e[3*_],e[3*_+1],e[3*_+2]),R=new THREE.Vector3(e[3*S],e[3*S+1],e[3*S+2]),B=C.sub(w),L=w.sub(R),O=B.cross(L);O.normalize();var P=I.faceIndex[1];T=a[3*P],_=a[3*P+1],S=a[3*P+2],C=new THREE.Vector3(e[3*T],e[3*T+1],e[3*T+2]),w=new THREE.Vector3(e[3*_],e[3*_+1],e[3*_+2]),R=new THREE.Vector3(e[3*S],e[3*S+1],e[3*S+2]),B=C.sub(w),L=w.sub(R);var D=B.cross(L);D.normalize(),Math.abs(O.dot(D))<i&&(b.push(I.vertexIndex[0]),b.push(I.vertexIndex[1]))}}return b},r.GetFaceIndex=function(i,a,n,s,o,l){for(var d=n.length/3,h=new Array,c=0;c<d;++c){var u=n[3*c];l?(t.set(a[2*u],a[2*u+1]),e=r.Math.octDecode(t,e)):e.set(a[3*u],a[3*u+1],a[3*u+2]);var p=e.dot(o);if(Math.abs(p-1)<.001){var m=-new THREE.Vector3(i[3*u],i[3*u+1],i[3*u+2]).dot(e),f=Math.abs(s.dot(e)+m);Math.abs(f)<3&&h.push(n[3*c],n[3*c+1],n[3*c+2])}}return h},r.BuildRoomEdge=function(e,t,i,r,a){function n(e,t){return Math.abs(e-t)<=.1}var s=e.length;n(e[0].x,e[s-1].x)&&n(e[0].y,e[s-1].y)||e.push(e[0]),s=e.length;for(var o=[],l=[],d=new THREE.BufferGeometry,h=0;h<s;++h)l.push(e[h].x-t,e[h].y-i,e[h].z-r);for(h=0;h<s;++h)l.push(e[h].x-t,e[h].y-i,e[h].z-r+a);for(h=0;h<2*s-1;++h)h!=s-1&&o.push(h,h+1);for(h=0;h<s-1;++h)o.push(h,h+s);return d.setIndex(new THREE.BufferAttribute(new Uint16Array(o),1)),d.setAttribute("position",new THREE.BufferAttribute(new Float32Array(l),3)),d.computeBoundingSphere(),d}}(),THREE.DDSLoader=function(){this._parser=THREE.DDSLoader.parse,this.loadBuffer=THREE.DDSLoader.loadBuffer},THREE.DDSLoader.prototype=Object.create(THREE.CompressedTextureLoader.prototype),THREE.DDSLoader.prototype.constructor=THREE.DDSLoader,THREE.DDSLoader.parse=function(e,t){var i={mipmaps:[],width:0,height:0,format:null,mipmapCount:1};function r(e){return e.charCodeAt(0)+(e.charCodeAt(1)<<8)+(e.charCodeAt(2)<<16)+(e.charCodeAt(3)<<24)}function a(e,t,i,r){for(var a=i*r*4,n=new Uint8Array(e,t,a),s=new Uint8Array(a),o=0,l=0,d=0;d<r;d++)for(var h=0;h<i;h++){var c=n[l],u=n[++l],p=n[++l],m=n[++l];l++,s[o]=p,s[++o]=u,s[++o]=c,s[++o]=m,o++}return s}var n,s=r("DXT1"),o=r("DXT3"),l=r("DXT5"),d=r("ETC1"),h=new Int32Array(e,0,31);if(542327876!==h[0])return console.error("THREE.DDSLoader.parse: Invalid magic number in DDS header."),i;if(4&!h[20])return console.error("THREE.DDSLoader.parse: Unsupported format, must contain a FourCC code."),i;var c,u=h[21],p=!1;switch(u){case s:n=8,i.format=THREE.RGB_S3TC_DXT1_Format;break;case o:n=16,i.format=THREE.RGBA_S3TC_DXT3_Format;break;case l:n=16,i.format=THREE.RGBA_S3TC_DXT5_Format;break;case d:n=8,i.format=THREE.RGB_ETC1_Format;break;default:if(!(32===h[22]&&16711680&h[23]&&65280&h[24]&&255&h[25]&&4278190080&h[26]))return console.error("THREE.DDSLoader.parse: Unsupported FourCC code ",(c=u,String.fromCharCode(255&c,c>>8&255,c>>16&255,c>>24&255))),i;p=!0,n=64,i.format=THREE.RGBAFormat}i.mipmapCount=1,131072&h[2]&&!1!==t&&(i.mipmapCount=Math.max(1,h[7]));var m=h[28];if(i.isCubemap=!!(512&m),i.isCubemap&&(!(1024&m)||!(2048&m)||!(4096&m)||!(8192&m)||!(16384&m)||!(32768&m)))return console.error("THREE.DDSLoader.parse: Incomplete cubemap faces"),i;i.width=h[4],i.height=h[3];for(var f=h[1]+4,g=i.isCubemap?6:1,v=0;v<g;v++)for(var y=i.width,M=i.height,E=0;E<i.mipmapCount;E++){if(p)var b=(I=a(e,f,y,M)).length;else{b=Math.max(4,y)/4*Math.max(4,M)/4*n;var I=new Uint8Array(e,f,b)}var x={data:I,width:y,height:M};i.mipmaps.push(x),f+=b,y=Math.max(y>>1,1),M=Math.max(M>>1,1)}return i},THREE.DDSLoader.loadBuffer=function(e,t){var i=[],r=new THREE.CompressedTexture;r.image=i;var a=this._parser(e,!0);if(a.isCubemap)for(var n=a.mipmaps.length/a.mipmapCount,s=0;s<n;s++){i[s]={mipmaps:[]};for(var o=0;o<a.mipmapCount;o++)i[s].mipmaps.push(a.mipmaps[s*a.mipmapCount+o]),i[s].format=a.format,i[s].width=a.width,i[s].height=a.height}else r.image.width=a.width,r.image.height=a.height,r.mipmaps=a.mipmaps;1===a.mipmapCount&&(r.minFilter=THREE.LinearFilter),r.format=a.format,r.needsUpdate=!0,t&&t(r)},r.SplitGeometryBuilder=class{constructor(e,t){this.sourceGeometry=e,this.slicePlane=t,this.addedVertices=[],this.addedIntersections=[];var i=this.sourceGeometry.getAttribute("uv");this.uvs=i?i.array:null;var r=this.sourceGeometry.getAttribute("normal");this.normals=r?r.array:null;var a=this.sourceGeometry.getAttribute("position");this.positions=a?a.array:null;const n=this.sourceGeometry.getAttribute("color");this.colors=n?n.array:null,this.targetIndices=[],this.targetNormals=[],this.targetUvs=[],this.targetPositions=[],this.targetColors=[]}startFace(e,t){this.sourceFaceIndex=e,this.sourceFace=t,this.faceIndices=[]}endFace(){this._addFace(this.faceIndices)}addVertex(e){var t,i=this.sourceFace[e];if(this.addedVertices.hasOwnProperty(i))t=this.addedVertices[i];else{var r=3*i;if(this.targetPositions.push(this.positions[r]),this.targetPositions.push(this.positions[r+1]),this.targetPositions.push(this.positions[r+2]),null!==this.colors){const e=4*i;this.targetColors.push(this.colors[e]),this.targetColors.push(this.colors[e+1]),this.targetColors.push(this.colors[e+2]),this.targetColors.push(this.colors[e+3])}t=this.targetPositions.length/3-1,this.addedVertices[i]=t,this._addUv(e),this._addNormal(e)}this.faceIndices.push(t)}addIntersection(e,t,i,r){var a,n=Math.abs(i)/(Math.abs(i)+Math.abs(r)),s=this.sourceFace[e],o=this.sourceFace[t],l=this._intersectionId(s,o);if(this.addedIntersections.hasOwnProperty(l))a=this.addedIntersections[l];else{var d=3*s,h=3*o,c=this.positions[d],u=this.positions[d+1],p=this.positions[d+2];if(this.targetPositions.push(c+(this.positions[h]-c)*n),this.targetPositions.push(u+(this.positions[h+1]-u)*n),this.targetPositions.push(p+(this.positions[h+2]-p)*n),null!==this.colors){const e=4*s,t=4*o;this.targetColors.push((this.colors[e]+this.colors[t])/2),this.targetColors.push((this.colors[e+1]+this.colors[t+1])/2),this.targetColors.push((this.colors[e+2]+this.colors[t+2])/2),this.targetColors.push((this.colors[e+3]+this.colors[t+3])/2)}a=this.targetPositions.length/3-1,this.addedIntersections[l]=a,this._addIntersectionUv(e,t,n),this._addIntersectionNormal(e,t,n)}this.faceIndices.push(a)}_addUv(e){if(this.uvs){var t=2*this._keyIndex(e),i=this.uvs[t],r=this.uvs[t+1];this.targetUvs.push(i),this.targetUvs.push(r)}}_addIntersectionUv(e,t,i){if(this.uvs){var r=2*this._keyIndex(e),a=2*this._keyIndex(t),n=this.uvs[r],s=this.uvs[r+1],o=n+(this.uvs[a]-n)*i,l=s+(this.uvs[a+1]-s)*i;this.targetUvs.push(o),this.targetUvs.push(l)}}_addNormal(e){if(this.normals){var t=3*this._keyIndex(e);this.targetNormals.push(this.normals[t]),this.targetNormals.push(this.normals[t+1]),this.targetNormals.push(this.normals[t+2])}}_addIntersectionNormal(e,t,i){if(this.normals){var r=3*this._keyIndex(e),a=3*this._keyIndex(t),n=this.normals[r],s=this.normals[r+1],o=this.normals[r+2];this.targetNormals.push(n+(this.normals[a]-n)*i),this.targetNormals.push(s+(this.normals[a+1]-s)*i),this.targetNormals.push(o+(this.normals[a+2]-o)*i)}}_addFace(e){if(!(e.length<3)){if(3===e.length)return this.targetIndices.push(e[0]),this.targetIndices.push(e[1]),void this.targetIndices.push(e[2]);for(var t=[],i=0;i<e.length;i++)for(var r=i+1;r<e.length;r++){var a=Math.abs(i-r);a>1&&a<e.length-1&&t.push([e[i],e[r]])}t.sort(function(e,t){return this._faceEdgeLength(e[0],e[1])-this._faceEdgeLength(t[0],t[1])}.bind(this));var n=e.indexOf(t[0][0]),s=(e=e.slice(n).concat(e.slice(0,n))).indexOf(t[0][1]),o=e.slice(0,s+1),l=e.slice(s).concat(e.slice(0,1));this._addFace(o),this._addFace(l)}}_faceEdgeLength(e,t){var i=3*this.faceIndices[e],r=3*this.faceIndices[t],a=this.targetPositions[i],n=this.targetPositions[i+1],s=this.targetPositions[i+2],o=a-this.targetPositions[r],l=n-this.targetPositions[r+1],d=s-this.targetPositions[r+2];return o*o+l*l+d*d}_intersectionId(e,t){return[e,t].sort().join(",")}_keyIndex(e){return this.sourceFace[e]}},r.PerformanceStats=class{constructor(e){e.container||r.Error.throwError(r.ERRORS.DEVELOPE_EXCEPTION,"container is required"),this._container=e.container,this._fpsPanel=document.createElement("div"),this._fpsPanel.style.cssText="position:fixed;top:0;left:0;cursor:pointer;opacity:0.9;z-index:10000;background:#002;color:#0ff",this._container.appendChild(this._fpsPanel),this._fpsText=document.createTextNode(""),this._fpsPanel.appendChild(this._fpsText),this._beginTime=this.getTimestamp(),this._prevTime=this._beginTime,this._frames=0,this._minFps=1/0,this._maxFps=0}destroy(){this._fpsText.parentNode&&(this._fpsText.parentNode.removeChild(this._fpsText),this._fpsText=null),this._fpsPanel.parentNode&&(this._fpsPanel.parentNode.removeChild(this._fpsPanel),this._fpsPanel=null),this._container=null}begin(){this._beginTime=this.getTimestamp()}end(){++this._frames;let e=this.getTimestamp(),t=e-this._prevTime;if(t>1e3){const i=1e3*this._frames/t|0;this._minFps=Math.min(i,this._minFps),this._maxFps=Math.max(i,this._maxFps),this._fpsText.nodeValue=Math.round(i)+" FPS ("+Math.round(this._minFps)+"-"+Math.round(this._maxFps)+")",this._prevTime=e,this._frames=0}return e}update(){this._beginTime=this.end()}getTimestamp(){return(performance||Date).now()}},r.SkeletonUtils={parallelTraverse:function(e,t,i){i(e,t);for(var r=0;r<e.children.length;r++)this.parallelTraverse(e.children[r],t.children[r],i)},retarget:(v=new THREE.Vector3,y=new THREE.Quaternion,M=new THREE.Vector3,E=new THREE.Matrix4,b=new THREE.Matrix4,I=new THREE.Matrix4,function(e,t,i){(i=i||{}).preserveMatrix=void 0===i.preserveMatrix||i.preserveMatrix,i.preservePosition=void 0===i.preservePosition||i.preservePosition,i.preserveHipPosition=void 0!==i.preserveHipPosition&&i.preserveHipPosition,i.useTargetMatrix=void 0!==i.useTargetMatrix&&i.useTargetMatrix,i.hip=void 0!==i.hip?i.hip:"hip",i.names=i.names||{};var r,a,n,s,o,l,d=t.isObject3D?t.skeleton.bones:this.getBones(t),h=e.isObject3D?e.skeleton.bones:this.getBones(e);if(e.isObject3D?e.skeleton.pose():(i.useTargetMatrix=!0,i.preserveMatrix=!1),i.preservePosition)for(o=[],l=0;l<h.length;l++)o.push(h[l].position.clone());if(i.preserveMatrix)for(e.updateMatrixWorld(),e.matrixWorld.identity(),l=0;l<e.children.length;++l)e.children[l].updateMatrixWorld(!0);if(i.offsets)for(r=[],l=0;l<h.length;++l)a=h[l],n=i.names[a.name]||a.name,i.offsets&&i.offsets[n]&&(a.matrix.multiply(i.offsets[n]),a.matrix.decompose(a.position,a.quaternion,a.scale),a.updateMatrixWorld()),r.push(a.matrixWorld.clone());for(l=0;l<h.length;++l){if(a=h[l],n=i.names[a.name]||a.name,s=this.getBoneByName(n,d),I.copy(a.matrixWorld),s){if(s.updateMatrixWorld(),i.useTargetMatrix?b.copy(s.matrixWorld):(b.copy(e.matrixWorld).invert(),b.multiply(s.matrixWorld)),M.setFromMatrixScale(b),b.scale(M.set(1/M.x,1/M.y,1/M.z)),I.makeRotationFromQuaternion(y.setFromRotationMatrix(b)),e.isObject3D){var c=h.indexOf(a),u=r?r[c]:E.copy(e.skeleton.boneInverses[c]).invert();I.multiply(u)}I.copyPosition(b)}a.parent&&a.parent.isBone?(a.matrix.copy(a.parent.matrixWorld).invert(),a.matrix.multiply(I)):a.matrix.copy(I),i.preserveHipPosition&&n===i.hip&&a.matrix.setPosition(v.set(0,a.position.y,0)),a.matrix.decompose(a.position,a.quaternion,a.scale),a.updateMatrixWorld()}if(i.preservePosition)for(l=0;l<h.length;++l)a=h[l],(n=i.names[a.name]||a.name)!==i.hip&&a.position.copy(o[l]);i.preserveMatrix&&e.updateMatrixWorld(!0)}),retargetClip:function(e,t,i,r){(r=r||{}).useFirstFramePosition=void 0!==r.useFirstFramePosition&&r.useFirstFramePosition,r.fps=void 0!==r.fps?r.fps:30,r.names=r.names||[],t.isObject3D||(t=this.getHelperFromSkeleton(t));var a,n,s,o,l,d,h=Math.round(i.duration*(r.fps/1e3)*1e3),c=1/r.fps,u=[],p=new THREE.AnimationMixer(t),m=this.getBones(e.skeleton),f=[];for(p.clipAction(i).play(),p.update(0),t.updateMatrixWorld(),l=0;l<h;++l){var g=l*c;for(this.retarget(e,t,r),d=0;d<m.length;++d)o=r.names[m[d].name]||m[d].name,this.getBoneByName(o,t.skeleton)&&(n=m[d],s=f[d]=f[d]||{bone:n},r.hip===o&&(s.pos||(s.pos={times:new Float32Array(h),values:new Float32Array(3*h)}),r.useFirstFramePosition&&(0===l&&(a=n.position.clone()),n.position.sub(a)),s.pos.times[l]=g,n.position.toArray(s.pos.values,3*l)),s.quat||(s.quat={times:new Float32Array(h),values:new Float32Array(4*h)}),s.quat.times[l]=g,n.quaternion.toArray(s.quat.values,4*l));p.update(c),t.updateMatrixWorld()}for(l=0;l<f.length;++l)(s=f[l])&&(s.pos&&u.push(new THREE.VectorKeyframeTrack(".bones["+s.bone.name+"].position",s.pos.times,s.pos.values)),u.push(new THREE.QuaterQuaternionKeyframeTrackion(".bones["+s.bone.name+"].quaternion",s.quat.times,s.quat.values)));return p.uncacheAction(i),new THREE.AnimationClip(i.name,-1,u)},getHelperFromSkeleton:function(e){var t=new THREE.SkeletonHelper(e.bones[0]);return t.skeleton=e,t},getSkeletonOffsets:(c=new THREE.Vector3,u=new THREE.Vector3,p=new THREE.Vector3,m=new THREE.Vector3,f=new THREE.Vector2,g=new THREE.Vector2,function(e,t,i){(i=i||{}).hip=void 0!==i.hip?i.hip:"hip",i.names=i.names||{},t.isObject3D||(t=this.getHelperFromSkeleton(t));var r,a,n,s,o=Object.keys(i.names),l=Object.values(i.names),d=t.isObject3D?t.skeleton.bones:this.getBones(t),h=e.isObject3D?e.skeleton.bones:this.getBones(e),v=[];for(e.skeleton.pose(),s=0;s<h.length;++s)if(r=h[s],n=i.names[r.name]||r.name,(a=this.getBoneByName(n,d))&&n!==i.hip){var y=this.getNearestBone(r.parent,o),M=this.getNearestBone(a.parent,l);y.updateMatrixWorld(),M.updateMatrixWorld(),c.setFromMatrixPosition(y.matrixWorld),u.setFromMatrixPosition(r.matrixWorld),p.setFromMatrixPosition(M.matrixWorld),m.setFromMatrixPosition(a.matrixWorld),f.subVectors(new THREE.Vector2(u.x,u.y),new THREE.Vector2(c.x,c.y)).normalize(),g.subVectors(new THREE.Vector2(m.x,m.y),new THREE.Vector2(p.x,p.y)).normalize();var E=f.angle()-g.angle(),b=(new THREE.Matrix4).makeRotationFromEuler(new THREE.Euler(0,0,E));r.matrix.multiply(b),r.matrix.decompose(r.position,r.quaternion,r.scale),r.updateMatrixWorld(),v[n]=b}return v}),renameBones:function(e,t){for(var i=this.getBones(e),r=0;r<i.length;++r){var a=i[r];t[a.name]&&(a.name=t[a.name])}return this},getBones:function(e){return Array.isArray(e)?e:e.bones},getBoneByName:function(e,t){for(var i=0,r=this.getBones(t);i<r.length;i++)if(e===r[i].name)return r[i]},getNearestBone:function(e,t){for(;e.isBone;){if(-1!==t.indexOf(e.name))return e;e=e.parent}},findBoneTrackData:function(e,t){for(var i=/\[(.*)\]\.(.*)/,r={name:e},a=0;a<t.length;++a){var n=i.exec(t[a].name);n&&e===n[1]&&(r[n[2]]=a)}return r},getEqualsBonesNames:function(e,t){var i=this.getBones(e),r=this.getBones(t),a=[];e:for(var n=0;n<i.length;n++)for(var s=i[n].name,o=0;o<r.length;o++)if(s===r[o].name){a.push(s);continue e}return a},clone:function(e){var t=new Map,i=new Map,r=e.clone();return this.parallelTraverse(e,r,(function(e,r){t.set(r,e),i.set(e,r)})),r.traverse((function(e){if(e.isSkinnedMesh){var r=e,a=t.get(e),n=a.skeleton.bones;r.skeleton=a.skeleton.clone(),r.bindMatrix.copy(a.bindMatrix),r.skeleton.bones=n.map((function(e){return i.get(e)})),r.bind(r.skeleton,r.bindMatrix)}})),r}},function(){function e(e,r,n){n=n||2;var s,o,l,c,u,m,f,g=r&&r.length,v=g?r[0]*n:e.length,y=t(e,0,v,n,!0),M=[];if(!y||y.next===y.prev)return M;if(g&&(y=function(e,r,a,n){var s,o,l,c=[];for(s=0,o=r.length;s<o;s++)(l=t(e,r[s]*n,s<o-1?r[s+1]*n:e.length,n,!1))===l.next&&(l.steiner=!0),c.push(p(l));for(c.sort(d),s=0;s<c.length;s++)h(c[s],a),a=i(a,a.next);return a}(e,r,y,n)),e.length>80*n){s=l=e[0],o=c=e[1];for(var E=n;E<v;E+=n)(u=e[E])<s&&(s=u),(m=e[E+1])<o&&(o=m),u>l&&(l=u),m>c&&(c=m);f=0!==(f=Math.max(l-s,c-o))?1/f:0}return a(y,M,n,s,o,f),M}function t(e,t,i,r,a){var n,s;if(a===S(e,t,i,r)>0)for(n=t;n<i;n+=r)s=x(n,e[n],e[n+1],s);else for(n=i-r;n>=t;n-=r)s=x(n,e[n],e[n+1],s);return s&&v(s,s.next)&&(T(s),s=s.next),s}function i(e,t){if(!e)return e;t||(t=e);var i,r=e;do{if(i=!1,r.steiner||!v(r,r.next)&&0!==g(r.prev,r,r.next))r=r.next;else{if(T(r),(r=t=r.prev)===r.next)break;i=!0}}while(i||r!==t);return t}function a(e,t,r,d,h,c,p){if(e){!p&&c&&function(e,t,i,r){var a=e;do{null===a.z&&(a.z=u(a.x,a.y,t,i,r)),a.prevZ=a.prev,a.nextZ=a.next,a=a.next}while(a!==e);a.prevZ.nextZ=null,a.prevZ=null,function(e){var t,i,r,a,n,s,o,l,d=1;do{for(i=e,e=null,n=null,s=0;i;){for(s++,r=i,o=0,t=0;t<d&&(o++,r=r.nextZ);t++);for(l=d;o>0||l>0&&r;)0!==o&&(0===l||!r||i.z<=r.z)?(a=i,i=i.nextZ,o--):(a=r,r=r.nextZ,l--),n?n.nextZ=a:e=a,a.prevZ=n,n=a;i=r}n.nextZ=null,d*=2}while(s>1)}(a)}(e,d,h,c);for(var m,f,g=e;e.prev!==e.next;)if(m=e.prev,f=e.next,c?s(e,d,h,c):n(e))t.push(m.i/r),t.push(e.i/r),t.push(f.i/r),T(e),e=f.next,g=f.next;else if((e=f)===g){p?1===p?a(e=o(i(e),t,r),t,r,d,h,c,2):2===p&&l(e,t,r,d,h,c):a(i(e),t,r,d,h,c,1);break}}}function n(e){var t=e.prev,i=e,r=e.next;if(g(t,i,r)>=0)return!1;for(var a=e.next.next;a!==e.prev;){if(m(t.x,t.y,i.x,i.y,r.x,r.y,a.x,a.y)&&g(a.prev,a,a.next)>=0)return!1;a=a.next}return!0}function s(e,t,i,r){var a=e.prev,n=e,s=e.next;if(g(a,n,s)>=0)return!1;for(var o=a.x<n.x?a.x<s.x?a.x:s.x:n.x<s.x?n.x:s.x,l=a.y<n.y?a.y<s.y?a.y:s.y:n.y<s.y?n.y:s.y,d=a.x>n.x?a.x>s.x?a.x:s.x:n.x>s.x?n.x:s.x,h=a.y>n.y?a.y>s.y?a.y:s.y:n.y>s.y?n.y:s.y,c=u(o,l,t,i,r),p=u(d,h,t,i,r),f=e.prevZ,v=e.nextZ;f&&f.z>=c&&v&&v.z<=p;){if(f!==e.prev&&f!==e.next&&m(a.x,a.y,n.x,n.y,s.x,s.y,f.x,f.y)&&g(f.prev,f,f.next)>=0)return!1;if(f=f.prevZ,v!==e.prev&&v!==e.next&&m(a.x,a.y,n.x,n.y,s.x,s.y,v.x,v.y)&&g(v.prev,v,v.next)>=0)return!1;v=v.nextZ}for(;f&&f.z>=c;){if(f!==e.prev&&f!==e.next&&m(a.x,a.y,n.x,n.y,s.x,s.y,f.x,f.y)&&g(f.prev,f,f.next)>=0)return!1;f=f.prevZ}for(;v&&v.z<=p;){if(v!==e.prev&&v!==e.next&&m(a.x,a.y,n.x,n.y,s.x,s.y,v.x,v.y)&&g(v.prev,v,v.next)>=0)return!1;v=v.nextZ}return!0}function o(e,t,r){var a=e;do{var n=a.prev,s=a.next.next;!v(n,s)&&y(n,a,a.next,s)&&b(n,s)&&b(s,n)&&(t.push(n.i/r),t.push(a.i/r),t.push(s.i/r),T(a),T(a.next),a=e=s),a=a.next}while(a!==e);return i(a)}function l(e,t,r,n,s,o){var l=e;do{for(var d=l.next.next;d!==l.prev;){if(l.i!==d.i&&f(l,d)){var h=I(l,d);return l=i(l,l.next),h=i(h,h.next),a(l,t,r,n,s,o),void a(h,t,r,n,s,o)}d=d.next}l=l.next}while(l!==e)}function d(e,t){return e.x-t.x}function h(e,t){if(t=function(e,t){var i,r=t,a=e.x,n=e.y,s=-1/0;do{if(n<=r.y&&n>=r.next.y&&r.next.y!==r.y){var o=r.x+(n-r.y)*(r.next.x-r.x)/(r.next.y-r.y);if(o<=a&&o>s){if(s=o,o===a){if(n===r.y)return r;if(n===r.next.y)return r.next}i=r.x<r.next.x?r:r.next}}r=r.next}while(r!==t);if(!i)return null;if(a===s)return i;var l,d=i,h=i.x,u=i.y,p=1/0;r=i;do{a>=r.x&&r.x>=h&&a!==r.x&&m(n<u?a:s,n,h,u,n<u?s:a,n,r.x,r.y)&&(l=Math.abs(n-r.y)/(a-r.x),b(r,e)&&(l<p||l===p&&(r.x>i.x||r.x===i.x&&c(i,r)))&&(i=r,p=l)),r=r.next}while(r!==d);return i}(e,t),t){var r=I(t,e);i(t,t.next),i(r,r.next)}}function c(e,t){return g(e.prev,e,t.prev)<0&&g(t.next,e,e.next)<0}function u(e,t,i,r,a){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-i)*a)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-r)*a)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function p(e){var t=e,i=e;do{(t.x<i.x||t.x===i.x&&t.y<i.y)&&(i=t),t=t.next}while(t!==e);return i}function m(e,t,i,r,a,n,s,o){return(a-s)*(t-o)-(e-s)*(n-o)>=0&&(e-s)*(r-o)-(i-s)*(t-o)>=0&&(i-s)*(n-o)-(a-s)*(r-o)>=0}function f(e,t){return e.next.i!==t.i&&e.prev.i!==t.i&&!function(e,t){var i=e;do{if(i.i!==e.i&&i.next.i!==e.i&&i.i!==t.i&&i.next.i!==t.i&&y(i,i.next,e,t))return!0;i=i.next}while(i!==e);return!1}(e,t)&&(b(e,t)&&b(t,e)&&function(e,t){var i=e,r=!1,a=(e.x+t.x)/2,n=(e.y+t.y)/2;do{i.y>n!=i.next.y>n&&i.next.y!==i.y&&a<(i.next.x-i.x)*(n-i.y)/(i.next.y-i.y)+i.x&&(r=!r),i=i.next}while(i!==e);return r}(e,t)&&(g(e.prev,e,t.prev)||g(e,t.prev,t))||v(e,t)&&g(e.prev,e,e.next)>0&&g(t.prev,t,t.next)>0)}function g(e,t,i){return(t.y-e.y)*(i.x-t.x)-(t.x-e.x)*(i.y-t.y)}function v(e,t){return e.x===t.x&&e.y===t.y}function y(e,t,i,r){var a=E(g(e,t,i)),n=E(g(e,t,r)),s=E(g(i,r,e)),o=E(g(i,r,t));return a!==n&&s!==o||(!(0!==a||!M(e,i,t))||(!(0!==n||!M(e,r,t))||(!(0!==s||!M(i,e,r))||!(0!==o||!M(i,t,r)))))}function M(e,t,i){return t.x<=Math.max(e.x,i.x)&&t.x>=Math.min(e.x,i.x)&&t.y<=Math.max(e.y,i.y)&&t.y>=Math.min(e.y,i.y)}function E(e){return e>0?1:e<0?-1:0}function b(e,t){return g(e.prev,e,e.next)<0?g(e,t,e.next)>=0&&g(e,e.prev,t)>=0:g(e,t,e.prev)<0||g(e,e.next,t)<0}function I(e,t){var i=new _(e.i,e.x,e.y),r=new _(t.i,t.x,t.y),a=e.next,n=t.prev;return e.next=t,t.prev=e,i.next=a,a.prev=i,r.next=i,i.prev=r,n.next=r,r.prev=n,r}function x(e,t,i,r){var a=new _(e,t,i);return r?(a.next=r.next,a.prev=r,r.next.prev=a,r.next=a):(a.prev=a,a.next=a),a}function T(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function _(e,t,i){this.i=e,this.x=t,this.y=i,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}function S(e,t,i,r){for(var a=0,n=t,s=i-r;n<i;n+=r)a+=(e[s]-e[n])*(e[n+1]+e[s+1]),s=n;return a}e.deviation=function(e,t,i,r){var a=t&&t.length,n=a?t[0]*i:e.length,s=Math.abs(S(e,0,n,i));if(a)for(var o=0,l=t.length;o<l;o++){var d=t[o]*i,h=o<l-1?t[o+1]*i:e.length;s-=Math.abs(S(e,d,h,i))}var c=0;for(o=0;o<r.length;o+=3){var u=r[o]*i,p=r[o+1]*i,m=r[o+2]*i;c+=Math.abs((e[u]-e[m])*(e[p+1]-e[u+1])-(e[u]-e[p])*(e[m+1]-e[u+1]))}return 0===s&&0===c?0:Math.abs((c-s)/s)},e.flatten=function(e){for(var t=e[0][0].length,i={vertices:[],holes:[],dimensions:t},r=0,a=0;a<e.length;a++){for(var n=0;n<e[a].length;n++)for(var s=0;s<t;s++)i.vertices.push(e[a][n][s]);a>0&&(r+=e[a-1].length,i.holes.push(r))}return i},r.earcut=e}(),r.Math={EPSILON1:.1,EPSILON2:.01,EPSILON3:.001,EPSILON4:1e-4,EPSILON5:1e-5,EPSILON6:1e-6,EPSILON7:1e-7,EPSILON8:1e-8,EPSILON9:1e-9,EPSILON10:1e-10,EPSILON11:1e-11,EPSILON12:1e-12,EPSILON13:1e-13,EPSILON14:1e-14,EPSILON15:1e-15,EPSILON16:1e-16,EPSILON17:1e-17,EPSILON18:1e-18,EPSILON19:1e-19,EPSILON20:1e-20,EPSILON21:1e-21,ONE_Megabytes:1048576,ONE_GIGABYTES:1073741824,TWO_PI:2*Math.PI,PI_OVER_TWO:Math.PI/2,RADIANS_PER_DEGREE:Math.PI/180,RADIANS_PER_ARCSECOND:Math.PI/180/3600,mod:function(e,t){return(e%t+t)%t},clamp:function(e,t,i){return e<t?t:e>i?i:e},normalize:function(e,t,i){return 0===(i=Math.max(i-t,0))?0:r.Math.clamp((e-t)/i,0,1)},isolateDigits:function(e,t,i){return parseInt(e*Math.pow(10,t))*Math.pow(10,i)},equalsEpsilon:function(e,t,i,r){r=void 0!==r?r:i;var a=Math.abs(e-t);return a<=r||a<=i*Math.max(Math.abs(e),Math.abs(t))},lessThan:function(e,t,i){return e-t<-i},lessThanOrEquals:function(e,t,i){return e-t<i},greaterThan:function(e,t,i){return e-t>i},greaterThanOrEquals:function(e,t,i){return e-t>-i},equalsEpsilonVec3:function(e,t,i){return r.Math.equalsEpsilon(e.x,t.x,i)&&r.Math.equalsEpsilon(e.y,t.y,i)&&r.Math.equalsEpsilon(e.z,t.z,i)},equalsEpsilonMatrix4:function(e,t,i){i=i||0;const a=e.elements,n=t.elements;for(let e=0;e<16;e++)if(!r.Math.equalsEpsilon(a[e],n[e],i))return!1;return!0},equalsEpsilonQuaternion:function(e,t,i){return i=i||0,r.Math.equalsEpsilon(e._x,t._x,i)&&r.Math.equalsEpsilon(e._y,t._y,i)&&r.Math.equalsEpsilon(e._z,t._z,i)&&r.Math.equalsEpsilon(e._w,t._w,i)},equalsEpsilonFrustum:function(e,t,i){i=i||0;const a=e.planes,n=t.planes;for(let e=0;e<6;e++)if(!r.Math.equalsEpsilonVec3(a[e].normal,n[e].normal,i)||!r.Math.equalsEpsilon(a[e].constant,n[e].constant,i))return!1;return!0},incrementWrap:function(e,t,i){return i=void 0!==i?i:0,++e>t&&(e=i),e},isPowerOfTwo:function(e){return 0!==e&&0==(e&e-1)},nextPowerOfTwo:function(e){return--e,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,++e},maxComponent:function(e,t){var i=Math.max(Math.abs(e.x),Math.abs(t.x)),r=Math.max(Math.abs(e.y),Math.abs(t.y)),a=Math.max(Math.abs(e.z),Math.abs(t.z));return Math.max(Math.max(i,r),a)},getMatrix3:function(e){var t=e.elements,i=new THREE.Matrix3;return i.elements[0]=t[0],i.elements[1]=t[1],i.elements[2]=t[2],i.elements[3]=t[4],i.elements[4]=t[5],i.elements[5]=t[6],i.elements[6]=t[8],i.elements[7]=t[9],i.elements[8]=t[10],i},bezierCurveFn:function(e,t,i,r){return r>1&&(r=1),(1-r)*(1-r)*e+2*r*(1-r)*t+r*r*i},tweens:function(e,t,i,r){var a=i%r/r;return a<0&&(a*=-1),a>1&&(a=1),this.linear([e,t],a)},breatheTweens:function(e,t,i,r){var a=i%r/(.5*r)-1;return a<0&&(a*=-1),a>1&&(a=1),this.linear([e,t],a)},linear:function(e,t){var i=this,r=e.length-1,a=r*t,n=Math.floor(a);return t<0?i.linearFn(e[0],e[1],a):t>1?i.linearFn(e[r],e[r-1],r-a):i.linearFn(e[n],e[n+1>r?r:n+1],a-n)},linearFn:function(e,t,i){return(t-e)*i+e},negativePiToPi(e){if(!r.Utils.defined(e))throw new Error("angle is required.");return this.zeroToTwoPi(e+Math.PI)-Math.PI},zeroToTwoPi(e){if(!r.Utils.defined(e))throw new Error("angle is required.");var t=this.mod(e,this.TWO_PI);return Math.abs(t)<this.EPSILON14&&Math.abs(e)>this.EPSILON14?TWO_PI:t},equalsEpsilon(e,t,i,a){if(!r.Utils.defined(e))throw new Error("left is required.");if(!r.Utils.defined(t))throw new Error("right is required.");i=r.Utils.defaultValue(i,0),a=r.Utils.defaultValue(a,i);var n=Math.abs(e-t);return n<=a||n<=i*Math.max(Math.abs(e),Math.abs(t))},equalsEpsilonVector3(e,t,i,a){return e===t||r.Utils.defined(e)&&r.Utils.defined(t)&&this.equalsEpsilon(e.x,t.x,i,a)&&this.equalsEpsilon(e.y,t.y,i,a)&&this.equalsEpsilon(e.z,t.z,i,a)},isMirror(e){const t=r.Utils.scratchVector_1,i=r.Utils.scratchVector_2,a=r.Utils.scratchVector_3,n=e.elements,s=t.set(n[0],n[1],n[2]),o=i.set(n[4],n[5],n[6]),l=a.set(n[8],n[9],n[10]);return s.cross(o).dot(l)<0},octDecode(e,t){if(t=r.Utils.isDefined(t)?t:new THREE.Vector3,e.x<r.Math.EPSILON10&&e.y<r.Math.EPSILON10)return t.set(0,0,0),t;let i=e.x/255*2-1,a=e.y/255*2-1;if(t.set(i,a,1-Math.abs(i)-Math.abs(a)),t.z<0){let e=i>=0?1:-1,r=a>=0?1:-1;i=(1-Math.abs(t.y))*e,a=(1-Math.abs(t.x))*r,t.x=i,t.y=a}return t.normalize()}},r.Debug={INFO:"INFO",WARNING:"WARNING",ERROR:"ERROR",EXCEPTION:"EXCEPTION",isActive:!1,DebugColor:{BLACK:0,WHITE:16777215,RED:16711680,GREEN:65280,BLUE:255,YELLOW:16776960,ORANGE:16753920,GRAY:8421504,GOLD:16766720},DebugColorArray:[16776960,16711680,65280,255],activate:function(){r.Debug.isActive=!0},deactivate:function(){r.Debug.isActive=!1},doLog:function(e,t){if(r.Debug.isActive)switch(e){case r.Debug.INFO:console.info(t);break;case r.Debug.WARNING:console.warn(t);break;case r.Debug.ERROR:console.error(t);break;case r.Debug.EXCEPTION:console.debug(t)}},logInfo:function(e){r.Debug.doLog(r.Debug.INFO,e)},logWarning:function(e){r.Debug.doLog(r.Debug.WARNING,e)},logError:function(e){r.Debug.doLog(r.Debug.ERROR,e)},logException:function(e){r.Debug.doLog(r.Debug.EXCEPTION,e)}},r.Runtime=function(){this.config={},this.isReady=!1,this.fps=0,this.states={measurements:[],infos:[]}},r.Runtime.prototype.addMeasurement=function(e,t){this.states.measurements[e]=t},r.Runtime.prototype.removeMeasurement=function(e){this.states.measurements[e]&&delete this.states.measurements[e]},r.Runtime.prototype.addInfo=function(e,t){this.states.infos[e]=t},r.Runtime.prototype.removeInfo=function(e){delete this.states.infos[e]},r.Runtime.prototype.getFPS=function(){return this.fps},function(){function e(e,t){return t-e}r.Event=class{constructor(){this._listeners=[],this._scopes=[],this._toRemove=[],this._insideFireEvent=!1}addEventListener(e,t){this._listeners.push(e),this._scopes.push(t);var i=this;return function(){i.removeEventListener(e,t)}}removeEventListener(e,t){for(var i=this._listeners,r=this._scopes,a=-1,n=0;n<i.length;n++)if(i[n]===e&&r[n]===t){a=n;break}return-1!==a&&(this._insideFireEvent?(this._toRemove.push(a),i[a]=void 0,r[a]=void 0):(i.splice(a,1),r.splice(a,1)),!0)}fireEvent(){var t;this._insideFireEvent=!0;var i=this._listeners,r=this._scopes,a=i.length;for(t=0;t<a;t++){i[t]&&i[t].apply(r[t],arguments)}var n=this._toRemove;if((a=n.length)>0){for(n.sort(e),t=0;t<a;t++){var s=n[t];i.splice(s,1),r.splice(s,1)}n.length=0}this._insideFireEvent=!1}}}(),x=0,r.EVENTS={ERROR:x++,WEBGL_CONTEXT_LOST:x++,WEBGL_CONTEXT_RESTORED:x++,ON_LOAD_START_NO_PROGRESS:x++,ON_LOAD_START:x++,ON_LOAD_PROGRESS:x++,ON_LOAD_COMPLETE:x++,ON_LOAD_EMPTY_SCENE:x++,ON_LOAD_INVALID_SCENE:x++,ON_DEMAND_LOAD_START:x++,ON_DEMAND_LOAD_PROGRESS:x++,ON_DEMAND_LOAD_COMPLETE:x++,ON_TILES_LOAD_INITIAL:x++,ON_TILES_LOAD_PROGRESS:x++,ON_TILES_LOAD_COMPLETE:x++,ON_EDITOR_ENTER:x++,ON_EDITOR_EXIST:x++,ON_EDITOR_BEGIN:x++,ON_EDITOR_END:x++,ON_TOOL_END:x++,ON_EDITOR_UPDATEUI:x++,ON_EDITOR_ZOOM:x++,ON_EDITOR_PANING:x++,ON_EDITOR_ROTATING:x++,ON_EDITOR_WALKING:x++,ON_VOLUME_MEASURE_END:x++,ON_EDITOR_ZOOM_END:x++,ON_SELECTION_CHANGED:x++,ON_CLICK_PICK:x++,ON_CLICK_MARKER3D_PICK:x++,ON_HOVER_PICK:x++,ON_MOUSE_MOVE_PICK:x++,ON_MEASURE_PICK:x++,ON_MEASURE_RESET:x++,ON_SELECTION_FAILED:x++,ON_CLIP_HOVER:x++,ON_HOVER_SNAP:x++,ON_CLIP_MOUSE_MOVE:x++,ON_MOUSE_DRAGGED:x++,ON_CAMERA_CHANGED_AND_RENDERED:x++,ON_CAMERA_CHANGED:x++,ON_VERSION_NO_MATCH:x++,ON_AXIS_GRID_HOVER:x++,ON_VIEWER_RESTORED:x++,ON_EARTH_ANIMATION_COMPLETE:x++,ON_CAMERA_HEIGHT_CHANGED:x++,ON_CAMERA_ANIMATION_UPDATE:x++,ON_FLOOR_EXPLOSION:x++,ON_EXPLOSION:x++,ON_PRE_UPDATE:x++,ON_POST_UPDATE:x++,ON_PRE_RENDER:x++,ON_POST_RENDER:x++,ON_MAP_CREATED:x++,ON_MAP_LOAD_ALL:x++},function(){class e extends THREE.EventDispatcher{constructor(){super()}destroy(){this._listeners=void 0}}r.EventDispatcher=e,r.eventsDispatcher=new r.EventDispatcher}(),function(){var e=0;r.ERRORS={DEVELOPE_EXCEPTION:e++,INVALID_FRAMEBUFFER:e++,WEBGL_NOT_SUPPORTED:e++,WEBGL_CONTEXT_LOST:e++};class t extends Error{constructor(e,t){super(),this.name=this._getName(e),this.message=t||"N/A",this.stack=(new Error).stack}_getName(e){for(const t in r.ERRORS)if(r.ERRORS[t]===e)return t;return null}toString(){let e=this.name+": "+this.message;return this.stack&&(e+="\n"+this.stack.toString()),e}static throwError(e,i){throw new t(e,i)}}r.Error=t}(),function(){class e{constructor(e,t){this.canvasId=e||0,this.domContainer=t;var i=document.createElement("div");this.domContainer.appendChild(i),this.canvas=this._createHTMLCanvas(i)}destroy(){var e=this.canvas.parentNode;e&&(e.removeChild(this.canvas),this.domContainer.removeChild(e),e=null),this.canvas=null,this.domContainer=null}addEventListener(e,t,i){this.canvas.addEventListener(e,t,i)}removeEventListener(e,t,i){this.canvas.removeEventListener(e,t,i)}_createHTMLCanvas(e){var t=document.createElement("canvas");return t.setAttribute("id","cloud-canvas-"+this.canvasId),t.setAttribute("class","cloud-main-canvas"),t.setAttribute("tabindex","0"),e.appendChild(t),t}initWebGL(){for(var t=e.WEBGL_CONTEXT_NAMES,i=0;!this.gl&&i<t.length;i++)try{this.gl=this.canvas.getContext(t[i],this.contextAttr)}catch(e){}if(!this.gl)throw r.Error.fatalError(r.ErrorTypes.WEBGL_NOT_SUPPORTED,"Failed to get a WebGL context")}loseWebGLContext(){this.canvas.loseContext()}getWidth(){return this.canvas.width}getHeight(){return this.canvas.height}}e.WEBGL_CONTEXT_NAMES=["webgl","experimental-webgl","webkit-3d","moz-webgl","moz-glweb20"],r.Canvas=e}(),function(){function e(){this.head=void 0,this.tail=void 0,this._length=0}function t(e,t,i){this.item=e,this.previous=t,this.next=i}function i(e,t){t.previous&&t.next?(t.previous.next=t.next,t.next.previous=t.previous):t.previous?(t.previous.next=void 0,e.tail=t.previous):t.next?(t.next.previous=void 0,e.head=t.next):(e.head=void 0,e.tail=void 0),t.next=void 0,t.previous=void 0}Object.defineProperties(e.prototype,{length:{get:function(){return this._length}}}),e.prototype.add=function(e){var i=new t(e,this.tail,void 0);return this.tail?(this.tail.next=i,this.tail=i):(this.head=i,this.tail=i),++this._length,i},e.prototype.remove=function(e){e&&(i(this,e),--this._length)},e.prototype.splice=function(e,t){if(e!==t){i(this,t);var r=e.next;e.next=t,this.tail===e?this.tail=t:r.previous=t,t.next=r,t.previous=e}},r.DoublyLinkedList=e}(),function(){function e(e,t,i){var r=e[t];e[t]=e[i],e[i]=r}r.Heap=class{constructor(e){this._comparator=e.comparator,this._array=[],this._length=0,this._maximumLength=void 0}destroy(){this._comparator=void 0,this._array=void 0}get length(){return this._length}get internalArray(){return this._array}get maximumLength(){return this._maximumLength}set maximumLength(e){var t=this._length;if(e<t){for(var i=this._array,r=e;r<t;++r)i[r]=void 0;this._length=e,i.length=e}this._maximumLength=e}get comparator(){return this._comparator}reserve(e){e=e||this._length,this._array.length=e}heapify(t){t=t||0;for(var i=this._length,r=this._comparator,a=this._array,n=-1,s=!0;s;){var o=2*(t+1),l=o-1;n=l<i&&r(a[l],a[t])<0?l:t,o<i&&r(a[o],a[n])<0&&(n=o),n!==t?(e(a,n,t),t=n):s=!1}}resort(){for(var e=this._length,t=Math.ceil(e/2);t>=0;--t)this.heapify(t)}insert(t){var i,r=this._array,a=this._comparator,n=this._maximumLength,s=this._length++;for(s<r.length?r[s]=t:r.push(t);0!==s;){var o=Math.floor((s-1)/2);if(!(a(r[s],r[o])<0))break;e(r,s,o),s=o}return null!=n&&this._length>n&&(i=r[n],this._length=n),i}pop(t){if(t=t||0,0!==this._length){var i=this._array,r=i[t];return e(i,t,--this._length),this.heapify(t),i[this._length]=void 0,r}}}}(),r.Deferred=class{constructor(){var e,t,i=new Promise((function(i,r){e=function(e){i(e)},t=function(e){r(e)}}));this.promise=i,this.resolve=e,this.reject=t,this.resolver={resolve:e,reject:t}}destroy(){this.resolver=void 0,this.resolve=void 0,this.reject=void 0,this.promise=void 0}},r.TaskRunner=class{constructor(e){this.limit=e||5,this.store=[],this.active=0}next(){this.store.length&&this.runTask(...this.store.shift())}runTask(e,t,i){this.active++;var r=this;e.call(t.that,t,(function(e){r.active--,i&&i(e),r.next()}))}push(e,t,i){this.active<this.limit?this.runTask(e,t,i):this.store.push([e,t,i])}},r.LoadTaskRunner=class{constructor(e){this.limit=e||5,this.store=[],this.active=0}next(){this.store.length&&this.runTask(...this.store.shift())}runTask(e,t,i,r){this.active++;var a=this;e.load(t,(function(e){a.active--,r&&r({context:e,paras:i}),a.next()}))}push(e,t,i,r){this.active<this.limit?this.runTask(e,t,i,r):this.store.push([e,t,i,r])}},THREE.Face3=class{constructor(e,t,i,r,a,n=0){this.a=e,this.b=t,this.c=i,this.normal=r&&r.isVector3?r:new THREE.Vector3,this.vertexNormals=Array.isArray(r)?r:[],this.color=a&&a.isColor?a:new THREE.Color,this.vertexColors=Array.isArray(a)?a:[],this.materialIndex=n}clone(){return(new this.constructor).copy(this)}copy(e){this.a=e.a,this.b=e.b,this.c=e.c,this.normal.copy(e.normal),this.color.copy(e.color),this.materialIndex=e.materialIndex;for(let t=0,i=e.vertexNormals.length;t<i;t++)this.vertexNormals[t]=e.vertexNormals[t].clone();for(let t=0,i=e.vertexColors.length;t<i;t++)this.vertexColors[t]=e.vertexColors[t].clone();return this}},(()=>{const e=new THREE.Matrix4,t=new THREE.Object3D,i=new THREE.Vector3;function r(){this.uuid=THREE.MathUtils.generateUUID(),this.name="",this.type="Geometry",this.vertices=[],this.colors=[],this.faces=[],this.faceVertexUvs=[[]],this.morphTargets=[],this.morphNormals=[],this.skinWeights=[],this.skinIndices=[],this.lineDistances=[],this.boundingBox=null,this.boundingSphere=null,this.elementsNeedUpdate=!1,this.verticesNeedUpdate=!1,this.uvsNeedUpdate=!1,this.normalsNeedUpdate=!1,this.colorsNeedUpdate=!1,this.lineDistancesNeedUpdate=!1,this.groupsNeedUpdate=!1}r.prototype=Object.assign(Object.create(THREE.EventDispatcher.prototype),{constructor:r,isGeometry:!0,applyMatrix4:function(e){const t=(new THREE.Matrix3).getNormalMatrix(e);for(let t=0,i=this.vertices.length;t<i;t++){this.vertices[t].applyMatrix4(e)}for(let e=0,i=this.faces.length;e<i;e++){const i=this.faces[e];i.normal.applyMatrix3(t).normalize();for(let e=0,r=i.vertexNormals.length;e<r;e++)i.vertexNormals[e].applyMatrix3(t).normalize()}return null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this.verticesNeedUpdate=!0,this.normalsNeedUpdate=!0,this},rotateX:function(t){return e.makeRotationX(t),this.applyMatrix4(e),this},rotateY:function(t){return e.makeRotationY(t),this.applyMatrix4(e),this},rotateZ:function(t){return e.makeRotationZ(t),this.applyMatrix4(e),this},translate:function(t,i,r){return e.makeTranslation(t,i,r),this.applyMatrix4(e),this},scale:function(t,i,r){return e.makeScale(t,i,r),this.applyMatrix4(e),this},lookAt:function(e){return t.lookAt(e),t.updateMatrix(),this.applyMatrix4(t.matrix),this},fromBufferGeometry:function(e){const t=this,i=null!==e.index?e.index:void 0,r=e.attributes;if(void 0===r.position)return console.error("THREE.Geometry.fromBufferGeometry(): Position attribute required for conversion."),this;const a=r.position,n=r.normal,s=r.color,o=r.uv,l=r.uv2;void 0!==l&&(this.faceVertexUvs[1]=[]);for(let e=0;e<a.count;e++)t.vertices.push((new THREE.Vector3).fromBufferAttribute(a,e)),void 0!==s&&t.colors.push((new THREE.Color).fromBufferAttribute(s,e));function d(e,i,r,a){const d=void 0===s?[]:[t.colors[e].clone(),t.colors[i].clone(),t.colors[r].clone()],h=void 0===n?[]:[(new THREE.Vector3).fromBufferAttribute(n,e),(new THREE.Vector3).fromBufferAttribute(n,i),(new THREE.Vector3).fromBufferAttribute(n,r)],c=new THREE.Face3(e,i,r,h,d,a);t.faces.push(c),void 0!==o&&t.faceVertexUvs[0].push([(new THREE.Vector2).fromBufferAttribute(o,e),(new THREE.Vector2).fromBufferAttribute(o,i),(new THREE.Vector2).fromBufferAttribute(o,r)]),void 0!==l&&t.faceVertexUvs[1].push([(new THREE.Vector2).fromBufferAttribute(l,e),(new THREE.Vector2).fromBufferAttribute(l,i),(new THREE.Vector2).fromBufferAttribute(l,r)])}const h=e.groups;if(h.length>0)for(let e=0;e<h.length;e++){const t=h[e],r=t.start;for(let e=r,a=r+t.count;e<a;e+=3)void 0!==i?d(i.getX(e),i.getX(e+1),i.getX(e+2),t.materialIndex):d(e,e+1,e+2,t.materialIndex)}else if(void 0!==i)for(let e=0;e<i.count;e+=3)d(i.getX(e),i.getX(e+1),i.getX(e+2));else for(let e=0;e<a.count;e+=3)d(e,e+1,e+2);return this.computeFaceNormals(),null!==e.boundingBox&&(this.boundingBox=e.boundingBox.clone()),null!==e.boundingSphere&&(this.boundingSphere=e.boundingSphere.clone()),this},center:function(){return this.computeBoundingBox(),this.boundingBox.getCenter(i).negate(),this.translate(i.x,i.y,i.z),this},normalize:function(){this.computeBoundingSphere();const e=this.boundingSphere.center,t=this.boundingSphere.radius,i=0===t?1:1/t,r=new THREE.Matrix4;return r.set(i,0,0,-i*e.x,0,i,0,-i*e.y,0,0,i,-i*e.z,0,0,0,1),this.applyMatrix4(r),this},computeFaceNormals:function(){const e=new THREE.Vector3,t=new THREE.Vector3;for(let i=0,r=this.faces.length;i<r;i++){const r=this.faces[i],a=this.vertices[r.a],n=this.vertices[r.b],s=this.vertices[r.c];e.subVectors(s,n),t.subVectors(a,n),e.cross(t),e.normalize(),r.normal.copy(e)}},computeVertexNormals:function(e=!0){const t=new Array(this.vertices.length);for(let e=0,i=this.vertices.length;e<i;e++)t[e]=new THREE.Vector3;if(e){const e=new THREE.Vector3,i=new THREE.Vector3;for(let r=0,a=this.faces.length;r<a;r++){const a=this.faces[r],n=this.vertices[a.a],s=this.vertices[a.b],o=this.vertices[a.c];e.subVectors(o,s),i.subVectors(n,s),e.cross(i),t[a.a].add(e),t[a.b].add(e),t[a.c].add(e)}}else{this.computeFaceNormals();for(let e=0,i=this.faces.length;e<i;e++){const i=this.faces[e];t[i.a].add(i.normal),t[i.b].add(i.normal),t[i.c].add(i.normal)}}for(let e=0,i=this.vertices.length;e<i;e++)t[e].normalize();for(let e=0,i=this.faces.length;e<i;e++){const i=this.faces[e],r=i.vertexNormals;3===r.length?(r[0].copy(t[i.a]),r[1].copy(t[i.b]),r[2].copy(t[i.c])):(r[0]=t[i.a].clone(),r[1]=t[i.b].clone(),r[2]=t[i.c].clone())}this.faces.length>0&&(this.normalsNeedUpdate=!0)},computeFlatVertexNormals:function(){this.computeFaceNormals();for(let e=0,t=this.faces.length;e<t;e++){const t=this.faces[e],i=t.vertexNormals;3===i.length?(i[0].copy(t.normal),i[1].copy(t.normal),i[2].copy(t.normal)):(i[0]=t.normal.clone(),i[1]=t.normal.clone(),i[2]=t.normal.clone())}this.faces.length>0&&(this.normalsNeedUpdate=!0)},computeMorphNormals:function(){for(let e=0,t=this.faces.length;e<t;e++){const t=this.faces[e];t.__originalFaceNormal?t.__originalFaceNormal.copy(t.normal):t.__originalFaceNormal=t.normal.clone(),t.__originalVertexNormals||(t.__originalVertexNormals=[]);for(let e=0,i=t.vertexNormals.length;e<i;e++)t.__originalVertexNormals[e]?t.__originalVertexNormals[e].copy(t.vertexNormals[e]):t.__originalVertexNormals[e]=t.vertexNormals[e].clone()}const e=new r;e.faces=this.faces;for(let t=0,i=this.morphTargets.length;t<i;t++){if(!this.morphNormals[t]){this.morphNormals[t]={},this.morphNormals[t].faceNormals=[],this.morphNormals[t].vertexNormals=[];const e=this.morphNormals[t].faceNormals,i=this.morphNormals[t].vertexNormals;for(let t=0,r=this.faces.length;t<r;t++){const t=new THREE.Vector3,r={a:new THREE.Vector3,b:new THREE.Vector3,c:new THREE.Vector3};e.push(t),i.push(r)}}const i=this.morphNormals[t];e.vertices=this.morphTargets[t].vertices,e.computeFaceNormals(),e.computeVertexNormals();for(let e=0,t=this.faces.length;e<t;e++){const t=this.faces[e],r=i.faceNormals[e],a=i.vertexNormals[e];r.copy(t.normal),a.a.copy(t.vertexNormals[0]),a.b.copy(t.vertexNormals[1]),a.c.copy(t.vertexNormals[2])}}for(let e=0,t=this.faces.length;e<t;e++){const t=this.faces[e];t.normal=t.__originalFaceNormal,t.vertexNormals=t.__originalVertexNormals}},computeBoundingBox:function(){null===this.boundingBox&&(this.boundingBox=new THREE.Box3),this.boundingBox.setFromPoints(this.vertices)},computeBoundingSphere:function(){null===this.boundingSphere&&(this.boundingSphere=new THREE.Sphere),this.boundingSphere.setFromPoints(this.vertices)},merge:function(e,t,i=0){if(!e||!e.isGeometry)return void console.error("THREE.Geometry.merge(): geometry not an instance of THREE.Geometry.",e);let r;const a=this.vertices.length,n=this.vertices,s=e.vertices,o=this.faces,l=e.faces,d=this.colors,h=e.colors;void 0!==t&&(r=(new THREE.Matrix3).getNormalMatrix(t));for(let e=0,i=s.length;e<i;e++){const i=s[e].clone();void 0!==t&&i.applyMatrix4(t),n.push(i)}for(let e=0,t=h.length;e<t;e++)d.push(h[e].clone());for(let e=0,t=l.length;e<t;e++){const t=l[e];let n,s;const d=t.vertexNormals,h=t.vertexColors,c=new THREE.Face3(t.a+a,t.b+a,t.c+a);c.normal.copy(t.normal),void 0!==r&&c.normal.applyMatrix3(r).normalize();for(let e=0,t=d.length;e<t;e++)n=d[e].clone(),void 0!==r&&n.applyMatrix3(r).normalize(),c.vertexNormals.push(n);c.color.copy(t.color);for(let e=0,t=h.length;e<t;e++)s=h[e],c.vertexColors.push(s.clone());c.materialIndex=t.materialIndex+i,o.push(c)}for(let t=0,i=e.faceVertexUvs.length;t<i;t++){const i=e.faceVertexUvs[t];void 0===this.faceVertexUvs[t]&&(this.faceVertexUvs[t]=[]);for(let e=0,r=i.length;e<r;e++){const r=i[e],a=[];for(let e=0,t=r.length;e<t;e++)a.push(r[e].clone());this.faceVertexUvs[t].push(a)}}},mergeMesh:function(e){e&&e.isMesh?(e.matrixAutoUpdate&&e.updateMatrix(),this.merge(e.geometry,e.matrix)):console.error("THREE.Geometry.mergeMesh(): mesh not an instance of THREE.Mesh.",e)},mergeVertices:function(e=4){const t={},i=[],r=[],a=Math.pow(10,e);for(let e=0,n=this.vertices.length;e<n;e++){const n=this.vertices[e],s=Math.round(n.x*a)+"_"+Math.round(n.y*a)+"_"+Math.round(n.z*a);void 0===t[s]?(t[s]=e,i.push(this.vertices[e]),r[e]=i.length-1):r[e]=r[t[s]]}const n=[];for(let e=0,t=this.faces.length;e<t;e++){const t=this.faces[e];t.a=r[t.a],t.b=r[t.b],t.c=r[t.c];const i=[t.a,t.b,t.c];for(let t=0;t<3;t++)if(i[t]===i[(t+1)%3]){n.push(e);break}}for(let e=n.length-1;e>=0;e--){const t=n[e];this.faces.splice(t,1);for(let e=0,i=this.faceVertexUvs.length;e<i;e++)this.faceVertexUvs[e].splice(t,1)}const s=this.vertices.length-i.length;return this.vertices=i,s},setFromPoints:function(e){this.vertices=[];for(let t=0,i=e.length;t<i;t++){const i=e[t];this.vertices.push(new THREE.Vector3(i.x,i.y,i.z||0))}return this},sortFacesByMaterialIndex:function(){const e=this.faces,t=e.length;for(let i=0;i<t;i++)e[i]._id=i;e.sort((function(e,t){return e.materialIndex-t.materialIndex}));const i=this.faceVertexUvs[0],r=this.faceVertexUvs[1];let a,n;i&&i.length===t&&(a=[]),r&&r.length===t&&(n=[]);for(let s=0;s<t;s++){const t=e[s]._id;a&&a.push(i[t]),n&&n.push(r[t])}a&&(this.faceVertexUvs[0]=a),n&&(this.faceVertexUvs[1]=n)},toJSON:function(){const e={metadata:{version:4.5,type:"Geometry",generator:"Geometry.toJSON"}};if(e.uuid=this.uuid,e.type=this.type,""!==this.name&&(e.name=this.name),void 0!==this.parameters){const t=this.parameters;for(const i in t)void 0!==t[i]&&(e[i]=t[i]);return e}const t=[];for(let e=0;e<this.vertices.length;e++){const i=this.vertices[e];t.push(i.x,i.y,i.z)}const i=[],r=[],a={},n=[],s={},o=[],l={};for(let e=0;e<this.faces.length;e++){const t=this.faces[e],r=!0,a=!1,n=void 0!==this.faceVertexUvs[0][e],s=t.normal.length()>0,o=t.vertexNormals.length>0,l=1!==t.color.r||1!==t.color.g||1!==t.color.b,p=t.vertexColors.length>0;let m=0;if(m=d(m,0,0),m=d(m,1,r),m=d(m,2,a),m=d(m,3,n),m=d(m,4,s),m=d(m,5,o),m=d(m,6,l),m=d(m,7,p),i.push(m),i.push(t.a,t.b,t.c),i.push(t.materialIndex),n){const t=this.faceVertexUvs[0][e];i.push(u(t[0]),u(t[1]),u(t[2]))}if(s&&i.push(h(t.normal)),o){const e=t.vertexNormals;i.push(h(e[0]),h(e[1]),h(e[2]))}if(l&&i.push(c(t.color)),p){const e=t.vertexColors;i.push(c(e[0]),c(e[1]),c(e[2]))}}function d(e,t,i){return i?e|1<<t:e&~(1<<t)}function h(e){const t=e.x.toString()+e.y.toString()+e.z.toString();return void 0!==a[t]||(a[t]=r.length/3,r.push(e.x,e.y,e.z)),a[t]}function c(e){const t=e.r.toString()+e.g.toString()+e.b.toString();return void 0!==s[t]||(s[t]=n.length,n.push(e.getHex())),s[t]}function u(e){const t=e.x.toString()+e.y.toString();return void 0!==l[t]||(l[t]=o.length/2,o.push(e.x,e.y)),l[t]}return e.data={},e.data.vertices=t,e.data.normals=r,n.length>0&&(e.data.colors=n),o.length>0&&(e.data.uvs=[o]),e.data.faces=i,e},clone:function(){return(new r).copy(this)},copy:function(e){this.vertices=[],this.colors=[],this.faces=[],this.faceVertexUvs=[[]],this.morphTargets=[],this.morphNormals=[],this.skinWeights=[],this.skinIndices=[],this.lineDistances=[],this.boundingBox=null,this.boundingSphere=null,this.name=e.name;const t=e.vertices;for(let e=0,i=t.length;e<i;e++)this.vertices.push(t[e].clone());const i=e.colors;for(let e=0,t=i.length;e<t;e++)this.colors.push(i[e].clone());const r=e.faces;for(let e=0,t=r.length;e<t;e++)this.faces.push(r[e].clone());for(let t=0,i=e.faceVertexUvs.length;t<i;t++){const i=e.faceVertexUvs[t];void 0===this.faceVertexUvs[t]&&(this.faceVertexUvs[t]=[]);for(let e=0,r=i.length;e<r;e++){const r=i[e],a=[];for(let e=0,t=r.length;e<t;e++){const t=r[e];a.push(t.clone())}this.faceVertexUvs[t].push(a)}}const a=e.morphTargets;for(let e=0,t=a.length;e<t;e++){const t={};if(t.name=a[e].name,void 0!==a[e].vertices){t.vertices=[];for(let i=0,r=a[e].vertices.length;i<r;i++)t.vertices.push(a[e].vertices[i].clone())}if(void 0!==a[e].normals){t.normals=[];for(let i=0,r=a[e].normals.length;i<r;i++)t.normals.push(a[e].normals[i].clone())}this.morphTargets.push(t)}const n=e.morphNormals;for(let e=0,t=n.length;e<t;e++){const t={};if(void 0!==n[e].vertexNormals){t.vertexNormals=[];for(let i=0,r=n[e].vertexNormals.length;i<r;i++){const r=n[e].vertexNormals[i],a={};a.a=r.a.clone(),a.b=r.b.clone(),a.c=r.c.clone(),t.vertexNormals.push(a)}}if(void 0!==n[e].faceNormals){t.faceNormals=[];for(let i=0,r=n[e].faceNormals.length;i<r;i++)t.faceNormals.push(n[e].faceNormals[i].clone())}this.morphNormals.push(t)}const s=e.skinWeights;for(let e=0,t=s.length;e<t;e++)this.skinWeights.push(s[e].clone());const o=e.skinIndices;for(let e=0,t=o.length;e<t;e++)this.skinIndices.push(o[e].clone());const l=e.lineDistances;for(let e=0,t=l.length;e<t;e++)this.lineDistances.push(l[e]);const d=e.boundingBox;null!==d&&(this.boundingBox=d.clone());const h=e.boundingSphere;return null!==h&&(this.boundingSphere=h.clone()),this.elementsNeedUpdate=e.elementsNeedUpdate,this.verticesNeedUpdate=e.verticesNeedUpdate,this.uvsNeedUpdate=e.uvsNeedUpdate,this.normalsNeedUpdate=e.normalsNeedUpdate,this.colorsNeedUpdate=e.colorsNeedUpdate,this.lineDistancesNeedUpdate=e.lineDistancesNeedUpdate,this.groupsNeedUpdate=e.groupsNeedUpdate,this},toBufferGeometry:function(){const e=(new a).fromGeometry(this),t=new THREE.BufferGeometry,i=new Float32Array(3*e.vertices.length);if(t.setAttribute("position",new THREE.BufferAttribute(i,3).copyVector3sArray(e.vertices)),e.normals.length>0){const i=new Float32Array(3*e.normals.length);t.setAttribute("normal",new THREE.BufferAttribute(i,3).copyVector3sArray(e.normals))}if(e.colors.length>0){const i=new Float32Array(3*e.colors.length);t.setAttribute("color",new THREE.BufferAttribute(i,3).copyColorsArray(e.colors))}if(e.uvs.length>0){const i=new Float32Array(2*e.uvs.length);t.setAttribute("uv",new THREE.BufferAttribute(i,2).copyVector2sArray(e.uvs))}if(e.uvs2.length>0){const i=new Float32Array(2*e.uvs2.length);t.setAttribute("uv2",new THREE.BufferAttribute(i,2).copyVector2sArray(e.uvs2))}t.groups=e.groups;for(const i in e.morphTargets){const r=[],a=e.morphTargets[i];for(let e=0,t=a.length;e<t;e++){const t=a[e],i=new THREE.Float32BufferAttribute(3*t.data.length,3);i.name=t.name,r.push(i.copyVector3sArray(t.data))}t.morphAttributes[i]=r}if(e.skinIndices.length>0){const i=new THREE.Float32BufferAttribute(4*e.skinIndices.length,4);t.setAttribute("skinIndex",i.copyVector4sArray(e.skinIndices))}if(e.skinWeights.length>0){const i=new THREE.Float32BufferAttribute(4*e.skinWeights.length,4);t.setAttribute("skinWeight",i.copyVector4sArray(e.skinWeights))}return null!==e.boundingSphere&&(t.boundingSphere=e.boundingSphere.clone()),null!==e.boundingBox&&(t.boundingBox=e.boundingBox.clone()),t},computeTangents:function(){console.error("THREE.Geometry: .computeTangents() has been removed.")},computeLineDistances:function(){console.error("THREE.Geometry: .computeLineDistances() has been removed. Use THREE.Line.computeLineDistances() instead.")},applyMatrix:function(e){return console.warn("THREE.Geometry: .applyMatrix() has been renamed to .applyMatrix4()."),this.applyMatrix4(e)},dispose:function(){this.dispatchEvent({type:"dispose"})}}),r.createBufferGeometryFromObject=function(e){let t=new THREE.BufferGeometry;const i=e.geometry;if(e.isPoints||e.isLine){const e=new THREE.Float32BufferAttribute(3*i.vertices.length,3),r=new THREE.Float32BufferAttribute(3*i.colors.length,3);if(t.setAttribute("position",e.copyVector3sArray(i.vertices)),t.setAttribute("color",r.copyColorsArray(i.colors)),i.lineDistances&&i.lineDistances.length===i.vertices.length){const e=new THREE.Float32BufferAttribute(i.lineDistances.length,1);t.setAttribute("lineDistance",e.copyArray(i.lineDistances))}null!==i.boundingSphere&&(t.boundingSphere=i.boundingSphere.clone()),null!==i.boundingBox&&(t.boundingBox=i.boundingBox.clone())}else e.isMesh&&(t=i.toBufferGeometry());return t};class a{constructor(){this.vertices=[],this.normals=[],this.colors=[],this.uvs=[],this.uvs2=[],this.groups=[],this.morphTargets={},this.skinWeights=[],this.skinIndices=[],this.boundingBox=null,this.boundingSphere=null,this.verticesNeedUpdate=!1,this.normalsNeedUpdate=!1,this.colorsNeedUpdate=!1,this.uvsNeedUpdate=!1,this.groupsNeedUpdate=!1}computeGroups(e){const t=[];let i,r,a;const n=e.faces;for(r=0;r<n.length;r++){const e=n[r];e.materialIndex!==a&&(a=e.materialIndex,void 0!==i&&(i.count=3*r-i.start,t.push(i)),i={start:3*r,materialIndex:a})}void 0!==i&&(i.count=3*r-i.start,t.push(i)),this.groups=t}fromGeometry(e){const t=e.faces,i=e.vertices,r=e.faceVertexUvs,a=r[0]&&r[0].length>0,n=r[1]&&r[1].length>0,s=e.morphTargets,o=s.length;let l;if(o>0){l=[];for(let e=0;e<o;e++)l[e]={name:s[e].name,data:[]};this.morphTargets.position=l}const d=e.morphNormals,h=d.length;let c;if(h>0){c=[];for(let e=0;e<h;e++)c[e]={name:d[e].name,data:[]};this.morphTargets.normal=c}const u=e.skinIndices,p=e.skinWeights,m=u.length===i.length,f=p.length===i.length;i.length>0&&0===t.length&&console.error("THREE.DirectGeometry: Faceless geometries are not supported.");for(let e=0;e<t.length;e++){const g=t[e];this.vertices.push(i[g.a],i[g.b],i[g.c]);const v=g.vertexNormals;if(3===v.length)this.normals.push(v[0],v[1],v[2]);else{const e=g.normal;this.normals.push(e,e,e)}const y=g.vertexColors;if(3===y.length)this.colors.push(y[0],y[1],y[2]);else{const e=g.color;this.colors.push(e,e,e)}if(!0===a){const t=r[0][e];void 0!==t?this.uvs.push(t[0],t[1],t[2]):(console.warn("THREE.DirectGeometry.fromGeometry(): Undefined vertexUv ",e),this.uvs.push(new THREE.Vector2,new THREE.Vector2,new THREE.Vector2))}if(!0===n){const t=r[1][e];void 0!==t?this.uvs2.push(t[0],t[1],t[2]):(console.warn("THREE.DirectGeometry.fromGeometry(): Undefined vertexUv2 ",e),this.uvs2.push(new THREE.Vector2,new THREE.Vector2,new THREE.Vector2))}for(let e=0;e<o;e++){const t=s[e].vertices;l[e].data.push(t[g.a],t[g.b],t[g.c])}for(let t=0;t<h;t++){const i=d[t].vertexNormals[e];c[t].data.push(i.a,i.b,i.c)}m&&this.skinIndices.push(u[g.a],u[g.b],u[g.c]),f&&this.skinWeights.push(p[g.a],p[g.b],p[g.c])}return this.computeGroups(e),this.verticesNeedUpdate=e.verticesNeedUpdate,this.normalsNeedUpdate=e.normalsNeedUpdate,this.colorsNeedUpdate=e.colorsNeedUpdate,this.uvsNeedUpdate=e.uvsNeedUpdate,this.groupsNeedUpdate=e.groupsNeedUpdate,null!==e.boundingSphere&&(this.boundingSphere=e.boundingSphere.clone()),null!==e.boundingBox&&(this.boundingBox=e.boundingBox.clone()),this}}THREE.Geometry=r})(),(()=>{var e=new THREE.Box3,t=new THREE.Matrix4,i=new THREE.Ray,a=new THREE.Sphere;class n extends THREE.LineSegments{constructor(e,t){super(e,t),this.type="LineSegmentsEx"}init(e){}destroy(){}intersectBoxWithDistance(t,i){var r=this.geometry,a=this.matrixWorld;return i&&(a=this.matrixWorld.clone()).multiplyMatrices(this.matrixWorld,i),r.boundingBox||r.computeBoundingBox(),e.copy(r.boundingBox),e.applyMatrix4(a),t.ray.intersectBoxWithDistance(e)}intersectBoxWithDistanceByIndices(e,t){var i=this.geometry.attributes.position.array,a=0,n=i.length;t&&t.indexCount>0&&(a=t.positionStart,n=t.positionStart+t.positionCount);var s=r.Utils.box3FromArrayRange(i,a,n);return s.applyMatrix4(this.matrixWorld),e.ray.intersectBoxWithDistance(s)}raycastByIndices(e,n,s,o,l){var d=e.linePrecision;e.linePrecision=void 0===l?r.GlobalData.LineSelectRange:r.GlobalData.LineSelectRange*l;var h,c=e.linePrecision,u=c*c;o?(h=this.matrixWorld.clone()).multiplyMatrices(this.matrixWorld,o):h=this.matrixWorld;var p=this.geometry;if(null===p.boundingSphere&&p.computeBoundingSphere(),a.copy(p.boundingSphere),a.applyMatrix4(h),!1!==e.ray.intersectsSphere(a)){t.copy(h).invert(),i.copy(e.ray).applyMatrix4(t);var m=new THREE.Vector3,f=new THREE.Vector3,g=new THREE.Vector3,v=new THREE.Vector3,y=p.attributes.position.array,M=p.index.array,E=0,b=M.length;s&&s.indexCount>0&&(E=s.indexStart,b=s.indexStart+s.indexCount);for(var I=E;I<b-1;I+=2){var x=M[I],T=M[I+1];if(m.fromArray(y,3*x),f.fromArray(y,3*T),!(i.distanceSqToSegment(m,f,v,g)>u)){v.applyMatrix4(h);var _=e.ray.origin.distanceTo(v);_<e.near||_>e.far||n.push({distance:_,point:g.clone().applyMatrix4(h),index:I,face:null,faceIndex:null,object:this})}}e.linePrecision=d}}}r.LineSegmentsEx=n})(),function(){const e=new THREE.Box3,t=new THREE.Vector3;class i extends THREE.InstancedBufferGeometry{constructor(){super(),this.isLineSegmentsGeometry=!0,this.type="LineSegmentsGeometry";this.setIndex([0,2,1,2,3,1,2,4,3,4,5,3,4,6,5,6,7,5]),this.setAttribute("position",new THREE.Float32BufferAttribute([-1,2,0,1,2,0,-1,1,0,1,1,0,-1,0,0,1,0,0,-1,-1,0,1,-1,0],3)),this.setAttribute("uv",new THREE.Float32BufferAttribute([-1,2,1,2,-1,1,1,1,-1,-1,1,-1,-1,-2,1,-2],2))}applyMatrix4(e){const t=this.attributes.instanceStart,i=this.attributes.instanceEnd;return void 0!==t&&(t.applyMatrix4(e),i.applyMatrix4(e),t.needsUpdate=!0),null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this}setPositions(e){let t;e instanceof Float32Array?t=e:Array.isArray(e)&&(t=new Float32Array(e));const i=new THREE.InstancedInterleavedBuffer(t,6,1);return this.setAttribute("instanceStart",new THREE.InterleavedBufferAttribute(i,3,0)),this.setAttribute("instanceEnd",new THREE.InterleavedBufferAttribute(i,3,3)),this.computeBoundingBox(),this.computeBoundingSphere(),this}setColors(e){let t;e instanceof Float32Array?t=e:Array.isArray(e)&&(t=new Float32Array(e));const i=new THREE.InstancedInterleavedBuffer(t,6,1);return this.setAttribute("instanceColorStart",new THREE.InterleavedBufferAttribute(i,3,0)),this.setAttribute("instanceColorEnd",new THREE.InterleavedBufferAttribute(i,3,3)),this}fromWireframeGeometry(e){return this.setPositions(e.attributes.position.array),this}fromEdgesGeometry(e){return this.setPositions(e.attributes.position.array),this}fromMesh(e){return this.fromWireframeGeometry(new THREE.WireframeGeometry(e.geometry)),this}fromLineSegments(e){const t=e.geometry;return this.setPositions(t.attributes.position.array),this}computeBoundingBox(){null===this.boundingBox&&(this.boundingBox=new THREE.Box3);const t=this.attributes.instanceStart,i=this.attributes.instanceEnd;void 0!==t&&void 0!==i&&(this.boundingBox.setFromBufferAttribute(t),e.setFromBufferAttribute(i),this.boundingBox.union(e))}computeBoundingSphere(){null===this.boundingSphere&&(this.boundingSphere=new THREE.Sphere),null===this.boundingBox&&this.computeBoundingBox();const e=this.attributes.instanceStart,i=this.attributes.instanceEnd;if(void 0!==e&&void 0!==i){const r=this.boundingSphere.center;this.boundingBox.getCenter(r);let a=0;for(let n=0,s=e.count;n<s;n++)t.fromBufferAttribute(e,n),a=Math.max(a,r.distanceToSquared(t)),t.fromBufferAttribute(i,n),a=Math.max(a,r.distanceToSquared(t));this.boundingSphere.radius=Math.sqrt(a),isNaN(this.boundingSphere.radius)&&console.error("THREE.LineSegmentsGeometry.computeBoundingSphere(): Computed radius is NaN. The instanced position data is likely to have NaN values.",this)}}toJSON(){}clone(){}copy(e){return this}applyMatrix(e){return console.warn("THREE.LineSegmentsGeometry: applyMatrix() has been renamed to applyMatrix4()."),this.applyMatrix4(e)}}THREE.LineSegmentsGeometry=i}(),function(){class e extends THREE.LineSegmentsGeometry{constructor(){super(),this.isLineGeometry=!0,this.type="LineGeometry"}setPositions(e){const t=e.length-3,i=new Float32Array(2*t);for(let r=0;r<t;r+=3)i[2*r]=e[r],i[2*r+1]=e[r+1],i[2*r+2]=e[r+2],i[2*r+3]=e[r+3],i[2*r+4]=e[r+4],i[2*r+5]=e[r+5];return super.setPositions(i),this}setColors(e){const t=e.length-3,i=new Float32Array(2*t);for(let r=0;r<t;r+=3)i[2*r]=e[r],i[2*r+1]=e[r+1],i[2*r+2]=e[r+2],i[2*r+3]=e[r+3],i[2*r+4]=e[r+4],i[2*r+5]=e[r+5];return super.setColors(i),this}fromLine(e){const t=e.geometry;return this.setPositions(t.attributes.position.array),this}copy(e){return this}}THREE.LineGeometry=e}(),function(){const e=new THREE.Vector3,t=new THREE.Vector3,i=new THREE.Vector4,r=new THREE.Vector4,a=new THREE.Vector4,n=new THREE.Vector3,s=new THREE.Matrix4,o=new THREE.Line3,l=new THREE.Vector3,d=new THREE.Box3,h=new THREE.Sphere,c=new THREE.Vector4;let u,p,m,f;function g(e,t,i){return c.set(0,0,-t,1).applyMatrix4(e.projectionMatrix),c.multiplyScalar(1/c.w),c.x=f/i.width,c.y=f/i.height,c.applyMatrix4(e.projectionMatrixInverse),c.multiplyScalar(1/c.w),Math.abs(Math.max(c.x,c.y))}class v extends THREE.Mesh{constructor(e=new THREE.LineSegmentsGeometry,t=new THREE.LineMaterial({color:16777215*Math.random()})){super(e,t),this.isLineSegments2=!0,this.type="LineSegments2",this.geometry=void 0!==e?e:new THREE.LineSegmentsGeometry,this.material=void 0!==t?t:new THREE.LineMaterial({color:16777215*Math.random()})}computeLineDistances(){const i=this.geometry,r=i.attributes.instanceStart,a=i.attributes.instanceEnd,n=new Float32Array(2*r.count);for(let i=0,s=0,o=r.count;i<o;i++,s+=2)e.fromBufferAttribute(r,i),t.fromBufferAttribute(a,i),n[s]=0===s?0:n[s-1],n[s+1]=n[s]+e.distanceTo(t);const s=new THREE.InstancedInterleavedBuffer(n,2,1);return i.setAttribute("instanceDistanceStart",new THREE.InterleavedBufferAttribute(s,1,0)),i.setAttribute("instanceDistanceEnd",new THREE.InterleavedBufferAttribute(s,1,1)),this}copy(e){return this}raycast(e,t){const c=this.material.worldUnits,v=e.camera;null!==v||c||console.error('LineSegments2: "Raycaster.camera" needs to be set in order to raycast against LineSegments2 while worldUnits is set to false.');const y=void 0!==e.params.Line2&&e.params.Line2.threshold||0;u=e.ray;const M=this.matrixWorld,E=this.geometry,b=this.material;let I,x;if(f=b.linewidth+y,p=E.attributes.instanceStart,m=E.attributes.instanceEnd,null===E.boundingSphere&&E.computeBoundingSphere(),h.copy(E.boundingSphere).applyMatrix4(M),c)I=.5*f;else{I=g(v,Math.max(v.near,h.distanceToPoint(u.origin)),b.resolution)}if(h.radius+=I,!1!==u.intersectsSphere(h)){if(null===E.boundingBox&&E.computeBoundingBox(),d.copy(E.boundingBox).applyMatrix4(M),c)x=.5*f;else{x=g(v,Math.max(v.near,d.distanceToPoint(u.origin)),b.resolution)}d.expandByScalar(x),!1!==u.intersectsBox(d)&&(c?function(e,t){for(let i=0,r=p.count;i<r;i++){o.start.fromBufferAttribute(p,i),o.end.fromBufferAttribute(m,i);const r=new THREE.Vector3,a=new THREE.Vector3;u.distanceSqToSegment(o.start,o.end,a,r),a.distanceTo(r)<.5*f&&t.push({point:a,pointOnLine:r,distance:u.origin.distanceTo(a),object:e,face:null,faceIndex:i,uv:null,uv2:null})}}(this,t):function(e,t,d){const h=t.projectionMatrix,c=e.material.resolution,p=e.matrixWorld,m=e.geometry,g=m.attributes.instanceStart,v=m.attributes.instanceEnd,y=-t.near;u.at(1,a),a.w=1,a.applyMatrix4(t.matrixWorldInverse),a.applyMatrix4(h),a.multiplyScalar(1/a.w),a.x*=c.x/2,a.y*=c.y/2,a.z=0,n.copy(a),s.multiplyMatrices(t.matrixWorldInverse,p);for(let t=0,a=g.count;t<a;t++){if(i.fromBufferAttribute(g,t),r.fromBufferAttribute(v,t),i.w=1,r.w=1,i.applyMatrix4(s),r.applyMatrix4(s),i.z>y&&r.z>y)continue;if(i.z>y){const e=i.z-r.z,t=(i.z-y)/e;i.lerp(r,t)}else if(r.z>y){const e=r.z-i.z,t=(r.z-y)/e;r.lerp(i,t)}i.applyMatrix4(h),r.applyMatrix4(h),i.multiplyScalar(1/i.w),r.multiplyScalar(1/r.w),i.x*=c.x/2,i.y*=c.y/2,r.x*=c.x/2,r.y*=c.y/2,o.start.copy(i),o.start.z=0,o.end.copy(r),o.end.z=0;const a=o.closestPointToPointParameter(n,!0);o.at(a,l);const m=THREE.MathUtils.lerp(i.z,r.z,a),M=m>=-1&&m<=1,E=n.distanceTo(l)<.5*f;if(M&&E){o.start.fromBufferAttribute(g,t),o.end.fromBufferAttribute(v,t),o.start.applyMatrix4(p),o.end.applyMatrix4(p);const i=new THREE.Vector3,r=new THREE.Vector3;u.distanceSqToSegment(o.start,o.end,r,i),d.push({point:r,pointOnLine:i,distance:u.origin.distanceTo(r),object:e,face:null,faceIndex:t,uv:null,uv2:null})}}}(this,v,t))}}}THREE.LineSegments2=v}(),function(){class e extends THREE.LineSegments2{constructor(e=new THREE.LineGeometry,t=new THREE.LineMaterial({color:16777215*Math.random()})){super(e,t),this.isLine2=!0,this.type="Line2",this.geometry=void 0!==e?e:new THREE.LineGeometry,this.material=void 0!==t?t:new THREE.LineMaterial({color:16777215*Math.random()}),this.groundCurve=void 0}copy(e){return this}createGroundCurve(e){this.groundCurve=r.GroundPrimitiveManager.getInstance().createGroundCurve(e)}}THREE.Line2=e}(),function(){THREE.UniformsLib.line={linewidth:{value:1},resolution:{value:new THREE.Vector2(1,1)},dashScale:{value:1},dashSize:{value:1},dashOffset:{value:0},gapSize:{value:1},opacity:{value:1},uvTransform:{value:new THREE.Matrix3},clippingTolerance:{value:0},clippingPlanes:{value:new Float32Array(24)},outNormal:{value:new THREE.Vector3}},THREE.ShaderLib.line={uniforms:THREE.UniformsUtils.merge([THREE.UniformsLib.common,THREE.UniformsLib.fog,THREE.UniformsLib.line]),vertexShader:"\n\t\t#include <common>\n\t\t#include <color_pars_vertex>\n\t\t#include <fog_pars_vertex>\n\t\t#include <logdepthbuf_pars_vertex>\n\t\t#include <clipping_planes_pars_vertex>\n\n\t\t#if defined( USE_MAP )\n        uniform mat3 uvTransform;\n    \t#endif\n\n\t\tuniform float linewidth;\n\t\tuniform vec2 resolution;\n\t\n\n\t\tattribute vec3 instanceStart;\n\t\tattribute vec3 instanceEnd;\n\n\t\tattribute vec3 instanceColorStart;\n\t\tattribute vec3 instanceColorEnd;\n\n\t\tattribute float instanceDistanceStart;//for quick to change style and map\n\t\tattribute float instanceDistanceEnd;\n\n\t\tvarying vec2 vUv;\n\t\tvarying float rate;\n\t\tuniform float totalSize;//v is depend on nowSize/Totalsize\n\t\t#if defined( USE_MAP )\n\n\t\t\t//uniform vec4 uv;\n\t\t\t//uniform mat3 rotateMatrix;\n\n\t\t\tvarying vec2 vUv2;\n\n\t\t#endif\n\n\t\t#ifdef USE_DASH\n\n\t\t\tuniform float dashScale;\n\t\t\tattribute float instanceDistanceStart;\n\t\t\tattribute float instanceDistanceEnd;\n\t\t\tvarying float vLineDistance;\n\n\t\t#endif\n\n\t\tvoid trimSegment( const in vec4 start, inout vec4 end ) {\n\n\t\t\t// trim end segment so it terminates between the camera plane and the near plane\n\n\t\t\t// conservative estimate of the near plane\n\t\t\tfloat a = projectionMatrix[ 2 ][ 2 ]; // 3nd entry in 3th column\n\t\t\tfloat b = projectionMatrix[ 3 ][ 2 ]; // 3nd entry in 4th column\n\t\t\tfloat nearEstimate = - 0.5 * b / a;\n\n\t\t\tfloat alpha = ( nearEstimate - start.z ) / ( end.z - start.z );\n\n\t\t\tend.xyz = mix( start.xyz, end.xyz, alpha );\n\n\t\t}\n\n\t\t#ifdef USE_OUTNORMAL\n        \tuniform vec3 outNormal;\n\t\t\tvarying float vIsVisible;\n\n    \t#endif\n\n\t\tvoid main() {\n\n\t\t\t#ifdef USE_COLOR\n\n\t\t\t\tvColor.xyz = ( position.y < 0.5 ) ? instanceColorStart : instanceColorEnd;\n\n\t\t\t#endif\n\n\t\t\t#ifdef USE_DASH\n\n\t\t\t\tvLineDistance = ( position.y < 0.5 ) ? dashScale * instanceDistanceStart : dashScale * instanceDistanceEnd;\n\n\t\t\t#endif\n\n\t\t\tfloat aspect = resolution.x / resolution.y;\n\n\t\t\tvUv = uv;\n\t\t\trate = instanceDistanceEnd/totalSize;\n\n\t\t\t#if defined( USE_MAP )\n\t\t\t\t//u: uv.x* 0.5 + 0.5, v: instanceDistanceEnd/totalSize\n\t\t\t\tvUv2 = vec2((uv.x* 0.5 + 0.5) - 0.5,instanceDistanceEnd/totalSize - 0.5) + vec2(0.5, 0.5);\n\t\t\t\tvUv2 = ( uvTransform * vec3( vUv2, 1 ) ).xy;\n\t\t\t#endif\n\t\t\t// camera space\n\t\t\tvec4 start = modelViewMatrix * vec4( instanceStart, 1.0 );\n\t\t\tvec4 end = modelViewMatrix * vec4( instanceEnd, 1.0 );\n\n\t\t\t// special case for perspective projection, and segments that terminate either in, or behind, the camera plane\n\t\t\t// clearly the gpu firmware has a way of addressing this issue when projecting into ndc space\n\t\t\t// but we need to perform ndc-space calculations in the shader, so we must address this issue directly\n\t\t\t// perhaps there is a more elegant solution -- WestLangley\n\n\t\t\tbool perspective = ( projectionMatrix[ 2 ][ 3 ] == - 1.0 ); // 4th entry in the 3rd column\n\n\t\t\tif ( perspective ) {\n\n\t\t\t\tif ( start.z < 0.0 && end.z >= 0.0 ) {\n\n\t\t\t\t\ttrimSegment( start, end );\n\n\t\t\t\t} else if ( end.z < 0.0 && start.z >= 0.0 ) {\n\n\t\t\t\t\ttrimSegment( end, start );\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\t// clip space\n\t\t\tvec4 clipStart = projectionMatrix * start;\n\t\t\tvec4 clipEnd = projectionMatrix * end;\n\n\t\t\t// ndc space\n\t\t\tvec2 ndcStart = clipStart.xy / clipStart.w;\n\t\t\tvec2 ndcEnd = clipEnd.xy / clipEnd.w;\n\n\t\t\t// direction\n\t\t\tvec2 dir = ndcEnd - ndcStart;\n\n\t\t\t// account for clip-space aspect ratio\n\t\t\tdir.x *= aspect;\n\t\t\tdir = normalize( dir );\n\n\t\t\t// perpendicular to dir\n\t\t\tvec2 offset = vec2( dir.y, - dir.x );\n\n\t\t\t// undo aspect ratio adjustment\n\t\t\tdir.x /= aspect;\n\t\t\toffset.x /= aspect;\n\n\t\t\t// sign flip\n\t\t\tif ( position.x < 0.0 ) offset *= - 1.0;\n\n\t\t\t// endcaps\n\t\t\tif ( position.y < 0.0 ) {\n\n\t\t\t\toffset += - dir;\n\n\t\t\t} else if ( position.y > 1.0 ) {\n\n\t\t\t\toffset += dir;\n\n\t\t\t}\n\n\t\t\t// adjust for linewidth\n\t\t\toffset *= linewidth;\n\n\t\t\t// adjust for clip-space to screen-space conversion // maybe resolution should be based on viewport ...\n\t\t\toffset /= resolution.y;\n\n\t\t\t// select end\n\t\t\tvec4 clip = ( position.y < 0.5 ) ? clipStart : clipEnd;\n\n\t\t\t// back to clip space\n\t\t\toffset *= clip.w;\n\n\t\t\tclip.xy += offset;\n\n\t\t\tgl_Position = clip;\n\t\t\tvec4 mvPosition = ( position.y < 0.5 ) ? start : end; // this is an approximation\n\n\t\t\t#ifdef USE_OUTNORMAL\n\t\t\t\tvec3 viewNormal = normalMatrix * outNormal;\n            \tvIsVisible = dot(normalize(viewNormal), normalize(mvPosition.xyz)) > 0.0?1.0:-1.0;\n        \t#endif\n\t\t\t#include <logdepthbuf_vertex>\n\t\t\t#include <clipping_planes_vertex>\n\t\t\t#include <fog_vertex>\n\n\t\t}\n\t\t",fragmentShader:"\n\t\tuniform vec3 diffuse;\n\t\tuniform float opacity;\n\t\tuniform float visibility;\n\t\t#ifdef USE_DASH\n\n\t\t\tuniform float dashSize;\n\t\t\tuniform float dashOffset;\n\t\t\tuniform float gapSize;\n\n\t\t#endif\n\n\t\t#ifdef USE_OUTNORMAL\n\t\t\tvarying float vIsVisible;\n\t\t#endif\n\t\tvarying float vLineDistance;\n\t\tvarying float rate;\n\t\t#include <map_pars_fragment>\n\t\t#include <alphamap_pars_fragment>\n\t\t#if defined( USE_MAP )\n\t\t\tvarying vec2 vUv2;\n\t\t#endif\n\t\t#include <common>\n\t\t#include <color_pars_fragment>\n\t\t//r142\n\t\t//#include <alphatest_pars_fragment>\n\t\t#include <fog_pars_fragment>\n\t\t#include <logdepthbuf_pars_fragment>\n\t\t#include <clipping_planes_pars_fragment>\n\n\t\tvarying vec2 vUv;\n\t\tuniform float clippingTolerance;\n\n\t\tvoid main() {\n\t\t\t#ifdef USE_OUTNORMAL\n\t\t\t\tif(vIsVisible<0.0) discard;\n\t\t\t#endif\n\t\t\t#if NUM_CLIPPING_PLANES > 0\n\n\t\t\t\tvec4 plane;\n\n\t\t\t\tfor ( int i = 0; i < UNION_CLIPPING_PLANES; i ++ ) {\n\n\t\t\t\t\tplane = clippingPlanes[ i ];\n\t\t\t\t\tif (dot( vClipPosition, plane.xyz ) > plane.w + clippingTolerance ) discard;\n\t\t\t\t}\n\n\t\t\t\t#if UNION_CLIPPING_PLANES < NUM_CLIPPING_PLANES\n\n\t\t\t\t\tbool clipped = true;\n\n\t\t\t\t\tfor ( int i = UNION_CLIPPING_PLANES; i < NUM_CLIPPING_PLANES; i ++ ) {\n\t\t\t\n\t\t\t\t\t\tplane = clippingPlanes[ i ];\n\t\t\t\t\t\tclipped = ( dot( vClipPosition, plane.xyz ) > plane.w ) && clipped;\n\t\t\t\n\t\t\t\t\t}\n\t\t\t\n\t\t\t\t\tif ( clipped ) discard;\n\t\t\t\n\t\t\t\t#endif\n\t\t\t#endif\n\n\t\t\tif(rate > visibility) discard;\n\t\t\t#ifdef USE_DASH\n\n\t\t\t\tif ( vUv.y < - 1.0 || vUv.y > 1.0 ) discard; // discard endcaps\n\n\t\t\t\tif ( mod( vLineDistance + dashOffset, dashSize + gapSize ) > dashSize ) discard; // todo - FIX\n\n\t\t\t#endif\n\n\t\t\tfloat alpha = opacity;\n\n\t\t\t#ifdef ALPHA_TO_COVERAGE\n\n\t\t\t// artifacts appear on some hardware if a derivative is taken within a conditional\n\t\t\tfloat a = vUv.x;\n\t\t\tfloat b = ( vUv.y > 0.0 ) ? vUv.y - 1.0 : vUv.y + 1.0;\n\t\t\tfloat len2 = a * a + b * b;\n\t\t\tfloat dlen = fwidth( len2 );\n\n\t\t\tif ( abs( vUv.y ) > 1.0 ) {\n\n\t\t\t\talpha = 1.0 - smoothstep( 1.0 - dlen, 1.0 + dlen, len2 );\n\n\t\t\t}\n\n\t\t\t#else\n\n\t\t\tif ( abs( vUv.y ) > 1.0 ) {\n\n\t\t\t\tfloat a = vUv.x;\n\t\t\t\tfloat b = ( vUv.y > 0.0 ) ? vUv.y - 1.0 : vUv.y + 1.0;\n\t\t\t\tfloat len2 = a * a + b * b;\n\n\t\t\t\tif ( len2 > 1.0 ) discard;\n\n\t\t\t}\n\n\t\t\t#endif\n\n\t\t\tvec4 diffuseColor = vec4( diffuse, opacity );\n\n\t\t\t#ifdef USE_MAP\n\t\t\t   vec4 texelColor = texture2D( map, vUv2 );\n\t\t\t   //texelColor = mapTexelToLinear( texelColor );\n\t\t\t   diffuseColor = vec4(texelColor.rgb, opacity);\n\t\t\t#endif\n\n\t\t\t#ifdef USE_ALPHAMAP\n\t\t\t\tdiffuseColor.a *= texture2D( alphaMap, vUv2 ).a;\n\t\t\t#endif\n\t\t\t#include <alphatest_fragment>\n\n\n\t\t\t#include <logdepthbuf_fragment>\n\t\t\t#include <color_fragment>\n\n\t\t\tgl_FragColor = vec4( diffuseColor.rgb, diffuseColor.a );\n\n\t\t\t#include <premultiplied_alpha_fragment>\n\t\t\t#include <tonemapping_fragment>\n\t\t\t#include <encodings_fragment>\n\t\t\t#include <fog_fragment>\n\n\t\t}\n\t\t"};class e extends THREE.ShaderMaterial{constructor(e){super({type:"LineMaterial",uniforms:THREE.UniformsUtils.clone(THREE.ShaderLib.line.uniforms),vertexShader:THREE.ShaderLib.line.vertexShader,fragmentShader:THREE.ShaderLib.line.fragmentShader,clipping:!1}),this.dashed=!1,this.alphaMap=null,this.visibility=1,this.outNormal=new THREE.Vector3(0),Object.defineProperties(this,{color:{enumerable:!0,get:function(){return this.uniforms.diffuse.value},set:function(e){this.uniforms.diffuse.value=e}},linewidth:{enumerable:!0,get:function(){return this.uniforms.linewidth.value},set:function(e){this.uniforms.linewidth.value=e}},dashScale:{enumerable:!0,get:function(){return this.uniforms.dashScale.value},set:function(e){this.uniforms.dashScale.value=e}},dashSize:{enumerable:!0,get:function(){return this.uniforms.dashSize.value},set:function(e){this.uniforms.dashSize.value=e}},dashOffset:{enumerable:!0,get:function(){return this.uniforms.dashOffset.value},set:function(e){this.uniforms.dashOffset.value=e}},gapSize:{enumerable:!0,get:function(){return this.uniforms.gapSize.value},set:function(e){this.uniforms.gapSize.value=e}},opacity:{enumerable:!0,get:function(){return this.uniforms.opacity.value},set:function(e){this.uniforms.opacity.value=e}},map:{enumerable:!0,get:function(){return this.uniforms.map.value},set:function(e){this.uniforms.map.value=e,r.MaterialUtil.updateUVMatrix(this.uniforms.map.value),this.uniforms.uvTransform.value=this.uniforms.map.value.matrix}},resolution:{enumerable:!0,get:function(){return this.uniforms.resolution.value},set:function(e){this.uniforms.resolution.value.copy(e)}},clippingTolerance:{enumerable:!0,get:function(){return this.uniforms.clippingTolerance.value},set:function(e){this.uniforms.clippingTolerance.value=e}},alphaToCoverage:{enumerable:!0,get:function(){return Boolean("ALPHA_TO_COVERAGE"in this.defines)},set:function(e){Boolean(e)!==Boolean("ALPHA_TO_COVERAGE"in this.defines)&&(this.needsUpdate=!0),e?(this.defines.ALPHA_TO_COVERAGE="",this.extensions.derivatives=!0):(delete this.defines.ALPHA_TO_COVERAGE,this.extensions.derivatives=!1)},totalSize:{enumerable:!0,get:function(){return this.uniforms.totalSize.value},set:function(e){this.uniforms.totalSize.value=e}},alphaMap:{enumerable:!0,get:function(){return this.uniforms.alphaMap.value},set:function(e){this.uniforms.alphaMap.value=e}},visibility:{enumerable:!0,get:function(){return this.uniforms.visibility.value},set:function(e){this.uniforms.visibility.value=e}},outNormal:{enumerable:!0,get:function(){return this.uniforms.outNormal.value},set:function(e){this.uniforms.outNormal.value=e}}}}),this.setValues(e)}}e.prototype.isLineMaterial=!0,THREE.LineMaterial=e}();var _,S,C={uniforms:THREE.UniformsUtils.merge([THREE.UniformsLib.common,THREE.UniformsLib.fog,{linewidth:{value:1},resolution:{value:new THREE.Vector2(1,1)},dashArray:{value:0},dashRatio:{value:0},visibility:{value:1},alphaTest:{value:0},glowPower:{value:0},enableColorOverride:{value:!1},sizeAttenuation:{value:!1}}]),vertexShader:"\n    #include <common>\n    #include <logdepthbuf_pars_vertex>\n    #include <fog_pars_vertex>\n    attribute vec3 previous;\n    attribute vec3 next;\n    uniform vec2 resolution;\n    uniform float linewidth;\n    uniform vec3 diffuse;\n    uniform float opacity;\n    uniform bool sizeAttenuation;\n\n    varying vec2 vUv;\n    varying vec4 vColor;\n\n    vec3 fix( vec4 i, float aspect ) {\n        vec2 res = i.xy / i.w;\n        res.x *= aspect;\n        return vec3(res,0.0);\n    }\n\n    vec3 getDir(vec3 currentP, vec3 prevP, vec3 nextP){\n        vec3 dir;\n        if( nextP == currentP ) dir = normalize( currentP - prevP );\n        else if( prevP == currentP ) dir = normalize( nextP - currentP );\n        else {\n            vec3 dir1 = normalize( currentP - prevP );\n            vec3 dir2 = normalize( nextP - currentP );\n            dir = normalize( dir1 + dir2 );\n        }\n        return dir;\n    }\n\n    vec4 getNormalWithWidth(float width, vec4 normal, float side){\n        #if defined(SINGLE_EXPAND)\n            if(side > 0.0){//left expand\n                normal *= 2.0 * width;\n            }\n        #else\n            normal *= width;\n        #endif\n\n        return normal;\n    }\n\n    mat4 inverse_mat4(mat4 m)\n    {\n        float Coef00 = m[2][2] * m[3][3] - m[3][2] * m[2][3];\n        float Coef02 = m[1][2] * m[3][3] - m[3][2] * m[1][3];\n        float Coef03 = m[1][2] * m[2][3] - m[2][2] * m[1][3];\n        \n        float Coef04 = m[2][1] * m[3][3] - m[3][1] * m[2][3];\n        float Coef06 = m[1][1] * m[3][3] - m[3][1] * m[1][3];\n        float Coef07 = m[1][1] * m[2][3] - m[2][1] * m[1][3];\n        \n        float Coef08 = m[2][1] * m[3][2] - m[3][1] * m[2][2];\n        float Coef10 = m[1][1] * m[3][2] - m[3][1] * m[1][2];\n        float Coef11 = m[1][1] * m[2][2] - m[2][1] * m[1][2];\n        \n        float Coef12 = m[2][0] * m[3][3] - m[3][0] * m[2][3];\n        float Coef14 = m[1][0] * m[3][3] - m[3][0] * m[1][3];\n        float Coef15 = m[1][0] * m[2][3] - m[2][0] * m[1][3];\n        \n        float Coef16 = m[2][0] * m[3][2] - m[3][0] * m[2][2];\n        float Coef18 = m[1][0] * m[3][2] - m[3][0] * m[1][2];\n        float Coef19 = m[1][0] * m[2][2] - m[2][0] * m[1][2];\n        \n        float Coef20 = m[2][0] * m[3][1] - m[3][0] * m[2][1];\n        float Coef22 = m[1][0] * m[3][1] - m[3][0] * m[1][1];\n        float Coef23 = m[1][0] * m[2][1] - m[2][0] * m[1][1];\n        \n        const vec4 SignA = vec4( 1.0, -1.0,  1.0, -1.0);\n        const vec4 SignB = vec4(-1.0,  1.0, -1.0,  1.0);\n        \n        vec4 Fac0 = vec4(Coef00, Coef00, Coef02, Coef03);\n        vec4 Fac1 = vec4(Coef04, Coef04, Coef06, Coef07);\n        vec4 Fac2 = vec4(Coef08, Coef08, Coef10, Coef11);\n        vec4 Fac3 = vec4(Coef12, Coef12, Coef14, Coef15);\n        vec4 Fac4 = vec4(Coef16, Coef16, Coef18, Coef19);\n        vec4 Fac5 = vec4(Coef20, Coef20, Coef22, Coef23);\n        \n        vec4 Vec0 = vec4(m[1][0], m[0][0], m[0][0], m[0][0]);\n        vec4 Vec1 = vec4(m[1][1], m[0][1], m[0][1], m[0][1]);\n        vec4 Vec2 = vec4(m[1][2], m[0][2], m[0][2], m[0][2]);\n        vec4 Vec3 = vec4(m[1][3], m[0][3], m[0][3], m[0][3]);\n        \n        vec4 Inv0 = SignA * (Vec1 * Fac0 - Vec2 * Fac1 + Vec3 * Fac2);\n        vec4 Inv1 = SignB * (Vec0 * Fac0 - Vec2 * Fac3 + Vec3 * Fac4);\n        vec4 Inv2 = SignA * (Vec0 * Fac1 - Vec1 * Fac3 + Vec3 * Fac5);\n        vec4 Inv3 = SignB * (Vec0 * Fac2 - Vec1 * Fac4 + Vec2 * Fac5);\n        \n        mat4 Inverse = mat4(Inv0, Inv1, Inv2, Inv3);\n        \n        vec4 Row0 = vec4(Inverse[0][0], Inverse[1][0], Inverse[2][0], Inverse[3][0]);\n        \n        float Determinant = dot(m[0], Row0);\n        \n        Inverse /= Determinant;\n        \n        return Inverse;\n    }\n\n    void main() {\n    \n        float aspect = resolution.x / resolution.y;\n    \n        vColor = vec4( diffuse, opacity );\n        vUv = uv;\n    \n        mat4 m = projectionMatrix * modelViewMatrix;\n        vec4 finalPosition;\n\n        float side = (vUv.x - 0.5) * (-2.0);\n        if( sizeAttenuation == false) {\n            finalPosition = m * vec4( position, 1.0 );\n            vec4 prevPos = m * vec4( previous, 1.0 );\n            vec4 nextPos = m * vec4( next, 1.0 );\n\n            vec3 currentP = fix( finalPosition, aspect );\n            vec3 prevP = fix( prevPos, aspect );\n            vec3 nextP = fix( nextPos, aspect );\n            \n            vec3 dir = getDir(currentP, prevP, nextP);\n            vec4 normal = vec4( -dir.y, dir.x, 0., 1. );\n            normal = getNormalWithWidth(linewidth, normal, side);\n\n            normal *= projectionMatrix;\n            normal.xy *= finalPosition.w;\n            normal.xy /= ( vec4( resolution, 0., 1. ) * projectionMatrix ).xy;\n            finalPosition.xy += (normal.xy * side);\n\n        }else{\n            vec3 dir = getDir(position, previous, next);\n            vec3 cameraDir = normalize((inverse_mat4(modelMatrix) * vec4(cameraPosition,1.0)).xyz - position);\n            vec4 normal =  vec4(normalize(cross( vec3( dir), cameraDir)), 1.0) ;//vec3( 0., 0., 1. )\n            normal = getNormalWithWidth(0.5 * linewidth, normal, side);\n\n            normal = normal * side* (-1.0) ;//frontSide\n            finalPosition = m * vec4( position + normal.xyz, 1.0 );\n        }\n    \n        gl_Position = finalPosition;\n    \n        #include <logdepthbuf_vertex>\n        #include <fog_vertex>\n    }\n    ",fragmentShader:"\n    #include <fog_pars_fragment>\n    #include <common>\n    #include <logdepthbuf_pars_fragment>\n    \n    #ifdef USE_MAP \n        uniform sampler2D map;\n    #endif\n\n    #if defined(USE_MAP)||defined(USE_DASH)\n        uniform mat3 uvTransform;\n    #endif\n\n    #ifdef USE_GLOW\n        uniform float glowPower;\n    #endif\n\n    #ifdef USE_DASH\n        uniform float dashArray;\n        uniform float dashRatio;\n    #endif\n\n    uniform float visibility;\n    uniform float alphaTest;\n    uniform bool enableColorOverride;\n    \n    varying vec2 vUv;\n    varying vec4 vColor;\n    \n    void main() {\n    \n        #include <logdepthbuf_fragment>\n        vec4 diffuseColor = vColor;\n\n        if(vUv.y > visibility) discard;\n        \n        vec2 uv = vUv;\n        #if defined(USE_MAP)||defined(USE_DASH)\n            uv = vec2(vUv.x - 0.5, vUv.y - 0.5) + vec2(0.5, 0.5);\n            uv = ( uvTransform * vec3( uv, 1 ) ).xy;\n        #endif\n\n\n        #ifdef USE_DASH\n            float dashoffset = dashArray * dashRatio;\n            if((dashArray * dashRatio) - mod( uv.y, dashArray) < 0.0) discard; //diffuseColor.a = 0.0;\n        #endif\n\n        #ifdef USE_MAP\n            if(!enableColorOverride)\n                diffuseColor.xyz = texture2D( map, uv ).xyz;//*\n            diffuseColor.a = texture2D( map, uv).a * 2.0;\n        #endif\n\n        if( diffuseColor.a < alphaTest ) discard;\n\n        #ifdef USE_GLOW\n            float glow = glowPower / abs(vUv.y - 0.5) - (glowPower / 0.5);\n            // diffuseColor.rgb = max(vec3(glow - 1.0 + diffuseColor.rgb), diffuseColor.rgb);\n            diffuseColor.a = clamp(0.0, 1.0, glow) * diffuseColor.a;\n        #endif\n\n        gl_FragColor = diffuseColor;\n    \n        #include <fog_fragment>\n    }\n    "};!function(){class e extends THREE.ShaderMaterial{constructor(e){super({uniforms:THREE.UniformsUtils.clone(C.uniforms),vertexShader:C.vertexShader,fragmentShader:C.fragmentShader}),this.type="MeshLineMaterial",this.totalSize=0,this.setValues(e)}set linewidth(e){this.uniforms&&this.uniforms.linewidth&&(this.uniforms.linewidth.value=e)}get linewidth(){return this.uniforms.linewidth.value}set map(e){this.uniforms.map.value=e,e&&(r.MaterialUtil.updateUVMatrix(this.uniforms.map.value),this.uniforms.uvTransform.value=this.uniforms.map.value.matrix)}get map(){return this.uniforms.map.value}set color(e){this.uniforms.diffuse.value=e}get color(){return this.uniforms.diffuse.value}set opacity(e){this.uniforms&&(this.uniforms.opacity.value=e)}get opacity(){return this.uniforms.opacity.value}set resolution(e){this.uniforms.resolution.value=e}get resolution(){return this.uniforms.resolution.value}set dashArray(e){this.uniforms.dashArray.value=e,e>0?this.defines.USE_DASH="":delete this.defines.USE_DASH}get dashArray(){return this.uniforms.dashArray.value}set dashRatio(e){this.uniforms.dashRatio.value=e}get dashRatio(){return this.uniforms.dashRatio.value}set visibility(e){this.uniforms.visibility.value=e}get visibility(){return this.uniforms.visibility.value}set alphaTest(e){this.uniforms&&(this.uniforms.alphaTest.value=e)}get alphaTest(){return this.uniforms.alphaTest.value}set glowPower(e){this.uniforms.glowPower.value=e,e>0?this.defines.USE_GLOW="":delete this.defines.USE_GLOW}set enableSingleExpand(e){e?this.defines.SINGLE_EXPAND="":delete this.defines.SINGLE_EXPAND}get enableSingleExpand(){return!!this.defines.SINGLE_EXPAND}get glowPower(){return this.uniforms.glowPower.value}set enableColorOverride(e){this.uniforms.enableColorOverride.value=e}get enableColorOverride(){return this.uniforms.enableColorOverride.value}set sizeAttenuation(e){this.uniforms.sizeAttenuation.value=e}get sizeAttenuation(){return this.uniforms.sizeAttenuation.value}copy(e){return THREE.ShaderMaterial.prototype.copy.call(this,e),this.linewidth=e.linewidth,this.map=e.map,this.alphaMap=e.alphaMap,this.color.copy(e.color),this.opacity=e.opacity,this.resolution.copy(e.resolution),this.dashArray=e.dashArray,this.dashRatio=e.dashRatio,this.visibility=e.visibility,this.alphaTest=e.alphaTest,this}}r.MeshLineMaterial=e}(),function(){class e extends THREE.BufferGeometry{constructor(){super(),this.type="MeshLineGeometry"}setPositions(e){if(!(e instanceof Float32Array||e instanceof Array))return void console.error("ERROR: The BufferArray of points is not instancied correctly.");let t=[];var i=[0];if(e.length&&e[0]instanceof THREE.Vector3)for(var r=0;r<e.length;r++){var a=e[r];if(t.push(a.x,a.y,a.z),t.push(a.x,a.y,a.z),r>0){let t=i[i.length-1]+this._distanceTo(a.x,a.y,a.z,e[r-1].x,e[r-1].y,e[r-1].z);i.push(t)}}else for(r=0;r<e.length;r+=3)if(t.push(e[r],e[r+1],e[r+2]),t.push(e[r],e[r+1],e[r+2]),r>0){let t=i[i.length-1]+this._distanceTo(e[r-3],e[r-2],e[r-1],e[r],e[r+1],e[r+2]);i.push(t)}const n=t.length/6;let s,o=[],l=[],d=[],h=[];s=this.compareV3(t,0,n-1)?this.copyV3(t,n-2):this.copyV3(t,0),o.push(s[0],s[1],s[2]),o.push(s[0],s[1],s[2]);const c=i[i.length-1];this.totalSize=c;for(let e=0;e<n;e++){let r=i[e]/c;if(h.push(0,r),h.push(1,r),e<n-1){s=this.copyV3(t,e),o.push(s[0],s[1],s[2]),o.push(s[0],s[1],s[2]);var u=2*e;d.push(u,u+1,u+2),d.push(u+2,u+1,u+3)}e>0&&(s=this.copyV3(t,e),l.push(s[0],s[1],s[2]),l.push(s[0],s[1],s[2]))}s=this.compareV3(t,n-1,0)?this.copyV3(t,1):this.copyV3(t,n-1),l.push(s[0],s[1],s[2]),l.push(s[0],s[1],s[2]);const p=new THREE.BufferAttribute(new Float32Array(t),3),m=new THREE.BufferAttribute(new Float32Array(o),3),f=new THREE.BufferAttribute(new Float32Array(l),3),g=new THREE.BufferAttribute(new Float32Array(h),2),v=new THREE.BufferAttribute(new Uint16Array(d),1);this.setAttribute("position",p),this.setAttribute("previous",m),this.setAttribute("next",f),this.setAttribute("uv",g),this.setIndex(v),this.computeBoundingSphere(),this.computeBoundingBox()}setPositions2(e,t){let i=[];for(var r=[0],a=0;a<e.length;a+=3)if(i.push(e[a],e[a+1],e[a+2]),i.push(e[a],e[a+1],e[a+2]),a>0){let t=r[r.length-1]+this._distanceTo(e[a-3],e[a-2],e[a-1],e[a],e[a+1],e[a+2]);r.push(t)}const n=i.length/6;let s,o=[],l=[],d=[],h=[],c=0;s=this.compareV3(i,0,n-1)?this.copyV3(i,n-2):this.copyV3(i,0),o.push(s[0],s[1],s[2]),o.push(s[0],s[1],s[2]);const u=r[r.length-1];this.totalSize=u;for(let e=0;e<n;e++){let a=r[e]/u;h.push(0,a),h.push(1,a);var p=!0,m=!0;if(e<n-1){if(t&&(c%2==1&&t[c]!=t[c+1]?(p=!1,c++):c%2==1&&t[c]==t[c+1]?c+=2:(c++,m=!1)),p){var f=2*e;d.push(f,f+1,f+2),d.push(f+2,f+1,f+3)}s=p?this.copyV3(i,e):this.copyV3(i,e+1),o.push(s[0],s[1],s[2]),o.push(s[0],s[1],s[2])}e>0&&(s=m?this.copyV3(i,e):this.copyV3(i,e-1),l.push(s[0],s[1],s[2]),l.push(s[0],s[1],s[2]))}s=this.compareV3(i,n-1,0)?this.copyV3(i,1):this.copyV3(i,n-1),l.push(s[0],s[1],s[2]),l.push(s[0],s[1],s[2]);const g=new THREE.BufferAttribute(new Float32Array(i),3),v=new THREE.BufferAttribute(new Float32Array(o),3),y=new THREE.BufferAttribute(new Float32Array(l),3),M=new THREE.BufferAttribute(new Float32Array(h),2),E=new THREE.BufferAttribute(new Uint32Array(d),1);this.setAttribute("position",g),this.setAttribute("previous",v),this.setAttribute("next",y),this.setAttribute("uv",M),this.setIndex(E),this.computeBoundingSphere(),this.computeBoundingBox()}compareV3(e,t,i){const r=6*t,a=6*i;return e[r]===e[a]&&e[r+1]===e[a+1]&&e[r+2]===e[a+2]}copyV3(e,t){const i=6*t;return[e[i],e[i+1],e[i+2]]}_distanceTo(e,t,i,r,a,n){const s=r-e,o=a-t,l=n-i,d=s*s+o*o+l*l;return Math.sqrt(d)}}r.MeshLineGeometry=e}(),function(){let e=new THREE.Matrix4;class t extends THREE.Mesh{constructor(e,t){super(e,t),this.type="MeshLine",this.isMeshLine=!0,this.geometry=void 0!==e?e:new r.MeshLineGeometry,this.material=void 0!==t?t:new r.MeshLineMaterial({color:16777215*Math.random()}),this.groundCurve=void 0}copy(e){return this}raycast(t,i){var r=new THREE.Ray,a=new THREE.Sphere,n=new THREE.Vector3,s=this.geometry;if(a.copy(s.boundingSphere),a.applyMatrix4(this.matrixWorld),!1!==t.ray.intersectSphere(a,n)){e.copy(this.matrixWorld).invert(),r.copy(t.ray).applyMatrix4(e);var o=new THREE.Vector3,l=new THREE.Vector3,d=new THREE.Vector3,h=s.index,c=s.attributes;if(null!==h)for(var u=h.array,p=c.position.array,m=0,f=u.length-1;m<f;m+=2){var g=u[m],v=u[m+2];o.fromArray(p,3*g),l.fromArray(p,3*v);var y=t.params.Line.threshold+this.material.linewidth/2,M=y*y;if(!(r.distanceSqToSegment(o,l,n,d)>M)){n.applyMatrix4(this.matrixWorld);var E=t.ray.origin.distanceTo(n);E<t.near||E>t.far||(i.push({distance:E,point:d.clone().applyMatrix4(this.matrixWorld),index:m,face:null,faceIndex:null,object:this}),m=f)}}}}createGroundCurve(e){this.groundCurve=r.GroundPrimitiveManager.getInstance().createGroundCurve(e)}}r.MeshLine=t}(),function(){class e extends THREE.BufferGeometry{constructor(){super(),this.type="BandGeometry"}setPositions(e,t,i,r,a){if(!(e instanceof Float32Array||e instanceof Array))return void console.error("ERROR: The BufferArray of points is not instancied correctly.");let n=[];var s=[0];let o=[];for(var l=0;l<e.length;l+=3){const d=t[l],h=t[l+1],c=t[l+2];if(n.push(e[l]-d*r,e[l+1]-h*r,e[l+2]-c*r),n.push(e[l]+d*a,e[l+1]+h*a,e[l+2]+c*a),o.push(i[l],i[l+1],i[l+2]),o.push(i[l],i[l+1],i[l+2]),l>0){let t=s[s.length-1]+this._distanceTo(e[l-3],e[l-2],e[l-1],e[l],e[l+1],e[l+2]);s.push(t)}}const d=n.length/6;let h=[],c=[];const u=s[s.length-1];this.totalSize=u;for(let e=0;e<d;e++){let t=s[e]/u;if(c.push(0,t),c.push(1,t),e<d-1){var p=2*e;h.push(p,p+1,p+2),h.push(p+2,p+1,p+3)}}const m=new THREE.BufferAttribute(new Float32Array(n),3),f=new THREE.BufferAttribute(new Float32Array(c),2),g=new THREE.BufferAttribute(new Float32Array(o),3),v=new THREE.BufferAttribute(new Uint16Array(h),1);this.setAttribute("position",m),this.setAttribute("uv",f),this.setAttribute("normal",g),this.setIndex(v),this.computeBoundingSphere(),this.computeBoundingBox(),this.positions=n}getWireframe(){let e=[];const t=this.positions,i=t.length;let r=0;for(r=0;r<i;r+=6)e.push(t[r],t[r+1],t[r+2]);for(r-=1;r>0;r-=6)e.push(t[r-2],t[r-1],t[r]);return e.push(t[0],t[1],t[2]),e}_distanceTo(e,t,i,r,a,n){const s=r-e,o=a-t,l=n-i,d=s*s+o*o+l*l;return Math.sqrt(d)}}r.BandGeometry=e}(),function(){r.GIS=r.GIS||{};class e{constructor(e,t,i,r){this.west=e||0,this.south=t||0,this.east=i||0,this.north=r||0}static computeWidth(e){var t=e.east,i=e.west;return t<i&&(t+=r.Math.TWO_PI),t-i}static computeHeight(e){return e.north-e.south}static contains(e,t){var i=t.longitude,a=t.latitude,n=e.west,s=e.east;return s<n&&(s+=r.Math.TWO_PI,i<0&&(i+=r.Math.TWO_PI)),(i>n||r.Math.equalsEpsilon(i,n,r.Math.EPSILON14))&&(i<s||r.Math.equalsEpsilon(i,s,r.Math.EPSILON14))&&a>=e.south&&a<=e.north}static fromCartographicArray(t,i){for(var a=Number.MAX_VALUE,n=-Number.MAX_VALUE,s=Number.MAX_VALUE,o=-Number.MAX_VALUE,l=Number.MAX_VALUE,d=-Number.MAX_VALUE,h=0,c=t.length;h<c;h++){var u=t[h];a=Math.min(a,u.longitude),n=Math.max(n,u.longitude),l=Math.min(l,u.latitude),d=Math.max(d,u.latitude);var p=u.longitude>=0?u.longitude:u.longitude+r.Math.TWO_PI;s=Math.min(s,p),o=Math.max(o,p)}return n-a>o-s&&(a=s,(n=o)>Math.PI&&(n-=r.Math.TWO_PI),a>Math.PI&&(a-=r.Math.TWO_PI)),i?(i.west=a,i.south=l,i.east=n,i.north=d,i):new e(a,l,n,d)}get width(){return e.computeWidth(this)}get height(){return e.computeHeight(this)}}e.MAX_VALUE=Object.freeze(new e(-Math.PI,-r.Math.PI_OVER_TWO,Math.PI,r.Math.PI_OVER_TWO)),r.GIS.Rectangle=e}(),function(){r.GIS=r.GIS||{};class e{constructor(e,t,i){this.longitude=e||0,this.latitude=t||0,this.height=i||0}static fromRadians(t,i,r,a){return r=r||0,a?(a.longitude=t,a.latitude=i,a.height=r,a):new e(t,i,r)}}r.GIS.Cartographic=e}(),function(){r.GIS=r.GIS||{};var e,t,i={up:{south:"east",north:"west",west:"south",east:"north"},down:{south:"west",north:"east",west:"north",east:"south"},south:{up:"west",down:"east",west:"down",east:"up"},north:{up:"east",down:"west",west:"up",east:"down"},west:{up:"north",down:"south",north:"down",south:"up"},east:{up:"south",down:"north",north:"up",south:"down"}},a={north:[-1,0,0],east:[0,1,0],up:[0,0,1],south:[1,0,0],west:[0,-1,0],down:[0,0,-1]},n={},s={east:new THREE.Vector3,north:new THREE.Vector3,up:new THREE.Vector3,west:new THREE.Vector3,south:new THREE.Vector3,down:new THREE.Vector3},o=new THREE.Vector3,l=new THREE.Vector3,d=new THREE.Vector3,h=new THREE.Vector3;class c{constructor(){}static computeTemeToPseudoFixedMatrix(i,a){if(!r.Utils.defined(i))throw new Error("date is required.");t||(t=new r.JulianDate),e||(e=r.Math.TWO_PI/86400);var n,s=(t=r.JulianDate.addSeconds(i,-r.JulianDate.computeTaiMinusUtc(i),t)).dayNumber,o=t.secondsOfDay,l=s-2451545,d=(24110.54841+(n=o>=43200?(l+.5)/r.TimeConstants.DAYS_PER_JULIAN_CENTURY:(l-.5)/r.TimeConstants.DAYS_PER_JULIAN_CENTURY)*(8640184.812866+n*(.093104+-62e-7*n)))*e%r.Math.TWO_PI+(72921158553e-15+11772758384668e-32*(s-2451545.5))*((o+.5*r.TimeConstants.SECONDS_PER_DAY)%r.TimeConstants.SECONDS_PER_DAY),h=Math.cos(d),c=Math.sin(d);return r.Utils.defined(a)||(a=new THREE.Matrix3),a.set(h,c,0,-c,h,0,0,0,1)}static localFrameToFixedFrameGenerator(e,t){if(!i.hasOwnProperty(e)||!i[e].hasOwnProperty(t))throw new Error("firstAxis and secondAxis must be east, north, up, west, south or down.");var c,u=i[e][t],p=e+t;return r.Utils.defined(n[p])?c=n[p]:(c=function(i,n,c){if(!r.Utils.defined(i))throw new Error("origin is required.");if(r.Utils.defined(c)||(c=new THREE.Matrix4),r.Math.equalsEpsilonVector3(i,h,r.Math.EPSILON14))o.fromArray(a[e],0),l.fromArray(a[t],0),d.fromArray(a[u],0);else if(r.Math.equalsEpsilon(i.x,0,r.Math.EPSILON14)&&r.Math.equalsEpsilon(i.y,0,r.Math.EPSILON14)){var p=Math.sign(i.z);o.fromArray(a[e],0),"east"!==e&&"west"!==e&&o.multiplyScalar(p),l.fromArray(a[t],0),"east"!==t&&"west"!==t&&l.multiplyScalar(p),d.fromArray(a[u],0),"east"!==u&&"west"!==u&&d.multiplyScalar(p)}else{(n=r.Utils.defaultValue(n,r.GIS.Ellipsoid.WGS84)).geodeticSurfaceNormal(i,s.up);var m=s.up,f=s.east;f.x=-i.y,f.y=i.x,f.z=0,s.east.copy(f),s.east.normalize(),s.north.copy(m),s.north.cross(f),s.down.copy(s.up),s.down.multiplyScalar(-1),s.west.copy(s.east),s.west.multiplyScalar(-1),s.south.copy(s.north),s.south.multiplyScalar(-1),o=s[e],l=s[t],d=s[u]}return c.elements[0]=o.x,c.elements[1]=o.y,c.elements[2]=o.z,c.elements[3]=0,c.elements[4]=l.x,c.elements[5]=l.y,c.elements[6]=l.z,c.elements[7]=0,c.elements[8]=d.x,c.elements[9]=d.y,c.elements[10]=d.z,c.elements[11]=0,c.elements[12]=i.x,c.elements[13]=i.y,c.elements[14]=i.z,c.elements[15]=1,c},n[p]=c),c}}c.eastNorthUpToFixedFrame=c.localFrameToFixedFrameGenerator("east","north"),r.GIS.Transforms=c}(),function(){r.GIS=r.GIS||{};var e=new THREE.Vector3;class t{constructor(e,t,i){this._radii=void 0,this._radiiSquared=void 0,this._radiiToTheFourth=void 0,this._oneOverRadii=void 0,this._oneOverRadiiSquared=void 0,this._minimumRadius=void 0,this._maximumRadius=void 0,this._centerToleranceSquared=void 0,this._squaredXOverSquaredZ=void 0,this._squaredFirstEccentricity=void 0,function(e,t,i,a){t=r.Utils.defaultValue(t,0),i=r.Utils.defaultValue(i,0),a=r.Utils.defaultValue(a,0),e._radii=new THREE.Vector3(t,i,a),e._radiiSquared=new THREE.Vector3(t*t,i*i,a*a),e._radiiToTheFourth=new THREE.Vector3(t*t*t*t,i*i*i*i,a*a*a*a),e._oneOverRadii=new THREE.Vector3(0===t?0:1/t,0===i?0:1/i,0===a?0:1/a),e._oneOverRadiiSquared=new THREE.Vector3(0===t?0:1/(t*t),0===i?0:1/(i*i),0===a?0:1/(a*a)),e._minimumRadius=Math.min(t,i,a),e._maximumRadius=Math.max(t,i,a),e._centerToleranceSquared=r.Math.EPSILON1,e._squaredFirstEccentricity=1-a*a/(t*t),0!==e._radiiSquared.z&&(e._squaredXOverSquaredZ=e._radiiSquared.x/e._radiiSquared.z)}(this,e,t,i)}get radii(){return this._radii}get radiiSquared(){return this._radiiSquared}get radiiToTheFourth(){return this._radiiToTheFourth}get oneOverRadii(){return this._oneOverRadii}get oneOverRadiiSquared(){return this._oneOverRadiiSquared}get minimumRadius(){return this._minimumRadius}get maximumRadius(){return this._maximumRadius}getPerimeterByLat(e){const t=Math.sin(e*Math.PI/180),i=this._radii.x*Math.cos(e*Math.PI/180)/Math.sqrt(1-this._squaredFirstEccentricity*t*t);return Math.PI*i*2}geodeticSurfaceNormal(t,i){if(!r.Math.equalsEpsilonVec3(t,e,r.Math.EPSILON14))return r.Utils.defined(i)||(i=new THREE.Vector3),i.copy(t),i.multiply(this._oneOverRadiiSquared),i.normalize()}}t.WGS84=Object.freeze(new t(6378137,6378137,6356752.314245179)),r.GIS.Ellipsoid=t}(),function(){r.GIS=r.GIS||{};r.GIS.GeographicTilingScheme=class{constructor(){this._numberOfLevelZeroTilesX=2,this._numberOfLevelZeroTilesY=1,this._rectangle=r.GIS.Rectangle.MAX_VALUE}getNumberOfXTilesAtLevel(e){return this._numberOfLevelZeroTilesX<<e}getNumberOfYTilesAtLevel(e){return this._numberOfLevelZeroTilesY<<e}positionToTileXY(e,t,i){var a=this._rectangle;if(r.GIS.Rectangle.contains(a,e)){var n=this.getNumberOfXTilesAtLevel(t),s=this.getNumberOfYTilesAtLevel(t),o=a.width/n,l=a.height/s,d=e.longitude;a.east<a.west&&(d+=r.Math.TWO_PI);var h=(d-a.west)/o|0;h>=n&&(h=n-1);var c=(a.north-e.latitude)/l|0;return c>=s&&(c=s-1),i?(i.x=h,i.y=c,i):new THREE.Vector2(h,c)}}}}(),function(){r.GIS=r.GIS||{};var e=[new r.GIS.Cartographic,new r.GIS.Cartographic,new r.GIS.Cartographic,new r.GIS.Cartographic],t=new THREE.Vector2,i=new r.GIS.GeographicTilingScheme;class a{constructor(){}static initialize(){var e=a._initPromise;if(e)return e;var t=new THREE.FileLoader;t.setResponseType("json");var i=`${a._viewer._staticResourcesHost}/Earth/approximateTerrainHeights.json`;return e=new Promise(((e,r)=>{t.load(i,(function(t){a._terrainHeights=t,e()}))})),a._initPromise=e,e}static getMinimumMaximumHeights(e){var t=a.getTileXYLevel(e),i=a._defaultMinTerrainHeight,r=a._defaultMaxTerrainHeight;if(t){var n=t.level+"-"+t.x+"-"+t.y,s=a._terrainHeights[n];s&&(i=s[0],r=s[1])}return{minimumTerrainHeight:i=Math.max(a._defaultMinTerrainHeight,i),maximumTerrainHeight:r}}static getTileXYLevel(n){r.GIS.Cartographic.fromRadians(n.east,n.north,0,e[0]),r.GIS.Cartographic.fromRadians(n.west,n.north,0,e[1]),r.GIS.Cartographic.fromRadians(n.east,n.south,0,e[2]),r.GIS.Cartographic.fromRadians(n.west,n.south,0,e[3]);var s,o=0,l=0,d=0,h=0,c=a._terrainHeightsMaxLevel;for(s=0;s<=c;++s){for(var u=!1,p=0;p<4;++p){var m=e[p];if(i.positionToTileXY(m,s,t),0===p)d=t.x,h=t.y;else if(d!==t.x||h!==t.y){u=!0;break}}if(u)break;o=d,l=h}if(0!==s)return{x:o,y:l,level:s>c?c:s-1}}}a._terrainHeightsMaxLevel=6,a._defaultMaxTerrainHeight=9e3,a._defaultMinTerrainHeight=-1e5,a._terrainHeights=void 0,a._initPromise=void 0,a._viewer=void 0,r.GIS.ApproximateTerrainHeights=a}(),(()=>{new THREE.Matrix4;var e;r.Object3DEx=function(e,t){THREE.Object3D.call(this),this.type="Object3DEx",this.geometry=e||r.GeomUtil.EmptyGeometry,this.material=t||r.MaterialUtil.getDefaultStandardMaterial(),this.matrixAutoUpdate=!1,this.originalId=void 0,this.drawMode=THREE.TrianglesDrawMode},r.Object3DEx.prototype=Object.create(THREE.Mesh.prototype),r.Object3DEx.prototype.constructor=r.Object3DEx,r.Object3DEx.prototype.init=function(e){e&&e.parent&&e.parent.add(this)},r.Object3DEx.prototype.destroy=function(){this.parent&&this.parent.remove(this),this.userData&&(this.userData=null),this.geometry=null,this.material=null},r.Object3DEx.prototype.spawn=function(e){void 0!==e.userId?this.name=e.userId:void 0!==e.nodeId&&(this.name=e.nodeId),null!=e.meshId?this.meshId=e.meshId:this.meshId="",e.geometry&&(this.geometry=e.geometry),e.material&&(this.material=e.material),e.matrix?(this.matrix.copy(e.matrix),this.updateMatrixWorld(!0)):(this.matrix.identity(),this.updateMatrixWorld(!0)),e.databagId?this.databagId=e.databagId:this.databagId="",e.userData?this.userData=e.userData:this.userData&&(this.userData=null),e.originalId&&(this.originalId=e.originalId),null!=e.visible&&(this.visible=e.visible),null!=e.isMesh&&(this.isMesh=e.isMesh),null!=e.isLine&&(this.isLine=e.isLine),null!=e.isLineSegments&&(this.isLineSegments=e.isLineSegments),null!=e.instanceOrNot?this.instanceOrNot=e.instanceOrNot:this.instanceOrNot=!1,this.renderOrder=e.renderOrder||r.EnumRenderOrder.Component,this.frustumCulled=!1,this.material.visible=!0},r.Object3DEx.prototype.clear=function(){this.geometry=r.GeomUtil.EmptyGeometry,this.material=r.MaterialUtil.DefaultMaterial,this.visible=!0,this.frustumCulled=!0,this.material.visible=!1},r.Object3DEx.prototype.isVisible=function(){return this.visible},r.Object3DEx.prototype.intersectBoxWithDistance=(e=new THREE.Box3,function(t,i){var r=this.geometry,a=this.material,n=this.matrixWorld;return i&&(n=new THREE.Matrix4).multiplyMatrices(this.matrixWorld,i),void 0===a?-1:(r.boundingBox||r.computeBoundingBox(),e.copy(r.boundingBox),e.applyMatrix4(n),t.ray.intersectBoxWithDistance(e))}),r.Object3DEx.prototype.intersectBoxWithDistanceByIndices=function(e,t){var i=this.matrixWorld,r=this.computeBoundingBox(t);return r.applyMatrix4(i),e.ray.intersectBoxWithDistance(r)},r.Object3DEx.prototype.intersectBoxWithClipPlane=function(e,t){var i=this.matrixWorld,r=this.computeBoundingBox(t);return r.applyMatrix4(i),r.intersectsPlane(e)},r.Object3DEx.prototype.raycastByIndices=function(){var e=new THREE.Matrix4,t=new THREE.Ray,i=new THREE.Sphere,r=new THREE.Vector3,a=new THREE.Vector3,n=new THREE.Vector3,s=new THREE.Vector2,o=new THREE.Vector2,l=new THREE.Vector2,d=new THREE.Vector3,h=new THREE.Vector3,c=new THREE.Vector3,u=new THREE.Matrix4;function p(e,t,i,p,m,f,g,v){let y=new THREE.Vector3;r.fromBufferAttribute(p,f),a.fromBufferAttribute(p,g),n.fromBufferAttribute(p,v);var M,E,b,I,x,T,_,S=function(e,t,i,r,a,n,s){var o=e.material;if(null===(o instanceof Array?i.intersectTriangle(r,a,n,o[0].side!==THREE.DoubleSide,s):o.side===THREE.BackSide?i.intersectTriangle(n,a,r,!0,s):i.intersectTriangle(r,a,n,o.side!==THREE.DoubleSide,s)))return null;c.copy(s),c.applyMatrix4(u);var l=t.ray.origin.distanceTo(c);return l<t.near||l>t.far?null:{distance:l,point:c.clone(),object:e}}(e,t,i,r,a,n,h);if(S){if(m&&m.array&&m.array.length&&(s.fromBufferAttribute(m,f),o.fromBufferAttribute(m,g),l.fromBufferAttribute(m,v),S.uv=(M=h,E=r,b=a,I=n,x=s,T=o,_=l,THREE.Triangle.barycoordFromPoint(M,E,b,I,d),x.multiplyScalar(d.x),T.multiplyScalar(d.y),_.multiplyScalar(d.z),x.add(T).add(_),x.clone())),p.instanceMatrix){var C=r.clone().applyMatrix4(p.instanceMatrix),w=a.clone().applyMatrix4(p.instanceMatrix),R=n.clone().applyMatrix4(p.instanceMatrix);S.face=new THREE.Face3(f,g,v,THREE.Triangle.getNormal(C,w,R,y))}else S.face=new THREE.Face3(f,g,v,THREE.Triangle.getNormal(r,a,n,y));S.faceIndex=f}return S}return function(r,a,n,s){var o=this.geometry,l=this.material;if(s){o=this.geometry,l=this.material;if((u=new THREE.Matrix4).multiplyMatrices(this.matrixWorld,s),void 0===l)return;if(null===o.boundingSphere&&o.computeBoundingSphere(),i.copy(o.boundingSphere),i.applyMatrix4(u),!1===r.ray.intersectsSphere(i))return;if(e.copy(u).invert(),t.copy(r.ray).applyMatrix4(e),null!==o.boundingBox&&!1===t.intersectsBox(o.boundingBox))return;var d=o.index;(b=o.attributes.position).instanceMatrix=s;var h,c=o.attributes.uv;if(null!==d)for(M=0,h=d.count;M<h;M+=3)f=d.getX(M),g=d.getX(M+1),v=d.getX(M+2),(m=p(this,r,t,b,c,f,g,v))&&(m.faceIndex=Math.floor(M/3),a.push(m));else for(M=0,h=b.count;M<h;M+=3)(m=p(this,r,t,b,c,f=M,g=M+1,v=M+2))&&(m.index=f,a.push(m))}else{if(u=this.matrixWorld,void 0===l)return;if(i.copy(this.computeBoundingSphere(n)),i.applyMatrix4(u),!1===r.ray.intersectsSphere(i))return;e.copy(u).invert(),t.copy(r.ray).applyMatrix4(e);var m,f,g,v,y=this.computeBoundingBox(n);if(!1===t.intersectsBox(y))return;var M,E,b=o.attributes.position,I=(c=o.attributes.uv,n.indexStart),x=n.indexStart+n.indexCount,T=o.getIndex().array;for(M=I,E=x;M<E;M+=3)f=T[M],g=T[M+1],v=T[M+2],(m=p(this,r,t,b,c,f,g,v))&&(m.faceIndex=Math.floor(M/3),a.push(m))}}}(),r.Object3DEx.prototype.minDistanceToTri=function(e,t,i){function r(e,t){return new THREE.Vector3(e.x-t.x,e.y-t.y,e.z-t.z)}function a(e,t){return new THREE.Vector3(e.x+t.x,e.y+t.y,e.z+t.z)}function n(e,t,i){return new THREE.Vector3(e.x+t.x*i,e.y+t.y*i,e.z+t.z*i)}function s(e,t){return e.x*t.x+e.y*t.y+e.z*t.z}function o(e,t){return new THREE.Vector3(e.y*t.z-e.z*t.y,e.z*t.x-e.x*t.z,e.x*t.y-e.y*t.x)}function l(e,t,i,l){var d,h,c,u,p,m,f=s(t,l),g=s(t,t),v=s(l,l),y=r(i,e),M=s(t,y),E=s(l,y);return(d=(M*v-E*f)/(g*v-f*f))<0||isNaN(d)?d=0:d>1&&(d=1),(h=(d*f-E)/v)<=0||isNaN(h)?(u=i,(d=M/g)<=0||isNaN(d)?(c=e,p=r(i,e)):d>=1?p=r(i,c=a(e,t)):(c=n(e,t,d),m=o(y,t),p=o(t,m))):h>=1?(u=a(i,l),(d=(f+M)/g)<=0||isNaN(d)?(c=e,p=r(u,e)):d>=1?p=r(u,c=a(e,t)):(c=n(e,t,d),m=o(y=r(u,e),t),p=o(t,m))):(u=n(i,l,h),d<=0||isNaN(d)?(c=e,m=o(y,l),p=o(l,m)):d>=1?(m=o(y=r(i,c=a(e,t)),l),p=o(l,m)):(c=n(e,t,d),s(p=o(t,l),y)<0&&p.multiplyScalar(-1))),{vec:p,closestP:c,closestQ:u}}function d(e,t){var i,a,d,h,c,u,p=[],m=[];p[0]=r(e[1],e[0]),p[1]=r(e[2],e[1]),p[2]=r(e[0],e[2]),m[0]=r(t[1],t[0]),m[1]=r(t[2],t[1]),m[2]=r(t[0],t[2]);for(var f=0,g=e[0].distanceToSquared(t[0])+1,v=0;v<3;v++)for(var y=0;y<3;y++){var M=l(e[v],p[v],t[y],m[y]);d=M.vec,i=M.closestP;var E=s(h=r(a=M.closestQ,i),h);if(E<=g){c=i.clone(),u=a.clone(),g=E;var b=s(r(e[(v+2)%3],i),d),I=s(r(t[(y+2)%3],a),d);if(b<=0&&I>=0)return{start:i.clone(),end:a.clone(),minDistance:Math.sqrt(E)};b<0&&(b=0),I>0&&(I=0),s(h,d)-b+I>0&&(f=1)}}var x=o(p[0],p[1]),T=s(x,x);if(T>1e-15){var _=[];h=r(e[0],t[0]),_[0]=s(h,x),h=r(e[0],t[1]),_[1]=s(h,x),h=r(e[0],t[2]),_[2]=s(h,x);var S=-1;if(_[0]>0&&_[1]>0&&_[2]>0?(S=_[0]<_[1]?0:1,_[2]<_[S]&&(S=2)):_[0]<0&&_[1]<0&&_[2]<0&&(S=_[0]>_[1]?0:1,_[2]>_[S]&&(S=2)),S>=0&&(f=1,s(h=r(t[S],e[0]),o(x,p[0]))>0&&s(h=r(t[S],e[1]),o(x,p[1]))>0&&s(h=r(t[S],e[2]),o(x,p[2]))>0))return i=n(t[S],x,_[S]/T),a=t[S].clone(),{start:i.clone(),end:a,minDistance:i.distanceTo(a)}}var C=o(m[0],m[1]),w=s(C,C);if(w>1e-15){var R=[];h=r(t[0],e[0]),R[0]=s(h,C),h=r(t[0],e[1]),R[1]=s(h,C),h=r(t[0],e[2]),R[2]=s(h,C);S=-1;if(R[0]>0&&R[1]>0&&R[2]>0?(S=R[0]<R[1]?0:1,R[2]<R[S]&&(S=2)):R[0]<0&&R[1]<0&&R[2]<0&&(S=R[0]>R[1]?0:1,R[2]>R[S]&&(S=2)),S>=0&&(f=1,s(h=r(e[S],t[0]),o(C,m[0]))>0&&s(h=r(e[S],t[1]),o(C,m[1]))>0&&s(h=r(e[S],t[2]),o(C,m[2]))>0))return{start:i=e[S].clone(),end:(a=n(e[S],C,R[S]/w)).clone(),minDistance:i.distanceTo(a)}}return f?(i=c,a=u,{start:c.clone(),end:u.clone(),minDistance:Math.sqrt(g)}):{start:c.clone(),end:u.clone(),minDistance:0}}var h=new THREE.Vector3,c=new THREE.Vector3,u=new THREE.Vector3;function p(e,t,i,r,a,n){h.fromBufferAttribute(t,i),c.fromBufferAttribute(t,r),u.fromBufferAttribute(t,a),n&&(h.applyMatrix4(n),c.applyMatrix4(n),u.applyMatrix4(n)),e.push(h),e.push(c),e.push(u)}for(var m={start:null,end:null,minDistance:Number.POSITIVE_INFINITY},f=this.geometry,g=f.attributes.position,v=t?t.indexStart:0,y=f.getIndex().array,M=v,E=t?t.indexStart+t.indexCount:y.length;M<E;M+=3){var b=[];p(b,g,y[M],y[M+1],y[M+2],i);var I=d(e,b);if(I.minDistance<=0)return m.minDistance=0,m;m.minDistance>I.minDistance&&(m.minDistance=I.minDistance,m.start=I.start.clone(),m.end=I.end.clone())}return m},r.Object3DEx.prototype.computeBoundingBox=function(e){var t,i,r=new THREE.Box3,a=this.geometry.attributes.position.array;return e?(t=e.positionStart,i=e.positionStart+e.positionCount):(t=0,i=a.length),this.setBoundingBoxFromArray(r,a,t,i),r},r.Object3DEx.prototype.computeBoundingSphere=function(e){var t,i,r=new THREE.Box3,a=new THREE.Vector3,n=this.geometry.attributes.position.array;e?(t=e.positionStart,i=e.positionStart+e.positionCount):(t=0,i=n.length);var s=new THREE.Sphere,o=s.center;this.setBoundingBoxFromArray(r,n,t,i),r.getCenter(o);for(var l=0,d=t,h=i;d<h;d+=3)a.x=n[d],a.y=n[d+1],a.z=n[d+2],l=Math.max(l,o.distanceToSquared(a));return s.radius=Math.sqrt(l),s},r.Object3DEx.prototype.setBoundingBoxFromArray=function(e,t,i,r){for(var a=1/0,n=1/0,s=1/0,o=-1/0,l=-1/0,d=-1/0,h=i,c=r;h<c;h+=3){var u=t[h],p=t[h+1],m=t[h+2];u<a&&(a=u),p<n&&(n=p),m<s&&(s=m),u>o&&(o=u),p>l&&(l=p),m>d&&(d=m)}e.min.set(a,n,s),e.max.set(o,l,d)}})(),r.MaterialEx=function(){this.materialDefaultParams={color:14540253,opacity:.5,transparent:!0,side:THREE.DoubleSide},this.material=r.MaterialUtil.createStandardMaterial(this.materialDefaultParams)},r.MaterialEx.prototype.destroy=function(){this.material=null},r.MaterialEx.prototype.resetColor=function(){this.material.color.setHex(this.materialDefaultParams.color)},r.MaterialEx.prototype.resetOpacity=function(){this.material.opacity=this.materialDefaultParams.opacity},r.MaterialEx.prototype.reset=function(){this.material.color.setHex(this.materialDefaultParams.color),this.material.opacity=this.materialDefaultParams.opacity,this.material.transparent=this.materialDefaultParams.transparent,this.material.side=this.materialDefaultParams.side,this.material.needsUpdate=!0},(()=>{let e=new THREE.Matrix4,t=new THREE.Ray,i=new THREE.Sphere,a=new THREE.Vector3,n=new THREE.Vector3;class s extends THREE.Points{constructor(e,t){super(e,t),this.pointIds=[],this.size=1}calcPositionAfterYOffset(t,i,r,a,n){let s=t.clone();return s.applyMatrix4(n),s.project(a),s.y+=i/r,s.unproject(a),s.applyMatrix4(e),s}raycast(r,n){const s=this.geometry,o=this.matrixWorld,l=this.size,d=r.camera,h=r.viewportSize.height;e.copy(o).invert(),null===s.boundingSphere&&s.computeBoundingSphere(),i.copy(s.boundingSphere);const c=i.center,u=this.calcPositionAfterYOffset(c,l,h,d,o),p=u.distanceToSquared(c);if(i.radius+=p,i.center.copy(u),i.applyMatrix4(o),!1===r.ray.intersectsSphere(i))return;t.copy(r.ray).applyMatrix4(e);let m=l;if(s.isBufferGeometry){const e=s.index,i=s.attributes,l=i.position.array;let c,u=!1;if(i.attrSize&&(u=!0,c=i.attrSize.array),null!==e){const i=e.array;i.length;for(const e of i)a.fromArray(l,3*e),u&&(m=c[e]),this.testPoint(a,m,e,h,d,o,t,r,n)}else for(var f=0,g=l.length/3;f<g;f++)a.fromArray(l,3*f),u&&(m=c[f]),this.testPoint(a,m,f,h,d,o,t,r,n)}else{const e=s.vertices;for(f=0,g=e.length;f<g;f++)this.testPoint(e[f],m,f,h,d,o,t,r,n)}}testPoint(e,t,i,r,a,s,o,l,d){const h=this.calcPositionAfterYOffset(e,t,r,a,s),c=h.distanceToSquared(e),u=o.distanceSqToPoint(h);if(u<c){o.closestPointToPoint(h,n),n.applyMatrix4(s);const e=l.ray.origin.distanceTo(n);if(e<l.near||e>l.far)return;d.push({id:this.pointIds[i],distance:e,distanceToRay:Math.sqrt(u),point:n.clone(),index:i,face:null,object:this})}}setAttributeSize(e,t){const i=this.geometry.attributes;i.attrSize&&(i.attrSize.array[e]=t,i.attrSize.needsUpdate=!0)}getAttributeSize(e){const t=this.geometry.attributes;let i=this.size;return t.attrSize&&(i=t.attrSize.array[e]),i}getAttributeHoverAnimation(e){const t=this.geometry.attributes;let i=!0;return t.attrHoverAnimation&&(i=t.attrHoverAnimation.array[e]),i}}r.PointsEx=s})(),(()=>{let e=new THREE.Matrix4,t=new THREE.Vector3;class i extends THREE.Mesh{constructor(e,t){super(e=e||r.GeomUtil.EmptyGeometry,t=t||r.MaterialUtil.getDefaultStandardMaterial()),this.type="MeshEx",this.matrixAutoUpdate=!1,this.originalId=void 0,this.pickable=!0}init(e){e&&e.parent&&e.parent.add(this)}destroy(){this.parent&&this.parent.remove(this),this.userData&&(this.userData=null),this.geometry=null,this.material=null}spawn(e){void 0!==e.userId?this.name=e.userId:void 0!==e.nodeId&&(this.name=e.nodeId),e.geometry&&(this.geometry=e.geometry),e.material&&(this.material=e.material),e.matrix?(this.matrix.copy(e.matrix),this.updateMatrixWorld(!0)):(this.matrix.identity(),this.updateMatrixWorld(!0)),this.databagId=r.Utils.isDefined(e.databagId)?e.databagId:"",this.fileId=r.Utils.isDefined(e.fileId)?e.fileId:"",e.userData?this.userData=e.userData:this.userData&&(this.userData=null),e.originalId&&(this.originalId=e.originalId),null!=e.visible&&(this.visible=e.visible),null!=e.isMesh&&(this.isMesh=e.isMesh),null!=e.isLine&&(this.isLine=e.isLine),null!=e.isLineSegments&&(this.isLineSegments=e.isLineSegments),null!=e.pickable?this.pickable=e.pickable:this.pickable=!0,this.groupOrder=e.groupOrder||r.EnumRenderOrder.Component,this.renderOrder=e.renderOrder||r.EnumRenderOrder.Component,this.frustumCulled=!1,this.material.visible=!0}clear(){this.geometry=r.GeomUtil.EmptyGeometry,this.material=r.MaterialUtil.DefaultMaterial,this.visible=!0,this.frustumCulled=!0,this.material.visible=!1}isVisible(){return this.visible}intersectBoxWithDistance(e,t){const i=new THREE.Box3;return((e,t)=>{var r=this.geometry,a=this.material,n=this.matrixWorld;return t&&(n=new THREE.Matrix4).multiplyMatrices(this.matrixWorld,t),void 0===a?-1:(r.boundingBox||r.computeBoundingBox(),i.copy(r.boundingBox),i.applyMatrix4(n),e.ray.intersectBoxWithDistance(i))})(e,t)}intersectBoxWithDistanceByIndices(e,t){var i=this.matrixWorld,r=this.computeBoundingBox(t);return r.applyMatrix4(i),e.ray.intersectBoxWithDistance(r)}intersectBoxWithClipPlane(e,t){var i=this.matrixWorld,r=t.boundingBox.clone();return r.applyMatrix4(i),r.intersectsPlane(e)}intersectBoxWithPlaneMesh(e,t){const i=this.matrixWorld;let a=t.boundingBox.clone();a.applyMatrix4(i);const n=e.matrixWorld,s=e.geometry.attributes.position;let o=[];for(let e=0;e<s.count;e++)o.push((new THREE.Vector3).fromBufferAttribute(s,e));const l=o.map((e=>e.clone().applyMatrix4(n))),d=e.geometry.index.array,h=d.length;for(let e=0;e<h/3;++e){const t=(new THREE.Triangle).setFromPointsAndIndices(l,d[e],d[e+1],d[e+2]);if(r.GeomUtil.boxIntersectsTriangle(a,t))return!0}return!1}_traverIntersectionPoints(i,r,a,n){e.copy(this.matrixWorld).invert();var s=i.clone();function o(e,i,r){t=i.intersectLine(e,t),t?n&&n(t,r):t=new THREE.Vector3}s=s.applyMatrix4(e);for(var l,d,h,c=this.geometry.getIndex().array,u=this.geometry.getAttribute("position").array,p=a?0:r.indexStart,m=a?c.length:r.indexStart+r.indexCount,f=new THREE.Vector3,g=new THREE.Vector3,v=new THREE.Vector3,y=new THREE.Line3,M=new THREE.Line3,E=new THREE.Line3,b=p,I=m;b<I;b+=3){const e=b/3;l=3*c[b],d=3*c[b+1],h=3*c[b+2],f.set(u[l],u[l+1],u[l+2]),g.set(u[d],u[d+1],u[d+2]),v.set(u[h],u[h+1],u[h+2]),a&&(f.applyMatrix4(r.matrix),g.applyMatrix4(r.matrix),v.applyMatrix4(r.matrix)),y.set(f,g),M.set(g,v),E.set(v,f),o(y,s,e),o(M,s,e),o(E,s,e)}}getIntersectionPoints(e,t,i,r){this._traverIntersectionPoints(e,t,r,((e,t)=>{i.push(e.x,e.y,e.z)}))}getIntersectionContours(e,t,i,a){let n=[];if(this._traverIntersectionPoints(e,t,a,((e,t)=>{let i=e.clone();i.faceIndex=t,i.checked=!1,n.push(i)})),0===n.length)return;r.ClipPlaneContourManager.getContours(n,[],!0).map((e=>{let t=[];e.map((e=>{t.push(e)})),i.push(t)}))}intersectByBox(t,i,r,a){var n=new THREE.Vector3,s=new THREE.Vector3,o=new THREE.Vector3;let l=new THREE.Triangle,d=(e,t,i,r,a)=>(n.fromBufferAttribute(t,i),s.fromBufferAttribute(t,r),o.fromBufferAttribute(t,a),l.set(n,s,o),e.intersectsTriangle(l));var h=this.geometry,c={distance:-1};if(void 0===this.material)return!1;if(a){e.copy(this.matrix).invert();let n=t.clone();n.applyMatrix4(e),e.copy(a).invert(),n.applyMatrix4(e);var u=this.computeBoundingBox(r);if(!1===n.intersectsBox(u))return!1;var p,m=h.index;if((v=h.attributes.position).instanceMatrix=a,null!==m){for(f=0,p=m.count;f<p;f+=3)if(d(n,v,m.getX(f),m.getX(f+1),m.getX(f+2)))return i.push(c),!0}else for(f=0,p=v.count;f<p;f+=3)if(d(n,v,f,f+1,f+2))return i.push(c),!0}else{let e=t;u=this.computeBoundingBox(r);if(!1===e.intersectsBox(u))return!1;var f,g,v=h.attributes.position,y=r.indexStart,M=r.indexStart+r.indexCount,E=h.getIndex().array;for(f=y,g=M;f<g;f+=3)if(d(e,v,E[f],E[f+1],E[f+2]))return i.push(c),!0}return!1}raycastByIndices(t,i,r,a,n){var s=new THREE.Ray,o=new THREE.Sphere,l=new THREE.Vector3,d=new THREE.Vector3,h=new THREE.Vector3,c=new THREE.Vector2,u=new THREE.Vector2,p=new THREE.Vector2,m=new THREE.Vector3,f=new THREE.Vector3,g=new THREE.Vector3,v=new THREE.Matrix4;let y=(e,t,i,r,a,n,s,o)=>{let y=new THREE.Vector3;l.fromBufferAttribute(r,n),d.fromBufferAttribute(r,s),h.fromBufferAttribute(r,o);var M,E,b,I,x,T,_,S=((e,t,i,r,a,n,s)=>{var o=e.material;if(null===(o instanceof Array?i.intersectTriangle(r,a,n,o[0].side!==THREE.DoubleSide,s):o.side===THREE.BackSide?i.intersectTriangle(n,a,r,!0,s):i.intersectTriangle(r,a,n,o.side!==THREE.DoubleSide,s)))return null;g.copy(s),g.applyMatrix4(v);var l=t.ray.origin.distanceTo(g);return l<t.near||l>t.far?null:{distance:l,point:g.clone(),object:e}})(e,t,i,l,d,h,f);if(S){if(a&&a.array&&a.array.length&&(c.fromBufferAttribute(a,n),u.fromBufferAttribute(a,s),p.fromBufferAttribute(a,o),S.uv=(M=f,E=l,b=d,I=h,x=c,T=u,_=p,THREE.Triangle.getBarycoord(M,E,b,I,m),x.multiplyScalar(m.x),T.multiplyScalar(m.y),_.multiplyScalar(m.z),x.add(T).add(_),x.clone())),r.instanceMatrix){var C=l.clone().applyMatrix4(r.instanceMatrix),w=d.clone().applyMatrix4(r.instanceMatrix),R=h.clone().applyMatrix4(r.instanceMatrix);S.face=new THREE.Face3(n,s,o,THREE.Triangle.getNormal(C,w,R,y))}else S.face=new THREE.Face3(n,s,o,THREE.Triangle.getNormal(l,d,h,y));S.faceIndex=n}return S};return((t,i,r,a,n)=>{var l=this.geometry,d=this.material;if(a){l=this.geometry,d=this.material;if((v=new THREE.Matrix4).multiplyMatrices(this.matrixWorld,a),void 0===d)return;if(null===l.boundingSphere&&l.computeBoundingSphere(),o.copy(l.boundingSphere),o.applyMatrix4(v),!1===t.ray.intersectsSphere(o))return;if(e.copy(v).invert(),s.copy(t.ray).applyMatrix4(e),null!==l.boundingBox&&!1===s.intersectsBox(l.boundingBox))return;var h=l.index;(I=l.attributes.position).instanceMatrix=a;var c,u=l.attributes.uv;if(null!==h)for(E=0,c=h.count;E<c;E+=3)m=h.getX(E),f=h.getX(E+1),g=h.getX(E+2),(p=y(this,t,s,I,u,m,f,g))&&(p.faceIndex=Math.floor(E/3),i.push(p));else for(E=0,c=I.count;E<c;E+=3)(p=y(this,t,s,I,u,m=E,f=E+1,g=E+2))&&(p.index=m,i.push(p))}else{if(v=this.matrixWorld,void 0===d)return;if(o.copy(this.computeBoundingSphere(r)),o.applyMatrix4(v),!1===t.ray.intersectsSphere(o))return;e.copy(v).invert(),s.copy(t.ray).applyMatrix4(e);var p,m,f,g,M=this.computeBoundingBox(r);if(!1===s.intersectsBox(M))return;var E,b,I=l.attributes.position,x=(u=l.attributes.uv,r.indexStart),T=r.indexStart+r.indexCount,_=l.getIndex().array;for(E=x,b=T;E<b;E+=3)m=_[E],f=_[E+1],g=_[E+2],(p=y(this,t,s,I,u,m,f,g))&&(p.faceIndex=Math.floor(E/3),i.push(p))}})(t,i,r,a)}raycastByIndices2(e,t,i,r){var a=new THREE.Matrix4,n=new THREE.Ray,s=new THREE.Sphere,o=new THREE.Vector3,l=new THREE.Vector3,d=new THREE.Vector3,h=new THREE.Vector2,c=new THREE.Vector2,u=new THREE.Vector2,p=new THREE.Vector3,m=new THREE.Vector3,f=new THREE.Vector3,g=new THREE.Matrix4;let v=(e,t,i,r,a,n,s,v)=>{let y=new THREE.Vector3;o.fromBufferAttribute(r,n),l.fromBufferAttribute(r,s),d.fromBufferAttribute(r,v);var M,E,b,I,x,T,_,S=((e,t,i,r,a,n,s)=>{var o=e.material;if(null===(o instanceof Array?i.intersectTriangle(r,a,n,o[0].side!==THREE.DoubleSide,s):o.side===THREE.BackSide?i.intersectTriangle(n,a,r,!0,s):i.intersectTriangle(r,a,n,o.side!==THREE.DoubleSide,s)))return null;f.copy(s),f.applyMatrix4(g);var l=t.ray.origin.distanceTo(f);return l<t.near||l>t.far?null:{distance:l,point:f.clone(),object:e}})(e,t,i,o,l,d,m);if(S){if(a&&a.array&&a.array.length&&(h.fromBufferAttribute(a,n),c.fromBufferAttribute(a,s),u.fromBufferAttribute(a,v),S.uv=(M=m,E=o,b=l,I=d,x=h,T=c,_=u,THREE.Triangle.getBarycoord(M,E,b,I,p),x.multiplyScalar(p.x),T.multiplyScalar(p.y),_.multiplyScalar(p.z),x.add(T).add(_),x.clone())),r.instanceMatrix){var C=o.clone().applyMatrix4(r.instanceMatrix),w=l.clone().applyMatrix4(r.instanceMatrix),R=d.clone().applyMatrix4(r.instanceMatrix);S.face=new THREE.Face3(n,s,v,THREE.Triangle.getNormal(C,w,R,y))}else S.face=new THREE.Face3(n,s,v,THREE.Triangle.getNormal(o,l,d,y));S.faceIndex=n}return S};return((e,t,i,r)=>{var o=this.geometry,l=this.material;if(r=!!r,i.isInstanced){if(void 0===i.matrix)return;if(g.multiplyMatrices(this.matrixWorld,i.matrix),void 0===l)return;if(r&&(null===o.boundingSphere&&o.computeBoundingSphere(),s.copy(o.boundingSphere),s.applyMatrix4(g),!1===e.ray.intersectsSphere(s)))return;if(a.copy(g).invert(),n.copy(e.ray).applyMatrix4(a),r&&null!==o.boundingBox&&!1===n.intersectsBox(o.boundingBox))return;var d=o.index;(b=o.attributes.position).instanceMatrix=i.matrix;var h,c=o.attributes.uv;if(null!==d)for(M=0,h=d.count;M<h;M+=3)m=d.getX(M),f=d.getX(M+1),y=d.getX(M+2),(p=v(this,e,n,b,c,m,f,y))&&(p.faceIndex=Math.floor(M/3),t.push(p));else for(M=0,h=b.count;M<h;M+=3)(p=v(this,e,n,b,c,m=M,f=M+1,y=M+2))&&(p.index=m,t.push(p))}else if(i.matrix?g.multiplyMatrices(this.matrixWorld,i.matrix):g=this.matrixWorld,void 0!==l&&(!r||(s.copy(this.computeBoundingSphere(i)),s.applyMatrix4(g),!1!==e.ray.intersectsSphere(s)))){if(a.copy(g).invert(),n.copy(e.ray).applyMatrix4(a),r){var u=this.computeBoundingBox(i);if(!1===n.intersectsBox(u))return}var p,m,f,y,M,E,b=o.attributes.position,I=(c=o.attributes.uv,i.indexStart),x=i.indexStart+i.indexCount,T=o.getIndex().array;for(M=I,E=x;M<E;M+=3)m=T[M],f=T[M+1],y=T[M+2],(p=v(this,e,n,b,c,m,f,y))&&(p.faceIndex=Math.floor(M/3),t.push(p))}})(e,t,i,r)}computeBoundingBox(e){var t,i,r=new THREE.Box3,a=this.geometry.attributes.position.array;return e?(t=e.positionStart,i=e.positionStart+e.positionCount):(t=0,i=a.length),this.setBoundingBoxFromArray(r,a,t,i),r}computeBoundingSphere(e){var t,i,r=new THREE.Box3,a=new THREE.Vector3,n=this.geometry.attributes.position.array;e?(t=e.positionStart,i=e.positionStart+e.positionCount):(t=0,i=n.length);var s=new THREE.Sphere,o=s.center;this.setBoundingBoxFromArray(r,n,t,i),r.getCenter(o);for(var l=0,d=t,h=i;d<h;d+=3)a.x=n[d],a.y=n[d+1],a.z=n[d+2],l=Math.max(l,o.distanceToSquared(a));return s.radius=Math.sqrt(l),s}setBoundingBoxFromArray(e,t,i,r){for(var a=1/0,n=1/0,s=1/0,o=-1/0,l=-1/0,d=-1/0,h=i,c=r;h<c;h+=3){var u=t[h],p=t[h+1],m=t[h+2];u<a&&(a=u),p<n&&(n=p),m<s&&(s=m),u>o&&(o=u),p>l&&(l=p),m>d&&(d=m)}e.min.set(a,n,s),e.max.set(o,l,d)}}r.MeshEx=i})(),function(){class e extends THREE.LineSegments{constructor(e,t){super(e,t),this.type="SkinnedMesh",this.bindMode="attached",this.isSkinnedMesh=!0,this.bindMatrix=new THREE.Matrix4,this.bindMatrixInverse=new THREE.Matrix4,this.init()}init(){const e=this.initBones(),t=new THREE.Skeleton(e);this.bind(t,this.matrixWorld),this.normalizeSkinWeights()}initBones(){var e,t,i,r,a=[];if(this.geometry&&void 0!==this.geometry.bones){for(i=0,r=this.geometry.bones.length;i<r;i++)t=this.geometry.bones[i],e=new THREE.Bone,a.push(e),e.name=t.name,e.position.fromArray(t.pos),e.quaternion.fromArray(t.rotq),void 0!==t.scl&&e.scale.fromArray(t.scl);for(i=0,r=this.geometry.bones.length;i<r;i++)-1!==(t=this.geometry.bones[i]).parent&&null!==t.parent&&void 0!==a[t.parent]?a[t.parent].add(a[i]):this.add(a[i])}return this.updateMatrixWorld(!0),a}bind(e,t){this.skeleton=e,void 0===t&&(this.updateMatrixWorld(!0),this.skeleton.calculateInverses(),t=this.matrixWorld),this.bindMatrix.copy(t),this.bindMatrixInverse.copy(t).invert()}pose(){this.skeleton.pose()}normalizeSkinWeights(){var e,t;if(this.geometry&&this.geometry.isGeometry)for(t=0;t<this.geometry.skinWeights.length;t++){var i=this.geometry.skinWeights[t];(e=1/i.manhattanLength())!==1/0?i.multiplyScalar(e):i.set(1,0,0,0)}else if(this.geometry&&this.geometry.isBufferGeometry){var r=new THREE.Vector4,a=this.geometry.attributes.skinWeight;for(t=0;t<a.count;t++)r.x=a.getX(t),r.y=a.getY(t),r.z=a.getZ(t),r.w=a.getW(t),(e=1/r.manhattanLength())!==1/0?r.multiplyScalar(e):r.set(1,0,0,0),a.setXYZW(t,r.x,r.y,r.z,r.w)}}updateMatrixWorld(e){THREE.LineSegments.prototype.updateMatrixWorld.call(this,e),"attached"===this.bindMode?this.bindMatrixInverse.copy(this.matrixWorld).invert():"detached"===this.bindMode?this.bindMatrixInverse.copy(this.bindMatrix).invert():console.warn("THREE.SkinnedMesh: Unrecognized bindMode: "+this.bindMode)}clone(){return new this.constructor(this.geometry,this.material).copy(this)}}r.SkinnedLine=e,r.SkinnedLineEx=class extends e{constructor(e,t){super(e,t)}init(){this.bindMatrixInverseReal=new THREE.Matrix4;const e=this.initBones(),t=new THREE.SkeletonEx(e);this.bind(t,this.matrixWorld),this.normalizeSkinWeights()}getBindMatrixInverse(){return this.bindMatrixInverseReal}bind(e,t){this.skeleton&&(this.skeleton.associatedSkinnedMesh=null),super.bind(e,t),this.bindMatrixInverseReal.copy(this.bindMatrix).invert(),this.skeleton.associatedSkinnedMesh=this}updateMatrixWorld(e){THREE.LineSegments.prototype.updateMatrixWorld.call(this,e),"attached"===this.bindMode?(this.bindMatrixInverseReal.copy(this.matrixWorld).invert(),this.bindMatrixInverse.identity()):"detached"===this.bindMode?(this.bindMatrixInverse.copy(this.bindMatrix).invert(),this.bindMatrixInverseReal.copy(this.bindMatrix).invert()):console.warn("THREE.SkinnedMesh: Unrecognized bindMode: "+this.bindMode)}}}(),function(){const e=new THREE.Vector3,t=new THREE.Vector4,i=new THREE.Vector4,r=new THREE.Vector3,a=new THREE.Matrix4;class n extends THREE.SkinnedMesh{constructor(e,t){super(e,t),this.isSkinnedMeshEx=!0,this.bindMatrixInverseReal=new THREE.Matrix4}getBindMatrixInverse(){return this.bindMatrixInverseReal}copy(e){super.copy(e),this.bindMatrixInverseReal.copy(e.bindMatrixInverseReal)}bind(e,t){this.skeleton&&(this.skeleton.associatedSkinnedMesh=null),super.bind(e,t),this.bindMatrixInverseReal.copy(this.bindMatrix).invert(),this.skeleton.associatedSkinnedMesh=this}updateMatrixWorld(e){THREE.Mesh.prototype.updateMatrixWorld.call(this,e),"attached"===this.bindMode?(this.bindMatrixInverseReal.copy(this.matrixWorld).invert(),this.bindMatrixInverse.identity()):"detached"===this.bindMode?(this.bindMatrixInverse.copy(this.bindMatrix).invert(),this.bindMatrixInverseReal.copy(this.bindMatrix).invert()):console.warn("THREE.SkinnedMesh: Unrecognized bindMode: "+this.bindMode)}boneTransform(n,s){const o=this.skeleton,l=this.geometry;t.fromBufferAttribute(l.attributes.skinIndex,n),i.fromBufferAttribute(l.attributes.skinWeight,n),e.fromBufferAttribute(l.attributes.position,n).applyMatrix4(this.bindMatrix),s.set(0,0,0);for(let n=0;n<4;n++){const l=i.getComponent(n);if(0!==l){const i=t.getComponent(n);a.multiplyMatrices(o.bones[i].matrixWorld,o.boneInverses[i]),s.addScaledVector(r.copy(e).applyMatrix4(a),l)}}return s.applyMatrix4(this.bindMatrixInverseReal)}}THREE.SkinnedMeshEx=n}(),function(){const e=new THREE.Matrix4,t=new THREE.Matrix4;class i extends THREE.Skeleton{constructor(e=[],t=[]){super(e,t),this.isSkinnedMeshEx=!0,this.associatedSkinnedMesh=null}getBindMatrixInverse(){return this.associatedSkinnedMesh?this.associatedSkinnedMesh.getBindMatrixInverse():void 0}update(){const i=this.bones,r=this.boneInverses,a=this.boneMatrices,n=this.boneTexture,s=this.getBindMatrixInverse();for(let n=0,o=i.length;n<o;n++){const o=i[n]?i[n].matrixWorld:t;e.multiplyMatrices(o,r[n]),s&&e.premultiply(s),e.toArray(a,16*n)}null!==n&&(n.needsUpdate=!0)}}THREE.SkeletonEx=i}(),THREE.Wireframe=function(e,t){THREE.Mesh.call(this),this.type="Wireframe",this.geometry=void 0!==e?e:new THREE.LineSegmentsGeometry,this.material=void 0!==t?t:new THREE.LineMaterial({color:16777215*Math.random()})},THREE.Wireframe.prototype=Object.assign(Object.create(THREE.Mesh.prototype),{constructor:THREE.Wireframe,isWireframe:!0,computeLineDistances:(_=new THREE.Vector3,S=new THREE.Vector3,function(){for(var e=this.geometry,t=e.attributes.instanceStart,i=e.attributes.instanceEnd,r=new Float32Array(2*t.data.count),a=0,n=0,s=t.data.count;a<s;a++,n+=2)_.fromBufferAttribute(t,a),S.fromBufferAttribute(i,a),r[n]=0===n?0:r[n-1],r[n+1]=r[n]+_.distanceTo(S);var o=new THREE.InstancedInterleavedBuffer(r,2,1);return e.setAttribute("instanceDistanceStart",new THREE.InterleavedBufferAttribute(o,1,0)),e.setAttribute("instanceDistanceEnd",new THREE.InterleavedBufferAttribute(o,1,1)),this}),copy:function(e){return this}}),THREE.WireframeGeometry2=function(e){THREE.LineSegmentsGeometry.call(this),this.type="WireframeGeometry2",this.fromWireframeGeometry(new THREE.WireframeGeometry(e))},THREE.WireframeGeometry2.prototype=Object.assign(Object.create(THREE.LineSegmentsGeometry.prototype),{constructor:THREE.WireframeGeometry2,isWireframeGeometry2:!0,copy:function(e){return this}}),function(){class e extends THREE.LineSegments{constructor(e,t){super((new THREE.BufferGeometry).setAttribute("position",new THREE.BufferAttribute(new Float32Array(72),3)),new THREE.LineBasicMaterial({color:t})),void 0!==e&&this.updateBBox(e)}unload(){}updateBBox(e){var t=e.min,i=e.max,r=this.geometry.attributes.position.array;r[0]=i.x,r[1]=i.y,r[2]=i.z,r[3]=t.x,r[4]=i.y,r[5]=i.z,r[6]=t.x,r[7]=i.y,r[8]=i.z,r[9]=t.x,r[10]=t.y,r[11]=i.z,r[12]=t.x,r[13]=t.y,r[14]=i.z,r[15]=i.x,r[16]=t.y,r[17]=i.z,r[18]=i.x,r[19]=t.y,r[20]=i.z,r[21]=i.x,r[22]=i.y,r[23]=i.z,r[24]=i.x,r[25]=i.y,r[26]=t.z,r[27]=t.x,r[28]=i.y,r[29]=t.z,r[30]=t.x,r[31]=i.y,r[32]=t.z,r[33]=t.x,r[34]=t.y,r[35]=t.z,r[36]=t.x,r[37]=t.y,r[38]=t.z,r[39]=i.x,r[40]=t.y,r[41]=t.z,r[42]=i.x,r[43]=t.y,r[44]=t.z,r[45]=i.x,r[46]=i.y,r[47]=t.z,r[48]=i.x,r[49]=i.y,r[50]=i.z,r[51]=i.x,r[52]=i.y,r[53]=t.z,r[54]=t.x,r[55]=i.y,r[56]=i.z,r[57]=t.x,r[58]=i.y,r[59]=t.z,r[60]=t.x,r[61]=t.y,r[62]=i.z,r[63]=t.x,r[64]=t.y,r[65]=t.z,r[66]=i.x,r[67]=t.y,r[68]=i.z,r[69]=i.x,r[70]=t.y,r[71]=t.z,this.geometry.attributes.position.needsUpdate=!0,this.geometry.computeBoundingBox(),this.geometry.computeBoundingSphere(),this.matrixAutoUpdate=!1}}r.BBoxNode=e}(),THREE.PlaneBufferGeometry2=function(e,t,i){THREE.BufferGeometry.call(this),this.type="PlaneBufferGeometry2";let r=e[0],a=e[1],n=e[2],s=a.clone().distanceTo(n),o=r.clone().distanceTo(a),l=n.clone().sub(a).normalize(),d=a.clone().sub(r).normalize();var h,c,u=Math.floor(t)||1,p=Math.floor(i)||1,m=u+1,f=p+1,g=s/u,v=o/p,y=[],M=[],E=[],b=[];let I=e[0].clone(),x=l.clone().cross(d).normalize();for(c=0;c<f;c++){let e=d.clone().multiplyScalar(c*v);for(h=0;h<m;h++){let t=l.clone().multiplyScalar(h*g),i=I.clone().add(t.add(e));M.push(i.x,i.y,i.z),E.push(x),b.push(h/u),b.push(1-c/p)}}for(c=0;c<p;c++)for(h=0;h<u;h++){var T=h+m*c,_=h+m*(c+1),S=h+1+m*(c+1),C=h+1+m*c;y.push(T,_,C),y.push(_,S,C)}this.setIndex(y),this.setAttribute("position",new THREE.Float32BufferAttribute(M,3)),this.setAttribute("normal",new THREE.Float32BufferAttribute(E,3)),this.setAttribute("uv",new THREE.Float32BufferAttribute(b,2))},THREE.PlaneBufferGeometry2.prototype=Object.create(THREE.BufferGeometry.prototype),THREE.PlaneBufferGeometry2.prototype.constructor=THREE.PlaneBufferGeometry2,function(){var e=[0,2,1,0,3,2,0,7,3,0,4,7,0,5,4,0,1,5,5,7,4,5,6,7,5,2,6,5,1,2,3,6,2,3,7,6],t=e.length,i=1e-5,a=Math.cos(THREE.Math.degToRad(30)),n=Math.cos(THREE.Math.degToRad(150)),s=new r.GIS.Cartographic,o=new r.GIS.Cartographic,l=[s,o],d=new r.GIS.Rectangle;class h extends THREE.BufferGeometry{constructor(e){super(),this.type="GroundCurveGeometry",this.curve=void 0,this.viewer=void 0,this.tileManager=void 0,this.curveType=void 0,this.minHeight=-1e3,this.maxHeight=1e3,this.lowest=100,this.localPositions=[],this._initialized=!1,this._options=e;var t=this;r.GIS.ApproximateTerrainHeights.initialize().then((()=>{var i=t.createCurve(e),r=t.createGeometry(i),a=t.createAttributes(r);for(var n in t.setIndex(a.index),a.attributes)t.setAttribute(n,new THREE.Float32BufferAttribute(a.attributes[n].array,a.attributes[n].itemSize));t.computeBoundingSphere(),t._initialized||(t._initialized=!0,t.viewer.render())}))}createAttributes(r){for(var a=r.bottomPositionsArray,n=r.topPositionsArray,s=r.normalsArray,o=a.length/3-1,l=8*o,d=2*l,c=3*l,u=new Array(36*o),p=new Array(c),m=new Array(c),f=new Array(c),g=new Array(c),v=new Array(c),y=new Array(c),M=new Array(d),E=0,b=new THREE.Vector3,I=new THREE.Vector3,x=n.length/3,T=0,_=0;_<x-1;_++)b.fromArray(n,T),I.fromArray(n,T+3),E+=b.distanceTo(I),T+=3;var S=0,C=new THREE.Vector3,w=new THREE.Vector3,R=new THREE.Vector3,B=new THREE.Vector3,L=new THREE.Vector3,O=new THREE.Vector3,P=0,D=0,A=0,N=0,H=0,U=0,F=i,k=!1;w.fromArray(a,P),B.fromArray(n,P),O.fromArray(s,P),P=3;for(_=0;_<o;_++){C.copy(w),R.copy(B),L.copy(O),k&&L.negate(),w.fromArray(a,P),B.fromArray(n,P),O.fromArray(s,P),k=h._breakMiter(O,C,w,B);var G=R.distanceTo(B),V=new THREE.Vector3;V.subVectors(w,C);var j=new THREE.Vector3;j.copy(V),j.normalize();var z=new THREE.Vector3;z.subVectors(R,C),z.normalize();var W=new THREE.Vector3;W.crossVectors(j,z),W.normalize();var q=new THREE.Vector3;q.crossVectors(z,L),q.normalize();var X=new THREE.Vector3;X.subVectors(B,w),X.normalize();var Y=new THREE.Vector3;Y.crossVectors(O,X),Y.normalize();for(var K=G/E,Z=S/E,$=0;$<8;$++){A=H+3*$,N=U+2*$;var Q=$<4?1:-1,J=2===$||3===$||6===$||7===$?1:-1;C.toArray(m,A),q.toArray(f,A),Y.toArray(g,A),V.toArray(y,A),W.toArray(v,A);var ee=new THREE.Vector2;ee.x=K*Q;var te=Z*J;0===te&&J<0&&(te=9),ee.y=te,ee.toArray(M,N)}var ie=new THREE.Vector3,re=new THREE.Vector3,ae=new THREE.Vector3,ne=new THREE.Vector3;ie.copy(C),re.copy(w),ae.copy(R),ne.copy(B);var se=this._getMinMaxHeight(C,w);se&&(ie.y=se.minimumTerrainHeight,re.y=se.minimumTerrainHeight,ae.y=se.maximumTerrainHeight,ne.y=se.maximumTerrainHeight,this.lowest=Math.min(this.lowest,ie.y),this.lowest=Math.min(this.lowest,re.y)),ie.addScaledVector(W,F),re.addScaledVector(W,F),ne.addScaledVector(W,F),ae.addScaledVector(W,F),ie.toArray(p,D),re.toArray(p,D+3),ne.toArray(p,D+6),ae.toArray(p,D+9),ie.addScaledVector(W,-2e-5),re.addScaledVector(W,-2e-5),ne.addScaledVector(W,-2e-5),ae.addScaledVector(W,-2e-5),ie.toArray(p,D+12),re.toArray(p,D+15),ne.toArray(p,D+18),ae.toArray(p,D+21),P+=3,D+=24,U+=16,H+=24,S+=G}P=0;var oe=0;for(_=0;_<o;_++){for($=0;$<t;$++)u[P+$]=e[$]+oe;oe+=8,P+=t}return{index:u,attributes:{position:{array:p,itemSize:3},startPosition:{array:m,itemSize:3},startNormal:{array:f,itemSize:3},endNormal:{array:g,itemSize:3},rightNormal:{array:v,itemSize:3},forwardOffset:{array:y,itemSize:3},texcoordNormalization:{array:M,itemSize:2},textureUV:{array:this._createTextureUVAttribute(p),itemSize:2}}}}_distanceTo(e,t,i,r){const a=i-e,n=r-t,s=a*a+n*n;return Math.sqrt(s)}_createTextureUVAttribute(e){let t=[];var i=[0];if(e.length&&e[0]instanceof THREE.Vector3)for(var r=0;r<e.length;r++){var a=e[r];if(t.push(a.x,a.y,a.z),t.push(a.x,a.y,a.z),r>0){let t=i[i.length-1]+this._distanceTo(a.x,a.y,a.z,e[r-1].x,e[r-1].y,e[r-1].z);i.push(t)}}else for(r=0;r<e.length;r+=3)if(t.push(e[r],e[r+1],e[r+2]),t.push(e[r],e[r+1],e[r+2]),r>0){let t=i[i.length-1]+this._distanceTo(e[r-3],e[r-2],e[r-1],e[r],e[r+1],e[r+2]);i.push(t)}const n=t.length/6;let s=[];const o=i[i.length-1];for(let e=0;e<n;e++){let t=i[e]/o;s.push(0,t),s.push(1,t)}return s}createCurve(e){if(!this.viewer){this.viewer=e.viewer;var t=this.viewer.modelManager.modelCollection,i=this;t.traverse((e=>{e.isDemLayer&&(i.tileManager=e.tileManager)}))}if(e.points){var r=e.points;this.localPositions=[];for(var a=0;a<r.length;a++)this.localPositions.push(this.viewer.worldToDrawing(r[a]));var n=new THREE.CatmullRomCurve3(this.localPositions);this.curve=n}n=this.curve;var s=e.type;this.curveType=s,n.tension=0,n.type="polyline"==s?"catmullrom":"centripetal";var o="polyline"==s?e.points.length:e.divisions,l="polyline"==s?this.localPositions:n.getPoints(o);for(a=0;a<l.length;a++){var d=l[a];this.minHeight=Math.min(this.minHeight,d.y),this.maxHeight=Math.max(this.maxHeight,d.y)}return l}createGeometry(e){for(var t=e.length,i=new Array(3*t),r=new Array(3*t),a=new Array(3*t),n=0,s=new THREE.Vector3,o=new THREE.Vector3,l=new THREE.Vector3,d=new THREE.Vector3,c=new THREE.Vector3,u=new THREE.Vector3,p=this.minHeight,m=this.maxHeight,f=0;f<t;f++)o.copy(e[f]),o.y=p,s.copy(e[f]),s.y=m,0==f?(u.copy(e[f+1]),u.y=p,l=h._computeRightNormal(o,s,u)):f==e.length-1?(d.copy(e[f-1]),d.y=p,c.copy(e[f-1]),c.y=m,l=h._computeRightNormal(d,c,o)):(d.copy(e[f-1]),d.y=p,u.copy(e[f+1]),u.y=p,l=h._computeVertexMiterNormal(d,o,s,u)),s.toArray(r,n),o.toArray(i,n),l.toArray(a,n),n+=3;return{bottomPositionsArray:i,topPositionsArray:r,normalsArray:a}}updateGeometry(e){var t=this;r.GIS.ApproximateTerrainHeights.initialize().then((()=>{var i=e||{};i.type=i.curveType||t.curveType,i.points=i.points||t._options.points;var r=t.createCurve(i),a=t.createGeometry(r),n=t.createAttributes(a);for(var s in t.setIndex(n.index),n.attributes)t.deleteAttribute(s),t.setAttribute(s,new THREE.Float32BufferAttribute(n.attributes[s].array,n.attributes[s].itemSize));t.computeBoundingSphere(),t._initialized||(t._initialized=!0,t.viewer.render())}))}static _computeRightNormal(e,t,i){var r=h._direction(i,e),a=h._direction(t,e),n=new THREE.Vector3;return n.crossVectors(r,a),n.normalize(),n}static _computeVertexMiterNormal(e,t,r,a){var n=h._direction(r,t),s=h._tangentDirection(e,t,n),o=h._tangentDirection(a,t,n),l=new THREE.Vector3;if(h._equalsEpsilon(s.dot(o),-1,i))return l.crossVectors(n,s),l.normalize(),l;l.addVectors(o,s),l.normalize();var d=new THREE.Vector3;return d.crossVectors(n,l),o.dot(d)<0&&l.negate(),l}static _direction(e,t){var i=new THREE.Vector3;return i.subVectors(e,t),i.normalize(),i}static _tangentDirection(e,t,i){var r=h._direction(e,t);return r.cross(i),r.normalize(),r.crossVectors(i,r),r}static _equalsEpsilon(e,t,i,r){var a=Math.abs(e-t);return a<=r||a<=i*Math.max(Math.abs(e),Math.abs(t))}static _breakMiter(e,t,i,s){var o=h._direction(i,t).dot(e);if(o>a||o<n){var l=h._direction(s,i),d=o<n?r.Math.PI_OVER_TWO:-r.Math.PI_OVER_TWO;return e.applyAxisAngle(l,d),!0}return!1}_getMinMaxHeight(e,t){const i=this.viewer.getSceneHeightRange();var a=this.tileManager;if(!a)return{maximumTerrainHeight:Math.max(1e3,i.max),minimumTerrainHeight:Math.min(-1e3,i.min)};if(!a.isUseTerrain())return{maximumTerrainHeight:Math.max(1e3,i.max),minimumTerrainHeight:Math.min(-1e3,i.min)};var n=this.viewer.drawingToWorld(e),h=this.viewer.drawingToWorld(t),c=a.worldPositionToLngLat(n),u=a.worldPositionToLngLat(h),p=s;p.height=0,p.longitude=THREE.Math.degToRad(c.x),p.latitude=THREE.Math.degToRad(c.y);var m=o;m.height=0,m.longitude=THREE.Math.degToRad(u.x),m.latitude=THREE.Math.degToRad(u.y);var f=r.GIS.Rectangle.fromCartographicArray(l,d),g=r.GIS.ApproximateTerrainHeights.getMinimumMaximumHeights(f);if(g){var v=new THREE.Vector3(0,0,(g.maximumTerrainHeight-a.modelAltitude)*r.Tile.TileMath.unitScale),y=this.viewer.worldToDrawing(v);g.maximumTerrainHeight=y.y,v=new THREE.Vector3(0,0,(g.minimumTerrainHeight-a.modelAltitude)*r.Tile.TileMath.unitScale),y=this.viewer.worldToDrawing(v),g.minimumTerrainHeight=y.y}return g.maximumTerrainHeight=Math.max(g.maximumTerrainHeight,i.max),g.minimumTerrainHeight=Math.min(g.minimumTerrainHeight,i.min),g}}r.GroundCurveGeometry=h}(),function(){class e extends THREE.Mesh{constructor(e,t){super(e,t),this.type="GroundCurveMesh",this.lineType="Continuous",this.visibleModelIdMap=null}setColor(e){e.alpha<1||this.material.map?this.material.transparent=!0:this.material.transparent=!1,this.material.color.setRGB(e.red/255,e.green/255,e.blue/255),this.material.opacity=e.alpha,this.renderOrder=r.GlobalData.IncrementRender?r.EnumRenderOrder.Increment:r.EnumRenderOrder.BeforeComponent}setOpacity(e){this.material.opacity=e,this.material.transparent=e<1}setWidth(e){this.material.lineWidth=e}setStyle(e){if(this.lineType!=e.lineType){this.lineType=e.lineType;var t=this.material;"Continuous"==this.lineType?t.dashMode=0:t.dashMode=1}}setType(e){var t=this.geometry;t.curveType=e,t.updateGeometry({curveType:e})}setMap(e,t){this.material.map=e,this.material.uvTransform=e.matrix,e&&(r.MaterialUtil.updateUVMatrix(this.material.map),this.material.transparent=!0,this.material.needsUpdate=!0,this.material.uniforms.uvTransform.value=this.material.map.matrix,this.material.enableColorOverride=null!=t&&t)}setClampMode(e){this.material.clampMode=e}setVisibleModelIdMap(e){this.visibleModelIdMap=e}getVisibleModelIdMap(){return this.visibleModelIdMap}dispose(){this.geometry.dispose(),this.material.dispose()}onRemoved(){r.GroundPrimitiveManager.getInstance().removeGroundCurve(this)}onAdded(){r.GroundPrimitiveManager.getInstance().addGroundCurve(this)}}r.GroundCurveMesh=e}(),function(){var e=new r.GIS.Cartographic,t=new r.GIS.Cartographic,i=[e,t],a=new r.GIS.Rectangle;class n extends THREE.BufferGeometry{constructor(e){if(super(),this.type="GroundPolygonGeometry",this.viewer=void 0,this.tileManager=void 0,this.minHeight=-1e3,this.maxHeight=1e3,this._initialized=!1,!e.points||e.points.length<3)console.warn("ground polygon's points.length must >= 3.");else{var t=this;r.GIS.ApproximateTerrainHeights.initialize().then((()=>{t.viewer||(t.viewer=e.viewer,t.viewer.modelManager.modelCollection.traverse((e=>{e.isDemLayer&&(t.tileManager=e.tileManager)})));var i=t.createAttributes(e);for(var r in t.setIndex(i.index),i.attributes)t.setAttribute(r,new THREE.Float32BufferAttribute(i.attributes[r].array,i.attributes[r].itemSize));t.computeBoundingSphere(),t._initialized||(t._initialized=!0,t.viewer.render())}))}}createAttributes(e){this._getMinMaxHeight(e);for(var t=e.points,i=t.length,a=new Array(2*i),n=[],s=0;s<i;s++){var o=this.viewer.worldToDrawing(t[s]);n.push(o),a[2*s]=o.x,a[2*s+1]=o.z}var l=0,d=new THREE.Vector3,h=new THREE.Vector3,c=new Array(3*i),u=new Array(3*i);for(s=0;s<i;s++)h.copy(n[s]),h.y=this.minHeight,d.copy(n[s]),d.y=this.maxHeight,d.toArray(u,l),h.toArray(c,l),l+=3;var p=new Array;p=p.concat(c).concat(u);var m=new Array,f=r.earcut(a);m=m.concat(f);var g=[...f].reverse();for(s=0;s<g.length;s++)g[s]+=i;m=m.concat(g);var v=new Array;for(s=0;s<i;s++)v.push(s),v.push((s+1)%i),v.push(i+(s+1)%i),v.push(s),v.push(i+(s+1)%i),v.push(i+s);return r.Utils.isClockWise(t)&&(v=[...v].reverse()),{index:m=m.concat(v),attributes:{position:{array:p,itemSize:3}}}}updateGeometry(e){var t=this;r.GIS.ApproximateTerrainHeights.initialize().then((()=>{var i=t.createAttributes(e);for(var r in t.setIndex(i.index),i.attributes)t.deleteAttribute(r),t.setAttribute(r,new THREE.Float32BufferAttribute(i.attributes[r].array,i.attributes[r].itemSize));t.computeBoundingSphere(),t._initialized||(t._initialized=!0,t.viewer.render())}))}_getMinMaxHeight(n){const s=this.viewer.getSceneHeightRange();var o=this.tileManager;if(!o)return this.maxHeight=Math.max(this.maxHeight,1e3,s.max),void(this.minHeight=Math.min(this.minHeight,-1e3,s.min));if(!o.isUseTerrain())return this.maxHeight=Math.max(this.maxHeight,1e3,s.max),void(this.minHeight=Math.min(this.minHeight,-1e3,s.min));for(var l=n.points,d=180,h=90,c=-180,u=-90,p=0;p<l.length;p++){var m=l[p],f=o.worldPositionToLngLat(m);d=Math.min(d,f.x),c=Math.max(c,f.x),h=Math.min(h,f.y),u=Math.max(u,f.y)}var g=e;g.height=0,g.longitude=THREE.Math.degToRad(d),g.latitude=THREE.Math.degToRad(h);var v=t;v.height=0,v.longitude=THREE.Math.degToRad(c),v.latitude=THREE.Math.degToRad(u);var y=r.GIS.Rectangle.fromCartographicArray(i,a),M=r.GIS.ApproximateTerrainHeights.getMinimumMaximumHeights(y);if(M){m=new THREE.Vector3(0,0,(M.maximumTerrainHeight-o.modelAltitude)*r.Tile.TileMath.unitScale);var E=this.viewer.worldToDrawing(m);this.maxHeight=E.y,m=new THREE.Vector3(0,0,(M.minimumTerrainHeight-o.modelAltitude)*r.Tile.TileMath.unitScale),E=this.viewer.worldToDrawing(m),this.minHeight=E.y}this.maxHeight=Math.max(this.maxHeight,s.max),this.minHeight=Math.min(this.minHeight,s.min)}}r.GroundPolygonGeometry=n}(),function(){class e extends THREE.Mesh{constructor(e,t){super(e,t),this.type="GroundPolygonMesh"}setColor(e){this.material.color.setRGB(e.red/255,e.green/255,e.blue/255),this.material.opacity=e.alpha,this.material.transparent=e.alpha<1}setOpacity(e){this.material.opacity=e,this.material.transparent=e<1}dispose(){this.geometry.dispose(),this.material.dispose()}onRemoved(){r.GroundPrimitiveManager.getInstance().removeGroundPolygon(this)}onAdded(){r.GroundPrimitiveManager.getInstance().addGroundPolygon(this)}}r.GroundPolygonMesh=e}(),function(){const e=new THREE.Matrix4;e.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1);r.ShadowMapCamera=class{constructor(){this.viewMatrix=new THREE.Matrix4,this.inverseViewMatrix=new THREE.Matrix4,this.orthoCamera=new THREE.OrthographicCamera,this.positionWC=new THREE.Vector3,this.directionWC=new THREE.Vector3(0,0,1),this.upWC=new THREE.Vector3(0,1,0),this.rightWC=new THREE.Vector3(1,0,0),this.viewProjectionMatrix=new THREE.Matrix4}destroy(){this.viewMatrix=null,this.inverseViewMatrix=null,this.orthoCamera=null,this.positionWC=null,this.directionWC=null,this.upWC=null,this.rightWC=null,this.viewProjectionMatrix=null}clone(e){this.viewMatrix.copy(e.viewMatrix),this.inverseViewMatrix.copy(e.inverseViewMatrix),this.orthoCamera.copy(e.orthoCamera),this.positionWC.copy(e.positionWC),this.directionWC.copy(e.directionWC),this.upWC.copy(e.upWC),this.rightWC.copy(e.rightWC)}getViewProjection(){var t=this.viewMatrix;this.orthoCamera.updateProjectionMatrix();var i=this.orthoCamera.projectionMatrix;return this.viewProjectionMatrix.multiplyMatrices(i,t),this.viewProjectionMatrix.multiplyMatrices(e,this.viewProjectionMatrix),this.viewProjectionMatrix}}}(),(()=>{const e=new THREE.Sphere,t=new THREE.Vector2,i=new THREE.Vector3,a=new THREE.Vector3,n=new THREE.Matrix4,s=new THREE.Matrix4,o=new THREE.Vector3,l=new THREE.Vector3,d=new THREE.Matrix4,h=new THREE.Vector3,c=new THREE.Vector3,u=new THREE.Vector3,p=new Array(8);p[0]=new THREE.Vector4(-1,-1,-1,1),p[1]=new THREE.Vector4(1,-1,-1,1),p[2]=new THREE.Vector4(1,1,-1,1),p[3]=new THREE.Vector4(-1,1,-1,1),p[4]=new THREE.Vector4(-1,-1,1,1),p[5]=new THREE.Vector4(1,-1,1,1),p[6]=new THREE.Vector4(1,1,1,1),p[7]=new THREE.Vector4(-1,1,1,1);for(var m=new Array(8),f=0;f<8;++f)m[f]=new THREE.Vector4;var g=new Array(5),v=new Array(4),y=new THREE.PerspectiveCamera;r.CSM=class{constructor(e){e=e||{},this.viewer=e.viewer,this.camera=e.camera,this.scene=e.scene,this.cascades=4,this.shadowMapSize=1024,this.shadowBias=[-.0015,-.0018,-.0022,-.003],this.lights=[],this.extendedBreaks=[new THREE.Vector2(0,.16704173648319734),new THREE.Vector2(.16704173648319734,.34690875474964117),new THREE.Vector2(.34690875474964117,1),new THREE.Vector2(1,1)],this.shadowNear=+Number.MAX_VALUE,this.shadowFar=-Number.MAX_VALUE,this.shadowClosestObjectSize=Number.MAX_VALUE,this.MAXIMUM_DISTANCE=2e4,this.maximumDistance=1e4,this.sceneCamera=new r.Camera(r.CAMERATYPE.PERSPECTIVE),this.shadowMapCamera=new r.ShadowMapCamera,this._maximumCascadeDistances=[25,150,700,Number.MAX_VALUE],this.createLights()}destroy(){this.shadowBias=null,this.lights=null,this.extendedBreaks=null,this.sceneCamera=null,this.shadowMapCamera.destroy(),this.shadowMapCamera=null,this._maximumCascadeDistances=null,this.viewer=null,this.camera=null,this.scene=null}createLights(){for(let e=0;e<this.cascades;e++){const t=new THREE.DirectionalLight(16777215,1);t.castShadow=!0,t.shadow.mapSize.width=this.shadowMapSize,t.shadow.mapSize.height=this.shadowMapSize,t.shadow.bias=this.shadowBias[e],this.lights.push(t)}}update(e){this.computeNearFarPlane(this.scene,this.camera),this.shadowMapCamera.directionWC.copy(e),this.shadowMapCamera.directionWC.negate(),this.shadowMapCamera.directionWC.normalize(),this.fitShadowMapToScene(),this.computeCascades();const t=this.camera;this.extendedBreaks[0].set(g[0],g[1]),this.extendedBreaks[1].set(g[1],g[2]),this.extendedBreaks[2].set(g[2],g[3]),this.extendedBreaks[3].set(g[3],g[4]),t.csmCascades=this.extendedBreaks,this.viewer.updateShadowMap(),this.updateCascades()}updateCascades(){const e=this.viewer.getScene().getObjectGroups();for(var t=0;t<e.length;t++)this._updateCascadesForModel(e[t])}_updateCascadesForModel(e){if(!e.visible)return;const t=e.material;if(t instanceof Array)for(let e=0;e<t.length;e++){const i=t[e];r.Utils.isDefined(i)&&i.useCSM&&(i.needsUpdate=!0,i.uniforms.csmCascades.value=this.camera.csmCascades)}else r.Utils.isDefined(t)&&t.useCSM&&(t.needsUpdate=!0,t.uniforms.csmCascades.value=this.camera.csmCascades);let i=e.children;for(let e=0,t=i.length;e<t;e++)this._updateCascadesForModel(i[e])}computeCascades(){var e,t=this.shadowMapCamera,i=this.sceneCamera,r=i.near,a=i.far,s=a-r,o=a/r,l=.9,d=!1;this.shadowClosestObjectSize<200&&(d=!0,l=.9);var f=v,M=g;for(M[0]=r,M[4]=a,e=0;e<4;++e){var E=(e+1)/4,b=r*Math.pow(o,E),I=r+s*E,x=THREE.Math.lerp(I,b,l);M[e+1]=x,f[e]=x-M[e]}if(d){for(e=0;e<4;++e)f[e]=Math.min(f[e],this._maximumCascadeDistances[e]);var T=M[0];for(e=0;e<3;++e)T+=f[e],M[e+1]=T}var _=t.orthoCamera,S=_.left,C=_.right,w=_.bottom,R=_.top,B=_.near,L=_.far,O=t.positionWC,P=t.directionWC,D=t.upWC,A=y;A.fov=i.fov,A.aspect=i.aspect,A.position.copy(i.position),A.up.copy(i.up),A.lookAt(i.target),A.updateMatrixWorld(!0),A.matrixWorldInverse.copy(A.matrixWorld).invert();var N=t.getViewProjection();for(e=0;e<4;++e){A.near=M[e],A.far=M[e+1],A.updateProjectionMatrix();for(var H=n.multiplyMatrices(A.projectionMatrix,A.matrixWorldInverse),U=n.copy(H).invert(),F=n.multiplyMatrices(N,U),k=h.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),G=c.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),V=0;V<8;++V){var j=m[V].copy(p[V]);j.applyMatrix4(F),j.divideScalar(j.w),k.min(j),G.max(j)}k.x=Math.max(k.x,0),k.y=Math.max(k.y,0),k.z=0,G.x=Math.min(G.x,1),G.y=Math.min(G.y,1),G.z=Math.min(G.z,1),u.copy(O),u.add(P);const t=this.lights[e];t.position.copy(O),t.up.copy(D),t.updateMatrixWorld(!0),t.target.position.copy(u),t.target.updateMatrixWorld(!0);const i=t.shadow.camera;i.left=S+k.x*(C-S),i.right=S+G.x*(C-S),i.bottom=w+k.y*(R-w),i.top=w+G.y*(R-w),i.near=B+k.z*(L-B),i.far=B+G.z*(L-B),i.updateProjectionMatrix(),i.position.copy(O),i.up.copy(D),i.lookAt(t.target.position),i.updateMatrixWorld(!0)}}fitShadowMapToScene(){var e=this.shadowMapCamera,t=this.sceneCamera,a=n.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse),u=s.copy(a).invert(),f=e.directionWC,g=i;r.Math.equalsEpsilonVector3(f,g,r.Math.EPSILON10)&&(g=t.up),o.copy(f),o.cross(g);var v=o;g.copy(v),g.cross(f),g.normalize(),v.normalize();var y=l;y.set(0,0,0);for(var M=r.Utils.computeView(y,f,g,v,d),E=s.multiplyMatrices(M,u),b=h.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),I=c.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),x=0;x<8;++x){var T=m[x].copy(p[x]);T.applyMatrix4(E),T.divideScalar(T.w),b.min(T),I.max(T)}I.z+=1e3,b.z-=10;var _=l;_.x=-.5*(b.x+I.x),_.y=-.5*(b.y+I.y),_.z=-I.z;var S=n.makeTranslation(_.x,_.y,_.z);M=S.multiplyMatrices(S,M);var C=.5*(I.x-b.x),w=.5*(I.y-b.y),R=I.z-b.z,B=e.orthoCamera;B.left=-C,B.right=C,B.bottom=-w,B.top=w,B.near=.01,B.far=R,e.viewMatrix.copy(M),e.inverseViewMatrix.copy(M).invert(),r.Utils.getTranslationFromMatrix4(e.inverseViewMatrix,e.positionWC),e.directionWC.copy(f),e.upWC.copy(g),e.rightWC.copy(v)}computeNearFarPlane(e,t){this.shadowNear=+Number.MAX_VALUE,this.shadowFar=-Number.MAX_VALUE,this.shadowClosestObjectSize=Number.MAX_VALUE;var r=t.position,a=t.target;i.subVectors(a,r),i.normalize(),this._computeNearFarPlane(e,t),this.shadowNear=Math.min(Math.max(this.shadowNear,t.near),t.far),this.shadowFar=Math.max(Math.min(this.shadowFar,t.far),this.shadowNear),this.shadowNear=Math.min(this.shadowNear,this.maximumDistance),this.shadowFar=Math.min(this.shadowFar,this.maximumDistance+1),this.sceneCamera.copy(t),this.sceneCamera.near=this.shadowNear,this.sceneCamera.far=this.shadowFar,this.sceneCamera.updateProjectionMatrix()}_computePlaneDistances(e,t,i,r){var n=e.center;a.subVectors(n,t);var s=i.dot(a);return r.x=s-e.radius,r.y=s+e.radius,r}_computeNearFarPlane(a,n){if(a.visible&&a.name!=r.ObjectGroupType.RECEIVESHADOWPLANE){if(a.layers.test(n.layers)&&(a.isMesh||a.isLine||a.isPoints)&&(a.isSkinnedMesh&&a.skeleton.update(),!a.frustumCulled||n.frustum.intersectsObject(a))){var s=a.geometry;null===s.boundingSphere&&s.computeBoundingSphere(),e.copy(s.boundingSphere).applyMatrix4(a.matrixWorld),this._computePlaneDistances(e,n.position,i,t);var o=t.x,l=t.y;if(a.castShadow&&o<this.MAXIMUM_DISTANCE){var d=l-o;o<100&&(this.shadowClosestObjectSize=Math.min(this.shadowClosestObjectSize,d)),this.shadowNear=Math.min(this.shadowNear,o),this.shadowFar=Math.max(this.shadowFar,l)}}for(var h=a.children,c=0,u=h.length;c<u;c++)this._computeNearFarPlane(h[c],n)}}}})(),(()=>{let e=new THREE.Vector3,t=new THREE.Vector3;var i=new THREE.Box3;r.LightManager=class{constructor(e){this.scene=e,this.lightHelper=!1,this.shadowLightNum=0,this.shadowBox=new THREE.Box3,this.defaultLightsGroup=new r.ObjectGroup(r.ObjectGroupType.DEFAULTLIGHTS),this.externalDirLightsGroup=new r.ObjectGroup(r.ObjectGroupType.EXTERNALDIRLIGHTS),this.scene.add(this.defaultLightsGroup),this.scene.add(this.externalDirLightsGroup),this.externalSpotLightsGroup=this.scene.getOrCreateObjectGroup(r.ObjectGroupType.EXTERNALSPOTLIGHTS,{globalSpace:!0}),this.lightHelperGroup=this.scene.getOrCreateObjectGroup(r.ObjectGroupType.LIGHTHELPER),this.receivingPlane=null,this.cameraHelper=null,this.csm=null,this.useCSM=!1,this.defaultLightArray=[],this.initDefaultLights(),this.lightPreset()}initCSM(e){this.csm||(this.csm=new r.CSM({viewer:e,camera:e.camera,scene:this.scene}))}enableCSM(e){this.useCSM=e,r.GlobalData.EnableCSM=e,this.adjustLightsForCSM(),this.csm&&this.csm.viewer.modelManager.updateMaterialsValue("useCSM",e)}adjustLightsForCSM(){for(var e=!(!this.useCSM||!this.csm),t=0;t<this.defaultLightArray.length;t++)this.defaultLightsGroup.remove(this.defaultLightArray[t]);for(t=0;t<this.csm.lights.length;t++)this.defaultLightsGroup.remove(this.csm.lights[t]);if(e)for(t=0;t<this.csm.lights.length;t++)this.defaultLightsGroup.add(this.csm.lights[t]);for(t=0;t<this.defaultLightArray.length;t++){var i=this.defaultLightArray[t];this.defaultLightsGroup.add(i),i instanceof THREE.DirectionalLight&&e&&(i.castShadow=!1)}for(t=0;t<this.externalDirLightsGroup.children.length;t++){(i=this.externalDirLightsGroup[t])instanceof THREE.DirectionalLight&&e&&(i.castShadow=!1)}}destroy(){this.scene.remove(this.defaultLightsGroup),this.defaultLightsGroup=null,this.defaultLightArray=null,this.hemisphereLight=null,this.dirLight=null,this.ambientLight=null,this.sunLight=null,this.fillLight01=null,this.fillLight02=null,this.fillLight03=null,this.light04=null,this.shadowBox=null,this.externalSpotLightsGroup.clear(),this.scene.remove(this.externalSpotLightsGroup),this.externalSpotLightsGroup=null,this.externalDirLightsGroup.clear(),this.scene.remove(this.externalDirLightsGroup),this.externalDirLightsGroup=null,this.lightHelperGroup.clear(),this.scene.remove(this.lightHelperGroup),this.lightHelperGroup=null,this.cameraHelper=null,this.receivingPlane&&(this.scene.objectGroups.remove(this.receivingPlane),this.receivingPlane=null),this.csm&&(this.csm.destroy(),this.csm=null),this.scene=null}initDefaultLights(){var e=.7;this.hemisphereLight||(this.hemisphereLight=new THREE.HemisphereLight(16777215,16777215,e*r.GlobalData.LightIntensityFactor),this.hemisphereLight.initIntensity=e,this.defaultLightsGroup.add(this.hemisphereLight),this.defaultLightArray.push(this.hemisphereLight)),e=.7,this.dirLight||(this.dirLight=new THREE.DirectionalLight(16777215,e*r.GlobalData.LightIntensityFactor),this.dirLight.initIntensity=e,this.defaultLightsGroup.add(this.dirLight),this.defaultLightArray.push(this.dirLight)),this.ambientLight||(this.ambientLight=new THREE.AmbientLight(16777215,.6),this.defaultLightsGroup.add(this.ambientLight),this.defaultLightArray.push(this.ambientLight)),this.sunLight||(this.sunLight=new THREE.DirectionalLight(16777215,1),this.defaultLightsGroup.add(this.sunLight),this.defaultLightArray.push(this.sunLight)),this.fillLight01||(this.fillLight01=new THREE.DirectionalLight(16777215,1),this.defaultLightsGroup.add(this.fillLight01),this.defaultLightArray.push(this.fillLight01)),this.fillLight02||(this.fillLight02=new THREE.DirectionalLight(16777215,1),this.defaultLightsGroup.add(this.fillLight02),this.defaultLightArray.push(this.fillLight02)),this.fillLight03||(this.fillLight03=new THREE.DirectionalLight(16777215,1),this.defaultLightsGroup.add(this.fillLight03),this.defaultLightArray.push(this.fillLight03)),this.light04||(this.light04=new THREE.DirectionalLight(16777215,.15),this.light04.castShadow=!1,this.light04.intensity=.5,this.light04.shadow.mapSize.width=1024,this.light04.shadow.mapSize.height=1024,this.light04.shadow.bias=-9e-4,this.defaultLightsGroup.add(this.light04),this.defaultLightArray.push(this.light04),this.lightCastShadow=this.light04)}hideDefaultLights(){for(var e=0;e<this.defaultLightsGroup.children.length;e++){this.defaultLightsGroup.children[e].visible=!1}if(this.useCSM&&this.csm)for(e=0;e<this.csm.lights.length;e++)this.csm.lights[e].visible=!0}defaultLightPreset(){this.hideDefaultLights(),this.hemisphereLight.visible=!0,this.hemisphereLight.position.set(0,500,0),this.hemisphereLight.updateMatrixWorld(!0),this.dirLight.visible=!0,this.dirLight.color.setHSL(.1,1,.95),this.dirLight.position.set(-1,.75,1),this.dirLight.position.multiplyScalar(50)}updateDefaultLight(e){var t=this.dirLight;t.intensity=t.initIntensity*r.GlobalData.LightIntensityFactor,t.position.set(e.x,e.y,e.z),t.updateMatrixWorld(!0);var i=this.hemisphereLight;i.intensity=i.initIntensity*r.GlobalData.LightIntensityFactor}setupCommonLight(){this.hideDefaultLights(),this.ambientLight.visible=!0,this.ambientLight.intensity=.6,this.sunLight.visible=!0,this.sunLight.color.setHex(14800580),this.sunLight.position.set(-100,160,100),this.sunLight.intensity=.72,this.sunLight.distance=300,this.sunLight.updateMatrixWorld()}lightPreset01(){this.setupCommonLight(),this.fillLight01.visible=!0,this.fillLight01.color.setHex(16777215),this.fillLight01.position.set(100,100,100),this.fillLight01.intensity=1,this.fillLight01.updateMatrixWorld(),this.fillLight02.visible=!0,this.fillLight02.color.setHex(16777215),this.fillLight02.position.set(-100,100,-100),this.fillLight02.intensity=.24,this.fillLight02.updateMatrixWorld(),this.ambientLight.intensity=.6,this.sunLight.intensity=.9}lightPreset02(){this.setupCommonLight(),this.fillLight01.visible=!0,this.fillLight01.position.set(60,80,130),this.fillLight01.intensity=.28,this.fillLight01.updateMatrixWorld(),this.fillLight02.visible=!0,this.fillLight02.color.setHex(8100788),this.fillLight02.position.set(100,80,-100),this.fillLight02.intensity=.22,this.fillLight02.updateMatrixWorld(),this.fillLight03.visible=!0,this.fillLight03.color.setHex(8100788),this.fillLight03.position.set(-140,80,-50),this.fillLight03.intensity=.18,this.fillLight03.updateMatrixWorld()}lightPreset03(){this.setupCommonLight(),this.fillLight01.visible=!0,this.fillLight01.color.setHex(16777215),this.fillLight01.position.set(100,100,100),this.fillLight01.intensity=.75,this.fillLight01.updateMatrixWorld(),this.fillLight02.visible=!0,this.fillLight02.color.setHex(16777215),this.fillLight02.position.set(-100,100,-100),this.fillLight02.intensity=.21,this.fillLight02.updateMatrixWorld(),this.ambientLight.intensity=.4,this.sunLight.intensity=.56}lightPreset04(){this.setupCommonLight(),this.fillLight01.visible=!0,this.fillLight01.color.setHex(16777215),this.fillLight01.position.set(100,100,100),this.fillLight01.intensity=.4,this.fillLight01.updateMatrixWorld(),this.fillLight02.visible=!0,this.fillLight02.color.setHex(16777215),this.fillLight02.position.set(-100,100,-100),this.fillLight02.intensity=.1,this.fillLight02.updateMatrixWorld(),this.ambientLight.intensity=.3,this.sunLight.intensity=.2,this.light04.visible=!0,this.updateShadowLight()}lightPreset(){var e=r.GlobalData.LightPreset;switch(e){case 0:this.defaultLightPreset();break;case 1:this.lightPreset01();break;case 2:this.lightPreset02();break;case 3:this.lightPreset03();break;case 4:this.lightPreset04();break;default:this.setupCommonLight(),this.sunLight.color.setHex(16777215),this.ambientLight.intensity=.72}this.scene.gisMode||(this.getReceivingPlane(),this.receivingPlane.visible=4==e),this.lightHelper&&this.addLightHelper()}addExternalSpotLight(e){this.externalSpotLightsGroup.add(e)}addExternalDirLight(e){this.externalDirLightsGroup.add(e),this.adjustLightsForCSM()}updateLights(e){var t=new THREE.Vector3(0,1,0),i=Math.PI/4,a=1e3,n=e.position.clone();switch(n.sub(e.target),n.normalize(),r.GlobalData.LightPreset){case 0:this.updateDefaultLight(n);break;case 1:case 3:case 4:var s=n.clone().applyAxisAngle(t,-1.2*i);this.fillLight01.position.copy(s).normalize(),this.fillLight01.position.multiplyScalar(a),this.fillLight01.position.y=600,this.fillLight01.updateMatrixWorld(),s=n.clone().applyAxisAngle(t,1*i),this.fillLight02.position.copy(s).normalize(),this.fillLight02.position.multiplyScalar(a),this.fillLight02.position.y=600,this.fillLight02.updateMatrixWorld(),this.updateShadowLight();break;case 2:break;default:s=n.clone().applyAxisAngle(t,-2*i);this.sunLight.position.copy(s).normalize(),this.sunLight.position.multiplyScalar(a),this.sunLight.position.y=600,this.sunLight.updateMatrixWorld()}this.lightHelper&&this.updateLightHelper()}updateShadowLight(){if(this.useCSM&&this.csm)this.csm.update(this.scene.sunDirection);else if(this.scene.getBoundingBoxWithoutDEM()){i.copy(this.scene.getBoundingBoxWithoutDEM());var r=i,a=r.getCenter(e),n=new THREE.Vector3,s=new THREE.Vector3;s.copy(this.scene.sunDirection),s.negate(),s.multiplyScalar(100),n.set(a.x-s.x,a.y-s.y,a.z-s.z);var o=r.getSize(t);r.min.y=r.min.y-.05*o.y;var l=new THREE.Plane(new THREE.Vector3(0,1,0),-r.min.y),d=l.normal.dot(s),h=new THREE.Vector3(r.max.x,r.max.y,r.min.z),c=-(h.dot(l.normal)+l.constant)/d,u=new THREE.Vector3;u.copy(s).multiplyScalar(c).add(h),r.expandByPoint(u),this.shadowBox.copy(r),this.lightCastShadow.position.set(n.x,n.y,n.z),this.lightCastShadow.target.position.set(a.x,a.y,a.z),this.lightCastShadow.target.updateMatrixWorld(!0),this.lightCastShadow.updateMatrixWorld(!0);var p=this.lightCastShadow.shadow.camera;p.position.set(n.x,n.y,n.z);var m=a;p.lookAt(m),p.updateMatrixWorld(),p.matrixWorldInverse.copy(p.matrixWorld).invert(),r.applyMatrix4(p.matrixWorldInverse),p.left=r.min.x,p.right=r.max.x,p.top=r.max.y,p.bottom=r.min.y,p.far=-r.min.z,p.near=-r.max.z,p.updateProjectionMatrix(),this.updateReceivingPlane()}}getReceivingPlane(){if(!this.receivingPlane){this.receivingPlane=this.scene.getOrCreateObjectGroup(r.ObjectGroupType.RECEIVESHADOWPLANE);var e=new THREE.ShadowMaterial;e.isShaderMaterial=!1,e.transparent=!0,e.opacity=.2,e.side=THREE.DoubleSide;var t=new THREE.PlaneBufferGeometry(1,1),i=new THREE.Mesh(t,e);i.receiveShadow=!0,i.rotateOnAxis(new THREE.Vector3(1,0,0),Math.PI/2),this.receivingPlane.add(i),this.receivingPlane.matrixAutoUpdate=!1}return this.receivingPlane}updateReceivingPlane(){var t=this.shadowBox;if(t&&this.receivingPlane&&this.receivingPlane.visible){var i=t.getCenter(e),r=this.receivingPlane.children[0];r.position.y=t.min.y,r.position.x=i.x,r.position.z=i.z;var a=t.getSize(e);r.scale.x=a.x,r.scale.y=a.z,this.receivingPlane.updateMatrixWorld(!0)}}clearLightHelper(){for(var e=this.lightHelperGroup.children.length-1;e>=0;e--){var t=this.lightHelperGroup.children[e];this.lightHelperGroup.remove(t)}this.cameraHelper=null}addLightHelper(){this.clearLightHelper();for(var e=0;e<this.defaultLightsGroup.children.length;++e){if((i=this.defaultLightsGroup.children[e])instanceof THREE.DirectionalLight&&i.visible){var t=new THREE.DirectionalLightHelper(i,200);this.lightHelperGroup.add(t)}}for(e=0;e<this.externalSpotLightsGroup.children.length;++e){if((i=this.externalSpotLightsGroup.children[e])instanceof THREE.DirectionalLight&&i.visible){t=new THREE.DirectionalLightHelper(i,200);this.lightHelperGroup.add(t)}}for(e=0;e<this.externalDirLightsGroup.children.length;++e){var i;if((i=this.externalDirLightsGroup.children[e])instanceof THREE.DirectionalLight&&i.visible){t=new THREE.DirectionalLightHelper(i,200);this.lightHelperGroup.add(t)}}if(this.lightCastShadow&&this.lightCastShadow.visible&&(this.cameraHelper=new THREE.CameraHelper(this.lightCastShadow.shadow.camera),this.lightHelperGroup.add(this.cameraHelper)),this.useCSM&&this.csm)for(e=0;e<this.csm.lights.length;e++){var r=new THREE.CameraHelper(this.csm.lights[e].shadow.camera);this.lightHelperGroup.add(r)}}updateLightHelper(){for(var e=0;e<this.lightHelperGroup.children.length;++e){var t=this.lightHelperGroup.children[e];t.update(),t.updateMatrixWorld(!0)}}getShadowBoxWorld(){if(this.shadowBox){var e=new THREE.Box3;e.copy(this.shadowBox);var t=this.scene.geometryGroup.matrix.clone();return t.invert(),e.applyMatrix4(t),e}return null}removeLight(e){e&&e.parent&&e.parent.remove(e)}}})(),r.ObjectPool=function(e,t){this.cls=e,this.size=t,this._pool=[],this.counter=0},r.ObjectPool.prototype.init=function(e){for(var t=0,i=this.size;t<i;++t){var a=new this.cls;a.init(e),this._pool[t]=a,r.GlobalData.EnableShadowMap&&(a.castShadow=!0,a.receiveShadow=!0)}},r.ObjectPool.prototype.resize=function(e,t){this.size=e,this.collect(),this.init(t)},r.ObjectPool.prototype.get=function(e){if(this.counter>=this.size)return null;var t=this._pool[this.counter];return t.spawn(e),++this.counter,t},r.ObjectPool.prototype.clear=function(){for(var e=0,t=this.size;e<t;++e)this._pool[e].clear();this.counter=0},r.ObjectPool.prototype.destroy=function(){this.collect()},r.ObjectPool.prototype.collect=function(){this._pool=[],this.counter=0},r.ObjectPool.prototype.getObjects=function(){return this._pool},r.ExpandableObjectPool=function(){this.size=0,this.counter=0,this.expansion=1,this._pool=null},r.ExpandableObjectPool.prototype.init=function(e,t){this.classType=e,this._pool=[],this._expand(t)},r.ExpandableObjectPool.prototype._expand=function(e){this.size+=e;for(var t=0;t<e;t++)this._pool.push(new this.classType)},r.ExpandableObjectPool.prototype.acquire=function(){return this.counter>=this.size&&(this.expansion=Math.round(1.2*this.expansion)+1,this._expand(this.expansion),console.log("_expand")),this._pool[this.counter++]},r.ExpandableObjectPool.prototype.clear=function(){this.counter=0},r.ExpandableObjectPool.prototype.destroy=function(){for(var e=0,t=this.size;e<t;++e)this._pool[e].destroy();this.counter=0,this.size=0,this.expansion=1,this._pool=null},r.ExpandableObjectPool.prototype.getObjects=function(){return this._pool},function(){class e extends THREE.Group{constructor(e,t={}){super(),this.name=e,this.priority=t&&t.priority?t.priority:5,this.pickableType=t&&t.pickableType?t.pickableType:r.PICKABLETYPE.UnPickable,this.globalSpace=!(!t||!t.globalSpace)&&t.globalSpace,this.boundingBox=null,this.hoverEnabled=!(!t||!t.hoverEnabled)&&t.hoverEnabled}clear(){this.children.length=0}removeByName(e){for(var t=this.children,i=0,r=t.length;i<r;++i)if(t[i].name===e){t.splice(i,1);break}}isGlobalSpace(){return this.globalSpace}hasChild(e){for(var t=0,i=this.children.length;t<i;t++)if(this.children[t].name==e)return!0;return!1}isPickable(){return this.pickableType!==r.PICKABLETYPE.UnPickable}raycast(e,t){for(var i=0,a=this.children.length;i<a;i++){var n=this.children[i];if(r.Utils.isGroupObject(n)){var s=n.name;n.traverseVisible((function(i){r.Utils.isMeshObject(i)&&(void 0===i.userId&&(i.userId=s),i.raycast(e,t))}))}else n.visible&&n.raycast(e,t)}t.forEach((e=>{e.userId=e.object.userId}))}}r.ObjectGroup=e}(),(()=>{let e=new THREE.Matrix4;r.ObjectGroupType={MODEL:"Model",GEOMETRY:"Geometry",LINESEGMENTS:"LineSegments",INSTANCEGEOMETRY:"InstanceGeometry",INSTANCEWIREFRAMEGEOMETRY:"InstanceWireframeGeometry",WIREFRAME:"Wireframe",MARKER3D:"Marker3D",CLIPPLANE:"ClipPlane",FILLCLIPPLANE:"FillClipPlane",CLIPREGION:"ClipRegion",CAPSWIREFRAME:"CapsWireframe",IBLCUBE:"IBLCube",CUSTOMPLANE:"CustomPlane",PIVOTBALL:"PivotBall",MEASUREPICKPOINT:"MeasurePickPoint",MEASUREPICKLINE:"MeasurePickLine",MEASUREPLANE:"MeasurePlane",MEASURELINE:"MeasureLine",OCTREENODE:"OctreeNode",BOUNDARYEDGEMANAGER:"BoundaryEdgeManager",AXISGRIDMANAGER:"AxisGridManager",EXTRUDEBODYMANAGER:"ExtrudeBodyManager",EXTRUDEBODYMANAGERTEST:"EXTRUDEBODYMANAGERTEST",EXTERNALCOMPONENTMANAGER:"ExternalComponentManager",BIMTILESGROUP:"BimTilesGroup",BIMTILESWIREFRAMEGROUP:"BimTilesWireframeGroup",TILEGROUP:"TileGroup",ROADNETWORK:"RoadNetworkGroup",GEOJSONGROUP:"GEOJSONGROUP",RECEIVESHADOWPLANE:"ReceiveShadowPlane",CONTACTSHADOW:"ContactShadow",VIEWSHED:"Viewshed",DEFAULTLIGHTS:"DefaultLights",EXTERNALSPOTLIGHTS:"ExternalSpotLights",EXTERNALDIRLIGHTS:"ExternalDirLights",LIGHTHELPER:"LightHelper",GLOBALEARTH:"GlobelEarth"};var t=new THREE.Box3;class i extends THREE.Scene{constructor(e){super();var t=r.Utils.defaultValue(e,{});this.gisMode=t.gisMode,this.type="Scene",this.autoUpdate=!1,this.objectGroups=new r.ObjectGroup,this.add(this.objectGroups),this.fog=new r.PostProcess(16777215),this.geometryGroup=new r.ObjectGroup(r.ObjectGroupType.GEOMETRY,{pickableType:r.PICKABLETYPE.Geometry,globalSpace:!0}),this.objectGroups.add(this.geometryGroup),this.pool=new r.ObjectPool(r.MeshEx,0),this.expandScalar=1.02,this.clipPlanes=null,this.fillClipPlane=null,this.boundaryEdge=null,this.extrudeBodyManager=null,this.externalComponentManager=null,this.customPlaneManager=null,this.axisGridManager=null,this.IBLMaps=new V.IBLMaps,this.transformMatrix=new THREE.Matrix4,this.lightManager=new r.LightManager(this),this.selectedMeshes=[],this.nonSelectedMeshes=[],this.selectedInstanceMeshes=[],this.nonSelectedInstanceMeshes=[],this.sunDirection=new THREE.Vector3(-1,1.6,1),this._planIntersect=new THREE.Vector3,this._renderedObjects=[]}changeToWorkSpaceScene(){for(var e=this.getObjectGroups(),t=0;t<e.length;t++){var i=e[t];i.preVisible=i.visible,i.visible=!0}const a=this.getObjectGroup(r.ObjectGroupType.GLOBALEARTH);void 0!==a&&(a.visible=!1)}destroy(){this.lightManager.destroy(),this.lightManager=null,this.clearAll(),this.pool.destroy(),this.pool=null,this.geometryGroup=null,this.objectGroups=null,this.clipPlanes=null,this.fillClipPlane=null,this.boundaryEdge=null,this.extrudeBodyManager=null,this.externalComponentManager=null,this.axisGridManager=null,this.IBLMaps=null,this.transformMatrix=null,this.selectedMeshes=null,this.nonSelectedMeshes=null,this.selectedInstanceMeshes=null,this.nonSelectedInstanceMeshes=null,this._renderedObjects=null}resizePool(e){r.GlobalData.BatchMergeEnabled||(this.geometryGroup.clear(),this.pool.resize(e,{parent:this.geometryGroup}))}clearAll(){this.pool.clear(),this.autoUpdate=!1}getRootNode(){return this.geometryGroup}hasBoundingBox(){return!!this.geometryGroup.boundingBox}getBoundingBox(){if(this.geometryGroup.boundingBox)return t.copy(this.geometryGroup.boundingBox),t.applyMatrix4(this.geometryGroup.matrix),t}getOriginalBoundingBoxWorld(){return this.originalBoundingBoxWorld}getBoundingBoxWorld(){return this.geometryGroup.boundingBox.clone()}getMatrixGlobal(){return this.geometryGroup.matrix.clone()}getRawMatrixGlobal(){return this.geometryGroup.matrix}getInverseMatrixGlobal(){return this.geometryGroup.inverseMatrixGlobal||(this.geometryGroup.inverseMatrixGlobal=new THREE.Matrix4),this.geometryGroup.inverseMatrixGlobal.copy(this.geometryGroup.matrix).invert(),this.geometryGroup.inverseMatrixGlobal}getGlobalScaleFactor(){return this.geometryGroup.matrix.elements[0]}getMatrixWorldGlobal(){return this.geometryGroup.matrixWorld}getRotationGlobal(){if(this.geometryGroup.matrix){var e=new THREE.Matrix4;e.extractRotation(this.geometryGroup.matrix);var t=new THREE.Euler;return t.setFromRotationMatrix(e),t}return null}getNearDepthByRect(e,i){var a=1/0,n=new THREE.Matrix4,s=new THREE.Vector3;function o(e){s.setFromMatrixPosition(e.matrixWorld),s.applyProjection(n);var t=s.z;t<a&&t>=0&&t<=1&&(a=t)}function l(e,i){if(i instanceof r.MeshEx){if(!function(e,i){if(!i.boundingBox||i instanceof THREE.Mesh){var r=i.geometry;null===r.boundingBox&&r.computeBoundingBox(),t.copy(r.boundingBox),t.applyMatrix4(i.matrixWorld)}else t.copy(i.boundingBox),t.applyMatrix4(i.matrixWorld);return e.intersectsBox(t)}(e,i))return;o(i)}else if(i.worldBoundingBox){if(!e.intersectsBox(i.worldBoundingBox))return;o(i)}var a=i.children;if(a)for(var n=0,s=a.length;n<s;n++){var d=a[n];d.visible&&l(e,d)}}n.multiplyMatrices(i.projectionMatrix,i.matrixWorldInverse);for(var d=this.geometryGroup.children,h=0,c=d.length;h<c;h++){var u=d[h];u.visible&&l(e,u)}return a}getExpandScalar(){return this.expandScalar}hasClipPlanes(){return null!=this.clipPlanes}hasFillClipPlanes(){return null!=this.fillClipPlane}shrinkScopeByClipPlane(e,t){if(this.clipPlanes&&this.clipPlanes.isEnabled()){var i=this.clipPlanes.hitTest(e);if(null==i.distance)return;i.sign?i.distance>t.near&&(t.near=i.distance):i.distance<t.far&&(t.far=i.distance)}}updateWorldMatrix(e,t,i){var r=new THREE.Matrix4;r.compose(e,t,i),this.updateWorldMatrixByMatrix(r)}updateWorldMatrixByMatrix(e){for(var t=this.objectGroups.children,i=0,r=t.length;i<r;i++)if(t[i].globalSpace){let r=t[i].transformMatrix||new THREE.Matrix4;t[i].matrix.copy(r),t[i].matrix.multiplyMatrices(e,t[i].matrix),t[i].matrixAutoUpdate=!1,t[i].updateMatrixWorld(!0)}}getShadowBoxWorld(){return this.lightManager.getShadowBoxWorld()}lightPreset(){this.lightManager.lightPreset()}updateLights(e,t){this.lightManager.updateLights(e)}updateCSMParameter(){this.lightManager.useCSM&&this.lightManager.csm&&this.lightManager.csm.updateCascades()}getOrCreateObjectGroup(e,t){for(var i=this.objectGroups.children,a=0,n=i.length;a<n;a++)if(i[a].name==e)return i[a];var s=new r.ObjectGroup(e,t);return s.isGlobalSpace()&&(s.matrix.copy(this.geometryGroup.matrix),s.matrixAutoUpdate=!1,s.updateMatrixWorld(!0)),this.objectGroups.add(s),s}getObjectGroup(e){for(var t=this.objectGroups.children,i=0,r=t.length;i<r;i++)if(t[i].name==e)return t[i];return null}getObjectGroupType(e){var t=e.split("|");return{groupType:t[0],databagId:t.length>1?t[1]:void 0}}getObjectGroups(){return this.objectGroups.children}removeObjectGroup(e){this.objectGroups.remove(e)}removeObjectGroupByName(e){this.objectGroups.removeByName(e)}hasObjectGroup(e){return this.objectGroups.hasChild(e)}intersectToWorld(e,t){const i=this.getRawMatrixGlobal();e.worldPosition=r.GeomUtil.getWorldPositionOfMesh(e.point,i);const a=e.fileId,n=t.getModelManager().getModel(a);n&&n.transformMatrix?n.transformMatrix:new THREE.Matrix4;let s={};s[e.userId]=!0;const o=t.getBoundingBoxByIds(s,a),l=t.drawingToWorld(o.min.clone()),d=t.drawingToWorld(o.max.clone()),h=new THREE.Vector3(l.x,l.y,l.z),c=new THREE.Vector3(d.x,d.y,d.z);e.worldBoundingBox=(new THREE.Box3).setFromPoints([h,c]),e.unit=t.getModelManager().getSceneUnit()}worldToDrawing(e){var t=this.getMatrixGlobal(),i=new THREE.Vector3(e.x,e.y,e.z);return i.applyMatrix4(t),i}drawingToWorld(t){var i=this.getMatrixGlobal();e.copy(i).invert();var r=new THREE.Vector3(t.x,t.y,t.z);return r.applyMatrix4(e),r}getBoundingBoxWorldByMesh(t){var i=this.getMatrixGlobal(),r=t.boundingBox;r||(t.geometry.boundingBox||t.geometry.computeBoundingBox(),r=t.geometry.boundingBox);var a=r.clone();return a.applyMatrix4(t.matrixWorld),e.copy(i).invert(),a.applyMatrix4(e),a}getObjectPool(){return this.pool}setBoundingBoxWorld(e){this.geometryGroup.boundingBox?this.geometryGroup.boundingBox.copy(e):this.geometryGroup.boundingBox=e,this.originalBoundingBoxWorld=e.clone()}updateBoundingBoxWorld(e){this.geometryGroup.boundingBox=this.geometryGroup.boundingBox||new THREE.Box3,this.originalBoundingBoxWorld=this.originalBoundingBoxWorld||new THREE.Box3,this.geometryGroup.boundingBox.expandByPoint(e.min),this.geometryGroup.boundingBox.expandByPoint(e.max),this.originalBoundingBoxWorld.expandByPoint(e.min),this.originalBoundingBoxWorld.expandByPoint(e.max)}setBoundingBoxWorldWithoutDEM(e){this.boundingBoxWorldWithoutDEM=this.boundingBoxWorldWithoutDEM||new THREE.Box3,this.boundingBoxWorldWithoutDEM.copy(e)}updateBoundingBoxWorldWithoutDEM(e){this.boundingBoxWorldWithoutDEM=this.boundingBoxWorldWithoutDEM||new THREE.Box3,this.boundingBoxWorldWithoutDEM.expandByPoint(e.min),this.boundingBoxWorldWithoutDEM.expandByPoint(e.max)}getBoundingBoxWithoutDEM(){if(this.boundingBoxWorldWithoutDEM)return t.copy(this.boundingBoxWorldWithoutDEM),t.applyMatrix4(this.geometryGroup.matrix),t}getBoundingBoxOfGeometries(e){for(var t=!e,i=new THREE.Box3,a=this.pool._pool,n=0,s=this.pool.counter;n<s;++n){var o=a[n];if(o.isVisible()){var l=o.geometry;if(l){if(t||void 0!==e[o.name]){l.boundingBox||l.computeBoundingBox();var d=l.boundingBox;if(d){var h=d.clone();o.matrixWorld&&h.applyMatrix4(o.matrixWorld),i.expandByPoint(h.min),i.expandByPoint(h.max)}}}else r.Logger.log("empty geometry!")}}return i}getTransformMatrixGlobal(){return this.transformMatrix}setTransformMatrixGlobal(e){this.transformMatrix.copy(e)}adjustInstanceVisibility(e){this.traverse((function(t){if((t instanceof THREE.Mesh||t instanceof THREE.LineSegments)&&t.geometry instanceof THREE.InstancedBufferGeometry){var i=t.visible;if(i==e)return;e&&!t.bVisible||(t.visible=e),t.bVisible=i}}))}adjustVisibility(e){this.traverse((function(t){if((t instanceof THREE.Mesh||t instanceof THREE.LineSegments)&&!(t.geometry instanceof THREE.InstancedBufferGeometry)){var i=t.visible;if(i==e)return;e&&!t.bVisible||(t.visible=e),t.bVisible=i}}))}changeVisibilityOfSelectedObjects(e){var t=this;e||(t.selectedMeshes.length=0,t.selectedInstanceMeshes.length=0);var i=t.selectedMeshes,a=t.selectedInstanceMeshes;this.traverse((function(n){(n instanceof THREE.Mesh||n instanceof THREE.LineSegments)&&(n.geometry instanceof THREE.InstancedBufferGeometry?e?function(e){for(var i=0,a=t.selectedInstanceMeshes.length;i<a;i++)if(e===t.selectedInstanceMeshes[i].object){for(var n=t.selectedInstanceMeshes[i].indices,s=e.geometry.getAttribute("vState").array,o=0,l=n.length;o<l;o++)s[n[o]]=r.EnumInstanceState.SELECTED;e.geometry.getAttribute("vState").needsUpdate=!0}}(n):function(e){if(e.visible){for(var t=[],i=e.geometry.getAttribute("vState").array,n=0;n<i.length;++n)i[n]===r.EnumInstanceState.SELECTED&&(t.push(n),i[n]=r.EnumInstanceState.HIDDEN);t.length&&(e.geometry.getAttribute("vState").needsUpdate=!0,a.push({object:e,indices:t}))}}(n):e?function(e){for(var i=0,r=t.selectedMeshes.length;i<r;i++)if(e===t.selectedMeshes[i].object)for(var a=t.selectedMeshes[i].indices,n=0,s=a.length;n<s;n++){var o=a[n],l=e.geometry.groups[o.idx];l.start=o.start,l.count=o.count}}(n):function(e){if(e._indicesGroup&&e.visible){var t=[],a=e.geometry.groups;if(a&&a.length){for(var n=0,s=a.length;n<s;n++){var o=a[n];o.materialIndex===r.Model.EnumFilterState.SELECTED&&(t.push({idx:n,start:o.start,count:o.count}),o.start=0,o.count=0)}t.length&&i.push({object:e,indices:t})}}}(n))}))}changeVisibilityOfNonSelectedObjects(e){var t=this;e||(t.nonSelectedMeshes.length=0,t.nonSelectedInstanceMeshes.length=0);var i=t.nonSelectedMeshes,a=t.nonSelectedInstanceMeshes;this.traverse((function(n){(n instanceof THREE.Mesh||n instanceof THREE.LineSegments)&&(n.geometry instanceof THREE.InstancedBufferGeometry?e?function(e){for(var i=0,r=t.nonSelectedInstanceMeshes.length;i<r;i++)if(e===t.nonSelectedInstanceMeshes[i].object){for(var a=t.nonSelectedInstanceMeshes[i].indices,n=e.geometry.getAttribute("vState").array,s=0,o=a.length;s<o;s++)n[a[s].idx]=a[s].state;e.geometry.getAttribute("vState").needsUpdate=!0}}(n):function(e){if(e.visible){for(var t=[],i=e.geometry.getAttribute("vState").array,n=0,s=i.length;n<s;++n)i[n]!==r.EnumInstanceState.SELECTED&&i[n]!==r.EnumInstanceState.HIDDEN&&(t.push({idx:n,state:i[n]}),i[n]=r.EnumInstanceState.HIDDEN);t.length&&(e.geometry.getAttribute("vState").needsUpdate=!0,a.push({object:e,indices:t}))}}(n):e?function(e){for(var i=0,r=t.nonSelectedMeshes.length;i<r;i++)if(e===t.nonSelectedMeshes[i].object){var a=t.nonSelectedMeshes[i].indices;if(null===a)e.visible=!0;else for(var n=0,s=a.length;n<s;n++){var o=a[n],l=e.geometry.groups[o.idx];l.start=o.start,l.count=o.count}}}(n):function(e){if(e._indicesGroup&&e.visible){var t=[],a=e.geometry.groups;if(a&&a.length){for(var n=0,s=a.length;n<s;n++){var o=a[n];o.materialIndex!==r.Model.EnumFilterState.SELECTED&&(t.push({idx:n,start:o.start,count:o.count}),o.start=0,o.count=0)}t.length?i.push({object:e,indices:t}):(e.visible=!1,i.push({object:e,indices:null}))}else e.visible=!1,i.push({object:e,indices:null})}}(n))}))}clearSelectedAndNonSelectedMeshes(){this.selectedMeshes.length=0,this.nonSelectedMeshes.length=0,this.selectedInstanceMeshes.length=0,this.nonSelectedInstanceMeshes.length=0}drawBoundingBox(e){if(e){var t=this.getOrCreateObjectGroup("BoundingBox",{pickable:0,priority:2}),i=this.getBoundingBox();void 0===this.boudingBoxNode?(this.boudingBoxNode=new r.BBoxNode(i,16711680),t.add(this.boudingBoxNode)):this.boudingBoxNode.updateBBox(i),this.boudingBoxNode.updateMatrixWorld(!0)}else this.removeObjectGroupByName("BoundingBox")}calculateGisMapBox(t){var i=this.getObjectGroup(r.GlobalData.TileGlobalGroupName)||this.getObjectGroup(r.GlobalData.TilePlaneGroupName),a=this.getBoundingBoxWorld(),n=a.clone();if(i){var s=t.position.clone(),o=this.getMatrixWorldGlobal();e.copy(o).invert(),s.applyMatrix4(e);var l=r.Tile.TileMath.earthRadius*r.Tile.TileMath.unitScale,d=s.z-a.min.z;d=Math.abs(d);var h=l*Math.acos(l/(l+d)),c=void 0!==i.altitudeOffset?i.altitudeOffset*r.Tile.TileMath.unitScale:void 0;n.min.x=s.x-h,n.max.x=s.x+h,n.min.y=s.y-h,n.max.y=s.y+h,n.min.z=void 0!==c&&c>0?Math.min(a.min.z,-c):a.min.z,n.max.z=void 0!==c&&c<0?Math.max(a.max.z,-c):a.max.z;var u=i.heightRange;void 0!==u&&u.max>u.min&&(n.min.z=Math.min(n.min.z,u.min),n.max.z=Math.max(n.max.z,u.max))}return n}getTerrainHeightRange(){const e=this.getObjectGroup(r.GlobalData.TileGlobalGroupName)||this.getObjectGroup(r.GlobalData.TilePlaneGroupName);if(e){const t=e.heightRange;if(void 0!==t&&t.max>t.min)return{max:t.max,min:t.min}}}}r.Scene=i})(),(()=>{let e=new THREE.Vector3;r.Raycaster=function(e,t,i,r){this.ray=new THREE.Ray(e,t),this.near=i||0,this.far=r||1/0,this.params={Sprite:{},Mesh:{},Points:{threshold:1},LOD:{},Line:{threshold:1}}},r.Raycaster.prototype={constructor:r.Raycaster,precision:1e-4,linePrecision:1,descSort:function(e,t){return e.distance-t.distance},set:function(e,t){this.ray.set(e,t)},setFromCamera:function(e,t){t instanceof r.CombinedCamera?t.isPerspective?(this.ray.origin.copy(t.position),this.ray.direction.set(e.x,e.y,.5).unproject(t).sub(t.position).normalize()):(this.ray.origin.set(e.x,e.y,(t.near+t.far)/(t.near-t.far)).unproject(t),this.ray.direction.set(0,0,-1).transformDirection(t.matrixWorld)):t instanceof THREE.PerspectiveCamera?(this.ray.origin.copy(t.position),this.ray.direction.set(e.x,e.y,.5).unproject(t).sub(t.position).normalize()):t instanceof THREE.OrthographicCamera?(this.ray.origin.set(e.x,e.y,(t.near+t.far)/(t.near-t.far)).unproject(t),this.ray.direction.set(0,0,-1).transformDirection(t.matrixWorld)):console.error("CLOUD.Raycaster: Unsupported camera type.")},intersectOctantForNode:function(t,i){var r=this,a=new THREE.Box3;!function t(n){var s,o;if(a.set(n.min,n.max),r.ray.intersectBox(a,e)&&(i.push(n),n.childOctants))for(s=0,o=n.childOctants.length;s<o;s++)t(n.childOctants[s])}(t)}},THREE.Ray.prototype.intersectBoxWithDistance=function(t){var i,r,a,n,s,o,l=1/this.direction.x,d=1/this.direction.y,h=1/this.direction.z,c=this.origin;if(l>=0?(i=(t.min.x-c.x)*l,r=(t.max.x-c.x)*l):(i=(t.max.x-c.x)*l,r=(t.min.x-c.x)*l),d>=0?(a=(t.min.y-c.y)*d,n=(t.max.y-c.y)*d):(a=(t.max.y-c.y)*d,n=(t.min.y-c.y)*d),i>n||a>r)return-1;if((a>i||i!=i)&&(i=a),(n<r||r!=r)&&(r=n),h>=0?(s=(t.min.z-c.z)*h,o=(t.max.z-c.z)*h):(s=(t.max.z-c.z)*h,o=(t.min.z-c.z)*h),i>o||s>r)return-1;if((s>i||i!=i)&&(i=s),(o<r||r!=r)&&(r=o),r<0)return-1;if(i<0)return 0;var u=this.at(i>=0?i:r,e),p=u.x-c.x,m=u.y-c.y,f=u.z-c.z;return Math.sqrt(p*p+m*m+f*f)}})(),r.CapsuleObject=class{constructor(e,t){this.id=e,this.object=t}destroy(){this.object=null}_inDistanceRange(e,t){return e>=t.near&&e<=t.far}raycast(e,t,i,r,a){}},function(){class e extends r.CapsuleObject{constructor(e,t){super(e,t)}raycast(e,t,i,a,n,s,o){var l=[];if(this.object.raycast(e,l),l.length>0){l.sort((function(e,t){return e.distance-t.distance}));for(var d=0,h=l.length;d<h;d++){var c=l[d];const e=t.userId,h=c.point;if(!(o&&o[e]&&a.clipConditionPoint(h))&&(this._inDistanceRange(c.distance,i)&&!a.clipPoint(h))){s||(i.far=c.distance-r.Utils.MinusEpsilon),n.push(c);break}}}}intersectByBox(e,t,i){const r=this.object.geometry;if(!r.isBufferGeometry)return null;const a=r.index,n=r.attributes.position,s={indexStart:Math.max(0,r.drawRange.start),indexCount:Math.min(a?a.count:n.count,r.drawRange.count),positionStart:0,positionCount:3*n.count};return this.object.intersectByBox(e,t,s)}}class t extends r.CapsuleObject{constructor(e,t){super(e,t)}raycast(e,t,i,a,n){var s=this.object,o=[],l=s.geometry,d={indexStart:l.drawRange.start,indexCount:l.drawRange.count};if(s.raycastByIndices2(e,o,d,!1),o.length>0){o.sort((function(e,t){return e.distance-t.distance}));for(var h=0,c=o.length;h<c;h++){var u=o[h];if(this._inDistanceRange(u.distance,i)&&!a.clipPoint(u.point)){i.far=u.distance-r.Utils.MinusEpsilon,u.userId=t.userId,u.indexInfo=d,n.push(u);break}}}}intersectByBox(e,t,i){const r=this.object.geometry;if(!r.isBufferGeometry)return null;const a=r.attributes.position,n={indexStart:r.drawRange.start,indexCount:r.drawRange.count,positionStart:0,positionCount:3*a.count};return this.object.intersectByBox(e,t,n)}}r.SingleCapsuleObject=e,r.SingleCapsuleObjectWithDrawRange=t}(),function(){class e extends r.CapsuleObject{constructor(e,t){super(e,t)}_getIndexInfo(e){var t=this.object._indicesGroup;if(!t)return null;var i=t[e.userId];if(!i)return null;for(var r,a=!1,n=0,s=i.length;n<s;n++)if(i[n].nodeId===e.nodeId){r=i[n],a=!0;break}return a?r:null}raycast(e,t,i,a,n,s,o){var l=this.object;let d=this._getIndexInfo(t);if(d){var h=[];if(l.raycastByIndices(e,h,d),h.length>0){h.sort((function(e,t){return e.distance-t.distance}));for(var c=0,u=h.length;c<u;c++){var p=h[c];const e=d.userId,t=p.point;if(!(o&&o[e]&&a.clipConditionPoint(t))&&(this._inDistanceRange(p.distance,i)&&!a.clipPoint(t))){s||(i.far=p.distance-r.Utils.MinusEpsilon),p.userId=e,p.indexInfo=d,n.push(p);break}}}}}intersectByBox(e,t,i){var r=this.object;let a=this._getIndexInfo(i);return!!a&&r.intersectByBox(e,t,a)}}r.BatchedCapsuleObject=e}(),function(){class e extends r.CapsuleObject{constructor(e,t){super(e,t)}raycast(e,t,i,a,n,s,o){var l=[];if(this.object.raycastByIndices(e,l,null,t.matrix),l.length>0){l.sort((function(e,t){return e.distance-t.distance}));for(var d=0,h=l.length;d<h;d++){var c=l[d];const e=t.userId,h=c.point;if(!(o&&o[e]&&a.clipConditionPoint(h))&&(this._inDistanceRange(c.distance,i)&&!a.clipPoint(h))){s||(i.far=c.distance-r.Utils.MinusEpsilon),c.userId=t.userId,c.matrix=t.matrix,n.push(c);break}}}}intersectByBox(e,t,i){return this.object.intersectByBox(e,t,null,i.matrix)}}r.InstancedCapsuleObject=e}(),function(){class e extends THREE.Camera{constructor(e,t={}){super(),this.cameraType=e||r.CAMERATYPE.PERSPECTIVE,this.target=new THREE.Vector3,this.name=t.name||"",this.near=t.near||.1,this.far=t.far||2e3,this.fov=t.fov||45,this.cameraType===r.CAMERATYPE.PERSPECTIVE?(t.width&&t.height&&(this.aspect=t.width/t.height,this.left=-t.width/2,this.right=t.width/2,this.top=t.height/2,this.bottom=-t.height/2),this.perspectiveCamera=new r.CloudPerspectiveCamera(this.fov,this.aspect,this.near,this.far),this.orthoCamera=null,this.toPerspective()):(this.left=t.left,this.right=t.right,this.top=t.top,this.bottom=t.bottom,void 0!==t.left&&void 0!==t.right&&void 0!==t.top&&void 0!==t.bottom&&(this.aspect=(this.right-this.left)/(this.top-this.bottom)),this.orthoCamera=new THREE.OrthographicCamera(this.left,this.right,this.top,this.bottom,this.near,this.far),this.perspectiveCamera=null,this.orthoCamera.updateProjectionMatrix(),this.projectionMatrix=this.orthoCamera.projectionMatrix,this.isPerspective=!1),this.zoom=t.zoom||1,this.updateProjectionMatrixByFrustum=!1}toPerspective(){null!==this.perspectiveCamera?this.updateProjectionMatrixByFrustum||(this.perspectiveCamera.aspect=this.aspect,this.perspectiveCamera.near=this.near,this.perspectiveCamera.far=this.far,this.perspectiveCamera.fov=this.fov,this.perspectiveCamera.updateProjectionMatrix(),this.projectionMatrix=this.perspectiveCamera.projectionMatrix,this.projectionMatrixInverse=this.perspectiveCamera.projectionMatrixInverse,this.isPerspective=!0,this.dirty=!0):console.log("Can not convert to perspective camera because the camera original type is orthographic.")}toOrthographic(){null===this.orthoCamera&&(this.orthoCamera=new THREE.OrthographicCamera(this.left,this.right,this.top,this.bottom,this.near,this.far));var e=this.fov,t=this.target.clone().sub(this.position).length(),i=Math.tan(e*Math.PI/180/2)*t,r=i*this.aspect;i/=this.zoom,r/=this.zoom,this.left=this.orthoCamera.left=-r,this.right=this.orthoCamera.right=r,this.top=this.orthoCamera.top=i,this.bottom=this.orthoCamera.bottom=-i,this.orthoCamera.near=this.near,this.orthoCamera.far=this.far,this.orthoCamera.updateProjectionMatrix(),this.projectionMatrix=this.orthoCamera.projectionMatrix,this.projectionMatrixInverse=this.orthoCamera.projectionMatrixInverse,this.isPerspective=!1,this.dirty=!0}setSize(e,t){this.left=-e/2,this.right=e/2,this.top=t/2,this.bottom=-t/2,this.aspect=e/t,this.dirty=!0}setSizeByFrustum(e,t){var i,r=2*this.right,a=2*this.top;this.aspect=r/a,r/a<e/t?(i=a/r,this.perspectiveCamera.setProjectOnWidth(!0)):(i=r/a,this.perspectiveCamera.setProjectOnWidth(!1)),this.dirty=!0,this.isPerspective&&(this.perspectiveCamera.aspect=i,this.perspectiveCamera.near=this.near,this.perspectiveCamera.far=this.far,this.perspectiveCamera.fov=this.fov,this.perspectiveCamera.updateProjectionMatrixByFrustum(e,t),this.projectionMatrix=this.perspectiveCamera.projectionMatrix,this.isPerspective=!0,this.dirty=!0)}setFov(e){this.fov=e,this.dirty=!0,this.updateProjectionMatrix()}setNearFar(e,t){this.near=e,this.far=t,this.dirty=!0,this.updateProjectionMatrix()}updateProjectionMatrix(){this.isPerspective?this.toPerspective():this.toOrthographic()}setLens(e,t){void 0===t&&(t=24);var i=2*THREE.Math.radToDeg(Math.atan(t/(2*e)));return this.setFov(i),this.dirty=!0,i}setZoom(e){this.zoom=e,this.dirty=!0,this.updateProjectionMatrix()}copy(e){return super.copy(e),this.cameraType=e.cameraType,this.target.copy(e.target),this.aspect=e.aspect,this.fov=e.fov,this.near=e.near,this.far=e.far,this.left=e.left,this.right=e.right,this.top=e.top,this.bottom=e.bottom,this.zoom=e.zoom,this.isPerspective=e.isPerspective,this.updateProjectionMatrixByFrustum=e.updateProjectionMatrixByFrustum,this.orthoCamera&&e.orthoCamera&&this.orthoCamera.copy(e.orthoCamera),this.perspectiveCamera&&e.perspectiveCamera&&this.perspectiveCamera.copy(e.perspectiveCamera),this}clone(){return new this.constructor(this.cameraType).copy(this)}isDirty(){return this.dirty}}r.CombinedCamera=e}();class w extends THREE.PerspectiveCamera{constructor(e,t,i,r){super(e,t,i,r),this.projectOnWidth=!1}updateProjectionMatrixByFrustum(e,t){var i,r,a,n,s=this.near;this.projectOnWidth?(r=-.5*(a=e),i=.5*(n=this.aspect*a)):(i=.5*(n=t),r=-.5*(a=this.aspect*n));var o=this.view;if(null!==o){var l=o.fullWidth,d=o.fullHeight;r+=o.offsetX*a/l,i-=o.offsetY*n/d,a*=o.width/l,n*=o.height/d}var h=this.filmOffset;0!==h&&(r+=s*h/this.getFilmWidth()),this.projectionMatrix.makePerspective(r,r+a,i,i-n,s,this.far)}setProjectOnWidth(e){this.projectOnWidth=e}}r.CloudPerspectiveCamera=w,(()=>{class e extends r.CombinedCamera{constructor(e,t){super(e,t),this.realUp=this.up.clone(),this.dirty=!1,this.orthoScale=1,this.positionPlane=new THREE.Plane,this.projScreenMatrix=new THREE.Matrix4,this.viewProjInverse=new THREE.Matrix4,this.frustum=new THREE.Frustum,this.frustumHeightFactor=this.computeFrustumHeightFactor(),this.minimumElevation=null,this._statusInitialized=!1,this._direction=null,this.statusChange=!1,this._inverseMatrix=new THREE.Matrix4,this.scratchVector=new THREE.Vector3,this.scratchVector_2=new THREE.Vector3,this.scratchVector_3=new THREE.Vector3}get statusInitialized(){return this._statusInitialized}direction(e){return this._direction||(this._direction=new THREE.Vector3),this._direction.subVectors(this.target,this.position),r.Utils.isDefined(e)||(e=new THREE.Vector3),e.copy(this._direction)}_updatePositionPlane(){this.positionPlane.setFromNormalAndCoplanarPoint(this.getWorldDirection(this.scratchVector),this.position)}_updateFrustum(){this.frustum.setFromProjectionMatrix(this.projScreenMatrix)}updateMVP(){this.dirty&&(this._statusInitialized||(this._statusInitialized=!0),null===this.parent&&this.updateMatrixWorld(),this.matrixWorldInverse.copy(this.matrixWorld).invert(),this.projScreenMatrix.multiplyMatrices(this.projectionMatrix,this.matrixWorldInverse),this.viewProjInverse.copy(this.projScreenMatrix).invert(),this._updateFrustum(),this._updatePositionPlane(),this.frustumHeightFactor=this.computeFrustumHeightFactor())}computeFrustumHeightFactor(){return 2*Math.tan(.5*THREE.Math.degToRad(this.fov))}getFrustum(){return this.dirty&&this.updateMVP(),this.frustum}LookAt(e,t,i,r){let a=new THREE.Vector3;a.copy(t),void 0!==r&&a.setLength(r),this.position.subVectors(e,a),this.up=i,this.lookAt(e),this.realUp=i.clone(),this.target=e.clone(),this.dirty=!0}copy(e){return super.copy(e),this.realUp.copy(e.realUp),this.orthoScale=e.orthoScale,this.dirty=e.dirty,this.positionPlane.copy(e.positionPlane),this.projScreenMatrix.copy(e.projScreenMatrix),this.viewProjInverse.copy(e.viewProjInverse),this.frustum.copy(e.frustum),this}setStandardView(e,t){var i;i=t?t.getCenter(this.scratchVector):new THREE.Vector3(0,0,0);var a=r.GlobalData.SceneSize,n=a/2;switch(e){case r.EnumStandardView.ISO:var s=new THREE.Vector3(-a,a,a),o=new THREE.Vector3,l=new THREE.Vector3(0,0,0);o.subVectors(l,s),this.LookAt(i,o,THREE.Object3D.DefaultUp);break;case r.EnumStandardView.Top:this.LookAt(i,new THREE.Vector3(0,-1,0),new THREE.Vector3(0,0,-1),n);break;case r.EnumStandardView.Bottom:this.LookAt(i,new THREE.Vector3(0,1,0),new THREE.Vector3(0,0,1),n);break;case r.EnumStandardView.Front:this.LookAt(i,new THREE.Vector3(0,0,-1),new THREE.Vector3(0,1,0),n);break;case r.EnumStandardView.Back:this.LookAt(i,new THREE.Vector3(0,0,1),new THREE.Vector3(0,1,0),n);break;case r.EnumStandardView.Right:this.LookAt(i,new THREE.Vector3(-1,0,0),new THREE.Vector3(0,1,0),n);break;case r.EnumStandardView.Left:this.LookAt(i,new THREE.Vector3(1,0,0),new THREE.Vector3(0,1,0),n);break;case r.EnumStandardView.SouthEast:this.LookAt(i,new THREE.Vector3(-1,0,-1),new THREE.Vector3(0,1,0),n);break;case r.EnumStandardView.SouthWest:this.LookAt(i,new THREE.Vector3(1,0,-1),new THREE.Vector3(0,1,0),n);break;case r.EnumStandardView.NorthWest:this.LookAt(i,new THREE.Vector3(1,0,1),new THREE.Vector3(0,1,0),n);break;case r.EnumStandardView.NorthEast:this.LookAt(i,new THREE.Vector3(-1,0,1),new THREE.Vector3(0,1,0),n);break;case r.EnumStandardView.BottomFront:this.LookAt(i,new THREE.Vector3(0,1,-1),new THREE.Vector3(0,1,0),n);break;case r.EnumStandardView.BottomBack:this.LookAt(i,new THREE.Vector3(0,1,1),new THREE.Vector3(0,1,0),n);break;case r.EnumStandardView.BottomRight:this.LookAt(i,new THREE.Vector3(-1,1,0),new THREE.Vector3(0,1,0),n);break;case r.EnumStandardView.BottomLeft:this.LookAt(i,new THREE.Vector3(1,1,0),new THREE.Vector3(0,1,0),n);break;case r.EnumStandardView.BottomSouthEast:this.LookAt(i,new THREE.Vector3(-1,1,-1),new THREE.Vector3(0,1,0),n);break;case r.EnumStandardView.BottomSouthWest:this.LookAt(i,new THREE.Vector3(1,1,-1),new THREE.Vector3(0,1,0),n);break;case r.EnumStandardView.BottomNorthWest:this.LookAt(i,new THREE.Vector3(1,1,1),new THREE.Vector3(0,1,0),n);break;case r.EnumStandardView.BottomNorthEast:this.LookAt(i,new THREE.Vector3(-1,1,1),new THREE.Vector3(0,1,0),n);break;case r.EnumStandardView.RoofFront:this.LookAt(i,new THREE.Vector3(0,-1,-1),new THREE.Vector3(0,1,0),n);break;case r.EnumStandardView.RoofBack:this.LookAt(i,new THREE.Vector3(0,-1,1),new THREE.Vector3(0,1,0),n);break;case r.EnumStandardView.RoofRight:this.LookAt(i,new THREE.Vector3(-1,-1,0),new THREE.Vector3(0,1,0),n);break;case r.EnumStandardView.RoofLeft:this.LookAt(i,new THREE.Vector3(1,-1,0),new THREE.Vector3(0,1,0),n);break;case r.EnumStandardView.RoofSouthEast:this.LookAt(i,new THREE.Vector3(-1,-1,-1),new THREE.Vector3(0,1,0),n);break;case r.EnumStandardView.RoofSouthWest:this.LookAt(i,new THREE.Vector3(1,-1,-1),new THREE.Vector3(0,1,0),n);break;case r.EnumStandardView.RoofNorthWest:this.LookAt(i,new THREE.Vector3(1,-1,1),new THREE.Vector3(0,1,0),n);break;case r.EnumStandardView.RoofNorthEast:this.LookAt(i,new THREE.Vector3(-1,-1,1),new THREE.Vector3(0,1,0),n);break;case r.EnumStandardView.TopTurnRight:this.LookAt(i,new THREE.Vector3(0,-1,0),new THREE.Vector3(-1,0,0),n);break;case r.EnumStandardView.TopTurnBack:this.LookAt(i,new THREE.Vector3(0,-1,0),new THREE.Vector3(0,0,1),n);break;case r.EnumStandardView.TopTurnLeft:this.LookAt(i,new THREE.Vector3(0,-1,0),new THREE.Vector3(1,0,0),n);break;case r.EnumStandardView.BottomTurnRight:this.LookAt(i,new THREE.Vector3(0,1,0),new THREE.Vector3(-1,0,0),n);break;case r.EnumStandardView.BottomTurnBack:this.LookAt(i,new THREE.Vector3(0,1,0),new THREE.Vector3(0,0,-1),n);break;case r.EnumStandardView.BottomTurnLeft:this.LookAt(i,new THREE.Vector3(0,1,0),new THREE.Vector3(1,0,0),n);break;case r.EnumStandardView.FrontTurnTop:this.LookAt(i,new THREE.Vector3(0,0,-1),new THREE.Vector3(0,-1,0),n);break;case r.EnumStandardView.FrontTurnLeft:this.LookAt(i,new THREE.Vector3(0,0,-1),new THREE.Vector3(1,0,0),n);break;case r.EnumStandardView.FrontTurnRight:this.LookAt(i,new THREE.Vector3(0,0,-1),new THREE.Vector3(-1,0,0),n);break;case r.EnumStandardView.RightTurnTop:this.LookAt(i,new THREE.Vector3(-1,0,0),new THREE.Vector3(0,-1,0),n);break;case r.EnumStandardView.RightTurnFront:this.LookAt(i,new THREE.Vector3(-1,0,0),new THREE.Vector3(0,0,-1),n);break;case r.EnumStandardView.RightTurnBack:this.LookAt(i,new THREE.Vector3(-1,0,0),new THREE.Vector3(0,0,1),n);break;case r.EnumStandardView.BackTurnTop:this.LookAt(i,new THREE.Vector3(0,0,1),new THREE.Vector3(0,-1,0),n);break;case r.EnumStandardView.BackTurnLeft:this.LookAt(i,new THREE.Vector3(0,0,1),new THREE.Vector3(-1,0,0),n);break;case r.EnumStandardView.BackTurnRight:this.LookAt(i,new THREE.Vector3(0,0,1),new THREE.Vector3(1,0,0),n);break;case r.EnumStandardView.LeftTurnTop:this.LookAt(i,new THREE.Vector3(1,0,0),new THREE.Vector3(0,-1,0),n);break;case r.EnumStandardView.LeftTurnBack:this.LookAt(i,new THREE.Vector3(1,0,0),new THREE.Vector3(0,0,1),n);break;case r.EnumStandardView.LeftTurnFront:this.LookAt(i,new THREE.Vector3(1,0,0),new THREE.Vector3(0,0,-1),n)}return this.updateProjectionMatrix(),i}zoomToBBox(e,t,i,r){i=i||1,t=(t=t||0)<-1?-1:t;var a=new THREE.Box3;if(a.copy(e),0!==t){var n=.5*e.getSize(this.scratchVector).length(),s=new THREE.Vector3;s.subVectors(a.max,a.min).normalize(),s.multiplyScalar(n*t),a.expandByVector(s)}var o=r||this.getWorldDirection(this.scratchVector),l=this.up,d=this.aspect,h=THREE.Math.degToRad(.5*this.fov),c=a.getSize(this.scratchVector_2),u=a.getCenter(this.scratchVector_3),p=.5*c.length()/Math.sin(h)*i,m=new THREE.Vector3;m.copy(o),m.setLength(p);var f=new THREE.Vector3;f.subVectors(u,m);var g=new THREE.Vector3;g.crossVectors(o,l),g.normalize();var v=new THREE.Vector3;v.crossVectors(o,g),v.normalize();var y=new THREE.Plane;y.setFromNormalAndCoplanarPoint(g,f);var M=new THREE.Plane;M.setFromNormalAndCoplanarPoint(v,f);var E=0,b=0,I=0,x=0,T=0,_=[new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3];_[0].set(a.min.x,a.min.y,a.min.z),_[1].set(a.min.x,a.min.y,a.max.z),_[2].set(a.min.x,a.max.y,a.min.z),_[3].set(a.min.x,a.max.y,a.max.z),_[4].set(a.max.x,a.min.y,a.min.z),_[5].set(a.max.x,a.min.y,a.max.z),_[6].set(a.max.x,a.max.y,a.min.z),_[7].set(a.max.x,a.max.y,a.max.z);for(var S=0;S<8;S++){var C=new THREE.Vector3;C.subVectors(_[S],f);var w=Math.abs(C.dot(o)),R=Math.abs(M.distanceToPoint(_[S])),B=R*d,L=Math.abs(y.distanceToPoint(_[S])),O=L/d,P=Math.max(R,O),D=Math.max(B,L);E<P&&(E=P),(!b||!I||P>b*w/I)&&(b=P,I=w),(!x||!T||D>x*w/T)&&(x=D,T=w)}var A,N=x/Math.tan(h)+(p-T),H=b/Math.tan(h)+(p-I);if((A=d<1?Math.max(N,H):Math.min(N,H))<this.near){this.near=(A*A+.001*A)/16777.216}if(m.copy(o).normalize().setLength(A),f.subVectors(u,m),this.position.copy(f),this.lookAt(u),this.target.copy(u),!this.isPerspective){var U=Math.tan(this.fov*Math.PI/180/2)*A;this.orthoScale=U/E,this.zoom=this.orthoScale}return this.updateProjectionMatrix(),this.dirty=!0,u}calculateNearFar(e,t){const i=e,r=[new THREE.Vector3(i.min.x,i.min.y,i.min.z),new THREE.Vector3(i.min.x,i.min.y,i.max.z),new THREE.Vector3(i.min.x,i.max.y,i.min.z),new THREE.Vector3(i.min.x,i.max.y,i.max.z),new THREE.Vector3(i.max.x,i.min.y,i.min.z),new THREE.Vector3(i.max.x,i.min.y,i.max.z),new THREE.Vector3(i.max.x,i.max.y,i.min.z),new THREE.Vector3(i.max.x,i.max.y,i.max.z)],a=this.getWorldDirection(this.scratchVector),n=(new THREE.Plane).setFromNormalAndCoplanarPoint(a,this.position);let s=-1/0,o=1/0;r.forEach((e=>{const t=n.distanceToPoint(e);o>t-10&&(o=t-10),s<t+10&&(s=t+10)}));let l=o>0?o:.1,d=s>0?s:2e3;this.isPerspective?void 0!==t&&(l=t):l=-d,this.setNearFar(l,d)}calculateNearFar2(e,t,i){const r=e,a=r.getCenter(this.scratchVector),n=this.position.clone().sub(a).length(),s=r.getSize(this.scratchVector_2).length();let o,l;if(t){const e=.5*s;if(l=n+e,this.isPerspective){const t=.001;o=(n*n+n*t)/((1<<24)*t),n<e||i?o=.1:o+e>n&&(o=n-e)}else o=-l}else l=n,o=this.isPerspective?.1:-l;this.setNearFar(o,l)}computeRay(e,t,i){var r=new THREE.Vector2;if(void 0===i)r.x=window.innerWidth,r.y=window.innerHeight;else{var a=i===document?i.body:i;r.x=a.offsetWidth,r.y=a.offsetHeight}var n=new THREE.Vector2;n.x=e/r.x*2-1,n.y=-t/r.y*2+1;var s=new THREE.Ray;return this.isPerspective?(s.origin.copy(this.position),s.direction.set(n.x,n.y,.5).unproject(this).sub(this.position).normalize()):(s.origin.set(n.x,n.y,-1).unproject(this),s.direction.set(0,0,-1).transformDirection(this.matrixWorld)),s}screenToWorld(e,t,i,r){var a=this.computeRay(e,t,i),n=this.getWorldDirection(this.scratchVector).normalize(),s=new THREE.Plane(n);return s.setFromNormalAndCoplanarPoint(n,r),a.intersectPlane(s,r)}getWorldFrustum(e){var t=new THREE.Frustum,i=this.clone(),r=this.target,a=r.clone().sub(this.position).length();this._inverseMatrix.copy(e).invert();var n=new THREE.Matrix4;n.extractRotation(e);var s=new THREE.Quaternion;s.setFromRotationMatrix(n),s.inverse(),i.position.applyMatrix4(this._inverseMatrix);var o=r.clone();o.applyMatrix4(this._inverseMatrix);var l=o.clone().sub(i.position),d=l.length();l.normalize();var h=d/a;return i.far=camera.far*h,i.up.applyQuaternion(s).normalize(),i.realUp.applyQuaternion(s).normalize(),i.updateProjectionMatrix(),i.updateMatrixWorld(),this._inverseMatrix.copy(i.matrixWorld).invert(),t.setFromProjectionMatrix((new THREE.Matrix4).multiplyMatrices(i.projectionMatrix,this._inverseMatrix)),i=null,t}distanceFromWorldToDrawing(e,t){var i=this.position.clone(),r=this.target.clone();return r.subVectors(this.target,this.position),r.normalize(),this._inverseMatrix.copy(e).invert(),r.add(i).applyMatrix4(this._inverseMatrix),i.applyMatrix4(this._inverseMatrix),r.sub(i),r.normalize().multiplyScalar(t),r.add(i).applyMatrix4(e),r.sub(this.position),r.length()}getPositionByDis(e,t,i,r){var a=i||this.position,n=r||this.target;a=a.clone(),n=n.clone(),this._inverseMatrix.copy(t).invert(),a.applyMatrix4(this._inverseMatrix),n.applyMatrix4(this._inverseMatrix);var s=e/a.distanceTo(n),o=new THREE.Vector3;return o.subVectors(a,n),o.multiplyScalar(s),o.subVectors(a,o),o}getDistanceByPos(e,t){var i=this.position.clone();return this._inverseMatrix.copy(t).invert(),i.applyMatrix4(this._inverseMatrix),i.distanceTo(e)}updatePositionByMatrix(e,t){let i={position:this.position,target:this.target,up:this.up};i=r.Camera.drawingToWorld(i,e),i=r.Camera.worldToDrawing(i,t),this.position.copy(i.position),this.target.copy(i.target),this.up.copy(i.up)}static nearFarDrawingToWorld(e,t){let i=e.position.clone(),r=e.target.clone().sub(i);r.normalize();let a=new THREE.Matrix4;a.copy(t).invert();let n=(e,t,i,r)=>{let a=i.clone().multiplyScalar(e);a.add(t).applyMatrix4(r);let n=t.clone().applyMatrix4(r);a.sub(n);return e>0?a.length():-a.length()};return e.near&&e.far&&(e.near=n(e.near,i,r,a),e.far=n(e.far,i,r,a)),e.left&&e.right&&e.top&&e.bottom&&(e.left=n(e.left,i,r,a),e.right=n(e.right,i,r,a),e.top=n(e.top,i,r,a),e.bottom=n(e.bottom,i,r,a)),e}static drawingToWorld(e,t){let i=e.position.clone(),r=e.target.clone(),a=e.up.clone(),n=new THREE.Matrix4;return n.copy(t).invert(),a.add(i),a.applyMatrix4(n),i.applyMatrix4(n),r.applyMatrix4(n),a.sub(i),a.normalize(),{position:i,target:r,up:a}}static worldToDrawing(e,t){var i=e.position.clone(),r=e.target.clone(),a=e.up.clone();return a.add(i),a.applyMatrix4(t),i.applyMatrix4(t),r.applyMatrix4(t),a.sub(i),a.normalize(),{position:i,target:r,up:a}}}r.Camera=e})(),r.Animation=function(){var e=this,t=null,i={},r={},a=1e3,n=null,s=null,o=null,l=!1,d=null,h=null,c=null;this.from=function(e){for(var r in t=e)i[r]=t[r];return this},this.to=function(e,t){return void 0!==t&&(a=t),r=e,this},this.onStart=function(e){return d=e,this},this.onUpdate=function(e){return h=e,this},this.onComplete=function(e){return c=e,this},this.start=function(e){l=!1,s&&cancelAnimationFrame(s),n=Date.now(),o=this.interpolate,s=requestAnimationFrame((function u(){var p,m=i,f=r,g=Date.now();!1===l&&(null!==d&&d.call(t),l=!0),t=o(m,f,p=(p=(g-n)/a)>1?1:p),1===p?(cancelAnimationFrame(s),null!==c&&c.call(t)):(requestAnimationFrame(u,e),null!==h&&h.call(t,p))}),e)},this.isAngleGreaterThanPi=function(e,t,i){var r=new THREE.Vector3;return r.crossVectors(e,t),!(r.dot(i)>=0)},this.conicInterpolate=function(e,t,i,r){var a=-t.angleTo(e)*r,n=new THREE.Vector3;n.crossVectors(t,e).normalize();var s=new THREE.Quaternion;s.setFromAxisAngle(n,a),i.copy(e),i.applyQuaternion(s)},this.quaternionInterpolate=function(e,t,i,r,a){var n=new THREE.Quaternion(e.x,e.y,e.z,1).normalize(),s=new THREE.Quaternion(t.x,t.y,t.z,1).normalize(),o=new THREE.Quaternion(0,0,0,1),l=new THREE.Quaternion(0,0,0,1),d=new THREE.Vector3;d.crossVectors(e,i).normalize(),o.set(d.x,d.y,d.z,1).normalize();var h=0;a<.5?(h=2*a,THREE.Quaternion.slerp(n,o,l,h),r.set(l.x,l.y,l.z)):(h=2*(a-.5),THREE.Quaternion.slerp(o,s,l,h),r.set(l.x,l.y,l.z))},this.slerpInterpolate=function(e,t,i,r,a,n){var s=e.dot(t);n<s?r.copy(t):n<Math.abs(s)?this.quaternionInterpolate(e,t,i,r,a):this.conicInterpolate(e,t,r,a),r.normalize()},this.linearInterpolate=function(e,t,i,r,a){if(e.equals(t))i.copy(t);else{var n=new THREE.Vector3(1,0,0),s=new THREE.Vector3(0,0,1),o=new THREE.Vector3,l=0,d=e.dot(t);a<d?i.copy(t):a<-d?(a>Math.abs(e.dot(s))?o.crossVectors(e,s).normalize():o.crossVectors(e,n).normalize(),r<.5?(l=2*r,i.lerpVectors(e,o,l)):(l=2*(r-.5),i.lerpVectors(o,t,l))):i.lerpVectors(e,t,r),i.normalize()}},this.linearInterpolatePosition=function(e,t,i,r){i.lerpVectors(e,t,r)},this.sphericalInterpolate=function(e,t,i,r,a,n){var s=e.clone().sub(t),o=i.clone().sub(r),l=new THREE.Spherical;l.setFromVector3(s);var d=new THREE.Spherical;d.setFromVector3(o);let h=d.theta-l.theta;Math.abs(h)>Math.PI&&(h=h>0?-(2*Math.PI-Math.abs(h)):2*Math.PI-Math.abs(h));var c=l.theta+h*n,u=l.phi+(d.phi-l.phi)*n,p=s.length(),m=new THREE.Spherical;m.set(p,u,c);var f=new THREE.Vector3;f.setFromSpherical(m),a.copy(f).multiplyScalar(-1)},this.interpolate=function(t,i,r){var a=new THREE.Vector3,n=new THREE.Vector3,s=new THREE.Vector3,o=new THREE.Vector3,l=new THREE.Vector3,d=t.animPos,h=t.animTarget,c=(t.animDir,t.animUp),u=t.animFocal,p=t.zoom,m=i.animPos,f=i.animTarget,g=(i.animDir,i.animUp),v=i.animFocal,y=i.zoom;return e.sphericalInterpolate(d,h,m,f,a,r),e.linearInterpolate(c,g,n,r,.9995),e.linearInterpolatePosition(h,f,s,r),e.linearInterpolatePosition(u,v,o,r),e.linearInterpolatePosition(p,y,l,r),{animDir:a,animUp:n,animTarget:s,animFocal:o,zoomScale:l}}},(()=>{let e=new THREE.Vector3,t=new THREE.Vector3;r.CameraAnimator=class{constructor(){this._duration=500,this._frameTime=13,this._animation=new r.Animation}setDuration(e){this._duration=e}getDuration(){return this._duration}setFrameTime(e){this._frameTime=e}setStandardView(i,a,n,s,o,l){var d=a.camera,h=d.position.clone(),c=d.target.clone(),u=d.getWorldDirection(e);u.normalize();var p=new THREE.Vector3;p.copy(d.realUp||d.up),p.normalize();var m=new THREE.Vector3(d.position.clone().sub(c).length(),0,0);const f=a.camera.clone();f.setStandardView(i,n);let g=f.zoomToBBox(n,s);var v=f.position.clone(),y=f.getWorldDirection(t);y.normalize();var M=new THREE.Vector3;M.copy(f.realUp||f.up),M.normalize();var E=new THREE.Vector3(f.position.clone().sub(g).length(),0,0);a.getEditorManager().setInteractiveState(!1),this._animation.from({animPos:h,animDir:u,animUp:p,animTarget:c,animFocal:m,zoom:1}).to({animPos:v,animDir:y,animUp:M,animTarget:g,animFocal:E,zoom:1},this._duration).onUpdate((function(){if(a.camera){var e=this.animTarget,t=this.animDir,i=this.animUp,n=this.animFocal.x;a.camera.LookAt(e,t,i,n),a.cameraControl.update(!0,!0),a.modelManager.dispatchEvent({type:r.EVENTS.ON_CAMERA_ANIMATION_UPDATE}),o&&o()}})).onComplete((function(){a.camera&&(a.camera.LookAt(g,y,M,E.x),a.cameraControl.update(!0,!0),l&&l(),a.getEditorManager().setInteractiveState(!0))})).start(this._frameTime)}active(e,t,i,a,n){var s=i.camera,o=new THREE.Vector3(e.position.x,e.position.y,e.position.z),l=new THREE.Vector3(e.target.x,e.target.y,e.target.z),d=new THREE.Vector3(l.distanceTo(o),0,0),h=l.clone().sub(o).normalize(),c=new THREE.Vector3(e.up.x,e.up.y,e.up.z);c.normalize();var u=new THREE.Vector3(e.zoom),p=new THREE.Vector3(t.position.x,t.position.y,t.position.z),m=new THREE.Vector3(t.target.x,t.target.y,t.target.z),f=new THREE.Vector3(m.distanceTo(p),0,0),g=m.clone().sub(p).normalize(),v=new THREE.Vector3(t.up.x,t.up.y,t.up.z);v.normalize();var y=new THREE.Vector3(t.zoom,0,0);if(0==function(){let e=.01,t=p.clone().sub(o).length()<e,i=g.clone().sub(h).length()<e,r=v.clone().sub(c).length()<e;return!(t&&i&&r)}())return console.log("Current camera status is equal with before."),void(n&&n());i.getEditorManager().setInteractiveState(!1),this._animation.from({animPos:o,animDir:h,animUp:c,animTarget:l,animFocal:d,zoom:u}).to({animPos:p,animDir:g,animUp:v,animTarget:m,animFocal:f,zoom:y},this._duration).onUpdate((function(){var e=this.animTarget,t=this.animDir,n=this.animUp,o=this.animFocal.x,l=this.zoomScale.x;s.setZoom(l),s.LookAt(e,t,n,o),i.modelManager.dispatchEvent({type:r.EVENTS.ON_CAMERA_ANIMATION_UPDATE}),a&&a(e)})).onComplete((function(){s.setZoom(y.x),s.LookAt(m,g,v,f.x),a&&a(m),n&&n(),i.getEditorManager().setInteractiveState(!0)})).start(this._frameTime)}}})(),(()=>{let e=new THREE.Vector3,t=new THREE.Vector3,i=new THREE.Matrix4;var a;r.CameraInfo=function(e,t,i,r,a,n,s,o,l,d){this.name=e,this.position=t,this.target=i,this.up=r,this.near=a,this.far=n,this.zoom=s,this.frustumWidth=l,this.frustumHeight=d,this.version=void 0===o?1:o},r.PerspectiveCameraInfo=function(e,t,i,a,n,s,o,l,d,h,c){r.CameraInfo.call(this,"persp",e,t,i,s,o,l,d,h,c),this.fov=a,this.aspect=n},r.OrthographicCameraInfo=function(e,t,i,a,n,s,o,l,d,h,c,u,p){r.CameraInfo.call(this,"orth",e,t,i,l,d,h,c,u,p),this.left=a,this.right=n,this.top=s,this.bottom=o},r.CameraUtil={createCameraInfo:function(e){var t=e.camera,i=new CameraInfo(e.getCameraName(),t.position,t.target,t.up);return JSON.stringify(i)},transformCamera:function(e,t){var i=new THREE.Vector3,a=function(e){return[parseFloat(e[0]),parseFloat(e[1]),parseFloat(e[2])]};i.fromArray(a(e.position.split(",")));var n=new THREE.Vector3;n.fromArray(a(e.direction.split(",")));var s=new THREE.Vector3;s.fromArray(a(e.up.split(",")));var o=new THREE.Vector3;o.addVectors(i,n),i.applyMatrix4(t.rootNode.matrix),o.applyMatrix4(t.rootNode.matrix);var l=new THREE.Matrix4;return l.makeRotationFromEuler(t.rootNode.rotation),s.applyMatrix4(l),s.normalize(),new r.CameraInfo(e.name,i,o,s)},parseCameraInfo:function(e){if(!e)return null;var t=JSON.parse(e);if(!t.hasOwnProperty("position")||!t.hasOwnProperty("target")||!t.hasOwnProperty("up"))return null;var i=t.name||"persp",a=new THREE.Vector3;a.x=t.position.x,a.y=t.position.y,a.z=t.position.z;var n=new THREE.Vector3;n.x=t.target.x,n.y=t.target.y,n.z=t.target.z;var s=new THREE.Vector3;s.x=t.up.x,s.y=t.up.y,s.z=t.up.z;var o=void 0===t.version?0:t.version,l=t.frustumWidth,d=t.frustumHeight;return"persp"===i?new r.PerspectiveCameraInfo(a,n,s,t.fov,t.aspect,t.near,t.far,t.zoom,o,l,d):new r.OrthographicCameraInfo(a,n,s,t.left,t.right,t.top,t.bottom,t.near,t.far,t.zoom,o,l,d)},canvasToNormalized:function(e,t,i){var r={x:0,y:0,z:0};return r.x=e.x/t*2-1,r.y=-e.y/i*2+1,r.z=e.z||0,r},normalizedToCanvas:function(e,t,i){var r={x:0,y:0,z:0};return r.x=Math.floor(.5*(e.x+1)*t+.5),r.y=Math.floor(-.5*(e.y-1)*i+.5),r.z=e.z||0,r},drawingToCanvas:function(e,t,i,r){var a=new THREE.Vector3(t.x,t.y,t.z);return a.project(e),this.normalizedToCanvas(a,i,r)},drawingPointsToCanvas:function(e,t,r,a,n){var s={};i.copy(e.matrixWorld).invert();var o=new THREE.Vector3(t.x,t.y,t.z);o.applyMatrix4(i);var l=new THREE.Vector3(r.x,r.y,r.z);if(l.applyMatrix4(i),o.z>0&&l.z>0)return null;var d=o.clone().sub(l);if(d.normalize(),o.z>0){var h=(o.z+e.near)/d.z;o.sub(d.multiplyScalar(h))}else if(l.z>0){h=(l.z+e.near)/d.z;l.sub(d.multiplyScalar(h))}return o.applyMatrix4(e.projectionMatrix),l.applyMatrix4(e.projectionMatrix),s.start=this.normalizedToCanvas(o,a,n),s.end=this.normalizedToCanvas(l,a,n),s},lineIntersectWithRect:function(e,t){if(e&&e.start.x==e.end.x&&e.start.y==e.end.y)return console.log("Invalid line."),null;var i,r=0;e.start.x!=e.end.x&&(r=(e.start.y-e.end.y)/(e.start.x-e.end.x)),i=e.start.y-r*e.start.x;var a=[],n=t.min,s=t.max;return r*n.x+i>=n.y&&r*n.x+i<=s.y&&a.push(new THREE.Vector2(n.x,r*n.x+i)),r*s.x+i>=n.y&&r*s.x+i<=s.y&&a.push(new THREE.Vector2(s.x,r*s.x+i)),0==r&&(a.push(new THREE.Vector2(n.x,i)),a.push(new THREE.Vector2(s.x,i))),(n.y-i)/r>n.x&&(n.y-i)/r<s.x&&a.push(new THREE.Vector2((n.y-i)/r,n.y)),(s.y-i)/r>n.x&&(s.y-i)/r<s.x&&a.push(new THREE.Vector2((s.y-i)/r,s.y)),a},canvasToDrawing:function(e,t,i,r){var a=this.canvasToNormalized(t,i,r),n=new THREE.Vector3(a.x,a.y,a.z);return n.unproject(e),{x:n.x,y:n.y,z:n.z}},intersectBoxByRay:function(e,t){var i,r,a,n,s,o,l=1/e.direction.x,d=1/e.direction.y,h=1/e.direction.z,c=e.origin;return l>=0?(i=(t.min.x-c.x)*l,r=(t.max.x-c.x)*l):(i=(t.max.x-c.x)*l,r=(t.min.x-c.x)*l),d>=0?(a=(t.min.y-c.y)*d,n=(t.max.y-c.y)*d):(a=(t.max.y-c.y)*d,n=(t.min.y-c.y)*d),i>n||a>r?null:((a>i||i!=i)&&(i=a),(n<r||r!=r)&&(r=n),h>=0?(s=(t.min.z-c.z)*h,o=(t.max.z-c.z)*h):(s=(t.max.z-c.z)*h,o=(t.min.z-c.z)*h),i>o||s>r?null:((s>i||i!=i)&&(i=s),(o<r||r!=r)&&(r=o),r<0?null:i>=0?i:r))},intersectObjectWithFrustum:(a=new THREE.Box3,function(e,t){if(!e.boundingBox||e instanceof THREE.Mesh){var i=e.geometry;null===i.boundingBox&&i.computeBoundingBox(),a.copy(i.boundingBox)}else a.copy(e.boundingBox);return a.applyMatrix4(e.matrixWorld),t.intersectsBox(a)}),equalsCamera:function(i,a){const n=r.Math.EPSILON15;return r.Math.equalsEpsilonVec3(i.position,a.position,n)&&r.Math.equalsEpsilonVec3(i.up,a.up,n)&&r.Math.equalsEpsilonVec3(i.realUp,a.realUp,n)&&r.Math.equalsEpsilonVec3(i.getWorldDirection(e),a.getWorldDirection(t),n)&&r.Math.equalsEpsilonFrustum(i.frustum,a.frustum,n)}}})(),function(){class e extends THREE.Fog{constructor(){super();var e=this;e.postProcessMap=null,e.postProcessAdditiveMap=null,e.viewport={w:0,h:0},e.isPostOnly=!0,THREE.ShaderChunk.fog_pars_vertex="\n            #ifdef USE_FOG\n            #endif\n            ",THREE.ShaderChunk.fog_vertex="\n            #ifdef USE_FOG\n            #endif\n            ",THREE.ShaderChunk.fog_pars_fragment="\n                #ifdef USE_FOG\n                    uniform vec3 fogColor;\n                    uniform sampler2D postProcessMap;\n                    uniform sampler2D postProcessAdditiveMap;\n                    uniform float postProcessMixRate;\n                    uniform float postProcessAdditiveRate;\n                    uniform float viewportWidth;\n                    uniform float viewportHeight;\n                    varying float fogDepth;\n\n                    #ifdef FOG_EXP2\n                        uniform float fogDensity;\n                    #else\n                        uniform float fogNear;\n                        uniform float fogFar;\n                    #endif\n\n                    #include <postprocess_mix_minus_color>\n                #endif\n                ",THREE.ShaderChunk.fog_fragment="\n                #ifdef USE_FOG\n                    // #if ! defined( USE_POST_ONLY )\n                    //     #ifdef FOG_EXP2\n                    //         float fogFactor = whiteCompliment( exp2( - fogDensity * fogDensity * fogDepth * fogDepth * LOG2 ) );\n                    //     #else\n                    //         float fogFactor = smoothstep( fogNear, fogFar, fogDepth );\n                    //     #endif\n                    //     gl_FragColor.rgb = mix( gl_FragColor.rgb, fogColor, fogFactor );\n                    // #endif\n                    vec2 postUV = vec2(gl_FragCoord.x/viewportWidth,gl_FragCoord.y/viewportHeight);\n\n                    if(postProcessAdditiveRate> 0.0){\n                        vec4 postAdditiveColor = texture2D( postProcessAdditiveMap, postUV );\n//                      gl_FragColor.rgba = postAdditiveColor.rgba;\n//                      gl_FragColor.rgb = postprocess_mix_minus_color(postAdditiveColor, vec3(1.0));\n                        gl_FragColor.rgb = postprocess_mix_minus_color(postAdditiveColor, gl_FragColor.rgb);\n                    }\n                    if ( postProcessMixRate > 0.0 ) {\n                        vec4 postColor = texture2D( postProcessMap, postUV );\n//                      gl_FragColor.rgba = postColor.rgba;\n//                      gl_FragColor.rgb = vec3(postColor.a);\n//                      gl_FragColor.rgb = vec3(0.0);\n                        if ( postColor.a>0.0) {\n                            gl_FragColor.rgb = mix( gl_FragColor.rgb, postColor.rgb, postColor.a);\n                        }\n                    }\n                #endif\n                ",THREE.ShaderChunk.postprocess_mix_color="\n                vec4 mix_color(vec4 originalColor, vec3 mixColor, float mixNum){\n                    float _mixNum = 1.0-(1.0-mixNum)*(1.0-originalColor.a);\n                    if ( _mixNum==0.0 ) {\n                        return originalColor;\n                    }\n                   vec3 _color = mix(originalColor.rgb*originalColor.a,mixColor, mixNum)/_mixNum;\n                   return vec4(_color,_mixNum);\n                }\n                ",THREE.ShaderChunk.postprocess_original_color="\n                vec4 get_original_color(sampler2D tDiffuse, vec2 v_textureCoordinates, float firstFlg){\n                   vec4 color = texture2D(tDiffuse, v_textureCoordinates);\n                    if(firstFlg==0.0) {\n                       color = vec4(0.0);\n                    }\n                    return color;\n                }\n                ",THREE.ShaderChunk.postprocess_minus_color="\n                vec4 postprocess_minus_color(vec3 originalColor, vec3 texColor){\n                    float fragColor_a = 0.0;\n                    float fragColor_r = originalColor.r-texColor.r;\n                    float fragColor_g = originalColor.g-texColor.g;\n                    float fragColor_b = originalColor.b-texColor.b;\n                    if(fragColor_r <0.0){\n                        fragColor_a+=0.1;\n                    }\n                    if(fragColor_g <0.0){\n                        fragColor_a+=0.2;\n                    }\n                    if(fragColor_b <0.0){\n                        fragColor_a+=0.4;\n                    }\n                    return vec4(abs(fragColor_r), abs(fragColor_g), abs(fragColor_b),fragColor_a);\n                }\n                ",THREE.ShaderChunk.postprocess_mix_minus_color="\n                vec3 postprocess_mix_minus_color(vec4 originalColor, vec3 addColor){\n                    float fragColor_r = originalColor.r;\n                    float fragColor_g = originalColor.g;\n                    float fragColor_b = originalColor.b;\n                    float fragColor_a = originalColor.a;\n\n                    if(fragColor_a>0.35){\n                        fragColor_b=addColor.b-fragColor_b;\n                        fragColor_a=fragColor_a - 0.4;\n                    }else{\n                        fragColor_b +=addColor.b;\n                    }\n                    if(fragColor_b<0.0){\n                        fragColor_b=0.0;\n                    }\n\n                    if(fragColor_a>0.15){\n                        fragColor_g=addColor.g-fragColor_g;\n                        fragColor_a=fragColor_a-0.2;\n                    }else{\n                        fragColor_g +=addColor.g;\n                    }\n                   if(fragColor_g<0.0){\n                        fragColor_g=0.0;\n                    }\n\n                    if(fragColor_a > 0.05){\n                        fragColor_r=addColor.r-fragColor_r;\n                    }else{\n                        fragColor_r +=addColor.r;\n                    }\n                    if(fragColor_r<0.0){\n                        fragColor_r=0.0;\n                    }\n\n                    return vec3(fragColor_r,fragColor_g,fragColor_b);\n                }\n                "}setPostProcessMap(e){this.postProcessMap=e}setPostProcessAdditiveMap(e){this.postProcessAdditiveMap=e}setViewport(e,t){this.viewport.w=e,this.viewport.h=t}destroy(){var e=this;e.postProcessMap=null,e.postProcessAdditiveMap=null,e.isPostOnly=null,e.viewport=null}}r.PostProcess=e}(),function(){class e extends THREE.WebGLRenderer{constructor(e){super(e),this._renderBufferDirect=this.renderBufferDirect,this.renderBufferDirect=this._renderBufferDirectEx,this._render=this.render,this.render=this._renderEx,this._timeStart=0,this._timeEnd=0,this._timeElapse=0,this._frameNumber=0,this._newFrame=!0,this._renderBreaking=!1,this._renderInteracting=!1,this._forceRenderStateInit=!1,this._limitFrameTimeWithInteracting=30,this._frameTimeThreshold=0,this.disableRenderBreaking=!1}destroy(){this.dispose()}set renderInteracting(e){this._renderInteracting=e}get renderInteracting(){return this._renderInteracting}set forceRenderStateInit(e){this._forceRenderStateInit=e}get forceRenderStateInit(){return this._forceRenderStateInit}_renderBufferDirectEx(e,t,i,r,a,n){if(t){if(!this.disableRenderBreaking){if(!this._checkIfRender())return;if(this._isObjectRendered(a,n))return}this._renderBufferDirect(e,t,i,r,a,n),this._setStateOfObject(t,a,n),t._renderFinished=!1}else this._renderBufferDirect(e,t,i,r,a,n)}_renderEx(e,t){return this._resetState(),this._updateSceneState(e),this._render(e,t),e._renderFinished&&this._resetStateOfObjects(e),e._renderFinished}_resetState(){this._timeStart=0,this._timeEnd=0,this._renderBreaking=!1,this._newFrame=!1,this._frameTimeThreshold=this._renderInteracting?this._limitFrameTimeWithInteracting:r.GlobalData.LimitFrameTime,this.autoClear&&(this._frameNumber=r.Math.incrementWrap(this._frameNumber,15e6,1),this._newFrame=!0)}_updateSceneState(e){void 0===e._renderedObjects&&(e._renderedObjects=[]),e._renderFinished=!0,this._forceRenderStateInit?e.renderStateInitSkipped=!1:e.renderStateInitSkipped=!this._newFrame||!!this._renderInteracting,this._newFrame&&this._resetStateOfObjects(e)}_setStateOfObject(e,t,i){t._frameNumber=this._frameNumber,t._rendered=!0,i&&(i._rendered=!0),e._renderedObjects.push({object:t,group:i})}_resetStateOfObjects(e){e._renderedObjects.forEach((e=>{e.object._rendered=void 0,e.group&&(e.group._rendered=void 0)})),e._renderedObjects.length=0}_checkIfRender(){return!this._renderBreaking&&(this._timeStart||(this._timeStart=Date.now()),this._timeEnd=Date.now(),this._timeElapse=this._timeEnd-this._timeStart,!(this._timeElapse>this._frameTimeThreshold)||(this._renderBreaking=!0,!1))}_isObjectRendered(e,t){return t?e._rendered&&t._rendered:e._rendered}}r.WebGLRenderer=e}(),r.IncrementedRenderer=class{constructor(e,t){this.manager=e,this.viewer=e.viewer,this.countRenderRequest=0,this.maxCountRenderRequest=1e4,this.rendering=!1,this.incrementRenderHandle=0,this.renderer=new r.WebGLRenderer(t),this._renderSize=new THREE.Vector2,this.depthPass=new r.DepthRenderPass(this.viewer.modelManager),r.GlobalData.EnableShadowMap&&(this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=THREE.PCFSoftShadowMap,this.renderer.shadowMap.autoUpdate=!1,this.renderer.shadowMap.needsUpdate=!0,this.viewer.getScene().lightManager.shadowLightNum++),this._renderingCamera=void 0}destroy(){this.incrementRenderHandle>0&&cancelAnimationFrame(this.incrementRenderHandle),this.renderer&&(this.renderer.destroy&&this.renderer.destroy(),this.renderer.domElement.parentNode&&this.renderer.domElement.parentNode.removeChild(this.renderer.domElement),this.renderer=null),this.depthPass.destroy(),this.depthPass=null,this._renderSize=null,this.manager=null,this.viewer=null,this._renderingCamera=void 0}forceRenderOneFrame(){const e=this.viewer,t=e.camera,i=e.modelManager.getScene();this.renderer.render(i,t,null,!0)}_render(){if(!this.manager.prepareRender())return;if(++this.countRenderRequest,this.countRenderRequest>this.maxCountRenderRequest&&(this.countRenderRequest=0),this.rendering||this.pickingEffectRendering)return;this.rendering=!0;const e=this,t=this.viewer,i=t.camera,a=t.modelManager,n=t.editorManager,s=t.getScene(),o=this.renderer;a.calculateCameraModelRelation(i.position),t.calculateNearFar(),t.cameraControl.updateCamera(),s.updateLights(i,t),void 0===this._renderingCamera?this._renderingCamera=i.clone():this._renderingCamera.copy(i);const l=n.isUpdateRenderList,d=o.autoClear;o.renderInteracting=!l,l&&a.prepareScene(i),t.onCallbacks(r.EnumRenderCallbackType.PRE_RENDER),t.getIBLManager().renderWithOrthCamera(t,o,this._renderingCamera,l),this.incrementRenderHandle=requestAnimationFrame(function i(r,h,c){let u=h,p=r;return function(){o.autoClear=c,n.cameraChange?(o.autoClear=!0,n.cameraChange=!1,t.getIBLManager().renderWithOrthCamera(t,o,u,l)):o.autoClear=c,-1!==e.incrementRenderHandle?o.render(s,u)||p!==e.countRenderRequest?(e.rendering=!1,p!==e.countRenderRequest?(o.autoClear=d,t.render()):(e._renderPickingObjects(),t.onRenderFinishedCallback(),a.disposeBufferAfterVbo(),o.autoClear=d)):e.incrementRenderHandle=requestAnimationFrame(i(p,u,!1)):e.rendering=!1}}(e.countRenderRequest,this._renderingCamera,o.autoClear)),t.onRenderCallback(),t.cameraControl.setCameraChanging(!1)}render(e){this._render(e)}renderDepth(e,t,i,r){this.depthPass.renderDepth(e,t,i,r)}renderCustomDepth(e,t,i,r,a){this.depthPass.renderCustomDepth(e,t,i,r,a)}renderCustomDepthWithoutDEM(e,t,i,r){this.depthPass.renderCustomDepthWithoutDEM(e,t,i,r)}_applyPickingEffect(){const e=this.manager.getPickingEffecter();if(!e)return;const t=this.viewer.modelManager.isFilterApplied();e.apply(t)}_renderPickingObjects(){const e=this.renderer,t=e.forceRenderStateInit;e.forceRenderStateInit=!0,e.disableRenderBreaking=!0,this.pickingEffectRendering=!0,this._applyPickingEffect(),this.viewer.modelManager.setFilterApplied(!1),this.pickingEffectRendering=!1,e.forceRenderStateInit=t,e.disableRenderBreaking=!1}setSize(e,t){this.renderer.setSize(e,t)}getSize(){return this.renderer.getSize(this._renderSize)}canceRenderAnimation(){this.incrementRenderHandle>0&&(cancelAnimationFrame(this.incrementRenderHandle),this.incrementRenderHandle=-1,this.rendering=!1)}},function(){function e(e,t){return e.material.priorityOrderId!==t.material.priorityOrderId?(e.material.priorityOrderId||0)-(t.material.priorityOrderId||0):e.groupOrder!==t.groupOrder?e.groupOrder-t.groupOrder:e.renderOrder!==t.renderOrder?e.renderOrder-t.renderOrder:e.program!==t.program?e.program.id-t.program.id:e.material.id!==t.material.id?void 0===e.material.priorityOrderId?e.material.id-t.material.id:t.material.id-e.material.id:e.z!==t.z?e.z-t.z:e.id-t.id}r.BatchedRenderer=class{constructor(t,i){this.manager=t,this.viewer=t.viewer,this.composer=null,this.isBatched=!0,this.renderer=new THREE.WebGLRenderer(i),this.renderer.setOpaqueSort(e);var a=this.viewer;if(this.viewportWidth=a.domElement.offsetWidth,this.viewportHeight=a.domElement.offsetHeight,this.depthPass=new r.DepthRenderPass(this.viewer.modelManager),r.GlobalData.EnableShadowMap){this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=THREE.PCFSoftShadowMap,this.renderer.shadowMap.autoUpdate=!1,this.renderer.shadowMap.needsUpdate=!0,this.viewer.getScene().lightManager.shadowLightNum++}this._renderSize=new THREE.Vector2,this.oit=new r.OIT({renderer:this.renderer})}destroy(){this.composer&&(this.composer.destroy(),this.composer=null),this.oit&&(this.oit.destroy(),this.oit=void 0),this.renderer&&(this.renderer.dispose(),this.renderer.domElement.parentNode&&this.renderer.domElement.parentNode.removeChild(this.renderer.domElement),this.renderer=null),this.viewer=null,this.manager=null}_createComposer(){this.oldAutoClear=this.renderer.autoClear;var e=this.viewer;this.renderer.shadowMap.enabled=!0,this.composer=new r.RenderEffectComposer(this.renderer),this.composer.init(e,this.viewportWidth,this.viewportHeight)}_checkPostProcess(){return r.GlobalData.EnableSnowPass||r.GlobalData.EnableFogPass||r.GlobalData.EnableRainPass||r.GlobalData.EnableSkylinePass||r.GlobalData.ScanRingCount>0||r.GlobalData.FanScanCount>0||r.GlobalData.EnableGlow&&r.GlobalData.GlowCount>0||r.GlobalData.EnableGlow&&r.GlobalData.HighLightOutlineCount>0||r.GlobalData.BloomCount>0||r.GlobalData.SSAO}_render(e){var t=this.viewer,i=t.getScene();if(!this.manager.prepareRender())return;var a=this,n=t.camera,s=t.modelManager,o=this.renderer,l=this.manager;this._isNonInteracting();var d=t.getInteractionScene();function h(){var e;t.globalRendering?function(){var e=i.getObjectGroup(r.ObjectGroupType.GLOBALEARTH);if(e&&e.visible){for(var t=i.getObjectGroups(),a=0;a<t.length;a++){var s=t[a];s.preVisible=s.visible,s.visible=!1}e.visible=!0,o.shadowMap.needsUpdate=!1,o.render(i,n)}}():(r.ContactShadow.getInstance()&&r.ContactShadow.getInstance().render(o,i,n),t.clipCapsManager&&t.clipCapsManager.render(o),null!=t.scissorViewportManager&&t.scissorViewportManager.isEmbeddedView()?t.scissorViewportManager.setViewRegionRender(o,i,n):l.useOIT()?a.oit.render(i,n,t.modelManager):o.render(i,n),i.background=null,r.GroundPrimitiveManager.getInstance().render(o,n),e=o.autoClear,o.autoClear=!1,o.render(d,n),o.autoClear=e)}function c(){var e=o.autoClear;const l=n.near,d=n.far,c=r.ExtrudeBodyManager.getInstance(t)._getNodeGroupVisible();i.fillClipPlane&&i.fillClipPlane.updateCamera(t),t.getIBLManager().renderWithOrthCamera(t,o),r.ExtrudeBodyManager.getInstance(t)._setNodeGroupVisible(!1),h(),o.autoClear=e,r.ExtrudeBodyManager.getInstance(t)._setNodeGroupVisible(c),r.ExtrudeBodyManager.getInstance(t).applyFrontEffect(o,i,n),a._applyPickingEffect(),n.setNearFar(l,d),t.cameraControl.updateCamera(),s.setFilterApplied(!1)}!function(){let e=t.camera.lastDirty;i.updateLights(n,t),s.prepareScene(n,(function(){s.setRenderStateChanged(!0),t.render()})),s.blinkManager.getBlinkEnabled()&&s.blinkManager.updateBlinkMaterial(),t.onCallbacks(r.EnumRenderCallbackType.PRE_RENDER),t.terrainOperationManager.render(o),t.holesManager.render(o),t.heightLimitManager&&t.heightLimitManager.render(o),t.refleRefraManager&&t.refleRefraManager.render(o),a._checkPostProcess()?(null==a.composer&&a._createComposer(),a.composer.updateEnabled(),a.composer.conventionFn=function(){i.updateLights(n,t),c(),s.disposeBufferAfterVbo()},a.composer.checkRender()):(null!=a.composer&&(a.renderer.autoClear=a.oldAutoClear,a.composer.destroy(),a.composer=null),c()),t.onRenderCallback(),t.onRenderFinishedCallback(),(t.cameraControl.isCameraChanging()||e)&&s.dispatchEvent({type:r.EVENTS.ON_CAMERA_CHANGED_AND_RENDERED}),t.cameraControl.setCameraChanging(!1),a.composer||s.disposeBufferAfterVbo()}()}render(e){this.adjustNearFar(),this._render(e)}renderDepth(e,t,i,r){this.depthPass.renderDepth(e,t,i,r)}renderCustomDepth(e,t,i,r,a,n){this.depthPass.renderCustomDepth(e,t,i,r,a,n)}renderCustomDepthByOpacity(e,t,i,r,a,n){this.depthPass.renderCustomDepthByOpacity(e,t,i,r,a,n)}renderCustomDepthWithoutDEM(e,t,i,r,a){this.depthPass.renderCustomDepthWithoutDEM(e,t,i,r,a)}setSize(e,t){this.viewportWidth=e,this.viewportHeight=t,this.renderer.setPixelRatio(window.devicePixelRatio||1),this.renderer.setSize(this.viewportWidth,this.viewportHeight),this.manager.useOIT()&&this.oit.setSize(this.viewportWidth,this.viewportHeight),this.composer&&this.composer.setSize(this.viewportWidth,this.viewportHeight)}getSize(){return this.renderer.getSize(this._renderSize)}_applyPickingEffect(){var e=this.manager.getPickingEffecter();if(!e)return;const t=this.viewer.getFilter().isVisibleStateChanged();e.apply(t),this.viewer.getFilter().disableVisibleStateChanged()}forceRenderOneFrame(){const e=this.viewer,t=e.camera,i=e.modelManager.getScene();this.renderer.render(i,t,null,!0)}adjustNearFar(){const e=this.viewer;e.getModelManager().calculateCameraModelRelation(e.camera.position),e.camera.lastDirty=e.camera.dirty,e.calculateNearFar(),e.cameraControl.updateCamera()}_isNonInteracting(){return this.viewer.editorManager.isUpdateRenderList}_isCameraChanged(){const e=this.viewer.camera;let t=this.lastCamera;return void 0===t?(this.lastCamera=e.clone(),!0):!r.CameraUtil.equalsCamera(e,t)&&(t.copy(e),!0)}}}(),function(){class e extends r.BatchedRenderer{constructor(e,t){super(e,t),this.fps=t.fps||0,this._running=!1,this._paused=!1,this._destroyed=!1,this._showRenderErrors=!0,this._renderRequested=!0,this._frameState=new r.FrameState,this._preRenderLoopType=void 0,this._renderLoopHandel=null,this._firstRender=!0,this._currentRenderLoop=void 0}destroy(){this._destroyed=!0,this._frameState=this._frameState.destroy(),this._performanceStats&&(this._performanceStats=this._performanceStats.destroy()),this._currentRenderLoop=void 0,this.stop(),super.destroy()}_batchModelRenderLop(){this.viewer.editorManager.update();this._shouldRender()&&(this._renderRequested=!1,this.viewer.editorManager.onRender(),this.adjustNearFar(),this._render(!0))}_oocRenderLoop(){this.viewer.editorManager.update(),this._beginPerformanceStats();const e=new Date,t=this._frameState;this.updateFrameState(t);const i=this._shouldRender();if(i){this._renderRequested=!1;const i=r.Math.incrementWrap(t.frameNumber,15e6,1);this.updateFrameNumber(i,e),t.newFrame=!0}this.preUpdate(t),i&&this.update(t),this.postUpdate(t),this._callForAfterRender(),this._endPerformanceStats()}render(e){this.requestRender(),this._checkIfForceRender()&&this._currentRenderLoop&&(this._currentRenderLoop(),this.viewer.cameraControl.dirtyCamera(!0))}preUpdate(e){r.eventsDispatcher.dispatchEvent({type:r.EVENTS.ON_PRE_UPDATE,params:{}});var t=this.viewer.getModelManager();t.traverseValidModels((function(t){t.preUpdate(e)})),t.tilesCacheScheduler.resetTilesCache(e)}update(e){const t=this.viewer.getModelManager();t.tilesCacheScheduler.clearStatistics(),this.viewer.editorManager.onRender(),this.adjustNearFar(),t.traverseValidModels((function(t){t.update(e)})),this.createPotentiallyVisibleSet(),this._render()}postUpdate(e){r.eventsDispatcher.dispatchEvent({type:r.EVENTS.ON_POST_UPDATE,params:{}});var t=this.viewer.getModelManager();t.traverseValidModels((function(t){t.postUpdate(e)})),r.RequestScheduler.update(),t.fireTilesLoadEvent(e),t.tilesCacheScheduler.update()}createPotentiallyVisibleSet(){}updateFrameNumber(e,t){var i=this._frameState;i.frameNumber=e,i.time=t}updateFrameState(){const e=this.viewer,t=this._frameState;t.globalMatrixUpdated=!1,void 0!==t.globalMatrix&&t.globalMatrix.equals(e.getScene().getRawMatrixGlobal())||(t.globalMatrixUpdated=!0,void 0===t.globalMatrix?t.globalMatrix=e.getScene().getRawMatrixGlobal().clone():t.globalMatrix.copy(e.getScene().getRawMatrixGlobal())),t.newFrame=!1,t.globalInverseMatrix=e.getScene().getInverseMatrixGlobal(),t.camera=e.camera,t.cameraPositionWc.copy(t.camera.position).applyMatrix4(t.globalInverseMatrix),t.camera.direction(t.cameraDirectionWc),t.cameraDirectionWc.transformDirection(t.globalInverseMatrix),t.frustum=t.camera.getFrustum(),t.cameraPreSSE=e.domElement.offsetHeight/t.camera.frustumHeightFactor,t.viewer=this.viewer}_callForAfterRender(){for(var e=this._frameState.afterRenderFns,t=0,i=e.length;t<i;++t)e[t](),this.requestRender();e.length=0}requestRender(){this._renderRequested=!0}get frameState(){return this._frameState}start(e){if(!this._running){this._running=!0,this._paused=!1;var t=this,i=0;this._renderLoopHandel=requestAnimationFrame((function r(a){if(!t.isDestroyed()&&(t._running||t._paused))try{var n=t.fps;if(n>0){var s=1e3/n,o=a-i;o>s&&(t.resize(),t._running&&!t._paused&&e.call(t),i=a-o%s),t._renderLoopHandel=requestAnimationFrame(r)}else t.resize(),t._running&&!t._paused&&e.call(t),t._renderLoopHandel=requestAnimationFrame(r)}catch(e){t._running=!1,t._showRenderErrors&&(console.error("An error occurred while rendering. Rendering has stopped."),console.error(e))}}))}}pause(e){this._paused=e}stop(){this._running&&(this._running=!1,this._paused=!1),r.Utils.isDefined(this._renderLoopHandel)&&cancelAnimationFrame(this._renderLoopHandel)}_shouldRender(){const e=this._isCameraChanged();return e&&this.viewer.modelManager.dispatchEvent({type:r.EVENTS.ON_CAMERA_CHANGED,camera:this.viewer.camera}),this._renderRequested||e||this.viewer.cameraControl.isCameraChanging()||this.viewer.getModelManager().isSceneChanged()||this.viewer.getModelManager().blinkManager.getBlinkEnabled()||this.viewer.inputStatusMonitor.forceShouldRender()}resize(){}isDestroyed(){return this._destroyed}_getPerformanceStats(){const e=this.viewer;return e._options.debugShowFPS?(this._performanceStats||(this._performanceStats=new r.PerformanceStats({container:e.domElement})),this._performanceStats):(this._performanceStats&&(this._performanceStats=this._performanceStats.destroy()),null)}_beginPerformanceStats(){const e=this._getPerformanceStats();e&&e.begin()}_endPerformanceStats(){const e=this._getPerformanceStats();e&&e.end()}setRenderLoop(e){e!==this._preRenderLoopType&&(this._preRenderLoopType=e,this.stop(),this.requestRender(!0),this._currentRenderLoop=e?this._oocRenderLoop:this._batchModelRenderLop,this.start(this._currentRenderLoop))}_checkIfForceRender(){const e=this._firstRender&&this.viewer.getModelManager().hasLoadedModel();return e&&(this._firstRender=!1),e}}r.OoCRenderer=e}(),r.RenderGroup=function(){var e=[],t=[],i=-1,a=-1,n=0,s=!1,o=!1,l=0,d=0;function h(e,t){return e.material.id!==t.material.id?e.material.id-t.material.id:e.id-t.id}function c(e,t){return e.z!==t.z?t.z-e.z:e.id-t.id}function u(e,t,i,a,s,o,h){l=Date.now();for(var c=t.length,u=n;u<c;u++){var p=t[u],m=p.object,f=p.material,g=p.group,v=p.geometry;if(m.modelViewMatrix.multiplyMatrices(i.matrixWorldInverse,m.matrixWorld),m.normalMatrix.getNormalMatrix(m.modelViewMatrix),v=e.updateObject(m),e.renderBufferDirect(i,s,v,f,m,g),!h&&(d=Date.now(),d-l>r.GlobalData.LimitFrameTime))return n=u+1,!1}return n=0,!0}this.getOpaqueObjects=function(){return e},this.getTransparentObjects=function(){return t},this.destroy=function(){e=[],t=[]},this.restart=function(){n=0,s=!1,o=!1},this.prepare=function(){this.restart(),i=-1,a=-1},this.renderableCount=function(){return i+a},this.pushRenderItem=function(r,n,s,o,l){var d,h;s.transparent?(d=t,h=++a):(d=e,h=++i);var c=d[h];void 0!==c?(c.id=r.id,c.object=r,c.geometry=n,c.material=s,c.z=o,c.group=l||null):(c={id:r.id,object:r,geometry:n,material:s,z:o,group:l||null},d[h]=c)},this.sortRenderList=function(r){e.length=i+1,t.length=a+1,r&&(e.sort(h),t.sort(c))},this.renderOpaqueObjects=function(t,i,r,a,n,o){return s||(s=u(t,e,i,0,a,0,o)),s},this.renderTransparentObjects=function(e,i,r,a,n,s){return o||(o=u(e,t,i,0,a,0,s)),o}},r.OrderedRenderer=function(){var e=0,t=!1,i=!1,a=0,n=0,s=[],o=null,l=null,d=new THREE.Vector3,h=!0,c=!0;this.updateObjectList=function(e){h=e};var u=!1;function p(e,t,i,a,n){var o=s[e.renderOrder];void 0===o&&(o=new r.RenderGroup,s[e.renderOrder]=o),o.pushRenderItem(e,t,i,a,n)}function m(t,i){if(!1===t.visible)return!0;if(t._cullTicket!=e){if(!u)if(Date.now()-a>30)return!1;if(t._cullTicket=e,(t.isMesh||t.isLine||t.isPoints)&&(t.isSkinnedMesh&&t.skeleton.update(),!1===t.frustumCulled||!0===o.intersectsObject(t))){var r=t.material,n=t.geometry;if(d.setFromMatrixPosition(t.matrixWorld),d.applyMatrix4(l),Array.isArray(r))for(var s=n.groups,h=0,c=s.length;h<c;h++){var f=s[h],g=r[f.materialIndex];g.transparent?p(t,n,g,d.z,f):p(t,n,g,0,f)}else r.transparent?p(t,n,r,d.z):p(t,n,r,0)}}var v=t.children;if(v)for(h=0,c=v.length;h<c;h++)if(!m(v[h],i))return!1;return!0}this.setNonBreakingRender=function(e){u=e},this.destroy=function(){for(var e=0,t=s.length;e<t;++e){var i=s[e];void 0!==i&&i.destroy()}},this.restart=function(){for(var e=0,i=s.length;e<i;++e){var r=s[e];void 0!==r&&r.restart()}c=!0,t=!0},this.setFilter=function(e){},this.projectLights=function(e,t){t.length=0,e.traverseVisible((function(e){e.isLight&&t.push(e)}))};var f=this;function g(i,r,n){h?(t&&(!function(){++e>1e5&&(e=0);for(var t=0,i=s.length;t<i;++t){var r=s[t];void 0!==r&&r.prepare()}}(),f.projectLights(i,n)),a=Date.now(),t=m(i,r),function(){for(var e=0,i=s.length;e<i;++e){var r=s[e];void 0!==r&&r.sortRenderList(t)}}()):t=!0}this.update=function(e,t){l=t,o=e},this.render=function(e,a,o,l,d,p,m){if(h&&!c||++n,n>1e4&&(n=0),c){if(r.Logger.time("build object list"),g(a,o,l),r.Logger.timeEnd("build object list"),!t)return!1;p=this.forceClear||e.autoClear,c=!1,this.forceClear=!1,e.setupLights(l,o),e.setRenderTarget(d)}r.Logger.time("increment render object"),(e.autoClear||p)&&e.clear(e.autoClearColor,e.autoClearDepth,e.autoClearStencil,h);var f=a.fog;e.setRenderTicket(n),m.setBlending(THREE.NoBlending);for(var v=s.length-1;v>=0;--v){if(void 0!==(y=s[v])&&!(i=y.renderOpaqueObjects(e,o,l,f,h,u)))break}if(i)for(v=s.length-1;v>=0;--v){var y;if(void 0!==(y=s[v])&&!(i=y.renderTransparentObjects(e,o,l,f,void 0,u)))break}return 0==s.length&&(i=!0),m.buffers.depth.setTest(!0),m.buffers.depth.setMask(!0),m.buffers.color.setMask(!0),r.Logger.timeEnd("increment render object"),i}},r.RenderComposer=function(){var e,t,i,a,n,s,o,l=null,d=null,h=!1,c=!0,u=!1;this.init=function(t,i,l){!function(){function e(e){e.material.blending=THREE.NoBlending,e.material.depthWrite=!1,e.material.depthTest=!1}e(a=new r.ShaderPass(FXAAShader)),e(n=new r.ShaderPass(CopyShader))}(),t?(s=i,o=l,e=t,this.setSize(i,l,!0)):console.log("You need a gl context to make a renderer. Things will go downhill from here.")},this.cleanup=function(){l&&(l.dispose(),l=null),d&&(d.dispose(),d=null)},this.setSize=function(t,i,r){if(s=t,o=i,0===t&&0===i||!e)this.cleanup();else{var n=0|t*e.getPixelRatio(),h=0|i*e.getPixelRatio(),c=1/n,u=1/h;!r&&l&&l.width==n&&l.height==h||(this.cleanup(),(l=new THREE.WebGLRenderTarget(n,h,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat,stencilBuffer:!1})).texture.generateMipmaps=!1,l.texture.name="_color_rt1",(d=l.clone()).texture.name="_write_rt1"),a.uniforms.uResolution.value.set(c,u)}},this.renderIncrement=function(a,d){if(!l&&s)this.setSize();else if(!l&&!s)return;return r.GlobalData.SSAO&&!i&&(i=new THREE.SSAOPass(a,d,s,o)),t=d,c&&(u||(e.resetIncrementRender(),e.setClearColor(0,0),e.clearTarget(l,!0,!0,!1)),c=!1),e.autoClear=!1,h||(h=e.render(a,t,l))&&(n.renderToScreen=!0,e.resetIncrementRender(),n.render(e,null,l)),h},this.render=function(a,d){if(!l&&s)this.setSize();else if(!l&&!s)return;var h=r.GlobalData.SSAO;h&&!i&&(i=new THREE.SSAOPass(a,d,s,o)),t=d,c&&(u||(e.setClearColor(0,0),e.clearTarget(l,!0,!0,!1)),c=!1),e.autoClear=!1,u||e.render(a,t,l);var p=h?i:n;p.renderToScreen=!0,p.render(e,null,l)},this.restart=function(e,t){u=!!e,h=!1,c=!0},this.finish=function(){}},r.RendererManager=class{constructor(e){this.viewer=e,this.renderer=null,this.pickingEffecter=null,this._renderSize={x:0,y:0},this._useOIT=!1}destroy(){this.renderer&&(this.renderer.destroy(),this.renderer=null),this.pickingEffecter&&(this.pickingEffecter.destroy(),this.pickingEffecter=null),this._renderSize=null,this.viewer=null}setupRenderer(e){if(!this.renderer){var t=this.viewer;r.GlobalData.BatchMergeEnabled?(console.log("renderer: BatchedRenderer"),this.renderer=new r.OoCRenderer(this,e)):(t.modelManager.blinkManager.permitBlink(!0),r.GlobalData.InstanceSharedMeshEnabled=!1,console.log("renderer: IncrementedRenderer"),this.renderer=new r.IncrementedRenderer(this,e)),this._initRenderer()}}prepareRender(){var e=this.renderer;if(!e)return!1;var t=this.viewer,i=t.modelManager;if(!i.isDrawable())return!1;if(!i.hasModel())return r.Logger.log("model not loaded!"),e.forceRenderOneFrame(),!1;if(r.GlobalData.IBL&&0==t.getIBLManager().textureLoad)return!1;if(t.globalRendering){if(!t.globeEarth)return!1;if(!t.globeEarth.modelLoaded)return!1}return!i.checkLayerDataLoading()&&(t.getScene().fillClipPlane&&r.GlobalData.ClippingCaps&&r.GlobalData.BatchMergeEnabled&&t.setRenderStateChanged(!0),!0)}render(e){this.renderer&&this.renderer.render(e)}getRenderer(){if(this.renderer)return this.renderer.renderer}setSize(e,t){this.renderer&&this.renderer.setSize(e,t)}getRendererSize(){if(this.renderer){const e=this.renderer.getSize();this._renderSize.width=e.x,this._renderSize.height=e.y}else this._renderSize.width=0,this._renderSize.height=0;return this._renderSize}getPickingEffecter(){return r.GlobalData.PickingEffect?(this.pickingEffecter||(this.pickingEffecter=new r.PickingEffecter(this.viewer)),this.pickingEffecter):null}_initRenderer(){var e=this.viewer,t=e.domElement,i=t.offsetWidth,a=t.offsetHeight,n=this.renderer.renderer;n.setClearColor(0,0),n.setPixelRatio(window.devicePixelRatio||1),n.setSize(i,a),n.toneMapping=r.GlobalData.ToneMapping,n.gammaFactor=2.2,n.outputEncoding=THREE.sRGBEncoding,n.domElement.setAttribute("tabindex","0"),n.domElement.setAttribute("id","cloud-main-canvas"),e.domElement.appendChild(n.domElement)}enableVR(e){this.renderer.renderer.xr.enabled=e}enableOIT(e){this._useOIT=e}useOIT(){return this._useOIT}_isSupportOIT(){return this._useOIT&&this.renderer&&this.renderer.oit}enableOITAlphaMask(e){this._isSupportOIT()&&this.renderer.oit.enableTransparentAlphaMask(e)}setOITCustomizedAlpha(e){if(this._isSupportOIT()){const t=this.renderer.oit;null===e?(t.enableCustomizedAlpha(!1),t.setCustomizedAlpha(1)):(t.enableCustomizedAlpha(!0),t.setCustomizedAlpha(e))}}forceRenderClearScreen(){const e=this.getRenderer();e&&(e.clear(!0,!0,!0),this.renderer.canceRenderAnimation&&this.renderer.canceRenderAnimation())}},THREE.SimplexNoise=function(e){null==e&&(e=Math),this.grad3=[[1,1,0],[-1,1,0],[1,-1,0],[-1,-1,0],[1,0,1],[-1,0,1],[1,0,-1],[-1,0,-1],[0,1,1],[0,-1,1],[0,1,-1],[0,-1,-1]],this.grad4=[[0,1,1,1],[0,1,1,-1],[0,1,-1,1],[0,1,-1,-1],[0,-1,1,1],[0,-1,1,-1],[0,-1,-1,1],[0,-1,-1,-1],[1,0,1,1],[1,0,1,-1],[1,0,-1,1],[1,0,-1,-1],[-1,0,1,1],[-1,0,1,-1],[-1,0,-1,1],[-1,0,-1,-1],[1,1,0,1],[1,1,0,-1],[1,-1,0,1],[1,-1,0,-1],[-1,1,0,1],[-1,1,0,-1],[-1,-1,0,1],[-1,-1,0,-1],[1,1,1,0],[1,1,-1,0],[1,-1,1,0],[1,-1,-1,0],[-1,1,1,0],[-1,1,-1,0],[-1,-1,1,0],[-1,-1,-1,0]],this.p=[];for(var t=0;t<256;t++)this.p[t]=Math.floor(256*e.random());this.perm=[];for(t=0;t<512;t++)this.perm[t]=this.p[255&t];this.simplex=[[0,1,2,3],[0,1,3,2],[0,0,0,0],[0,2,3,1],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,2,3,0],[0,2,1,3],[0,0,0,0],[0,3,1,2],[0,3,2,1],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,3,2,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,2,0,3],[0,0,0,0],[1,3,0,2],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,3,0,1],[2,3,1,0],[1,0,2,3],[1,0,3,2],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,0,3,1],[0,0,0,0],[2,1,3,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,0,1,3],[0,0,0,0],[0,0,0,0],[0,0,0,0],[3,0,1,2],[3,0,2,1],[0,0,0,0],[3,1,2,0],[2,1,0,3],[0,0,0,0],[0,0,0,0],[0,0,0,0],[3,1,0,2],[0,0,0,0],[3,2,0,1],[3,2,1,0]]},THREE.SimplexNoise.prototype.dot=function(e,t,i){return e[0]*t+e[1]*i},THREE.SimplexNoise.prototype.dot3=function(e,t,i,r){return e[0]*t+e[1]*i+e[2]*r},THREE.SimplexNoise.prototype.dot4=function(e,t,i,r,a){return e[0]*t+e[1]*i+e[2]*r+e[3]*a},THREE.SimplexNoise.prototype.noise=function(e,t){var i,r,a=(e+t)*(.5*(Math.sqrt(3)-1)),n=Math.floor(e+a),s=Math.floor(t+a),o=(3-Math.sqrt(3))/6,l=(n+s)*o,d=e-(n-l),h=t-(s-l);d>h?(i=1,r=0):(i=0,r=1);var c=d-i+o,u=h-r+o,p=d-1+2*o,m=h-1+2*o,f=255&n,g=255&s,v=this.perm[f+this.perm[g]]%12,y=this.perm[f+i+this.perm[g+r]]%12,M=this.perm[f+1+this.perm[g+1]]%12,E=.5-d*d-h*h,b=.5-c*c-u*u,I=.5-p*p-m*m;return 70*((E<0?0:(E*=E)*E*this.dot(this.grad3[v],d,h))+(b<0?0:(b*=b)*b*this.dot(this.grad3[y],c,u))+(I<0?0:(I*=I)*I*this.dot(this.grad3[M],p,m)))},THREE.SimplexNoise.prototype.noise3d=function(e,t,i){var r,a,n,s,o,l,d=(e+t+i)*(1/3),h=Math.floor(e+d),c=Math.floor(t+d),u=Math.floor(i+d),p=1/6,m=(h+c+u)*p,f=e-(h-m),g=t-(c-m),v=i-(u-m);f>=g?g>=v?(r=1,a=0,n=0,s=1,o=1,l=0):f>=v?(r=1,a=0,n=0,s=1,o=0,l=1):(r=0,a=0,n=1,s=1,o=0,l=1):g<v?(r=0,a=0,n=1,s=0,o=1,l=1):f<v?(r=0,a=1,n=0,s=0,o=1,l=1):(r=0,a=1,n=0,s=1,o=1,l=0);var y=f-r+p,M=g-a+p,E=v-n+p,b=f-s+2*p,I=g-o+2*p,x=v-l+2*p,T=f-1+.5,_=g-1+.5,S=v-1+.5,C=255&h,w=255&c,R=255&u,B=this.perm[C+this.perm[w+this.perm[R]]]%12,L=this.perm[C+r+this.perm[w+a+this.perm[R+n]]]%12,O=this.perm[C+s+this.perm[w+o+this.perm[R+l]]]%12,P=this.perm[C+1+this.perm[w+1+this.perm[R+1]]]%12,D=.6-f*f-g*g-v*v,A=.6-y*y-M*M-E*E,N=.6-b*b-I*I-x*x,H=.6-T*T-_*_-S*S;return 32*((D<0?0:(D*=D)*D*this.dot3(this.grad3[B],f,g,v))+(A<0?0:(A*=A)*A*this.dot3(this.grad3[L],y,M,E))+(N<0?0:(N*=N)*N*this.dot3(this.grad3[O],b,I,x))+(H<0?0:(H*=H)*H*this.dot3(this.grad3[P],T,_,S)))},THREE.SimplexNoise.prototype.noise4d=function(e,t,i,r){var a,n,s,o,l,d,h,c,u,p,m,f,g=this.grad4,v=this.simplex,y=this.perm,M=(Math.sqrt(5)-1)/4,E=(5-Math.sqrt(5))/20,b=(e+t+i+r)*M,I=Math.floor(e+b),x=Math.floor(t+b),T=Math.floor(i+b),_=Math.floor(r+b),S=(I+x+T+_)*E,C=e-(I-S),w=t-(x-S),R=i-(T-S),B=r-(_-S),L=(C>w?32:0)+(C>R?16:0)+(w>R?8:0)+(C>B?4:0)+(w>B?2:0)+(R>B?1:0),O=C-(a=v[L][0]>=3?1:0)+E,P=w-(n=v[L][1]>=3?1:0)+E,D=R-(s=v[L][2]>=3?1:0)+E,A=B-(o=v[L][3]>=3?1:0)+E,N=C-(l=v[L][0]>=2?1:0)+2*E,H=w-(d=v[L][1]>=2?1:0)+2*E,U=R-(h=v[L][2]>=2?1:0)+2*E,F=B-(c=v[L][3]>=2?1:0)+2*E,k=C-(u=v[L][0]>=1?1:0)+3*E,G=w-(p=v[L][1]>=1?1:0)+3*E,V=R-(m=v[L][2]>=1?1:0)+3*E,j=B-(f=v[L][3]>=1?1:0)+3*E,z=C-1+4*E,W=w-1+4*E,q=R-1+4*E,X=B-1+4*E,Y=255&I,K=255&x,Z=255&T,$=255&_,Q=y[Y+y[K+y[Z+y[$]]]]%32,J=y[Y+a+y[K+n+y[Z+s+y[$+o]]]]%32,ee=y[Y+l+y[K+d+y[Z+h+y[$+c]]]]%32,te=y[Y+u+y[K+p+y[Z+m+y[$+f]]]]%32,ie=y[Y+1+y[K+1+y[Z+1+y[$+1]]]]%32,re=.6-C*C-w*w-R*R-B*B,ae=.6-O*O-P*P-D*D-A*A,ne=.6-N*N-H*H-U*U-F*F,se=.6-k*k-G*G-V*V-j*j,oe=.6-z*z-W*W-q*q-X*X;return 27*((re<0?0:(re*=re)*re*this.dot4(g[Q],C,w,R,B))+(ae<0?0:(ae*=ae)*ae*this.dot4(g[J],O,P,D,A))+(ne<0?0:(ne*=ne)*ne*this.dot4(g[ee],N,H,U,F))+(se<0?0:(se*=se)*se*this.dot4(g[te],k,G,V,j))+(oe<0?0:(oe*=oe)*oe*this.dot4(g[ie],z,W,q,X)))},THREE.CopyShader={uniforms:{tDiffuse:{value:null},opacity:{value:1}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform float opacity;","uniform sampler2D tDiffuse;","varying vec2 vUv;","void main() {","vec4 texel = texture2D( tDiffuse, vUv );","gl_FragColor = opacity * texel;","}"].join("\n")},THREE.EffectComposer=function(e,t){if(this.renderer=e,void 0===t){var i={minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat,stencilBuffer:!0};let r=new THREE.Vector2;r=e.getSize(r),(t=new THREE.WebGLRenderTarget(r.width,r.height,i)).texture.name="EffectComposer.rt1",t.texture.encoding=THREE.GammaEncoding}this.renderTarget1=t,this.renderTarget2=t.clone(),this.renderTarget2.texture.name="EffectComposer.rt2",this.renderTarget2.texture.encoding=THREE.sRGBEncoding,this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2,this.passes=[],void 0===THREE.CopyShader&&console.error("THREE.EffectComposer relies on THREE.CopyShader"),this.copyPass=new THREE.ShaderPass(THREE.CopyShader),this.renderFirst=!0},Object.assign(THREE.EffectComposer.prototype,{swapBuffers:function(){var e=this.readBuffer;this.readBuffer=this.writeBuffer,this.writeBuffer=e},addPass:function(e){this.passes.push(e);let t=new THREE.Vector2;t=this.renderer.getSize(t),e.setSize(t.width,t.height)},insertPass:function(e,t){this.passes.splice(t,0,e)},render:function(e){var t,i,r=!1,a=this.passes.length;for(this.renderFirst=!0,i=0;i<a;i++)if((t=this.passes[i]).renderIndex=i,!1!==t.enabled){if(t.render(this.renderer,this.writeBuffer,this.readBuffer,e,r,this.renderFirst),this.renderFirst=!1,t.needsSwap){if(r){var n=this.renderer.context;n.stencilFunc(n.NOTEQUAL,1,4294967295),this.copyPass.render(this.renderer,this.writeBuffer,this.readBuffer,e),n.stencilFunc(n.EQUAL,1,4294967295)}this.swapBuffers()}void 0!==THREE.MaskPass&&(t instanceof THREE.MaskPass?r=!0:t instanceof THREE.ClearMaskPass&&(r=!1))}},reset:function(e){if(void 0===e){var t=this.renderer.getSize();(e=this.renderTarget1.clone()).setSize(t.width,t.height)}this.renderTarget1.dispose(),this.renderTarget2.dispose(),this.renderTarget1=e,this.renderTarget2=e.clone(),this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2},setSize:function(e,t){this.renderTarget1.setSize(e,t),this.renderTarget2.setSize(e,t);for(var i=0;i<this.passes.length;i++)this.passes[i].setSize(e,t)}}),THREE.Pass=function(){this.enabled=!0,this.needsSwap=!0,this.clear=!1,this.renderToScreen=!1},Object.assign(THREE.Pass.prototype,{setSize:function(e,t){},render:function(e,t,i,r,a){console.error("THREE.Pass: .render() must be implemented in derived pass.")}}),function(){class e{constructor(e){this.renderer=e,this.composerMix=null,this.composerAdditive=null,this.highlightoutlinePass=null,this.snowPass=null,this.rainPass=null,this.fogPass=null,this.skylinePass=null,this.ssaoPass=null,this.glowPass=[],this.scanRingPassAry=[],this.fanScanPassAry=[],this.conventionFn=null,this.depthTextureFlg=!1,this.normalTextureFlg=!1}destroy(){this.snowPass.enabled=!1,this.rainPass.enabled=!1,this.fogPass.enabled=!1,this.skylinePass.enabled=!1,this.ssaoPass.enabled=!1,this.highlightoutlinePass.enabled=!1,this.renderer=null,this.composerMix=null,this.composerAdditive=null,this.highlightoutlinePass.dispose(),this.highlightoutlinePass=null,this.snowPass.dispose(),this.snowPass=null,this.rainPass.dispose(),this.rainPass=null;for(var e=0;e<this.scanRingPassAry.length;e++)this.scanRingPassAry[e].dispose();this.scanRingPassAry.length=0;for(let e=0,t=this.fanScanPassAry.length;e<t;e++)this.fanScanPassAry[e].dispose();this.fanScanPassAry.length=0;for(e=0;e<this.glowPass.length;e++)this.glowPass[e].dispose();this.glowPass.length=0,this.fogPass.dispose(),this.fogPass=null,this.skylinePass.dispose(),this.skylinePass=null,this.conventionFn=null,this.autoRenderFlg=!1,null!=this.depthRenderTarget&&this.depthRenderTarget.dispose(),null!=this.transparentDepthRenderTarget&&this.transparentDepthRenderTarget.dispose(),null!=this.normalRenderTarget&&this.normalRenderTarget.dispose(),null!=this.requestAnimationFrameID&&window.cancelAnimationFrame(this.requestAnimationFrameID),null!=this.scene.fog&&(this.scene.fog.setPostProcessMap(null),this.scene.fog.setPostProcessAdditiveMap(null))}init(e,t,i){var a=this;a.viewer=e,a.modelManager=e.modelManager,a.scene=e.getScene(),a.camera=e.camera,a.autoRenderFlg=!1,a.selectedGlow={},a.composerMix=new THREE.EffectComposer(a.renderer),a.highlightoutlinePass=new r.OutlineHighLightPass(a),a.composerMix.addPass(a.highlightoutlinePass),a.snowPass=new r.SnowPass(a,a.viewer,t,i),a.composerMix.addPass(a.snowPass),a.rainPass=new r.RainPass(a,a.viewer,t,i),a.composerMix.addPass(a.rainPass),a.fogPass=new r.FogPass(a,a.scene,a.camera,t,i),a.composerMix.addPass(a.fogPass),a.skylinePass=new r.SkylinePass(a,a.scene,a.camera,t,i),a.composerMix.addPass(a.skylinePass),a.composerAdditive=new THREE.EffectComposer(a.renderer),a.ssaoPass=new THREE.SSAOPass(a,a.scene,a.camera,t,i,a.modelManager),a.composerAdditive.addPass(a.ssaoPass),a.composerBackground=new THREE.EffectComposer(a.renderer),a.backgroundPass=new r.BackgroundPass(a,a.viewer,a.width,a.height),a.composerBackground.addPass(a.backgroundPass),a.setSize(t,i)}render(){var e=this;if(e.scene.background=null,null!=e.scene.fog){e.scene.fog.setPostProcessAdditiveMap(null),e.scene.fog.setPostProcessMap(null),e.normalTextureFlg=!1,e.depthTextureFlg=!1,e.transparentDepthTextureFlg=!1;var t=e.composerMix.renderer.getRenderTarget();e.composerMix.renderer.setRenderTarget(e.composerMix.readBuffer),e.composerMix.renderer.clear(),e.composerAdditive.renderer.setRenderTarget(e.composerAdditive.readBuffer),e.composerAdditive.renderer.clear(),e.composerMix.renderer.setRenderTarget(t),e.isAdditiveRoad()&&e.composerAdditive.render(),e.isMixRoad()&&e.composerMix.render(),e.composerBackground.render(),e.scene.fog.setViewport(e.composerMix.readBuffer.viewport.z,e.composerMix.readBuffer.viewport.w),e.isAdditiveRoad()&&e.scene.fog.setPostProcessAdditiveMap(e.composerAdditive.readBuffer.texture),e.isMixRoad()&&e.scene.fog.setPostProcessMap(e.composerMix.readBuffer.texture)}}isMixRoad(){var e=this;return e.rainPass.enabled||e.snowPass.enabled||e.fogPass.enabled||e.skylinePass.enabled||e.highlightoutlinePass.enabled||e.scanRingPassAry.length>0||e.fanScanPassAry.length>0}isAdditiveRoad(){return this.glowPass.length>0||this.ssaoPass.enabled}setSize(e,t){var i=this,r=window.devicePixelRatio||1;i.width=e*r,i.height=t*r,null!=i.normalRenderTarget&&i.normalRenderTarget.setSize(i.width,i.height),null!=i.depthRenderTarget&&i.depthRenderTarget.setSize(i.width,i.height),null!=i.transparentDepthRenderTarget&&i.transparentDepthRenderTarget.setSize(i.width,i.height),i.composerMix.setSize(i.width,i.height),i.composerAdditive.setSize(i.width,i.height),i.composerBackground.setSize(i.width,i.height)}updateEnabled(){var e=this;e.snowPass.enabled=r.GlobalData.EnableSnowPass,e.fogPass.enabled=r.GlobalData.EnableFogPass,e.rainPass.enabled=r.GlobalData.EnableRainPass,e.skylinePass.enabled=r.GlobalData.EnableSkylinePass,e.ssaoPass.enabled=r.GlobalData.SSAO,e.highlightoutlinePass.enabled=r.GlobalData.EnableGlow&&r.GlobalData.HighLightOutlineCount>0;for(var t=0;t<e.glowPass.length;t++)e.glowPass[t].enabled=r.GlobalData.EnableGlow||e.glowPass[t].useDiffuse}getNormalTexture(){var e=this;if(null==e.normalMaterial&&(e.normalMaterial=new r.NormalMaterial,e.normalMaterial.blending=THREE.NoBlending),null==e.normalStandardMaterial&&(e.normalStandardMaterial=new r.InstancedNormalMaterial,e.normalStandardMaterial.blending=THREE.NoBlending),null==e.normalRenderTarget&&(e.normalRenderTarget=new THREE.WebGLRenderTarget(e.width,e.height,{minFilter:THREE.NearestFilter,magFilter:THREE.NearestFilter,format:THREE.RGBAFormat})),0==e.normalTextureFlg){var t=e.renderer.autoClear;e.renderer.autoClear=!1,e.modelManager.adjustVisibility(!1),e.modelManager.adjustInstanceVisibility(!0),e.scene.overrideMaterial=e.normalStandardMaterial;var i=e.renderer.getRenderTarget();e.renderer.setRenderTarget(e.normalRenderTarget),e.renderer.clear(),e.renderer.render(e.scene,e.camera),e.scene.overrideMaterial=null,e.modelManager.adjustVisibility(!0),e.modelManager.adjustInstanceVisibility(!1),e.scene.overrideMaterial=e.normalMaterial,e.renderer.render(e.scene,e.camera),e.renderer.setRenderTarget(i),e.scene.overrideMaterial=null,e.modelManager.adjustInstanceVisibility(!0),e.normalTextureFlg=!0,e.renderer.autoClear=t}return e.normalRenderTarget.texture}getDepthTexture(){var e=this;if(null==e.depthMaterial&&(e.depthMaterial=new r.CustomMeshDepthMaterial,e.depthMaterial.side=THREE.DoubleSide,e.depthMaterial.depthPacking=THREE.RGBADepthPacking,e.depthMaterial.blending=THREE.NoBlending),null==e.InstancedDepthMaterial&&(e.InstancedDepthMaterial=new r.CustomInstancedMeshDepthMaterial,e.InstancedDepthMaterial.side=THREE.DoubleSide,e.InstancedDepthMaterial.depthPacking=THREE.RGBADepthPacking,e.InstancedDepthMaterial.blending=THREE.NoBlending),null==e.depthRenderTarget&&(e.depthRenderTarget=new THREE.WebGLRenderTarget(e.width,e.height,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter})),0==e.depthTextureFlg){var t=e.renderer.autoClear;e.renderer.autoClear=!1,e.scene.overrideMaterial=e.depthMaterial,e.modelManager.adjustVisibility(!0),e.modelManager.adjustInstanceVisibility(!1);const a=r.DepthRenderPass.hideInVisibleGroup(e.scene);var i=e.renderer.getRenderTarget();e.renderer.setRenderTarget(e.depthRenderTarget),e.renderer.clear(),e.renderer.render(e.scene,e.camera),e.scene.overrideMaterial=e.InstancedDepthMaterial,e.modelManager.adjustVisibility(!1),e.modelManager.adjustInstanceVisibility(!0),r.DepthRenderPass.restoreInVisibleGroup(e.scene,a),e.renderer.render(e.scene,e.camera),e.renderer.setRenderTarget(i),e.scene.overrideMaterial=null,e.modelManager.adjustVisibility(!0),e.depthTextureFlg=!0,e.renderer.autoClear=t}return e.depthRenderTarget.texture}getTransparentDepthTexture(t=.95){var i=this;if(null==i.transparentDepthMaterial&&(i.transparentDepthMaterial=new THREE.MeshDepthMaterial,i.transparentDepthMaterial.side=THREE.DoubleSide,i.transparentDepthMaterial.depthPacking=THREE.RGBADepthPacking,i.transparentDepthMaterial.blending=THREE.NoBlending),null==i.transparentInstancedDepthMaterial&&(i.transparentInstancedDepthMaterial=new r.InstancedDepthMaterial,i.transparentInstancedDepthMaterial.side=THREE.DoubleSide,i.transparentInstancedDepthMaterial.depthPacking=THREE.RGBADepthPacking,i.transparentInstancedDepthMaterial.blending=THREE.NoBlending,i.transparentInstancedDepthMaterial.uniforms.discardAlpha.value=t),null==i.transparentDepthRenderTarget){var a=new THREE.DepthTexture;a.format=THREE.DepthStencilFormat,a.type=THREE.UnsignedInt248Type,a.minFilter=THREE.NearestFilter,a.maxFilter=THREE.NearestFilter,i.transparentDepthRenderTarget=new THREE.WebGLRenderTarget(i.width,i.height,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat,depthTexture:a,depthBuffer:!0,stencilBuffer:!1})}if(0==i.transparentDepthTextureFlg){var n=i.renderer.autoClear;i.transparentObjectTemp={},i.transparentObjectVisibleListTemp={},e.setTransparentObjectVisible(i.scene,i.camera,t,!1,i.transparentObjectTemp,i.transparentObjectVisibleListTemp);const a=r.DepthRenderPass.hideInVisibleGroup(i.scene);i.scene.overrideMaterial=i.transparentDepthMaterial,i.modelManager.adjustVisibility(!0),i.modelManager.adjustInstanceVisibility(!1);var s=i.renderer.getRenderTarget();i.renderer.setRenderTarget(i.transparentDepthRenderTarget),i.renderer.clear(),i.renderer.render(i.scene,i.camera),i.scene.overrideMaterial=i.transparentInstancedDepthMaterial,i.modelManager.adjustVisibility(!1),i.modelManager.adjustInstanceVisibility(!0),i.renderer.setRenderTarget(i.transparentDepthRenderTarget),i.renderer.render(i.scene,i.camera),i.renderer.setRenderTarget(s),e.setTransparentObjectVisible(i.scene,i.camera,t,!0,i.transparentObjectTemp,i.transparentObjectVisibleListTemp),i.modelManager.adjustVisibility(!0),r.DepthRenderPass.restoreInVisibleGroup(i.scene,a),i.scene.overrideMaterial=null,i.transparentDepthTextureFlg=!0,i.renderer.autoClear=n}return i.transparentDepthRenderTarget.depthTexture}addRingScanEffect(e){var t=this,i=new r.ScanRingPass(e.id,t,t.viewer,t.width,t.height);return i.setOpts(e),t.composerMix.insertPass(i,t.composerMix.passes.length-1),t.scanRingPassAry.push(i),i}removeRingScanEffect(e){for(var t=this,i=0;i<t.scanRingPassAry.length;i++)if(t.scanRingPassAry[i].id==e){t.scanRingPassAry.splice(i,1);for(var r=0;r<t.composerMix.passes.length;r++)t.composerMix.passes[r].id==e&&(t.composerMix.passes[r].dispose(),t.composerMix.passes.splice(r,1));return!0}return!1}addFanScanEffect(e){const t=this,i=new r.FanScanPass(e.id,t,t.viewer,t.width,t.height);return i.setOpts(e),t.composerMix.insertPass(i,t.composerMix.passes.length-1),t.fanScanPassAry.push(i),i}removeFanScanEffect(e){const t=this;for(let i=0,r=t.fanScanPassAry.length;i<r;i++)if(t.fanScanPassAry[i].id==e){t.fanScanPassAry.splice(i,1);for(let i=0;i<t.composerMix.passes.length;i++)t.composerMix.passes[i].id==e&&(t.composerMix.passes[i].dispose(),t.composerMix.passes.splice(i,1));return!0}return!1}checkRender(e){var t=this;let i=t.viewer.rendererManager.renderer;var r=function(){i._isCameraChanged()&&i.adjustNearFar(),t.render(),t.conventionFn(),t.requestAnimationFrameID=window.requestAnimationFrame(r)};t.snowPass.enabled||t.scanRingPassAry.length>0||t.fanScanPassAry.length>0||t.rainPass.enabled?0==t.autoRenderFlg&&(r(),t.autoRenderFlg=!0):(t.autoRenderFlg=!1,window.cancelAnimationFrame(t.requestAnimationFrameID),t.render(),t.conventionFn())}rainEffectOpt(e){if(null!=this.rainPass)return null==e?this.rainPass.getOpts():void this.rainPass.setOpts(e)}snowEffectOpt(e){if(null!=this.snowPass)return null==e?this.snowPass.getOpts():void this.snowPass.setOpts(e)}ssaoEffectOpt(e){if(null!=this.ssaoPass)return null==e?this.ssaoPass.getOpts():void this.ssaoPass.setOpts(e)}fogEffectOpt(e){if(null!=this.fogPass)return null==e?this.fogPass.getOpts():void this.fogPass.setOpts(e)}skylineOpt(e){if(null!=this.skylinePass)return null==e?this.skylinePass.getOpts():void this.skylinePass.setOpts(e)}addGlowEffect(e){var t=this,i=new r.GlowPass(t,e.useDiffuse);return t.composerAdditive.insertPass(i,t.composerAdditive.passes.length-1),t.glowPass.push(i),i.fillColor=e.fillColor,i.intensity=e.intensity,i.spread=e.spread,i.luminosityThreshold=e.threshold,i}updateGlowEffect(e,t){var i=this;for(var r in i.selectedGlow)if(null!=i.selectedGlow[r][e]&&null!=i.selectedGlow[r][e][t])for(var a=0;a<i.glowPass.length;a++)if(i.glowPass[a].key==r){i.glowPass[a].updateSelectedObjectIds=!0;break}i.highlightoutlinePass&&i.highlightoutlinePass.updateHighLightOutlineById(e,t)}setGlowEffectById(e,t,i){var a=this,n=i.color||new THREE.Color(1,1,1),s=Math.max(Math.min(i.intensity,1),0),o=Math.max(Math.min(i.spread,5),1);let l=null==i.threshold?0:i.threshold;l=Math.max(Math.min(l,1),0);var d,h=n.r+"_"+n.g+"_"+n.b+"_"+s+"_"+o+"_"+l;if(a.removeGlowEffectById(e,t,i.useDiffuse),null==a.selectedGlow[h])a.selectedGlow[h]={},(d=a.addGlowEffect({fillColor:n,intensity:s,spread:o,useDiffuse:null!=i.useDiffuse&&i.useDiffuse,threshold:l})).key=h;else for(var c=0;c<a.glowPass.length;c++)if(a.glowPass[c].key==h){d=a.glowPass[c];break}a.selectedGlow[h][e]||(a.selectedGlow[h][e]={});c=0;for(var u=t.length;c<u;c++)i.useDiffuse?r.GlobalData.BloomCount++:r.GlobalData.GlowCount++,a.selectedGlow[h][e][t[c]]=!0;d.selectedObjectIds=a.selectedGlow[h],d.updateSelectedObjectIds=!0}_removeGlowPassByKey(e){for(var t=this,i=0;i<t.glowPass.length;i++)if(t.glowPass[i].key==e){t.glowPass.splice(i,1);for(var r=0;r<t.composerAdditive.passes.length;r++)t.composerAdditive.passes[r].key==e&&(t.composerAdditive.passes[r].dispose(),t.composerAdditive.passes.splice(r,1));return!0}return!1}removeGlowEffectById(e,t){var i=this;for(var a in i.selectedGlow)if(null!=i.selectedGlow[a][e]){for(var n,s=0;s<i.glowPass.length;s++)if(i.glowPass[s].key==a){n=i.glowPass[s];break}var o=i.selectedGlow[a][e];let h=n.useDiffuse;if(null==t){var l=Object.keys(o).length;h?r.GlobalData.BloomCount-=l:r.GlobalData.GlowCount-=l,o={}}else for(var d=0;d<t.length;d++)o[t[d]]&&(h?r.GlobalData.BloomCount--:r.GlobalData.GlowCount--,delete o[t[d]],null!=n&&(n.updateSelectedObjectIds=!0));0==Object.keys(o).length&&delete i.selectedGlow[a][e],0==Object.keys(i.selectedGlow[a]).length&&(i._removeGlowPassByKey(a),delete i.selectedGlow[a])}}applyGlowEffectByModel(e,t){if(0!==this.glowPass.length)for(let i=0;i<this.glowPass.length;i++){const r=this.glowPass[i].selectedObjectIds[e.id];if(!r)return;for(const a in r){const r=e.tilesLoader.tileReader.getIndexByUserId(a);if(t.userIndexMap.has(r)){this.glowPass[i].updateSelectedObjectIds=!0;break}}}}}e.setTransparentObjectVisible=(t,i,r,a,n,s)=>{if(t.layers.test(i.layers))if(t.isImmediateRenderObject){const e=t.material;e.transparent&&e.opacity<r&&(t.visible=a)}else if(t.isMesh||t.isLine||t.isPoints){const e=t.material,i=t.databagId+"_"+t.uuid;if(Array.isArray(e)&&null!=t.geometry&&null!=t.geometry.groups){const s=t.geometry.groups;if(0==a&&s.length>0)for(let t=s.length-1;t>=0;t--){let a=s[t].materialIndex;a<0&&(a=Math.abs(2+a)),e[a]&&e[a].transparent&&e[a].opacity<r&&(null==n[i]&&(n[i]=[]),n[i].push(s[t]),s.splice(t,1))}else if(a&&null!=n[i]&&n[i].length>0)for(let e=n[i].length-1;e>=0;e--)s.push(n[i][e]),n[i].splice(e,1)}}for(var o=t.children,l=0,d=o.length;l<d;l++)e.setTransparentObjectVisible(o[l],i,r,a,n,s)},r.RenderEffectComposer=e}(),THREE.ShaderPass=function(e,t){THREE.Pass.call(this),this.textureID=void 0!==t?t:"tDiffuse",e instanceof THREE.ShaderMaterial?(this.uniforms=e.uniforms,this.material=e):e&&(this.uniforms=THREE.UniformsUtils.clone(e.uniforms),this.material=new THREE.ShaderMaterial({defines:e.defines||{},uniforms:this.uniforms,vertexShader:e.vertexShader,fragmentShader:e.fragmentShader})),this.camera=new THREE.OrthographicCamera(-1,1,1,-1,0,1),this.scene=new THREE.Scene,this.quad=new THREE.Mesh(new THREE.PlaneBufferGeometry(2,2),null),this.quad.frustumCulled=!1,this.scene.add(this.quad)},THREE.ShaderPass.prototype=Object.assign(Object.create(THREE.Pass.prototype),{constructor:THREE.ShaderPass,render:function(e,t,i,r,a){this.uniforms[this.textureID]&&(this.uniforms[this.textureID].value=i.texture),this.quad.material=this.material,this.renderToScreen?e.render(this.scene,this.camera):e.render(this.scene,this.camera,t,this.clear)}}),THREE.SSAOPass=function(e,t,i,a,n,s){var o=this;THREE.Pass.call(o),o.KERNEL_SIZE=32,o.shader=THREE.SSAOShader,o.uniforms=THREE.UniformsUtils.clone(o.shader.uniforms),o.material=new THREE.ShaderMaterial({defines:o.shader.defines||{},uniforms:o.uniforms,vertexShader:o.shader.vertexShader,fragmentShader:o.shader.fragmentShader}),o.renderComposer=e,o.sceneCamera=i,o.mainScene=t,o.modelManager=s,o.width=a,o.height=n,o.oldClearColor=new THREE.Color,o.oldClearAlpha=1,o.minDistance=3e-4,o.maxDistance=8e-4,o.kernelRadius=.5,o.blurKernelRadius=4,o.blurMaxRadius=10,o.blurDirectionX=new THREE.Vector2(1,0),o.blurDirectionY=new THREE.Vector2(0,1),o.blurDirectionXY=new THREE.Vector2(1,1),o.blurDirectionXY2=new THREE.Vector2(-1,-1),o.createOverlayMaterial(),o.renderTarget=new THREE.WebGLRenderTarget(o.width,o.height,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat,stencilBuffer:!0}),o.renderTarget.texture.name="SSAO.renderpass",o.enabled=!1,o.uniforms.tNoise.value=o.generateRandomKernelRotations(),o.uniforms.kernel.value=o.generateSampleKernel(),o.uniforms.minDistance.value=o.minDistance,o.uniforms.maxDistance.value=o.maxDistance,o.camera=new THREE.OrthographicCamera(-1,1,1,-1,0,1),o.scene=new THREE.Scene,o.quad=new THREE.Mesh(new THREE.PlaneBufferGeometry(2,2),null),o.quad.frustumCulled=!1,o.scene.add(o.quad),o.renderTargetSSAOBuffer=new THREE.WebGLRenderTarget(o.width,o.height,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat}),o.renderTargetSSAOBuffer.texture.name="SSAOPass.edge",o.renderTargetSSAOBuffer.texture.generateMipmaps=!1,o.separableBlurMaterial=new THREE.ShaderMaterial(r.SeperableBlurShader),o.blurMaterial=new THREE.ShaderMaterial({defines:Object.assign({},r.SSAOBlurShader.defines),uniforms:THREE.UniformsUtils.clone(r.SSAOBlurShader.uniforms),vertexShader:r.SSAOBlurShader.vertexShader,fragmentShader:r.SSAOBlurShader.fragmentShader}),o.renderTargetBlurBuffer=new THREE.WebGLRenderTarget(o.width,o.height,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat}),o.renderTargetBlurBuffer.texture.name="SSAOPass.blur",o.renderTargetBlurBuffer.texture.generateMipmaps=!1,o.renderTargetBlurBuffer1=new THREE.WebGLRenderTarget(o.width,o.height,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat}),o.renderTargetBlurBuffer1.texture.name="SSAOPass.blur1",o.renderTargetBlurBuffer1.texture.generateMipmaps=!1,o.renderTargetBlurBuffer2=new THREE.WebGLRenderTarget(o.width,o.height,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat}),o.renderTargetBlurBuffer2.texture.name="SSAOPass.blur2",o.renderTargetBlurBuffer2.texture.generateMipmaps=!1,o.renderTargetBlurBuffer3=new THREE.WebGLRenderTarget(o.width,o.height,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat}),o.renderTargetBlurBuffer3.texture.name="SSAOPass.blur3",o.renderTargetBlurBuffer3.texture.generateMipmaps=!1,o.renderTargetBlurBuffer4=new THREE.WebGLRenderTarget(o.width,o.height,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat}),o.renderTargetBlurBuffer4.texture.name="SSAOPass.blur4",o.renderTargetBlurBuffer4.texture.generateMipmaps=!1},THREE.SSAOPass.prototype=Object.create(THREE.ShaderPass.prototype),THREE.SSAOPass.prototype.generateSampleKernel=function(){for(var e,t=[],i=0;i<this.KERNEL_SIZE;i++){var r=new THREE.Vector3;r.x=2*Math.random()-1,r.y=2*Math.random()-1,r.z=Math.random()/4,r.normalize();var a=i/this.KERNEL_SIZE;a=(1-(e=a*a))*.15+e*1,r.multiplyScalar(a),t.push(r)}return t},THREE.SSAOPass.prototype.setOpts=function(e){var t=this;e&&(void 0!==e.minDistance&&null!==e.minDistance&&(t.minDistance=e.minDistance),void 0!==e.maxDistance&&null!==e.maxDistance&&(t.maxDistance=e.maxDistance),void 0!==e.kernelRadius&&null!==e.kernelRadius&&(t.kernelRadius=e.kernelRadius),void 0!==e.blurKernelRadius&&null!==e.blurKernelRadius&&(t.blurKernelRadius=e.blurKernelRadius),void 0!==e.blurMaxRadius&&null!==e.blurMaxRadius&&(t.blurMaxRadius=e.blurMaxRadius))},THREE.SSAOPass.prototype.generateRandomKernelRotations=function(){for(var e=new Float32Array(64),t=0;t<16;t++){var i=4*t;e[i]=2*Math.random()-1,e[i+1]=2*Math.random()-1,e[i+2]=2*Math.random()-1,e[i+3]=1}var r=new THREE.DataTexture(e,4,4,THREE.RGBAFormat,THREE.FloatType);return r.wrapS=THREE.RepeatWrapping,r.wrapT=THREE.RepeatWrapping,r.needsUpdate=!0,r},THREE.SSAOPass.prototype.render=function(e,t,i,r,a){var n=this,s=e.getRenderTarget();e.setRenderTarget(n.renderTarget),e.clear(),e.render(n.mainScene,n.sceneCamera),e.getClearColor(n.oldClearColor),n.oldClearAlpha=e.getClearAlpha();var o=e.autoClear;e.setClearColor(0,0),e.autoClear=!1,n.uniforms.minDistance.value=n.minDistance,n.uniforms.maxDistance.value=n.maxDistance,n.uniforms.kernelRadius.value=n.kernelRadius,n.uniforms.tDepth.value=n.renderComposer.getDepthTexture(),n.uniforms.tNormal.value=n.renderComposer.getNormalTexture(),n.setCameraUniforms(n.sceneCamera),n.uniforms.logDepthBufFC.value=2/(Math.log(n.sceneCamera.far+1)/Math.LN2),n.uniforms.viewport.value.set(0,0,e.getContext().drawingBufferWidth,e.getContext().drawingBufferHeight),n.quad.material=n.material,e.setRenderTarget(n.renderTargetSSAOBuffer),e.clear(),e.render(n.scene,n.camera),n.quad.material=n.blurMaterial,n.blurMaterial.uniforms.tDiffuse.value=n.renderTargetSSAOBuffer.texture,e.setRenderTarget(n.renderTargetBlurBuffer),e.clear(),e.render(n.scene,n.camera),n.quad.material=n.separableBlurMaterial,n.separableBlurMaterial.uniforms.kernelRadius.value=n.blurKernelRadius,n.separableBlurMaterial.defines.MAX_RADIUS=n.blurMaxRadius,n.separableBlurMaterial.uniforms.colorTexture.value=n.renderTargetSSAOBuffer.texture,n.separableBlurMaterial.uniforms.direction.value=n.blurDirectionX,e.setRenderTarget(n.renderTargetBlurBuffer1),e.clear(),e.render(n.scene,n.camera),n.separableBlurMaterial.uniforms.colorTexture.value=n.renderTargetBlurBuffer1.texture,n.separableBlurMaterial.uniforms.direction.value=n.blurDirectionY,e.setRenderTarget(n.renderTargetBlurBuffer2),e.clear(),e.render(n.scene,n.camera),n.separableBlurMaterial.uniforms.colorTexture.value=n.renderTargetBlurBuffer2.texture,n.separableBlurMaterial.uniforms.direction.value=n.blurDirectionXY,e.setRenderTarget(n.renderTargetBlurBuffer3),e.clear(),e.render(n.scene,n.camera),n.separableBlurMaterial.uniforms.colorTexture.value=n.renderTargetBlurBuffer3.texture,n.separableBlurMaterial.uniforms.direction.value=n.blurDirectionXY2,e.setRenderTarget(n.renderTargetBlurBuffer4),e.clear(),e.render(n.scene,n.camera),n.scene.overrideMaterial=n.overlayMaterial,n.overlayMaterial.uniforms.edgeTexture1.value=n.renderTargetBlurBuffer.texture,n.overlayMaterial.uniforms.edgeTexture2.value=n.renderTargetBlurBuffer4.texture,n.overlayMaterial.uniforms.maskTexture.value=n.renderTarget.texture,e.setRenderTarget(t),e.clear(),e.render(n.scene,n.camera),n.scene.overrideMaterial=null,e.setClearColor(n.oldClearColor,n.oldClearAlpha),e.autoClear=o,e.setRenderTarget(s)},THREE.SSAOPass.prototype.setCameraUniforms=function(e){var t=this;t.sceneCamera=e,t.uniforms.cameraNear.value=t.sceneCamera.near,t.uniforms.cameraFar.value=t.sceneCamera.far,t.uniforms.cameraProjection.value.copy(t.sceneCamera.projectionMatrix),t.uniforms.inverseProjection.value.copy(t.sceneCamera.projectionMatrix).invert()},THREE.SSAOPass.prototype.setSize=function(e,t){var i=this;i.width=e,i.height=t,i.renderTarget.setSize(i.width,i.height),i.renderTargetSSAOBuffer.setSize(i.width,i.height),i.renderTargetBlurBuffer.setSize(i.width,i.height),i.renderTargetBlurBuffer1.setSize(i.width,i.height),i.renderTargetBlurBuffer2.setSize(i.width,i.height),i.renderTargetBlurBuffer3.setSize(i.width,i.height),i.renderTargetBlurBuffer4.setSize(i.width,i.height),i.uniforms.resolution.value.set(i.width,i.height),i.separableBlurMaterial.uniforms.texSize.value.set(i.width,i.height),i.blurMaterial.uniforms.resolution.value.set(i.width,i.height)},THREE.SSAOPass.prototype.createOverlayMaterial=function(){this.overlayMaterial=new THREE.ShaderMaterial({uniforms:{maskTexture:{value:null},edgeTexture1:{value:null},edgeTexture2:{value:null},edgeTexture3:{value:null}},vertexShader:"\n            varying vec2 vUv;\n\t\t\tvoid main() {\n\t\t\t\tvUv = uv;\n\t\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\t\t\t}\n\t\t",fragmentShader:"\n            varying vec2 vUv;\n            uniform sampler2D maskTexture;\n            uniform sampler2D edgeTexture1;\n            uniform sampler2D edgeTexture2;\n            #include <postprocess_minus_color>\n            void main() {\n                vec4 edgeValue1 = texture2D(edgeTexture1, vUv);\n                vec4 edgeValue2 = texture2D(edgeTexture2, vUv);\n                vec4 maskColor = texture2D(maskTexture, vUv);\n\n                vec4 color = maskColor;\n                color *= vec4(vec3(1.0 - edgeValue1.r),1.0);\n                color *= vec4(vec3(1.0 - edgeValue2.r),1.0);\n                gl_FragColor = postprocess_minus_color(color.rgb, maskColor.rgb);\n\t\t\t}\n\t\t"})},function(){class e extends THREE.Pass{constructor(e){super();var t=this;t.renderComposer=e,t.width=t.renderComposer.width,t.height=t.renderComposer.height,t.modelManager=t.renderComposer.modelManager,t.renderScene=t.renderComposer.scene,t.renderCamera=t.renderComposer.camera,t.selectedObjectIds={},r.GlobalData.HighLightOutlineCount=0,t.edgeStrength=10,t.visibleEdgeColor=new THREE.Color(0,1,0),t.hiddenEdgeColor=new THREE.Color(.1,.04,.02),t.intensity=.5,t.spread=1,t.defaultEdgeColor=(new THREE.Color).setHex(7733223),t.edgeColor=new THREE.Vector4(t.defaultEdgeColor.r,t.defaultEdgeColor.g,t.defaultEdgeColor.b,.95),t.edgeLength=2,t.blurDirectionX=new THREE.Vector2(1,0),t.blurDirectionY=new THREE.Vector2(0,1);var i={minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat};t.renderTargetMaskBuffer1=new THREE.WebGLRenderTarget(t.width,t.height,i),t.renderTargetMaskBuffer1.texture.name="OutlinePass.mask1",t.renderTargetMaskBuffer1.texture.generateMipmaps=!1,t.renderTargetMaskBuffer2=new THREE.WebGLRenderTarget(t.width,t.height,i),t.renderTargetMaskBuffer2.texture.name="OutlinePass.mask2",t.renderTargetMaskBuffer2.texture.generateMipmaps=!1,t.renderTargetBlurBuffer1=new THREE.WebGLRenderTarget(t.width,t.height,i),t.renderTargetBlurBuffer1.texture.name="OutlinePass.blur1",t.renderTargetBlurBuffer1.texture.generateMipmaps=!1,t.renderTargetBlurBuffer2=new THREE.WebGLRenderTarget(Math.round(t.width/2),Math.round(t.height/2),i),t.renderTargetBlurBuffer2.texture.name="OutlinePass.blur2",t.renderTargetBlurBuffer2.texture.generateMipmaps=!1,t.renderTargetEdgeBuffer1=new THREE.WebGLRenderTarget(t.width,t.height,i),t.renderTargetEdgeBuffer1.texture.name="OutlinePass.edge1",t.renderTargetEdgeBuffer1.texture.generateMipmaps=!1,t.renderTargetEdgeBuffer2=new THREE.WebGLRenderTarget(Math.round(t.width/2),Math.round(t.height/2),i),t.renderTargetEdgeBuffer2.texture.name="OutlinePass.edge2",t.renderTargetEdgeBuffer2.texture.generateMipmaps=!1,t.setEdgeDetectionMaterial(),t.separableBlurMaterial=new THREE.ShaderMaterial({defines:r.SeperableBlurShader.defines||{MAX_RADIUS:5},uniforms:THREE.UniformsUtils.clone(r.SeperableBlurShader.uniforms),vertexShader:r.SeperableBlurShader.vertexShader,fragmentShader:r.SeperableBlurShader.fragmentShader}),t.createOverlayMaterial(),t.oldClearColor=new THREE.Color,t.oldClearAlpha=1,t.camera=new THREE.OrthographicCamera(-1,1,1,-1,0,1),t.scene=new THREE.Scene,t.quad=new THREE.Mesh(new THREE.PlaneBufferGeometry(2,2),null),t.quad.frustumCulled=!1,t.scene.add(t.quad),t.prepareMaskMaterial=t.getPrepareMaskMaterial(),t.prepareMaskMaterial.side=THREE.DoubleSide,t.prepareMaskInstancedMaterial=t.getPrepareMaskInstancedMaterial(),t.prepareMaskInstancedMaterial.side=THREE.DoubleSide,t.initSelectedObjectSceneAndMaterial(),t.enabled=!1,t.setSize(),t.meshGeneratorId="outlineHighLight"}dispose(){var e=this;e.renderTargetMaskBuffer1.dispose(),e.renderTargetMaskBuffer2.dispose(),e.renderTargetEdgeBuffer1.dispose(),e.renderTargetEdgeBuffer2.dispose(),e.renderTargetBlurBuffer1.dispose(),e.renderTargetBlurBuffer2.dispose()}setSize(e,t){var i=this;null!=e&&(i.width=e),null!=t&&(i.height=t),i.renderTargetMaskBuffer1.setSize(i.width,i.height),i.renderTargetMaskBuffer2.setSize(i.width,i.height);var r=Math.round(i.width/2),a=Math.round(i.height/2);i.renderTargetEdgeBuffer1.setSize(i.width,i.height),i.renderTargetEdgeBuffer2.setSize(r,a),i.renderTargetBlurBuffer1.setSize(i.width,i.height),i.renderTargetBlurBuffer2.setSize(r,a),i.edgeDetectionMaterial.uniforms.texSize.value.set(i.width,i.height),i.separableBlurMaterial.uniforms.texSize.value.set(i.width,i.height)}initSelectedObjectSceneAndMaterial(){var e=this;e.selectedObjectScene=new THREE.Scene,e.selectedObjectScene.autoUpdate=!1,e.selectedObjectGroup=new r.ObjectGroup,e.selectedObjectGroup.name="OutlineHighLightMeshGroup",e.selectedObjectGroup.matrixAutoUpdate=!1,e.selectedObjectScene.add(e.selectedObjectGroup)}_ClearSelectedObjectScene(){this.selectedObjectGroup.clear()}_AddSelectedObjectToScene(e){let t=Object.keys(e);for(const i of t)this.selectedObjectGroup.add(e[i])}_GetSelectedObjectMeshes(e){var t=this,i={};return t.modelManager.traverseModels((function(r){var a=e[r.id];if(a){var n=Object.keys(a);r.getPickingMeshes({skinningWireframeMaterial:t.prepareMaskMaterial,skinningSelectedMaterial:t.prepareMaskMaterial,selectedLineMaterial:t.prepareMaskMaterial,selectedMaterial:t.prepareMaskMaterial,wireframeMaterial:t.prepareMaskMaterial,instancedSelectedMaterial:t.prepareMaskInstancedMaterial,instancedWireFrameMaterial:t.prepareMaskInstancedMaterial},i,n,a,t.meshGeneratorId)}})),i}_UpdateSelectedObjectSceneWorldMatrix(){this.selectedObjectGroup.matrix.copy(this.renderScene.getMatrixGlobal()),this.selectedObjectGroup.updateMatrixWorld(!0)}_UpdateSelectedObjectScene(e){var t=this;(1==t.updateSelectedObjectIds||t.modelManager.isFilterApplied()||t.renderComposer.isGis)&&(t._ClearSelectedObjectScene(),t._AddSelectedObjectToScene(t._GetSelectedObjectMeshes(e)),t.updateSelectedObjectIds=!1),this._UpdateSelectedObjectSceneWorldMatrix()}render(e,t,i,a,n,s){var o=this;if(0!==r.GlobalData.HighLightOutlineCount){o._UpdateSelectedObjectScene(o.selectedObjectIds),e.getClearColor(o.oldClearColor),o.oldClearAlpha=e.getClearAlpha();var l=e.autoClear;e.autoClear=!1,n&&e.getContext().disable(e.getContext().STENCIL_TEST),e.setClearColor(16777215,1);var d=e.getRenderTarget();e.setRenderTarget(o.renderTargetMaskBuffer1),e.clear(),e.render(o.selectedObjectScene,o.renderCamera),o.quad.material=o.edgeDetectionMaterial,o.edgeDetectionMaterial.uniforms.maskTexture.value=o.renderTargetMaskBuffer1.texture,o.edgeDetectionMaterial.uniforms.visibleEdgeColor.value=o.visibleEdgeColor,o.edgeDetectionMaterial.uniforms.hiddenEdgeColor.value=o.hiddenEdgeColor,e.setRenderTarget(o.renderTargetMaskBuffer2),e.clear(),e.render(o.scene,o.camera),o.quad.material=o.separableBlurMaterial,o.separableBlurMaterial.uniforms.kernelRadius.value=Math.sqrt(o.spread),o.separableBlurMaterial.uniforms.colorTexture.value=o.renderTargetMaskBuffer2.texture,o.separableBlurMaterial.uniforms.direction.value=o.blurDirectionX,e.setRenderTarget(o.renderTargetBlurBuffer1),e.clear(),e.render(o.scene,o.camera),o.separableBlurMaterial.uniforms.colorTexture.value=o.renderTargetBlurBuffer1.texture,o.separableBlurMaterial.uniforms.direction.value=o.blurDirectionY,e.setRenderTarget(o.renderTargetEdgeBuffer1),e.clear(),e.render(o.scene,o.camera),o.separableBlurMaterial.uniforms.kernelRadius.value=2*o.spread,o.separableBlurMaterial.uniforms.colorTexture.value=o.renderTargetEdgeBuffer1.texture,o.separableBlurMaterial.uniforms.direction.value=o.blurDirectionX,e.setRenderTarget(o.renderTargetBlurBuffer2),e.clear(),e.render(o.scene,o.camera),o.separableBlurMaterial.uniforms.colorTexture.value=o.renderTargetBlurBuffer2.texture,o.separableBlurMaterial.uniforms.direction.value=o.blurDirectionY,e.setRenderTarget(o.renderTargetEdgeBuffer2),e.clear(),e.render(o.scene,o.camera),o.quad.material=o.overlayMaterial,o.overlayMaterial.uniforms.maskTexture.value=o.renderTargetMaskBuffer1.texture,o.overlayMaterial.uniforms.edgeTexture1.value=o.renderTargetEdgeBuffer1.texture,o.overlayMaterial.uniforms.edgeTexture2.value=o.renderTargetEdgeBuffer2.texture,o.overlayMaterial.uniforms.edgeStrength.value=o.edgeStrength*o.intensity,o.overlayMaterial.uniforms.edgeGlow.value=o.spread/5,o.overlayMaterial.uniforms.firstFlg&&(o.overlayMaterial.uniforms.firstFlg.value=s?0:1),e.setRenderTarget(t),o.clear&&e.clear(),e.render(o.scene,o.camera),n&&e.state.buffers.stencil.setTest(!0),e.setClearColor(o.oldClearColor,o.oldClearAlpha),e.autoClear=l,e.setRenderTarget(d)}}createOverlayMaterial(){this.overlayMaterial=new THREE.ShaderMaterial({uniforms:{tDiffuse:{value:null},maskTexture:{value:null},edgeTexture1:{value:null},edgeTexture2:{value:null},edgeStrength:{value:1},edgeGlow:{value:1},firstFlg:{value:0}},vertexShader:"\n                    varying vec2 vUv;\n                    void main() {\n                        vUv = uv;\n                        gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n                    }\n                ",fragmentShader:"\n                    uniform sampler2D tDiffuse;\n                    varying vec2 vUv;\n                    uniform sampler2D maskTexture;\n                    uniform sampler2D edgeTexture1;\n                    uniform sampler2D edgeTexture2;\n                    uniform float edgeStrength;\n                    uniform float edgeGlow;\n                    uniform float firstFlg;\n\n                    #include <postprocess_mix_color>\n                    #include <postprocess_original_color>\n                    void main() {\n                        vec4 color = get_original_color(tDiffuse, vUv, firstFlg);\n                        vec4 edgeValue1 = texture2D(edgeTexture1, vUv);\n                        vec4 edgeValue2 = texture2D(edgeTexture2, vUv);\n                        vec4 maskColor = texture2D(maskTexture, vUv);\n\n                        vec4 edgeValue = edgeValue1 + edgeValue2 * edgeGlow;\n                        vec4 finalColor = edgeStrength * maskColor.r * edgeValue;\n                        gl_FragColor = mix_color(color, finalColor.rgb, finalColor.a);\n                        //fix BIMFACE-22520:edge.a > 0\n                        if(gl_FragColor.a < 0.1)  gl_FragColor.a = 0.0;\n                    }\n                "})}getPrepareMaskMaterial(){return new THREE.ShaderMaterial({uniforms:{depthTexture:{value:null},cameraNearFar:{value:new THREE.Vector2(.5,.5)},textureMatrix:{value:new THREE.Matrix4}},vertexShader:"\n                    varying vec2 vUv;\n    \t\t\t\tvarying vec4 projTexCoord;\n    \t\t\t\tvarying vec4 vPosition;\n    \t\t\t\tuniform mat4 textureMatrix;\n    \t\t\t\tvoid main() {\n    \t\t\t\t\tvUv = uv;\n    \t\t\t\t\tvPosition = modelViewMatrix * vec4( position, 1.0 );\n    \t\t\t\t\tvec4 worldPosition = modelMatrix * vec4( position, 1.0 );\n    \t\t\t\t\tprojTexCoord = textureMatrix * worldPosition;\n    \t\t\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n    \t\t\t\t}\n\t\t\t\t",fragmentShader:"\n                    #include <packing>\n                    varying vec4 vPosition;\n    \t\t\t\tvarying vec4 projTexCoord;\n    \t\t\t\tuniform sampler2D depthTexture;\n    \t\t\t\tuniform vec2 cameraNearFar;\n\n                    void main()\n                    {\n                        gl_FragColor.r = 0.0;\n                        gl_FragColor.g = 1.0;\n                        gl_FragColor.b = 0.0;\n                        gl_FragColor.a = 1.0;\n                    }\n                "})}getPrepareMaskInstancedMaterial(){return new THREE.ShaderMaterial({uniforms:{depthTexture:{value:null},cameraNearFar:{value:new THREE.Vector2(.5,.5)},textureMatrix:{value:new THREE.Matrix4}},vertexShader:"\n                    attribute float vState;\n                    attribute vec4 aColor;\n                    attribute vec3 mcol0;\n                    attribute vec3 mcol1;\n                    attribute vec3 mcol2;\n                    attribute vec3 mcol3;\n                    #if defined(USE_MAP)\n                        attribute vec2 muvCol0;\n                        attribute vec2 muvCol1;\n                        attribute vec2 muvCol2;\n                    #endif\n\n                    varying float vfState;\n                    varying vec2 vUv;\n    \t\t\t\tvarying vec4 projTexCoord;\n    \t\t\t\tvarying vec4 vPosition;\n    \t\t\t\tuniform mat4 textureMatrix;\n\n    \t\t\t\tvec3 getInstancePosition(vec3 position) {\n                        return vec3(mat4(vec4(mcol0, 0.0),\n                                         vec4(mcol1, 0.0),\n                                         vec4(mcol2, 0.0),\n                                         vec4(mcol3, 1.0)) * vec4(position, 1.0));\n                    }\n\n                    vec2 getInstanceUV(vec2 uv) {\n                        #if defined(USE_MAP)\n                            return vec2(mat3(vec3(muvCol0, 0.0),\n                                             vec3(muvCol1, 0.0),\n                                             vec3(muvCol2, 1.0)) * vec3(uv, 1.0));\n                        #else\n                            return uv;\n                        #endif\n                    }\n\n    \t\t\t\tvoid main() {\n    \t\t\t\t    vfState = vState;\n    \t\t\t\t\tvUv = uv;\n    \t\t\t\t\tvPosition = vec4(getInstancePosition(position), 1.0);\n    \t\t\t\t\tvec4 worldPosition = modelMatrix * vPosition;\n    \t\t\t\t\tprojTexCoord = textureMatrix * worldPosition;\n                        gl_Position = projectionMatrix * modelViewMatrix * vPosition;\n                        vPosition = modelViewMatrix * vPosition;\n\t\t\t\t    }\n    \t\t\t",fragmentShader:"\n                    #include <packing>\n                    varying float vfState;\n                    varying vec2 vUv;\n                    varying vec4 vPosition;\n                    varying vec4 projTexCoord;\n                    uniform sampler2D depthTexture;\n                    uniform vec2 cameraNearFar;\n\n                    float linearDepth(float depth)\n                    {\n                        float far = cameraNearFar.y;\n                        float near = cameraNearFar.x;\n                        return (2.0 * near) / (far + near - depth * (far - near));\n                    }\n\n                    void main() {\n                        if (vfState <= -0.99 && vfState >= -1.01) discard;\n                        gl_FragColor.r = 0.0;\n                        gl_FragColor.g = 1.0;\n                        gl_FragColor.b = 0.0;\n                        gl_FragColor.a = 1.0;\n                    }\n                "})}setEdgeDetectionMaterial(){this.edgeDetectionMaterial=new THREE.ShaderMaterial({uniforms:{maskTexture:{value:null},texSize:{value:new THREE.Vector2(.5,.5)},visibleEdgeColor:{value:new THREE.Vector3(1,1,1)},hiddenEdgeColor:{value:new THREE.Vector3(1,1,1)}},vertexShader:"\n                    varying vec2 vUv;\n    \t\t\t\tvoid main() {\n    \t\t\t\t\tvUv = uv;\n    \t\t\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n    \t\t\t\t}\n\t\t\t\t",fragmentShader:"\n                    varying vec2 vUv;\n                    uniform sampler2D maskTexture;\n                    uniform vec2 texSize;\n                    uniform vec3 visibleEdgeColor;\n                    uniform vec3 hiddenEdgeColor;\n                    void main() {\n                        vec2 invSize = 1.0 / texSize;\n                        vec4 uvOffset = vec4(1.0, 0.0, 0.0, 1.0) * vec4(invSize, invSize);\n                        vec4 c1 = texture2D( maskTexture, vUv + uvOffset.xy);\n                        vec4 c2 = texture2D( maskTexture, vUv - uvOffset.xy);\n                        vec4 c3 = texture2D( maskTexture, vUv + uvOffset.yw);\n                        vec4 c4 = texture2D( maskTexture, vUv - uvOffset.yw);\n                        float diff1 = (c1.r - c2.r)*0.5;\n                        float diff2 = (c3.r - c4.r)*0.5;\n                        float d = length( vec2(diff1, diff2) );\n                        float a1 = min(c1.g, c2.g);\n                        float a2 = min(c3.g, c4.g);\n                        float visibilityFactor = min(a1, a2);\n                        vec3 edgeColor =  visibleEdgeColor;\n                        gl_FragColor = vec4(edgeColor, 1.0) * vec4(d);\n                    }\n                "})}setHighLightOutlineById(e,t,i){var a=this;a.selectedObjectIds[e]||(a.selectedObjectIds[e]={});for(var n=a.selectedObjectIds[e],s=0,o=t.length;s<o;s++)n[t[s]]||r.GlobalData.HighLightOutlineCount++,n[t[s]]=!0;a.visibleEdgeColor=i.color,a.intensity=Math.max(Math.min(i.intensity,1),0),a.spread=Math.max(Math.min(i.spread,5),1),a.updateSelectedObjectIds=!0}removeHighLightOutlineById(e,t){var i=this;i.selectedObjectIds[e]||(i.selectedObjectIds[e]={});var a=i.selectedObjectIds[e];if(null==t){var n=Object.keys(a).length;r.GlobalData.HighLightOutlineCount-=n,i.selectedObjectIds[e]={}}else for(var s=0;s<t.length;s++)a[t[s]]&&(r.GlobalData.HighLightOutlineCount--,delete a[t[s]]);i.updateSelectedObjectIds=!0}updateHighLightOutlineById(e,t){var i=this.selectedObjectIds;i[e]&&i[e][t]&&(this.updateSelectedObjectIds=!0)}}r.OutlineHighLightPass=e}(),function(){class e extends THREE.Pass{constructor(e,t){super();var i=this;i.renderComposer=e,i.width=i.renderComposer.width,i.height=i.renderComposer.height,i.modelManager=i.renderComposer.modelManager,i.renderScene=i.renderComposer.scene,i.renderCamera=i.renderComposer.camera,i.intensity=.5,i.spread=1,i.depthMaterial=new THREE.MeshDepthMaterial,i.depthMaterial.side=THREE.DoubleSide,i.depthMaterial.depthPacking=THREE.RGBADepthPacking,i.depthMaterial.blending=THREE.NoBlending,i.instancedDepthMaterial=new r.InstancedDepthMaterial,i.instancedDepthMaterial.side=THREE.DoubleSide,i.instancedDepthMaterial.depthPacking=THREE.RGBADepthPacking,i.instancedDepthMaterial.blending=THREE.NoBlending;var a=new THREE.DepthTexture;a.format=THREE.DepthStencilFormat,a.type=THREE.UnsignedInt248Type,a.minFilter=THREE.NearestFilter,a.maxFilter=THREE.NearestFilter,i.selectDepthRenderTarget=new THREE.WebGLRenderTarget(i.width,i.height,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat,depthTexture:a,depthBuffer:!0,stencilBuffer:!1}),i.setFillColorMaterial(),i.fillColorMaterial.uniforms.SelectObjDepthTexture.value=i.selectDepthRenderTarget.depthTexture,i.fillColorMaterial.uniforms.diffuseMap.value=i.selectDepthRenderTarget.texture,t&&(i.fillColorMaterial.defines.USE_DIFFUSEMAP=""),i.QuadCamera=new THREE.OrthographicCamera(-1,1,1,-1,0,1),i.ScreenQuad=new THREE.Scene,i.quad=new THREE.Mesh(new THREE.PlaneBufferGeometry(2,2),null),i.quad.frustumCulled=!1,i.ScreenQuad.add(i.quad),i.GlowRenderTarget=new THREE.WebGLRenderTarget(i.width,i.height,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat}),i.GlowRenderTarget.texture.generateMipmaps=!1,i.fillColor=new THREE.Color(1,0,0),i.selectedObjectIds={},i.blurDirectionX=new THREE.Vector2(1,0),i.blurDirectionY=new THREE.Vector2(0,1);var n={minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat},s=Math.round(i.width/2),o=Math.round(i.height/2);this.renderTargetsHorizontal=[],this.renderTargetsVertical=[],this.nMips=5;var l=[3,5,7,9,11];this.separableBlurMaterials=[];for(var d=0;d<this.nMips;d++){var h=new THREE.WebGLRenderTarget(s,o,n);h.texture.name="UnrealBloomPass.h"+d,h.texture.generateMipmaps=!1,this.renderTargetsHorizontal.push(h);var c=new THREE.WebGLRenderTarget(s,o,n);c.texture.name="UnrealBloomPass.v"+d,c.texture.generateMipmaps=!1,this.renderTargetsVertical.push(c),this.separableBlurMaterials.push(this.getSeperableBlurMaterial(l[d])),this.separableBlurMaterials[d].uniforms.texSize.value=new THREE.Vector2(s,o),s=Math.round(s/2),o=Math.round(o/2)}i.createOverlayMaterial(),i.overlayMaterial.uniforms.blurTexture0.value=this.renderTargetsVertical[0].texture,i.overlayMaterial.uniforms.blurTexture1.value=this.renderTargetsVertical[1].texture,i.overlayMaterial.uniforms.blurTexture2.value=this.renderTargetsVertical[2].texture,i.overlayMaterial.uniforms.blurTexture3.value=this.renderTargetsVertical[3].texture,i.overlayMaterial.uniforms.blurTexture4.value=this.renderTargetsVertical[4].texture,i.enabled=!1,i.oldClearColor=new THREE.Color,i.oldClearAlpha=1,i.initSelectedObjectSceneAndMaterial(),i.meshGeneratorId="glow",i._renderIndex=-1,i.useDiffuse=t,i.luminosityThreshold=0,i.modelUserIdTileMapVisibility={}}dispose(){this.GlowRenderTarget.dispose(),this.selectDepthRenderTarget.dispose();for(var e=0;e<this.nMips;e++)this.renderTargetsHorizontal[e].dispose(),this.renderTargetsVertical[e].dispose();this.modelUserIdTileMapVisibility=null}setSize(e,t){var i=this;i.width=e,i.height=t,i.GlowRenderTarget.setSize(e,t),i.selectDepthRenderTarget.setSize(e,t);for(var r=Math.round(i.width/2),a=Math.round(i.height/2),n=0;n<this.nMips;n++)this.renderTargetsHorizontal[n].setSize(r,a),this.renderTargetsVertical[n].setSize(r,a),this.separableBlurMaterials[n].uniforms.texSize.value=new THREE.Vector2(r,a),r=Math.round(r/2),a=Math.round(a/2)}initSelectedObjectSceneAndMaterial(){var e=this;e.selectedObjectScene=new THREE.Scene,e.selectedObjectScene.autoUpdate=!1,e.selectedObjectGroup=new r.ObjectGroup,e.selectedObjectGroup.name="GlowMeshGroup",e.selectedObjectGroup.matrixAutoUpdate=!1,e.selectedObjectScene.add(e.selectedObjectGroup)}_ClearSelectedObjectScene(){this.selectedObjectGroup.clear()}_AddSelectedObjectToScene(e){let t=Object.keys(e);for(const i of t)this.selectedObjectGroup.add(e[i])}_isTilesVisibleChanged(e){let t=!1;return this.modelManager.traverseModels((i=>{if(!i.tilesLoader)return;let r=e[i.id];if(!r)return;const a=Object.keys(r),n=i.getUserIdTileMap(a);if(i.getUserIdTileMapVisibility(n),this.modelUserIdTileMapVisibility[i.id]){const e=this.modelUserIdTileMapVisibility[i.id];for(const i in n)for(const r in n[i])e[i]&&e[i][r]===n[i][r]||(t=!0)}else this.modelUserIdTileMapVisibility[i.id]=n,t=!0;this.modelUserIdTileMapVisibility[i.id]=n})),t}_GetSelectedObjectMeshes(e){var t=this,i={};return t.modelManager.traverseModels((function(r){let a=e[r.id];if(!a)return;var n=Object.keys(a);let s=t.useDiffuse?{}:{skinningWireframeMaterial:t.depthMaterial,skinningSelectedMaterial:t.depthMaterial,selectedLineMaterial:t.depthMaterial,selectedMaterial:t.depthMaterial,wireframeMaterial:t.depthMaterial,instancedSelectedMaterial:t.instancedDepthMaterial,instancedWireFrameMaterial:t.instancedDepthMaterial};r.getPickingMeshes(s,i,n,a,t.meshGeneratorId+t.renderIndex)})),i}_UpdateSelectedObjectSceneWorldMatrix(){this.selectedObjectGroup.matrix.copy(this.renderScene.getMatrixGlobal()),this.selectedObjectGroup.updateMatrixWorld(!0)}_UpdateSelectedObjectScene(e){var t=this;(1==t.updateSelectedObjectIds||t._renderIndex!=t.renderIndex||t.modelManager.isFilterApplied()||t._isTilesVisibleChanged(e))&&(t._renderIndex=t.renderIndex,t._ClearSelectedObjectScene(),t._AddSelectedObjectToScene(t._GetSelectedObjectMeshes(e)),t.updateSelectedObjectIds=!1),t._UpdateSelectedObjectSceneWorldMatrix()}render(e,t,i,r,a,n){var s=this;s._UpdateSelectedObjectScene(s.selectedObjectIds),e.autoClear=!1;var o=e.getRenderTarget();e.setRenderTarget(s.selectDepthRenderTarget),e.clear(),s._dealDepthWrite(),e.render(s.selectedObjectScene,s.renderCamera),s._rescoverDepthWrite(),s.fillColorMaterial.uniforms.cameraNear.value=s.renderCamera.near,s.fillColorMaterial.uniforms.cameraFar.value=s.renderCamera.far,s.fillColorMaterial.uniforms.fillColor.value=s.fillColor,s.fillColorMaterial.uniforms.luminosityThreshold.value=s.luminosityThreshold,s.fillColorMaterial.uniforms.scenDepthTexture.value=s.renderComposer.getTransparentDepthTexture(),s.quad.material=s.fillColorMaterial,e.setRenderTarget(s.GlowRenderTarget),e.clear(),e.render(s.ScreenQuad,s.QuadCamera);for(var l=this.GlowRenderTarget,d=0;d<this.nMips;d++)this.quad.material=this.separableBlurMaterials[d],this.separableBlurMaterials[d].uniforms.colorTexture.value=l.texture,this.separableBlurMaterials[d].uniforms.direction.value=s.blurDirectionX,e.setRenderTarget(this.renderTargetsHorizontal[d]),e.clear(),e.render(s.ScreenQuad,s.QuadCamera),this.separableBlurMaterials[d].uniforms.colorTexture.value=this.renderTargetsHorizontal[d].texture,this.separableBlurMaterials[d].uniforms.direction.value=s.blurDirectionY,e.setRenderTarget(this.renderTargetsVertical[d]),e.clear(),e.render(s.ScreenQuad,s.QuadCamera),l=this.renderTargetsVertical[d];s.overlayMaterial.uniforms.firstFlg.value=n?0:1,s.overlayMaterial.uniforms.sceneTexture.value=i.texture,s.overlayMaterial.uniforms.bloomStrength.value=s.useDiffuse?2*s.intensity:s.intensity,s.overlayMaterial.uniforms.bloomRadius.value=s.spread/5,s.quad.material=s.overlayMaterial,e.setRenderTarget(t),s.clear&&e.clear(),e.render(s.ScreenQuad,s.QuadCamera),e.setRenderTarget(o)}_dealDepthWrite(){let e=this.selectedObjectScene.getObjectByName("PickingExternalMeshGroup");if(e){var t=e.children;for(let e=0;e<t.length;e++)t[e].material&&0==t[e].material.depthWrite&&(t[e].material.depthWrite=!0,t[e].material.originDepthWrite=!1)}}_rescoverDepthWrite(){let e=this.selectedObjectScene.getObjectByName("PickingExternalMeshGroup");if(e){var t=e.children;for(let e=0;e<t.length;e++)t[e].material&&0==t[e].material.originDepthWrite&&(t[e].material.depthWrite=!1)}}setFillColorMaterial(){this.fillColorMaterial=new THREE.ShaderMaterial({defines:{},uniforms:{scenDepthTexture:{value:null},SelectObjDepthTexture:{value:null},cameraNear:{value:1},cameraFar:{value:100},fillColor:{value:new THREE.Vector3(1,1,1)},diffuseMap:{value:null},luminosityThreshold:{value:0}},vertexShader:"\n                    varying vec2 vUv;\n                    void main() {\n                        vUv = uv;\n                        gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n                    }\n                ",fragmentShader:"\n                    varying vec2 vUv;\n                    #include <common>\n                    #include <packing>\n                    uniform sampler2D scenDepthTexture;\n                    uniform sampler2D SelectObjDepthTexture;\n                    #ifdef USE_DIFFUSEMAP\n                        uniform sampler2D diffuseMap;\n                    #endif\n                    uniform vec3 fillColor;\n                    uniform float cameraNear;\n                    uniform float cameraFar;\n\n                    uniform float luminosityThreshold;\n                    float smoothWidth = 0.01;\n                    const vec4 defaultColor = vec4(0.0, 0.0, 0.0, 0.0);\n                    float getViewZ( const in float depth )\n                    {\n                        return perspectiveDepthToViewZ( depth, cameraNear, cameraFar );\n                    }\n                    void main() {\n                        float sceneDepthNDC = texture2D(scenDepthTexture, vUv).x;\n                        float selectObjDepthNDC = texture2D(SelectObjDepthTexture, vUv).x;\n                        float sceneDepth = getViewZ(sceneDepthNDC);\n                        float selectObjDepth = getViewZ(selectObjDepthNDC);\n                        if((sceneDepthNDC == 1.0 && selectObjDepthNDC != 1.0) ||\n                            (sceneDepth - selectObjDepth < 0.0001 && selectObjDepthNDC != 1.0) )\n                        {\n                            #ifdef USE_DIFFUSEMAP\n                                vec4 color = texture2D(diffuseMap, vUv);\n                                vec3 luma = vec3( 0.299, 0.587, 0.114 );\n                                float v = dot( color.xyz, luma );\n                                float alpha = smoothstep( luminosityThreshold, luminosityThreshold + smoothWidth, v );\n                                gl_FragColor = mix( defaultColor, color * 2.0, alpha );\n                            #else\n                                gl_FragColor = vec4(fillColor.xyz, 1.0);\n                            #endif\n    \n                        }\n                        else\n                        {\n                            gl_FragColor = vec4(0.0,0.0,0.0,0.0);\n                        }\n                    }\n                ",depthTest:!1,depthWrite:!1,transparent:!0})}getSeperableBlurMaterial(e){return new THREE.ShaderMaterial({defines:{KERNEL_RADIUS:e,SIGMA:e},uniforms:{colorTexture:{value:null},texSize:{value:new THREE.Vector2(.5,.5)},direction:{value:new THREE.Vector2(.5,.5)}},vertexShader:"varying vec2 vUv;\n                    void main() {\n                        vUv = uv;\n                        gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n                    }",fragmentShader:"#include <common>\n                    varying vec2 vUv;\n                    uniform sampler2D colorTexture;\n                    uniform vec2 texSize;\n                    uniform vec2 direction;\n                    \n                    float gaussianPdf(in float x, in float sigma) {\n                        return 0.39894 * exp( -0.5 * x * x/( sigma * sigma))/sigma;\n                    }\n                    void main() {\n                        vec2 invSize = 1.0 / texSize;\n                        float fSigma = float(SIGMA);\n                        float weightSum = gaussianPdf(0.0, fSigma);\n                        vec3 diffuseSum = texture2D( colorTexture, vUv).rgb * weightSum;\n                        for( int i = 1; i < KERNEL_RADIUS; i ++ ) {\n                            float x = float(i);\n                            float w = gaussianPdf(x, fSigma);\n                            vec2 uvOffset = direction * invSize * x;\n                            vec3 sample1 = texture2D( colorTexture, vUv + uvOffset).rgb;\n                            vec3 sample2 = texture2D( colorTexture, vUv - uvOffset).rgb;\n                            diffuseSum += (sample1 + sample2) * w;\n                            weightSum += 2.0 * w;\n                        }\n                        gl_FragColor = vec4(diffuseSum/weightSum, 1.0);\n                    }"})}createOverlayMaterial(){this.overlayMaterial=new THREE.ShaderMaterial({defines:{NUM_MIPS:5},uniforms:{sceneTexture:{value:null},firstFlg:{value:0},blurTexture0:{value:null},blurTexture1:{value:null},blurTexture2:{value:null},blurTexture3:{value:null},blurTexture4:{value:null},bloomStrength:{value:.5},bloomRadius:{value:1}},vertexShader:"\n                    varying vec2 vUv;\n                    void main() {\n                        vUv = uv;\n                        gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n                    }\n                ",fragmentShader:"\n                    varying vec2 vUv;\n                    uniform float firstFlg;\n                    uniform sampler2D sceneTexture;\n\n                    uniform sampler2D blurTexture0;\n                    uniform sampler2D blurTexture1;\n                    uniform sampler2D blurTexture2;\n                    uniform sampler2D blurTexture3;\n                    uniform sampler2D blurTexture4;\n\n                    uniform float bloomStrength;\n                    uniform float bloomRadius;\n                    const vec3 bloomTintColor = vec3(1.0,1.0,1.0);\n                    \n                    float lerpBloomFactor(const in float factor) { \n                        float mirrorFactor = 1.2 - factor;\n                        return mix(factor, mirrorFactor, bloomRadius);\n                    }\n\n                    #include <postprocess_original_color>\n                    #include <postprocess_mix_minus_color>\n                    #include <postprocess_minus_color>\n                    void main() {\n                        vec4 sceneColor = get_original_color(sceneTexture, vUv, firstFlg);\n\n                        vec4 finalColor = bloomStrength * ( lerpBloomFactor(1.0) * vec4(bloomTintColor, 1.0) * texture2D(blurTexture0, vUv)  \n                        +lerpBloomFactor(0.8) * vec4(bloomTintColor, 1.0) * texture2D(blurTexture1, vUv)  \n                        +lerpBloomFactor(0.6) * vec4(bloomTintColor, 1.0) * texture2D(blurTexture2, vUv) \n                        +lerpBloomFactor(0.4) * vec4(bloomTintColor, 1.0) * texture2D(blurTexture3, vUv) \n                        +lerpBloomFactor(0.2) * vec4(bloomTintColor, 1.0) * texture2D(blurTexture4, vUv));\n                        \n                        if(finalColor.r==0.0 && finalColor.g==0.0 && finalColor.b==0.0){\n                            gl_FragColor = sceneColor;\n                        }else{\n                            vec3 rgb = postprocess_mix_minus_color(sceneColor, finalColor.rgb);\n                            gl_FragColor.rgba = postprocess_minus_color(rgb,vec3(0.0));\n                        }\n                    }\n                "})}}r.GlowPass=e}(),r.SSAOBlurShader={uniforms:{tDiffuse:{value:null},resolution:{value:new THREE.Vector2}},vertexShader:["varying vec2 vUv;","void main() {","   vUv = uv;","   gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform vec2 resolution;","varying vec2 vUv;","void main() {","   vec2 texelSize = ( 1.0 / resolution );","   float result = 0.0;","   for ( int i = - 2; i <= 2; i ++ ) {","       for ( int j = - 2; j <= 2; j ++ ) {","           vec2 offset = ( vec2( float( i ), float( j ) ) ) * texelSize;","           result += texture2D( tDiffuse, vUv + offset ).r;","       }","   }","   gl_FragColor = vec4( vec3( result / ( 5.0 * 5.0 ) ), 1.0 );","}"].join("\n")},r.BackgroundShader={uniforms:{mbTexture:{value:null},abTexture:{value:null},isAdditive:{value:0}},vertexShader:["varying vec2 v_textureCoordinates;","void main() {","   v_textureCoordinates = uv;","   gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:"\n        uniform sampler2D mbTexture;\n        uniform sampler2D abTexture;\n        uniform float isAdditive;\n        varying vec2 v_textureCoordinates;\n\n        void main(void){\n            vec4 abcolor = texture2D( abTexture, v_textureCoordinates );\n            vec4 mbcolor = texture2D( mbTexture, v_textureCoordinates );\n            vec4 color=vec4(0.0);\n            if(isAdditive>0.0){\n                if(abcolor.a==0.0 && abcolor.r!=0.0 && abcolor.g!=0.0 && abcolor.b!=0.0){\n                    color = vec4(abcolor.r,abcolor.g,abcolor.b,1.0);\n                }else{\n                    color = abcolor;\n                }\n            }\n            if(mbcolor.a >0.0){\n                color = vec4(color.r/mbcolor.a+mbcolor.r*mbcolor.a, color.g/mbcolor.a+mbcolor.g*mbcolor.a, color.b/mbcolor.a+mbcolor.b*mbcolor.a, mbcolor.a);\n            }else{\n                if(color.a == 1.0){\n                    color = vec4(color.r, color.g, color.b, 0.0);\n                }\n            }\n            gl_FragColor = color;\n        }\n    "},r.FogShader={uniforms:{tDiffuse:{value:null},depthTexture:{value:null},darkness:{value:0},fogColor:{value:new THREE.Vector3},visualDistance:{value:0},cameraNear:{value:0},cameraFar:{value:0},lightAttenuation:{value:0},firstFlg:{value:0},logDepthBufFC:{value:0}},vertexShader:["varying vec2 v_textureCoordinates;","void main() {","   v_textureCoordinates = uv;","   gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform sampler2D depthTexture;","uniform float firstFlg;","uniform float lightAttenuation;","uniform float darkness;","uniform vec3 fogColor;","uniform float visualDistance;","varying vec2 v_textureCoordinates;","#include <packing>","#include <logdepthbuf_pars_fragment>","#include <depth_parse_fragment>","#include <postprocess_mix_color>","#include <postprocess_original_color>","void main(void){","   vec4 color = get_original_color(tDiffuse, v_textureCoordinates, firstFlg);","   vec4 depthColor = texture2D(depthTexture, v_textureCoordinates);","   float depth = unpackRGBAToDepth(depthColor);","   float viewZ = getViewZ(depth);","   if (depth == 0.0) {depth = 1.0;}","   if(depth>0.0) {","       float param = 1.0- exp(-lightAttenuation*(-viewZ)/(visualDistance ));","       color = mix_color(color, fogColor, param) ;","   }","   gl_FragColor = mix_color(color, vec3(0), darkness); ","}"].join("\n")},r.RainShader={uniforms:{tDiffuse:{value:null},darkness:{value:.5},density:{value:1},frameNumber:{value:0},viewport:{value:new THREE.Vector4(1,1,1,1)},firstFlg:{value:0}},vertexShader:["varying vec2 v_textureCoordinates;","void main() {","   v_textureCoordinates = uv;","   gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform vec4 viewport;","varying vec2 v_textureCoordinates;","uniform sampler2D tDiffuse;","uniform float firstFlg;","uniform float frameNumber;","uniform float darkness;","uniform float density;","float hash(float x) {","    return fract(sin(x * 133.3) * 13.13);","}","vec3 rain(vec2 uv, float d){","   float time = frameNumber / (100.*(1.+0.3*d));","   vec3 c = vec3(.6, .7, .8);","   float a = .05;","   float si = sin(a), co = cos(a);","   uv *= mat2(co, -si, si, co);","   uv *= length(uv + vec2(0, 4.9)) * .3 + 0.5;","   float v = 1.0 - sin(hash(floor(uv.x * 150.)) * 2.);","   float b = clamp(abs(sin(20. * time * v + uv.y * ((10.-d*2.) / (2. + v)))) - .95, 0., 1.) * (8.+d/2.);","   c *= v * b;","   if(d==2.0 && (v<0.3||v>0.7)){","       c=vec3(0.0);","   }","   if(d==1.0 && (v<0.33||v>0.4)){","       c=vec3(0.0);","   }","   return c;","}","#include <postprocess_mix_color>","#include <postprocess_original_color>","void main(void){","   vec4 color = get_original_color(tDiffuse, v_textureCoordinates, firstFlg);","   vec2 resolution = viewport.zw;","   vec2 uv=(gl_FragCoord.xy*2.-resolution.xy)/min(resolution.x,resolution.y);","   vec3 rColor = vec3(0.0);","   if(density>0.0) {","       rColor = rain(uv,density); ","   }","   gl_FragColor = mix_color(color, rColor, darkness); ","}"].join("\n")},THREE.SSAOShader={uniforms:{tDepth:{value:null},tNoise:{value:null},resolution:{value:new THREE.Vector2},cameraNear:{value:1},cameraFar:{value:100},cameraProjection:{value:new THREE.Matrix4},inverseProjection:{value:new THREE.Matrix4},kernelRadius:{value:8},tNormal:{value:null},kernel:{value:null},minDistance:{value:.005},maxDistance:{value:.05},viewport:{value:new THREE.Vector4},logDepthBufFC:{value:0}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["#include <packing>","#include <logdepthbuf_pars_fragment>","#include <depth_parse_fragment>","#define KERNEL_SIZE 32","varying vec2 vUv;","uniform sampler2D tNormal;","uniform sampler2D tDepth;","uniform sampler2D tNoise;","uniform vec2 resolution;","uniform float kernelRadius;","uniform float minDistance;","uniform float maxDistance;","uniform vec3 kernel[ KERNEL_SIZE ];","float getDepth( const in vec2 screenPosition ) {","   vec4 depthColor = texture2D(tDepth, screenPosition);","   return unpackRGBAToDepth(depthColor);","}","vec3 getViewNormal( const in vec2 screenPosition ) {","\treturn unpackRGBToNormal( texture2D( tNormal, screenPosition ).xyz );","}","float getLinearDepth( const in vec2 screenPosition ) {","       float fragCoordZ = getDepth( screenPosition );","       float viewZ = getViewZ( fragCoordZ );","       return viewZToOrthographicDepth( viewZ, cameraNear, cameraFar );","}","void main() {","\tfloat depth = getDepth( vUv );","   if(depth == 0.0) {","       gl_FragColor = vec4( 0.0 );","       return;","   }","   vec3 viewPosition = getViewPosition(depth);","\tvec3 viewNormal = getViewNormal( vUv );","   vec2 noiseScale = vec2( resolution.x/4.0 , resolution.y/4.0 );","   vec3 random = texture2D( tNoise, vUv * noiseScale ).xyz;","   vec3 tangent = normalize( random - viewNormal * dot( random, viewNormal ) );","   vec3 bitangent = cross( viewNormal, tangent );","   mat3 kernelMatrix = mat3( tangent, bitangent, viewNormal );","   float occlusion = 0.0;","   for ( int i = 0; i < KERNEL_SIZE; i ++ ) {","\t\tvec3 sampleVector = (kernelMatrix * kernel[ i ]);","\t\tvec3 samplePoint = viewPosition + ( sampleVector * kernelRadius );","\t\tvec4 samplePointNDC = cameraProjection * vec4( samplePoint, 1.0 );","\t\tsamplePointNDC /= samplePointNDC.w;","\t\tvec2 samplePointUv = samplePointNDC.xy * 0.5 + 0.5;","       float _depth = getDepth( samplePointUv );","       if(_depth == 0.0 )","       {","           continue;","       }","\t\tfloat realDepth = getLinearDepth( samplePointUv );","       float sampleDepth = viewZToOrthographicDepth( samplePoint.z, cameraNear, cameraFar );","\t\tfloat delta = sampleDepth - realDepth;","       float delta2 = realDepth - sampleDepth;","\t\tif (delta > minDistance && delta < maxDistance)","\t\t{","\t\t\tocclusion += 1.0;","\t\t}","       if (delta2 > minDistance && delta2 < 1.0)","       {","           occlusion -= 0.5;","       }","   }","   occlusion = clamp( occlusion / float( KERNEL_SIZE ), 0.0, 1.0 );","   if(occlusion > 0.04)","   {","       occlusion = 0.04 + occlusion/3.0;","   }","   gl_FragColor = vec4( vec3( occlusion ), 1.0 );","}"].join("\n")},r.SeperableBlurShader={defines:{MAX_RADIUS:1},uniforms:{colorTexture:{value:null},texSize:{value:new THREE.Vector2(.5,.5)},direction:{value:new THREE.Vector2(.5,.5)},kernelRadius:{value:1}},vertexShader:"\n            varying vec2 vUv;\n            void main() {\n                vUv = uv;\n                gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n            }\n        ",fragmentShader:"\n            #include <common>\n            varying vec2 vUv;\n            uniform sampler2D colorTexture;\n            uniform vec2 texSize;\n            uniform vec2 direction;\n            uniform float kernelRadius;\n\n            float gaussianPdf(in float x, in float sigma) {\n                return 0.39894 * exp( -0.5 * x * x/( sigma * sigma))/sigma;\n            }\n            void main() {\n                vec4 orginColor = texture2D( colorTexture, vUv);\n                vec2 invSize = 1.0 / texSize;\n                float weightSum = gaussianPdf(0.0, kernelRadius);\n                vec4 diffuseSum = orginColor * weightSum;\n                vec2 delta = direction * invSize * kernelRadius/float(MAX_RADIUS);\n                vec2 uvOffset = delta;\n                for( int i = 1; i <= MAX_RADIUS; i ++ ) {\n                    float w = gaussianPdf(uvOffset.x, kernelRadius);\n                    vec4 sample1 = texture2D( colorTexture, vUv + uvOffset);\n                    vec4 sample2 = texture2D( colorTexture, vUv - uvOffset);\n                    diffuseSum += ((sample1 + sample2) * w);\n                    weightSum += (2.0 * w);\n                    uvOffset += delta;\n                }\n                gl_FragColor = diffuseSum/weightSum;\n            }\n        "},r.FogPass=function(e,t,i,a,n){var s=this;THREE.Pass.call(s),s.renderComposer=e,s.shader=r.FogShader,s.darkness=.1,s.lightAttenuation=.5,s.visualDistance=5e4,s.fogColor=new THREE.Vector3(1,1,1),s.uniforms=THREE.UniformsUtils.clone(s.shader.uniforms),s.material=new THREE.ShaderMaterial({defines:s.shader.defines||{},uniforms:s.uniforms,vertexShader:s.shader.vertexShader,fragmentShader:s.shader.fragmentShader}),s.camera=i,s.scene=t,s.postCamera=new THREE.OrthographicCamera(-1,1,1,-1,0,1),s.postScene=new THREE.Scene,s.quad=new THREE.Mesh(new THREE.PlaneBufferGeometry(2,2),s.material),s.quad.frustumCulled=!1,s.postScene.add(s.quad),s.enabled=!1},r.FogPass.prototype=Object.assign(Object.create(THREE.Pass.prototype),{constructor:r.FogPass,setOpts:function(e){var t=this;e&&(void 0!==e.darkness&&null!==e.darkness&&(t.darkness=e.darkness),void 0!==e.visualDistance&&null!==e.visualDistance&&(t.visualDistance=e.visualDistance),void 0!==e.lightAttenuation&&null!==e.lightAttenuation&&(t.lightAttenuation=e.lightAttenuation),void 0!==e.fogColor&&null!==e.fogColor&&(t.fogColor=new THREE.Vector3(e.fogColor.r,e.fogColor.g,e.fogColor.b)))},getOpts:function(){var e=this;return{darkness:e.darkness,visualDistance:e.visualDistance,lightAttenuation:e.lightAttenuation,fogColor:new THREE.Color(e.fogColor.x,e.fogColor.y,e.fogColor.z)}},render:function(e,t,i,r,a,n){var s=this;null!=s.camera&&null!=s.scene&&(s.uniforms.cameraNear.value=s.camera.near,s.uniforms.cameraFar.value=s.camera.far,s.uniforms.depthTexture.value=s.renderComposer.getDepthTexture(),s.uniforms.logDepthBufFC.value=2/(Math.log(s.camera.far+1)/Math.LN2)),s.uniforms.fogColor.value=s.fogColor,s.uniforms.visualDistance.value=s.visualDistance,s.uniforms.darkness.value=s.darkness,s.uniforms.lightAttenuation.value=s.lightAttenuation,s.uniforms.tDiffuse&&(s.uniforms.tDiffuse.value=i.texture),s.uniforms.firstFlg&&(s.uniforms.firstFlg.value=n?0:1),s.quad.material=s.material;var o=e.getRenderTarget();e.setRenderTarget(t),s.clear&&e.clear(),e.render(s.postScene,s.postCamera),e.setRenderTarget(o)},dispose:function(){},setSize(e,t){}}),r.SkylinePass=function(e,t,i,a,n){var s=this;THREE.Pass.call(s),s.renderComposer=e,s.shader=r.SkylineShader,s.skylineColor=new THREE.Vector3(1,0,0),s.skylineWidth=1,s.uniforms=THREE.UniformsUtils.clone(s.shader.uniforms),s.material=new THREE.ShaderMaterial({defines:s.shader.defines||{},uniforms:s.uniforms,vertexShader:s.shader.vertexShader,fragmentShader:s.shader.fragmentShader}),s.camera=i,s.scene=t,s.postCamera=new THREE.OrthographicCamera(-1,1,1,-1,0,1),s.postScene=new THREE.Scene,s.quad=new THREE.Mesh(new THREE.PlaneBufferGeometry(2,2),s.material),s.quad.frustumCulled=!1,s.postScene.add(s.quad),s.copyMaterial=new THREE.ShaderMaterial({uniforms:THREE.UniformsUtils.clone(THREE.CopyShader.uniforms),vertexShader:THREE.CopyShader.vertexShader,fragmentShader:THREE.CopyShader.fragmentShader,transparent:!0}),s.enabled=!1},r.SkylinePass.prototype=Object.assign(Object.create(THREE.Pass.prototype),{constructor:r.SkylinePass,setOpts:function(e){e&&(void 0!==e.skylineColor&&null!==e.skylineColor&&(this.skylineColor=new THREE.Vector3(e.skylineColor.r,e.skylineColor.g,e.skylineColor.b)),void 0!==e.skylineWidth&&null!==e.skylineWidth&&(this.skylineWidth=e.skylineWidth))},getOpts:function(){var e=this;return{skylineColor:new THREE.Color(e.skylineColor.x,e.skylineColor.y,e.skylineColor.z),skylineWidth:e.skylineWidth}},render:function(e,t,i,r,a,n){var s=this;let o=e.autoClear;e.autoClear=!1,null!=s.camera&&null!=s.scene&&(s.uniforms.cameraNear.value=s.camera.near,s.uniforms.cameraFar.value=s.camera.far,s.uniforms.depthTexture.value=s.renderComposer.getDepthTexture(),s.uniforms.logDepthBufFC.value=2/(Math.log(s.camera.far+1)/Math.LN2)),s.uniforms.skylineColor.value.set(s.skylineColor.x,s.skylineColor.y,s.skylineColor.z),s.uniforms.skylineWidth.value=s.skylineWidth,s.uniforms.viewport.value.set(0,0,e.getContext().drawingBufferWidth,e.getContext().drawingBufferHeight);var l=e.getRenderTarget();e.setRenderTarget(t),s.clear&&e.clear(),s.quad.material=s.material,e.render(s.postScene,s.postCamera),s.copyMaterial.uniforms.tDiffuse.value=i.texture,s.quad.material=s.copyMaterial,e.render(s.postScene,s.postCamera),e.setRenderTarget(l),e.autoClear=o},dispose:function(){},setSize(e,t){}}),r.SkylineShader={uniforms:{depthTexture:{value:null},skylineColor:{value:new THREE.Vector3},skylineWidth:{value:1},cameraNear:{value:0},cameraFar:{value:0},logDepthBufFC:{value:0},viewport:{value:new THREE.Vector4}},vertexShader:["varying vec2 v_textureCoordinates;","void main() {","   v_textureCoordinates = uv;","   gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:[" \n        uniform sampler2D depthTexture;\n        uniform vec3 skylineColor;\n        uniform float cameraNear;\n        uniform float cameraFar;\n        uniform vec4 viewport;\n        uniform float skylineWidth;\n        varying vec2 v_textureCoordinates;\n\n        #include <packing>\n        #include <logdepthbuf_pars_fragment>\n\n        float getDepth(in vec4 depthColor){\n            float result = unpackRGBAToDepth(depthColor);\n            if (result == 0.0) {\n                return 1.0;\n            }\n\n            return result;\n        }\n        bool isSkyline(vec2 uv,float pixelWidth){\n            vec2 pixelSize = pixelWidth / viewport.zw;\n            float dx0 = -pixelSize.x;\n            float dy0 = -pixelSize.y;\n            float dx1 = pixelSize.x;\n            float dy1 = pixelSize.y;\n\n            vec2 currUV = uv + vec2(dx0, dy0);\n            vec4 depthColor = texture2D(depthTexture, currUV);\n            float depth = getDepth(depthColor);\n            if(depth>=1.0)return true;\n\n            currUV = uv + vec2(0.0, dy0);\n            depthColor = texture2D(depthTexture, currUV);\n            depth = getDepth(depthColor);\n            if(depth>=1.0)return true;\n\n            currUV = uv + vec2(dx1, dy0);\n            depthColor = texture2D(depthTexture, currUV);\n            depth = getDepth(depthColor);\n            if(depth>=1.0)return true;\n\n            currUV = uv + vec2(dx0, 0.0);\n            depthColor = texture2D(depthTexture, currUV);\n            depth = getDepth(depthColor);\n            if(depth>=1.0)return true;\n\n            currUV = uv + vec2(dx1, 0.0);\n            depthColor = texture2D(depthTexture, currUV);\n            depth = getDepth(depthColor);\n            if(depth>=1.0)return true;\n\n            currUV = uv + vec2(dx0, dy1);\n            depthColor = texture2D(depthTexture, currUV);\n            depth = getDepth(depthColor);\n            if(depth>=1.0)return true;\n\n            currUV = uv + vec2(0.0, dy1);\n            depthColor = texture2D(depthTexture, currUV);\n            depth = getDepth(depthColor);\n            if(depth>=1.0)return true;\n\n            currUV = uv + vec2(dx1, dy1);\n            depthColor = texture2D(depthTexture, currUV);\n            depth = getDepth(depthColor);\n            if(depth>=1.0)return true;\n\n            return false;\n        }\n\n        void main(void){\n            vec4 depthColor = texture2D(depthTexture, v_textureCoordinates);\n            float depth = getDepth(depthColor);\n            if (depth >= 1.0) {\n                gl_FragColor = vec4(0.0); \n                return;\n            }\n            bool skyline = isSkyline(v_textureCoordinates, skylineWidth);\n            if(skyline){\n                gl_FragColor = vec4(skylineColor, 1.0);\n                return;\n            }\n            gl_FragColor = vec4(0.0);\n            // gl_FragColor = vec4(vec3(depth), 1.0);\n        }\n        "].join("\n")},r.SnowShader={uniforms:{tDiffuse:{value:null},tNormal:{value:null},darkness:{value:.5},density:{value:1},thickness:{value:.5},frameNumber:{value:0},viewport:{value:new THREE.Vector4(1,1,1,1)},cameraNear:{value:1},cameraFar:{value:100},inverseViewRotation:{value:new THREE.Matrix3},firstFlg:{value:0}},vertexShader:["varying vec2 v_textureCoordinates;","void main() {","   v_textureCoordinates = uv;","   gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform float cameraNear;","uniform float cameraFar;","uniform mat3 inverseViewRotation;","uniform vec4 viewport;","uniform float frameNumber;","uniform float darkness;","uniform float density;","uniform sampler2D tDiffuse;","uniform sampler2D tNormal;","uniform float thickness;","varying vec2 v_textureCoordinates;","uniform float firstFlg;","float snow(vec2 uv,float scale){","    float time = frameNumber / 60.0;","    float w=smoothstep(1.,0.,-uv.y*(scale/10.));if(w<.1)return 0.;","    uv+=time/scale;uv.y+=time*2./scale;uv.x+=sin(uv.y+time*.5)/scale;","    uv*=scale;vec2 s=floor(uv),f=fract(uv),p;float k=3.,d;","    p=.5+.35*sin(11.*fract(sin((s+p+scale)*mat2(7,3,6,5))*5.))-f;d=length(p);k=min(d,k);","    k=smoothstep(0.,k,sin(f.x+f.y)*0.01);","    return k*w;","}","#include <packing>","vec3 getViewNormal(in sampler2D tn,const in vec2 screenPosition){","   return unpackRGBToNormal(texture2D(tn,screenPosition).xyz);","}","float getDotNumWC(vec3 nor, mat3 rotation){","    vec3 normalWC = normalize(rotation * nor);","    return dot(vec3(0.0,1.0,0.0),normalWC);","}","#include <postprocess_mix_color>","#include <postprocess_original_color>","void main(void){","   vec4 color = get_original_color(tDiffuse, v_textureCoordinates,firstFlg);","   if(thickness>0.0) {","       vec3 tNor = getViewNormal(tNormal, v_textureCoordinates);","       float dotNumWC = getDotNumWC(tNor, inverseViewRotation);","       if(dotNumWC<0.3){","           dotNumWC=0.3;","       } else if(dotNumWC>1.0){","           dotNumWC=1.0;","       }","       color = mix_color(color, vec3(1.0), dotNumWC*thickness); ","   }","   vec2 resolution = viewport.zw;","   vec2 uv=(gl_FragCoord.xy*2.-resolution.xy)/min(resolution.x,resolution.y);","   vec3 finalColor=vec3(0);","   float c = 0.0;","   if(density>2.0){","       c+=snow(uv,35.);","       c+=snow(uv,20.);","       c+=snow(uv,8.);","   }","   if(density>1.0){","       c+=snow(uv,30.);","       c+=snow(uv,15.);","       c+=snow(uv,6.);","   }","   if(density>0.0){","       c+=snow(uv,25.);","       c+=snow(uv,10.);","       c+=snow(uv,5.);","       finalColor=(vec3(c)); ","   }","   gl_FragColor = mix_color(color, finalColor, darkness); ","}"].join("\n")},r.ScanRingShader={uniforms:{tDiffuse:{value:null},depthTexture:{value:null},color:{value:new THREE.Vector4},radius:{value:0},time:{value:0},cameraNear:{value:1},cameraFar:{value:100},progressive:{value:2},scanCenterEC:{value:new THREE.Vector4},scanPlaneNormalEC:{value:new THREE.Vector3},inverseProjection:{value:new THREE.Matrix4},cameraProjection:{value:new THREE.Matrix4},firstFlg:{value:0},viewport:{value:new THREE.Vector4},logDepthBufFC:{value:0},matrixWorld:{value:new THREE.Vector4},minHeight:{value:0},maxHeight:{value:0}},vertexShader:["varying vec2 v_textureCoordinates;","void main() {","   v_textureCoordinates = uv;","   gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform float firstFlg;","uniform float minHeight;","uniform float maxHeight;","uniform float radius;","uniform float time;","uniform vec4 color;","uniform float progressive;","uniform vec3 scanPlaneNormalEC;","uniform vec4 scanCenterEC;","uniform mat4 matrixWorld;","uniform sampler2D tDiffuse;","uniform sampler2D depthTexture;","varying vec2 v_textureCoordinates;","#include <packing>","#include <logdepthbuf_pars_fragment>","#include <depth_parse_fragment>","vec3 pointProjectOnPlane(in vec3 planeNormal, in vec3 planeOrigin, in vec3 point)","{","   vec3 v01 = point-planeOrigin;","   float d = dot(planeNormal, v01) ;","   return (point - planeNormal * d);","}","#include <postprocess_mix_color>","#include <postprocess_original_color>","void main(void){","   vec4 originalColor = get_original_color(tDiffuse, v_textureCoordinates,firstFlg);","   vec4 depthColor = texture2D(depthTexture, v_textureCoordinates);","   float depth = unpackRGBAToDepth(depthColor);","   vec3 viewPos = getViewPosition(depth);","   if(dot(scanPlaneNormalEC, viewPos)>0.0){","       gl_FragColor = originalColor;","       return;","   }","   vec3 prjOnPlane = pointProjectOnPlane(scanPlaneNormalEC.xyz, scanCenterEC.xyz, viewPos.xyz);","   float dis = length(prjOnPlane.xyz - scanCenterEC.xyz);","   float _radius = time * radius;","   float _time = (1.0-time) * 0.75 + 0.25;","   float f = dis/ _radius;","   f = min(f, 1.0);","   f = max(f, 0.0);","   if(f == 1.0){","       f = 0.0;","   }else{","       f = pow(f, progressive);","       f = max(f, 0.1);","   }","   vec4 wpos = matrixWorld * vec4( viewPos, 1.0 );","   if(minHeight != maxHeight && (wpos.y < minHeight || wpos.y > maxHeight)) {","       gl_FragColor = originalColor;","       return;","   };","   if(depth == 0.0){","       gl_FragColor = originalColor;","   }else{","       gl_FragColor = mix_color(originalColor, color.xyz*pow(f,0.1), f * color.w * _time); ","   }","}"].join("\n")},r.RingScanShader={uniforms:{backGroundColor:{value:new THREE.Vector3},radius:{value:0},time:{value:0},progressive:{value:2},scanCenter:{value:new THREE.Vector4}},vertexShader:"\n        #include <common>\n        #include <uv_pars_vertex>\n        #include <uv2_pars_vertex>\n        #include <envmap_pars_vertex>\n        #include <color_pars_vertex>\n        #include <fog_pars_vertex>\n        #include <morphtarget_pars_vertex>\n        #include <skinning_pars_vertex>\n        #include <logdepthbuf_pars_vertex>\n        #include <clipping_planes_pars_vertex>\n        varying vec2 vCoordinates;\n        void main() {\n            #include <uv_vertex>\n            #include <uv2_vertex>\n            #include <color_vertex>\n            #include <skinbase_vertex>\n            #ifdef USE_ENVMAP\n            #include <beginnormal_vertex>\n            #include <morphnormal_vertex>\n            #include <skinnormal_vertex>\n            #include <defaultnormal_vertex>\n            #endif\n            vCoordinates = vec2(position.x, position.y);\n            #include <begin_vertex>\n            #include <morphtarget_vertex>\n            #include <skinning_vertex>\n            #include <project_vertex>\n            #include <logdepthbuf_vertex>\n            #include <worldpos_vertex>\n            #include <clipping_planes_vertex>\n            #include <envmap_vertex>\n            #include <fog_vertex>\n        }\n    ",fragmentShader:"\n        uniform vec3 backGroundColor;\n        uniform float radius;\n        uniform float progressive;\n        uniform float time;\n        uniform vec4 scanCenter;\n\n        varying vec2 vCoordinates;\n\n        uniform vec3 diffuse;\n        uniform float opacity;\n        \n        #ifndef FLAT_SHADED\n            varying vec3 vNormal;\n        #endif\n        #include <common>\n        #include <color_pars_fragment>\n        #include <uv_pars_fragment>\n        #include <uv2_pars_fragment>\n        #include <map_pars_fragment>\n        #include <alphamap_pars_fragment>\n        #include <aomap_pars_fragment>\n        #include <lightmap_pars_fragment>\n        #include <envmap_pars_fragment>\n        #include <fog_pars_fragment>\n        #include <specularmap_pars_fragment>\n        #include <logdepthbuf_pars_fragment>\n        #include <clipping_planes_pars_fragment>\n        void main() {\n            #include <clipping_planes_fragment>\n            #include <logdepthbuf_fragment>\n\n            float dis = length(vCoordinates.xy - scanCenter.xy);\n\n            float _radius = time * radius;\n            float _time = (1.0-time) * 0.75 + 0.25;\n            float f = dis/ _radius;\n            if(f > 1.0 || f < 0.0){\n                discard;\n            }\n            f = pow(f, progressive);\n            f = max(f, 0.1);\n            gl_FragColor = vec4(backGroundColor*pow(f,0.1), f * opacity * _time);\n\n            #include <premultiplied_alpha_fragment>\n            #include <tonemapping_fragment>\n            #include <encodings_fragment>\n            #include <fog_fragment>\n        }\n    "},r.FanScanPassShader={uniforms:{tDiffuse:{value:null},depthTexture:{value:null},cameraNear:{value:1},cameraFar:{value:100},scanCenter:{value:new THREE.Vector4},scanPlaneNormalEC:{value:new THREE.Vector3},inverseProjection:{value:new THREE.Matrix4},cameraProjection:{value:new THREE.Matrix4},viewport:{value:new THREE.Vector4},logDepthBufFC:{value:0},matrixWorld:{value:new THREE.Vector4},radius:{value:0},fanAngle:{value:0},time:{value:0},backgroundColor:{value:new THREE.Vector3(1,1,1)},backgroundOpacity:{value:0},color:{value:new THREE.Vector3(1,1,1)},opacity:{value:0}},vertexShader:["varying vec2 v_textureCoordinates;","varying vec2 vCoordinates;","void main() {","   v_textureCoordinates = uv;","   vCoordinates = vec2(position.x, position.y);","   gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform float fanAngle;","uniform float time;","uniform vec3 backgroundColor;","uniform float backgroundOpacity;","uniform float radius;","uniform vec3 color;","uniform float opacity;","uniform vec3 scanPlaneNormalEC;","uniform vec4 scanCenter;","uniform mat4 matrixWorld;","uniform sampler2D tDiffuse;","uniform sampler2D depthTexture;","varying vec2 v_textureCoordinates;","varying vec2 vCoordinates;","#include <packing>","#include <logdepthbuf_pars_fragment>","#include <depth_parse_fragment>","vec3 pointProjectOnPlane(in vec3 planeNormal, in vec3 planeOrigin, in vec3 point)","{","   vec3 v01 = point-planeOrigin;","   float d = dot(planeNormal, v01) ;","   return (point - planeNormal * d);","}","#include <postprocess_mix_color>","#include <postprocess_original_color>","void main(void){","   vec4 originalColor = get_original_color(tDiffuse, v_textureCoordinates,1.0);","   vec4 depthColor = texture2D(depthTexture, v_textureCoordinates);","   float depth = unpackRGBAToDepth(depthColor);","   vec3 viewPos = getViewPosition(depth);","   vec4 wPosCenter = scanCenter;","   vec4 wPos = matrixWorld * vec4( viewPos, 1.0 );","   vec3 dis = wPos.xyz - wPosCenter.xyz;","   float disLen = length(dis.xz);","   if(dis.z==0.0 && dis.x==0.0){","       discard;","   }","   if(disLen > radius){","       gl_FragColor = originalColor;","       return;","   }","   float scanAngle = 0.0;","   float PI = 3.141592653589793;","   float fanOpacity = backgroundOpacity;","   float _angle = atan(dis.z, dis.x);","   if(dis.z < 0.0){","       _angle = _angle + PI*2.0;","   }","   _angle = _angle/(PI*2.0);","   if( (_angle>=time &&_angle <= (fanAngle+time)) ||","       ((fanAngle+time)>1.0 && _angle<=fract(fanAngle+time))){","       if(_angle-time<0.0) {","           scanAngle = _angle+(1.0-time);","       }else{","           scanAngle = _angle-time;","       }","       scanAngle = pow(scanAngle/fanAngle,2.0);","       fanOpacity = fanOpacity + (1.0 - fanOpacity) * scanAngle * opacity;","   }","   if(depth == 0.0){","       gl_FragColor = originalColor;","   }else{","\t\tgl_FragColor = vec4(mix_color(originalColor,mix(backgroundColor, color, scanAngle), fanOpacity));","   }","}"].join("\n")},r.SnowPass=function(e,t,i,a){var n=this;THREE.Pass.call(n),n.viewer=t,n.shader=r.SnowShader,n.density=2,n.thickness=.8,n.darkness=.5,n.renderComposer=e,n.uniforms=THREE.UniformsUtils.clone(n.shader.uniforms),n.material=new THREE.ShaderMaterial({defines:n.shader.defines||{},uniforms:n.uniforms,vertexShader:n.shader.vertexShader,fragmentShader:n.shader.fragmentShader}),n._frameState=new r.FrameState,n._frameState.camera=n.viewer.camera,n._frameState.scene=n.viewer.getScene(),n.postCamera=new THREE.OrthographicCamera(-1,1,1,-1,0,1),n.postScene=new THREE.Scene,n.quad=new THREE.Mesh(new THREE.PlaneBufferGeometry(2,2),n.material),n.quad.frustumCulled=!1,n.postScene.add(n.quad),n.enabled=!1},r.SnowPass.prototype=Object.assign(Object.create(THREE.Pass.prototype),{constructor:r.SnowPass,setOpts:function(e){var t=this;e&&(void 0!==e.darkness&&null!==e.darkness&&(t.darkness=e.darkness),void 0!==e.thickness&&null!==e.thickness&&(t.thickness=e.thickness),void 0!==e.density&&null!==e.density&&(t.density=e.density))},getOpts:function(){var e=this;return{darkness:e.darkness,thickness:e.thickness,density:e.density}},render:function(e,t,i,a,n,s){var o=this;null!=o._frameState.camera&&(o.uniforms.inverseViewRotation.value=r.Math.getMatrix3(o._frameState.camera.matrixWorld),o.uniforms.cameraNear.value=o._frameState.camera.near,o.uniforms.cameraFar.value=o._frameState.camera.far),o._frameState.frameNumber=r.Math.incrementWrap(o._frameState.frameNumber,15e6,1),o.uniforms.frameNumber.value=o._frameState.frameNumber,o.uniforms.density.value=o.density,o.uniforms.thickness.value=o.thickness,o.uniforms.darkness.value=o.darkness,o.uniforms.viewport&&null!=i&&(o.uniforms.viewport.value=new THREE.Vector4(i.viewport.x,i.viewport.y,i.viewport.z,i.viewport.w)),o.uniforms.firstFlg&&(o.uniforms.firstFlg.value=s?0:1),o.uniforms.tDiffuse&&(o.uniforms.tDiffuse.value=i.texture),o.uniforms.tNormal&&(o.uniforms.tNormal.value=o.renderComposer.getNormalTexture()),o.quad.material=o.material;var l=e.getRenderTarget();e.setRenderTarget(t),o.clear&&e.clear(),e.render(o.postScene,o.postCamera),e.setRenderTarget(l)},dispose:function(){this._frameState=this._frameState.destroy()},setSize(e,t){}}),r.RainPass=class{constructor(e,t,i,a){var n=this;THREE.Pass.call(n),n.viewer=t,n.shader=r.RainShader,n.density=2,n.darkness=.5,n.renderComposer=e,n.uniforms=THREE.UniformsUtils.clone(n.shader.uniforms),n.camera=n.viewer.camera,n.scene=n.viewer.getScene(),n.modelManager=n.viewer.modelManager,n.material=new THREE.ShaderMaterial({defines:n.shader.defines||{},uniforms:n.uniforms,vertexShader:n.shader.vertexShader,fragmentShader:n.replaceDepthToViewZ(n.shader.fragmentShader,n.camera)}),n._frameState=new r.FrameState,n._frameState.camera=n.viewer.camera,n._frameState.scene=n.viewer.getScene(),n._frameState.frameNumber=Math.floor(1e3*Math.random()),n.postCamera=new THREE.OrthographicCamera(-1,1,1,-1,0,1),n.postScene=new THREE.Scene,n.quad=new THREE.Mesh(new THREE.PlaneBufferGeometry(2,2),n.material),n.quad.frustumCulled=!1,n.postScene.add(n.quad)}replaceDepthToViewZ(e,t){var i=t.isPerspective?"perspective":"orthographic";return e.replace(/DEPTH_TO_VIEW_Z/g,i+"DepthToViewZ")}setOpts(e){e&&(void 0!==e.darkness&&null!==e.darkness&&(this.darkness=e.darkness),void 0!==e.density&&null!==e.density&&(this.density=e.density))}getOpts(){return{darkness:this.darkness,density:this.density}}render(e,t,i,a,n,s){var o=this;o._frameState.frameNumber=r.Math.incrementWrap(o._frameState.frameNumber,15e6,1),o.uniforms.frameNumber.value=o._frameState.frameNumber,o.uniforms.density.value=o.density,o.uniforms.darkness.value=o.darkness,o.uniforms.viewport&&null!=i&&(o.uniforms.viewport.value=new THREE.Vector4(i.viewport.x,i.viewport.y,i.viewport.z,i.viewport.w)),o.uniforms.firstFlg&&(o.uniforms.firstFlg.value=s?0:1),o.uniforms.tDiffuse&&(o.uniforms.tDiffuse.value=i.texture),o.quad.material=o.material;var l=e.getRenderTarget();e.setRenderTarget(t),o.clear&&e.clear(),e.render(o.postScene,o.postCamera),e.setRenderTarget(l)}dispose(){}setSize(e,t){}},function(){class e extends THREE.Pass{constructor(e,t,i,a,n){super(),this.modelManager=t,this.renderScene=i,this.renderCamera=a,this.selectedObjectIds=void 0!==n?n:[],this.defaultEdgeColor=(new THREE.Color).setHex(7733223),this.defaultEdgeAlpha=.95,this.edgeColor=new THREE.Vector4(this.defaultEdgeColor.r,this.defaultEdgeColor.g,this.defaultEdgeColor.b,this.defaultEdgeAlpha),this.edgeLength=2,this.resolution=void 0!==e?new THREE.Vector2(e.x,e.y):new THREE.Vector2(256,256);var s={minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat};this.renderTargetDepthBuffer=new THREE.WebGLRenderTarget(this.resolution.x,this.resolution.y,s),this.renderTargetDepthBuffer.texture.name="OutlinePass.depth",this.renderTargetDepthBuffer.texture.generateMipmaps=!1,this.renderTargetMaskBuffer=new THREE.WebGLRenderTarget(this.resolution.x,this.resolution.y,s),this.renderTargetMaskBuffer.texture.name="OutlinePass.mask",this.renderTargetMaskBuffer.texture.generateMipmaps=!1,this.renderTargetMaskDownSampleBuffer=new THREE.WebGLRenderTarget(this.resolution.x,this.resolution.y,s),this.renderTargetMaskDownSampleBuffer.texture.name="OutlinePass.depthDownSample",this.renderTargetMaskDownSampleBuffer.texture.generateMipmaps=!1,this.renderTargetEdgeBuffer=new THREE.WebGLRenderTarget(this.resolution.x,this.resolution.y,s),this.renderTargetEdgeBuffer.texture.name="OutlinePass.edge",this.renderTargetEdgeBuffer.texture.generateMipmaps=!1,this.renderTargetColorBuffer=new THREE.WebGLRenderTarget(this.resolution.x,this.resolution.y,s),this.renderTargetColorBuffer.texture.name="OutlinePass.color",this.renderTargetColorBuffer.texture.generateMipmaps=!1,this.depthMaterial=new THREE.MeshDepthMaterial,this.depthMaterial.side=THREE.DoubleSide,this.depthMaterial.depthPacking=THREE.RGBADepthPacking,this.depthMaterial.blending=THREE.NoBlending,this.InstancedDepthMaterial=new r.InstancedDepthMaterial,this.InstancedDepthMaterial.side=THREE.DoubleSide,this.InstancedDepthMaterial.depthPacking=THREE.RGBADepthPacking,this.InstancedDepthMaterial.blending=THREE.NoBlending,this.prepareMaskMaterial=this.getPrepareMaskMaterial(),this.prepareMaskMaterial.side=THREE.DoubleSide,this.prepareMaskInstancedMaterial=this.getPrepareMaskInstancedMaterial(),this.prepareMaskInstancedMaterial.side=THREE.DoubleSide,this.edgeDetectionMaterial=this.getEdgeDetectionMaterial(),this.overlayMaterial=this.getOverlayMaterial(),void 0===THREE.CopyShader&&console.error("CLOUD.OutlinePass relies on THREE.CopyShader");var o=THREE.CopyShader;this.copyUniforms=THREE.UniformsUtils.clone(o.uniforms),this.copyUniforms.opacity.value=1,this.materialCopy=new THREE.ShaderMaterial({uniforms:this.copyUniforms,vertexShader:o.vertexShader,fragmentShader:o.fragmentShader,blending:THREE.NoBlending,depthTest:!1,depthWrite:!1,transparent:!0}),this.enabled=!0,this.needsSwap=!1,this.oldClearColor=new THREE.Color,this.oldClearAlpha=1,this.camera=new THREE.OrthographicCamera(-1,1,1,-1,0,1),this.scene=new THREE.Scene,this.quad=new THREE.Mesh(new THREE.PlaneBufferGeometry(2,2),null),this.quad.frustumCulled=!1,this.scene.add(this.quad),this.textureMatrix=new THREE.Matrix4}dispose(){this.renderTargetDepthBuffer.dispose(),this.renderTargetMaskBuffer.dispose(),this.renderTargetMaskDownSampleBuffer.dispose(),this.renderTargetEdgeBuffer.dispose(),this.renderTargetColorBuffer.dispose()}setSize(e,t){this.renderTargetDepthBuffer.setSize(e,t),this.renderTargetMaskBuffer.setSize(e,t),this.renderTargetMaskDownSampleBuffer.setSize(e,t),this.renderTargetEdgeBuffer.setSize(e,t),this.renderTargetColorBuffer.setSize(e,t)}adjustVisibility(e){this.modelManager.adjustVisibility(e)}changeVisibilityOfSelectedObjects(e){this.modelManager.changeVisibilityOfSelectedObjects(e)}changeVisibilityOfNonSelectedObjects(e){this.modelManager.changeVisibilityOfNonSelectedObjects(e)}adjustInstanceVisibility(e){this.modelManager.adjustInstanceVisibility(e)}changeInstanceVisibilityOfSelectedObjects(e){this.modelManager.changeInstanceVisibilityOfSelectedObjects(e)}changeInstanceVisibilityOfNonSelectedObjects(e){this.modelManager.changeInstanceVisibilityOfNonSelectedObjects(e)}restoreVisibilityOfObjects(){this.modelManager.restoreVisibilityOfObjects()}updateTextureMatrix(){this.textureMatrix.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),this.textureMatrix.multiply(this.renderCamera.projectionMatrix),this.textureMatrix.multiply(this.renderCamera.matrixWorldInverse)}render(e,t,i,r,a){if(0!==this.selectedObjectIds.length){e.getClearColor(this.oldClearColor),this.oldClearAlpha=e.getClearAlpha();var n=e.autoClear;e.autoClear=!1,a&&e.context.disable(e.context.STENCIL_TEST),e.setClearColor(0,0),this.adjustInstanceVisibility(!1),this.changeVisibilityOfSelectedObjects(!1),this.renderScene.overrideMaterial=this.depthMaterial,e.render(this.renderScene,this.renderCamera,this.renderTargetDepthBuffer,!0),this.adjustInstanceVisibility(!0),this.changeVisibilityOfSelectedObjects(!0),this.adjustVisibility(!1),this.changeInstanceVisibilityOfSelectedObjects(!1),this.renderScene.overrideMaterial=this.InstancedDepthMaterial,e.render(this.renderScene,this.renderCamera,this.renderTargetDepthBuffer,!1),this.adjustVisibility(!0),this.changeInstanceVisibilityOfSelectedObjects(!0),this.updateTextureMatrix(),this.adjustInstanceVisibility(!1),this.changeVisibilityOfNonSelectedObjects(!1),this.renderScene.overrideMaterial=this.prepareMaskMaterial,this.prepareMaskMaterial.uniforms.cameraNearFar.value=new THREE.Vector2(this.renderCamera.near,this.renderCamera.far),this.prepareMaskMaterial.uniforms.depthTexture.value=this.renderTargetDepthBuffer.texture,this.prepareMaskMaterial.uniforms.textureMatrix.value=this.textureMatrix,e.render(this.renderScene,this.renderCamera,this.renderTargetMaskBuffer,!0),this.adjustInstanceVisibility(!0),this.changeVisibilityOfNonSelectedObjects(!0),this.adjustVisibility(!1),this.changeInstanceVisibilityOfNonSelectedObjects(!1),this.renderScene.overrideMaterial=this.prepareMaskInstancedMaterial,this.prepareMaskInstancedMaterial.uniforms.cameraNearFar.value=new THREE.Vector2(this.renderCamera.near,this.renderCamera.far),this.prepareMaskInstancedMaterial.uniforms.depthTexture.value=this.renderTargetDepthBuffer.texture,this.prepareMaskInstancedMaterial.uniforms.textureMatrix.value=this.textureMatrix,e.render(this.renderScene,this.renderCamera,this.renderTargetMaskBuffer,!1),this.renderScene.overrideMaterial=null,this.adjustVisibility(!0),this.changeInstanceVisibilityOfNonSelectedObjects(!0),this.restoreVisibilityOfObjects(),this.quad.material=this.materialCopy,this.copyUniforms.tDiffuse.value=this.renderTargetMaskBuffer.texture,e.render(this.scene,this.camera,this.renderTargetMaskDownSampleBuffer,!0),this.quad.material=this.edgeDetectionMaterial,this.edgeDetectionMaterial.uniforms.maskTexture.value=this.renderTargetMaskDownSampleBuffer.texture,this.edgeDetectionMaterial.uniforms.texSize.value=new THREE.Vector2(this.renderTargetMaskDownSampleBuffer.width,this.renderTargetMaskDownSampleBuffer.height),this.edgeDetectionMaterial.uniforms.edgeColor.value=this.edgeColor,this.edgeDetectionMaterial.uniforms.edgeLength.value=this.edgeLength,e.render(this.scene,this.camera,this.renderTargetEdgeBuffer,!0),this.quad.material=this.overlayMaterial,this.overlayMaterial.uniforms.colorTexture.value=i.texture,this.overlayMaterial.uniforms.outlineTexture.value=this.renderTargetEdgeBuffer.texture,e.render(this.scene,this.camera,this.renderTargetColorBuffer,!0),this.quad.material=this.materialCopy,this.copyUniforms.tDiffuse.value=this.renderTargetColorBuffer.texture,a&&e.context.enable(e.context.STENCIL_TEST),e.render(this.scene,this.camera,i,!0),e.setClearColor(this.oldClearColor,this.oldClearAlpha),e.autoClear=n}}getPrepareMaskMaterial(){return new THREE.ShaderMaterial({uniforms:{depthTexture:{value:null},cameraNearFar:{value:new THREE.Vector2(.5,.5)},textureMatrix:{value:new THREE.Matrix4}},vertexShader:"varying vec2 vUv;\n\t\t\t\tvarying vec4 projTexCoord;\n\t\t\t\tvarying vec4 vPosition;\n\t\t\t\tuniform mat4 textureMatrix;\n\t\t\t\tvoid main() {\n\t\t\t\t\tvUv = uv;\n\t\t\t\t\tvPosition = modelViewMatrix * vec4( position, 1.0 );\n\t\t\t\t\tvec4 worldPosition = modelMatrix * vec4( position, 1.0 );\n\t\t\t\t\tprojTexCoord = textureMatrix * worldPosition;\n\t\t\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\t\t\t\t}",fragmentShader:"\n                #include <packing>\n\t\t\t\tvarying vec2 vUv;\n\t\t\t\tvarying vec4 vPosition;\n\t\t\t\tvarying vec4 projTexCoord;\n\t\t\t\tuniform sampler2D depthTexture;\n\t\t\t\tuniform vec2 cameraNearFar;\n\t\t\t\t\n\t\t\t\tfloat linearDepth(float depth)\n                {\n                    float far = cameraNearFar.y;\n                    float near = cameraNearFar.x;\n                    return (2.0 * near) / (far + near - depth * (far - near));\n                }\n\t\t\t\t\n\t\t\t\tvoid main() {\n\t\t\t\t\tfloat depth = unpackRGBAToDepth(texture2DProj( depthTexture, projTexCoord ));\t\t\t\t\t\n\t\t\t\t\tgl_FragColor = vec4(depth);\n\t\t\t\t}"})}getPrepareMaskInstancedMaterial(){return new THREE.ShaderMaterial({uniforms:{depthTexture:{value:null},cameraNearFar:{value:new THREE.Vector2(.5,.5)},textureMatrix:{value:new THREE.Matrix4}},vertexShader:"\n                attribute float vState;            \n                attribute vec4 aColor;            \n                attribute vec3 mcol0;\n                attribute vec3 mcol1;\n                attribute vec3 mcol2;\n                attribute vec3 mcol3;\n                #if defined(USE_MAP)\n                    attribute vec2 muvCol0;\n                    attribute vec2 muvCol1;\n                    attribute vec2 muvCol2;\n                #endif\n                \n                varying float vfState;\n                varying vec2 vUv;\n\t\t\t\tvarying vec4 projTexCoord;\n\t\t\t\tvarying vec4 vPosition;\n\t\t\t\tuniform mat4 textureMatrix;\n\t\t\t\t\n\t\t\t\tvec3 getInstancePosition(vec3 position) {\n                    return vec3(mat4(vec4(mcol0, 0.0),\n                                     vec4(mcol1, 0.0),\n                                     vec4(mcol2, 0.0),\n                                     vec4(mcol3, 1.0)) * vec4(position, 1.0));\n                }\n                \n                vec2 getInstanceUV(vec2 uv) {\n                \n                    #if defined(USE_MAP)\n                        return vec2(mat3(vec3(muvCol0, 0.0),\n                                         vec3(muvCol1, 0.0), \n                                         vec3(muvCol2, 1.0)) * vec3(uv, 1.0));\n                    #else\n                        return uv;\n                    #endif                    \n                    \n                }\n            \n\t\t\t\tvoid main() {\n\t\t\t\t    vfState = vState;\n\t\t\t\t\tvUv = uv;\n\t\t\t\t\tvPosition = vec4(getInstancePosition(position), 1.0);\n\t\t\t\t\tvec4 worldPosition = modelMatrix * vPosition;\n\t\t\t\t\tprojTexCoord = textureMatrix * worldPosition;\n\t\t\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vPosition;\n\t\t\t\t}",fragmentShader:"#include <packing>\n                varying float vfState;\n                varying vec2 vUv;\n                varying vec4 vPosition;\n                varying vec4 projTexCoord;\n                uniform sampler2D depthTexture;\n                uniform vec2 cameraNearFar;\n                \n                float linearDepth(float depth)\n                {\n                    float far = cameraNearFar.y;\n                    float near = cameraNearFar.x;\n                    return (2.0 * near) / (far + near - depth * (far - near));\n                }\n                \n                void main() {\n                    if (vfState <= -0.99 && vfState >= -1.01) discard;\n                    float depth = unpackRGBAToDepth(texture2DProj( depthTexture, projTexCoord ));\n                    gl_FragColor = vec4(depth);\n                }"})}getEdgeDetectionMaterial(){return new THREE.ShaderMaterial({uniforms:{maskTexture:{value:null},texSize:{value:new THREE.Vector2(.5,.5)},edgeColor:{value:new THREE.Vector4(1,1,1,1)},edgeLength:{value:2}},vertexShader:"\n                varying vec2 vUv;\n\t\t\t\tvoid main() {\n\t\t\t\t\tvUv = uv;\n\t\t\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\t\t\t\t}",fragmentShader:"\n                varying vec2 vUv;\n\t\t\t\tuniform sampler2D maskTexture;\n\t\t\t\tuniform vec2 texSize;\n\t\t\t\tuniform vec4 edgeColor;\n                uniform float edgeLength; \n                \n                void main(void)\n                {\n                    float directions[3];\n                    directions[0] = -1.0;\n                    directions[1] = 0.0;\n                    directions[2] = 1.0;\n                \n                    float scalars[3];\n                    scalars[0] = 3.0;\n                    scalars[1] = 10.0;\n                    scalars[2] = 3.0;\n                \n                    float padx = 1.0 / texSize.x;\n                    float pady = 1.0 / texSize.y ; \n                \n                    float edgeSize  = 0.0; \n                    float horizEdge = 0.0;\n                    float vertEdge = 0.0;                    \n                \n                    for (int i = 0; i < 3; ++i)\n                    {\n                        float dir = directions[i];\n                        float scale = scalars[i];\n                \n                        horizEdge -= texture2D(maskTexture, vUv + vec2(-padx, dir * pady)).x * scale;\n                        horizEdge += texture2D(maskTexture, vUv + vec2(padx, dir * pady)).x * scale;\n                \n                        vertEdge -= texture2D(maskTexture, vUv + vec2(dir * padx, -pady)).x * scale;\n                        vertEdge += texture2D(maskTexture, vUv + vec2(dir * padx, pady)).x * scale;\n                    }                    \n                  \n                    float len = sqrt(horizEdge * horizEdge + vertEdge * vertEdge);    \n                    float alpha = len > edgeLength ? edgeColor.a : (texture2D(maskTexture, vUv).w > 0.1 ? 0.1 : 0.0);\n                    gl_FragColor = vec4(edgeColor.rgb, alpha);\n                }"})}getOverlayMaterial(){return new THREE.ShaderMaterial({uniforms:{colorTexture:{value:null},outlineTexture:{value:null}},vertexShader:"varying vec2 vUv;\n\t\t\t\tvoid main() {\n\t\t\t\t\tvUv = uv;\n\t\t\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\t\t\t\t}",fragmentShader:"varying vec2 vUv;\n\t\t\t\tuniform sampler2D colorTexture;\n\t\t\t\tuniform sampler2D outlineTexture;\n\t\t\t\t\n\t\t\t\tvoid main() {\n\t\t\t\t\tvec4 outlineColor = texture2D(outlineTexture, vUv);\t\t\t\t\t\n                    gl_FragColor = mix(texture2D(colorTexture, vUv), outlineColor, outlineColor.a);\n\t\t\t\t}",blending:THREE.AdditiveBlending,depthTest:!1,depthWrite:!1,transparent:!0})}setOutlineEdgeColor(e){var t=r.Utils.hexToRgb(e.color);this.edgeColor.fromArray([t.r,t.g,t.b,e.opacity?e.opacity:1])}}r.OutlinePass=e}(),function(){class e{constructor(e){this.modelManager=e,this.depthMaterial=new THREE.MeshDepthMaterial,this.depthMaterial.side=THREE.DoubleSide,this.depthMaterial.depthPacking=THREE.RGBADepthPacking,this.depthMaterial.blending=THREE.NoBlending,this.instancedDepthMaterial=new r.InstancedDepthMaterial,this.instancedDepthMaterial.side=THREE.DoubleSide,this.instancedDepthMaterial.depthPacking=THREE.RGBADepthPacking,this.instancedDepthMaterial.blending=THREE.NoBlending,this.customDepthMaterial=new r.CustomMeshDepthMaterial,this.customDepthMaterial.side=THREE.DoubleSide,this.customDepthMaterial.depthPacking=THREE.RGBADepthPacking,this.customDepthMaterial.blending=THREE.NoBlending,this.customInstancedDepthMaterial=new r.CustomInstancedMeshDepthMaterial,this.customInstancedDepthMaterial.side=THREE.DoubleSide,this.customInstancedDepthMaterial.depthPacking=THREE.RGBADepthPacking,this.customInstancedDepthMaterial.blending=THREE.NoBlending}destroy(){this.modelManager=null,this.depthMaterial.dispose(),this.depthMaterial=null,this.instancedDepthMaterial.dispose(),this.instancedDepthMaterial=null,this.customDepthMaterial.dispose(),this.customDepthMaterial=null,this.customInstancedDepthMaterial.dispose(),this.customInstancedDepthMaterial=null}adjustVisibility(e){this.modelManager.adjustVisibility(e)}adjustInstanceVisibility(e){this.modelManager.adjustInstanceVisibility(e)}adjustDemVisibility(e){this.modelManager.adjustDemVisibility(e)}changeVisibilityOfSelectedObjects(e){this.modelManager.changeVisibilityOfSelectedObjects(e)}changeInstanceVisibilityOfSelectedObjects(e){this.modelManager.changeInstanceVisibilityOfSelectedObjects(e)}renderDepth(e,t,i,r){var a=e.getRenderTarget(),n=t.overrideMaterial,s=e.autoClear;e.autoClear=!1,this.adjustInstanceVisibility(!1),this.changeVisibilityOfSelectedObjects(!1),t.overrideMaterial=this.depthMaterial,e.setRenderTarget(r),e.clear(),e.render(t,i),this.adjustInstanceVisibility(!0),this.changeVisibilityOfSelectedObjects(!0),this.adjustVisibility(!1),this.changeInstanceVisibilityOfSelectedObjects(!1),t.overrideMaterial=this.instancedDepthMaterial,e.render(t,i),t.overrideMaterial=n,e.setRenderTarget(a),e.autoClear=s,this.adjustVisibility(!0),this.changeInstanceVisibilityOfSelectedObjects(!0)}renderCustomDepth(t,i,a,n,s){var o=!!r.Utils.isDefined(s)&&s,l=t.getRenderTarget(),d=i.overrideMaterial,h=t.autoClear;t.autoClear=!1;const c=e.hideInVisibleGroup(i);this.adjustInstanceVisibility(!1),this.changeVisibilityOfSelectedObjects(!1),i.overrideMaterial=this.customDepthMaterial,this.customDepthMaterial.uniforms.forceLogDepth.value=o,this.customDepthMaterial.uniforms.forceCustomDepth.value=!1,this.customDepthMaterial.uniforms.forceLogDepthBufFC.value=2/(Math.log(a.far+1)/Math.LN2),t.setRenderTarget(n),t.clear(),t.render(i,a),this.adjustInstanceVisibility(!0),this.changeVisibilityOfSelectedObjects(!0),this.adjustVisibility(!1),this.changeInstanceVisibilityOfSelectedObjects(!1),i.overrideMaterial=this.customInstancedDepthMaterial,this.customInstancedDepthMaterial.uniforms.forceLogDepth.value=o,this.customInstancedDepthMaterial.uniforms.forceCustomDepth.value=!1,this.customInstancedDepthMaterial.uniforms.forceLogDepthBufFC.value=2/(Math.log(a.far+1)/Math.LN2),t.render(i,a),i.overrideMaterial=d,t.setRenderTarget(l),t.autoClear=h,this.adjustVisibility(!0),this.changeInstanceVisibilityOfSelectedObjects(!0),e.restoreInVisibleGroup(i,c)}renderCustomDepthByOpacity(e,t,i,a,n,s){let o={},l={};r.RenderEffectComposer.setTransparentObjectVisible(t,i,n,!1,o,l),this.customInstancedDepthMaterial.uniforms.discardAlpha.value=n,this.renderCustomDepth(e,t,i,a,s),r.RenderEffectComposer.setTransparentObjectVisible(t,i,n,!0,o,l),this.customInstancedDepthMaterial.uniforms.discardAlpha.value=0}renderCustomDepthWithoutDEM(t,i,a,n){var s=t.getRenderTarget(),o=i.overrideMaterial,l=t.autoClear;t.autoClear=!1;var d=!1,h=i.getObjectGroup(r.GlobalData.TilePlaneGroupName);h&&(d=h.visible),this.adjustDemVisibility(!1);const c=e.hideInVisibleGroup(i);this.adjustVisibility(!1),this.adjustInstanceVisibility(!1),this.changeVisibilityOfSelectedObjects(!1),this.changeInstanceVisibilityOfSelectedObjects(!1),i.overrideMaterial=this.customDepthMaterial,this.customDepthMaterial.uniforms.forceLogDepth.value=!1,this.customDepthMaterial.uniforms.forceCustomDepth.value=!0,this.customDepthMaterial.uniforms.customDepth.value=1,t.setRenderTarget(n),t.clear(),t.render(i,a);var u=!1,p=i.getObjectGroup(r.ObjectGroupType.EXTERNALCOMPONENTMANAGER);p&&(u=p.visible,p.visible=!1),this.adjustVisibility(!0),this.adjustInstanceVisibility(!1),this.changeVisibilityOfSelectedObjects(!1),i.overrideMaterial=this.customDepthMaterial,this.customDepthMaterial.uniforms.forceLogDepth.value=!1,this.customDepthMaterial.uniforms.forceCustomDepth.value=!0,this.customDepthMaterial.uniforms.customDepth.value=.5,t.render(i,a),this.adjustInstanceVisibility(!0),this.changeVisibilityOfSelectedObjects(!0),this.adjustVisibility(!1),this.changeInstanceVisibilityOfSelectedObjects(!1),i.overrideMaterial=this.customInstancedDepthMaterial,this.customInstancedDepthMaterial.uniforms.forceLogDepth.value=!1,this.customInstancedDepthMaterial.uniforms.forceCustomDepth.value=!0,this.customInstancedDepthMaterial.uniforms.customDepth.value=.5,t.render(i,a),i.overrideMaterial=o,t.setRenderTarget(s),t.autoClear=l,this.adjustVisibility(!0),this.changeInstanceVisibilityOfSelectedObjects(!0),this.adjustDemVisibility(d),e.restoreInVisibleGroup(i,c),p&&(p.visible=u)}}e.inVisibleGroupList=[r.ObjectGroupType.IBLCUBE],e.hideInVisibleGroup=t=>{const i=e.inVisibleGroupList.length;let r=new Array(i);for(let a=0;a<i;++a){const i=t.getObjectGroup(e.inVisibleGroupList[a]);i&&(r[a]=i.visible,i.visible=!1)}return r},e.restoreInVisibleGroup=(t,i)=>{const r=e.inVisibleGroupList.length;for(let a=0;a<r;++a){const r=t.getObjectGroup(e.inVisibleGroupList[a]);r&&(r.visible=i[a])}},r.DepthRenderPass=e}(),function(){let e=new THREE.Matrix4,t=new THREE.Matrix4;r.ScanRingPass=class{constructor(e,t,i,a,n){var s=this;THREE.Pass.call(s),s._running=!0,s._paused=!1,s._tickTimeLast=void 0,s._first=!0,s.viewer=i,s.shader=r.ScanRingShader,s.id=e,s.radius=500,s.emitPosition=new THREE.Vector3(0,1,0),s.originPosition=new THREE.Vector3(0,0,0),s.progressive=10,s.duration=3e3,s.color=new THREE.Vector3(1,1,1),s.range=[],s.renderComposer=t,s.uniforms=THREE.UniformsUtils.clone(s.shader.uniforms),s.camera=s.viewer.camera,s.scene=s.viewer.getScene(),s.modelManager=s.viewer.modelManager,s.material=new THREE.ShaderMaterial({defines:s.shader.defines||{},uniforms:s.uniforms,vertexShader:s.shader.vertexShader,fragmentShader:s.shader.fragmentShader}),s.postCamera=new THREE.OrthographicCamera(-1,1,1,-1,0,1),s.postScene=new THREE.Scene,s.quad=new THREE.Mesh(new THREE.PlaneBufferGeometry(2,2),s.material),s.quad.frustumCulled=!1,s.postScene.add(s.quad)}setOpts(e){var t=this;e&&(null!=e.originPosition&&(t.originPosition=new THREE.Vector3(e.originPosition.x,e.originPosition.y,e.originPosition.z)),null!=e.emitPosition&&(t.emitPosition=new THREE.Vector3(e.emitPosition.x,e.emitPosition.y,e.emitPosition.z)),null!=e.progressive&&(t.progressive=e.progressive),null!=e.radius&&(t.radius=e.radius),null!=e.duration&&(t.duration=e.duration),null!=e.color&&null!=e.alpha&&(t.color=new THREE.Vector4(e.color.r,e.color.g,e.color.b,e.alpha)),null!=e.range&&(t.range=e.range))}getOpts(){var e=this;return{emitPosition:e.emitPosition,originPosition:e.originPosition,radius:e.radius,duration:e.duration,color:e.color,progressive:e.progressive}}render(e,t,i,r,a,n){const s=this;if(s._updateCameraUniforms(e),null==s.startTime&&(s.startTime=(new Date).getTime(),s._tickTimeLast=s.startTime),!s._running)return s._updateTimeUniform(),s._updatePartUniforms(n),void s._renderToTarget(e,t,i);if(s._paused)return s._updateTimeUniform(s._tickTimeLast),s._updatePartUniforms(n),void s._renderToTarget(e,t,i);const o=s._tickTimeLast;s._tickTimeLast=(new Date).getTime(),s._updateTimeUniform(o),s._updatePartUniforms(n),s._renderToTarget(e,t,i)}_updateCameraUniforms(i){const r=this;if(r.camera){r.uniforms.cameraProjection.value=r.camera.projectionMatrix,e.copy(r.camera.projectionMatrix).invert(),r.uniforms.inverseProjection.value=e,t.copy(r.camera.matrixWorld).invert(),r.uniforms.matrixWorld.value=r.camera.matrixWorld;var a=new THREE.Vector4(r.emitPosition.x,r.emitPosition.y,r.emitPosition.z,1);a.applyMatrix4(t);var n=new THREE.Vector4(r.originPosition.x,r.originPosition.y,r.originPosition.z,1);n.applyMatrix4(t);var s=new THREE.Vector3;s.set(a.x,a.y,a.z),s.sub(n),r.uniforms.scanPlaneNormalEC.value=s.normalize(),r.uniforms.scanCenterEC.value=n,r.uniforms.cameraNear.value=r.camera.near,r.uniforms.cameraFar.value=r.camera.far,r.uniforms.progressive.value=r.progressive,r.uniforms.viewport.value.set(0,0,i.getContext().drawingBufferWidth,i.getContext().drawingBufferHeight),r.uniforms.logDepthBufFC.value=2/(Math.log(r.camera.far+1)/Math.LN2)}}_updateTimeUniform(e){const t=this;t.uniforms.time&&(0==t.duration?t.uniforms.time.value=1:t.uniforms.time.value=void 0===e?1:(e-t.startTime)%t.duration/t.duration)}_updatePartUniforms(e){const t=this;2==t.range.length?(t.uniforms.minHeight.value=t.range[0],t.uniforms.maxHeight.value=t.range[1]):(t.uniforms.minHeight.value=0,t.uniforms.maxHeight.value=0),t.uniforms.radius&&(t.uniforms.radius.value=t.radius),t.uniforms.color&&(t.uniforms.color.value=t.color),t.uniforms.firstFlg&&(t.uniforms.firstFlg.value=e?0:1),t.quad.material=t.material}_renderToTarget(e,t,i){const r=this;r.uniforms.tDiffuse&&(r.uniforms.tDiffuse.value=i.texture),r.uniforms.depthTexture&&(r.uniforms.depthTexture.value=r.renderComposer.getDepthTexture());const a=e.getRenderTarget();e.setRenderTarget(t),r.clear&&e.clear(),e.render(r.postScene,r.postCamera),e.setRenderTarget(a)}dispose(){var e=this;e.emitPosition=null,e.originPosition=null,e.uniforms=null}setSize(e,t){}play(){this._running&&!this._paused||(this._running=!0,this._paused=!1)}pause(){!1===this._paused&&(this._paused=!0)}stop(){this._running&&(this._running=!1,this._paused=!1)}}}(),function(){let e=new THREE.Matrix4,t=new THREE.Matrix4;r.FanScanPass=class{constructor(e,t,i,a,n){const s=this;THREE.Pass.call(s),s._running=!0,s._paused=!1,s._tickTimeLast=void 0,s.viewer=i,s.shader=r.FanScanPassShader,s.id=e,s.radius=500,s.fanAngle=Math.PI/3,s.originPosition=new THREE.Vector3(0,0,0),s.backgroundColor=new THREE.Vector3(1,1,1),s.backgroundAlpha=1,s.duration=3e3,s.color=new THREE.Vector3(1,1,1),s.alpha=1,s.renderComposer=t,s.uniforms=THREE.UniformsUtils.clone(s.shader.uniforms),s.camera=s.viewer.camera,s.scene=s.viewer.getScene(),s.modelManager=s.viewer.modelManager,s.material=new THREE.ShaderMaterial({defines:s.shader.defines||{},uniforms:s.uniforms,vertexShader:s.shader.vertexShader,fragmentShader:s.shader.fragmentShader}),s.postCamera=new THREE.OrthographicCamera(-1,1,1,-1,0,1),s.postScene=new THREE.Scene,s.quad=new THREE.Mesh(new THREE.PlaneBufferGeometry(2,2),s.material),s.quad.frustumCulled=!1,s.postScene.add(s.quad)}setOpts(e){const t=this;e&&(null!=e.originPosition&&(t.originPosition=new THREE.Vector3(e.originPosition.x,e.originPosition.y,e.originPosition.z)),null!=e.backgroundColor&&(t.backgroundColor=new THREE.Vector3(e.backgroundColor.r,e.backgroundColor.g,e.backgroundColor.b)),null!=e.alpha&&(t.alpha=e.alpha),null!=e.backgroundAlpha&&(t.backgroundAlpha=e.backgroundAlpha),null!=e.radius&&(t.radius=e.radius),null!=e.duration&&(t.duration=e.duration),null!=e.fanAngle&&(t.fanAngle=e.fanAngle),null!=e.color&&(t.color=new THREE.Vector3(e.color.r,e.color.g,e.color.b)))}getOpts(){const e=this;return{radius:e.radius,fanAngle:e.fanAngle,originPosition:e.originPosition,backgroundColor:e.backgroundColor,backgroundAlpha:e.backgroundAlpha,duration:e.duration,color:e.color,alpha:e.alpha}}render(e,t,i,r,a,n){const s=this;if(s._updateCameraUniforms(e),null==s.startTime&&(s.startTime=(new Date).getTime(),s._tickTimeLast=s.startTime),!s._running)return s._updateTimeUniform(s.startTime),s._updatePartUniforms(),void s._renderToTarget(e,t,i);if(s._paused)return s._updateTimeUniform(s._tickTimeLast),s._updatePartUniforms(),void s._renderToTarget(e,t,i);const o=s._tickTimeLast;s._tickTimeLast=(new Date).getTime(),s._updateTimeUniform(o),s._updatePartUniforms(),s._renderToTarget(e,t,i)}_updateCameraUniforms(i){const r=this;if(!r.camera)return;r.uniforms.cameraProjection.value=r.camera.projectionMatrix,e.copy(r.camera.projectionMatrix).invert(),r.uniforms.inverseProjection.value=e,t.copy(r.camera.matrixWorld).invert(),r.uniforms.matrixWorld.value=r.camera.matrixWorld;let a=new THREE.Vector4(r.originPosition.x,r.originPosition.y,r.originPosition.z,1),n=new THREE.Vector4(r.originPosition.x,r.originPosition.y+1,r.originPosition.z,1);n.applyMatrix4(t);let s=new THREE.Vector3;s.set(n.x,n.y,n.z),s.sub(a),r.uniforms.scanPlaneNormalEC.value=s.normalize(),r.uniforms.scanCenter.value=a,r.uniforms.cameraNear.value=r.camera.near,r.uniforms.cameraFar.value=r.camera.far,r.uniforms.viewport.value.set(0,0,i.getContext().drawingBufferWidth,i.getContext().drawingBufferHeight),r.uniforms.logDepthBufFC.value=2/(Math.log(r.camera.far+1)/Math.LN2)}_updateTimeUniform(e){const t=this;t.uniforms.time&&(0==t.duration?t.uniforms.time.value=1:t.uniforms.time.value=void 0===e?1:(e-t.startTime)%t.duration/t.duration)}_updatePartUniforms(){const e=this;e.uniforms.radius&&(e.uniforms.radius.value=e.radius),e.uniforms.color&&(e.uniforms.color.value=e.color),e.uniforms.opacity&&(e.uniforms.opacity.value=e.alpha),e.uniforms.fanAngle&&(e.uniforms.fanAngle.value=e.fanAngle/(2*Math.PI)),e.uniforms.backgroundColor&&(e.uniforms.backgroundColor.value=e.backgroundColor),e.uniforms.backgroundOpacity&&(e.uniforms.backgroundOpacity.value=e.backgroundAlpha),e.quad.material=e.material}_renderToTarget(e,t,i){const r=this;r.uniforms.tDiffuse&&(r.uniforms.tDiffuse.value=i.texture),r.uniforms.depthTexture&&(r.uniforms.depthTexture.value=r.renderComposer.getDepthTexture());const a=e.getRenderTarget();e.setRenderTarget(t),r.clear&&e.clear(),e.render(r.postScene,r.postCamera),e.setRenderTarget(a)}dispose(){var e=this;e.emitPosition=null,e.originPosition=null,e.uniforms=null}setSize(e,t){}play(){this._running&&!this._paused||(this._running=!0,this._paused=!1)}pause(){!1===this._paused&&(this._paused=!0)}stop(){this._running&&(this._running=!1,this._paused=!1)}}}(),function(){class e extends THREE.Pass{constructor(e,t,i,a){super();var n=this;n.viewer=t,n.renderComposer=e,n.shader=r.BackgroundShader,n.uniforms=THREE.UniformsUtils.clone(n.shader.uniforms),n.camera=n.viewer.camera,n.scene=n.viewer.getScene(),n.modelManager=n.viewer.modelManager,n.material=new THREE.ShaderMaterial({defines:n.shader.defines||{},uniforms:n.uniforms,vertexShader:n.shader.vertexShader,fragmentShader:n.shader.fragmentShader,depthTest:!1,depthWrite:!1}),n.postCamera=new THREE.OrthographicCamera(-1,1,1,-1,0,1),n.postScene=new THREE.Scene,n.quad=new THREE.Mesh(new THREE.PlaneBufferGeometry(2,2),n.material),n.quad.frustumCulled=!1,n.postScene.add(n.quad)}render(e,t,i,r,a){var n=this;n.uniforms.abTexture&&(n.uniforms.abTexture.value=n.renderComposer.composerAdditive.readBuffer.texture),n.uniforms.mbTexture&&(n.uniforms.mbTexture.value=n.renderComposer.composerMix.readBuffer.texture),n.uniforms.isAdditive&&(n.uniforms.isAdditive.value=n.renderComposer.isAdditiveRoad()?1:0),n.quad.material=n.material;var s=e.getRenderTarget();e.autoClear=!1,e.setRenderTarget(null),e.clear(),e.render(n.postScene,n.postCamera),e.setRenderTarget(s)}destroy(){this.material.dispose()}setSize(e,t){}}r.BackgroundPass=e}(),r.FanScanShader={uniforms:{fanAngle:{value:0},time:{value:0},backgroundColor:{value:new THREE.Vector3(1,1,1)},backgroundOpacity:{value:0}},vertexShader:"\n        #include <common>\n        #include <uv_pars_vertex>\n        #include <uv2_pars_vertex>\n        #include <envmap_pars_vertex>\n        #include <color_pars_vertex>\n        #include <fog_pars_vertex>\n        #include <morphtarget_pars_vertex>\n        #include <skinning_pars_vertex>\n        #include <logdepthbuf_pars_vertex>\n        #include <clipping_planes_pars_vertex>\n\n        varying vec2 vCoordinates;\n        void main() {\n            #include <uv_vertex>\n            #include <uv2_vertex>\n            #include <color_vertex>\n            #include <skinbase_vertex>\n            #ifdef USE_ENVMAP\n            #include <beginnormal_vertex>\n            #include <morphnormal_vertex>\n            #include <skinnormal_vertex>\n            #include <defaultnormal_vertex>\n            #endif\n            vCoordinates = vec2(position.x, position.y);\n            #include <begin_vertex>\n            #include <morphtarget_vertex>\n            #include <skinning_vertex>\n            #include <project_vertex>\n            #include <logdepthbuf_vertex>\n            #include <worldpos_vertex>\n            #include <clipping_planes_vertex>\n            #include <envmap_vertex>\n            #include <fog_vertex>\n        }\n    ",fragmentShader:"\n        uniform float fanAngle;\n        uniform float time;\n        uniform vec3 backgroundColor;\n        uniform float backgroundOpacity;\n        varying vec2 vCoordinates;\n\n        uniform vec3 diffuse;\n        uniform float opacity;\n        #ifndef FLAT_SHADED\n            varying vec3 vNormal;\n        #endif\n        #include <common>\n        #include <color_pars_fragment>\n        #include <uv_pars_fragment>\n        #include <uv2_pars_fragment>\n        #include <map_pars_fragment>\n        #include <alphamap_pars_fragment>\n        #include <aomap_pars_fragment>\n        #include <lightmap_pars_fragment>\n        #include <envmap_pars_fragment>\n        #include <fog_pars_fragment>\n        #include <specularmap_pars_fragment>\n        #include <logdepthbuf_pars_fragment>\n        #include <clipping_planes_pars_fragment>\n        void main() {\n            #include <logdepthbuf_fragment>\n\n            float scanAngle = 0.0;\n            float fanOpacity = backgroundOpacity;\n            if(vCoordinates.y==0.0 && vCoordinates.x==0.0){\n                discard;\n            }\n\n            float _angle = atan(vCoordinates.y, vCoordinates.x);\n            if(vCoordinates.y < 0.0){\n                _angle = _angle + PI*2.0;\n            }\n            _angle = _angle/(PI*2.0);\n\n            if( (_angle>=time &&_angle <= (fanAngle+time)) ||\n                ((fanAngle+time)>1.0 && _angle<=fract(fanAngle+time))){\n                if(_angle-time<0.0) {\n                    scanAngle = _angle+(1.0-time);\n                }else{\n                    scanAngle = _angle-time;\n                }\n                //提高融合感\n                scanAngle = pow(1.0 - scanAngle/fanAngle,2.0);\n                fanOpacity = fanOpacity + (1.0 - fanOpacity) * scanAngle * opacity;\n            }\n\n            gl_FragColor = vec4(mix(backgroundColor, diffuse, scanAngle), fanOpacity);\n//          gl_FragColor = vec4(vec3(fanOpacity), fanOpacity);\n//          gl_FragColor = vec4(vec3(scanAngle), scanAngle);\n            #include <premultiplied_alpha_fragment>\n            #include <tonemapping_fragment>\n            #include <encodings_fragment>\n            #include <fog_fragment>\n        }\n    "},r.HorizontalBlurShader={uniforms:{tDiffuse:{value:null},h:{value:1/512}},vertexShader:"varying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tvUv = uv;\n\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n\t\t}",fragmentShader:"uniform sampler2D tDiffuse;\n\t\tuniform float h;\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tvec4 sum = vec4( 0.0 );\n\n\t\t\tsum += texture2D( tDiffuse, vec2( vUv.x - 4.0 * h, vUv.y ) ) * 0.051;\n\t\t\tsum += texture2D( tDiffuse, vec2( vUv.x - 3.0 * h, vUv.y ) ) * 0.0918;\n\t\t\tsum += texture2D( tDiffuse, vec2( vUv.x - 2.0 * h, vUv.y ) ) * 0.12245;\n\t\t\tsum += texture2D( tDiffuse, vec2( vUv.x - 1.0 * h, vUv.y ) ) * 0.1531;\n\t\t\tsum += texture2D( tDiffuse, vec2( vUv.x, vUv.y ) ) * 0.1633;\n\t\t\tsum += texture2D( tDiffuse, vec2( vUv.x + 1.0 * h, vUv.y ) ) * 0.1531;\n\t\t\tsum += texture2D( tDiffuse, vec2( vUv.x + 2.0 * h, vUv.y ) ) * 0.12245;\n\t\t\tsum += texture2D( tDiffuse, vec2( vUv.x + 3.0 * h, vUv.y ) ) * 0.0918;\n\t\t\tsum += texture2D( tDiffuse, vec2( vUv.x + 4.0 * h, vUv.y ) ) * 0.051;\n\n\t\t\tgl_FragColor = sum;\n\n\t\t}"},r.VerticalBlurShader={uniforms:{tDiffuse:{value:null},v:{value:1/512}},vertexShader:"varying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tvUv = uv;\n\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n\t\t}",fragmentShader:"uniform sampler2D tDiffuse;\n\t\tuniform float v;\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tvec4 sum = vec4( 0.0 );\n\n\t\t\tsum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 4.0 * v ) ) * 0.051;\n\t\t\tsum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 3.0 * v ) ) * 0.0918;\n\t\t\tsum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 2.0 * v ) ) * 0.12245;\n\t\t\tsum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 1.0 * v ) ) * 0.1531;\n\t\t\tsum += texture2D( tDiffuse, vec2( vUv.x, vUv.y ) ) * 0.1633;\n\t\t\tsum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 1.0 * v ) ) * 0.1531;\n\t\t\tsum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 2.0 * v ) ) * 0.12245;\n\t\t\tsum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 3.0 * v ) ) * 0.0918;\n\t\t\tsum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 4.0 * v ) ) * 0.051;\n\n\t\t\tgl_FragColor = sum;\n\n\t\t}"},r.PostDepthShader={uniforms:{cameraNear:{value:0},cameraFar:{value:0},tDiffuse:{value:null},tDepth:{value:null},isDepthMode:{value:!1}},vertexShader:"\n    varying vec2 vUv;\n\n    void main() {\n        vUv = uv;\n        gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n    }\n    ",fragmentShader:"\n    #include <packing>\n\n    varying vec2 vUv;\n    uniform sampler2D tDiffuse;\n    uniform sampler2D tDepth;\n    uniform float cameraNear;\n    uniform float cameraFar;\n    uniform bool isDepthMode;\n\n\n    float readDepth( sampler2D depthSampler, vec2 coord ) {\n        float fragCoordZ = texture2D( depthSampler, coord ).x;\n        float viewZ = perspectiveDepthToViewZ( fragCoordZ, cameraNear, cameraFar );\n        return viewZToOrthographicDepth( viewZ, cameraNear, cameraFar );\n    }\n\n    void main() {\n        if(isDepthMode){\n            float depth = readDepth( tDepth, vUv );\n\n            gl_FragColor.rgb = vec3( depth );//1.0 - \n            gl_FragColor.a = 1.0;\n        }else{\n            gl_FragColor = texture2D( tDiffuse, vUv );\n\n        }\n        \n\t\t#include <tonemapping_fragment>\n\t\t#include <encodings_fragment>\n    }\n    "},r.CloudStateShader={cloud_state_pars_vertex:"\n    attribute uint idState;\n    varying vec4 iIdState;\n",cloud_state_pars_fragment:"\n    varying vec4 iIdState;\n",cloud_state_vertex:"\n    iIdState = vec4( float(idState/uint(256*256*256)) / 255.0, float(idState/uint(256*256)%uint(256)) / 255.0, float(uint(idState/uint(256))%uint(256)) / 255.0, float(idState%uint(256)) / 255.0 );\n",cloud_state_fragment:"\n    if(floatEqual(iIdState.a * 255.0, 0.0))\n    {\n        discard;\n    }\n    else if (floatEqual(iIdState.a * 255.0, 1.0))\n    {\n\n    }\n    else if (floatEqual(iIdState.a * 255.0, 3.0)\n        && iIdState.b>0.0 \n        &&floatEqual(iIdState.r * 255.0, 0.0)\n        &&floatEqual(iIdState.r * 255.0, 0.0))\n    {\n        diffuseColor.a = iIdState.b;\n    }\n    else if (floatEqual(iIdState.a * 255.0, 4.0))\n    {\n        diffuseColor = vec4(iIdState.rgb, 0.2);\n    }\n    else\n    {\n        diffuseColor = iIdState;        \n    }\n       \n"};var R=["#define PHYSICAL","varying vec3 vViewPosition;","#ifndef FLAT_SHADED","varying vec3 vNormal;","#endif","#ifdef USE_INSTANCE","   attribute float vState;","   attribute float vState2;","   attribute float vClipping;","#if NUM_CLIPPING_PLANES > 0","   varying float fClipping;","#endif","   varying float fState;","   attribute vec4 aColor;","   varying vec4 vaColor;","   attribute vec3 mcol0;","   attribute vec3 mcol1;","   attribute vec3 mcol2;","   attribute vec3 mcol3;","   #if defined(USE_MAP)||defined(USE_BUMPMAP) ","       attribute vec2 muvCol0;","       attribute vec2 muvCol1;","       attribute vec2 muvCol2;","   #endif","   #if defined(USE_MULTI_BLINK_COLOR) ","       attribute vec4 bColor;","       varying vec4 vbColor;","   #endif","   #if defined(USE_LIGHTMAP)","       attribute vec4 uv2OffsetRepeat;","   #endif","#endif","#include <common>","#include <uv_pars_vertex>","#include <uv2_pars_vertex>","#include <displacementmap_pars_vertex>","#include <color_pars_vertex>","#include <fog_pars_vertex>","#include <morphtarget_pars_vertex>","#include <skinning_pars_vertex>","#include <shadowmap_pars_vertex>","#include <specularmap_pars_fragment>","#include <logdepthbuf_pars_vertex>","#include <clipping_planes_pars_vertex>","#include <view_shed_pars_vertex>","#include <video_cast_pars_vertex>","varying vec4 wPositionForInnerClipping;","#include <CompressNormal_vertex>","#include <CompressColor_vertex>","#include <heightLimit_pars_vertex>","#include <excavation_pars_vertex>","#include <cloud_state_pars_vertex>","mat3 inverse_mat3(in mat3 m)","{","   float determinant =","    m[0][0] * (m[1][1] * m[2][2] - m[2][1] * m[1][2])","    - m[1][0] * (m[0][1] * m[2][2] - m[2][1] * m[0][2])","    + m[2][0] * (m[0][1] * m[1][2] - m[1][1] * m[0][2]);","    mat3 inverse;","    inverse[0][0] = + (m[1][1] * m[2][2] - m[2][1] * m[1][2]);","    inverse[1][0] = - (m[1][0] * m[2][2] - m[2][0] * m[1][2]);","    inverse[2][0] = + (m[1][0] * m[2][1] - m[2][0] * m[1][1]);","    inverse[0][1] = - (m[0][1] * m[2][2] - m[2][1] * m[0][2]);","    inverse[1][1] = + (m[0][0] * m[2][2] - m[2][0] * m[0][2]);","    inverse[2][1] = - (m[0][0] * m[2][1] - m[2][0] * m[0][1]);","    inverse[0][2] = + (m[0][1] * m[1][2] - m[1][1] * m[0][2]);","    inverse[1][2] = - (m[0][0] * m[1][2] - m[1][0] * m[0][2]);","    inverse[2][2] = + (m[0][0] * m[1][1] - m[1][0] * m[0][1]);","    inverse /= determinant;","    return inverse;","}","#ifdef USE_COMPRESS_UV","uniform vec2 uvCenter;","uniform vec2 uvHalfExtent;","vec2 uvDecode(vec2 myuv) {","    myuv = (myuv + 32768.0)* 2.0 / 65535.0 - 1.0;","    return myuv * uvHalfExtent + uvCenter;","}","#endif","void main() {","#if defined( USE_MAP ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_SPECULARMAP ) || defined( USE_ALPHAMAP ) || defined( USE_EMISSIVEMAP ) || defined( USE_ROUGHNESSMAP ) || defined( USE_METALNESSMAP )","#ifdef USE_COMPRESS_UV","   vUv = uvDecode(uv);","   vUv = ( uvTransform * vec3( vUv, 1 ) ).xy;","#else","   vUv = ( uvTransform * vec3( uv, 1 ) ).xy;","#endif","#endif","#include <uv2_vertex>","#include <color_vertex>","#include <beginnormal_vertex>","#ifdef CNORMAL","objectNormal = octDecode();","#endif","#include <morphnormal_vertex>","#include <skinbase_vertex>","#include <skinnormal_vertex>","#include <defaultnormal_vertex>","#if (defined(USE_MAP)||defined(USE_BUMPMAP)) && defined(USE_INSTANCE)  ","   vUv = vec2(mat3(vec3(muvCol0, 0.0),","                   vec3(muvCol1, 0.0),","                   vec3(muvCol2, 1.0)) * vec3(uv, 1.0));","   vUv = ( uvTransform * vec3( vUv, 1 ) ).xy;","#endif","#if defined(USE_COMPRESS_UV) && (defined(USE_LIGHTMAP) || defined(USE_AOMAP))","   vUv2 = uvDecode(vUv2);","#endif","#if defined(USE_LIGHTMAP) && defined(USE_INSTANCE)  ","   vUv2.x = uv2OffsetRepeat.x*vUv2.x/ 65535.0 + uv2OffsetRepeat.z ;","   vUv2.y = uv2OffsetRepeat.y*vUv2.y/ 65535.0 + uv2OffsetRepeat.w ;","#endif","vec3 transformed = vec3( position );","#ifdef USE_INSTANCE","vaColor = aColor;","#if NUM_CLIPPING_PLANES > 0","   fClipping = vClipping;","#endif","#if defined(USE_MULTI_BLINK_COLOR) ","   vbColor = bColor;","#endif","#ifdef INSTANCE_STATE_SECONDARY","fState = vState2;","#else","fState = vState;","#endif","transformed = vec3(mat4(vec4(mcol0, 0.0),","                   vec4(mcol1, 0.0),","                   vec4(mcol2, 0.0),","                   vec4(mcol3, 1.0)) * vec4(transformed, 1.0));","#ifdef USE_INSTANCE_NORMAL","    mat3 normalMat = mat3(mcol0, mcol1, mcol2);","    normalMat = inverse_mat3(normalMat);","    normalMat = transposeMat3(normalMat);","    transformedNormal = normalMat * objectNormal;","    transformedNormal = normalMatrix * transformedNormal;","#ifdef FLIP_SIDED","   transformedNormal = - transformedNormal;","#endif","    transformedNormal = normalize( transformedNormal );","#endif","#endif","#ifdef CCOLOR","ocColor = decodeColor();","#endif","#ifndef FLAT_SHADED","vNormal = normalize( transformedNormal );","#endif","#include <displacementmap_vertex>","#include <morphtarget_vertex>","#include <skinning_vertex>","#include <project_vertex>","#include <logdepthbuf_vertex>","#include <clipping_planes_vertex>","vViewPosition = - mvPosition.xyz;","wPositionForInnerClipping = modelMatrix * vec4( transformed, 1.0 );","#include <heightLimit_vertex>","#include <worldpos_vertex>","#include <shadowmap_vertex>","#include <fog_vertex>","vec3 vsWorldPosition = vec3(modelMatrix * vec4(transformed, 1.0));","#include <view_shed_vertex>","#include <video_cast_vertex>","#include <excavation_vertex>","#include <cloud_state_vertex>","}"].join("\n"),B=["#define PHYSICAL","uniform vec3 diffuse;","uniform vec3 emissive;","uniform float roughness;","uniform float metalness;","uniform float opacity;","uniform float imageFade;","uniform vec3 tintColor;","#ifndef STANDARD","uniform float clearCoat;","uniform float clearCoatRoughness;","#endif","varying vec3 vViewPosition;","#ifndef FLAT_SHADED","varying vec3 vNormal;","#endif","#ifdef USE_INSTANCE","   varying vec4 vaColor;","   varying float fState;","   varying float fClipping;","#endif","#ifdef CCOLOR","   varying vec4 ocColor;","#endif","#if defined(USE_MULTI_BLINK_COLOR) ","   varying vec4 vbColor;","#endif","#ifdef USE_FILLPATTERN","   uniform sampler2D fillMap;","#endif","varying vec4 wPositionForInnerClipping;","uniform float shift;","uniform float A;","uniform float B;","uniform float C;","uniform float D;","uniform float E;","uniform float F;","uniform float scale;","uniform vec4 blinkColor;","uniform float blinkCoefficient;","uniform float colorState;","uniform int localClipping;","uniform int innerClipping;","uniform mat4 orthoViewProjMatrix;","uniform bool useForCap;","#include <heightLimit_pars_fragment>","vec3 toneMapCanonFilmic(vec3 color)","{","    color *= (1.0 / shift);","    return (((color * (A * color + C * B)) / (color * (A * color + B) + D * F))) * (1.0 / scale);","}","#include <common>","#include <packing>","#include <dithering_pars_fragment>","#include <color_pars_fragment>","#include <uv_pars_fragment>","#include <uv2_pars_fragment>","#include <map_pars_fragment>","#include <aomap_pars_fragment>","#include <lightmap_pars_fragment>","#include <emissivemap_pars_fragment>","#include <envmap_pars_fragment>","#include <fog_pars_fragment>","#include <bsdfs>","#include <cube_uv_reflection_fragment>","#include <lights_pars_begin>","#include <lights_physical_pars_fragment>","#include <shadowmap_pars_fragment>","#include <bumpmap_pars_fragment>","#include <normalmap_pars_fragment>","#include <roughnessmap_pars_fragment>","#include <metalnessmap_pars_fragment>","#include <logdepthbuf_pars_fragment>","#include <csm_fragment>","#include <clipping_planes_pars_fragment>","#include <envmap_common_pars_fragment>","#include <envmap_physical_pars_fragment>","#include <view_shed_pars_fragment>","#include <video_cast_pars_fragment>","#include <excavation_pars_fragment>","#include <cloud_state_pars_fragment>","vec3 hdrDecode(in vec4 rgbm) {","const float rgbmScale = 2.82842712;","vec3 r = rgbm.rgb * (rgbmScale * (1.0 - rgbm.a));","return r * r;","}","vec3 linearToGammaUnreal(in vec3 rgb) {","    return rgb / (rgb + 0.187) * 1.035 *(0.5 / shift);","}","bool floatEqual(in float x, in float y) {","    return (x >= y - 0.01) && (x <= y + 0.01);","}","bool floatNotEqual(in float x, in float y) {","    return (x <= y - 0.01) || (x >= y + 0.01);","}","void main() {","\n        if (innerClipping > 0)\n        {\n            vec4 clipPosition = orthoViewProjMatrix * wPositionForInnerClipping;\n            clipPosition.xyz /= clipPosition.w;\n            if (clipPosition.x >= -1.0 && clipPosition.x <= 1.0 &&\n                clipPosition.y >= -1.0 && clipPosition.y <= 1.0 && clipPosition.z >= -1.0) \n            {\n                discard;\n            }\n        }\n        else\n        {\n            #if NUM_CLIPPING_PLANES > 0\n            vec3 cameraPosInViewSpace = vec3(0.0);\n                #ifdef USE_INSTANCE\n                    if ((localClipping == 1 && floatEqual(fClipping, 6.0)) || localClipping < 0) {\n                        for ( int i = 0; i < UNION_CLIPPING_PLANES; ++ i ) {\n                            vec4 plane = clippingPlanes[ i ];\n                            if ( dot( vViewPosition, plane.xyz ) > plane.w &&(!useForCap ||(useForCap &&dot( cameraPosInViewSpace, plane.xyz ) > plane.w )) ) discard;\n                        }\n                        #if UNION_CLIPPING_PLANES < NUM_CLIPPING_PLANES\n                            bool clipped = true;\n                            for ( int i = UNION_CLIPPING_PLANES; i < NUM_CLIPPING_PLANES; ++ i ) {\n                                vec4 plane = clippingPlanes[ i ];\n                                clipped = ( dot( vViewPosition, plane.xyz ) > plane.w ) && clipped;\n                            }\n                            if ( clipped ) discard;\n                        #endif\n                    }\n                #else\n                    for ( int i = 0; i < UNION_CLIPPING_PLANES; ++ i ) {\n                        vec4 plane = clippingPlanes[ i ];\n                        if ( dot( vViewPosition, plane.xyz ) > plane.w &&(!useForCap ||(useForCap&&dot( cameraPosInViewSpace, plane.xyz ) > plane.w ))  ) discard;\n                    }\n                    #if UNION_CLIPPING_PLANES < NUM_CLIPPING_PLANES\n                        bool clipped = true;\n                        for ( int i = UNION_CLIPPING_PLANES; i < NUM_CLIPPING_PLANES; ++ i ) {\n                            vec4 plane = clippingPlanes[ i ];\n                            clipped = ( dot( vViewPosition, plane.xyz ) > plane.w ) && clipped;\n                        }\n                        if ( clipped ) discard;\n                    #endif\n                #endif\n            #endif\n        }\n    ","#ifdef USE_FILLPATTERN","    vec2 screenPosition = vec2(gl_FragCoord.x,gl_FragCoord.y);","    float flag = texture2D(fillMap, vec2(screenPosition.x/32.0, screenPosition.y/32.0)).r;","    if(flag == 0.0)","    {","        discard;","    }","#endif","vec4 diffuseColor = vec4( diffuse, opacity );","#include <vertex_color_frag>","#ifdef USE_INSTANCE","   if (floatEqual(fState, -1.0)) ","       discard;","   #ifndef USE_COLOR","       if (floatEqual(fState, 0.0)) ","           diffuseColor = vec4(vaColor.xyz,opacity);","   #endif","   if (floatNotEqual(fState, 0.0)) ","       diffuseColor = vaColor;","#endif","#ifdef CCOLOR","       diffuseColor = vec4(ocColor.rgb, opacity ) ;","#endif","vec4 selectedColor = diffuseColor;","#ifndef USE_LIGHTMAP","   diffuseColor.rgb = pow(diffuseColor.rgb, vec3(GAMMA_FACTOR));","#endif","ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );","vec3 totalEmissiveRadiance = emissive;","#ifdef USE_INSTANCE","   if (floatEqual(fState, 3.0))","       totalEmissiveRadiance = vec3(0.0);","#endif","#include <logdepthbuf_fragment>","vec4 gamaColor = diffuseColor ;","#ifdef USE_MAP","   vec4 texelColor = texture2D( map, vUv );","   texelColor = mapTexelToLinear( texelColor );","   #ifdef USE_CLAMP_TO_BORDER","       texelColor = (vUv.x > 1.0 ||vUv.x < 0.0 || vUv.y < 0.0|| vUv.y > 1.0) ?diffuseColor:mapTexelToLinear( texelColor );","   #endif","   diffuseColor = vec4( mix(diffuseColor.rgb , texelColor.rgb, imageFade), opacity);","   #ifdef USE_INSTANCE","       if (floatNotEqual(fState, 0.0)) ","           diffuseColor.a = vaColor.a;","         if (floatEqual(fState, 3.0))","             diffuseColor = gamaColor;","   #endif","#endif","#include <cloud_state_fragment>","diffuseColor = vec4(diffuseColor.rgb * tintColor.rgb,diffuseColor.a);","#include <alphamap_fragment_override>","#include <alphatest_fragment>","#include <specularmap_fragment>","#include <roughnessmap_fragment>","#include <metalnessmap_fragment>","#include <normal_fragment_begin>","#include <normal_fragment_maps>","#include <emissivemap_fragment>","#ifdef USE_INSTANCE","   if (floatEqual(fState, 3.0)){","       roughnessFactor = 1.0;","       metalnessFactor = 0.0;","   }","#endif","#include <lights_physical_fragment>"," GeometricContext geometry;","geometry.position = - vViewPosition;","geometry.normal = normal;","geometry.viewDir = normalize( vViewPosition );","IncidentLight directLight;","#if ( NUM_POINT_LIGHTS > 0 ) && defined( RE_Direct )","PointLight pointLight;","#if defined( USE_SHADOWMAP ) && (NUM_POINT_LIGHT_SHADOWS > 0)","PointLightShadow pointLightShadow;","#endif","#pragma unroll_loop_start","for ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {","pointLight = pointLights[ i ];","getPointDirectLightIrradiance( pointLight, geometry, directLight );","#if defined( USE_SHADOWMAP ) && (NUM_POINT_LIGHT_SHADOWS > 0)  && ( UNROLLED_LOOP_INDEX < NUM_POINT_LIGHT_SHADOWS )","pointLightShadow = pointLightShadows[ i ];","directLight.color *= all( bvec2( receiveShadow, directLight.visible ) ) ? getPointShadow( pointShadowMap[ i ], pointLightShadow.shadowMapSize, pointLightShadow.shadowBias, pointLightShadow.shadowRadius, vPointShadowCoord[ i ] ) : 1.0;","#endif","RE_Direct( directLight, geometry, material, reflectedLight );","}","#pragma unroll_loop_end","#endif","#if ( NUM_SPOT_LIGHTS > 0 ) && defined( RE_Direct )","    SpotLight spotLight;","    #if defined( USE_SHADOWMAP ) && (NUM_SPOT_LIGHT_SHADOWS > 0)","        SpotLightShadow spotLightShadow;","    #endif","    #pragma unroll_loop_start","    for ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {","        spotLight = spotLights[ i ];","        getSpotDirectLightIrradiance( spotLight, geometry, directLight );","        #if defined( USE_SHADOWMAP ) && (NUM_SPOT_LIGHT_SHADOWS > 0) && ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS )","        spotLightShadow = spotLightShadows[ i ];","        if(opacity > 0.8)","        directLight.color *= all( bvec2( receiveShadow, directLight.visible ) ) ? getShadow( spotShadowMap[ i ], spotLightShadow.shadowMapSize, spotLightShadow.shadowBias, spotLightShadow.shadowRadius, vSpotShadowCoord[ i ] ) : 1.0;","        #endif","        RE_Direct( directLight, geometry, material, reflectedLight );","    }","   #pragma unroll_loop_end","#endif","#if ( NUM_DIR_LIGHTS > 0 ) && defined( RE_Direct ) && defined( USE_CSM )","\n            DirectionalLight directionalLight;\n            float shadowValue = calcShadowFactor(geometry.normal);\n        ","    for ( int i = 4; i < NUM_DIR_LIGHTS; i ++ ) {","        directionalLight = directionalLights[ i ];","        getDirectionalDirectLightIrradiance( directionalLight, geometry, directLight );","        #ifdef USE_SHADOWMAP","        if(opacity > 0.8)","        directLight.color *=  receiveShadow ? shadowValue : 1.0;","        #endif","       RE_Direct( directLight, geometry, material, reflectedLight );","    }","#endif","\n        #if ( NUM_DIR_LIGHTS > 0 ) && defined( RE_Direct ) && !defined( USE_CSM )\n            DirectionalLight directionalLight;\n\n            #if defined( USE_SHADOWMAP ) && NUM_DIR_LIGHT_SHADOWS > 0\n                DirectionalLightShadow directionalLightShadow;\n            #endif\n\n            #pragma unroll_loop_start\n            for ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n                directionalLight = directionalLights[ i ];\n                getDirectionalDirectLightIrradiance( directionalLight, geometry, directLight );\n                //r142\n                //getDirectionalLightInfo( directionalLight, geometry, directLight );\n                #if defined( USE_SHADOWMAP ) && (NUM_DIR_LIGHT_SHADOWS > 0) && ( UNROLLED_LOOP_INDEX < NUM_DIR_LIGHT_SHADOWS )\n                directionalLightShadow = directionalLightShadows[ i ];\n                if(opacity > 0.8)\n                directLight.color *= all( bvec2( receiveShadow, directLight.visible ) ) ? getShadow( directionalShadowMap[ i ], directionalLightShadow.shadowMapSize, directionalLightShadow.shadowBias, directionalLightShadow.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;\n                #endif\n                RE_Direct( directLight, geometry, material, reflectedLight );\n            }\n            #pragma unroll_loop_end\n        #endif\n        ","#if ( NUM_RECT_AREA_LIGHTS > 0 ) && defined( RE_Direct_RectArea )","   RectAreaLight rectAreaLight;","    for ( int i = 0; i < NUM_RECT_AREA_LIGHTS; i ++ ) {","        rectAreaLight = rectAreaLights[ i ];","        RE_Direct_RectArea( rectAreaLight, geometry, material, reflectedLight );","    }","#endif","#if defined( RE_IndirectDiffuse )","    vec3 irradiance = getAmbientLightIrradiance( ambientLightColor );","    #if ( NUM_HEMI_LIGHTS > 0 )","       for ( int i = 0; i < NUM_HEMI_LIGHTS; i ++ ) {","           irradiance += getHemisphereLightIrradiance( hemisphereLights[ i ], geometry );","       }","    #endif","    #if defined( USE_ENVMAP ) && defined( PHYSICAL ) && defined( ENVMAP_TYPE_CUBE_UV )","       irradiance += getLightProbeIndirectIrradiance( geometry, 8 );","    #endif","    RE_IndirectDiffuse( irradiance, geometry, material, reflectedLight );","    #endif","    #if defined( USE_ENVMAP ) && defined( RE_IndirectSpecular )","    vec3 radiance = getLightProbeIndirectRadiance( geometry.viewDir, geometry.normal, material.specularRoughness, 8 );","    #ifndef STANDARD","    vec3 clearCoatRadiance = getLightProbeIndirectRadiance( geometry.viewDir, geometry.clearcoatNormal, material.clearcoatRoughness, 8 );","    #else","    vec3 clearCoatRadiance = vec3( 0.0 );","    #endif","    RE_IndirectSpecular( radiance, irradiance, clearCoatRadiance, geometry, material, reflectedLight ); ","    #endif","#include <aomap_fragment>","vec3 diffuseSpecularEmissive = vec3(0.0);","#ifdef USE_LIGHTMAP","   #ifdef USE_COMPONENT_LIGHTMAP","       vec3 lightMapIrradiance = (texture2D(lightMap, vUv2)).rgb * lightMapIntensity;","   #else","       vec3 lightMapIrradiance = hdrDecode(texture2D(lightMap, vUv2)) * lightMapIntensity;","   #endif","   vec3 diffuseSpecular =  clamp(diffuseColor.rgb, vec3(0.0, 0.0, 0.0), vec3(1.0, 1.0, 1.0)) * lightMapIrradiance;","   diffuseSpecularEmissive = diffuseSpecular + diffuseColor.rgb * 0.0;","#endif","vec3 outgoingLight = diffuseSpecularEmissive + reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveRadiance;","bool useColorWithoutLight = false;","#ifdef USE_COLORWITHOUTLIGHT ","   useColorWithoutLight = true;","#endif","if (useColorWithoutLight || (ambientLightColor == vec3(0.0)) ) ","   gl_FragColor = diffuseColor;","else","   gl_FragColor = vec4( outgoingLight, diffuseColor.a );","#if defined( TONE_MAPPING )","   #if defined(USE_LIGHTMAP)","       gl_FragColor.rgb = linearToGammaUnreal(diffuseSpecularEmissive.xyz );","   #else","       gl_FragColor.rgb = toneMapCanonFilmic( gl_FragColor.rgb );","   #endif","#endif","#ifdef USE_INSTANCE","       if (floatEqual(fState, 2.0))","           gl_FragColor = selectedColor;","       if (floatEqual(fState, 5.0) && floatEqual(colorState, 1.0)) {","           #if defined(USE_MULTI_BLINK_COLOR)","               vec4 finBlinkColor = vbColor;","           #else","               vec4 finBlinkColor = blinkColor;","           #endif","           gl_FragColor = mix(gl_FragColor, finBlinkColor, blinkCoefficient);","       }","#else","       if (floatEqual(colorState, 1.0)) {","           gl_FragColor = mix(gl_FragColor, blinkColor, blinkCoefficient);","       }","       if (floatEqual(colorState, 2.0))","           gl_FragColor = selectedColor;","#endif","#include <view_shed_fragment>","#include <video_cast_fragment>","#ifndef USE_LIGHTMAP","  #include <encodings_fragment>","#endif","#include <heightLimit_fragment>","#include <excavation_fragment>","#include <premultiplied_alpha_fragment>","#include <dithering_fragment>","#include <fog_fragment>","}"].join("\n");r.ClippingStencilShader={uniforms:{},vertexShader:"\n        #include <clipping_planes_pars_vertex>\n        #ifdef USE_INSTANCE\n            attribute float vState;\n            attribute float vState2;\n            attribute float vClipping;\n            varying float fClipping;\n            varying float fState;\n            attribute vec4 aColor;\n            varying vec4 vaColor;\n            attribute vec3 mcol0;\n            attribute vec3 mcol1;\n            attribute vec3 mcol2;\n            attribute vec3 mcol3;\n            #if defined(USE_MAP)||defined(USE_BUMPMAP) \n                attribute vec2 muvCol0;\n                attribute vec2 muvCol1;\n                attribute vec2 muvCol2;\n            #endif\n            #if defined(USE_LIGHTMAP)\n                attribute vec4 uv2OffsetRepeat;\n            #endif\n        #endif\n\n        void main() {\n            #include <begin_vertex>\n            #ifdef USE_INSTANCE\n                // vaColor = aColor;\n                // fClipping = vClipping;\n                #ifdef INSTANCE_STATE_SECONDARY\n                    fState = vState2;\n                #else\n                    fState = vState;\n                #endif\n                transformed = vec3(mat4(vec4(mcol0, 0.0),\n                                vec4(mcol1, 0.0),\n                                vec4(mcol2, 0.0),\n                                vec4(mcol3, 1.0)) * vec4(transformed, 1.0));\n            #endif\n            #include <project_vertex>\n            #include <clipping_planes_vertex>\n        }",fragmentShader:"\n        #include <clipping_planes_pars_fragment>\n        #ifdef USE_INSTANCE\n            varying float fState;\n        #endif\n\n        bool floatEqual(in float x, in float y) {\n            return (x >= y - 0.01) && (x <= y + 0.01);\n        }\n\n        void main(void){\n            #ifdef USE_INSTANCE\n               if (floatEqual(fState, -1.0)) \n                   discard;\n            #endif\n            #if NUM_CLIPPING_PLANES > 0\n                for ( int i = 0; i < UNION_CLIPPING_PLANES; ++ i ) {\n                    vec4 plane = clippingPlanes[ i ];\n                    if ( dot( vClipPosition, plane.xyz ) > plane.w && dot( vec3(0.0), plane.xyz ) > plane.w) discard;//!!cameraPosition is vec3(0.0) in camera space\n                }\n                #if UNION_CLIPPING_PLANES < NUM_CLIPPING_PLANES\n                    bool clipped = true;\n                    for ( int i = UNION_CLIPPING_PLANES; i < NUM_CLIPPING_PLANES; ++ i ) {\n                        vec4 plane = clippingPlanes[ i ];\n                        clipped = ( dot( vClipPosition, plane.xyz ) > plane.w ) && clipped;\n                    }\n                    if ( clipped ) discard;\n                #endif\n            #endif\n            gl_FragColor = vec4(1.0, 0.0, 0.0, 1.0);\n        }\n    "},r.ShadowMapShader={shadowmap_pars_fragment:" \n#ifdef USE_SHADOWMAP\n\n\t#if NUM_DIR_LIGHT_SHADOWS > 0\n\n\t\tuniform sampler2D directionalShadowMap[ NUM_DIR_LIGHT_SHADOWS ];\n\t\tvarying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHT_SHADOWS ];\n\n\t\tstruct DirectionalLightShadow {\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t};\n\n\t\tuniform DirectionalLightShadow directionalLightShadows[ NUM_DIR_LIGHT_SHADOWS ];\n\n\t#endif\n\n\t#if NUM_SPOT_LIGHT_SHADOWS > 0\n\n\t\tuniform sampler2D spotShadowMap[ NUM_SPOT_LIGHT_SHADOWS ];\n\t\tvarying vec4 vSpotShadowCoord[ NUM_SPOT_LIGHT_SHADOWS ];\n\n\t\tstruct SpotLightShadow {\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t};\n\n\t\tuniform SpotLightShadow spotLightShadows[ NUM_SPOT_LIGHT_SHADOWS ];\n\n\t#endif\n\n\t#if NUM_POINT_LIGHT_SHADOWS > 0\n\n\t\tuniform sampler2D pointShadowMap[ NUM_POINT_LIGHT_SHADOWS ];\n\t\tvarying vec4 vPointShadowCoord[ NUM_POINT_LIGHT_SHADOWS ];\n\n\t\tstruct PointLightShadow {\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t\tfloat shadowCameraNear;\n\t\t\tfloat shadowCameraFar;\n\t\t};\n\n\t\tuniform PointLightShadow pointLightShadows[ NUM_POINT_LIGHT_SHADOWS ];\n\n\t#endif\n\n\t/*\n\t#if NUM_RECT_AREA_LIGHTS > 0\n\n\t\t// TODO (abelnation): create uniforms for area light shadows\n\n\t#endif\n\t*/\n\n\tfloat texture2DCompare( sampler2D depths, vec2 uv, float compare ) {\n\n\t\treturn step( compare, unpackRGBAToDepth( texture2D( depths, uv ) ) );\n\n\t}\n\n\tvec2 texture2DDistribution( sampler2D shadow, vec2 uv ) {\n\n\t\treturn unpackRGBATo2Half( texture2D( shadow, uv ) );\n\n\t}\n\n\tfloat VSMShadow (sampler2D shadow, vec2 uv, float compare ){\n\n\t\tfloat occlusion = 1.0;\n\n\t\tvec2 distribution = texture2DDistribution( shadow, uv );\n\n\t\tfloat hard_shadow = step( compare , distribution.x ); // Hard Shadow\n\n\t\tif (hard_shadow != 1.0 ) {\n\n\t\t\tfloat distance = compare - distribution.x ;\n\t\t\tfloat variance = max( 0.00000, distribution.y * distribution.y );\n\t\t\tfloat softness_probability = variance / (variance + distance * distance ); // Chebeyshevs inequality\n\t\t\tsoftness_probability = clamp( ( softness_probability - 0.3 ) / ( 0.95 - 0.3 ), 0.0, 1.0 ); // 0.3 reduces light bleed\n\t\t\tocclusion = clamp( max( hard_shadow, softness_probability ), 0.0, 1.0 );\n\n\t\t}\n\t\treturn occlusion;\n\n\t}\n\n\tfloat texture2DShadowLerp( sampler2D depths, vec2 size, vec2 uv, float compare ) {\n        const vec2 offset = vec2( 0.0, 1.0 );\n        vec2 texelSize = vec2( 1.0 ) / size;\n        vec2 centroidUV = floor( uv * size + 0.5 ) / size;\n        float lb = texture2DCompare( depths, centroidUV + texelSize * offset.xx, compare );\n        float lt = texture2DCompare( depths, centroidUV + texelSize * offset.xy, compare );\n        float rb = texture2DCompare( depths, centroidUV + texelSize * offset.yx, compare );\n        float rt = texture2DCompare( depths, centroidUV + texelSize * offset.yy, compare );\n        vec2 f = fract( uv * size + 0.5 );\n        float a = mix( lb, lt, f.y );\n        float b = mix( rb, rt, f.y );\n        float c = mix( a, b, f.x );\n        return c;\n\t}\n\t\n\tfloat getShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowBias, float shadowRadius, vec4 shadowCoord ) {\n\n\t\tfloat shadow = 1.0;\n\n\t\tshadowCoord.xyz /= shadowCoord.w;\n\t\tshadowCoord.z += shadowBias;\n\n\t\t// if ( something && something ) breaks ATI OpenGL shader compiler\n\t\t// if ( all( something, something ) ) using this instead\n\n\t\tbvec4 inFrustumVec = bvec4 ( shadowCoord.x >= 0.0, shadowCoord.x <= 1.0, shadowCoord.y >= 0.0, shadowCoord.y <= 1.0 );\n\t\tbool inFrustum = all( inFrustumVec );\n\n\t\tbvec2 frustumTestVec = bvec2( inFrustum, shadowCoord.z <= 1.0 );\n\n\t\tbool frustumTest = all( frustumTestVec );\n\n\t\tif ( frustumTest ) {\n\n\t\t#if defined( SHADOWMAP_TYPE_PCF )\n\n\t\t\tvec2 texelSize = vec2( 1.0 ) / shadowMapSize;\n\n\t\t\tfloat dx0 = - texelSize.x * shadowRadius;\n\t\t\tfloat dy0 = - texelSize.y * shadowRadius;\n\t\t\tfloat dx1 = + texelSize.x * shadowRadius;\n\t\t\tfloat dy1 = + texelSize.y * shadowRadius;\n\t\t\tfloat dx2 = dx0 / 2.0;\n\t\t\tfloat dy2 = dy0 / 2.0;\n\t\t\tfloat dx3 = dx1 / 2.0;\n\t\t\tfloat dy3 = dy1 / 2.0;\n\n\t\t\tshadow = (\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx2, dy2 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy2 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx3, dy2 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx2, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx3, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx2, dy3 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy3 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx3, dy3 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy1 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy1 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy1 ), shadowCoord.z )\n\t\t\t) * ( 1.0 / 17.0 );\n\n\t\t#elif defined( SHADOWMAP_TYPE_PCF_SOFT )\n\t\t\tvec2 texelSize = vec2( 1.0 ) / shadowMapSize;\n\t\t\tfloat dx0 = - texelSize.x * shadowRadius;\n\t\t\tfloat dy0 = - texelSize.y * shadowRadius;\n\t\t\tfloat dx1 = + texelSize.x * shadowRadius;\n\t\t\tfloat dy1 = + texelSize.y * shadowRadius;\n\t\t\treturn (\n\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( dx0, dy0 ), shadowCoord.z ) +\n\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( 0.0, dy0 ), shadowCoord.z ) +\n\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( dx1, dy0 ), shadowCoord.z ) +\n\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( dx0, 0.0 ), shadowCoord.z ) +\n\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy, shadowCoord.z ) +\n\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( dx1, 0.0 ), shadowCoord.z ) +\n\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( dx0, dy1 ), shadowCoord.z ) +\n\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( 0.0, dy1 ), shadowCoord.z ) +\n\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( dx1, dy1 ), shadowCoord.z )\n\t\t\t) * ( 1.0 / 9.0 );\n\n\t\t#elif defined( SHADOWMAP_TYPE_VSM )\n\n\t\t\tshadow = VSMShadow( shadowMap, shadowCoord.xy, shadowCoord.z );\n\n\t\t#else // no percentage-closer filtering:\n\n\t\t\tshadow = texture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z );\n\n\t\t#endif\n\n\t\t}\n\n\t\treturn shadow;\n\n\t}\n\n\t// cubeToUV() maps a 3D direction vector suitable for cube texture mapping to a 2D\n\t// vector suitable for 2D texture mapping. This code uses the following layout for the\n\t// 2D texture:\n\t//\n\t// xzXZ\n\t//  y Y\n\t//\n\t// Y - Positive y direction\n\t// y - Negative y direction\n\t// X - Positive x direction\n\t// x - Negative x direction\n\t// Z - Positive z direction\n\t// z - Negative z direction\n\t//\n\t// Source and test bed:\n\t// https://gist.github.com/tschw/da10c43c467ce8afd0c4\n\n\tvec2 cubeToUV( vec3 v, float texelSizeY ) {\n\n\t\t// Number of texels to avoid at the edge of each square\n\n\t\tvec3 absV = abs( v );\n\n\t\t// Intersect unit cube\n\n\t\tfloat scaleToCube = 1.0 / max( absV.x, max( absV.y, absV.z ) );\n\t\tabsV *= scaleToCube;\n\n\t\t// Apply scale to avoid seams\n\n\t\t// two texels less per square (one texel will do for NEAREST)\n\t\tv *= scaleToCube * ( 1.0 - 2.0 * texelSizeY );\n\n\t\t// Unwrap\n\n\t\t// space: -1 ... 1 range for each square\n\t\t//\n\t\t// #X##\t\tdim    := ( 4 , 2 )\n\t\t//  # #\t\tcenter := ( 1 , 1 )\n\n\t\tvec2 planar = v.xy;\n\n\t\tfloat almostATexel = 1.5 * texelSizeY;\n\t\tfloat almostOne = 1.0 - almostATexel;\n\n\t\tif ( absV.z >= almostOne ) {\n\n\t\t\tif ( v.z > 0.0 )\n\t\t\t\tplanar.x = 4.0 - v.x;\n\n\t\t} else if ( absV.x >= almostOne ) {\n\n\t\t\tfloat signX = sign( v.x );\n\t\t\tplanar.x = v.z * signX + 2.0 * signX;\n\n\t\t} else if ( absV.y >= almostOne ) {\n\n\t\t\tfloat signY = sign( v.y );\n\t\t\tplanar.x = v.x + 2.0 * signY + 2.0;\n\t\t\tplanar.y = v.z * signY - 2.0;\n\n\t\t}\n\n\t\t// Transform to UV space\n\n\t\t// scale := 0.5 / dim\n\t\t// translate := ( center + 0.5 ) / dim\n\t\treturn vec2( 0.125, 0.25 ) * planar + vec2( 0.375, 0.75 );\n\n\t}\n\n\tfloat getPointShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowBias, float shadowRadius, vec4 shadowCoord, float shadowCameraNear, float shadowCameraFar ) {\n\n\t\tvec2 texelSize = vec2( 1.0 ) / ( shadowMapSize * vec2( 4.0, 2.0 ) );\n\n\t\t// for point lights, the uniform @vShadowCoord is re-purposed to hold\n\t\t// the vector from the light to the world-space position of the fragment.\n\t\tvec3 lightToPosition = shadowCoord.xyz;\n\n\t\t// dp = normalized distance from light to fragment position\n\t\tfloat dp = ( length( lightToPosition ) - shadowCameraNear ) / ( shadowCameraFar - shadowCameraNear ); // need to clamp?\n\t\tdp += shadowBias;\n\n\t\t// bd3D = base direction 3D\n\t\tvec3 bd3D = normalize( lightToPosition );\n\n\t\t#if defined( SHADOWMAP_TYPE_PCF ) || defined( SHADOWMAP_TYPE_PCF_SOFT ) || defined( SHADOWMAP_TYPE_VSM )\n\n\t\t\tvec2 offset = vec2( - 1, 1 ) * shadowRadius * texelSize.y;\n\n\t\t\treturn (\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xyy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yyy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xyx, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yyx, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xxy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yxy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xxx, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yxx, texelSize.y ), dp )\n\t\t\t) * ( 1.0 / 9.0 );\n\n\t\t#else // no percentage-closer filtering\n\n\t\t\treturn texture2DCompare( shadowMap, cubeToUV( bd3D, texelSize.y ), dp );\n\n\t\t#endif\n\n\t}\n\n#endif\n"},r.DepthFragShader={depth_frag:" \n    #if DEPTH_PACKING == 3200\n\n\tuniform float opacity;\n\n#endif\n\n#include <common>\n#include <packing>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n//r142\n//#include <alphatest_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\n\nvarying vec2 vHighPrecisionZW;\n\nvoid main() {\n\n\t#include <clipping_planes_fragment>\n\n\tvec4 diffuseColor = vec4( 1.0 );\n\n\t#if DEPTH_PACKING == 3200\n\n\t\tdiffuseColor.a = opacity;\n\n\t#endif\n\n\t#include <map_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\n\t#include <logdepthbuf_fragment>\n\n\t// Higher precision equivalent of gl_FragCoord.z. This assumes depthRange has been left to its default values.\n\tfloat fragCoordZ = 0.5 * vHighPrecisionZW[0] / vHighPrecisionZW[1] + 0.5;\n\n\t#if DEPTH_PACKING == 3200\n\n\t\tgl_FragColor = vec4( vec3( 1.0 - fragCoordZ ), opacity );\n\n\t#elif DEPTH_PACKING == 3201\n\n\t\tgl_FragColor = packDepthToRGBA( gl_FragCoord.z );\n\n\t#endif\n\n}\n"},r.CSMShader={csm_fragment:"\n        uniform vec2 csmCascades[4];\n        float calcShadowFactor(vec3 normal)\n        {\n            float shadowFactor = 1.0;\n            #ifdef USE_CSM\n                #if ( NUM_DIR_LIGHTS > 0 )\n                    #ifdef USE_SHADOWMAP\n                        float viewDepth = vViewPosition.z;\n                        DirectionalLight directionalLight;\n                        directionalLight = directionalLights[ 0 ];\n                        #if defined( USE_SHADOWMAP ) && NUM_DIR_LIGHT_SHADOWS > 0\n                        DirectionalLightShadow directionalLightShadow;\n                        #endif\n                        directionalLightShadow = directionalLightShadows[ 0 ];\n\n                        float bias = cos(80.0);\n                        float biasFactor = 0.8;\n                        if (viewDepth >= csmCascades[0].x && viewDepth < csmCascades[0].y) {\n                            shadowFactor = getShadow( directionalShadowMap[ 0 ], directionalLightShadow.shadowMapSize, directionalLightShadow.shadowBias, directionalLightShadow.shadowRadius, vDirectionalShadowCoord[ 0 ] );\n                            float dotNL = dot( normal, directionalLight.direction );\n                            if (dotNL < bias) {\n                                shadowFactor = biasFactor;\n                            }\n                        }\n\n                        #if ( NUM_DIR_LIGHTS > 1 )\n                            directionalLight = directionalLights[ 1 ];\n                            directionalLightShadow = directionalLightShadows[ 1 ];\n                            if (viewDepth >= csmCascades[1].x && viewDepth < csmCascades[1].y) {\n                                shadowFactor = getShadow( directionalShadowMap[ 1 ], directionalLightShadow.shadowMapSize, directionalLightShadow.shadowBias, directionalLightShadow.shadowRadius, vDirectionalShadowCoord[ 1 ] );\n                                float dotNL = dot( normal, directionalLight.direction );\n                                if (dotNL < bias) {\n                                    shadowFactor = biasFactor;\n                                }\n                            }\n                        #endif\n\n                        #if ( NUM_DIR_LIGHTS > 2 )\n                            directionalLight = directionalLights[ 2 ];\n                            directionalLightShadow = directionalLightShadows[ 2 ];\n                            if (viewDepth >= csmCascades[2].x && viewDepth < csmCascades[2].y) {\n                                shadowFactor = getShadow( directionalShadowMap[ 2 ], directionalLightShadow.shadowMapSize, directionalLightShadow.shadowBias, directionalLightShadow.shadowRadius, vDirectionalShadowCoord[ 2 ] );\n                                float dotNL = dot( normal, directionalLight.direction );\n                                if (dotNL < bias) {\n                                    shadowFactor = biasFactor;\n                                }\n                            }\n                        #endif\n\n                        #if ( NUM_DIR_LIGHTS > 3 )\n                            directionalLight = directionalLights[ 3 ];\n                            directionalLightShadow = directionalLightShadows[ 3 ];\n                            if (viewDepth >= csmCascades[3].x && viewDepth < csmCascades[3].y) {\n                                shadowFactor = getShadow( directionalShadowMap[ 3 ], directionalLightShadow.shadowMapSize, directionalLightShadow.shadowBias, directionalLightShadow.shadowRadius, vDirectionalShadowCoord[ 3 ] );\n                                float dotNL = dot( normal, directionalLight.direction );\n                                if (dotNL < bias) {\n                                    shadowFactor = biasFactor;\n                                }\n                            }\n                        #endif\n                    #endif\n                #endif\n            #endif\n            shadowFactor = max(shadowFactor, 0.0);\n            return shadowFactor;\n        }\n    "},r.CompressNormalShader={CompressNormal_vertex:"\n        #ifdef CNORMAL\n            attribute vec2 cNormal;\n\n            float signNotZero(float value)\n            {\n                return value >= 0.0 ? 1.0 : -1.0;\n            }\n\n            vec2 signNotZero(vec2 value)\n            {\n                return vec2(signNotZero(value.x), signNotZero(value.y));\n            }\n\n            vec3 octDecode(){\n                vec2 encoded = cNormal;\n                if (encoded.x == 0.0 && encoded.y == 0.0) {\n                        return vec3(0.0, 0.0, 0.0);\n                    }\n\n                encoded = encoded / 255.0 * 2.0 - 1.0;\n                vec3 v = vec3(encoded.x, encoded.y, 1.0 - abs(encoded.x) - abs(encoded.y));\n                if (v.z < 0.0)\n                {\n                    v.xy = (1.0 - abs(v.yx)) * signNotZero(v.xy);\n                }\n                return normalize(v);\n            }\n        #endif\n    "},r.CompressColorShader={CompressColor_vertex:"\n        #ifdef CCOLOR\n            attribute uint cColor;\n            varying vec4 ocColor;\n            vec4 decodeColor(){\n                uint ucColor = uint(cColor);\n                float ca = float(ucColor >> 24) / 255.0;\n                uint cri = ucColor << 8;\n                float cr = float(cri >> 24) / 255.0;\n                uint cgi = ucColor << 16;\n                float cg = float(cgi >> 24) / 255.0;\n                uint cgb = ucColor << 24;\n                float cb = float(cgb >> 24) / 255.0;\n                vec4 vcColor = vec4(cr, cg, cb, 1.0);\n                return vcColor;\n            }\n        #endif\n    "},r.VertexColorFrag={vertex_color_frag:"\n    #if defined( USE_COLOR_ALPHA )\n        diffuseColor = vec4(vColor.bgr, opacity);\n    #elif defined( USE_COLOR )\n        diffuseColor.rgb = vColor.rgb;\n    #endif\n    "},r.HeightLimitShader={heightLimit_pars_vertex:"\n    #ifdef HEIGHT_LIMIT_READ\n        uniform mat4 heightLimitOrthoMatrix;\n        varying vec3 v_HeightLimitOrthoPosition;\n        varying float heightWorld;\n    #endif\n",heightLimit_vertex:"\n    #ifdef HEIGHT_LIMIT_READ\n        vec4 othPostion = heightLimitOrthoMatrix * modelMatrix * vec4( transformed, 1.0 );//???\n        othPostion /= othPostion.w;\n        v_HeightLimitOrthoPosition = othPostion.xyz;\n        heightWorld = (modelMatrix * vec4( transformed, 1.0 )).y;\n    #endif\n",heightLimit_pars_fragment:"\n    #ifdef HEIGHT_LIMIT_READ\n        varying vec3 v_HeightLimitOrthoPosition;\n        uniform sampler2D  heightLimitSampler;\n        uniform sampler2D  heightColorSampler;\n        varying float heightWorld;\n\n        vec2 postProjToScreen(vec2 position)\n        {\n            vec2 screenPos = position;\n            \n            return 0.5 *(vec2(screenPos.x, screenPos.y) + 1.0);\n        }\n\n        float decode_float(vec4 v) {\n            vec4 bits = v * 255.0;\n            float sign = mix(-1.0, 1.0, step(bits[3], 128.0));\n            float expo = floor(mod(bits[3] + 0.1, 128.0)) * 2.0 + floor((bits[2] + 0.1) / 128.0) - 127.0;\n            float sig = bits[0] + bits[1] * 256.0 + floor(mod(bits[2] + 0.1, 128.0)) * 256.0 * 256.0;\n            return sign * (1.0 + sig / 8388607.0) * pow(2.0, expo);\n        }\n\n    #endif\n\n    #ifdef HEIGHT_LIMIT_WRITE\n        uniform float heightLimit;\n        uniform bool useHeightLimit;\n\n        #define FLOAT_MAX  1.70141184e38\n        #define FLOAT_MIN  1.17549435e-38\n        lowp vec4 encode_float(highp float v) {\n            highp float av = abs(v);\n        \n            //Handle special cases\n            if(av < FLOAT_MIN) {\n            return vec4(0.0, 0.0, 0.0, 0.0);\n            } else if(v > FLOAT_MAX) {\n            return vec4(127.0, 128.0, 0.0, 0.0) / 255.0;\n            } else if(v < -FLOAT_MAX) {\n            return vec4(255.0, 128.0, 0.0, 0.0) / 255.0;\n            }\n        \n            highp vec4 c = vec4(0,0,0,0);\n        \n            //Compute exponent and mantissa\n            highp float e = floor(log2(av));\n            highp float m = av * pow(2.0, -e) - 1.0;\n            \n            //Unpack mantissa\n            c[1] = floor(128.0 * m);\n            m -= c[1] / 128.0;\n            c[2] = floor(32768.0 * m);\n            m -= c[2] / 32768.0;\n            c[3] = floor(8388608.0 * m);\n            \n            //Unpack exponent\n            highp float ebias = e + 127.0;\n            c[0] = floor(ebias / 2.0);\n            ebias -= c[0] * 2.0;\n            c[1] += floor(ebias) * 128.0; \n        \n            //Unpack sign bit\n            c[0] += 128.0 * step(0.0, -v);\n        \n            //Scale back to range\n            return c / 255.0;\n        }\n      #endif\n",heightLimit_fragment:"\n    #ifdef HEIGHT_LIMIT_READ\n        vec2 heightLimitUV = postProjToScreen(v_HeightLimitOrthoPosition.xy);\n        if(heightLimitUV.x >= 0.0 && heightLimitUV.x <= 1.0 && heightLimitUV.y >= 0.0 && heightLimitUV.y <= 1.0)\n        {\n            vec4 color = texture2D(heightColorSampler, heightLimitUV);\n            \n            vec4 heightColor = texture2D(heightLimitSampler, heightLimitUV);\n            float heightLimit0 = decode_float(heightColor);//unpackRGBAToDepth\n            if(color.a > 0.01 &&heightWorld > heightLimit0 && (heightColor != vec4(0.0,0.0,0.0,0.0))) // edge\n            {\n                gl_FragColor = color;//a?\n            }\n        }\n    #endif\n    #ifdef HEIGHT_LIMIT_WRITE\n        if(useHeightLimit){\n            gl_FragColor = encode_float(heightLimit).abgr;//packDepthToRGBA(heightLimit);//(0-1)\n        }\n    #endif   \n\n"},r.WallShader={uniforms:{blendingRatio:{value:0},directionType:{value:0},directionReverse:{value:0},time:{value:0},unitLength:{value:0},repeat:{value:1}},vertexShader:"\n        #include <common>\n        #include <uv_pars_vertex>\n        #include <uv2_pars_vertex>\n        #include <envmap_pars_vertex>\n        #include <color_pars_vertex>\n        #include <fog_pars_vertex>\n        #include <morphtarget_pars_vertex>\n        #include <skinning_pars_vertex>\n        #include <logdepthbuf_pars_vertex>\n        #include <clipping_planes_pars_vertex>\n        void main() {\n            #include <uv_vertex>\n            #include <uv2_vertex>\n            #include <color_vertex>\n            #include <skinbase_vertex>\n            #ifdef USE_ENVMAP\n            #include <beginnormal_vertex>\n            #include <morphnormal_vertex>\n            #include <skinnormal_vertex>\n            #include <defaultnormal_vertex>\n            #endif\n            #include <begin_vertex>\n            #include <morphtarget_vertex>\n            #include <skinning_vertex>\n            #include <project_vertex>\n            #include <logdepthbuf_vertex>\n            #include <worldpos_vertex>\n            #include <clipping_planes_vertex>\n            #include <envmap_vertex>\n            #include <fog_vertex>\n        }\n    ",fragmentShader:"\n        uniform float blendingRatio;\n        uniform float directionType;\n        uniform float directionReverse;\n        uniform float time;\n\n        uniform float unitLength;\n        uniform float repeat;\n\n        uniform vec3 diffuse;\n        uniform float opacity;\n        #ifndef FLAT_SHADED\n            varying vec3 vNormal;\n        #endif\n        #include <common>\n        #include <color_pars_fragment>\n        #include <uv_pars_fragment>\n        #include <uv2_pars_fragment>\n        #include <map_pars_fragment>\n        #include <alphamap_pars_fragment>\n        #include <aomap_pars_fragment>\n        #include <lightmap_pars_fragment>\n        #include <envmap_pars_fragment>\n        #include <fog_pars_fragment>\n        #include <specularmap_pars_fragment>\n        #include <logdepthbuf_pars_fragment>\n        #include <clipping_planes_pars_fragment>\n        void main() {\n            #include <clipping_planes_fragment>\n            #include <logdepthbuf_fragment>\n//          #include <map_fragment>\n//          #include <color_fragment>\n//          #include <alphamap_fragment>\n//          #include <alphatest_fragment>\n//          #include <specularmap_fragment>\n//          ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n//          #ifdef USE_LIGHTMAP\n//              reflectedLight.indirectDiffuse += texture2D( lightMap, vUv2 ).xyz * lightMapIntensity;\n//          #else\n//              reflectedLight.indirectDiffuse += vec3( 1.0 );\n//          #endif\n//          #include <aomap_fragment>\n//          reflectedLight.indirectDiffuse *= diffuseColor.rgb;\n//          vec3 outgoingLight = reflectedLight.indirectDiffuse;\n//          #include <normal_flip>\n//          #include <envmap_fragment>\n//          gl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\n            vec2 vUvDirection;\n            float uvReverse;\n            if(directionType > 0.0){\n                uvReverse = vUv.y;\n                vUvDirection.y =vUv.x;\n            }else{\n                uvReverse = vUv.x;\n                vUvDirection.y =vUv.y;\n            }\n\n            float _unitLength = 1.0/unitLength;\n            float _orginLength = 0.0;\n            if(directionReverse>0.0){\n                uvReverse = 1.0 - uvReverse;\n                _orginLength=uvReverse;\n                if(unitLength>1.0){\n                    uvReverse =uvReverse/_unitLength + time*unitLength;\n                }else{\n                    uvReverse =uvReverse/_unitLength + time;\n                }\n            }else{\n                _orginLength=uvReverse;\n                if(unitLength>1.0){\n                    uvReverse =uvReverse/_unitLength - time*unitLength;\n                }else{\n                    uvReverse =uvReverse/_unitLength - time;\n                }\n            }\n\n            vUvDirection.x =fract(uvReverse);\n            //重复场合\n            if(unitLength > 1.0 && repeat<1.0){\n                float _time = time + _unitLength;\n                if(_orginLength < time ||_orginLength>_time){\n                    if(_time>1.0 && _orginLength< fract(_time)){\n                        //闭合场合\n                    }\n                    else{\n                        gl_FragColor = vec4(0.0);\n                        return;\n                    }\n                }\n            }\n            vec4 colorImage;\n\n            //临时解决方案,原因很奇怪,有时候会出现虚线\n            if(vUvDirection.x>0.99) {\n                colorImage = texture2D(map, vec2(0.99,vUvDirection.y));\n            } else if(vUvDirection.x<0.01) {\n                colorImage = texture2D(map, vec2(0.01,vUvDirection.y));\n            }else{\n                colorImage = texture2D(map, vUvDirection);\n            }\n            vec3 diffuseColor = mix(diffuse, colorImage.rgb, blendingRatio);\n\n            gl_FragColor = vec4(diffuseColor, colorImage.a * opacity);\n\n            #include <premultiplied_alpha_fragment>\n            #include <tonemapping_fragment>\n            #include <encodings_fragment>\n            #include <fog_fragment>\n        }\n    "},r.PlaneScanShader={uniforms:{blendingRatio:{value:0},angle:{value:0},time:{value:0}},vertexShader:"\n        #include <common>\n        #include <uv_pars_vertex>\n        #include <uv2_pars_vertex>\n        #include <envmap_pars_vertex>\n        #include <color_pars_vertex>\n        #include <fog_pars_vertex>\n        #include <morphtarget_pars_vertex>\n        #include <skinning_pars_vertex>\n        #include <logdepthbuf_pars_vertex>\n        #include <clipping_planes_pars_vertex>\n        void main() {\n            #include <uv_vertex>\n            #include <uv2_vertex>\n            #include <color_vertex>\n            #include <skinbase_vertex>\n            #ifdef USE_ENVMAP\n            #include <beginnormal_vertex>\n            #include <morphnormal_vertex>\n            #include <skinnormal_vertex>\n            #include <defaultnormal_vertex>\n            #endif\n            #include <begin_vertex>\n            #include <morphtarget_vertex>\n            #include <skinning_vertex>\n            #include <project_vertex>\n            #include <logdepthbuf_vertex>\n            #include <worldpos_vertex>\n            #include <clipping_planes_vertex>\n            #include <envmap_vertex>\n            #include <fog_vertex>\n        }\n    ",fragmentShader:"\n        uniform float blendingRatio;\n        uniform float angle;\n        uniform float time;\n\n        uniform vec3 diffuse;\n        uniform float opacity;\n        #ifndef FLAT_SHADED\n            varying vec3 vNormal;\n        #endif\n        #include <common>\n        #include <color_pars_fragment>\n        #include <uv_pars_fragment>\n        #include <uv2_pars_fragment>\n        #include <map_pars_fragment>\n        #include <alphamap_pars_fragment>\n        #include <aomap_pars_fragment>\n        #include <lightmap_pars_fragment>\n        #include <envmap_pars_fragment>\n        #include <fog_pars_fragment>\n        #include <specularmap_pars_fragment>\n        #include <logdepthbuf_pars_fragment>\n        #include <clipping_planes_pars_fragment>\n        mat2 rotate(float rad) {\n            float c = cos(rad);\n            float s = sin(rad);\n            return mat2(\n                c, s,\n                -s, c\n            );\n        }\n        void main() {\n            #include <clipping_planes_fragment>\n            #include <logdepthbuf_fragment>\n\n            vec2 vUvDirection = rotate(-angle) * vec2(vUv.x, vUv.y);\n            vUvDirection.x = fract(vUvDirection.x - time);\n            vUvDirection.y = fract(vUvDirection.y);\n\n            //临时解决方案,原因很奇怪,有时候会出现虚线\n            vec4 colorImage;\n            float _max = 0.99;\n            float _min = 0.01;\n            if(vUvDirection.y>_max && vUvDirection.x>_max) {\n                colorImage = texture2D(map, vec2(_max, _max));\n            } else if(vUvDirection.y>_max && vUvDirection.x<_min) {\n                colorImage = texture2D(map, vec2(_min, _max));\n            } else if(vUvDirection.y<_min && vUvDirection.x>_max) {\n                colorImage = texture2D(map, vec2(_min, _max));\n            }else if(vUvDirection.y<_min && vUvDirection.x<_min) {\n                colorImage = texture2D(map, vec2(_min, _min));\n            }else if(vUvDirection.y>_max) {\n                colorImage = texture2D(map, vec2(vUvDirection.x,_max));\n            } else if(vUvDirection.y<_min) {\n                colorImage = texture2D(map, vec2(vUvDirection.x,_min));\n            } else if(vUvDirection.x>_max) {\n                colorImage = texture2D(map, vec2(_max, vUvDirection.y));\n            }else if(vUvDirection.x<_min) {\n                colorImage = texture2D(map, vec2(_min, vUvDirection.y));\n            } else {\n                colorImage = texture2D(map, vUvDirection);\n            }\n\n            vec3 diffuseColor = mix(diffuse, colorImage.rgb, blendingRatio);\n            gl_FragColor = vec4(diffuseColor, colorImage.a * opacity);\n\n            #include <premultiplied_alpha_fragment>\n            #include <tonemapping_fragment>\n            #include <encodings_fragment>\n            #include <fog_fragment>\n        }\n    "},r.ViewshedShader={view_shed_pars_vertex:"\n    #ifdef VIEW_SHED_MODE\n        const int MAX_VIEWSHED_COUNT = 4;\n        uniform int viewshedCount;\n        struct ViewshedContent {\n            mat4 viewshedViewProjMatrix;\n            mat4 viewshedViewMatrix;\n            vec4 viewshedVisibleColor;\n            vec4 viewshedHiddenColor;\n            vec2 viewshedMinMax;\n            float viewshedLogDepthBufFC;\n\t\t};\n\n        uniform ViewshedContent viewshedContents[ MAX_VIEWSHED_COUNT ];\n        varying float viewshedFragDepth[MAX_VIEWSHED_COUNT];\n        varying vec3 viewshedWorldPosition;\n    #endif\n",view_shed_pars_fragment:"\n    #ifdef VIEW_SHED_MODE\n        const int MAX_VIEWSHED_COUNT = 4;\n        uniform int viewshedCount;\n        uniform sampler2D viewshedDepthMaps[ MAX_VIEWSHED_COUNT ];\n\n        struct ViewshedContent {\n            mat4 viewshedViewProjMatrix;\n            mat4 viewshedViewMatrix;\n            vec4 viewshedVisibleColor;\n            vec4 viewshedHiddenColor;\n            vec2 viewshedMinMax;\n            float viewshedLogDepthBufFC;\n\t\t};\n\n        uniform ViewshedContent viewshedContents[ MAX_VIEWSHED_COUNT ];\n        varying float viewshedFragDepth[MAX_VIEWSHED_COUNT];\n        varying vec3 viewshedWorldPosition;\n        \n        float toLinearDepth(float fragCoordZ, float near, float far)\n        {\n            float viewZ = perspectiveDepthToViewZ( fragCoordZ, near, far );\n\t\t\treturn viewZToOrthographicDepth( viewZ, near, far );\n        }\n\n        float sampleDepthMap(sampler2D depthMap, vec2 uv){\n            vec4 depthColor = texture2D(depthMap, uv);\n            return unpackRGBAToDepth(depthColor);\n        }\n\n        float viewshedDepthCompare(sampler2D depthMap, vec2 uv, float depth){\n            return step(depth, sampleDepthMap(depthMap, uv));\n        }\n\n        float viewshedVisibility(sampler2D depthMap, vec2 uv, float depth, float depthBias){\n            depth -= depthBias;\n            vec2 texelStepSize = 1.0 / vec2(1024.0, 1024.0);\n            float radius = 1.0;\n            float dx0 = -texelStepSize.x * radius;\n            float dy0 = -texelStepSize.y * radius;\n            float dx1 = texelStepSize.x * radius;\n            float dy1 = texelStepSize.y * radius;\n            float visibility = \n            (\n                viewshedDepthCompare(depthMap, uv, depth) +\n                viewshedDepthCompare(depthMap, uv + vec2(dx0, dy0), depth) +\n                viewshedDepthCompare(depthMap, uv + vec2(0.0, dy0), depth) +\n                viewshedDepthCompare(depthMap, uv + vec2(dx1, dy0), depth) +\n                viewshedDepthCompare(depthMap, uv + vec2(dx0, 0.0), depth) +\n                viewshedDepthCompare(depthMap, uv + vec2(dx1, 0.0), depth) +\n                viewshedDepthCompare(depthMap, uv + vec2(dx0, dy1), depth) +\n                viewshedDepthCompare(depthMap, uv + vec2(0.0, dy1), depth) +\n                viewshedDepthCompare(depthMap, uv + vec2(dx1, dy1), depth)\n            ) * (1.0 / 9.0)\n            ;\n            return visibility;\n        }\n    #endif\n",view_shed_vertex:"\n    #ifdef VIEW_SHED_MODE\n        for (int i=0; i<MAX_VIEWSHED_COUNT; i++)\n        {\n            if (i >= viewshedCount) \n            {\n                break;\n            }\n            vec4 viewshedProjPosition = viewshedContents[i].viewshedViewProjMatrix * vec4(vsWorldPosition.xyz, 1.0);\n            float fragDepth = 1.0 + viewshedProjPosition.w;\n            viewshedFragDepth[i] = fragDepth;\n        }\n        viewshedWorldPosition = vsWorldPosition.xyz;\n    #endif\n",view_shed_fragment:"\n    #ifdef VIEW_SHED_MODE\n        vec3 resultColor = gl_FragColor.rgb;\n        #pragma unroll_loop_start\n        for (int i=0; i<4; i++)\n        {\n            if(UNROLLED_LOOP_INDEX < viewshedCount) {\n                vec4 visibleColor = viewshedContents[i].viewshedVisibleColor;\n                vec4 hiddenColor = viewshedContents[i].viewshedHiddenColor;\n                vec4 viewshedViewPosition = viewshedContents[i].viewshedViewMatrix * vec4(viewshedWorldPosition, 1.0);\n                vec4 viewshedClipPosition = viewshedContents[i].viewshedViewProjMatrix * vec4(viewshedWorldPosition, 1.0);\n                viewshedClipPosition = viewshedClipPosition / viewshedClipPosition.w;\n                vec3 viewshedUV = viewshedClipPosition.xyz * 0.5 + 0.5;\n    \n                vec2 minMax = viewshedContents[i].viewshedMinMax;\n                float fragDistance = length(viewshedViewPosition.xyz);\n                if(fragDistance <= minMax.y &&\n                    viewshedUV.x >= 0.0 && viewshedUV.x <= 1.0 &&\n                    viewshedUV.y >=0.0 && viewshedUV.y <= 1.0 &&\n                    viewshedUV.z >=0.0 && viewshedUV.z <= 1.0)\n                {\n                    float fragZ = log2( viewshedFragDepth[i] ) * viewshedContents[i].viewshedLogDepthBufFC * 0.5;\n                    vec4 depthColor = texture2D(viewshedDepthMaps[i], viewshedUV.xy);\n                    float closetDepth = unpackRGBAToDepth(depthColor);\n                    float depthBias = 0.002 + smoothstep(100.0, 1000.0, fragDistance) * 0.058;\n                    \n                    // float visibility = viewshedVisibility(viewshedDepthMaps[i], viewshedUV.xy, fragZ, depthBias); \n                    // if (visibility == 1.0)\n                    if (fragZ - depthBias < closetDepth || closetDepth < depthBias)\n                    {\n                        resultColor = mix(visibleColor.rgb, resultColor, 1.0 - visibleColor.a);\n                    }\n                    else\n                    {\n                        resultColor = mix(hiddenColor.rgb, resultColor, 1.0 - hiddenColor.a);\n                    }\n                }\n            }\n        }\n        #pragma unroll_loop_end\n        gl_FragColor.rgb = resultColor;\n    #endif\n"},r.VideoCastShader={video_cast_pars_vertex:"\n    #ifdef VIDEO_CAST_MODE\n        const int MAX_VIDEO_CAST_COUNT = 4;\n        uniform int videoCastCount;\n        struct VideoCastContent {\n            mat4 viewProjMatrix;\n            mat4 viewMatrix;\n            float logDepthBufFC;\n\t\t};\n\n        uniform VideoCastContent videoCastContents[ MAX_VIDEO_CAST_COUNT ];\n        varying float videoCastFragDepth[MAX_VIDEO_CAST_COUNT];\n        varying vec3 videoCastWorldPosition;\n    #endif\n",video_cast_pars_fragment:"\n    #ifdef VIDEO_CAST_MODE\n        const int MAX_VIDEO_CAST_COUNT = 4;\n        uniform int videoCastCount;\n        uniform sampler2D videoCastDepthMaps[ MAX_VIDEO_CAST_COUNT ];\n        uniform sampler2D videoCastProjectorMaps[ MAX_VIDEO_CAST_COUNT];\n\n        struct VideoCastContent {\n            mat4 viewProjMatrix;\n            mat4 viewMatrix;\n            float logDepthBufFC;\n\t\t};\n\n        uniform VideoCastContent videoCastContents[ MAX_VIDEO_CAST_COUNT ];\n        varying float videoCastFragDepth[MAX_VIDEO_CAST_COUNT];\n        varying vec3 videoCastWorldPosition;\n        \n        float toLinearDepth(float fragCoordZ, float near, float far)\n        {\n            float viewZ = perspectiveDepthToViewZ( fragCoordZ, near, far );\n\t\t\treturn viewZToOrthographicDepth( viewZ, near, far );\n        }\n\n        float sampleDepthMap(sampler2D depthMap, vec2 uv){\n            vec4 depthColor = texture2D(depthMap, uv);\n            return unpackRGBAToDepth(depthColor);\n        }\n\n        float videoCastDepthCompare(sampler2D depthMap, vec2 uv, float depth){\n            return step(depth, sampleDepthMap(depthMap, uv));\n        }\n\n        float videoCastVisibility(sampler2D depthMap, vec2 uv, float depth, float depthBias){\n            depth -= depthBias;\n            vec2 texelStepSize = 1.0 / vec2(1024.0, 1024.0);\n            float radius = 1.0;\n            float dx0 = -texelStepSize.x * radius;\n            float dy0 = -texelStepSize.y * radius;\n            float dx1 = texelStepSize.x * radius;\n            float dy1 = texelStepSize.y * radius;\n            float visibility = \n            (\n                videoCastDepthCompare(depthMap, uv, depth) +\n                videoCastDepthCompare(depthMap, uv + vec2(dx0, dy0), depth) +\n                videoCastDepthCompare(depthMap, uv + vec2(0.0, dy0), depth) +\n                videoCastDepthCompare(depthMap, uv + vec2(dx1, dy0), depth) +\n                videoCastDepthCompare(depthMap, uv + vec2(dx0, 0.0), depth) +\n                videoCastDepthCompare(depthMap, uv + vec2(dx1, 0.0), depth) +\n                videoCastDepthCompare(depthMap, uv + vec2(dx0, dy1), depth) +\n                videoCastDepthCompare(depthMap, uv + vec2(0.0, dy1), depth) +\n                videoCastDepthCompare(depthMap, uv + vec2(dx1, dy1), depth)\n            ) * (1.0 / 9.0)\n            ;\n            return visibility;\n        }\n    #endif\n",video_cast_vertex:"\n    #ifdef VIDEO_CAST_MODE\n        for (int i=0; i<videoCastCount; i++)\n        {\n            vec4 videoCastProjPosition = videoCastContents[i].viewProjMatrix * vec4(vsWorldPosition.xyz, 1.0);\n            float fragDepth = 1.0 + videoCastProjPosition.w;\n            videoCastFragDepth[i] = fragDepth;\n        }\n        videoCastWorldPosition = vsWorldPosition.xyz;\n    #endif\n",video_cast_fragment:"\n    #ifdef VIDEO_CAST_MODE\n        vec3 resultColor = gl_FragColor.rgb;\n        #pragma unroll_loop_start\n        for (int i=0; i<4; i++)\n        {\n            if(UNROLLED_LOOP_INDEX < videoCastCount) \n            {\n                vec4 videoCastViewPosition = videoCastContents[i].viewMatrix * vec4(videoCastWorldPosition, 1.0);\n                vec4 videoCastClipPosition = videoCastContents[i].viewProjMatrix * vec4(videoCastWorldPosition, 1.0);\n                videoCastClipPosition = videoCastClipPosition / videoCastClipPosition.w;\n                vec3 videoCastUV = videoCastClipPosition.xyz * 0.5 + 0.5;\n    \n                vec4 textureColor = texture2D(videoCastProjectorMaps[i], videoCastUV.xy);\n            \n                float fragDistance = length(videoCastViewPosition.xyz);\n                if(videoCastUV.x >= 0.0 && videoCastUV.x <= 1.0 &&\n                    videoCastUV.y >=0.0 && videoCastUV.y <= 1.0 &&\n                    videoCastUV.z >=0.0 && videoCastUV.z <= 1.0)\n                {\n                    float fragZ = log2( videoCastFragDepth[i] ) * videoCastContents[i].logDepthBufFC * 0.5;\n                    vec4 depthColor = texture2D(videoCastDepthMaps[i], videoCastUV.xy);\n                    float closetDepth = unpackRGBAToDepth(depthColor);\n                    float depthBias = 0.002 + smoothstep(100.0, 1000.0, fragDistance) * 0.058;\n                    \n                    if (fragZ - depthBias < closetDepth)\n                    {\n                        resultColor = textureColor.rgb;\n                    }\n                }\n            }\n            \n        }\n        #pragma unroll_loop_end\n\n        gl_FragColor.rgb = resultColor;\n    #endif\n"},function(){class e extends THREE.MeshBasicMaterial{constructor(e){super(e),this.type="GroundCurveMaterial",this.cameraNear=.1,this.cameraFar=10,this.pixelRatio=1,this.frustumPlanes=new THREE.Vector4,this.viewport=new THREE.Vector4,this.geometricToleranceOverMeter=1,this.lineWidth=1,this.globeDepthTexture=null,this.customDepthTexture=null,this.cameraProjection=new THREE.Matrix4,this.inverseProjection=new THREE.Matrix4,this.dashMode=0,this.dashSize=16,this.clampMode=0,this.map=null,this.uvTransform=null,this.visibility=1,this.enableColorOverride=!1,this.enableAnimation=!1,this.isTrail=!1,this.uniforms=THREE.UniformsUtils.merge([THREE.ShaderLib.basic.uniforms,{cameraNear:{value:this.cameraNear},cameraFar:{value:this.cameraFar},pixelRatio:{value:this.pixelRatio},frustumPlanes:{value:this.frustumPlanes.clone()},viewport:{value:this.viewport.clone()},geometricToleranceOverMeter:{value:this.geometricToleranceOverMeter},lineWidth:{value:this.lineWidth},globeDepthTexture:{value:this.globeDepthTexture},customDepthTexture:{value:this.customDepthTexture},cameraProjection:{value:this.cameraProjection},inverseProjection:{value:this.inverseProjection},dashMode:{value:this.dashMode},dashSize:{value:this.dashSize},clampMode:{value:this.clampMode},map:{value:this.map},uvTransform:{value:this.uvTransform},visibility:{value:this.visibility},enableColorOverride:{value:this.enableColorOverride},enableAnimation:{value:this.enableAnimation},isTrail:{value:this.isTrail}}]),this.vertexShader=r.GroundCurveShader.vertexShader,this.fragmentShader=r.GroundCurveShader.fragmentShader}refreshUniforms(){this.uniforms.cameraNear.value=this.cameraNear,this.uniforms.cameraFar.value=this.cameraFar,this.uniforms.pixelRatio.value=this.pixelRatio,this.uniforms.frustumPlanes.value.copy(this.frustumPlanes),this.uniforms.viewport.value.copy(this.viewport),this.uniforms.geometricToleranceOverMeter.value=this.geometricToleranceOverMeter,this.uniforms.lineWidth.value=this.lineWidth,this.uniforms.globeDepthTexture.value=this.globeDepthTexture,this.uniforms.customDepthTexture.value=this.customDepthTexture,this.uniforms.cameraProjection.value=this.cameraProjection,this.uniforms.inverseProjection.value=this.inverseProjection,this.uniforms.dashMode.value=this.dashMode,this.uniforms.dashSize.value=this.dashSize,this.uniforms.clampMode.value=this.clampMode,this.uniforms.map.value=this.map,this.uniforms.visibility.value=this.visibility,this.uniforms.enableColorOverride.value=this.enableColorOverride,this.uniforms.enableAnimation.value=this.enableAnimation,this.uniforms.isTrail.value=this.isTrail}}r.GroundCurveMaterial=e}(),r.GroundCurveShader={vertexShader:"\n    precision highp float;\n    precision highp int;\n    #include <common>\n    #include <fog_pars_vertex>\n    #include <logdepthbuf_pars_vertex>\n    #include <clipping_planes_pars_vertex>\n    const float GLOBE_MINIMUM_ALTITUDE = 6356752.3;\n    const float pi = 3.141592653589793;\n    const float piOverTwo = 1.5707963267948966;\n    attribute vec3 startPosition;\n    attribute vec3 startNormal;\n    attribute vec3 endNormal;\n    attribute vec3 rightNormal;\n    attribute vec3 forwardOffset;\n    attribute vec2 texcoordNormalization;\n\n    attribute vec2 textureUV;\n    varying vec2 vUUv;\n\n    varying vec4 v_startPlaneNormalEcAndHalfWidth;\n    varying vec3 v_endPlaneNormalEc;\n    varying vec4 v_rightPlaneEC;\n    varying vec4 v_endEcAndStartEcX;\n    varying vec4 v_texcoordNormalizationAndStartEcYZ;\n    varying float v_polylineAngle;\n\n    uniform float cameraNear;\n    uniform float cameraFar;\n    uniform float pixelRatio;\n    uniform vec4 frustumPlanes;\n    uniform vec4 viewport;\n    uniform float geometricToleranceOverMeter;\n    uniform float lineWidth;\n\n    float planeDistance(vec4 plane, vec3 point) {\n        return (dot(plane.xyz, point) + plane.w);\n    }\n    float planeDistance(vec3 planeNormal, float planeDistance, vec3 point) {\n        return (dot(planeNormal, point) + planeDistance);\n    }\n    float branchFreeTernary(bool comparison, float a, float b) {\n        float useA = float(comparison);\n        return a * useA + b * (1.0 - useA);\n    }\n    vec2 branchFreeTernary(bool comparison, vec2 a, vec2 b) {\n        float useA = float(comparison);\n        return a * useA + b * (1.0 - useA);\n    }\n    vec3 branchFreeTernary(bool comparison, vec3 a, vec3 b) {\n        float useA = float(comparison);\n        return a * useA + b * (1.0 - useA);\n    }\n    vec4 branchFreeTernary(bool comparison, vec4 a, vec4 b) {\n        float useA = float(comparison);\n        return a * useA + b * (1.0 - useA);\n    }\n    float metersPerPixel(vec4 positionEC, float pixelRatio) {\n        float width = viewport.z;\n        float height = viewport.w;\n        float pixelWidth;\n        float pixelHeight;\n        float top = frustumPlanes.x;\n        float bottom = frustumPlanes.y;\n        float left = frustumPlanes.z;\n        float right = frustumPlanes.w;\n\n        float distanceToPixel = -positionEC.z;\n        float inverseNear = 1.0 / cameraNear;\n        float tanTheta = top * inverseNear;\n        pixelHeight = 2.0 * distanceToPixel * tanTheta / height;\n        tanTheta = right * inverseNear;\n        pixelWidth = 2.0 * distanceToPixel * tanTheta / width;\n\n        return max(pixelWidth, pixelHeight) * pixelRatio;\n    }\n    float metersPerPixel(vec4 positionEC) {\n        return metersPerPixel(positionEC, pixelRatio);\n    }\n    float fastApproximateAtan(float x) {\n        return x * (-0.1784 * x - 0.0663 * x * x + 1.0301);\n    }\n    float fastApproximateAtan(float x, float y) {\n        float t = abs(x);\n        float opposite = abs(y);\n        float adjacent = max(t, opposite);\n        opposite = min(t, opposite);\n        t = fastApproximateAtan(opposite / adjacent);\n        t = branchFreeTernary(abs(y) > abs(x), piOverTwo - t, t);\n        t = branchFreeTernary(x < 0.0, pi - t, t);\n        t = branchFreeTernary(y < 0.0, -t, t);\n        return t;\n    }\n\n    void main() {\n        vUUv = textureUV;\n        vec3 ecStart = (viewMatrix * vec4(startPosition, 1.0)).xyz;\n        vec3 offset = normalMatrix * forwardOffset;\n        vec3 ecEnd = ecStart + offset;\n        vec3 forwardDirectionEC = normalize(offset);\n        vec4 startPlaneEC;\n        startPlaneEC.xyz = normalMatrix * startNormal;\n        startPlaneEC.w = -dot(startPlaneEC.xyz, ecStart);\n        vec4 endPlaneEC;\n        endPlaneEC.xyz = normalMatrix * endNormal;\n        endPlaneEC.w = -dot(endPlaneEC.xyz, ecEnd);\n        v_rightPlaneEC.xyz = normalMatrix * rightNormal;\n        v_rightPlaneEC.w = -dot(v_rightPlaneEC.xyz, ecStart);\n        v_texcoordNormalizationAndStartEcYZ.x = abs(texcoordNormalization.x);\n        v_texcoordNormalizationAndStartEcYZ.y = texcoordNormalization.y;\n\n        v_endEcAndStartEcX.xyz = ecEnd;\n        v_endEcAndStartEcX.w = ecStart.x;\n        v_texcoordNormalizationAndStartEcYZ.zw = ecStart.yz;\n\n        vec4 positionEC = viewMatrix * vec4(position, 1.0);\n        float absStartPlaneDistance = abs(planeDistance(startPlaneEC, positionEC.xyz));\n        float absEndPlaneDistance = abs(planeDistance(endPlaneEC, positionEC.xyz));\n        vec3 planeDirection = branchFreeTernary(absStartPlaneDistance < absEndPlaneDistance, startPlaneEC.xyz, endPlaneEC.xyz);\n        vec3 upOrDown = normalize(cross(v_rightPlaneEC.xyz, planeDirection));\n        vec3 normalEC = normalize(cross(planeDirection, upOrDown));    \n        upOrDown = cross(forwardDirectionEC, normalEC);\n        upOrDown = float(v_texcoordNormalizationAndStartEcYZ.y > 1.0 || v_texcoordNormalizationAndStartEcYZ.y < 0.0) * upOrDown;\n        upOrDown = min(GLOBE_MINIMUM_ALTITUDE, geometricToleranceOverMeter * length(positionEC.xyz)) * upOrDown;\n        positionEC.xyz += upOrDown;\n        v_texcoordNormalizationAndStartEcYZ.y = branchFreeTernary(v_texcoordNormalizationAndStartEcYZ.y > 1.0, 0.0, abs(v_texcoordNormalizationAndStartEcYZ.y));\n        float width = lineWidth;\n\n        v_startPlaneNormalEcAndHalfWidth.xyz = startPlaneEC.xyz;\n        v_startPlaneNormalEcAndHalfWidth.w = width * 0.5;\n        v_endPlaneNormalEc = endPlaneEC.xyz;\n        width = width * max(0.0, metersPerPixel(positionEC));\n        width = width / dot(normalEC, v_rightPlaneEC.xyz);\n        normalEC *= sign(texcoordNormalization.x);\n\n        positionEC.xyz += width * normalEC;\n        vec4 mvPosition = positionEC;\n        gl_Position = projectionMatrix * mvPosition;\n\n        vec2 approxLineDirection = normalize(vec2(forwardDirectionEC.x, -forwardDirectionEC.y));\n        approxLineDirection.y = branchFreeTernary(approxLineDirection.x == 0.0 && approxLineDirection.y == 0.0, -1.0, approxLineDirection.y);\n        v_polylineAngle = fastApproximateAtan(approxLineDirection.x, approxLineDirection.y);\n\n        #include <logdepthbuf_vertex>\n        #include <clipping_planes_vertex>\n        #include <fog_vertex>\n    }\n\n    ",fragmentShader:"\n    precision highp float;\n    precision highp int;\n\n    #include <common>\n    #include <fog_pars_fragment>\n    #include <logdepthbuf_pars_fragment>\n\n    #include <clipping_planes_pars_fragment>\n    #include <packing>\n    #include <depth_parse_fragment>\n\n    const float maskLength = 16.0;\n    uniform vec3 diffuse;\n    uniform float opacity;\n    uniform float pixelRatio;\n    uniform sampler2D globeDepthTexture;\n    uniform sampler2D customDepthTexture;\n    uniform int dashMode;\n    uniform float dashSize;\n    uniform vec4 frustumPlanes;\n    uniform int clampMode;\n\n    #ifdef USE_MAP\n    uniform sampler2D map;\n    uniform mat3 uvTransform;\n#endif\n    uniform float visibility;\n    uniform bool enableColorOverride;\n    uniform bool enableAnimation;\n    uniform bool isTrail;\n\n    varying vec2 vUUv;\n    const float uvXOffset = 0.06;\n\n    varying vec4 v_startPlaneNormalEcAndHalfWidth;\n    varying vec3 v_endPlaneNormalEc;\n    varying vec4 v_rightPlaneEC;\n    varying vec4 v_endEcAndStartEcX;\n    varying vec4 v_texcoordNormalizationAndStartEcYZ;\n    varying float v_polylineAngle;\n\n    float metersPerPixel(vec4 positionEC, float pixelRatio) {\n        float width = viewport.z;\n        float height = viewport.w;\n        float pixelWidth;\n        float pixelHeight;\n        float top = frustumPlanes.x;\n        float bottom = frustumPlanes.y;\n        float left = frustumPlanes.z;\n        float right = frustumPlanes.w;\n\n        float distanceToPixel = -positionEC.z;\n        float inverseNear = 1.0 / cameraNear;\n        float tanTheta = top * inverseNear;\n        pixelHeight = 2.0 * distanceToPixel * tanTheta / height;\n        tanTheta = right * inverseNear;\n        pixelWidth = 2.0 * distanceToPixel * tanTheta / width;\n\n        return max(pixelWidth, pixelHeight) * pixelRatio;\n    }\n    float metersPerPixel(vec4 positionEC) {\n        return metersPerPixel(positionEC, pixelRatio);\n    }\n    float planeDistance(vec4 plane, vec3 point) {\n        return (dot(plane.xyz, point) + plane.w);\n    }\n    float planeDistance(vec3 planeNormal, float planeDistance, vec3 point) {\n        return (dot(planeNormal, point) + planeDistance);\n    }\n    mat2 rotate(float rad) {\n        float c = cos(rad);\n        float s = sin(rad);\n        return mat2(\n        c, s, -s, c\n        );\n    }\n\n    void main() {\n        #include <clipping_planes_fragment>\n        if(isTrail){\n            if(vUUv.y*2.0 > visibility) discard;\n        }\n\n        vec2 uv = gl_FragCoord.xy / viewport.zw;\n        vec4 depthColor = texture2D(globeDepthTexture, uv);\n        float depth = unpackRGBAToDepth(depthColor);\n        if (depth == 0.0) {\n            discard;\n        }\n        vec4 customColor = texture2D(customDepthTexture, uv);\n        float customDepth = unpackRGBAToDepth(customColor);\n        if (clampMode == 0) { //discard external components\n            if (customDepth > 0.6) {\n                discard;\n            }\n        }\n        else if (clampMode == 1) { //only clamp to ground\n            if (customDepth > 0.4) {\n                discard;\n            }\n        } else if (clampMode == 2) { //only clamp to model\n            if (customDepth < 0.1 || customDepth > 0.6) {\n                discard;\n            }\n        }\n        vec3 viewPosition = getViewPosition(depth);\n        vec3 ecStart = vec3(v_endEcAndStartEcX.w, v_texcoordNormalizationAndStartEcYZ.zw);\n        float halfMaxWidth = v_startPlaneNormalEcAndHalfWidth.w * metersPerPixel(vec4(viewPosition.xyz, 1.0));\n        float widthwiseDistance = planeDistance(v_rightPlaneEC, viewPosition.xyz);\n        float distanceFromStart = planeDistance(v_startPlaneNormalEcAndHalfWidth.xyz, -dot(ecStart, v_startPlaneNormalEcAndHalfWidth.xyz), viewPosition.xyz);\n        float distanceFromEnd = planeDistance(v_endPlaneNormalEc.xyz, -dot(v_endEcAndStartEcX.xyz, v_endPlaneNormalEc.xyz), viewPosition.xyz);\n        if (abs(widthwiseDistance) > halfMaxWidth || distanceFromStart < 0.0 || distanceFromEnd < 0.0) {\n            discard;\n        }\n        \n        vec4 diffuseColor = vec4( diffuse, opacity );\n        vec4 fragColor = diffuseColor;\n\n        if (dashMode > 0){\n            vec2 pos = rotate(v_polylineAngle) * gl_FragCoord.xy;\n            float dashPosition = fract(pos.x / (max(1.0, dashSize) * pixelRatio));\n            float maskIndex = floor(dashPosition * maskLength);\n            float maskTest = floor(255.0 / pow(2.0, maskIndex));\n            fragColor = (mod(maskTest, 2.0) < 1.0) ? vec4(1.0, 1.0, 1.0, 0.0) : diffuseColor;\n            if (fragColor.a < 0.005) {\n                discard;\n            }\n        }\n\n        #ifdef USE_MAP\n            vec2 usv = vUUv;\n            usv = ( uvTransform * vec3( usv, 1 ) ).xy;\n            vec2 centerUVPos;\n            if(enableAnimation && !isTrail){\n                centerUVPos = vec2(usv.x + uvXOffset , usv.y*1.0);\n            }else{\n                centerUVPos = vec2(usv.x + uvXOffset , usv.y*2.0);\n            }\n            vec4 textureColor;\n            if(!enableColorOverride){\n                textureColor = texture2D( map,centerUVPos ).rgba;\n            }else{\n                float pAlpha = texture2D( map,centerUVPos ).a;\n                textureColor = fragColor;\n                textureColor.a = pAlpha;\n            }\n            gl_FragColor = textureColor;\n\n        #else\n            #include <logdepthbuf_fragment>\n            gl_FragColor = fragColor;\n            #include <premultiplied_alpha_fragment>\n            #if defined( TONE_MAPPING )\n                gl_FragColor.rgb = toneMapping( gl_FragColor.rgb );\n            #endif\n            #ifdef USE_FOG\n                #ifdef FOG_EXP2\n                    float fogFactor = whiteCompliment( exp2( - fogDensity * fogDensity * fogDepth * fogDepth * LOG2 ) );\n                #else\n                    float fogFactor = smoothstep( fogNear, fogFar, fogDepth );\n                #endif\n                gl_FragColor.rgb = mix( gl_FragColor.rgb, fogColor, fogFactor );\n            #endif\n        #endif\n\n    }\n\n    "},r.ShaderPass2=function(e,t){this.enabled=!0,this.needsSwap=!0,this.clear=!1,this.renderToScreen=!1,this.textureID=void 0!==t?t:"tDiffuse",e&&(this.uniforms=THREE.UniformsUtils.clone(e.uniforms),this.material=new THREE.ShaderMaterial({defines:e.defines||{},uniforms:this.uniforms,vertexShader:e.vertexShader,fragmentShader:e.fragmentShader})),this.camera=new THREE.OrthographicCamera(-1,1,1,-1,0,1),this.scene=new THREE.Scene,this.quad=new THREE.Mesh(new THREE.PlaneBufferGeometry(2,2),null),this.quad.frustumCulled=!1,this.scene.add(this.quad)},r.ShaderPass2.prototype={constructor:r.ShaderPass2,render:function(e,t,i,r){this.uniforms[this.textureID]&&(this.uniforms[this.textureID].value=i.texture),this.quad.material=this.material,this.renderToScreen?e.render(this.scene,this.camera):e.render(this.scene,this.camera,t,this.clear)}};new THREE.Vector3(0,0,0),["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),["uniform sampler2D tDiffuse;","uniform sampler2D tID;","uniform int objID;","uniform vec3 objIDv3;","uniform float highlightIntensity;","varying vec2 vUv;","void main() {","vec4 texel = texture2D( tDiffuse, vUv );","if (objID != 0) {","vec4 idAtPixel = texture2D(tID, vUv);","vec3 idDelta = abs(idAtPixel.rgb - objIDv3.rgb);","if (max(max(idDelta.r, idDelta.g), idDelta.b) < 1e-3) {","texel.rgb += highlightIntensity * 0.2;","}","}","gl_FragColor = texel;","}"].join("\n");(()=>{class e extends THREE.ShaderMaterial{constructor(e){super(),this.type="PhongLightingMaterial",this.color=new THREE.Color(16777215),this.specular=new THREE.Color(1118481),this.shininess=30,this.emissive=new THREE.Color(0),this.isShaderMaterial=!0,this.map=null,this.defines={},this.backSceneTexture=null,this.viewportSize=new THREE.Vector2(0,0),this.uniforms=THREE.UniformsUtils.merge([THREE.UniformsLib.common,THREE.UniformsLib.lights,{diffuse:{value:new THREE.Color(16711680)},opacity:{value:1},specular:{value:new THREE.Color(1118481)},shininess:{value:30},emissive:{value:new THREE.Color(0)},backSceneTexture:{value:null},viewportSize:{value:new THREE.Vector2(0,0)}}]),this.vertexShader=["varying vec3 vViewPosition;","varying vec3 vNormal;","#include <uv_pars_vertex>","#include <common>","#include <logdepthbuf_pars_vertex>","#include <shadowmap_pars_vertex>","void main() {","   #include <uv_vertex>","   #include <begin_vertex>","   #include <project_vertex>","\t#include <logdepthbuf_vertex>","   #include <beginnormal_vertex>","   #include <defaultnormal_vertex>","   vNormal = normalize( transformedNormal );","   vViewPosition = - mvPosition.xyz;","}"].join("\n"),this.fragmentShader=["uniform vec3 diffuse;","uniform float opacity;","uniform vec3 specular;","uniform float shininess;","uniform vec3 emissive;","#include <common>","#include <uv_pars_fragment>","#include <map_pars_fragment>","#include <packing>","#include <bsdfs>","#include <lights_pars_begin>","#include <lights_phong_pars_fragment>","#include <specularmap_pars_fragment>","#include <shadowmap_pars_fragment>","#include <logdepthbuf_pars_fragment>","#ifdef USE_CAP","uniform sampler2D backSceneTexture;","uniform vec2 viewportSize;","#endif","void main() {","\t#include <logdepthbuf_fragment>","   vec4 diffuseColor = vec4( diffuse, opacity );","#ifdef USE_MAP","   vec4 texelColor = texture2D( map, vUv );","   texelColor = mapTexelToLinear( texelColor );","   diffuseColor = vec4(texelColor.rgb, opacity);","#endif","   ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );","   vec3 totalEmissiveRadiance = emissive;","   float specularStrength = 1.0;","   #include <normal_fragment_begin>","   #include <normal_fragment_maps>","   #include <lights_phong_fragment>","   #include <lights_template>","   vec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveRadiance;","   gl_FragColor = vec4( outgoingLight, diffuseColor.a );","   #if defined( TONE_MAPPING )","       gl_FragColor.rgb = toneMapping( gl_FragColor.rgb );","   #endif","   gl_FragColor = linearToOutputTexel( gl_FragColor );","#ifdef USE_CAP","vec2 screenUV = vec2(gl_FragCoord.x/viewportSize.x,gl_FragCoord.y/viewportSize.y);","vec4 backColor = texture2D(backSceneTexture, screenUV);","gl_FragColor = texture2D(backSceneTexture, screenUV);","#endif","}"].join("\n"),this.lights=!0,this.defaultAttributeValues={color:[1,1,1],uv:[0,0],uv2:[0,0]},void 0!==e&&(void 0!==e.attributes&&console.error("PhongLightingMaterial: attributes should now be defined in THREE.BufferGeometry instead."),this.setValues(e)),this.refreshUniforms()}copy(e){return super.copy(e),this.color.copy(e.color),this.specular.copy(e.specular),this.shininess=e.shininess,this.emissive.copy(e.emissive),this}refreshUniforms(){this.uniforms.diffuse.value.set(this.color),this.uniforms.opacity.value=this.opacity,this.uniforms.specular.value.set(this.specular),this.uniforms.shininess.value=this.shininess,this.uniforms.emissive.value.set(this.emissive),this.uniforms.map.value=this.map,this.uniforms.backSceneTexture.value=this.backSceneTexture,this.uniforms.viewportSize.value=this.viewportSize}}r.PhongLightingMaterial=e})();var L=["GeometricContext geometry;","geometry.position = - vViewPosition;","#if NUM_CLIPPING_PLANES == 1","\tif (gl_FrontFacing) geometry.normal = normal;","\telse if (fillFaceClipDistance < 0.0) geometry.normal = -clippingPlanes[0].xyz;","\telse geometry.normal = -normal;","#else","\tgeometry.normal = normal;","#endif","geometry.viewDir = normalize( vViewPosition );","IncidentLight directLight;","#if ( NUM_POINT_LIGHTS > 0 ) && defined( RE_Direct )","\tPointLight pointLight;","   #if defined( USE_SHADOWMAP ) && (NUM_POINT_LIGHT_SHADOWS > 0)","  PointLightShadow pointLightShadow;","   #endif","\t#pragma unroll_loop_start","\tfor ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {","\t\tpointLight = pointLights[ i ];","\t\tgetPointLightInfo( pointLight, geometry, directLight );","\t\t#if defined( USE_SHADOWMAP ) && (NUM_POINT_LIGHT_SHADOWS > 0)  && ( UNROLLED_LOOP_INDEX < NUM_POINT_LIGHT_SHADOWS )","\t\tpointLightShadow = pointLightShadows[ i ];","\t\tdirectLight.color *= all( bvec2( receiveShadow, directLight.visible ) ) ? getPointShadow( pointShadowMap[ i ], pointLightShadow.shadowMapSize, pointLightShadow.shadowBias, pointLightShadow.shadowRadius, vPointShadowCoord[ i ] ) : 1.0;","\t\t#endif","\t\tRE_Direct( directLight, geometry, material, reflectedLight );","\t}","   #pragma unroll_loop_end","#endif","#if ( NUM_SPOT_LIGHTS > 0 ) && defined( RE_Direct )","\tSpotLight spotLight;","   #if defined( USE_SHADOWMAP ) && (NUM_SPOT_LIGHT_SHADOWS > 0)","        SpotLightShadow spotLightShadow;","   #endif","\t#pragma unroll_loop_start","\tfor ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {","\t\tspotLight = spotLights[ i ];","\t\tgetSpotLightInfo( spotLight, geometry, directLight );","\t\t#if defined( USE_SHADOWMAP )  && (NUM_SPOT_LIGHT_SHADOWS > 0)  && ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS )","       spotLightShadow = spotLightShadows[ i ];","\t\tdirectLight.color *= all( bvec2( receiveShadow, directLight.visible ) ) ? getShadow( spotShadowMap[ i ], spotLightShadow.shadowMapSize, spotLightShadow.shadowBias, spotLightShadow.shadowRadius, vSpotShadowCoord[ i ] ) : 1.0;","\t\t#endif","\tRE_Direct( directLight, geometry, material, reflectedLight );","\t}","   #pragma unroll_loop_end","#endif","#if ( NUM_DIR_LIGHTS > 0 ) && defined( RE_Direct )","\tDirectionalLight directionalLight;","   #if defined( USE_SHADOWMAP ) && NUM_DIR_LIGHT_SHADOWS > 0","      DirectionalLightShadow directionalLightShadow;","\t#endif","\t#pragma unroll_loop_start","\tfor ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {","\t\tdirectionalLight = directionalLights[ i ];","\t\tgetDirectionalDirectLightIrradiance( directionalLight, geometry, directLight );","\t\t#if defined( USE_SHADOWMAP )  && (NUM_DIR_LIGHT_SHADOWS > 0)  && ( UNROLLED_LOOP_INDEX < NUM_DIR_LIGHT_SHADOWS )","\t\tdirectionalLightShadow = directionalLightShadows[ i ];","\t\tdirectLight.color *= all( bvec2( receiveShadow, directLight.visible ) ) ? getShadow( directionalShadowMap[ i ], directionalLightShadow.shadowMapSize, directionalLightShadow.shadowBias, directionalLightShadow.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;","\t\t#endif","\t\tRE_Direct( directLight, geometry, material, reflectedLight );","\t}","   #pragma unroll_loop_end","#endif","#if ( NUM_RECT_AREA_LIGHTS > 0 ) && defined( RE_Direct_RectArea )","\tRectAreaLight rectAreaLight;","\tfor ( int i = 0; i < NUM_RECT_AREA_LIGHTS; i ++ ) {","\t\trectAreaLight = rectAreaLights[ i ];","\t\tRE_Direct_RectArea( rectAreaLight, geometry, material, reflectedLight );","\t}","#endif","#if defined( RE_IndirectDiffuse )","\tvec3 irradiance = getAmbientLightIrradiance( ambientLightColor );","\t#ifdef USE_LIGHTMAP","\t\tvec3 lightMapIrradiance = texture2D( lightMap, vUv2 ).xyz * lightMapIntensity;","\t\t#ifndef PHYSICALLY_CORRECT_LIGHTS","\t\t\tlightMapIrradiance *= PI; // factor of PI should not be present; included here to prevent breakage","\t\t#endif","\t\tirradiance += lightMapIrradiance;","\t#endif","\t#if ( NUM_HEMI_LIGHTS > 0 )","\t\tfor ( int i = 0; i < NUM_HEMI_LIGHTS; i ++ ) {","\t\t\tirradiance += getHemisphereLightIrradiance( hemisphereLights[ i ], geometry );","\t\t}","\t#endif","\t#if defined( USE_ENVMAP ) && defined( PHYSICAL ) && defined( ENVMAP_TYPE_CUBE_UV )","\t\tirradiance += getLightProbeIndirectIrradiance( /*lightProbe,*/ geometry, 8 );","\t#endif","\tRE_IndirectDiffuse( irradiance, geometry, material, reflectedLight );","#endif","#if defined( USE_ENVMAP ) && defined( RE_IndirectSpecular )","\tvec3 radiance = getLightProbeIndirectRadiance( geometry.viewDir, geometry.normal, material.specularRoughness, 8 );","\t#ifndef STANDARD","\t\tvec3 clearCoatRadiance = getLightProbeIndirectRadiance( geometry.viewDir, geometry.clearcoatNormal, material.clearcoatRoughness, 8 );","\t#else","\t\tvec3 clearCoatRadiance = vec3( 0.0 );","\t#endif","\tRE_IndirectSpecular( radiance, irradiance, clearCoatRadiance, geometry, material, reflectedLight ); ","#endif"].join("\n");r.LightsTemplateShader="\n    GeometricContext geometry;\n\n    geometry.position = - vViewPosition;\n    geometry.normal = normal;\n    geometry.viewDir = normalize( vViewPosition );\n    \n    IncidentLight directLight;\n    \n    #if ( NUM_POINT_LIGHTS > 0 ) && defined( RE_Direct )\n    \n\t\tPointLight pointLight;\n\t\t#if defined( USE_SHADOWMAP ) && (NUM_POINT_LIGHT_SHADOWS > 0)\n\t\t\tPointLightShadow pointLightShadow;\n\t\t#endif\n\t\t#pragma unroll_loop_start\n    \tfor ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {\n    \n    \t\tpointLight = pointLights[ i ];\n    \t\tgetPointLightInfo( pointLight, geometry, directLight );\n    \n\t\t\t#if defined( USE_SHADOWMAP ) && (NUM_POINT_LIGHT_SHADOWS > 0) && ( UNROLLED_LOOP_INDEX < NUM_POINT_LIGHT_SHADOWS )\n\t\t\tpointLightShadow = pointLightShadows[ i ];;\n    \t\tdirectLight.color *= all( bvec2( receiveShadow, directLight.visible ) ) ? getPointShadow( pointShadowMap[ i ], pointLightShadow.shadowMapSize, pointLightShadow.shadowBias, pointLightShadow.shadowRadius, vPointShadowCoord[ i ] ) : 1.0;\n    \t\t#endif\n    \n    \t\tRE_Direct( directLight, geometry, material, reflectedLight );\n    \n\t\t}\n\t\t#pragma unroll_loop_end\n    \n    #endif\n    \n    #if ( NUM_SPOT_LIGHTS > 0 ) && defined( RE_Direct )\n    \n\t\tSpotLight spotLight;\n\n\t    #if defined( USE_SHADOWMAP ) && (NUM_SPOT_LIGHT_SHADOWS > 0)\n            SpotLightShadow spotLightShadow;\n\t\t#endif\n\t\t\n\t\t#pragma unroll_loop_start\n    \tfor ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {\n    \n    \t\tspotLight = spotLights[ i ];\n    \t\tgetSpotLightInfo( spotLight, geometry, directLight );\n    \n\t\t\t#if defined( USE_SHADOWMAP ) && (NUM_SPOT_LIGHT_SHADOWS > 0)  && ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS )\n\t\t\tspotLightShadow = spotLightShadows[ i ];\n    \t\tdirectLight.color *= all( bvec2( receiveShadow, directLight.visible ) ) ? getShadow( spotShadowMap[ i ], spotLightShadow.shadowMapSize, spotLightShadow.shadowBias, spotLightShadow.shadowRadius, vSpotShadowCoord[ i ] ) : 1.0;\n    \t\t#endif\n    \n    \t\tRE_Direct( directLight, geometry, material, reflectedLight );\n    \n\t\t}\n\t\t#pragma unroll_loop_end\n    \n    #endif\n    \n    #if ( NUM_DIR_LIGHTS > 0 ) && defined( RE_Direct )\n    \n\t\tDirectionalLight directionalLight;\n\t\t#if defined( USE_SHADOWMAP ) && NUM_DIR_LIGHT_SHADOWS > 0\n\t\t    DirectionalLightShadow directionalLightShadow;\n\t\t#endif\n\t\t#pragma unroll_loop_start\n    \tfor ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n    \n    \t\tdirectionalLight = directionalLights[ i ];\n\t\t\tgetDirectionalDirectLightIrradiance( directionalLight, geometry, directLight );\n    \t\t//r142\n\t\t\t//getDirectionalLightInfo( directionalLight, geometry, directLight );\n    \n\t\t\t#if defined( USE_SHADOWMAP )  && (NUM_DIR_LIGHT_SHADOWS > 0) && ( UNROLLED_LOOP_INDEX < NUM_DIR_LIGHT_SHADOWS )\n\t\t\tdirectionalLightShadow = directionalLightShadows[ i ];\n    \t\tdirectLight.color *= all( bvec2( receiveShadow, directLight.visible ) ) ? getShadow( directionalShadowMap[ i ], directionalLightShadow.shadowMapSize, directionalLightShadow.shadowBias, directionalLightShadow.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;\n    \t\t#endif\n    \n    \t\tRE_Direct( directLight, geometry, material, reflectedLight );\n    \n\t\t}\n\t\t#pragma unroll_loop_end\n    \n    #endif\n    \n    #if ( NUM_RECT_AREA_LIGHTS > 0 ) && defined( RE_Direct_RectArea )\n    \n    \tRectAreaLight rectAreaLight;\n    \n    \tfor ( int i = 0; i < NUM_RECT_AREA_LIGHTS; i ++ ) {\n    \n    \t\trectAreaLight = rectAreaLights[ i ];\n    \t\tRE_Direct_RectArea( rectAreaLight, geometry, material, reflectedLight );\n    \n    \t}\n    \n    #endif\n    \n    #if defined( RE_IndirectDiffuse )\n    \n    \tvec3 irradiance = getAmbientLightIrradiance( ambientLightColor );\n    \n    \t#ifdef USE_LIGHTMAP\n    \n    \t\tvec3 lightMapIrradiance = texture2D( lightMap, vUv2 ).xyz * lightMapIntensity;\n    \n    \t\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n    \n    \t\t\tlightMapIrradiance *= PI; // factor of PI should not be present; included here to prevent breakage\n    \n    \t\t#endif\n    \n    \t\tirradiance += lightMapIrradiance;\n    \n    \t#endif\n    \n    \t#if ( NUM_HEMI_LIGHTS > 0 )\n    \n    \t\tfor ( int i = 0; i < NUM_HEMI_LIGHTS; i ++ ) {\n    \n    \t\t\tirradiance += getHemisphereLightIrradiance( hemisphereLights[ i ], geometry );\n    \n    \t\t}\n    \n    \t#endif\n    \n    \t#if defined( USE_ENVMAP ) && defined( PHYSICAL ) && defined( ENVMAP_TYPE_CUBE_UV )\n    \n    \t\t// TODO, replace 8 with the real maxMIPLevel\n    \t\tirradiance += getLightProbeIndirectIrradiance( /*lightProbe,*/ geometry, 8 );\n    \n    \t#endif\n    \n    \tRE_IndirectDiffuse( irradiance, geometry, material, reflectedLight );\n    \n    #endif\n    \n    #if defined( USE_ENVMAP ) && defined( RE_IndirectSpecular )\n\n    \t// TODO, replace 8 with the real maxMIPLevel\n    \tvec3 radiance = getLightProbeIndirectRadiance(  geometry.viewDir, geometry.normal, material.specularRoughness, 8 );\n    \n    \t#ifndef STANDARD\n    \t\tvec3 clearCoatRadiance = getLightProbeIndirectRadiance( geometry.viewDir, geometry.clearcoatNormal, material.clearcoatRoughness, 8 );\n    \t#else\n    \t\tvec3 clearCoatRadiance = vec3( 0.0 );\n    \t#endif\n    \n    \tRE_IndirectSpecular( radiance, irradiance, clearCoatRadiance, geometry, material, reflectedLight );\n    \n    #endif\n    ";var O=["#define PHONG","uniform vec3 diffuse;","uniform vec3 emissive;","uniform vec3 specular;","uniform float shininess;","uniform float opacity;","#include <common>","#include <packing>","#include <dithering_pars_fragment>","#include <color_pars_fragment>","#include <uv_pars_fragment>","#include <uv2_pars_fragment>","#include <map_pars_fragment>","#include <alphamap_pars_fragment>","#include <aomap_pars_fragment>","#include <lightmap_pars_fragment>","#include <emissivemap_pars_fragment>","#include <envmap_pars_fragment>","#include <gradientmap_pars_fragment>","#include <fog_pars_fragment>","#include <bsdfs>","#include <lights_pars_begin>","#include <lights_phong_pars_fragment>","#include <shadowmap_pars_fragment>","#include <bumpmap_pars_fragment>","#include <normalmap_pars_fragment>","#include <specularmap_pars_fragment>","#include <logdepthbuf_pars_fragment>","#include <clipping_planes_pars_fragment>","#include <lights_physical_pars_fragment>","#include <envmap_common_pars_fragment>","#include <envmap_physical_pars_fragment>","void main() {","\t#include <clipping_planes_fragment>","\tvec4 diffuseColor = vec4( diffuse, opacity );","\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );","\tvec3 totalEmissiveRadiance = emissive;","\t#include <logdepthbuf_fragment>","\t#include <map_fragment>","\t#include <color_fragment>","\t#include <alphamap_fragment>","\t#include <alphatest_fragment>","\t#include <specularmap_fragment>","\t#include <normal_flip>","\t#include <normal_fragment_begin>","\t#include <emissivemap_fragment>","   float fillFaceClipDistance = 0.0;","   #if NUM_CLIPPING_PLANES == 1","       vec4 plane = clippingPlanes[ 0 ];","\t    fillFaceClipDistance = dot( vViewPosition, plane.xyz ) - plane.w;","   #endif","\t#include <lights_phong_fragment>","\t#include <lights_fillFace_template>","\t#include <aomap_fragment>","\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveRadiance;","\t#include <envmap_fragment>","\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );","\t#include <tonemapping_fragment>","\t#include <encodings_fragment>","\t#include <premultiplied_alpha_fragment>","\t#include <dithering_fragment>","   #include <fog_fragment>","}"].join("\n"),P=["#define PHONG","varying vec3 vViewPosition;","#ifndef FLAT_SHADED","varying vec3 vNormal;","#endif","#include <common>","#include <uv_pars_vertex>","#include <uv2_pars_vertex>","#include <displacementmap_pars_vertex>","#include <envmap_pars_vertex>","#include <color_pars_vertex>","#include <fog_pars_vertex>","#include <morphtarget_pars_vertex>","#include <skinning_pars_vertex>","#include <shadowmap_pars_vertex>","#include <logdepthbuf_pars_vertex>","#include <clipping_planes_pars_vertex>","void main() {","#include <uv_vertex>","#include <uv2_vertex>","#include <color_vertex>","#include <beginnormal_vertex>","#include <morphnormal_vertex>","#include <skinbase_vertex>","#include <skinnormal_vertex>","#include <defaultnormal_vertex>","#ifndef FLAT_SHADED","vNormal = normalize( transformedNormal );","#endif","#include <begin_vertex>","#include <displacementmap_vertex>","#include <morphtarget_vertex>","#include <skinning_vertex>","#include <project_vertex>","#include <logdepthbuf_vertex>","#include <clipping_planes_vertex>","vViewPosition = - mvPosition.xyz;","#include <worldpos_vertex>","#include <envmap_vertex>","#include <shadowmap_vertex>","#include <fog_vertex>","}"].join("\n"),D=["#define PHYSICAL","varying vec3 vViewPosition;","#ifndef FLAT_SHADED","varying vec3 vNormal;","#endif","#include <common>","#include <uv_pars_vertex>","#include <uv2_pars_vertex>","#include <displacementmap_pars_vertex>","#include <color_pars_vertex>","#include <fog_pars_vertex>","#include <morphtarget_pars_vertex>","#include <skinning_pars_vertex>","#include <shadowmap_pars_vertex>","#include <specularmap_pars_fragment>","#include <logdepthbuf_pars_vertex>","#include <clipping_planes_pars_vertex>","void main() {","#include <uv_vertex>","#include <uv2_vertex>","#include <color_vertex>","#include <beginnormal_vertex>","#include <morphnormal_vertex>","#include <skinbase_vertex>","#include <skinnormal_vertex>","#include <defaultnormal_vertex>","#ifndef FLAT_SHADED","vNormal = normalize( transformedNormal );","#endif","#include <begin_vertex>","#include <displacementmap_vertex>","#include <morphtarget_vertex>","#include <skinning_vertex>","#include <project_vertex>","#include <logdepthbuf_vertex>","#include <clipping_planes_vertex>","vViewPosition = - mvPosition.xyz;","#include <worldpos_vertex>","#include <shadowmap_vertex>","#include <fog_vertex>","}"].join("\n"),A=["#define PHYSICAL","uniform vec3 diffuse;","uniform vec3 emissive;","uniform float roughness;","uniform float metalness;","uniform float opacity;","#ifndef STANDARD","uniform float clearCoat;","uniform float clearCoatRoughness;","#endif","varying vec3 vViewPosition;","#ifndef FLAT_SHADED","varying vec3 vNormal;","#endif","#include <common>","#include <packing>","#include <dithering_pars_fragment>","#include <color_pars_fragment>","#include <uv_pars_fragment>","#include <uv2_pars_fragment>","#include <map_pars_fragment>","#include <alphamap_pars_fragment>","#include <aomap_pars_fragment>","#include <lightmap_pars_fragment>","#include <emissivemap_pars_fragment>","#include <envmap_pars_fragment>","#include <fog_pars_fragment>","#include <bsdfs>","#include <cube_uv_reflection_fragment>","#include <lights_pars_begin>","#include <lights_physical_pars_fragment>","#include <shadowmap_pars_fragment>","#include <bumpmap_pars_fragment>","#include <normalmap_pars_fragment>","#include <roughnessmap_pars_fragment>","#include <metalnessmap_pars_fragment>","#include <logdepthbuf_pars_fragment>","#include <clipping_planes_pars_fragment>","void main() {","#include <clipping_planes_fragment>","vec4 diffuseColor = vec4( diffuse, opacity );","vec3 totalEmissiveRadiance = emissive;","#include <logdepthbuf_fragment>","#include <map_fragment>","#include <color_fragment>","#include <alphamap_fragment>","#include <alphatest_fragment>","#include <specularmap_fragment>","#include <roughnessmap_fragment>","#include <metalnessmap_fragment>","#include <normal_flip>","#include <normal_fragment_begin>","#include <emissivemap_fragment>","const mat4 diffuseMatrix = mat4(-0.07425443828105927, -0.05652861297130585, 0.12247831374406815, 0.2297295778989792,","                               -0.05652860924601555, 0.034799136221408844, -0.08437120914459229, -0.13896968960762024,","                               0.12247832119464874, -0.08437121659517288, 0.021763987839221954, 0.12510454654693604,","                               0.2297295778989792, -0.13896968960762024, 0.12510454654693604, 0.6190560460090637);","const vec3 sunDir = vec3(-0.6632131338119507, 0.5486575961112976, -0.509041428565979);","vec3 viewDir = normalize( vViewPosition );","vec4 diffuseDir = diffuseMatrix * vec4(normal, 1.0);","float diffuseTerm = dot(vec4(normal, 1.0), diffuseDir);","float nv = max(dot(normal, -viewDir), 0.0);","float vl = max(dot(viewDir, sunDir), 0.0);","diffuseTerm = diffuseTerm + (nv * (1.0 - vl)) * 0.8;","vec3 H = -normalize(sunDir + viewDir);","float nh = max(dot(normal, H), 0.0);","float specularTerm = pow(nh, 100.0);","vec3 color = 1.05 * vec3(0.5, 0.497, 0.49) * (diffuse * diffuseTerm + vec3(specularTerm)) + diffuse * 0.5;","vec3 outgoingLight = color + totalEmissiveRadiance;","gl_FragColor = vec4( outgoingLight, diffuseColor.a );","#include <tonemapping_fragment>","#include <encodings_fragment>","#include <premultiplied_alpha_fragment>","#include <dithering_fragment>","#include <fog_fragment>","}"].join("\n"),N=["#define PHYSICAL","varying vec3 vViewPosition;","#ifndef FLAT_SHADED","varying vec3 vNormal;","#endif","#ifdef USE_INSTANCE","   attribute float vState;","   attribute float vState2;","   attribute float vClipping;","#if NUM_CLIPPING_PLANES > 0","   varying float fClipping;","#endif","   varying float fState;","   attribute vec4 aColor;","   varying vec4 vaColor;","   attribute vec3 mcol0;","   attribute vec3 mcol1;","   attribute vec3 mcol2;","   attribute vec3 mcol3;","   #if defined(USE_MAP)||defined(USE_BUMPMAP) ","       attribute vec2 muvCol0;","       attribute vec2 muvCol1;","       attribute vec2 muvCol2;","   #endif","   #if defined(USE_MULTI_BLINK_COLOR) ","       attribute vec4 bColor;","       varying vec4 vbColor;","   #endif","   #if defined(USE_LIGHTMAP)","       attribute vec4 uv2OffsetRepeat;","   #endif","#endif","#include <common>","#include <uv_pars_vertex>","#include <uv2_pars_vertex>","#include <displacementmap_pars_vertex>","#include <color_pars_vertex>","#include <fog_pars_vertex>","#include <morphtarget_pars_vertex>","#include <skinning_pars_vertex>","#include <shadowmap_pars_vertex>","#include <specularmap_pars_fragment>","#include <logdepthbuf_pars_vertex>","#include <clipping_planes_pars_vertex>","#include <view_shed_pars_vertex>","#include <video_cast_pars_vertex>","varying vec4 wPositionForInnerClipping;","#include <CompressNormal_vertex>","#include <CompressColor_vertex>","#include <heightLimit_pars_vertex>","#include <excavation_pars_vertex>","mat3 inverse_mat3(in mat3 m)","{","   float determinant =","    m[0][0] * (m[1][1] * m[2][2] - m[2][1] * m[1][2])","    - m[1][0] * (m[0][1] * m[2][2] - m[2][1] * m[0][2])","    + m[2][0] * (m[0][1] * m[1][2] - m[1][1] * m[0][2]);","    mat3 inverse;","    inverse[0][0] = + (m[1][1] * m[2][2] - m[2][1] * m[1][2]);","    inverse[1][0] = - (m[1][0] * m[2][2] - m[2][0] * m[1][2]);","    inverse[2][0] = + (m[1][0] * m[2][1] - m[2][0] * m[1][1]);","    inverse[0][1] = - (m[0][1] * m[2][2] - m[2][1] * m[0][2]);","    inverse[1][1] = + (m[0][0] * m[2][2] - m[2][0] * m[0][2]);","    inverse[2][1] = - (m[0][0] * m[2][1] - m[2][0] * m[0][1]);","    inverse[0][2] = + (m[0][1] * m[1][2] - m[1][1] * m[0][2]);","    inverse[1][2] = - (m[0][0] * m[1][2] - m[1][0] * m[0][2]);","    inverse[2][2] = + (m[0][0] * m[1][1] - m[1][0] * m[0][1]);","    inverse /= determinant;","    return inverse;","}","#ifdef USE_COMPRESS_UV","uniform vec2 uvCenter;","uniform vec2 uvHalfExtent;","vec2 uvDecode(vec2 myuv) {","    myuv = (myuv + 32768.0)* 2.0 / 65535.0 - 1.0;","    return myuv * uvHalfExtent + uvCenter;","}","#endif","void main() {","#if defined( USE_MAP ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_SPECULARMAP ) || defined( USE_ALPHAMAP ) || defined( USE_EMISSIVEMAP ) || defined( USE_ROUGHNESSMAP ) || defined( USE_METALNESSMAP )","#ifdef USE_COMPRESS_UV","   vUv = uvDecode(uv);","   vUv = ( uvTransform * vec3( vUv, 1 ) ).xy;","#else","   vUv = ( uvTransform * vec3( uv, 1 ) ).xy;","#endif","#endif","#include <uv2_vertex>","#include <color_vertex>","#include <beginnormal_vertex>","#ifdef CNORMAL","objectNormal = octDecode();","#endif","#include <morphnormal_vertex>","#include <skinbase_vertex>","#include <skinnormal_vertex>","#include <defaultnormal_vertex>","#if (defined(USE_MAP)||defined(USE_BUMPMAP)) && defined(USE_INSTANCE)  ","   vUv = vec2(mat3(vec3(muvCol0, 0.0),","                   vec3(muvCol1, 0.0),","                   vec3(muvCol2, 1.0)) * vec3(uv, 1.0));","   vUv = ( uvTransform * vec3( vUv, 1 ) ).xy;","#endif","#if defined(USE_COMPRESS_UV) && (defined(USE_LIGHTMAP) || defined(USE_AOMAP))","   vUv2 = uvDecode(vUv2);","#endif","#if defined(USE_LIGHTMAP) && defined(USE_INSTANCE)  ","   vUv2.x = uv2OffsetRepeat.x*vUv2.x/ 65535.0 + uv2OffsetRepeat.z ;","   vUv2.y = uv2OffsetRepeat.y*vUv2.y/ 65535.0 + uv2OffsetRepeat.w ;","#endif","vec3 transformed = vec3( position );","#ifdef USE_INSTANCE","vaColor = aColor;","#if NUM_CLIPPING_PLANES > 0","   fClipping = vClipping;","#endif","#if defined(USE_MULTI_BLINK_COLOR) ","   vbColor = bColor;","#endif","#ifdef INSTANCE_STATE_SECONDARY","fState = vState2;","#else","fState = vState;","#endif","transformed = vec3(mat4(vec4(mcol0, 0.0),","                   vec4(mcol1, 0.0),","                   vec4(mcol2, 0.0),","                   vec4(mcol3, 1.0)) * vec4(transformed, 1.0));","#ifdef USE_INSTANCE_NORMAL","    mat3 normalMat = mat3(mcol0, mcol1, mcol2);","    normalMat = inverse_mat3(normalMat);","    normalMat = transposeMat3(normalMat);","    transformedNormal = normalMat * objectNormal;","    transformedNormal = normalMatrix * transformedNormal;","#ifdef FLIP_SIDED","   transformedNormal = - transformedNormal;","#endif","    transformedNormal = normalize( transformedNormal );","#endif","#endif","#ifdef CCOLOR","ocColor = decodeColor();","#endif","#ifndef FLAT_SHADED","vNormal = normalize( transformedNormal );","#endif","#include <displacementmap_vertex>","#include <morphtarget_vertex>","#include <skinning_vertex>","#include <project_vertex>","#include <logdepthbuf_vertex>","#include <clipping_planes_vertex>","vViewPosition = - mvPosition.xyz;","wPositionForInnerClipping = modelMatrix * vec4( transformed, 1.0 );","#include <heightLimit_vertex>","#include <worldpos_vertex>","#include <shadowmap_vertex>","#include <fog_vertex>","vec3 vsWorldPosition = vec3(modelMatrix * vec4(transformed, 1.0));","#include <view_shed_vertex>","#include <video_cast_vertex>","#include <excavation_vertex>","}"].join("\n"),H=["#define PHYSICAL","uniform vec3 diffuse;","uniform vec3 emissive;","uniform float roughness;","uniform float metalness;","uniform float opacity;","uniform float imageFade;","uniform vec3 tintColor;","#ifndef STANDARD","uniform float clearCoat;","uniform float clearCoatRoughness;","#endif","varying vec3 vViewPosition;","#ifndef FLAT_SHADED","varying vec3 vNormal;","#endif","#ifdef USE_INSTANCE","   varying vec4 vaColor;","   varying float fState;","   varying float fClipping;","#endif","#ifdef CCOLOR","   varying vec4 ocColor;","#endif","#if defined(USE_MULTI_BLINK_COLOR) ","   varying vec4 vbColor;","#endif","#ifdef USE_FILLPATTERN","   uniform sampler2D fillMap;","#endif","varying vec4 wPositionForInnerClipping;","uniform float shift;","uniform float A;","uniform float B;","uniform float C;","uniform float D;","uniform float E;","uniform float F;","uniform float scale;","uniform vec4 blinkColor;","uniform float blinkCoefficient;","uniform float colorState;","uniform int localClipping;","uniform int innerClipping;","uniform mat4 orthoViewProjMatrix;","uniform bool useForCap;","#include <heightLimit_pars_fragment>","vec3 toneMapCanonFilmic(vec3 color)","{","    color *= (1.0 / shift);","    return (((color * (A * color + C * B)) / (color * (A * color + B) + D * F))) * (1.0 / scale);","}","#include <common>","#include <packing>","#include <dithering_pars_fragment>","#include <color_pars_fragment>","#include <uv_pars_fragment>","#include <uv2_pars_fragment>","#include <map_pars_fragment>","#include <aomap_pars_fragment>","#include <lightmap_pars_fragment>","#include <emissivemap_pars_fragment>","#include <envmap_pars_fragment>","#include <fog_pars_fragment>","#include <bsdfs>","#include <cube_uv_reflection_fragment>","#include <lights_pars_begin>","#include <lights_physical_pars_fragment>","#include <shadowmap_pars_fragment>","#include <bumpmap_pars_fragment>","#include <normalmap_pars_fragment>","#include <roughnessmap_pars_fragment>","#include <metalnessmap_pars_fragment>","#include <logdepthbuf_pars_fragment>","#include <csm_fragment>","#include <clipping_planes_pars_fragment>","#include <envmap_common_pars_fragment>","#include <envmap_physical_pars_fragment>","#include <view_shed_pars_fragment>","#include <video_cast_pars_fragment>","#include <excavation_pars_fragment>","vec3 hdrDecode(in vec4 rgbm) {","const float rgbmScale = 2.82842712;","vec3 r = rgbm.rgb * (rgbmScale * (1.0 - rgbm.a));","return r * r;","}","vec3 linearToGammaUnreal(in vec3 rgb) {","    return rgb / (rgb + 0.187) * 1.035 *(0.5 / shift);","}","bool floatEqual(in float x, in float y) {","    return (x >= y - 0.01) && (x <= y + 0.01);","}","bool floatNotEqual(in float x, in float y) {","    return (x <= y - 0.01) || (x >= y + 0.01);","}","void main() {","\n        if (innerClipping > 0)\n        {\n            vec4 clipPosition = orthoViewProjMatrix * wPositionForInnerClipping;\n            clipPosition.xyz /= clipPosition.w;\n            if (clipPosition.x >= -1.0 && clipPosition.x <= 1.0 &&\n                clipPosition.y >= -1.0 && clipPosition.y <= 1.0 && clipPosition.z >= -1.0) \n            {\n                discard;\n            }\n        }\n        else\n        {\n            #if NUM_CLIPPING_PLANES > 0\n            vec3 cameraPosInViewSpace = vec3(0.0);\n                #ifdef USE_INSTANCE\n                    if ((localClipping == 1 && floatEqual(fClipping, 6.0)) || localClipping < 0) {\n                        for ( int i = 0; i < UNION_CLIPPING_PLANES; ++ i ) {\n                            vec4 plane = clippingPlanes[ i ];\n                            if ( dot( vViewPosition, plane.xyz ) > plane.w &&(!useForCap ||(useForCap &&dot( cameraPosInViewSpace, plane.xyz ) > plane.w )) ) discard;\n                        }\n                        #if UNION_CLIPPING_PLANES < NUM_CLIPPING_PLANES\n                            bool clipped = true;\n                            for ( int i = UNION_CLIPPING_PLANES; i < NUM_CLIPPING_PLANES; ++ i ) {\n                                vec4 plane = clippingPlanes[ i ];\n                                clipped = ( dot( vViewPosition, plane.xyz ) > plane.w ) && clipped;\n                            }\n                            if ( clipped ) discard;\n                        #endif\n                    }\n                #else\n                    for ( int i = 0; i < UNION_CLIPPING_PLANES; ++ i ) {\n                        vec4 plane = clippingPlanes[ i ];\n                        if ( dot( vViewPosition, plane.xyz ) > plane.w &&(!useForCap ||(useForCap&&dot( cameraPosInViewSpace, plane.xyz ) > plane.w ))  ) discard;\n                    }\n                    #if UNION_CLIPPING_PLANES < NUM_CLIPPING_PLANES\n                        bool clipped = true;\n                        for ( int i = UNION_CLIPPING_PLANES; i < NUM_CLIPPING_PLANES; ++ i ) {\n                            vec4 plane = clippingPlanes[ i ];\n                            clipped = ( dot( vViewPosition, plane.xyz ) > plane.w ) && clipped;\n                        }\n                        if ( clipped ) discard;\n                    #endif\n                #endif\n            #endif\n        }\n    ","#ifdef USE_FILLPATTERN","    vec2 screenPosition = vec2(gl_FragCoord.x,gl_FragCoord.y);","    float flag = texture2D(fillMap, vec2(screenPosition.x/32.0, screenPosition.y/32.0)).r;","    if(flag == 0.0)","    {","        discard;","    }","#endif","vec4 diffuseColor = vec4( diffuse, opacity );","#include <vertex_color_frag>","#ifdef USE_INSTANCE","   if (floatEqual(fState, -1.0)) ","       discard;","   if (floatNotEqual(fState, 0.0)) ","       diffuseColor = vaColor;","#endif","#ifdef CCOLOR","       diffuseColor = vec4(ocColor.rgb, opacity ) ;","#endif","vec4 selectedColor = diffuseColor;","#ifndef USE_LIGHTMAP","   diffuseColor.rgb = pow(diffuseColor.rgb, vec3(GAMMA_FACTOR));","#endif","ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );","vec3 totalEmissiveRadiance = emissive;","#ifdef USE_INSTANCE","   if (floatEqual(fState, 3.0))","       totalEmissiveRadiance = vec3(0.0);","#endif","#include <logdepthbuf_fragment>","vec4 gamaColor = diffuseColor ;","#ifdef USE_MAP","   vec4 texelColor = texture2D( map, vUv );","   texelColor = mapTexelToLinear( texelColor );","   #ifdef USE_CLAMP_TO_BORDER","       texelColor = (vUv.x > 1.0 ||vUv.x < 0.0 || vUv.y < 0.0|| vUv.y > 1.0) ?diffuseColor:mapTexelToLinear( texelColor );","   #endif","   diffuseColor = vec4( mix(diffuseColor.rgb , texelColor.rgb, imageFade), opacity);","   #ifdef USE_INSTANCE","       if (floatNotEqual(fState, 0.0)) ","           diffuseColor.a = vaColor.a;","         if (floatEqual(fState, 3.0))","             diffuseColor = gamaColor;","   #endif","#endif","diffuseColor = vec4(diffuseColor.rgb * tintColor.rgb,diffuseColor.a);","#include <alphamap_fragment_override>","#include <alphatest_fragment>","#include <specularmap_fragment>","#include <roughnessmap_fragment>","#include <metalnessmap_fragment>","#include <normal_fragment_begin>","#include <normal_fragment_maps>","#include <emissivemap_fragment>","#ifdef USE_INSTANCE","   if (floatEqual(fState, 3.0)){","       roughnessFactor = 1.0;","       metalnessFactor = 0.0;","   }","#endif","#include <lights_physical_fragment>"," GeometricContext geometry;","geometry.position = - vViewPosition;","geometry.normal = normal;","geometry.viewDir = normalize( vViewPosition );","IncidentLight directLight;","#if ( NUM_POINT_LIGHTS > 0 ) && defined( RE_Direct )","PointLight pointLight;","#if defined( USE_SHADOWMAP ) && (NUM_POINT_LIGHT_SHADOWS > 0)","PointLightShadow pointLightShadow;","#endif","#pragma unroll_loop_start","for ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {","pointLight = pointLights[ i ];","getPointDirectLightIrradiance( pointLight, geometry, directLight );","#if defined( USE_SHADOWMAP ) && (NUM_POINT_LIGHT_SHADOWS > 0)  && ( UNROLLED_LOOP_INDEX < NUM_POINT_LIGHT_SHADOWS )","pointLightShadow = pointLightShadows[ i ];","directLight.color *= all( bvec2( receiveShadow, directLight.visible ) ) ? getPointShadow( pointShadowMap[ i ], pointLightShadow.shadowMapSize, pointLightShadow.shadowBias, pointLightShadow.shadowRadius, vPointShadowCoord[ i ] ) : 1.0;","#endif","RE_Direct( directLight, geometry, material, reflectedLight );","}","#pragma unroll_loop_end","#endif","#if ( NUM_SPOT_LIGHTS > 0 ) && defined( RE_Direct )","    SpotLight spotLight;","    #if defined( USE_SHADOWMAP ) && (NUM_SPOT_LIGHT_SHADOWS > 0)","        SpotLightShadow spotLightShadow;","    #endif","    #pragma unroll_loop_start","    for ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {","        spotLight = spotLights[ i ];","        getSpotDirectLightIrradiance( spotLight, geometry, directLight );","        #if defined( USE_SHADOWMAP ) && (NUM_SPOT_LIGHT_SHADOWS > 0) && ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS )","        spotLightShadow = spotLightShadows[ i ];","        if(opacity > 0.8)","        directLight.color *= all( bvec2( receiveShadow, directLight.visible ) ) ? getShadow( spotShadowMap[ i ], spotLightShadow.shadowMapSize, spotLightShadow.shadowBias, spotLightShadow.shadowRadius, vSpotShadowCoord[ i ] ) : 1.0;","        #endif","        RE_Direct( directLight, geometry, material, reflectedLight );","    }","   #pragma unroll_loop_end","#endif","#if ( NUM_DIR_LIGHTS > 0 ) && defined( RE_Direct ) && defined( USE_CSM )","\n            DirectionalLight directionalLight;\n            float shadowValue = calcShadowFactor(geometry.normal);\n        ","    for ( int i = 4; i < NUM_DIR_LIGHTS; i ++ ) {","        directionalLight = directionalLights[ i ];","        getDirectionalDirectLightIrradiance( directionalLight, geometry, directLight );","        #ifdef USE_SHADOWMAP","        if(opacity > 0.8)","        directLight.color *=  receiveShadow ? shadowValue : 1.0;","        #endif","       RE_Direct( directLight, geometry, material, reflectedLight );","    }","#endif","\n        #if ( NUM_DIR_LIGHTS > 0 ) && defined( RE_Direct ) && !defined( USE_CSM )\n            DirectionalLight directionalLight;\n\n            #if defined( USE_SHADOWMAP ) && NUM_DIR_LIGHT_SHADOWS > 0\n                DirectionalLightShadow directionalLightShadow;\n            #endif\n\n            #pragma unroll_loop_start\n            for ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n                directionalLight = directionalLights[ i ];\n                getDirectionalDirectLightIrradiance( directionalLight, geometry, directLight );\n                //r142\n                //getDirectionalLightInfo( directionalLight, geometry, directLight );\n                #if defined( USE_SHADOWMAP ) && (NUM_DIR_LIGHT_SHADOWS > 0) && ( UNROLLED_LOOP_INDEX < NUM_DIR_LIGHT_SHADOWS )\n                directionalLightShadow = directionalLightShadows[ i ];\n                if(opacity > 0.8)\n                directLight.color *= all( bvec2( receiveShadow, directLight.visible ) ) ? getShadow( directionalShadowMap[ i ], directionalLightShadow.shadowMapSize, directionalLightShadow.shadowBias, directionalLightShadow.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;\n                #endif\n                RE_Direct( directLight, geometry, material, reflectedLight );\n            }\n            #pragma unroll_loop_end\n        #endif\n        ","#if ( NUM_RECT_AREA_LIGHTS > 0 ) && defined( RE_Direct_RectArea )","   RectAreaLight rectAreaLight;","    for ( int i = 0; i < NUM_RECT_AREA_LIGHTS; i ++ ) {","        rectAreaLight = rectAreaLights[ i ];","        RE_Direct_RectArea( rectAreaLight, geometry, material, reflectedLight );","    }","#endif","#if defined( RE_IndirectDiffuse )","    vec3 irradiance = getAmbientLightIrradiance( ambientLightColor );","    #if ( NUM_HEMI_LIGHTS > 0 )","       for ( int i = 0; i < NUM_HEMI_LIGHTS; i ++ ) {","           irradiance += getHemisphereLightIrradiance( hemisphereLights[ i ], geometry );","       }","    #endif","    #if defined( USE_ENVMAP ) && defined( PHYSICAL ) && defined( ENVMAP_TYPE_CUBE_UV )","       irradiance += getLightProbeIndirectIrradiance( geometry, 8 );","    #endif","    RE_IndirectDiffuse( irradiance, geometry, material, reflectedLight );","    #endif","    #if defined( USE_ENVMAP ) && defined( RE_IndirectSpecular )","    vec3 radiance = getLightProbeIndirectRadiance( geometry.viewDir, geometry.normal, material.specularRoughness, 8 );","    #ifndef STANDARD","    vec3 clearCoatRadiance = getLightProbeIndirectRadiance( geometry.viewDir, geometry.clearcoatNormal, material.clearcoatRoughness, 8 );","    #else","    vec3 clearCoatRadiance = vec3( 0.0 );","    #endif","    RE_IndirectSpecular( radiance, irradiance, clearCoatRadiance, geometry, material, reflectedLight ); ","    #endif","#include <aomap_fragment>","vec3 diffuseSpecularEmissive = vec3(0.0);","#ifdef USE_LIGHTMAP","   #ifdef USE_COMPONENT_LIGHTMAP","       vec3 lightMapIrradiance = (texture2D(lightMap, vUv2)).rgb * lightMapIntensity;","   #else","       vec3 lightMapIrradiance = hdrDecode(texture2D(lightMap, vUv2)) * lightMapIntensity;","   #endif","   vec3 diffuseSpecular =  clamp(diffuseColor.rgb, vec3(0.0, 0.0, 0.0), vec3(1.0, 1.0, 1.0)) * lightMapIrradiance;","   diffuseSpecularEmissive = diffuseSpecular + diffuseColor.rgb * 0.0;","#endif","vec3 outgoingLight = diffuseSpecularEmissive + reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveRadiance;","bool useColorWithoutLight = false;","#ifdef USE_COLORWITHOUTLIGHT ","   useColorWithoutLight = true;","#endif","if (useColorWithoutLight || (ambientLightColor == vec3(0.0)) ) ","   gl_FragColor = diffuseColor;","else","   gl_FragColor = vec4( outgoingLight, diffuseColor.a );","#if defined( TONE_MAPPING )","   #if defined(USE_LIGHTMAP)","       gl_FragColor.rgb = linearToGammaUnreal(diffuseSpecularEmissive.xyz );","   #else","       gl_FragColor.rgb = toneMapCanonFilmic( gl_FragColor.rgb );","   #endif","#endif","#ifdef USE_INSTANCE","       if (floatEqual(fState, 2.0))","           gl_FragColor = selectedColor;","       if (floatEqual(fState, 5.0) && floatEqual(colorState, 1.0)) {","           #if defined(USE_MULTI_BLINK_COLOR)","               vec4 finBlinkColor = vbColor;","           #else","               vec4 finBlinkColor = blinkColor;","           #endif","           gl_FragColor = mix(gl_FragColor, finBlinkColor, blinkCoefficient);","       }","#else","       if (floatEqual(colorState, 1.0)) {","           gl_FragColor = mix(gl_FragColor, blinkColor, blinkCoefficient);","       }","       if (floatEqual(colorState, 2.0))","           gl_FragColor = selectedColor;","#endif","#include <view_shed_fragment>","#include <video_cast_fragment>","#ifndef USE_LIGHTMAP","  #include <encodings_fragment>","#endif","#include <heightLimit_fragment>","#include <excavation_fragment>","#include <premultiplied_alpha_fragment>","#include <dithering_fragment>","#include <fog_fragment>","}"].join("\n"),U=["#define PHONG","#ifndef FLAT_SHADED","varying vec3 vNormal;","#endif","#ifdef USE_INSTANCE","   attribute float vState;","   attribute float vState2;","   attribute float vClipping;","   #if NUM_CLIPPING_PLANES > 0","      varying float fClipping;","   #endif","   varying float fState;","   attribute vec4 aColor;","   varying vec4 vaColor;","   attribute vec3 mcol0;","   attribute vec3 mcol1;","   attribute vec3 mcol2;","   attribute vec3 mcol3;","   #if defined(USE_MAP)||defined(USE_BUMPMAP) ","       attribute vec2 muvCol0;","       attribute vec2 muvCol1;","       attribute vec2 muvCol2;","   #endif","   #if defined(USE_MULTI_BLINK_COLOR) ","       attribute vec4 bColor;","       varying vec4 vbColor;","   #endif","   #if defined(USE_LIGHTMAP)","       attribute vec4 uv2OffsetRepeat;","   #endif","#endif","varying vec3 vViewPosition;","#include <uv_pars_vertex>","#include <uv2_pars_vertex>","#include <envmap_pars_vertex>","#include <color_pars_vertex>","#include <fog_pars_vertex>","#include <common>","#include <logdepthbuf_pars_vertex>","#include <shadowmap_pars_vertex>","#include <morphtarget_pars_vertex>","#include <skinning_pars_vertex>","#include <specularmap_pars_fragment>","#include <clipping_planes_pars_vertex>","#include <CompressNormal_vertex>","#include <CompressColor_vertex>","varying vec4 wPositionForInnerClipping;","#if defined(USE_PACKINGMAT)","  attribute vec2 uv3;","  varying vec2 vUv3;","#endif","mat3 inverse_mat3(in mat3 m)","{","   float determinant =","    m[0][0] * (m[1][1] * m[2][2] - m[2][1] * m[1][2])","    - m[1][0] * (m[0][1] * m[2][2] - m[2][1] * m[0][2])","    + m[2][0] * (m[0][1] * m[1][2] - m[1][1] * m[0][2]);","    mat3 inverse;","    inverse[0][0] = + (m[1][1] * m[2][2] - m[2][1] * m[1][2]);","    inverse[1][0] = - (m[1][0] * m[2][2] - m[2][0] * m[1][2]);","    inverse[2][0] = + (m[1][0] * m[2][1] - m[2][0] * m[1][1]);","    inverse[0][1] = - (m[0][1] * m[2][2] - m[2][1] * m[0][2]);","    inverse[1][1] = + (m[0][0] * m[2][2] - m[2][0] * m[0][2]);","    inverse[2][1] = - (m[0][0] * m[2][1] - m[2][0] * m[0][1]);","    inverse[0][2] = + (m[0][1] * m[1][2] - m[1][1] * m[0][2]);","    inverse[1][2] = - (m[0][0] * m[1][2] - m[1][0] * m[0][2]);","    inverse[2][2] = + (m[0][0] * m[1][1] - m[1][0] * m[0][1]);","    inverse /= determinant;","    return inverse;","}","#ifdef USE_COMPRESS_UV","uniform vec2 uvCenter;","uniform vec2 uvHalfExtent;","vec2 uvDecode(vec2 myuv) {","    myuv = (myuv + 32768.0)* 2.0 / 65535.0 - 1.0;","    return myuv * uvHalfExtent + uvCenter;","}","#endif","void main() {","   #if defined( USE_MAP ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_SPECULARMAP ) || defined( USE_ALPHAMAP ) || defined( USE_EMISSIVEMAP ) || defined( USE_ROUGHNESSMAP ) || defined( USE_METALNESSMAP )","   #ifdef USE_COMPRESS_UV","      vUv = uvDecode(uv);","      vUv = ( uvTransform * vec3( vUv, 1 ) ).xy;","   #else","      vUv = ( uvTransform * vec3( uv, 1 ) ).xy;","   #endif","   #endif","   #include <uv_vertex>","   #include <uv2_vertex>","   #include <color_vertex>","   #include <begin_vertex>","   #include <beginnormal_vertex>","   #ifdef CNORMAL","     objectNormal = octDecode();","   #endif","   #if (defined(USE_MAP)||defined(USE_BUMPMAP)) && defined(USE_INSTANCE)  ","      vUv = vec2(mat3(vec3(muvCol0, 0.0),","                      vec3(muvCol1, 0.0),","                      vec3(muvCol2, 1.0)) * vec3(uv, 1.0));","      vUv = ( uvTransform * vec3( vUv, 1 ) ).xy;","   #endif","   #if defined(USE_COMPRESS_UV) && (defined(USE_LIGHTMAP) || defined(USE_AOMAP))","      vUv2 = uvDecode(vUv2);","   #endif","   #if defined(USE_LIGHTMAP) && defined(USE_INSTANCE)  ","      vUv2.x = uv2OffsetRepeat.x*vUv2.x/ 65535.0 + uv2OffsetRepeat.z ;","      vUv2.y = uv2OffsetRepeat.y*vUv2.y/ 65535.0 + uv2OffsetRepeat.w ;","   #endif","   #include <defaultnormal_vertex>","   #ifdef USE_INSTANCE","      vaColor = aColor;","      #if NUM_CLIPPING_PLANES > 0","         fClipping = vClipping;","      #endif","      #if defined(USE_MULTI_BLINK_COLOR) ","         vbColor = bColor;","      #endif","      #ifdef INSTANCE_STATE_SECONDARY","         fState = vState2;","      #else","         fState = vState;","      #endif","      transformed = vec3(mat4(vec4(mcol0, 0.0),","                         vec4(mcol1, 0.0),","                         vec4(mcol2, 0.0),","                         vec4(mcol3, 1.0)) * vec4(transformed, 1.0));","      #ifdef USE_INSTANCE_NORMAL","         mat3 normalMat = mat3(mcol0, mcol1, mcol2);","         normalMat = inverse_mat3(normalMat);","         normalMat = transposeMat3(normalMat);","         transformedNormal = normalMat * objectNormal;","         transformedNormal = normalMatrix * transformedNormal;","         #ifdef FLIP_SIDED","            transformedNormal = - transformedNormal;","         #endif","             transformedNormal = normalize( transformedNormal );","      #endif","   #endif","   #ifdef CCOLOR","   ocColor = decodeColor();","   #endif","   #ifndef FLAT_SHADED","   vNormal = normalize( transformedNormal );","   #endif","   #include <displacementmap_vertex>","   #include <morphtarget_vertex>","   #include <skinning_vertex>","   #include <project_vertex>","   #include <logdepthbuf_vertex>","   #include <clipping_planes_vertex>","   vViewPosition = - mvPosition.xyz;","   wPositionForInnerClipping = modelMatrix * vec4( transformed, 1.0 );","   #if defined(USE_PACKINGMAT)","      vUv3 = uv3;","   #endif","   #include <heightLimit_vertex>","   #include <worldpos_vertex>","   #include <shadowmap_vertex>","   #include <fog_vertex>","   vec3 vsWorldPosition = vec3(modelMatrix * vec4(transformed, 1.0));","   #include <view_shed_vertex>","   #include <video_cast_vertex>","   #include <excavation_vertex>","}"].join("\n"),F=["#define PHONG","uniform vec3 diffuse;","uniform float opacity;","uniform vec3 specular;","uniform float shininess;","uniform vec3 emissive;","#include <common>","#include <uv_pars_fragment>","#include <uv2_pars_fragment>","#include <map_pars_fragment>","#include <aomap_pars_fragment>","#include <lightmap_pars_fragment>","#include <emissivemap_pars_fragment>","#include <envmap_pars_fragment>","#include <fog_pars_fragment>","uniform float shift;","uniform float A;","uniform float B;","uniform float C;","uniform float D;","uniform float E;","uniform float F;","uniform float scale;","uniform vec4 blinkColor;","uniform float blinkCoefficient;","uniform float colorState;","uniform int localClipping;","uniform int innerClipping;","uniform mat4 orthoViewProjMatrix;","uniform bool useForCap;","#include <packing>","#include <bsdfs>","#if defined(USE_PACKINGMAT)","   in vec2 vUv3;","   uniform sampler2D packingMatMap;","#endif","#ifdef USE_INSTANCE","   varying vec4 vaColor;","   varying float fState;","   varying float fClipping;","#endif","#ifdef CCOLOR","   varying vec4 ocColor;","#endif","#if defined(USE_MULTI_BLINK_COLOR) ","   varying vec4 vbColor;","#endif","#ifdef USE_FILLPATTERN","   uniform sampler2D fillMap;","#endif","varying vec4 wPositionForInnerClipping;","#include <cube_uv_reflection_fragment>","#include <lights_pars_begin>","#include <lights_phong_pars_fragment>","#include <specularmap_pars_fragment>","#include <shadowmap_pars_fragment>","#include <csm_fragment>","#include <clipping_planes_pars_fragment>","#include <logdepthbuf_pars_fragment>","#ifdef USE_CAP","uniform sampler2D backSceneTexture;","uniform vec2 viewportSize;","#endif","vec3 linearToGammaUnreal(in vec3 rgb) {","    return rgb / (rgb + 0.187) * 1.035 *(0.5 / shift);","}","vec3 toneMapCanonFilmic(vec3 color)","{","    color *= (1.0 / shift);","    return (((color * (A * color + C * B)) / (color * (A * color + B) + D * F))) * (1.0 / scale);","}","bool floatEqual(in float x, in float y) {","    return (x >= y - 0.01) && (x <= y + 0.01);","}","bool floatNotEqual(in float x, in float y) {","    return (x <= y - 0.01) || (x >= y + 0.01);","}","void main() {","\n       if (innerClipping > 0)\n       {\n           vec4 clipPosition = orthoViewProjMatrix * wPositionForInnerClipping;\n           clipPosition.xyz /= clipPosition.w;\n           if (clipPosition.x >= -1.0 && clipPosition.x <= 1.0 &&\n               clipPosition.y >= -1.0 && clipPosition.y <= 1.0 && clipPosition.z >= -1.0) \n           {\n               discard;\n           }\n       }\n       else\n       {\n           #if NUM_CLIPPING_PLANES > 0\n           vec3 cameraPosInViewSpace = vec3(0.0);\n               #ifdef USE_INSTANCE\n                   if ((localClipping == 1 && floatEqual(fClipping, 6.0)) || localClipping < 0) {\n                       for ( int i = 0; i < UNION_CLIPPING_PLANES; ++ i ) {\n                           vec4 plane = clippingPlanes[ i ];\n                           if ( dot( vViewPosition, plane.xyz ) > plane.w &&(!useForCap ||(useForCap &&dot( cameraPosInViewSpace, plane.xyz ) > plane.w )) ) discard;\n                       }\n                       #if UNION_CLIPPING_PLANES < NUM_CLIPPING_PLANES\n                           bool clipped = true;\n                           for ( int i = UNION_CLIPPING_PLANES; i < NUM_CLIPPING_PLANES; ++ i ) {\n                               vec4 plane = clippingPlanes[ i ];\n                               clipped = ( dot( vViewPosition, plane.xyz ) > plane.w ) && clipped;\n                           }\n                           if ( clipped ) discard;\n                       #endif\n                   }\n               #else\n                   for ( int i = 0; i < UNION_CLIPPING_PLANES; ++ i ) {\n                       vec4 plane = clippingPlanes[ i ];\n                       if ( dot( vViewPosition, plane.xyz ) > plane.w &&(!useForCap ||(useForCap&&dot( cameraPosInViewSpace, plane.xyz ) > plane.w ))  ) discard;\n                   }\n                   #if UNION_CLIPPING_PLANES < NUM_CLIPPING_PLANES\n                       bool clipped = true;\n                       for ( int i = UNION_CLIPPING_PLANES; i < NUM_CLIPPING_PLANES; ++ i ) {\n                           vec4 plane = clippingPlanes[ i ];\n                           clipped = ( dot( vViewPosition, plane.xyz ) > plane.w ) && clipped;\n                       }\n                       if ( clipped ) discard;\n                   #endif\n               #endif\n           #endif\n       }\n    ","#ifdef USE_PACKINGMAT","   float fUVStep = 0.0009765625;","   float uvx = vUv3.x;","   vec4 packing_pixel0 = texture2D(packingMatMap, vec2(uvx  , vUv3.y) );","   vec4 packing_pixel1 = texture2D(packingMatMap, vec2(uvx + 1.0*fUVStep , vUv3.y));","   vec4 packing_pixel2 = texture2D(packingMatMap, vec2(uvx + 2.0*fUVStep , vUv3.y));","   vec4 packing_pixel3 = texture2D(packingMatMap, vec2(uvx + 3.0*fUVStep , vUv3.y));","   vec4 packing_pixel4 = texture2D(packingMatMap, vec2(uvx + 4.0*fUVStep , vUv3.y));","   vec3 diffuse             = packing_pixel0.xyz  ;","   float opacity            = packing_pixel0.w     ;","   vec3 specular            = packing_pixel1.xyz;","   float shininess          = packing_pixel1.w;","   float bumpScale          = packing_pixel2.x;","   vec3 emissive            = packing_pixel3.xyz;","   float reflectivity       = packing_pixel3.w;","   vec3 enviroment          = packing_pixel4.xyz;","   float refractionRatio    = packing_pixel4.w;","#endif","   vec4 diffuseColor = vec4( diffuse, opacity );","#ifdef USE_INSTANCE","   if (floatEqual(fState, -1.0)) ","       discard;","   #ifndef USE_COLOR","       if (floatEqual(fState, 0.0)) ","           diffuseColor = vec4(vaColor.xyz,opacity);","   #endif","   if (floatNotEqual(fState, 0.0)) ","       diffuseColor = vaColor;","#endif","#ifdef CCOLOR","       diffuseColor = vec4(ocColor.rgb, opacity ) ;","#endif","\t#include <logdepthbuf_fragment>","vec4 selectedColor = diffuseColor;","#ifndef USE_LIGHTMAP","   diffuseColor.rgb = pow(diffuseColor.rgb, vec3(GAMMA_FACTOR));","#endif","#ifdef USE_MAP","   vec4 texelColor = texture2D( map, vUv );","   texelColor = mapTexelToLinear( texelColor );","   diffuseColor = vec4(texelColor.rgb, opacity);","#endif","   ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );","   vec3 totalEmissiveRadiance = emissive;","   float specularStrength = 1.0;","   #include <alphamap_fragment_override>","   #include <alphatest_fragment>","   #include <normal_fragment_begin>","   #include <normal_fragment_maps>","   #include <lights_phong_fragment>","   #include <emissivemap_fragment>","   #include <lights_template>","#ifdef USE_INSTANCE","   if (floatEqual(fState, 3.0))","       totalEmissiveRadiance = vec3(0.0);","#endif","#include <aomap_fragment>","reflectedLight.directSpecular =  clamp(reflectedLight.directSpecular,vec3(0.0), vec3(1.0));","reflectedLight.indirectSpecular =  clamp(reflectedLight.indirectSpecular,vec3(0.0), vec3(1.0));","   vec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse  + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveRadiance;","bool useColorWithoutLight = false;","#ifdef USE_COLORWITHOUTLIGHT ","   useColorWithoutLight = true;","#endif","if (useColorWithoutLight || (ambientLightColor == vec3(0.0)) ) ","   gl_FragColor = diffuseColor;","else","   gl_FragColor = vec4( outgoingLight, diffuseColor.a );","#if defined( TONE_MAPPING )","   #if defined(USE_LIGHTMAP)","       gl_FragColor.rgb = linearToGammaUnreal(diffuseSpecularEmissive.xyz );","   #else","       gl_FragColor.rgb = toneMapCanonFilmic( gl_FragColor.rgb );","   #endif","#endif","#ifdef USE_INSTANCE","       if (floatEqual(fState, 2.0))","           gl_FragColor = selectedColor;","       if (floatEqual(fState, 5.0) && floatEqual(colorState, 1.0)) {","           #if defined(USE_MULTI_BLINK_COLOR)","               vec4 finBlinkColor = vbColor;","           #else","               vec4 finBlinkColor = blinkColor;","           #endif","           gl_FragColor = mix(gl_FragColor, finBlinkColor, blinkCoefficient);","       }","#else","       if (floatEqual(colorState, 1.0)) {","           gl_FragColor = mix(gl_FragColor, blinkColor, blinkCoefficient);","       }","       if (floatEqual(colorState, 2.0))","           gl_FragColor = selectedColor;","#endif","#include <view_shed_fragment>","#include <video_cast_fragment>","#ifndef USE_LIGHTMAP","  #include <encodings_fragment>","#endif","#include <heightLimit_fragment>","#include <excavation_fragment>","#include <premultiplied_alpha_fragment>","#include <dithering_fragment>","#include <fog_fragment>","#ifdef USE_CAP","vec2 screenUV = vec2(gl_FragCoord.x/viewportSize.x,gl_FragCoord.y/viewportSize.y);","vec4 backColor = texture2D(backSceneTexture, screenUV);","gl_FragColor = texture2D(backSceneTexture, screenUV);","#endif","}"].join("\n");r.MapTileShader={vertex:"\n        #define PHONG\n        varying vec3 vViewPosition;\n        #ifndef FLAT_SHADED\n            varying vec3 vNormal;\n        #endif\n        #include <common>\n        #include <uv_pars_vertex>\n        #include <uv2_pars_vertex>\n        #include <displacementmap_pars_vertex>\n        #include <envmap_pars_vertex>\n        #include <color_pars_vertex>\n        #include <fog_pars_vertex>\n        #include <morphtarget_pars_vertex>\n        #include <skinning_pars_vertex>\n        #include <shadowmap_pars_vertex>\n        #include <logdepthbuf_pars_vertex>\n        #ifdef USE_CLIPPING\n        #include <clipping_planes_pars_vertex>\n        #endif\n\n        uniform mat4 u_CullOrthoMatrix;\n        varying vec3 v_CullOrthoPosition;\n\n        void main()\n        {\n            vec4 othPos = u_CullOrthoMatrix * (modelMatrix * vec4(position, 1.0));\n            othPos /= othPos.w;\n            v_CullOrthoPosition = othPos.xyz;\n\n            #include <uv_vertex>\n            #include <uv2_vertex>\n            #include <color_vertex>\n            #include <beginnormal_vertex>\n            #include <morphnormal_vertex>\n            #include <skinbase_vertex>\n            #include <skinnormal_vertex>\n            #include <defaultnormal_vertex>\n            #ifndef FLAT_SHADED\n                vNormal = normalize( transformedNormal );\n            #endif\n            #include <begin_vertex>\n            #include <displacementmap_vertex>\n            #include <morphtarget_vertex>\n            #include <skinning_vertex>\n\n            #ifdef USE_SKINNING\n                vec4 wPosition = modelMatrix * skinned;\n            #else\n                vec4 wPosition = modelMatrix * vec4( transformed, 1.0 );\n            #endif\n\n            vec4 mvPosition = viewMatrix * wPosition;\n            gl_Position = projectionMatrix * mvPosition;\n    \n            #include <logdepthbuf_vertex>\n            vViewPosition = - mvPosition.xyz;        \n            #ifdef USE_CLIPPING\n            #include <clipping_planes_vertex>\n            #endif\n            #include <worldpos_vertex>\n            #include <envmap_vertex>\n            #include <shadowmap_vertex>\n            #include <fog_vertex>\n        }",fragment:"\n        #define PHONG\n        uniform vec3 diffuse;\n        uniform vec3 emissive;\n        uniform vec3 specular;\n        uniform float shininess;\n        uniform float opacity;\n        #include <common>\n        #include <packing>\n        #include <dithering_pars_fragment>\n        #include <color_pars_fragment>\n        #include <uv_pars_fragment>\n        #include <uv2_pars_fragment>\n        #include <map_pars_fragment>\n        #include <alphamap_pars_fragment>\n        #include <aomap_pars_fragment>\n        #include <lightmap_pars_fragment>\n        #include <emissivemap_pars_fragment>\n        #include <envmap_pars_fragment>\n        #include <gradientmap_pars_fragment>\n        #include <fog_pars_fragment>\n        #include <bsdfs>\n        //r142\n        //#include <alphatest_pars_fragment>\n        //#include <normal_pars_fragment>\n        #include <lights_pars_begin>\n        #include <lights_phong_pars_fragment>\n        #include <shadowmap_pars_fragment>\n        #include <bumpmap_pars_fragment>\n        #include <normalmap_pars_fragment>\n        #include <specularmap_pars_fragment>\n        #include <logdepthbuf_pars_fragment>\n        #include <csm_fragment>\n        #ifdef USE_CLIPPING\n        #include <clipping_planes_pars_fragment>\n        #endif\n\n        uniform float brightness;\n        uniform float contrast;\n        uniform float saturation;\n        uniform float hue;\n        uniform float gamma;\n        uniform vec4 customColor;\n        uniform float useCustomColor;\n\n        varying vec3 v_CullOrthoPosition;\n        uniform sampler2D  u_SamplerExcavation;\n        \n        vec2 postProjToScreen(vec2 position)\n        {\n            vec2 screenPos = position;\n            \n            return 0.5 *(vec2(screenPos.x, screenPos.y) + 1.0);\n        }\n\n        vec4 depthColor(vec4 color) \n        {\n            color.r = color.r * color.r * color.r;\n            color.g = color.g * color.g * color.g;\n            color.b = color.b * color.b;\n            return color;\n        }\n\n        vec3 computeContrast(vec3 rgb, float contrast) \n        {\n            vec3 color = mix(vec3(0.5), rgb, contrast);\n            color = clamp(color, 0.0, 1.0);\n            return color;\n        }\n\n        vec3 computeHue(vec3 rgb, float adjustment) \n        {\n            const mat3 toYIQ = mat3(0.299, 0.587, 0.114, 0.595716, -0.274453, -0.321263, 0.211456, -0.522591, 0.311135);\n            const mat3 toRGB = mat3(1.0, 0.9563, 0.6210, 1.0, -0.2721, -0.6474, 1.0, -1.107, 1.7046);\n            vec3 yiq = toYIQ * rgb;\n            float hue = atan(yiq.z, yiq.y) + adjustment;\n            float chroma = sqrt(yiq.z * yiq.z + yiq.y * yiq.y);\n            vec3 color = vec3(yiq.x, chroma * cos(hue), chroma * sin(hue));\n            vec3 final = toRGB * color;\n            final = clamp(final, 0.0, 1.0);\n            return final;\n        }\n\n        vec3 computeSaturation(vec3 rgb, float adjustment) \n        {\n            const vec3 W = vec3(0.2125, 0.7154, 0.0721);\n            vec3 intensity = vec3(dot(rgb, W));\n            vec3 color = mix(intensity, rgb, adjustment);\n            color = clamp(color, 0.0, 1.0);\n            return color;\n        }\n\n        vec4 sampleAndBlend(float useCustom, vec4 customColor, vec4 earthColor, float brightness, float contrast, float hue, float saturation, float gamma)\n        {\n            vec4 value = earthColor;\n            if (useCustom == 1.0) {\n                value = depthColor(value);\n                value.rgb *= customColor.rgb;\n            }\n            vec3 color = value.rgb;\n            float alpha = value.a;\n            \n            //brightness\n            color = mix(vec3(0.0, 0.0, 0.0), color, brightness);\n            \n            //contrast\n            color = computeContrast(color, contrast);\n\n            //hue\n            color = computeHue(color, hue);\n\n            //saturation\n            color = computeSaturation(color, saturation);\n\n            //gamma\n            color = pow(color, vec3(gamma));\n\n            return vec4(color, alpha);\n        }\n\n        void main()\n        {   \n            vec2 uv = postProjToScreen(v_CullOrthoPosition.xy);\n            if(uv.x >= 0.0 && uv.x <= 1.0 && uv.y >= 0.0 && uv.y <= 1.0)\n            {\n                vec4 color = texture2D(u_SamplerExcavation, uv);\n                if(color.r > 0.0001)\n                {\n                    discard;\n                }\n            } \n              \n            #ifdef USE_CLIPPING\n            #include <clipping_planes_fragment>\n            #endif\n\n            vec4 diffuseColor = vec4( diffuse, opacity );\n            ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n            vec3 totalEmissiveRadiance = emissive;        \n            #include <logdepthbuf_fragment>\n            #include <map_fragment>\n            #include <color_fragment>\n            #include <alphamap_fragment>\n            #include <alphatest_fragment>\n            #include <specularmap_fragment>\n            #include <normal_fragment_maps>\n            #include <normal_fragment_begin>\n            #include <emissivemap_fragment>\n            #include <lights_phong_fragment>\n            \n            GeometricContext geometry;\n            geometry.position = - vViewPosition;\n            geometry.normal = normal;\n            geometry.viewDir = normalize( vViewPosition );\n            IncidentLight directLight;\n            #if ( NUM_DIR_LIGHTS > 0 ) && defined( RE_Direct ) && defined( USE_CSM )\n                DirectionalLight directionalLight;\n                float shadowValue = calcShadowFactor(geometry.normal);\n                shadowValue = max(shadowValue, 0.1);\n                #ifdef USE_SHADOWMAP\n                if(opacity > 0.9)\n                    diffuseColor.rgb *= receiveShadow ? shadowValue : 1.0;\n                #endif\n                #if defined( USE_SHADOWMAP ) && NUM_DIR_LIGHT_SHADOWS > 0\n                    DirectionalLightShadow directionalLightShadow;\n                #endif\n                #pragma unroll_loop_start\n                for ( int i = 4; i < NUM_DIR_LIGHTS; i ++ ) {\n                    directionalLight = directionalLights[ i ];\n                    getDirectionalDirectLightIrradiance( directionalLight, geometry, directLight );\n                    //r142\n                    //getDirectionalLightInfo( directionalLight, geometry, directLight );\n                    #if defined( USE_SHADOWMAP )  && (NUM_DIR_LIGHT_SHADOWS > 0) && ( UNROLLED_LOOP_INDEX < NUM_DIR_LIGHT_SHADOWS )\n                    directionalLightShadow = directionalLightShadows[i - 4];\n                    if(opacity > 0.9)\n                        diffuseColor.rgb *= all( bvec2(receiveShadow, directLight.visible ) ) ? getShadow( directionalShadowMap[ i - 4 ], directionalLightShadow.shadowMapSize, directionalLightShadow.shadowBias, directionalLightShadow.shadowRadius, vDirectionalShadowCoord[ i - 4 ] ) : 1.0;\n                    #endif\n                }\n                #pragma unroll_loop_end\n            #endif\n\n            #if ( NUM_DIR_LIGHTS > 0 ) && defined( RE_Direct ) && !defined( USE_CSM )\n                DirectionalLight directionalLight;\n                #if defined( USE_SHADOWMAP ) && NUM_DIR_LIGHT_SHADOWS > 0\n                    DirectionalLightShadow directionalLightShadow;\n                #endif\n                #pragma unroll_loop_start\n                for ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n                    directionalLight = directionalLights[ i ];\n                    getDirectionalDirectLightIrradiance( directionalLight, geometry, directLight );\n                    //getDirectionalLightInfo( directionalLight, geometry, directLight );\n                    #if defined( USE_SHADOWMAP ) && (NUM_DIR_LIGHT_SHADOWS > 0)  && ( UNROLLED_LOOP_INDEX < NUM_DIR_LIGHT_SHADOWS )\n                    directionalLightShadow = directionalLightShadows[ i ];\n                    if(opacity > 0.9)\n                        diffuseColor.rgb *= all( bvec2( receiveShadow, directLight.visible ) ) ? getShadow( directionalShadowMap[ i ], directionalLightShadow.shadowMapSize, directionalLightShadow.shadowBias, directionalLightShadow.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;\n                    #endif\n                }\n                #pragma unroll_loop_end\n            #endif\n            \n            vec3 outgoingLight = diffuseColor.rgb;\n            #include <envmap_fragment>\n            vec4 resultColor = vec4( outgoingLight, diffuseColor.a );\n            gl_FragColor = sampleAndBlend(useCustomColor, customColor, resultColor, brightness, contrast, hue, saturation, gamma);\n\n            #include <tonemapping_fragment>\n            #include <encodings_fragment>\n            #include <fog_fragment>\n            #include <premultiplied_alpha_fragment>\n            #include <dithering_fragment>        \n        }"},r.ObliquePhotographyShader={vertex:"\n        #define PHONG\n        varying vec3 vViewPosition;\n        #ifndef FLAT_SHADED\n            varying vec3 vNormal;\n        #endif\n        #include <common>\n        #include <uv_pars_vertex>\n        #include <uv2_pars_vertex>\n        #include <displacementmap_pars_vertex>\n        #include <envmap_pars_vertex>\n        #include <color_pars_vertex>\n        #include <fog_pars_vertex>\n        #include <morphtarget_pars_vertex>\n        #include <skinning_pars_vertex>\n        #include <shadowmap_pars_vertex>\n        #include <logdepthbuf_pars_vertex>\n        #include <clipping_planes_pars_vertex>\n        #include <excavation_pars_vertex>\n\n        void main()\n        {\n            \n            #include <uv_vertex>\n            #include <uv2_vertex>\n            #include <color_vertex>\n            #include <beginnormal_vertex>\n            #include <morphnormal_vertex>\n            #include <skinbase_vertex>\n            #include <skinnormal_vertex>\n            #include <defaultnormal_vertex>\n            #ifndef FLAT_SHADED\n                vNormal = normalize( transformedNormal );\n            #endif\n            #include <begin_vertex>\n            #include <displacementmap_vertex>\n            #include <morphtarget_vertex>\n            #include <skinning_vertex>\n\n            #ifdef USE_SKINNING\n                vec4 wPosition = modelMatrix * skinned;\n            #else\n                vec4 wPosition = modelMatrix * vec4( transformed, 1.0 );\n            #endif\n\n            vec4 mvPosition = viewMatrix * wPosition;\n            gl_Position = projectionMatrix * mvPosition;\n    \n            #include <logdepthbuf_vertex>\n            vViewPosition = - mvPosition.xyz;        \n            #include <clipping_planes_vertex>\n            #include <worldpos_vertex>\n            #include <envmap_vertex>\n            #include <shadowmap_vertex>\n            #include <fog_vertex>\n            vec3 vsWorldPosition = vec3(modelMatrix * vec4(transformed, 1.0));\n            #include <excavation_vertex>\n        }",fragment:"\n        #define PHONG\n        uniform vec3 diffuse;\n        uniform vec3 emissive;\n        uniform vec3 specular;\n        uniform float shininess;\n        uniform float opacity;\n        #include <common>\n        #include <packing>\n        #include <dithering_pars_fragment>\n        #include <color_pars_fragment>\n        #include <uv_pars_fragment>\n        #include <uv2_pars_fragment>\n        #include <map_pars_fragment>\n        #include <alphamap_pars_fragment>\n        #include <aomap_pars_fragment>\n        #include <lightmap_pars_fragment>\n        #include <emissivemap_pars_fragment>\n        #include <envmap_pars_fragment>\n        #include <gradientmap_pars_fragment>\n        #include <fog_pars_fragment>\n        #include <bsdfs>\n        //r142\n        //#include <alphatest_pars_fragment>\n        //#include <normal_pars_fragment>\n        #include <lights_pars_begin>\n        #include <lights_phong_pars_fragment>\n        #include <shadowmap_pars_fragment>\n        #include <bumpmap_pars_fragment>\n        #include <normalmap_pars_fragment>\n        #include <specularmap_pars_fragment>\n        #include <logdepthbuf_pars_fragment>\n        #include <csm_fragment>\n        #include <clipping_planes_pars_fragment>\n        #include <excavation_pars_fragment>\n\n        uniform float brightness;\n        uniform float contrast;\n        uniform float saturation;\n        uniform float hue;\n        uniform float gamma;\n        uniform vec4 customColor;\n        uniform float useCustomColor;\n        \n        void main()\n        {   \n            #include <excavation_fragment>      \n            #include <clipping_planes_fragment>\n            vec4 diffuseColor = vec4( diffuse, opacity );\n            #include <logdepthbuf_fragment>\n            #include <map_fragment>\n            #include <color_fragment>\n            #include <alphamap_fragment>\n            #include <alphatest_fragment>\n            #include <specularmap_fragment>\n            #include <normal_fragment_maps>\n            #include <normal_fragment_begin>\n            #include <emissivemap_fragment>\n            #include <lights_phong_fragment>\n            \n            #include <envmap_fragment>\n            gl_FragColor = diffuseColor;\n            #include <tonemapping_fragment>\n            #include <encodings_fragment>\n            #include <fog_fragment>\n            #include <premultiplied_alpha_fragment>\n            #include <dithering_fragment>        \n        }"},r.DepthParseShader={depth_parse_fragment:"\n        uniform float cameraNear;\n        uniform float cameraFar;\n        uniform mat4 cameraProjection;\n        uniform mat4 inverseProjection;\n        uniform vec4 viewport;\n\n        float getViewZ( const in float depth ) {\n            #if defined( USE_LOGDEPTHBUF ) && defined( USE_LOGDEPTHBUF_EXT )\n                float near = cameraNear;\n                float far = cameraFar;\n                float log2Depth = depth * 2.0 / logDepthBufFC;\n                float depthFromCamera = pow(2.0, log2Depth) - 1.0;\n                float a = far * (1.0 - near / depthFromCamera) / (far - near);\n                float viewZ = perspectiveDepthToViewZ( a, cameraNear, cameraFar );\n                if (depth == 0.0) \n                {\n                    viewZ = perspectiveDepthToViewZ( 1.0, cameraNear, cameraFar );\n                }\n            #else\n                float viewZ = perspectiveDepthToViewZ( depth, cameraNear, cameraFar );\n            #endif\n            return viewZ;\n        }\n\n        vec3 getViewPosition( const in float depth ) {\n            #if defined( USE_LOGDEPTHBUF ) && defined( USE_LOGDEPTHBUF_EXT )\n                float near = cameraNear;\n                float far = cameraFar;\n                float log2Depth = depth * 2.0 / logDepthBufFC;\n                float depthFromCamera = pow(2.0, log2Depth) - 1.0;\n                float x = 2.0 * (gl_FragCoord.x - viewport.x) / viewport.z - 1.0;\n                float y = 2.0 * (gl_FragCoord.y - viewport.y) / viewport.w - 1.0;\n                float z = 2.0 * (depthFromCamera - near) / (far-near) - 1.0;\n                vec4 viewPosition = vec4(x, y, z, 1.0);\n                viewPosition *= depthFromCamera;\n                viewPosition = inverseProjection * viewPosition;\n            #else\n                float viewZ = getViewZ(depth);\n                float clipW = cameraProjection[2][3] * viewZ + cameraProjection[3][3];\n                vec4 clipPosition = vec4( ( vec3( gl_FragCoord.xy / viewport.zw, depth ) - 0.5 ) * 2.0, 1.0 );\n                clipPosition *= clipW; //unprojection\n                vec4 viewPosition = inverseProjection * clipPosition;\n            #endif\n\n            return viewPosition.xyz;\n        }\n    "},r.PointsShader={vertex:"\n        #ifdef USE_ATTRIBUTE_SIZE\n            attribute float attrSize;\n        #endif\n        uniform float size;\n        uniform float scale;\n        #include <common>\n        #include <color_pars_vertex>\n        #include <fog_pars_vertex>\n        #include <logdepthbuf_pars_vertex>\n        #include <clipping_planes_pars_vertex>\n        void main() {\n            #include <color_vertex>\n            #include <begin_vertex>\n            #include <project_vertex>\n            #ifdef USE_ATTRIBUTE_SIZE\n                gl_PointSize = attrSize;\n            #else\n                #ifdef USE_SIZEATTENUATION\n                    gl_PointSize = size * ( scale / - mvPosition.z );\n                #else\n                    gl_PointSize = size;\n                #endif\n            #endif\n            #ifdef USE_POSITION_OFFSET\n                float yPos = gl_Position.y;\n                float w = gl_Position.w;\n                yPos /= w;\n                yPos += 0.5 * gl_PointSize / scale;\n                yPos *= w;\n                gl_Position.y = yPos;\n            #endif\n            #include <logdepthbuf_vertex>\n            #include <clipping_planes_vertex>\n            #include <worldpos_vertex>\n            #include <fog_vertex>\n        }",fragment:"\n        uniform vec3 diffuse;\n        uniform float opacity;\n        #include <common>\n        #include <packing>\n        //r142\n        //#include <alphatest_pars_fragment>\n        #include <color_pars_fragment>\n        #include <map_particle_pars_fragment>\n        #include <fog_pars_fragment>\n        #include <shadowmap_pars_fragment>\n        #include <logdepthbuf_pars_fragment>\n        #include <clipping_planes_pars_fragment>\n        void main() {\n            #include <clipping_planes_fragment>\n            vec3 outgoingLight = vec3( 0.0 );\n            vec4 diffuseColor = vec4( diffuse, opacity );\n            #include <logdepthbuf_fragment>\n            #include <map_particle_fragment>\n            #include <color_fragment>\n            #include <alphatest_fragment>\n            outgoingLight = diffuseColor.rgb;\n            gl_FragColor = vec4( outgoingLight, diffuseColor.a );\n            #include <premultiplied_alpha_fragment>\n            #include <tonemapping_fragment>\n            #include <encodings_fragment>\n            #include <fog_fragment>\n        }"},r.ExcavationShader={excavation_pars_vertex:"\n    #ifdef EXCAVATION_MODE\n        uniform mat4 u_CullOrthoMatrix;\n        varying vec3 v_CullOrthoPosition;\n    #endif\n",excavation_pars_fragment:"\n    #ifdef EXCAVATION_MODE\n        varying vec3 v_CullOrthoPosition;\n        uniform sampler2D u_SamplerExcavation;\n        \n        vec2 postProjToScreen(vec2 position)\n        {\n            vec2 screenPos = position;\n            \n            return 0.5 *(vec2(screenPos.x, screenPos.y) + 1.0);\n        }\n    #endif\n",excavation_vertex:"\n    #ifdef EXCAVATION_MODE\n        vec4 othPos = u_CullOrthoMatrix *  vec4(vsWorldPosition.xyz, 1.0);\n        othPos /= othPos.w;\n        v_CullOrthoPosition = othPos.xyz;\n    #endif\n",excavation_fragment:"\n    #ifdef EXCAVATION_MODE\n        vec2 uv = postProjToScreen(v_CullOrthoPosition.xy);\n        if(uv.x >= 0.0 && uv.x <= 1.0 && uv.y >= 0.0 && uv.y <= 1.0)\n        {\n            vec4 color = texture2D(u_SamplerExcavation, uv);\n            if(color.r > 0.0001)\n            {\n                discard;\n            }\n        } \n    #endif\n"};let k=(e,t,i)=>e.replace(t,i);THREE.ShaderChunk.meshphong_id_vert=P,THREE.ShaderChunk.lights_fillFace_template=L,THREE.ShaderChunk.lights_template=r.LightsTemplateShader,THREE.ShaderChunk.fillFaceFragment=O,THREE.ShaderChunk.cloudStandardVertex=N,THREE.ShaderChunk.cloudStandardFragment=H,THREE.ShaderChunk.cloudStandardVertexV3=R,THREE.ShaderChunk.cloudStandardFragmentV3=B,THREE.ShaderChunk.cloudPMPhongVertex=U,THREE.ShaderChunk.cloudPMPhongFragment=F,THREE.ShaderChunk.newStyleVertex=D,THREE.ShaderChunk.newStyleFragment=A,THREE.ShaderChunk.view_shed_pars_vertex=r.ViewshedShader.view_shed_pars_vertex,THREE.ShaderChunk.view_shed_pars_fragment=r.ViewshedShader.view_shed_pars_fragment,THREE.ShaderChunk.view_shed_vertex=r.ViewshedShader.view_shed_vertex,THREE.ShaderChunk.view_shed_fragment=r.ViewshedShader.view_shed_fragment,THREE.ShaderChunk.video_cast_pars_vertex=r.VideoCastShader.video_cast_pars_vertex,THREE.ShaderChunk.video_cast_pars_fragment=r.VideoCastShader.video_cast_pars_fragment,THREE.ShaderChunk.video_cast_vertex=r.VideoCastShader.video_cast_vertex,THREE.ShaderChunk.video_cast_fragment=r.VideoCastShader.video_cast_fragment,THREE.ShaderChunk.heightLimit_pars_vertex=r.HeightLimitShader.heightLimit_pars_vertex,THREE.ShaderChunk.heightLimit_vertex=r.HeightLimitShader.heightLimit_vertex,THREE.ShaderChunk.heightLimit_pars_fragment=r.HeightLimitShader.heightLimit_pars_fragment,THREE.ShaderChunk.heightLimit_fragment=r.HeightLimitShader.heightLimit_fragment,THREE.ShaderChunk.excavation_pars_vertex=r.ExcavationShader.excavation_pars_vertex,THREE.ShaderChunk.excavation_pars_fragment=r.ExcavationShader.excavation_pars_fragment,THREE.ShaderChunk.excavation_vertex=r.ExcavationShader.excavation_vertex,THREE.ShaderChunk.excavation_fragment=r.ExcavationShader.excavation_fragment,THREE.ShaderChunk.oblique_photography_vertex=r.ObliquePhotographyShader.vertex,THREE.ShaderChunk.oblique_photography_fragment=r.ObliquePhotographyShader.fragment,THREE.ShaderChunk.map_tile_vertex=r.MapTileShader.vertex,THREE.ShaderChunk.map_tile_fragment=r.MapTileShader.fragment,THREE.ShaderChunk.points_vertex=r.PointsShader.vertex,THREE.ShaderChunk.points_fragment=r.PointsShader.fragment,THREE.ShaderChunk.depth_parse_fragment=r.DepthParseShader.depth_parse_fragment,THREE.ShaderChunk.csm_fragment=r.CSMShader.csm_fragment,THREE.ShaderChunk.CompressNormal_vertex=r.CompressNormalShader.CompressNormal_vertex,THREE.ShaderChunk.CompressColor_vertex=r.CompressColorShader.CompressColor_vertex,THREE.ShaderChunk.vertex_color_frag=r.VertexColorFrag.vertex_color_frag,THREE.ShaderChunk.alphamap_fragment_override="#if defined(USE_MAP)&&defined(USE_ALPHAMAP)\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdiffuseColor.a *= texture2D( map, vUv ).a;\n\t\t\t\t\t\t\t\t\t\t\t\t\t#endif\n\t\t\t\t\t\t\t\t\t\t\t\t\t",THREE.ShaderChunk.shadowmap_pars_fragment=r.ShadowMapShader.shadowmap_pars_fragment,THREE.ShaderChunk.depth_frag=r.DepthFragShader.depth_frag,THREE.ShaderChunk.cloud_mesh_physical_frag=k(THREE.ShaderChunk.meshphysical_frag,"#include <alphamap_fragment>","#include <alphamap_fragment_override>"),THREE.ShaderChunk.cloud_mesh_basic_frag=k(THREE.ShaderChunk.meshbasic_frag,"#include <alphamap_fragment>","#include <alphamap_fragment_override>"),THREE.ShaderChunk.cloud_line_basic_frag=k(THREE.ShaderChunk.meshbasic_frag,"#include <color_fragment>","#include <vertex_color_frag>"),THREE.ShaderChunk.cloud_line_basic_frag=k(THREE.ShaderChunk.cloud_line_basic_frag,"#include <encodings_fragment>",""),THREE.ShaderChunk.cloud_state_pars_vertex=r.CloudStateShader.cloud_state_pars_vertex,THREE.ShaderChunk.cloud_state_pars_fragment=r.CloudStateShader.cloud_state_pars_fragment,THREE.ShaderChunk.cloud_state_vertex=r.CloudStateShader.cloud_state_vertex,THREE.ShaderChunk.cloud_state_fragment=r.CloudStateShader.cloud_state_fragment,THREE.ShaderLib.background={uniforms:{uvTransform:{value:new THREE.Matrix3},t2D:{value:null}},vertexShader:"\n\tvarying vec2 vUv;\n\tuniform mat3 uvTransform;\n\t#include <clipping_planes_pars_vertex>\n\t\n\tvoid main() {\n\t\n\t\tvUv = ( uvTransform * vec3( uv, 1 ) ).xy;\n\t\t#include <begin_vertex>\n\t\t#include <project_vertex>\n\t\t#include <clipping_planes_vertex>\n\t\t\n\t\tgl_Position = vec4( position.xy, 1.0, 1.0 );\n\t\n\t}\n\t",fragmentShader:"\n\tuniform sampler2D t2D;\n\t\n\tvarying vec2 vUv;\n\t#include <clipping_planes_pars_fragment>\n\tvoid main() {\n\t\t#include <clipping_planes_fragment>\n\t\n\t\tvec4 texColor = texture2D( t2D, vUv );\n\t\n\t\tgl_FragColor = texColor;\n\t\t//r142\n\t\tgl_FragColor = mapTexelToLinear( texColor );\n\t\n\t\t#include <tonemapping_fragment>\n\t\t#include <encodings_fragment>\n\t\n\t}\n\t"},THREE.ShaderLib.fillFacePhong={uniforms:THREE.UniformsUtils.merge([THREE.UniformsLib.common,THREE.UniformsLib.aomap,THREE.UniformsLib.lightmap,THREE.UniformsLib.emissivemap,THREE.UniformsLib.bumpmap,THREE.UniformsLib.normalmap,THREE.UniformsLib.displacementmap,THREE.UniformsLib.gradientmap,THREE.UniformsLib.fog,THREE.UniformsLib.lights,{emissive:{value:new THREE.Color(0)},specular:{value:new THREE.Color(1118481)},shininess:{value:30}}]),vertexShader:THREE.ShaderChunk.meshphong_id_vert,fragmentShader:THREE.ShaderChunk.fillFaceFragment},THREE.ShaderLib.newStyle={vertexShader:THREE.ShaderChunk.newStyleVertex,fragmentShader:THREE.ShaderChunk.newStyleFragment},THREE.ShaderLib.cloudStandard={vertexShader:THREE.ShaderChunk.cloudStandardVertex,fragmentShader:THREE.ShaderChunk.cloudStandardFragment},r.WaterShader={uniforms:{waterColor:{type:"v4",value:null},reflectivity:{type:"f",value:0},flowTime:{type:"f",value:0},tReflectionMap:{type:"t",value:null},tRefractionMap:{type:"t",value:null},tNormalMap0:{type:"t",value:null},tNormalMap1:{type:"t",value:null},textureMatrix:{type:"m4",value:null},config:{type:"v4",value:new THREE.Vector4},sunDirection:{type:"v3",value:new THREE.Vector3}},vertexShader:["#include <fog_pars_vertex>","uniform mat4 textureMatrix;","varying vec4 vCoord;","varying vec2 vUv;","varying vec2 worldPositionXZ;","varying vec3 vToEye;","#include <clipping_planes_pars_vertex>","#include <common>","#include <logdepthbuf_pars_vertex>","void main() {","   vUv = uv;","   vCoord = textureMatrix * vec4( position, 1.0 );","   vec4 worldPosition = modelMatrix * vec4( position, 1.0 );","   worldPositionXZ = (worldPosition.xz/worldPosition.w);","#ifdef USE_GLOBE","   worldPositionXZ = worldPositionXZ*max(1.0,pow(cameraPosition.y,0.05));","#endif","   vToEye = cameraPosition - worldPosition.xyz;","   gl_Position = projectionMatrix * (viewMatrix * worldPosition);","   #include <logdepthbuf_vertex>","   vec4 mvPosition = modelViewMatrix * vec4(position, 1.0);","   #include <clipping_planes_vertex>","   #include <fog_vertex>","}"].join("\n"),fragmentShader:["#include <common>","#include <fog_pars_fragment>","#ifdef USE_SHADOW","   uniform sampler2D tReflectionMap;","   uniform sampler2D tRefractionMap;","#endif","#ifdef USE_FLOWMAP","   uniform sampler2D tFlowMap;","#else","   uniform vec2 flowDirection;","#endif","const vec3 sunColor = vec3(1.0, 0.9803921568627451,0.803921568627451);","uniform sampler2D tNormalMap0;","uniform sampler2D tNormalMap1;","uniform vec4 waterColor;","uniform float reflectivity;","uniform vec4 config;","uniform float flowTime;","uniform vec3 sunDirection;","#include <clipping_planes_pars_fragment>","#include <logdepthbuf_pars_fragment>","varying vec4 vCoord;","varying vec2 vUv;","varying vec3 vToEye;","varying vec2 worldPositionXZ;","void sunLight( const vec3 surfaceNormal, const vec3 eyeDirection,in vec3 sunDir, inout vec3 diffuseColor, inout vec3 specularColor) {","   float diffuse = 0.5;","   vec3 _sunDir = normalize(sunDir);","   vec3 reflection = normalize( reflect( -_sunDir, surfaceNormal ) );","   diffuseColor += max( dot( _sunDir, surfaceNormal ), 0.0 ) * sunColor * diffuse;","   float direction = max( 0.0, dot( eyeDirection, reflection ) );","   specularColor += pow(direction, 300.0) * sunColor;","}","vec4 getNoise( vec2 uv, sampler2D normalSampler,float time) {","   vec2 uv0 = ( uv / 103.0 ) + vec2(time / 17.0, time / 29.0);","   vec2 uv1 = uv / 107.0-vec2( time / -19.0, time / 31.0 );","   vec2 uv2 = uv / vec2( 8907.0, 9803.0 ) + vec2( time / 101.0, time / 97.0 );","   vec2 uv3 = uv / vec2( 1091.0, 1027.0 ) - vec2( time / 109.0, time / -113.0 );","   vec4 noise = texture2D( normalSampler, uv0 ) +","       texture2D( normalSampler, uv1 ) +","       texture2D( normalSampler, uv2 ) +","       texture2D( normalSampler, uv3 );","   return noise * 0.5 - 1.0;","}","void main() {","   #include <clipping_planes_fragment>","   #include <logdepthbuf_fragment>","   float flowMapOffset0 = config.x;","   float flowMapOffset1 = config.y;","   float halfCycle = config.z;","   float scale = config.w*10.0;","   vec3 toEye = normalize( vToEye );","   vec2 flow;","#ifdef USE_FLOWMAP","   flow = texture2D( tFlowMap, vUv ).rg * 2.0 - 1.0;","#else","   flow = flowDirection;","#endif","   flow.x *= - 1.0;","   vec4 normalColor0 = texture2D( tNormalMap0, ( vUv * scale ) + flow * flowMapOffset0 );","   vec4 normalColor1 = texture2D( tNormalMap1, ( vUv * scale ) + flow * flowMapOffset1 );","   float flowLerp = abs( halfCycle - flowMapOffset0 ) / halfCycle;","   vec4 normalColor = mix( normalColor0, normalColor1, flowLerp );","   vec3 normal = normalize( vec3( normalColor.r * 2.0 - 1.0, normalColor.b,  normalColor.g * 2.0 - 1.0 )  );","   float theta = max( dot( toEye, normal ), 0.0 );","   float reflectance = reflectivity + ( 1.0 - reflectivity ) * pow( ( 1.0 - theta ), 5.0 );","   vec3 coord = vCoord.xyz / vCoord.w;","   vec2 uvReflect = coord.xy + coord.z * normal.xz * 0.03;","   vec2 uvRefract = coord.xy + coord.z * normal.xz * 0.01;","   vec4 reflectColor;","   vec4 refractColor;","#ifdef USE_FLOWMAP","   reflectColor = texture2D( tReflectionMap, vec2( 1.0 - uvReflect.x, uvReflect.y ));","#endif","#ifdef USE_SHADOW","   if(waterColor.a < 1.0){","       refractColor = texture2D( tRefractionMap, uvRefract );","   }","#endif","   vec3 _waterColor = waterColor.rgb;","   vec3 diffuseLight = vec3(0.0);","   vec3 specularLight = vec3(0.0);","   vec3 _noise = getNoise(-worldPositionXZ, tNormalMap0, flowTime).xyz;","   vec3 surfaceNormal = normalize(_noise.xzy * vec3( 1.5, 1.0, 1.5 ));","   sunLight( surfaceNormal.xyz, toEye,sunDirection, diffuseLight, specularLight);","   sunLight( surfaceNormal.xyz, toEye,vec3(-sunDirection.x,sunDirection.y,-sunDirection.z), diffuseLight, specularLight);","   sunLight( surfaceNormal.xyz, toEye,vec3(sunDirection.x,sunDirection.y,-sunDirection.z), diffuseLight, specularLight);","   sunLight( surfaceNormal.xyz, toEye,vec3(-sunDirection.x,sunDirection.y,sunDirection.z), diffuseLight, specularLight);","   sunLight( surfaceNormal.xyz, toEye,vec3(0,1,0), diffuseLight, specularLight);","   vec3 _reflectColor;","   #ifdef USE_SHADOW","       if(reflectColor.r<0.05 && reflectColor.g < 0.05 && reflectColor.b < 0.05){","           _reflectColor = vec3(_waterColor.r*1.5, _waterColor.g*1.4, _waterColor.b*1.3);","       }else{","           _reflectColor = mix(reflectColor.rgb, diffuseLight, 0.2);","       }","   #else","       _reflectColor = vec3(_waterColor.r*1.5, _waterColor.g*1.4, _waterColor.b*1.3);","   #endif","   vec3 _refractColor;","#ifdef USE_SHADOW","   if(waterColor.a < 1.0){","       _refractColor = refractColor.rgb*(1.0-waterColor.a) + _waterColor*waterColor.a;","   }else{","       _refractColor = vec3(_waterColor.r*0.45, _waterColor.g*0.55, _waterColor.b*0.75);","   }","#else","       _refractColor = vec3(_waterColor.r*0.45, _waterColor.g*0.55, _waterColor.b*0.75);","#endif","   vec3 finalColor = mix(_refractColor + specularLight, _reflectColor, reflectance);","   vec3 noiseScatter = max( 0.0, dot( surfaceNormal, toEye ) ) * _waterColor;","   finalColor = mix(finalColor, noiseScatter, 0.4);","   gl_FragColor = vec4(finalColor, 1.0);","   #include <tonemapping_fragment>","   #include <encodings_fragment>","   #include <fog_fragment>","}"].join("\n")},(()=>{class e extends THREE.MeshStandardMaterial{constructor(e){super(e),this.type="cloudStandard",this.roughness=1,this.metalness=0,this.originRoughness=1,this.originMetalness=0,this.pureColor=0,this.textureColor=0,this.imageFade=1,this.tintColor=new THREE.Color(16777215),this._referenceCount=1,this._imageByteSize=0,this.shift=.5,this.A=.64,this.B=.03,this.C=.02,this.D=.54,this.E=0,this.F=.81,this.scale=.92,this.receiveIBL=!0;const t=(new THREE.Color).setHex(3330982),i=[t.r,t.g,t.b,1];this.colorState=r.EnumShaderColorState.NONE,this.blinkColor=(new THREE.Vector4).fromArray(i),this.blinkCoefficient=0,this.fillMap=null,this.tag=null,this.viewshedCount=-1,this.viewshedContents=[],this.viewshedDepthMaps=[],this.videoCastCount=-1,this.videoCastContents=[],this.videoCastDepthMaps=[],this.videoCastProjectorMaps=[],this.localClipping=-1,this.innerClipping=-1,this.orthoViewProjMatrix=new THREE.Matrix4,this.heightLimitSampler=null,this.heightColorSampler=null,this.heightLimitOrthoMatrix=new THREE.Matrix4,this.heightLimit=0,this.useHeightLimit=!1,this.useCSM=r.GlobalData.EnableCSM,this.useCompressedNormal=!1,this.useCompressedColor=!1,this.useAlphaMap=!1,this.useForCap=!1,this.useClampToBorder=!1,this.useCompressedUv=!1,this.uvCenter=new THREE.Vector2(0,0),this.uvHalfExtent=new THREE.Vector2(0,0),this.samplerExcavation=null,this.cullOrthoMatrix=new THREE.Matrix4,this.uniforms=THREE.UniformsUtils.merge([THREE.UniformsLib.lights,THREE.UniformsLib.common,THREE.UniformsLib.lightmap,THREE.UniformsLib.bumpmap,THREE.UniformsLib.normalmap,THREE.UniformsLib.roughnessmap,THREE.UniformsLib.metalnessmap,THREE.UniformsLib.envmap,THREE.UniformsLib.fog,{emissive:{value:new THREE.Color(0)},roughness:{value:.5},metalness:{value:.5},envMapIntensity:{value:1}},{shift:{value:.5},A:{value:.64},B:{value:.03},C:{value:.02},D:{value:.54},E:{value:0},F:{value:.81},scale:{value:.92},colorState:{value:0},blinkColor:{value:(new THREE.Vector4).fromArray(i)},blinkCoefficient:{value:0},imageFade:{value:1},tintColor:{value:new THREE.Color(16777215)}},{fillMap:{value:null}},{viewshedCount:{value:-1},viewshedContents:{value:[]},viewshedDepthMaps:{value:[]}},{videoCastCount:{value:-1},videoCastContents:{value:[]},videoCastDepthMaps:{value:[]},videoCastProjectorMaps:{value:[]}},{localClipping:{value:-1},innerClipping:{value:this.innerClipping},orthoViewProjMatrix:{value:this.orthoViewProjMatrix}},{heightLimitSampler:{value:null},heightColorSampler:{value:null},heightLimitOrthoMatrix:{value:new THREE.Matrix4},heightLimit:{value:0},useHeightLimit:{value:!1}},{csmCascades:{value:null}},{useForCap:{value:!1}},{uvCenter:{value:new THREE.Vector2(0,0)},uvHalfExtent:{value:new THREE.Vector2(0,0)}},{u_SamplerExcavation:{value:null},u_CullOrthoMatrix:{value:new THREE.Matrix4}}]),this.vertexShader=THREE.ShaderChunk.cloudStandardVertex,this.fragmentShader=THREE.ShaderChunk.cloudStandardFragment,this.defaultAttributeValues={color:[1,1,1],uv:[0,0],uv2:[0,0]},void 0!==e&&(void 0!==e.attributes&&console.error("IBLMaterial: attributes should now be defined in THREE.BufferGeometry instead."),null!=e.doubleSide&&e.doubleSide&&(this.side=THREE.DoubleSide),this.setValues(e)),this.lights&&(this.uniforms=THREE.UniformsUtils.merge([this.uniforms,THREE.UniformsLib.lights])),this.useCSM?this.defines.USE_CSM="":delete this.defines.USE_CSM,this.useAlphaMap?this.defines.USE_ALPHAMAP="":delete this.defines.USE_ALPHAMAP}destroy(){THREE.MeshStandardMaterial.prototype.dispose.call(this),this.blinkColor=null,this.uniforms=null,this.defaultAttributeValues=null,this.lights=null,this.uvCenter=null,this.uvHalfExtent=null}setValues(e){if(void 0!==e)for(const t in e){const i=e[t];if(void 0===i){console.warn("THREE.Material: '"+t+"' parameter is undefined.");continue}const r=this[t];void 0!==r&&(r&&r.isColor?r.set(i):r&&r.isVector3&&i&&i.isVector3?r.copy(i):this[t]="overdraw"===t?Number(i):i)}}copy(e){for(var t in THREE.MeshStandardMaterial.prototype.copy.call(this,e),this.shift=e.shift,this.A=e.A,this.B=e.B,this.C=e.C,this.D=e.D,this.E=e.E,this.F=e.F,this.scale=e.scale,this.colorState=e.colorState,this.blinkColor.copy(e.blinkColor),this.blinkCoefficient=e.blinkCoefficient,this.imageFade=e.imageFade,this.tintColor.copy(e.tintColor),this.fillMap=e.fillMap,this.localClipping=e.localClipping,this.innerClipping=e.innerClipping,this.orthoViewProjMatrix.copy(e.orthoViewProjMatrix),this.viewshedCount=e.viewshedCount,this.viewshedContents=e.viewshedContents,this.viewshedDepthMaps=e.viewshedDepthMaps,this.videoCastCount=e.videoCastCount,this.videoCastContents=e.videoCastContents,this.videoCastDepthMaps=e.videoCastDepthMaps,this.videoCastProjectorMaps=e.videoCastProjectorMaps,this.heightLimitSampler=e.heightLimitSampler,this.heightColorSampler=e.heightColorSampler,this.heightLimitOrthoMatrix=e.heightLimitOrthoMatrix,this.heightLimit=e.heightLimit,this.useHeightLimit=e.useHeightLimit,this.useCSM=e.useCSM,this.useCompressedColor=e.useCompressedColor,this.useCompressedNormal=e.useCompressedNormal,this.useCompressedUv=e.useCompressedUv,this.uvCenter=e.uvCenter,this.uvHalfExtent=e.uvHalfExtent,this.u_SamplerExcavation=e.samplerExcavation,this.u_CullOrthoMatrix=e.cullOrthoMatrix,e.defines)this.defines[t]=e.defines[t];return this.refreshUniforms(),this}refreshUniforms(){this.uniforms.shift.value=this.shift,this.uniforms.A.value=this.A,this.uniforms.B.value=this.B,this.uniforms.C.value=this.C,this.uniforms.D.value=this.D,this.uniforms.E.value=this.E,this.uniforms.F.value=this.F,this.uniforms.scale.value=this.scale,this.uniforms.blinkColor.value.copy(this.blinkColor),this.uniforms.blinkCoefficient.value=this.blinkCoefficient,this.uniforms.colorState.value=this.colorState,this.uniforms.imageFade.value=this.imageFade,this.uniforms.tintColor.value.copy(this.tintColor),this.uniforms.fillMap.value=this.fillMap,this.uniforms.localClipping.value=this.localClipping,this.uniforms.innerClipping.value=this.innerClipping,this.uniforms.orthoViewProjMatrix.value.copy(this.orthoViewProjMatrix),this.uniforms.viewshedCount.value=this.viewshedCount,this.uniforms.viewshedContents.value=this.viewshedContents,this.uniforms.viewshedDepthMaps.value=this.viewshedDepthMaps,this.uniforms.videoCastCount.value=this.videoCastCount,this.uniforms.videoCastContents.value=this.videoCastContents,this.uniforms.videoCastDepthMaps.value=this.videoCastDepthMaps,this.uniforms.videoCastProjectorMaps.value=this.videoCastProjectorMaps,this.uniforms.uvCenter.value=this.uvCenter,this.uniforms.uvHalfExtent.value=this.uvHalfExtent,this.viewshedCount>0?this.defines.VIEW_SHED_MODE="":delete this.defines.VIEW_SHED_MODE,this.videoCastCount>0?this.defines.VIDEO_CAST_MODE="":delete this.defines.VIDEO_CAST_MODE,this.heightLimitSampler?this.defines.HEIGHT_LIMIT_READ="":delete this.defines.HEIGHT_LIMIT_READ,this.uniforms.heightLimitOrthoMatrix.value=this.heightLimitOrthoMatrix,this.uniforms.heightLimitSampler.value=this.heightLimitSampler,this.uniforms.heightColorSampler.value=this.heightColorSampler,this.uniforms.heightLimit.value=this.heightLimit,this.uniforms.useHeightLimit.value=this.useHeightLimit,this.useCSM?this.defines.USE_CSM="":delete this.defines.USE_CSM,this.useAlphaMap?this.defines.USE_ALPHAMAP="":delete this.defines.USE_ALPHAMAP,this.useCompressedColor?this.defines.CCOLOR="":delete this.defines.CCOLOR,this.useMultiBlinkColor?this.defines.USE_MULTI_BLINK_COLOR="":delete this.defines.USE_MULTI_BLINK_COLOR,this.useCompressedNormal?this.defines.CNORMAL="":delete this.defines.CNORMAL,this.uniforms.useForCap.value=this.useForCap,this.useClampToBorder?this.defines.USE_CLAMP_TO_BORDER="":delete this.defines.USE_CLAMP_TO_BORDER,this.useCompressedUv?this.defines.USE_COMPRESS_UV="":delete this.defines.USE_COMPRESS_UV,this.uniforms.u_SamplerExcavation.value=this.samplerExcavation,this.uniforms.u_CullOrthoMatrix.value=this.cullOrthoMatrix}setBlinkColor(e){this.blinkColor.fromArray(e.toArray()),this.uniforms.blinkColor.value.copy(this.blinkColor),this.uniforms.blinkCoefficient.value=this.blinkCoefficient,this.uniforms.colorState.value=r.EnumShaderColorState.BLINK}updateBlinkUniformValue(e,t,i){this.uniforms.colorState.value=e,this.uniforms.blinkColor.value.copy(t),this.uniforms.blinkCoefficient.value=i}resetBlinkUniformValue(){this.uniforms.colorState.value=this.colorState,this.uniforms.blinkColor.value.copy(this.blinkColor),this.uniforms.blinkCoefficient.value=this.blinkCoefficient}updateExcavation(e){e&&e.isExcavation?(this.defines.EXCAVATION_MODE="",this.samplerExcavation=e.samplerExcavation,this.cullOrthoMatrix=e.cullOrthoMatrix):(delete this.defines.EXCAVATION_MODE,this.samplerExcavation=null,this.cullOrthoMatrix.identity()),this.refreshUniforms()}updateSide(e){(e||{}).isExcavation||r.GlobalData.EnableSkylinePass?this.side=THREE.DoubleSide:this.side=THREE.FrontSide}}r.CloudStandardMaterial=e})(),(()=>{class e extends THREE.ShaderMaterial{constructor(e){super(),this.type="CloudPMMeshPhongMaterial",this.packingMatMap=e.packingMatTexture,this.color=new THREE.Color(16777215),this.specular=new THREE.Color(1118481),this.shininess=30,this.emissive=new THREE.Color(0),this.isShaderMaterial=!0,this.map=null,this.pureColor=0,this.textureColor=0,this.imageFade=1,this.tintColor=new THREE.Color(16777215),this._referenceCount=1,this._imageByteSize=0,this.shift=.5,this.A=.64,this.B=.03,this.C=.02,this.D=.54,this.E=0,this.F=.81,this.scale=.92,this.receiveIBL=!0;const t=(new THREE.Color).setHex(3330982),i=[t.r,t.g,t.b,1];this.colorState=r.EnumShaderColorState.NONE,this.blinkColor=(new THREE.Vector4).fromArray(i),this.blinkCoefficient=0,this.fillMap=null,this.tag=null,this.viewshedCount=-1,this.viewshedContents=[],this.viewshedDepthMaps=[],this.videoCastCount=-1,this.videoCastContents=[],this.videoCastDepthMaps=[],this.videoCastProjectorMaps=[],this.localClipping=-1,this.innerClipping=-1,this.orthoViewProjMatrix=new THREE.Matrix4,this.heightLimitSampler=null,this.heightColorSampler=null,this.heightLimitOrthoMatrix=new THREE.Matrix4,this.heightLimit=0,this.useHeightLimit=!1,this.useCSM=r.GlobalData.EnableCSM,this.useCompressedNormal=!1,this.useCompressedColor=!1,this.useAlphaMap=!1,this.useForCap=!1,this.useClampToBorder=!1,this.useCompressedUv=!1,this.uvCenter=new THREE.Vector2(0,0),this.uvHalfExtent=new THREE.Vector2(0,0),this.samplerExcavation=null,this.cullOrthoMatrix=new THREE.Matrix4,this.uniforms=THREE.UniformsUtils.merge([THREE.UniformsLib.common,THREE.UniformsLib.lights,THREE.UniformsLib.lightmap,THREE.UniformsLib.bumpmap,THREE.UniformsLib.normalmap,THREE.UniformsLib.envmap,THREE.UniformsLib.fog,{diffuse:{value:new THREE.Color(16711680)},opacity:{value:1},specular:{value:new THREE.Color(1118481)},shininess:{value:30},emissive:{value:new THREE.Color(0)},backSceneTexture:{value:null},viewportSize:{value:new THREE.Vector2(0,0)}},{packingMatMap:{value:null}},{fillMap:{value:null}},{shift:{value:.5},A:{value:.64},B:{value:.03},C:{value:.02},D:{value:.54},E:{value:0},F:{value:.81},scale:{value:.92},colorState:{value:0},blinkColor:{value:(new THREE.Vector4).fromArray(i)},blinkCoefficient:{value:0},imageFade:{value:1},tintColor:{value:new THREE.Color(16777215)}},{viewshedCount:{value:-1},viewshedContents:{value:[]},viewshedDepthMaps:{value:[]}},{videoCastCount:{value:-1},videoCastContents:{value:[]},videoCastDepthMaps:{value:[]},videoCastProjectorMaps:{value:[]}},{localClipping:{value:-1},innerClipping:{value:this.innerClipping},orthoViewProjMatrix:{value:this.orthoViewProjMatrix}},{heightLimitSampler:{value:null},heightColorSampler:{value:null},heightLimitOrthoMatrix:{value:new THREE.Matrix4},heightLimit:{value:0},useHeightLimit:{value:!1}},{csmCascades:{value:null}},{useForCap:{value:!1}},{uvCenter:{value:new THREE.Vector2(0,0)},uvHalfExtent:{value:new THREE.Vector2(0,0)}},{u_SamplerExcavation:{value:null},u_CullOrthoMatrix:{value:new THREE.Matrix4}}]),this.vertexShader=THREE.ShaderChunk.cloudPMPhongVertex,this.fragmentShader=THREE.ShaderChunk.cloudPMPhongFragment,this.lights=!0,this.defaultAttributeValues={color:[1,1,1],uv:[0,0],uv2:[0,0]},void 0!==e&&(void 0!==e.attributes&&console.error("PhongLightingMaterial: attributes should now be defined in THREE.BufferGeometry instead."),this.setValues(e)),this.lights&&(this.uniforms=THREE.UniformsUtils.merge([this.uniforms,THREE.UniformsLib.lights])),this.useCSM?this.defines.USE_CSM="":delete this.defines.USE_CSM,this.useAlphaMap?this.defines.USE_ALPHAMAP="":delete this.defines.USE_ALPHAMAP,this.refreshUniforms()}copy(e){for(var t in super.copy(e),this.color.copy(e.color),this.opacity.copy(e.opacity),this.specular.copy(e.specular),this.shininess=e.shininess,this.emissive.copy(e.emissive),this.packingMatMap=e.packingMatMap,this.map=e.map,this.shift=e.shift,this.A=e.A,this.B=e.B,this.C=e.C,this.D=e.D,this.E=e.E,this.F=e.F,this.scale=e.scale,this.colorState=e.colorState,this.blinkColor.copy(e.blinkColor),this.blinkCoefficient=e.blinkCoefficient,this.imageFade=e.imageFade,this.tintColor.copy(e.tintColor),this.fillMap=e.fillMap,this.localClipping=e.localClipping,this.innerClipping=e.innerClipping,this.orthoViewProjMatrix.copy(e.orthoViewProjMatrix),this.viewshedCount=e.viewshedCount,this.viewshedContents=e.viewshedContents,this.viewshedDepthMaps=e.viewshedDepthMaps,this.videoCastCount=e.videoCastCount,this.videoCastContents=e.videoCastContents,this.videoCastDepthMaps=e.videoCastDepthMaps,this.videoCastProjectorMaps=e.videoCastProjectorMaps,this.heightLimitSampler=e.heightLimitSampler,this.heightColorSampler=e.heightColorSampler,this.heightLimitOrthoMatrix=e.heightLimitOrthoMatrix,this.heightLimit=e.heightLimit,this.useHeightLimit=e.useHeightLimit,this.useCSM=e.useCSM,this.useCompressedColor=e.useCompressedColor,this.useCompressedNormal=e.useCompressedNormal,this.useCompressedUv=e.useCompressedUv,this.uvCenter=e.uvCenter,this.uvHalfExtent=e.uvHalfExtent,this.u_SamplerExcavation=e.samplerExcavation,this.u_CullOrthoMatrix=e.cullOrthoMatrix,e.defines)this.defines[t]=e.defines[t];return this.refreshUniforms(),this}refreshUniforms(){this.uniforms.diffuse.value.set(this.color),this.uniforms.opacity.value=this.opacity,this.uniforms.specular.value.set(this.specular),this.uniforms.shininess.value=this.shininess,this.uniforms.emissive.value.set(this.emissive),this.uniforms.map.value=this.map,null!=this.packingMatMap&&(this.uniforms.packingMatMap.value=this.packingMatMap),this.uniforms.A.value=this.A,this.uniforms.B.value=this.B,this.uniforms.C.value=this.C,this.uniforms.D.value=this.D,this.uniforms.E.value=this.E,this.uniforms.F.value=this.F,this.uniforms.scale.value=this.scale,this.uniforms.blinkColor.value.copy(this.blinkColor),this.uniforms.blinkCoefficient.value=this.blinkCoefficient,this.uniforms.colorState.value=this.colorState,this.uniforms.imageFade.value=this.imageFade,this.uniforms.tintColor.value.copy(this.tintColor),this.uniforms.fillMap.value=this.fillMap,this.uniforms.localClipping.value=this.localClipping,this.uniforms.innerClipping.value=this.innerClipping,this.uniforms.orthoViewProjMatrix.value.copy(this.orthoViewProjMatrix),this.uniforms.viewshedCount.value=this.viewshedCount,this.uniforms.viewshedContents.value=this.viewshedContents,this.uniforms.viewshedDepthMaps.value=this.viewshedDepthMaps,this.uniforms.videoCastCount.value=this.videoCastCount,this.uniforms.videoCastContents.value=this.videoCastContents,this.uniforms.videoCastDepthMaps.value=this.videoCastDepthMaps,this.uniforms.videoCastProjectorMaps.value=this.videoCastProjectorMaps,this.uniforms.uvCenter.value=this.uvCenter,this.uniforms.uvHalfExtent.value=this.uvHalfExtent,this.viewshedCount>0?this.defines.VIEW_SHED_MODE="":delete this.defines.VIEW_SHED_MODE,this.videoCastCount>0?this.defines.VIDEO_CAST_MODE="":delete this.defines.VIDEO_CAST_MODE,this.heightLimitSampler?this.defines.HEIGHT_LIMIT_READ="":delete this.defines.HEIGHT_LIMIT_READ,this.uniforms.heightLimitOrthoMatrix.value=this.heightLimitOrthoMatrix,this.uniforms.heightLimitSampler.value=this.heightLimitSampler,this.uniforms.heightColorSampler.value=this.heightColorSampler,this.uniforms.heightLimit.value=this.heightLimit,this.uniforms.useHeightLimit.value=this.useHeightLimit,this.useCSM?this.defines.USE_CSM="":delete this.defines.USE_CSM,this.useAlphaMap?this.defines.USE_ALPHAMAP="":delete this.defines.USE_ALPHAMAP,this.useCompressedColor?this.defines.CCOLOR="":delete this.defines.CCOLOR,this.useMultiBlinkColor?this.defines.USE_MULTI_BLINK_COLOR="":delete this.defines.USE_MULTI_BLINK_COLOR,this.useCompressedNormal?this.defines.CNORMAL="":delete this.defines.CNORMAL,this.uniforms.useForCap.value=this.useForCap,this.useClampToBorder?this.defines.USE_CLAMP_TO_BORDER="":delete this.defines.USE_CLAMP_TO_BORDER,this.useCompressedUv?this.defines.USE_COMPRESS_UV="":delete this.defines.USE_COMPRESS_UV,this.uniforms.u_SamplerExcavation.value=this.samplerExcavation,this.uniforms.u_CullOrthoMatrix.value=this.cullOrthoMatrix}setValues(e){if(void 0!==e)for(const t in e){const i=e[t];if(void 0===i){console.warn("THREE.Material: '"+t+"' parameter is undefined.");continue}const r=this[t];void 0!==r&&(r&&r.isColor?r.set(i):r&&r.isVector3&&i&&i.isVector3?r.copy(i):this[t]="overdraw"===t?Number(i):i)}}}r.CloudPMMeshPhongMaterial=e})(),(()=>{class e extends THREE.MeshBasicMaterial{constructor(e){super(e),this.type="CLOUDMeshBasicMaterial",this.defines={},this.vertexShader=r.ClippingStencilShader.vertexShader,this.fragmentShader=r.ClippingStencilShader.fragmentShader,this.uniforms=THREE.ShaderLib.basic.uniforms}}r.ClippingStencilMaterial=e})(),function(){const e="\n        vec4 mvPosition = modelViewMatrix * vec4(getInstancePosition(transformed), 1.0);\n        gl_Position = projectionMatrix * mvPosition;\n    ";class t extends THREE.MeshDepthMaterial{constructor(t){super(t),this.type="InstancedDepthMaterial",this.uniforms=THREE.UniformsUtils.merge([THREE.ShaderLib.depth.uniforms,{discardAlpha:{value:0}}]),this.vertexShader=function(t){return t.replace("#include <project_vertex>",e)}(THREE.ShaderLib.depth.vertexShader.replace("void main() {","\n            attribute float vState;            \n            attribute vec4 aColor;            \n            attribute vec3 mcol0;\n            attribute vec3 mcol1;\n            attribute vec3 mcol2;\n            attribute vec3 mcol3;\n            #if defined(USE_MAP)\n                attribute vec2 muvCol0;\n                attribute vec2 muvCol1;\n                attribute vec2 muvCol2;\n            #endif\n            \n            varying float vfState;\n            \n            vec3 getInstancePosition(vec3 position) {\n                return vec3(mat4(vec4(mcol0, 0.0),\n                                 vec4(mcol1, 0.0),\n                                 vec4(mcol2, 0.0),\n                                 vec4(mcol3, 1.0)) * vec4(position, 1.0));\n            }\n            \n            void main() {\n                vfState = vState;\n        ")),this.fragmentShader=THREE.ShaderLib.depth.fragmentShader.replace("void main() {","\n            varying float vfState;            \n            void main() {\n                if (vfState <= -0.99 && vfState >= -1.01) discard;\n                \n        ")}}r.InstancedDepthMaterial=t}(),function(){class e extends THREE.MeshBasicMaterial{constructor(e){var t;super(e),this.type="InstancedMeshBasicMaterial",this.innerClipping=-1,this.orthoViewProjMatrix=new THREE.Matrix4,this.uniforms=THREE.UniformsUtils.merge([THREE.ShaderLib.basic.uniforms,{orthoViewProjMatrix:{value:this.orthoViewProjMatrix},innerClipping:{value:this.innerClipping}}]),this.vertexShader=function(e){return e.replace("#include <clipping_planes_vertex>","\n                #include <clipping_planes_vertex>\n                wPositionForInnerClipping = modelMatrix * vec4(getInstancePosition(transformed), 1.0);\n            ").replace("#include <project_vertex>","\n        vec4 mvPosition = modelViewMatrix * vec4(getInstancePosition(transformed), 1.0);\n        gl_Position = projectionMatrix * mvPosition;\n    ")}(THREE.ShaderLib.basic.vertexShader.replace("#include <clipping_planes_pars_vertex>","\n                #include <clipping_planes_pars_vertex>\n                varying vec4 wPositionForInnerClipping;\n            ").replace("void main() {","\n            attribute float vState;           \n            attribute vec3 mcol0;\n            attribute vec3 mcol1;\n            attribute vec3 mcol2;\n            attribute vec3 mcol3; \n            varying float vfState;\n            \n            vec3 getInstancePosition(vec3 position) {\n                return vec3(mat4(vec4(mcol0, 0.0),\n                                 vec4(mcol1, 0.0),\n                                 vec4(mcol2, 0.0),\n                                 vec4(mcol3, 1.0)) * vec4(position, 1.0));\n            }\n            \n            void main() {\n                vfState = vState;\n        ")),this.fragmentShader=(t=THREE.ShaderLib.basic.fragmentShader,t.replace("#include <clipping_planes_pars_fragment>","\n                #include <clipping_planes_pars_fragment>\n                uniform mat4 orthoViewProjMatrix;\n                uniform int innerClipping;\n                varying vec4 wPositionForInnerClipping;\n            ").replace("#include <clipping_planes_fragment>","\n                if (innerClipping > 0) \n                {\n                    vec4 clipPosition = orthoViewProjMatrix * wPositionForInnerClipping;\n                    clipPosition.xyz /= clipPosition.w;\n                    if (clipPosition.x >= -1.0 && clipPosition.x <= 1.0 &&\n                        clipPosition.y >= -1.0 && clipPosition.y <= 1.0 && clipPosition.z >= -1.0) \n                    {\n                        discard;\n                    }\n                }\n                else\n                {\n                    #include <clipping_planes_fragment>\n                }\n            ").replace("void main() {","\n            varying float vfState;            \n            void main() {\n                if (vfState <= -0.99 && vfState >= -1.01) discard;\n                \n        "))}copy(e){return THREE.MeshBasicMaterial.prototype.copy.call(this,e),this.orthoViewProjMatrix.copy(e.orthoViewProjMatrix),this.innerClipping=e.innerClipping,this}refreshUniforms(){this.uniforms.orthoViewProjMatrix.value.copy(this.orthoViewProjMatrix),this.uniforms.innerClipping.value=this.innerClipping}}r.InstancedMeshBasicMaterial=e}(),function(){class e extends THREE.MeshDepthMaterial{constructor(e){super(e),this.type="LogNoAvailDepthMaterial",this.uniforms=THREE.ShaderLib.depth.uniforms,this.vertexShader=THREE.ShaderLib.depth.vertexShader,this.fragmentShader="\n                #if DEPTH_PACKING == 3200\n                    uniform float opacity;\n                #endif\n                #include <common>\n                #include <packing>\n                #include <uv_pars_fragment>\n                #include <map_pars_fragment>\n                #include <alphamap_pars_fragment>\n                //r142\n                //#include <alphatest_pars_fragment>\n                #include <clipping_planes_pars_fragment>\n                void main() {\n                    #include <clipping_planes_fragment>\n                    vec4 diffuseColor = vec4( 1.0 );\n                    #if DEPTH_PACKING == 3200\n                        diffuseColor.a = opacity;\n                    #endif\n                    #include <map_fragment>\n                    #include <alphamap_fragment>\n                    #include <alphatest_fragment>\n                    #if DEPTH_PACKING == 3200\n                        gl_FragColor = vec4( vec3( gl_FragCoord.z ), opacity );\n                    #elif DEPTH_PACKING == 3201\n                        gl_FragColor = packDepthToRGBA( gl_FragCoord.z );\n                    #endif\n                }"}}r.LogNoAvailDepthMaterial=e}(),function(){const e="\n        vec4 mvPosition = modelViewMatrix * vec4(getInstancePosition(transformed), 1.0);\n        gl_Position = projectionMatrix * mvPosition;\n    ";class t extends r.LogNoAvailDepthMaterial{constructor(t){super(t),this.type="LogNoAvailInstancedDepthMaterial",this.uniforms=THREE.ShaderLib.depth.uniforms,this.vertexShader=function(t){return t.replace("#include <project_vertex>",e)}(THREE.ShaderLib.depth.vertexShader.replace("void main() {","\n            attribute float vState;\n            attribute vec4 aColor;\n            attribute vec3 mcol0;\n            attribute vec3 mcol1;\n            attribute vec3 mcol2;\n            attribute vec3 mcol3;\n            #if defined(USE_MAP)\n                attribute vec2 muvCol0;\n                attribute vec2 muvCol1;\n                attribute vec2 muvCol2;\n            #endif\n\n            varying float vfState;\n\n            vec3 getInstancePosition(vec3 position) {\n                return vec3(mat4(vec4(mcol0, 0.0),\n                                 vec4(mcol1, 0.0),\n                                 vec4(mcol2, 0.0),\n                                 vec4(mcol3, 1.0)) * vec4(position, 1.0));\n            }\n\n            void main() {\n                vfState = vState;\n        ")),this.fragmentShader=this.fragmentShader.replace("void main() {","\n            varying float vfState;\n            void main() {\n                if (vfState <= -0.99 && vfState >= -1.01) discard;\n\n        ")}}r.LogNoAvailInstancedDepthMaterial=t}(),function(){class e extends THREE.MeshDepthMaterial{constructor(e){super(e),this.type="CustomMeshDepthMaterial",this.uniforms=THREE.UniformsUtils.merge([THREE.ShaderLib.depth.uniforms,{forceLogDepth:{value:!1},forceLogDepthBufFC:{value:1},forceCustomDepth:{value:!1},customDepth:{value:0}}]),this.vertexShader="\n                #include <common>\n                #include <uv_pars_vertex>\n                #include <displacementmap_pars_vertex>\n                #include <morphtarget_pars_vertex>\n                #include <skinning_pars_vertex>\n                #include <logdepthbuf_pars_vertex>\n                #include <clipping_planes_pars_vertex>\n                varying float forceFragDepth;\n                void main() {\n                    #include <uv_vertex>\n                    #include <skinbase_vertex>\n                    #include <begin_vertex>\n                    #include <displacementmap_vertex>\n                    #include <morphtarget_vertex>\n                    #include <skinning_vertex>\n                    #include <project_vertex>\n                    #include <logdepthbuf_vertex>\n                    forceFragDepth = 1.0 + gl_Position.w;\n                    #include <clipping_planes_vertex>\n                }\n            ",this.fragmentShader="\n                #if DEPTH_PACKING == 3200\n                    uniform float opacity;\n                #endif\n                #include <common>\n                #include <packing>\n                #include <uv_pars_fragment>\n                #include <map_pars_fragment>\n                //r142\n                //#include <alphatest_pars_fragment>\n                #include <alphamap_pars_fragment>\n                #include <logdepthbuf_pars_fragment>\n                #include <clipping_planes_pars_fragment>\n                uniform bool forceLogDepth;\n                uniform float forceLogDepthBufFC;\n                uniform bool forceCustomDepth;\n                uniform float customDepth;\n                varying float forceFragDepth;\n\n                void main() {\n                    #include <clipping_planes_fragment>\n                    vec4 diffuseColor = vec4( 1.0 );\n                    #if DEPTH_PACKING == 3200\n                        diffuseColor.a = opacity;\n                    #endif\n                    #include <map_fragment>\n                    #include <alphamap_fragment>\n                    #include <alphatest_fragment>\n                    #include <logdepthbuf_fragment>\n                    #if defined(USE_LOGDEPTHBUF) && defined(USE_LOGDEPTHBUF_EXT)\n                        float fragZ = vIsPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;\n                    #else\n                        float fragZ = gl_FragCoord.z;\n                    #endif\n                    if (forceLogDepth)\n                    {\n                        fragZ = log2( forceFragDepth ) * forceLogDepthBufFC * 0.5;\n                    }\n                    if (forceCustomDepth)\n                    {\n                        fragZ = customDepth;\n                    }\n\n                    #if DEPTH_PACKING == 3200\n                        gl_FragColor = vec4( vec3( fragZ ), opacity );\n                    #elif DEPTH_PACKING == 3201\n                        gl_FragColor = packDepthToRGBA( fragZ );\n                    #endif\n                }\n            "}}r.CustomMeshDepthMaterial=e}(),function(){class e extends THREE.MeshDepthMaterial{constructor(e){super(e),this.type="CustomInstancedMeshDepthMaterial",this.uniforms=THREE.UniformsUtils.merge([THREE.ShaderLib.depth.uniforms,{forceLogDepth:{value:!1},forceLogDepthBufFC:{value:1},forceCustomDepth:{value:!1},customDepth:{value:0},discardAlpha:{value:0}}]),this.vertexShader="\n                #include <common>\n                #include <uv_pars_vertex>\n                #include <displacementmap_pars_vertex>\n                #include <morphtarget_pars_vertex>\n                #include <skinning_pars_vertex>\n                #include <logdepthbuf_pars_vertex>\n                #include <clipping_planes_pars_vertex>\n                varying float forceFragDepth;\n                \n                attribute float vState;\n                attribute vec4 aColor;\n                attribute vec3 mcol0;\n                attribute vec3 mcol1;\n                attribute vec3 mcol2;\n                attribute vec3 mcol3;\n                #if defined(USE_MAP)\n                    attribute vec2 muvCol0;\n                    attribute vec2 muvCol1;\n                    attribute vec2 muvCol2;\n                #endif\n\n                varying float vfState;\n                varying float vAlpha;\n\n                vec3 getInstancePosition(vec3 position) {\n                    return vec3(mat4(vec4(mcol0, 0.0),\n                                    vec4(mcol1, 0.0),\n                                    vec4(mcol2, 0.0),\n                                    vec4(mcol3, 1.0)) * vec4(position, 1.0));\n                }\n\n                void main() {\n                    vfState = vState;\n                        \n                    #include <uv_vertex>\n                    #include <skinbase_vertex>\n                    #include <begin_vertex>\n                    #include <displacementmap_vertex>\n                    #include <morphtarget_vertex>\n                    #include <skinning_vertex>\n                    \n                    vec4 mvPosition = modelViewMatrix * vec4(getInstancePosition(transformed), 1.0);\n                    gl_Position = projectionMatrix * mvPosition;\n                    vAlpha = aColor.a;\n                    #include <logdepthbuf_vertex>\n                    forceFragDepth = 1.0 + gl_Position.w;\n                    #include <clipping_planes_vertex>\n                }\n            ",this.fragmentShader="\n                #if DEPTH_PACKING == 3200\n                    uniform float opacity;\n                #endif\n                #include <common>\n                #include <packing>\n                #include <uv_pars_fragment>\n                #include <map_pars_fragment>\n                #include <alphamap_pars_fragment>\n                #include <logdepthbuf_pars_fragment>\n                //r142\n                //#include <alphatest_pars_fragment>\n                #include <clipping_planes_pars_fragment>\n                uniform bool forceLogDepth;\n                uniform float forceLogDepthBufFC;\n                uniform bool forceCustomDepth;\n                uniform float customDepth;\n                uniform float discardAlpha;\n                varying float forceFragDepth;\n                \n                varying float vfState;\n                varying float vAlpha;\n                void main() {\n                    if (vfState <= -0.99 && vfState >= -1.01) discard;\n                    if (vAlpha <= discardAlpha && vAlpha >= 0.0) discard;\n\n                    #include <clipping_planes_fragment>\n                    vec4 diffuseColor = vec4( 1.0 );\n                    #if DEPTH_PACKING == 3200\n                        diffuseColor.a = opacity;\n                    #endif\n                    #include <map_fragment>\n                    #include <alphamap_fragment>\n                    #include <alphatest_fragment>\n                    #include <logdepthbuf_fragment>\n                    #if defined(USE_LOGDEPTHBUF) && defined(USE_LOGDEPTHBUF_EXT)\n                        float fragZ = vIsPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;\n                    #else\n                        float fragZ = gl_FragCoord.z;\n                    #endif\n                    \n                    if (forceLogDepth)\n                    {\n                        fragZ = log2( forceFragDepth ) * forceLogDepthBufFC * 0.5;\n                    }\n                    if (forceCustomDepth)\n                    {\n                        fragZ = customDepth;\n                    }\n\n                    #if DEPTH_PACKING == 3200\n                        gl_FragColor = vec4( vec3( fragZ ), opacity );\n                    #elif DEPTH_PACKING == 3201\n                        gl_FragColor = packDepthToRGBA( fragZ );\n                    #endif\n                }\n            "}}r.CustomInstancedMeshDepthMaterial=e}(),function(){class e extends THREE.MeshBasicMaterial{constructor(e){super(e),this.type="PickingExcavationMaterial",this.vertexShader="\n                #include <common>\n                #include <morphtarget_pars_vertex>\n                #include <skinning_pars_vertex>\n                #include <logdepthbuf_pars_vertex>\n\n                uniform mat4 u_CullOrthoMatrix;\n                varying vec3 v_CullOrthoPosition;\n\n                void main()\n                {\n                    vec4 othPos = u_CullOrthoMatrix * (modelMatrix * vec4(position, 1.0));\n                    othPos /= othPos.w;\n                    v_CullOrthoPosition = othPos.xyz;\n\n                    #include <skinbase_vertex>\n                    #include <begin_vertex>\n                    #include <morphtarget_vertex>\n                    #include <skinning_vertex>\n\n                    #ifdef USE_SKINNING\n                        vec4 wPosition = modelMatrix * skinned;\n                    #else\n                        vec4 wPosition = modelMatrix * vec4( transformed, 1.0 );\n                    #endif\n\n                    vec4 mvPosition = viewMatrix * wPosition;\n                    gl_Position = projectionMatrix * mvPosition;\n            \n                    #include <logdepthbuf_vertex>\n                    #include <worldpos_vertex>\n                }\n            ",this.fragmentShader="\n                #include <common>\n                #include <logdepthbuf_pars_fragment>\n        \n                varying vec3 v_CullOrthoPosition;\n                uniform sampler2D  u_SamplerExcavation;\n                \n                vec2 postProjToScreen(vec2 position)\n                {\n                    vec2 screenPos = position;\n                    return 0.5 *(vec2(screenPos.x, screenPos.y) + 1.0);\n                }\n        \n                void main()\n                {   \n                    vec2 uv = postProjToScreen(v_CullOrthoPosition.xy);\n                    vec4 resultColor = vec4(1.0);\n                    if(uv.x >= 0.0 && uv.x <= 1.0 && uv.y >= 0.0 && uv.y <= 1.0)\n                    {\n                        vec4 color = texture2D(u_SamplerExcavation, uv);\n                        if(color.r > 0.0001)\n                        {\n                            resultColor = vec4(0.0);\n                        }\n                    } \n                    \n                    #include <logdepthbuf_fragment>\n                    gl_FragColor = resultColor;\n                }\n            ",this.samplerExcavation=null,this.cullOrthoMatrix=new THREE.Matrix4,this.uniforms=THREE.UniformsUtils.merge([THREE.ShaderLib.basic.uniforms,{u_SamplerExcavation:{value:this.samplerExcavation},u_CullOrthoMatrix:{value:this.cullOrthoMatrix}}])}refreshUniforms(){this.uniforms.u_SamplerExcavation.value=this.samplerExcavation,this.uniforms.u_CullOrthoMatrix.value=this.cullOrthoMatrix}updateExcavation(e){e&&e.isExcavation?(this.samplerExcavation=e.samplerExcavation,this.cullOrthoMatrix=e.cullOrthoMatrix):(this.samplerExcavation=null,this.cullOrthoMatrix.identity()),this.refreshUniforms()}updateSide(e){(e||{}).isExcavation||r.GlobalData.EnableSkylinePass?this.side=THREE.DoubleSide:this.side=THREE.FrontSide}}r.PickingExcavationMaterial=e}(),function(){class e extends THREE.MeshBasicMaterial{constructor(e){super(e),this.defines={},this.type="MapBasicClipMaterial",this.innerClipping=-1,this.orthoViewProjMatrix=new THREE.Matrix4,this.uniforms=THREE.UniformsUtils.merge([THREE.ShaderLib.basic.uniforms,{orthoViewProjMatrix:{value:this.orthoViewProjMatrix},innerClipping:{value:this.innerClipping}}]),this.vertexShader=this._getVertexShader(THREE.ShaderLib.basic.vertexShader),this.fragmentShader=this._getFragmentShader(THREE.ShaderLib.basic.fragmentShader)}copy(e){return THREE.MeshBasicMaterial.prototype.copy.call(this,e),this.orthoViewProjMatrix.copy(e.orthoViewProjMatrix),this.innerClipping=e.innerClipping,this}refreshUniforms(){this.uniforms.orthoViewProjMatrix.value.copy(this.orthoViewProjMatrix),this.uniforms.innerClipping.value=this.innerClipping}_getVertexShader(e){var t=e.replace("#include <clipping_planes_pars_vertex>","\n                    #include <clipping_planes_pars_vertex>\n                    varying vec4 wPositionForInnerClipping;\n                ");return t=t.replace("#include <clipping_planes_vertex>","\n                    #include <clipping_planes_vertex>\n                    wPositionForInnerClipping = modelMatrix * vec4(transformed, 1.0);\n                ")}_getFragmentShader(e){var t=e.replace("#include <clipping_planes_pars_fragment>","\n                    #include <clipping_planes_pars_fragment>\n                    uniform mat4 orthoViewProjMatrix;\n                    uniform int innerClipping;\n                    varying vec4 wPositionForInnerClipping;\n                ");return t=t.replace("#include <clipping_planes_fragment>","\n                    if (innerClipping > 0) \n                    {\n                        vec4 clipPosition = orthoViewProjMatrix * wPositionForInnerClipping;\n                        clipPosition.xyz /= clipPosition.w;\n                        if (clipPosition.x >= -1.0 && clipPosition.x <= 1.0 &&\n                            clipPosition.y >= -1.0 && clipPosition.y <= 1.0 && clipPosition.z >= -1.0) \n                        {\n                            discard;\n                        }\n                    }\n                    else\n                    {\n                        #include <clipping_planes_fragment>\n                    }\n                ")}}r.MeshBasicClipMaterial=e}(),(()=>{class e extends THREE.Material{constructor(e){super(),this.isPointsMaterial=!0,this.type="CLOUDPointsMaterial",this.color=new THREE.Color(16777215),this.map=null,this.alphaMap=null,this.size=1,this.scale=1,this.morphTargets=!1,this.defines={},this.sizeAttenuation=r.Utils.defaultValue(e.sizeAttenuation,!1),this.sizeAttenuation?this.defines.USE_SIZEATTENUATION="":delete this.defines.USE_SIZEATTENUATION,this.positionOffset=r.Utils.defaultValue(e.positionOffset,!1),this.positionOffset?this.defines.USE_POSITION_OFFSET="":delete this.defines.USE_POSITION_OFFSET,this.sizeAttribute=r.Utils.defaultValue(e.sizeAttribute,!1),this.sizeAttribute?this.defines.USE_ATTRIBUTE_SIZE="":delete this.defines.USE_ATTRIBUTE_SIZE,this.setValues(e),this.vertexShader=THREE.ShaderChunk.points_vertex,this.fragmentShader=THREE.ShaderChunk.points_fragment,this.uniforms=THREE.UniformsUtils.merge([THREE.ShaderLib.basic.uniforms,{size:{value:this.size},scale:{value:this.scale}}])}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.alphaMap=e.alphaMap,this.size=e.size,this.sizeAttenuation=e.sizeAttenuation,this.positionOffset=e.positionOffset,this.sizeAttribute=e.sizeAttribute,this.morphTargets=e.morphTargets,this}refreshUniforms(){this.uniforms.positionOffset.value=this.positionOffset,this.uniforms.sizeAttribute.value=this.sizeAttribute}}r.PointsMaterial=e})(),function(){class e extends THREE.MeshNormalMaterial{constructor(e){super(e),this.type="InstancedNormalMaterial",this.uniforms=THREE.ShaderLib.normal.uniforms,this.vertexShader="#define NORMAL\n                #if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP )\n                    varying vec3 vViewPosition;\n                #endif\n                #ifndef FLAT_SHADED\n                    varying vec3 vNormal;\n                #endif\n                #include <uv_pars_vertex>\n                #include <displacementmap_pars_vertex>\n                #include <morphtarget_pars_vertex>\n                #include <skinning_pars_vertex>\n                #include <logdepthbuf_pars_vertex>\n                #include <clipping_planes_pars_vertex>\n                attribute float vState;\n                attribute vec4 aColor;\n                attribute vec3 mcol0;\n                attribute vec3 mcol1;\n                attribute vec3 mcol2;\n                attribute vec3 mcol3;\n                #if defined(USE_MAP)\n                    attribute vec2 muvCol0;\n                    attribute vec2 muvCol1;\n                    attribute vec2 muvCol2;\n                #endif\n                varying float vfState;\n                vec3 getInstancePosition(vec3 position) {\n                    return vec3(mat4(vec4(mcol0, 0.0),\n                                     vec4(mcol1, 0.0),\n                                     vec4(mcol2, 0.0),\n                                     vec4(mcol3, 1.0)) * vec4(position, 1.0));\n                }\n                mat3 transpose_mat3( const in mat3 v ) {\n                    mat3 tmp;\n                    tmp[0] = vec3(v[0].x, v[1].x, v[2].x);\n                    tmp[1] = vec3(v[0].y, v[1].y, v[2].y);\n                    tmp[2] = vec3(v[0].z, v[1].z, v[2].z);\n                    return tmp;\n                }\n                mat3 inverse_mat3(in mat3 m)\n                {\n                   float determinant =\n                    m[0][0] * (m[1][1] * m[2][2] - m[2][1] * m[1][2])\n                    - m[1][0] * (m[0][1] * m[2][2] - m[2][1] * m[0][2])\n                    + m[2][0] * (m[0][1] * m[1][2] - m[1][1] * m[0][2]);\n                    mat3 inverse;\n                    inverse[0][0] = + (m[1][1] * m[2][2] - m[2][1] * m[1][2]);\n                    inverse[1][0] = - (m[1][0] * m[2][2] - m[2][0] * m[1][2]);\n                    inverse[2][0] = + (m[1][0] * m[2][1] - m[2][0] * m[1][1]);\n                    inverse[0][1] = - (m[0][1] * m[2][2] - m[2][1] * m[0][2]);\n                    inverse[1][1] = + (m[0][0] * m[2][2] - m[2][0] * m[0][2]);\n                    inverse[2][1] = - (m[0][0] * m[2][1] - m[2][0] * m[0][1]);\n                    inverse[0][2] = + (m[0][1] * m[1][2] - m[1][1] * m[0][2]);\n                    inverse[1][2] = - (m[0][0] * m[1][2] - m[1][0] * m[0][2]);\n                    inverse[2][2] = + (m[0][0] * m[1][1] - m[1][0] * m[0][1]);\n                    inverse /= determinant;\n                    return inverse;\n                }\n                bool isPerspectiveMatrix(mat4 m) {\n                    return m[2][3] == -1.0;\n                }\n                void main() {\n                    vfState = vState;\n                    #include <uv_vertex>\n                    #include <beginnormal_vertex>\n                    #include <morphnormal_vertex>\n                    #include <skinbase_vertex>\n                    #include <skinnormal_vertex>\n                    #include <defaultnormal_vertex>\n\n                    mat3 normalMat = mat3(mcol0, mcol1, mcol2);\n                    normalMat = inverse_mat3(normalMat);\n                    normalMat = transpose_mat3(normalMat);\n                    transformedNormal = normalMat * objectNormal;\n                    transformedNormal = normalMatrix * transformedNormal;\n                    #ifdef FLIP_SIDED\n                       transformedNormal = - transformedNormal;\n                    #endif\n                    transformedNormal = normalize( transformedNormal );\n\n                #ifndef FLAT_SHADED\n                    vNormal = normalize( transformedNormal );\n                #endif\n                    #include <begin_vertex>\n                    #include <displacementmap_vertex>\n                    #include <morphtarget_vertex>\n                    #include <skinning_vertex>\n                    vec4 mvPosition = modelViewMatrix * vec4(getInstancePosition(transformed), 1.0);\n                    gl_Position = projectionMatrix * mvPosition;\n                    #include <clipping_planes_vertex>\n                    #include <logdepthbuf_vertex>\n                #if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP )\n                    vViewPosition = - mvPosition.xyz;\n                #endif\n                }\n                ",this.fragmentShader=THREE.ShaderLib.normal.fragmentShader.replace("void main() {","\n            varying float vfState;\n            void main() {\n                if (vfState <= -0.99 && vfState >= -1.01) discard;\n        ")}}r.InstancedNormalMaterial=e}(),function(){class e extends THREE.MeshPhongMaterial{constructor(e){super(e),this.defines={},this.type="MapTileMaterial",this.samplerExcavation=null,this.cullOrthoMatrix=new THREE.Matrix4,this.brightness=1,this.contrast=1,this.saturation=1,this.hue=0,this.gamma=1,this.customColor=new THREE.Vector4(1,1,1,1),this.useCustomColor=0,this._imageByteSize=0,this.useCSM=r.GlobalData.EnableCSM,this.uniforms=THREE.UniformsUtils.merge([THREE.ShaderLib.phong.uniforms,{u_SamplerExcavation:{value:null},u_CullOrthoMatrix:{value:new THREE.Matrix4}},{brightness:{value:this.brightness},contrast:{value:this.contrast},saturation:{value:this.saturation},hue:{value:this.hue},gamma:{value:this.gamma},customColor:{value:this.customColor},useCustomColor:{value:this.useCustomColor}},{csmCascades:{value:null}}]),this.vertexShader=THREE.ShaderChunk.map_tile_vertex,this.fragmentShader=THREE.ShaderChunk.map_tile_fragment,this.useCSM?this.defines.USE_CSM="":delete this.defines.USE_CSM}copy(e){return THREE.MeshBasicMaterial.prototype.copy.call(this,e),this.u_SamplerExcavation.value=e.samplerExcavation,this.u_CullOrthoMatrix.value=e.cullOrthoMatrix,this.brightness=e.brightness,this.contrast=e.contrast,this.saturation=e.saturation,this.hue=e.hue,this.gamma=e.gamma,this.customColor=e.customColor,this.useCustomColor=e.useCustomColor,this.useCSM=e.useCSM,this}refreshUniforms(){this.uniforms.u_SamplerExcavation.value=this.samplerExcavation,this.uniforms.u_CullOrthoMatrix.value=this.cullOrthoMatrix,this.uniforms.brightness.value=this.brightness,this.uniforms.contrast.value=this.contrast,this.uniforms.saturation.value=this.saturation,this.uniforms.hue.value=this.hue,this.uniforms.gamma.value=this.gamma,this.uniforms.customColor.value.copy(this.customColor),this.uniforms.useCustomColor.value=this.useCustomColor,this.useCSM?this.defines.USE_CSM="":delete this.defines.USE_CSM}updateStyle(e){this.brightness=r.Utils.isDefined(e.brightness)?e.brightness:1,this.contrast=r.Utils.isDefined(e.contrast)?e.contrast:1,this.saturation=r.Utils.isDefined(e.saturation)?e.saturation:1,this.hue=r.Utils.isDefined(e.hue)?e.hue:0,this.gamma=r.Utils.isDefined(e.gamma)?e.gamma:1,this.customColor=r.Utils.isDefined(e.color)?this.customColor.copy(e.color):this.customColor,this.useCustomColor=r.Utils.isDefined(e.color)?1:0,this.refreshUniforms()}updateExcavation(e){e&&e.isExcavation?(this.samplerExcavation=e.samplerExcavation,this.cullOrthoMatrix=e.cullOrthoMatrix):(this.samplerExcavation=null,this.cullOrthoMatrix.identity()),this.refreshUniforms()}updateSide(e){(e||{}).isExcavation||r.GlobalData.EnableSkylinePass?this.side=THREE.DoubleSide:this.side=THREE.FrontSide}}r.MapTileMaterial=e}(),function(){class e extends THREE.MeshPhongMaterial{constructor(e){super(e),this.defines={},this.type="ObliquePhotographyMaterial",this._referenceCount=1,this._imageByteSize=0,this.samplerExcavation=null,this.cullOrthoMatrix=new THREE.Matrix4,this.useCSM=r.GlobalData.EnableCSM,this.uniforms=THREE.UniformsUtils.merge([THREE.ShaderLib.phong.uniforms,{u_SamplerExcavation:{value:null},u_CullOrthoMatrix:{value:new THREE.Matrix4}},{csmCascades:{value:null}}]),this.vertexShader=THREE.ShaderChunk.oblique_photography_vertex,this.fragmentShader=THREE.ShaderChunk.oblique_photography_fragment,this.useCSM?this.defines.USE_CSM="":delete this.defines.USE_CSM}copy(e){return THREE.MeshPhongMaterial.prototype.copy.call(this,e),this.u_SamplerExcavation=e.samplerExcavation,this.u_CullOrthoMatrix=e.cullOrthoMatrix,this.useCSM=e.useCSM,this.refreshUniforms(),this}refreshUniforms(){this.uniforms.u_SamplerExcavation.value=this.samplerExcavation,this.uniforms.u_CullOrthoMatrix.value=this.cullOrthoMatrix,this.useCSM?this.defines.USE_CSM="":delete this.defines.USE_CSM}updateExcavation(e){e&&e.isExcavation?(this.defines.EXCAVATION_MODE="",this.samplerExcavation=e.samplerExcavation,this.cullOrthoMatrix=e.cullOrthoMatrix):(delete this.defines.EXCAVATION_MODE,this.samplerExcavation=null,this.cullOrthoMatrix.identity()),this.refreshUniforms()}updateSide(e){(e||{}).isExcavation||r.GlobalData.EnableSkylinePass?this.side=THREE.DoubleSide:this.side=THREE.FrontSide}}r.ObliquePhotographyMaterial=e}(),function(){class e extends THREE.MeshNormalMaterial{constructor(e){super(e),this.type="NormalMaterial",this.uniforms=THREE.ShaderLib.normal.uniforms,this.vertexShader="\n                #define NORMAL\n                #if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP )\n                    varying vec3 vViewPosition;\n                #endif\n                #ifndef FLAT_SHADED\n                    varying vec3 vNormal;\n                #endif\n                #include <uv_pars_vertex>\n                #include <displacementmap_pars_vertex>\n                #include <morphtarget_pars_vertex>\n                #include <skinning_pars_vertex>\n                #include <logdepthbuf_pars_vertex>\n                bool isPerspectiveMatrix(mat4 m) {\n                    return m[2][3] == -1.0;\n                }\n                #include <clipping_planes_pars_vertex>\n                void main() {\n                    #include <uv_vertex>\n                    #include <beginnormal_vertex>\n                    #include <morphnormal_vertex>\n                    #include <skinbase_vertex>\n                    #include <skinnormal_vertex>\n                    #include <defaultnormal_vertex>\n                #ifndef FLAT_SHADED\n                    vNormal = normalize( transformedNormal );\n                #endif\n                    #include <begin_vertex>\n                    #include <displacementmap_vertex>\n                    #include <morphtarget_vertex>\n                    #include <skinning_vertex>\n                    #include <project_vertex>\n                    #include <logdepthbuf_vertex>\n                #if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP )\n                    vViewPosition = - mvPosition.xyz;\n                #endif\n                #include <clipping_planes_vertex>\n                }\n                ",this.fragmentShader=THREE.ShaderLib.normal.fragmentShader}}r.NormalMaterial=e}(),function(){class e extends THREE.MeshBasicMaterial{constructor(e){super(e),this.type="WallMaterial",this.uniforms=THREE.UniformsUtils.merge([THREE.ShaderLib.basic.uniforms,r.WallShader.uniforms]),this.vertexShader=r.WallShader.vertexShader,this.fragmentShader=r.WallShader.fragmentShader}}r.WallMaterial=e}(),function(){class e extends THREE.MeshBasicMaterial{constructor(e){super(e),this.type="PlaneScanMaterial",this.uniforms=THREE.UniformsUtils.merge([THREE.ShaderLib.basic.uniforms,r.PlaneScanShader.uniforms]),this.vertexShader=r.PlaneScanShader.vertexShader,this.fragmentShader=r.PlaneScanShader.fragmentShader}}r.PlaneScanMaterial=e}(),function(){class e extends THREE.MeshBasicMaterial{constructor(e){super(e),this.type="RingScanMaterial",this.uniforms=THREE.UniformsUtils.merge([THREE.ShaderLib.basic.uniforms,r.RingScanShader.uniforms]),this.vertexShader=r.RingScanShader.vertexShader,this.fragmentShader=r.RingScanShader.fragmentShader}}r.RingScanMaterial=e}(),function(){class e extends THREE.MeshBasicMaterial{constructor(e){super(e),this.type="FanScanMaterial",this.uniforms=THREE.UniformsUtils.merge([THREE.ShaderLib.basic.uniforms,r.FanScanShader.uniforms]),this.vertexShader=r.FanScanShader.vertexShader,this.fragmentShader=r.FanScanShader.fragmentShader}}r.FanScanMaterial=e}(),function(){class e extends THREE.ShaderMaterial{constructor(e){super(e);var t=this;t.type="WaterMaterial",t.uniforms=THREE.UniformsUtils.merge([{fogDensity:{value:25e-5},fogNear:{value:1},fogFar:{value:2e3},fogColor:{value:new THREE.Color(16777215)},postProcessMap:{value:null},postProcessAdditiveMap:{value:null},postProcessMixRate:{value:0},postProcessAdditiveRate:{value:0},viewportWidth:{value:0},viewportHeight:{value:0}},r.WaterShader.uniforms]),t.vertexShader=r.WaterShader.vertexShader,t.fragmentShader=r.WaterShader.fragmentShader,t.textureMatrix=new THREE.Matrix4,t.transparent=!1,t.clipping=!0,t.side=THREE.DoubleSide,t.isUndersea=!0,t.fog=!0}initUniforms(e){var t=this;void 0!==e.flowMap?(t.defines.USE_FLOWMAP="",t.uniforms.tFlowMap={type:"t",value:e.flowMap}):t.uniforms.flowDirection={type:"v2",value:e.flowDirection},t.uniforms.tNormalMap0.value=e.normalMap0,t.uniforms.tNormalMap1.value=e.normalMap1,t.uniforms.waterColor.value=new THREE.Vector4(e.color.r,e.color.g,e.color.b,e.alpha),1==e.alpha&&(t.side=THREE.FrontSide,t.isUndersea=!1),t.uniforms.reflectivity.value=e.reflectivity,t.uniforms.config.value.x=0,t.uniforms.config.value.y=e.halfCycle,t.uniforms.config.value.z=e.halfCycle,t.uniforms.config.value.w=e.wavesScale,e.viewer.gisMode&&(t.defines.USE_GLOBE=""),e.shadow&&(t.defines.USE_SHADOW=""),t.uniforms.sunDirection.value=e.scene.sunDirection,t.uniforms.textureMatrix.value=t.textureMatrix}}r.WaterMaterial=e}(),function(){class e extends THREE.MeshBasicMaterial{constructor(e){super(e);var t=this;t.type="MeshBasicMaterial",t.depthTest=!1,t.depthWrite=!1,t.wireframe=!0,t.clipping=!0,t.side=THREE.DoubleSide,t.fog=!0,t.transparent=!0}}r.CutFillMaterial=e}(),(()=>{class e extends THREE.MeshBasicMaterial{constructor(e){super(e),this.type="CLOUDMeshBasicMaterial",this.vertexShader=THREE.ShaderChunk.meshbasic_vert,this.fragmentShader=THREE.ShaderChunk.cloud_mesh_basic_frag,this.uniforms=THREE.ShaderLib.basic.uniforms}}r.MeshBasicMaterial=e})(),(()=>{class e extends THREE.MeshStandardMaterial{constructor(e){super(e),this.type="CLOUDMeshStandardMaterial",this.vertexShader=THREE.ShaderChunk.meshphysical_vert,this.fragmentShader=THREE.ShaderChunk.cloud_mesh_physical_frag,this.uniforms=THREE.ShaderLib.physical.uniforms,this.metalness=.5,this.roughness=.5}}r.MeshStandardMaterial=e})(),function(){class e extends THREE.LineBasicMaterial{constructor(e){super(e),this.type="CloudLineBasicMaterial",this.vertexShader=THREE.ShaderLib.basic.vertexShader,this.fragmentShader=THREE.ShaderChunk.cloud_line_basic_frag,this.uniforms=THREE.ShaderLib.basic.uniforms}}r.LineBasicMaterial=e}(),function(){let e="\n      void main() {\n          gl_Position = vec4(position, 1.0);\n      }\n    ";function t(e){e.fragmentShader=e.fragmentShader.replace(/void\s+main\s*\(\s*(?:void)?\s*\)/g,"void testMain()"),e.fragmentShader+="\n      void main(){\n\n        testMain();\n\n        vec3 Ci = gl_FragColor.rgb * gl_FragColor.a;\n        float ai = gl_FragColor.a;\n        float zi = gl_FragCoord.z;\n        float wzi = oit_weight(zi, ai);\n        gl_FragColor = vec4(Ci, ai) * wzi;\n      }\n      ",a(e)}function i(e){e.fragmentShader=e.fragmentShader.replace(/void\s+main\s*\(\s*(?:void)?\s*\)/g,"void testMain()"),e.fragmentShader+="\n      void main(){\n\n        testMain();\n\n        float ai = gl_FragColor.a;\n        // gl_FragColor = vec4(ai);\n        gl_FragColor.r = ai;\n      }\n      ",a(e)}function a(e){e.fragmentShader=e.fragmentShader.replace("#include <packing>",""),e.fragmentShader=`\n        #include <packing>\n\n        float oit_weight(float z, float a){\n            return clamp(pow(min(1.0, a * 10.0) + 0.01, 3.0) * 1e8 * pow(1.0 - z * 0.9, 3.0), 1e-2, 3e3);\n        }\n\n        ${e.fragmentShader}\n    `}function n(e){e.fragmentShader=e.fragmentShader.replace(/void\s+main\s*\(\s*(?:void)?\s*\)/g,"void testMain()"),e.fragmentShader=e.fragmentShader.replace(/gl_FragColor/g,"alias_gl_FragColor"),e.fragmentShader+="\n      void main(){\n\n        testMain();\n\n        if(alias_gl_FragColor.a < 1.0){\n          discard;\n        }\n\n        gl_FragColor = alias_gl_FragColor;\n      }\n      ",e.fragmentShader=e.fragmentShader.replace("#include <packing>",""),e.fragmentShader=`\n        #include <packing>\n        vec4 alias_gl_FragColor;\n\n        ${e.fragmentShader}\n    `}r.OIT=class{constructor(t){this._renderer=t.renderer,this._fullScreenQuad=void 0,this._fullScreenQuadForCustomizedAlpha=void 0,this._fullScreenQuadForAdjustedAlpha=void 0,this._colorTarget=void 0,this._alphaTarget=void 0,this._opaqueTarget=void 0,this._fullScreenQuadMaterial=new THREE.ShaderMaterial({uniforms:{uAccumulate:{value:null},uAccumulateAlpha:{value:null}},vertexShader:e,fragmentShader:"\n      precision highp float;\n      uniform sampler2D uAccumulate;\n      uniform sampler2D uAccumulateAlpha;\n    \n      void main() {\n          ivec2 fragCoord = ivec2(gl_FragCoord.xy);\n          vec4 accum = texelFetch(uAccumulate, fragCoord, 0);\n          float revealage = texelFetch(uAccumulateAlpha, fragCoord, 0).r;          \n          gl_FragColor = vec4(accum.rgb / clamp(accum.a, 0.0001, 50000.0), 1.0 - revealage);\n      }\n    ",blending:THREE.CustomBlending,blendSrc:THREE.SrcAlphaFactor,blendDst:THREE.OneMinusSrcAlphaFactor,depthTest:!1,depthWrite:!1,transparent:!0}),this._fullScreenQuadMaterialForCustomizedAlpha=new THREE.ShaderMaterial({uniforms:{uOpaqueDepth:{value:null},uAccumulateAlpha:{value:null},uAdjustedAlpha:{value:1}},vertexShader:e,fragmentShader:"\n      precision highp float;\n      uniform float uAdjustedAlpha;\n      uniform sampler2D uOpaqueDepth;\n      uniform sampler2D uAccumulateAlpha;\n\n      void main() {\n          ivec2 fragCoord = ivec2(gl_FragCoord.xy);\n          float revealage = texelFetch(uAccumulateAlpha, fragCoord, 0).r;\n          float depth = texelFetch(uOpaqueDepth, fragCoord, 0).r;\n\n          if(revealage == 1.0 && depth == 1.0){\n            discard;\n          }\n       \n          gl_FragColor = vec4(0.0, 0.0, 0.0, uAdjustedAlpha);\n      }\n    ",blending:THREE.CustomBlending,blendSrc:THREE.ZeroFactor,blendDst:THREE.OneFactor,blendSrcAlpha:THREE.OneFactor,blendDstAlpha:THREE.ZeroFactor,depthTest:!1,depthWrite:!1,transparent:!0}),this._fullScreenQuadMaterialForAdjustedAlpha=new THREE.ShaderMaterial({uniforms:{uOpaqueDepth:{value:null}},vertexShader:e,fragmentShader:"\n      precision highp float;\n      uniform sampler2D uOpaqueDepth;\n\n      void main() {\n          ivec2 fragCoord = ivec2(gl_FragCoord.xy); \n          float depth = texelFetch(uOpaqueDepth, fragCoord, 0).r;\n\n          if(depth < 1.0){\n            gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);\n          } else {\n            discard;\n          }\n      }\n    ",blending:THREE.CustomBlending,blendSrc:THREE.ZeroFactor,blendDst:THREE.OneFactor,blendSrcAlpha:THREE.OneFactor,blendDstAlpha:THREE.OneFactor,depthTest:!1,depthWrite:!1}),this._oldRenderState={clearColor:new THREE.Color,clearAlpha:1,autoClear:!0,autoClearColor:!0,autoClearDepth:!0,autoClearStencil:!0},this._initialized=!1,this._customizedAlpha=1,this._customizedAlphaEanbled=!1,this._transparentAlphaMaskEnabled=!0,this._composeCamera=new THREE.OrthographicCamera(-1,1,1,-1,0,1)}destroy(){this._oldRenderState=void 0,this._renderer=void 0,this._fullScreenQuadMaterial.dispose(),this._fullScreenQuadMaterial=void 0,this._fullScreenQuad&&(this._fullScreenQuad.geometry.dispose(),this._fullScreenQuad.geometry=void 0,this._fullScreenQuad.material=void 0,this._fullScreenQuad=void 0),this._fullScreenQuadMaterialForCustomizedAlpha.dispose(),this._fullScreenQuadMaterialForCustomizedAlpha=void 0,this._fullScreenQuadForCustomizedAlpha&&(this._fullScreenQuadForCustomizedAlpha.geometry.dispose(),this._fullScreenQuadForCustomizedAlpha.geometry=void 0,this._fullScreenQuadForCustomizedAlpha.material=void 0,this._fullScreenQuadForCustomizedAlpha=void 0),this._fullScreenQuadMaterialForAdjustedAlpha.dispose(),this._fullScreenQuadMaterialForAdjustedAlpha=void 0,this._fullScreenQuadForAdjustedAlpha&&(this._fullScreenQuadForAdjustedAlpha.geometry.dispose(),this._fullScreenQuadForAdjustedAlpha.geometry=void 0,this._fullScreenQuadForAdjustedAlpha.material=void 0,this._fullScreenQuadForAdjustedAlpha=void 0),this._colorTarget&&(this._colorTarget.dispose(),this._colorTarget=void 0),this._alphaTarget&&(this._alphaTarget.dispose(),this._alphaTarget=void 0),this._opaqueTarget&&(this._opaqueTarget.dispose(),this._opaqueTarget=void 0),this._composeCamera=void 0}setSize(e,t){if(!this._colorTarget)return;let i=this._renderer.getPixelRatio(),r=e*i,a=t*i;this._colorTarget.setSize(r,a),this._alphaTarget.setSize(r,a),this._opaqueTarget.setSize(r,a)}render(e,t,i){this._isInitialized()||this._init(),this._holdRenderState(),e.renderObjectsHolded=!0,this._hideWireframe(i),this._holdBackground(e),this._renderForProjectObjectsOnly(e,t),this._updateBackgroud(e),this._renderOpaqueObjectsDepthOffScreen(e,t),this._renderTransparentObjectsDepthOffScreen(e,t),this._renderTransparentObjectsOffScreen(e,t),this._resetRenderState();this._renderer.setRenderTarget(null),this._renderOpaqueObjects(e,t),this._renderTransparentObjectsDepthOnly(e,t),this._renderTransparentObjects(),this._showWireframe(i),this._renderWireframe(e,t,i),this._resetRenderState(),this._resetBackground(e),this._clearSceneRenderCache(e)}enableTransparentAlphaMask(e){this._transparentAlphaMaskEnabled=e}setCustomizedAlpha(e){this._customizedAlpha=r.Math.clamp(e,0,1)}_getCustomizedAlpha(){return this._customizedAlpha}enableCustomizedAlpha(e){this._customizedAlphaEanbled=e}_isCustomizedAlphaEnabled(){return this._customizedAlphaEanbled}_isInitialized(){return this._initialized}_init(){this._createFullScreenQuad(),this._createRenderTarget(),this._initialized=!0}_createFullScreenQuad(){const e=new THREE.BufferGeometry;e.setAttribute("position",new THREE.Float32BufferAttribute([-1,-1,0,-1,1,0,1,-1,0,1,1,0],3)),e.setAttribute("uv",new THREE.Float32BufferAttribute([0,0,0,1,1,0,1,1],2)),e.setIndex([0,2,1,2,3,1]),this._fullScreenQuad=new THREE.Mesh(e,this._fullScreenQuadMaterial),this._fullScreenQuadForCustomizedAlpha=new THREE.Mesh(e,this._fullScreenQuadMaterialForCustomizedAlpha),this._fullScreenQuadForAdjustedAlpha=new THREE.Mesh(e,this._fullScreenQuadMaterialForAdjustedAlpha)}_createRenderTarget(){const e=this._renderer,t=new THREE.Vector2;e.getSize(t);const i=t.x,r=t.y,a=e.getPixelRatio(),n=i*a,s=r*a,o=null===e.extensions.get("OES_texture_float_linear")?THREE.HalfFloatType:THREE.FloatType,l=new THREE.DepthTexture;l.type=o;const d=THREE.WebGLRenderTarget;this._opaqueTarget=new d(n,s,{minFilter:THREE.NearestFilter,magFilter:THREE.NearestFilter,wrapS:THREE.ClampToEdgeWrapping,wrapT:THREE.ClampToEdgeWrapping,format:THREE.RGBAFormat,type:o});const h=this._opaqueTarget;h.stencilBuffer=!1,h.depthBuffer=!0,h.depthTexture=l,this._colorTarget=new d(n,s,{minFilter:THREE.NearestFilter,magFilter:THREE.NearestFilter,wrapS:THREE.ClampToEdgeWrapping,wrapT:THREE.ClampToEdgeWrapping,format:THREE.RGBAFormat,type:o});const c=this._colorTarget;c.stencilBuffer=!1,c.depthBuffer=!0,c.depthTexture=l,this._alphaTarget=new d(n,s,{minFilter:THREE.NearestFilter,magFilter:THREE.NearestFilter,wrapS:THREE.ClampToEdgeWrapping,wrapT:THREE.ClampToEdgeWrapping,format:THREE.RedFormat,type:o});const u=this._alphaTarget;u.stencilBuffer=!1,u.depthBuffer=!0,u.depthTexture=l}_holdMaterialStateForTransparentObjects(e){e.forEach((e=>{const t=e.material;t._holdedProperties={blending:t.blending,blendSrc:t.blendSrc,blendDst:t.blendDst,blendSrcAlpha:t.blendSrcAlpha,blendDstAlpha:t.blendDstAlpha,depthWrite:t.depthWrite,depthTest:t.depthTest,onBeforeCompile:t.onBeforeCompile}}))}_updateMaterialStateForTransparentObjects(e,r){let a=r?i:t;e.forEach((e=>{const t=e.material;t.blending=THREE.CustomBlending,r?(t.blendSrc=THREE.ZeroFactor,t.blendDst=THREE.OneMinusSrcAlphaFactor,t.blendSrcAlpha=THREE.ZeroFactor,t.blendDstAlpha=THREE.OneMinusSrcAlphaFactor):(t.blendSrc=THREE.OneFactor,t.blendDst=THREE.OneFactor,t.blendSrcAlpha=THREE.OneFactor,t.blendDstAlpha=THREE.OneFactor),t.depthWrite=!1,t.depthTest=!0,t.onBeforeCompile=a,t.needsUpdate=!0}))}_resetMaterialStateForTransparentObjects(e){e.forEach((e=>{const t=e.material,i=t._holdedProperties;t.blending=i.blending,t.blendSrc=i.blendSrc,t.blendDst=i.blendDst,t.blendSrcAlpha=i.blendSrcAlpha,t.blendDstAlpha=i.blendDstAlpha,t.depthWrite=i.depthWrite,t.depthTest=i.depthTest,t.onBeforeCompile=i.onBeforeCompile,t.needsUpdate=!0}))}_holdMaterialStateToAlphaCulling(e){e.forEach((e=>{const t=e.material;t._holdedProperties={blending:t.blending,depthWrite:t.depthWrite,depthTest:t.depthTest,onBeforeCompile:t.onBeforeCompile}}))}_updateMaterialStateToAlphaCulling(e){e.forEach((e=>{const t=e.material;t.blending=THREE.NoBlending,t.depthWrite=!0,t.depthTest=!0,t.onBeforeCompile=n,t.needsUpdate=!0}))}_resetMaterialStateToAlphaCulling(e){e.forEach((e=>{const t=e.material,i=t._holdedProperties;t.blending=i.blending,t.depthTest=i.depthTest,t.depthWrite=i.depthWrite,t.onBeforeCompile=i.onBeforeCompile,t.needsUpdate=!0}))}_holdMaterialStateForObjects(e){e.forEach((e=>{e.material._colorWrite=e.material.colorWrite}))}_updateMaterialStateForObjects(e){e.forEach((e=>{e.material.colorWrite=!1}))}_resetMaterialStateForObjects(e){e.forEach((e=>{e.material.colorWrite=e.material._colorWrite}))}_setRenderStateFlagForScene(e,t,i,r){e.renderStateInitSkipped=t,e.renderOpaqueObjectsSkipped=i,e.renderTransparentObjectsSkipped=r}_clearRenderStateFlagForScene(e){e.renderStateInitSkipped=void 0,e.renderOpaqueObjectsSkipped=void 0,e.renderTransparentObjectsSkipped=void 0}_clearSceneRenderCache(e){e.renderObjectsHolded=void 0,e.opaqueObjects=void 0,e.transparentObjects=void 0}_renderForProjectObjectsOnly(e,t){this._setRenderStateFlagForScene(e,!1,!0,!0);const i=this._renderer;i.autoClear=!0,i.autoClearColor=!0,i.autoClearDepth=!0,i.autoClearStencil=!0,i.setRenderTarget(null),i.render(e,t)}_renderOpaqueObjectsDepthOffScreen(e,t){this._setRenderStateFlagForScene(e,!0,!1,!0);const i=e.opaqueObjects;this._holdMaterialStateForObjects(i),this._updateMaterialStateForObjects(i);const r=this._renderer;r.setClearColor(0,1),r.autoClear=!0,r.autoClearColor=!0,r.autoClearDepth=!0,r.autoClearStencil=!0,r.setRenderTarget(this._opaqueTarget),r.render(e,t),this._resetMaterialStateForObjects(i),this._clearRenderStateFlagForScene(e)}_renderTransparentObjectsDepthOffScreen(e,t){if(!this._transparentAlphaMaskEnabled)return;this._setRenderStateFlagForScene(e,!0,!0,!1);const i=e.transparentObjects;this._holdMaterialStateToAlphaCulling(i),this._updateMaterialStateToAlphaCulling(i);const r=this._renderer;r.setClearColor(0,1),r.autoClear=!1,r.setRenderTarget(this._opaqueTarget),r.render(e,t),this._resetMaterialStateToAlphaCulling(i),this._clearRenderStateFlagForScene(e)}_renderTransparentObjectsOffScreen(e,t){this._setRenderStateFlagForScene(e,!0,!0,!1);const i=e.transparentObjects;this._holdMaterialStateForTransparentObjects(i),this._updateMaterialStateForTransparentObjects(i);const r=this._renderer;r.setClearColor(0,0),r.autoClear=!0,r.autoClearColor=!0,r.autoClearDepth=!1,r.autoClearStencil=!0,r.setRenderTarget(this._colorTarget),r.render(e,t),this._updateMaterialStateForTransparentObjects(i,!0),r.setClearColor(16777215,1),r.setRenderTarget(this._alphaTarget),r.render(e,t),this._resetMaterialStateForTransparentObjects(i),this._clearRenderStateFlagForScene(e)}_renderOpaqueObjects(e,t){this._setRenderStateFlagForScene(e,!0,!1,!0);const i=this._renderer;i.autoClear=!0,i.autoClearColor=!0,i.autoClearDepth=!0,i.autoClearStencil=!0,i.render(e,t),this._clearRenderStateFlagForScene(e)}_renderTransparentObjectsDepthOnly(e,t){this._setRenderStateFlagForScene(e,!0,!0,!1);const i=e.transparentObjects;this._holdMaterialStateForObjects(i),this._updateMaterialStateForObjects(i);const r=this._renderer;r.autoClear=!1,r.render(e,t),this._resetMaterialStateForObjects(i),this._clearRenderStateFlagForScene(e)}_renderTransparentObjects(){this._renderFullScreenQuad(),this._renderFullScreenQuadForAdjustedAlpha(),this._renderFullScreenQuadByCustomizedAlpha()}_renderFullScreenQuad(){const e=this._fullScreenQuadMaterial.uniforms;e.uAccumulate.value=this._colorTarget.texture,e.uAccumulateAlpha.value=this._alphaTarget.texture;const t=this._renderer;t.autoClear=!1,t.render(this._fullScreenQuad,this._composeCamera),e.uAccumulate.value=null,e.uAccumulateAlpha.value=null}_renderFullScreenQuadForAdjustedAlpha(){const e=this._fullScreenQuadMaterialForAdjustedAlpha.uniforms;e.uOpaqueDepth.value=this._opaqueTarget.depthTexture;const t=this._renderer;t.autoClear=!1,t.render(this._fullScreenQuadForAdjustedAlpha,this._composeCamera),e.uOpaqueDepth.value=null}_renderFullScreenQuadByCustomizedAlpha(){if(!this._isCustomizedAlphaEnabled())return;const e=this._fullScreenQuadMaterialForCustomizedAlpha.uniforms;e.uOpaqueDepth.value=this._opaqueTarget.depthTexture,e.uAccumulateAlpha.value=this._alphaTarget.texture,e.uAdjustedAlpha.value=this._getCustomizedAlpha();const t=this._renderer;t.autoClear=!1,t.render(this._fullScreenQuadForCustomizedAlpha,this._composeCamera),e.uOpaqueDepth.value=null,e.uAccumulateAlpha.value=null,e.uAdjustedAlpha.value=null}_renderWireframe(e,t,i){i.hideAllExcludeWireframes(),this._renderWireframeOnly(e,t),i.showAllExcludeWireframes(),i.resetAllNodeGroupVisibility()}_renderWireframeOnly(e,t){this._setRenderStateFlagForScene(e,!1,!1,!1);const i=this._renderer;i.autoClear=!1,i.render(e,t),this._clearRenderStateFlagForScene(e)}_holdRenderState(){const e=this._renderer,t=this._oldRenderState;e.getClearColor(t.clearColor),t.clearAlpha=e.getClearAlpha(),t.autoClear=e.autoClear,t.autoClearColor=e.autoClearColor,t.autoClearDepth=e.autoClearDepth,t.autoClearStencil=e.autoClearStencil}_resetRenderState(){const e=this._renderer,t=this._oldRenderState;e.setClearColor(t.clearColor,t.clearAlpha),e.autoClear=t.autoClear,e.autoClearColor=t.autoClearColor,e.autoClearDepth=t.autoClearDepth,e.autoClearStencil=t.autoClearStencil}_holdBackground(e){e.background&&(e._background={},e._background.isTexture=e.background.isTexture,e._background.isColor=e.background.isColor,e._background.isCubeTexture=e.background.isCubeTexture,e._background.mapping=e.background.mapping)}_updateBackgroud(e){e.background&&(e.background.isTexture=!1,e.background.isColor=!1,e.background.isCubeTexture=!1,e.background.mapping=void 0)}_resetBackground(e){e.background&&(e.background.isTexture=e._background.isTexture,e.background.isColor=e._background.isColor,e.background.isCubeTexture=e._background.isCubeTexture,e.background.mapping=e._background.mapping,e._background=void 0)}_hideWireframe(e){e.holdAllNodeGroupVisibility(),e.hideAllWireframes()}_showWireframe(e){e.showAllWireframes()}}}(),function(){class e extends THREE.Group{constructor(e){super();var t=this;let i;t.scene=e.scene,t.CONST_G=4.9,t.disPickable=!0,t.autoAnimation=!0,t.color=new THREE.Color(1,1,1),t.originPosition=new THREE.Vector3(0,0,0),t.originIntensity=.5,t.radius=2e4,t.originYaw=0,t.originPitch=0,t.particleScale=1,t.camera=e.camera,t.loader=new THREE.TextureLoader,t.zoomGis=1,t.setOpts(e),i=window.BimfaceLoaderConfig&&window.BimfaceLoaderConfig.fullStaticHost?window.BimfaceLoaderConfig.fullStaticHost+"/images/":"../../resources/Effect/",t.particleOpt=[{baseScale:60,imageUrl:`${i}sprayWater0.png`,minimumSpeed:22,maximumSpeed:25,minimumParticleLife:3.5,maximumParticleLife:4.5,emissionRate:1,radius:1,color:[{startAge:0,endAge:.4,startColor:.1,endColor:.15},{startAge:.4,endAge:1,startColor:.15,endColor:0}],scale:[{startAge:0,endAge:.3,startScale:.3,endScale:.66},{startAge:.3,endAge:.9,startScale:.66,endScale:15},{startAge:.9,endAge:1,startScale:3,endScale:20}],applyGravity:t.CONST_G,randomXY:.09},{baseScale:50,imageUrl:`${i}sprayWater1.png`,minimumSpeed:22,maximumSpeed:25,minimumParticleLife:3.5,maximumParticleLife:4,emissionRate:15,radius:1,color:[{startAge:0,endAge:.7,startColor:1,endColor:.2},{startAge:.7,endAge:1,startColor:.2,endColor:0}],scale:[{startAge:0,endAge:.4,startScale:.1,endScale:.66},{startAge:.4,endAge:1,startScale:.66,endScale:3.5}],applyGravity:t.CONST_G,randomXY:.08},{baseScale:110,imageUrl:`${i}sprayWater2.png`,minimumSpeed:23,maximumSpeed:24,minimumParticleLife:1.2,maximumParticleLife:1.8,emissionRate:1,radius:.5,color:[{startAge:0,endAge:.8,startColor:1,endColor:.8},{startAge:.8,endAge:1,startColor:.8,endColor:0}],scale:[{startAge:0,endAge:1,startScale:.3,endScale:1}],applyGravity:t.CONST_G,randomFrameNumber:!0,repeatX:.3,randomXY:.04},{baseScale:120,imageUrl:`${i}sprayWater3.png`,minimumSpeed:23,maximumSpeed:24,minimumParticleLife:1,maximumParticleLife:1.3,emissionRate:1,radius:.5,color:[{startAge:0,endAge:1,startColor:.5,endColor:.4}],scale:[{startAge:0,endAge:1,startScale:.3,endScale:1}],randomFrameNumber:!0,applyGravity:t.CONST_G,repeatX:.8,randomXY:.04}],t.water=[];for(var a=0;a<t.particleOpt.length;a++){for(var n=[],s=0;s<t.particleOpt[a].color.length;s++)n.push({startAge:t.particleOpt[a].color[s].startAge,endAge:t.particleOpt[a].color[s].endAge,startColor:new THREE.Vector4(t.color.r,t.color.g,t.color.b,t.alpha*t.particleOpt[a].color[s].startColor),endColor:new THREE.Vector4(t.color.r,t.color.g,t.color.b,t.alpha*t.particleOpt[a].color[s].endColor)});var o=new r.ParticleSystem({emissionRate:Math.floor(t.particleOpt[a].emissionRate*(1+t.originIntensity)),emitPosition:new THREE.Vector3(0,0,0),originYaw:t.originYaw,originPitch:t.originPitch,minimumSpeed:t.particleOpt[a].minimumSpeed*t.originIntensity/t.zoomGis,maximumSpeed:t.particleOpt[a].maximumSpeed*t.originIntensity/t.zoomGis,size:t.particleScale*t.particleOpt[a].baseScale/t.zoomGis,minimumParticleLife:t.particleOpt[a].minimumParticleLife*t.originIntensity/1.1,maximumParticleLife:t.particleOpt[a].maximumParticleLife*t.originIntensity/1.1,imgTexture:t.loader.load(t.particleOpt[a].imageUrl),color:n,scale:t.particleOpt[a].scale,updateCallback:t.particleOpt[a].updateCallback,applyGravity:null!=t.particleOpt[a].applyGravity?t.particleOpt[a].applyGravity/t.zoomGis:null,randomXY:t.particleOpt[a].randomXY*t.spread,repeatX:0==t.originPitch?t.particleOpt[a].repeatX:1,repeatY:t.particleOpt[a].repeatY,radius:t.particleOpt[a].radius*t.radius/t.zoomGis,camera:t.camera,randomFrameNumber:t.particleOpt[a].randomFrameNumber});t.water.push(o),t.add(o.particleSystem)}}destroy(){for(var e=this,t=0;t<e.water.length;t++)e.water[t].destroy(),e.remove(e.water[t].particleSystem);e.loader=null}play(){for(var e=0;e<this.water.length;e++)this.water[e].play()}stop(){for(var e=0;e<this.water.length;e++)this.water[e].stop()}update(){for(var e=0;e<this.water.length;e++)this.water[e].render()}effectOpt(e){var t=this;t.setOpts(e);for(var i=0;i<t.water.length;i++){for(var r=[],a=0;a<t.particleOpt[i].color.length;a++)r.push({startAge:t.particleOpt[i].color[a].startAge,endAge:t.particleOpt[i].color[a].endAge,startColor:new THREE.Vector4(t.color.r,t.color.g,t.color.b,t.alpha*t.particleOpt[i].color[a].startColor),endColor:new THREE.Vector4(t.color.r,t.color.g,t.color.b,t.alpha*t.particleOpt[i].color[a].endColor)});t.water[i].effectOpt({size:t.particleScale*t.particleOpt[i].baseScale/t.zoomGis,repeatX:0==t.originPitch?t.particleOpt[i].repeatX:1,originPitch:t.originPitch,originYaw:t.originYaw,minimumParticleLife:t.particleOpt[i].minimumParticleLife*t.originIntensity/1.1,maximumParticleLife:t.particleOpt[i].maximumParticleLife*t.originIntensity/1.1,randomXY:t.particleOpt[i].randomXY*t.spread,minimumSpeed:t.particleOpt[i].minimumSpeed*t.originIntensity/t.zoomGis,maximumSpeed:t.particleOpt[i].maximumSpeed*t.originIntensity/t.zoomGis,color:r,radius:t.particleOpt[i].radius*t.radius/t.zoomGis,emissionRate:Math.floor(t.particleOpt[i].emissionRate*(1+t.originIntensity))})}}hide(){for(var e=0;e<this.water.length;e++)this.water[e].hide()}show(){for(var e=0;e<this.water.length;e++)this.water[e].show()}setOpts(e){var t=this;e&&(void 0!==e.color&&null!==e.color&&(t.color=e.color),void 0!==e.alpha&&null!==e.alpha&&(t.alpha=e.alpha),void 0!==e.originPitch&&null!==e.originPitch&&(t.originPitch=e.originPitch),void 0!==e.originYaw&&null!==e.originYaw&&(t.originYaw=e.originYaw),void 0!==e.scale&&null!==e.scale&&(t.particleScale=e.scale/5),void 0!==e.originPosition&&null!==e.originPosition&&(t.originPosition=e.originPosition,t.position.set(t.originPosition.x,t.originPosition.y,t.originPosition.z),t.updateMatrixWorld()),void 0!==e.spread&&null!==e.spread&&(t.spread=e.spread),void 0!==e.originRadius&&null!==e.originRadius&&(t.radius=e.originRadius),void 0!==e.originIntensity&&null!==e.originIntensity&&(t.originIntensity=e.originIntensity+.1),null!==e.isGis&&1==e.isGis&&(t.zoomGis=1e3))}}r.SprayWater=e}(),r.Particle=class{constructor(e){var t=this;t.size=e.size,t.alpha=e.alpha,t.visible=0,t.birth=e.birth,t.age=e.age,t.minimumParticleLife=e.minimumParticleLife,t.maximumParticleLife=e.maximumParticleLife,t.minimumSpeed=e.minimumSpeed,t.maximumSpeed=e.maximumSpeed,t.scaleAry=e.scaleAry,t.colorAry=e.colorAry,t.emitPosition=e.emitPosition,t.radius=e.radius,t.initSize=e.initSize,t.updateCallback=e.updateCallback,t.camera=e.camera,t.life=0,t.initVelocity=e.initVelocity,t.normalizedAge=0,t.originPitch=e.originPitch,t.birthplace={x:0,y:0,z:0},t.velocity={x:0,y:0,z:0},t.position={x:0,y:0,z:0},t.randomXY=e.randomXY,t.applyGravity=e.applyGravity,t.randomFrameNumber=e.randomFrameNumber,t.color=new THREE.Color}updateStatus(e){var t=this;if(null!=t.birth&&e!=t.birth)if(t.age=e-t.birth,t.age>t.life)t.visible=0;else{t.visible=1,t.randomFrameNumber&&(t.age=t.age+50*(2*Math.random()-1),t.age<0&&(t.age=0),t.age>t.life&&(t.age=t.life)),t.normalizedAge=t.age/t.life;for(var i=0;i<t.scaleAry.length;i++)if(t.normalizedAge<=t.scaleAry[i].endAge){t.size=t.initSize*r.Math.tweens(t.scaleAry[i].startScale,t.scaleAry[i].endScale,t.normalizedAge-t.scaleAry[i].startAge,t.scaleAry[i].endAge-t.scaleAry[i].startAge);break}for(i=0;i<t.colorAry.length;i++)if(t.normalizedAge<=t.colorAry[i].endAge){var a=t.normalizedAge-t.colorAry[i].startAge,n=t.colorAry[i].endAge-t.colorAry[i].startAge;t.color.setRGB(r.Math.tweens(t.colorAry[i].startColor.x,t.colorAry[i].endColor.x,a,n),r.Math.tweens(t.colorAry[i].startColor.y,t.colorAry[i].endColor.y,a,n),r.Math.tweens(t.colorAry[i].startColor.z,t.colorAry[i].endColor.z,a,n)),t.alpha=r.Math.tweens(t.colorAry[i].startColor.w,t.colorAry[i].endColor.w,a,n);break}t.position={x:t.birthplace.x+t.velocity.x*t.normalizedAge,y:t.birthplace.y+t.velocity.y*t.normalizedAge,z:t.birthplace.z+t.velocity.z*t.normalizedAge},null!=t.applyGravity&&(t.position.z=t.position.z-t.applyGravity*Math.pow(t.age/1e3,2)*1e3),null!=t.updateCallback&&t.updateCallback(t)}}init(e){var t=this;t.birth=e,t.age=0,t.life=1e3*t.minimumParticleLife+Math.random()*(t.maximumParticleLife-t.minimumParticleLife)*1e3;var i=t.minimumSpeed+Math.random()*(t.maximumSpeed-t.minimumSpeed);t.normalizedAge=0,t.visible=1,null!=t.scaleAry&&(t.size=t.initSize*t.scaleAry[0].startScale),null!=t.colorAry&&(t.color.setRGB(t.colorAry[0].startColor.x,t.colorAry[0].startColor.y,t.colorAry[0].startColor.z),t.alpha=t.colorAry[0].startColor.w),t.velocity={x:t.initVelocity.x*i*t.life,y:t.initVelocity.y*i*t.life,z:t.initVelocity.z*i*t.life},null!=t.randomXY&&(t.velocity.x=t.velocity.x+i*t.life*t.randomXY*(2*Math.random()-1),t.velocity.y=t.velocity.y+i*t.life*t.randomXY*(2*Math.random()-1)),t.birthplace={x:t.emitPosition.x+(2*Math.random()-1)*t.radius,y:t.emitPosition.y+(2*Math.random()-1)*t.radius,z:t.emitPosition.z},t.position={x:t.birthplace.x,y:t.birthplace.y,z:t.birthplace.z}}destroy(){var e=this;e.velocity=null,e.position=null,e.birthplace=null,e.emitPosition=null,e.color=null}},function(){class e extends THREE.ShaderMaterial{constructor(e){super(e);var t=this;t.vertexShader=t.getVertexShader(),t.fragmentShader=t.getFragmentShader()}getVertexShader(){return"\n                attribute float size;\n                attribute float alpha;\n                attribute vec3 color;\n\n                varying vec3 vColor;\n                varying float vAlpha;\n                #include <common>\n                #include <logdepthbuf_pars_vertex>\n                void main() {\n                    vAlpha= alpha;\n                    vColor = color;\n                    vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );\n\n                    gl_PointSize = size * ( 300.0 / -mvPosition.z );\n                    gl_Position = projectionMatrix * mvPosition;\n                    #include <logdepthbuf_vertex>\n                }"}getFragmentShader(){return"\n                mat2 rotate(float rad) {\n                    float c = cos(rad);\n                    float s = sin(rad);\n                    return mat2(\n                        c, s,\n                        -s, c\n                    );\n                }\n                uniform sampler2D pointTexture;\n                uniform float repeatX;\n                uniform float repeatY;\n                varying vec3 vColor;\n                varying float vAlpha;\n                #include <logdepthbuf_pars_fragment>\n                void main() {\n                    #include <logdepthbuf_fragment>\n                    vec2 pos = gl_PointCoord;\n                    float offsetX =(1.0-repeatX)/2.0;\n                    float offsetY =(1.0-repeatY)/2.0;\n                    if(pos.x-offsetX>repeatX || pos.x-offsetX<0.0 || pos.y-offsetY>repeatY || pos.y-offsetY<0.0) discard;\n                    vec4 img = texture2D(pointTexture, vec2((pos.x-offsetX)/repeatX, (pos.y-offsetY)/repeatY));\n                    vec4 color = vec4( vColor, vAlpha );\n                    gl_FragColor = vec4(color.xyz, color.w * img.w);\n                }"}}r.ParticleMaterial=e}(),r.ParticleSystem=class{constructor(e){var t=this;t.showParticle=!0,t.particleSystemManager=new r.ParticleSystemManager(t,e),t.repeatX=1,t.repeatY=1,t.imgTexture=null,t.uniforms={pointTexture:{value:t.imgTexture},repeatX:{value:t.repeatX},repeatY:{value:t.repeatY}},t.setOpts(e),t.shaderMaterial=new r.ParticleMaterial({uniforms:t.uniforms,blending:THREE.NormalBlending,depthTest:!0,depthWrite:!1,transparent:!0}),t.geometry=new THREE.BufferGeometry,t.particleSystem=new THREE.Points(t.geometry,t.shaderMaterial)}destroy(){this.particleSystemManager.destroy()}stop(){this.particleSystemManager.stop()}play(){this.particleSystemManager.play()}render(){this.particleSystemManager.render()}hide(){var e=this;e.showParticle=!1,null!=e.particleSystem&&(e.particleSystem.visible=e.show)}show(){var e=this;e.showParticle=!0,null!=e.particleSystem&&(e.particleSystem.visible=e.show)}setOpts(e){var t=this;null!=e.repeatX&&(t.repeatX=e.repeatX,t.uniforms.repeatX.value=t.repeatX),null!=e.repeatY&&(t.repeatY=e.repeatY,t.uniforms.repeatY.value=t.repeatY),null!=e.imgTexture&&t.imgTexture!=e.imgTexture&&(t.imgTexture=e.imgTexture,t.imgTexture.wrapS=THREE.ClampToEdgeWrapping,t.imgTexture.wrapT=THREE.ClampToEdgeWrapping,t.imgTexture.minFilter=THREE.NearestFilter,t.uniforms.pointTexture.value=t.imgTexture)}effectOpt(e){this.setOpts(e),this.particleSystemManager.effectOpt(e)}update(e){var t=this;null==e.position||null!=t.geometry.attributes.position&&t.geometry.attributes.position.array.length==e.position.length||t.geometry.setAttribute("position",new THREE.Float32BufferAttribute(e.position,3)),null==e.color||null!=t.geometry.attributes.color&&t.geometry.attributes.color.array.length==e.color.length||t.geometry.setAttribute("color",new THREE.Float32BufferAttribute(e.color,3)),null==e.size||null!=t.geometry.attributes.size&&t.geometry.attributes.size.array.length==e.size.length||t.geometry.setAttribute("size",new THREE.Float32BufferAttribute(e.size,1).setUsage(THREE.DynamicDrawUsage)),null==e.alpha||null!=t.geometry.attributes.alpha&&t.geometry.attributes.alpha.array.length==e.alpha.length||t.geometry.setAttribute("alpha",new THREE.Float32BufferAttribute(e.alpha,1).setUsage(THREE.DynamicDrawUsage)),t.particleSystem.visible=t.showParticle;var i=t.geometry.attributes.size.array,r=t.geometry.attributes.color.array,a=t.geometry.attributes.alpha.array,n=t.geometry.attributes.position.array;if(null!=e.position)for(var s=0;s<e.position.length;s++)n[s]=e.position[s];if(null!=e.color)for(s=0;s<e.color.length;s++)r[s]=e.color[s];if(null!=e.alpha)for(s=0;s<e.alpha.length;s++)a[s]=e.alpha[s];if(null!=e.size)for(s=0;s<e.size.length;s++)i[s]=e.size[s];t.geometry.attributes.size.needsUpdate=e.sizeNeedsUpdate,t.geometry.attributes.color.needsUpdate=e.colorNeedsUpdate,t.geometry.attributes.alpha.needsUpdate=e.alphaNeedsUpdate,t.geometry.attributes.position.needsUpdate=e.positionNeedsUpdate}},r.ParticleSystemManager=class{constructor(e,t){var i=this;i.FPS=20,i.FPS_MS=1e3/i.FPS,i.particleSystem=e,i.particleList=[],i.initialOpts(t)}initialOpts(e){var t=this;t.setOpts(e);for(var i=0;i<t.count;i++)t.createParticle()}createParticle(){var e=this,t=new r.Particle({initSize:e.size,initVelocity:e.initVelocity,emitPosition:e.emitPosition,scaleAry:e.scale,colorAry:e.color,minimumSpeed:e.minimumSpeed,maximumSpeed:e.maximumSpeed,minimumParticleLife:e.minimumParticleLife,maximumParticleLife:e.maximumParticleLife,originPitch:e.originPitch,radius:e.radius,updateCallback:e.updateCallback,applyGravity:e.applyGravity,randomFrameNumber:e.randomFrameNumber,randomXY:e.randomXY,camera:e.camera});e.particleList.push(t)}setOpts(e){var t=this;null!=e.emissionRate&&(t.emissionRate=e.emissionRate),null!=e.minimumParticleLife&&(t.minimumParticleLife=e.minimumParticleLife),null!=e.maximumParticleLife&&(t.maximumParticleLife=e.maximumParticleLife),null!=e.originYaw&&(t.originYaw=e.originYaw),null!=e.originPitch&&(t.originPitch=e.originPitch),null!=e.originYaw&&(t.initVelocity={z:Math.cos(t.originPitch),x:Math.sin(t.originPitch)*Math.cos(t.originYaw),y:Math.sin(t.originPitch)*Math.sin(t.originYaw)}),null!=e.size&&(t.size=e.size),null!=e.emitPosition&&(t.emitPosition=e.emitPosition),null!=e.scale&&(t.scale=e.scale),null!=e.color&&(t.color=e.color),null!=e.minimumSpeed&&(t.minimumSpeed=e.minimumSpeed),null!=e.maximumSpeed&&(t.maximumSpeed=e.maximumSpeed),null!=e.radius&&(t.radius=e.radius),null!=e.updateCallback&&(t.updateCallback=e.updateCallback),null!=e.applyGravity&&(t.applyGravity=e.applyGravity),null!=e.randomFrameNumber&&(t.randomFrameNumber=e.randomFrameNumber),null!=e.randomXY&&(t.randomXY=e.randomXY),null!=e.camera&&(t.camera=e.camera),t.renderCount=Math.floor(t.FPS*t.maximumParticleLife),t.count=t.emissionRate*t.renderCount}effectOpt(e){var t=this;if(t.setOpts(e),t.count<t.particleList.length)t.particleList.length=t.count;else if(t.count>t.particleList.length)for(var i=t.particleList.length;i<t.count;i++)t.createParticle();for(i=0;i<t.particleList.length;i++)t.particleList[i].initSize=t.size,t.particleList[i].initVelocity=t.initVelocity,t.particleList[i].emitPosition=t.emitPosition,t.particleList[i].scaleAry=t.scale,t.particleList[i].colorAry=t.color,t.particleList[i].minimumSpeed=t.minimumSpeed,t.particleList[i].maximumSpeed=t.maximumSpeed,t.particleList[i].minimumParticleLife=t.minimumParticleLife,t.particleList[i].maximumParticleLife=t.maximumParticleLife,t.particleList[i].originPitch=t.originPitch,t.particleList[i].radius=t.radius,t.particleList[i].updateCallback=t.updateCallback,t.particleList[i].applyGravity=t.applyGravity,t.particleList[i].randomFrameNumber=t.randomFrameNumber,t.particleList[i].randomXY=t.randomXY,t.particleList[i].camera=t.camera}stop(){this.startTime=null}play(){var e=this;e.startTime=(new Date).getTime(),e.renderTimes=0,e.loops=0}render(){var e=this,t=(new Date).getTime();if(null!=e.startTime){var i=(t-e.startTime)%(1e3*e.maximumParticleLife),r=Math.floor((t-e.startTime)/(1e3*e.maximumParticleLife));for(r>e.loops?(e.loops=r,e.renderTimes=0):r<e.loops&&(e.loops=r);e.renderTimes*e.FPS_MS<=i;){for(var a=e.renderTimes*e.emissionRate;a<(e.renderTimes+1)*e.emissionRate;a++)a<e.particleList.length&&e.particleList[a].init(t-i+e.renderTimes*e.FPS_MS);e.renderTimes++}}var n={position:[],color:[],alpha:[],size:[]};for(a=0;a<e.count;a++)e.particleList[a].updateStatus(t),n.position.push(e.particleList[a].position.x),n.position.push(e.particleList[a].position.y),n.position.push(e.particleList[a].position.z),n.color.push(e.particleList[a].color.r),n.color.push(e.particleList[a].color.g),n.color.push(e.particleList[a].color.b),0==e.particleList[a].visible?n.alpha.push(0):n.alpha.push(e.particleList[a].alpha),n.size.push(e.particleList[a].size);n.angleNeedsUpdate=!0,n.sizeNeedsUpdate=!0,n.colorNeedsUpdate=!0,n.alphaNeedsUpdate=!0,n.positionNeedsUpdate=!0,e.particleSystem.update(n)}destroy(){this.particleSystem=null,this.initVelocity=null}},function(){class e extends THREE.Group{constructor(e){super();var t=this;t._running=!0,t._paused=!1,t._tickTimeFirst=void 0,t._tickTimeLast=void 0,t._visible=!0,t.disPickable=!0,t.autoAnimation=!0,null!=e.scene?t.scene=e.scene:t.scene=t,t.SQRT2=Math.SQRT2,t.setOpts(e),t.createLine(),t.createMesh(),t.show(),t.offsetHeight=0,t.hopFlg=!0}destroy(){var e=this;e._clear(),e.scene=void 0,e.meshGeometry=void 0,e.meshMaterial=void 0,e.lineGeometry=void 0,e.lineMaterial.color=void 0}createMesh(){var e=this;e.meshGeometry=new THREE.BufferGeometry;let t=new Float32Array([0,0,0,e.radius_SQRT2,e.size,e.radius_SQRT2,e.radius_SQRT2,e.size,-e.radius_SQRT2,-e.radius_SQRT2,e.size,-e.radius_SQRT2,-e.radius_SQRT2,e.size,e.radius_SQRT2]);e.meshGeometry.setAttribute("position",new THREE.BufferAttribute(t,3));e.meshGeometry.setIndex([0,1,2,0,2,3,0,3,4,0,4,1,1,2,3,3,4,1]),e.meshGeometry.computeBoundingSphere(),e.meshMaterial=new THREE.MeshBasicMaterial({color:e.color,opacity:e.alpha,side:THREE.DoubleSide,depthTest:!0,transparent:!0,depthWrite:!1,blending:THREE.NormalBlending}),e.mesh=new THREE.Mesh(e.meshGeometry,e.meshMaterial),e.scene.add(e.mesh)}updateMesh(){const e=this,t=e.meshGeometry.getAttribute("position");t.array.set([0,0,0,e.radius_SQRT2,e.size,e.radius_SQRT2,e.radius_SQRT2,e.size,-e.radius_SQRT2,-e.radius_SQRT2,e.size,-e.radius_SQRT2,-e.radius_SQRT2,e.size,e.radius_SQRT2]),t.needsUpdate=!0,e.meshGeometry.computeBoundingSphere(),e.meshMaterial.color=e.color,e.meshMaterial.opacity=e.alpha}createLine(){var e=this;e.lineGeometry=new THREE.BufferGeometry;let t=new Float32Array([0,0,0,e.radius_SQRT2,e.size,e.radius_SQRT2,e.radius_SQRT2,e.size,-e.radius_SQRT2,-e.radius_SQRT2,e.size,-e.radius_SQRT2,-e.radius_SQRT2,e.size,e.radius_SQRT2]);e.lineGeometry.setAttribute("position",new THREE.BufferAttribute(t,3));e.lineGeometry.setIndex([0,1,2,0,2,3,0,3,4,0,4,1]),e.lineGeometry.computeBoundingSphere(),e.lineMaterial=new THREE.MeshBasicMaterial({color:e.wireframeColor,opacity:e.wireframeAlpha,depthTest:!0,transparent:!0,depthWrite:!1,wireframe:!0,wireframeLinewidth:1,wireframeLinejoin:"round"}),e.line=new THREE.Mesh(e.lineGeometry,e.lineMaterial),e.scene.add(e.line)}updateLine(){const e=this,t=e.lineGeometry.getAttribute("position");t.array.set([0,0,0,e.radius_SQRT2,e.size,e.radius_SQRT2,e.radius_SQRT2,e.size,-e.radius_SQRT2,-e.radius_SQRT2,e.size,-e.radius_SQRT2,-e.radius_SQRT2,e.size,e.radius_SQRT2]),t.needsUpdate=!0,e.lineGeometry.computeBoundingSphere(),e.lineMaterial.color=e.wireframeColor,e.lineMaterial.opacity=e.wireframeAlpha}_clear(){var e=this;null!=e.mesh&&e.scene.remove(e.mesh),null!=e.line&&e.scene.remove(e.line),null!=e.lineGeometry&&e.lineGeometry.dispose(),null!=e.lineMaterial&&e.lineMaterial.dispose(),null!=e.meshGeometry&&e.meshGeometry.dispose(),null!=e.meshMaterial&&e.meshMaterial.dispose()}update(){var e=this;if(void 0===e._tickTimeFirst&&(e._tickTimeFirst=(new Date).getTime(),e._tickTimeLast=e._tickTimeFirst),!this._running)return void this._updatePosition();if(this._paused)return void this._updatePosition(e._tickTimeLast);const t=this._tickTimeLast;this._tickTimeLast=(new Date).getTime(),this._updatePosition(t)}_updatePosition(e){var t=this;t.offsetHeight=void 0===e?0:r.Math.breatheTweens(0,t.size/2,e,t.duration),t.position.set(t.originPosition.x,t.originPosition.y,t.originPosition.z+t.offsetHeight),t.updateMatrixWorld()}play(){this._running&&!this._paused||(this._running=!0,this._paused=!1)}pause(){!1===this._paused&&(this._paused=!0)}stop(){this._running&&(this._running=!1,this._paused=!1)}effectOpt(e){var t=this;t.setOpts(e),t.updateMesh(),t.updateLine(),t.lineMaterial.visible=t._visible,t.meshMaterial.visible=t._visible}hide(){var e=this;e._visible=!1,e.lineMaterial.visible=!1,e.meshMaterial.visible=!1}show(){var e=this;e._visible=!0,e.lineMaterial.visible=!0,e.meshMaterial.visible=!0}setOpts(e){var t=this;e&&(void 0!==e.color&&null!==e.color&&(t.color=e.color),void 0!==e.alpha&&null!==e.alpha&&(t.alpha=e.alpha),void 0!==e.wireframeColor&&null!==e.wireframeColor&&(t.wireframeColor=e.wireframeColor),void 0!==e.wireframeAlpha&&null!==e.wireframeAlpha&&(t.wireframeAlpha=e.wireframeAlpha),void 0!==e.duration&&null!==e.duration&&(t.duration=e.duration),void 0!==e.size&&null!==e.size&&(t.size=e.size),void 0!==e.originPosition&&null!==e.originPosition&&(t.originPosition=e.originPosition,t.position.set(t.originPosition.x,t.originPosition.y,t.originPosition.z),t.updateMatrixWorld()),t.radius_SQRT2=t.size/t.SQRT2/2)}changeRotation(){this.rotation.x=Math.PI/2,this.updateMatrixWorld()}}r.PrismPoint=e}(),function(){class e extends THREE.Group{constructor(e){super();var t=this;t.disPickable=!0,t.autoAnimation=!0,t.viewer=e.engineViewer,t.color=new THREE.Color(1,0,0),t.alpha=.8,t.duration=1e3,t.blendingRatio=0,t.directionType=0,t.directionReverse=0,t.height=1,t.wallTexture=null,t.stretch=!1,t.repeat=!0,t.path=[],t.sideSum=0,t.imageWidth=512,t.imageHeight=32,t.unitLength=1,null!=e.scene?t.scene=e.scene:t.scene=t,t.setOpts(e),t.createUpdateMesh(),t.show()}createUpdateMesh(){const e=this;null==e.meshGeometry&&(e.meshGeometry=new THREE.BufferGeometry),e.meshGeometry.dispose();const t=e.path.length;var i=[],a=[];e.sideSum=0;for(var n=0,s=0;s<t-1;s++){var o=Math.sqrt((e.path[s].x-e.path[s+1].x)*(e.path[s].x-e.path[s+1].x)+(e.path[s].y-e.path[s+1].y)*(e.path[s].y-e.path[s+1].y));i.push(o),e.sideSum=e.sideSum+o}for(s=0;s<t-1;s++)a.push(n/e.sideSum),n+=i[s];a.push(n/e.sideSum);let l=[];for(let i=0;i<t;i++)l.push(new THREE.Vector3(e.path[i].x,e.path[i].y,e.path[i].z),new THREE.Vector3(e.path[i].x,e.path[i].y,e.path[i].z+e.height));const d=[],h=[];for(let e=0;e<t-1;++e){var c=2*e;h.push(l[c],l[c+1],l[c+3]),h.push(l[c],l[c+2],l[c+3]),d.push(new THREE.Vector2(a[e],0),new THREE.Vector2(a[e],1),new THREE.Vector2(a[e+1],1)),d.push(new THREE.Vector2(a[e],0),new THREE.Vector2(a[e+1],0),new THREE.Vector2(a[e+1],1))}l=null;let u=new Float32Array(3*h.length),p=new Float32Array(2*d.length);e.meshGeometry.setAttribute("position",new THREE.BufferAttribute(u,3).copyVector3sArray(h)),e.meshGeometry.setAttribute("uv",new THREE.BufferAttribute(p,2).copyVector2sArray(d));const m=Array.from(new Array(h.length).keys()).slice(0);e.meshGeometry.setIndex(m),e.meshGeometry.attributes.position.needsUpdate=!0,null==e.meshMaterial&&(e.meshMaterial=new r.WallMaterial({side:THREE.DoubleSide,depthTest:!0,transparent:!0,depthWrite:!1,blending:THREE.NormalBlending}),e.refreshUniforms(),null===e.meshGeometry.boundingSphere&&e.meshGeometry.computeBoundingSphere(),e.mesh=new THREE.Mesh(e.meshGeometry,e.meshMaterial),e.mesh.renderOrder=r.EnumRenderOrder.Effect,e.scene.add(e.mesh))}destroy(){var e=this;e.clear(),e.color=null,e.wallTexture=null,e.path=null,e.resetPath=null,e.scene=null}clear(){var e=this;null!=e.mesh&&(e.scene.remove(e.mesh),e.mesh=null),null!=e.meshGeometry&&(e.meshGeometry.dispose(),e.meshGeometry=null),null!=e.meshMaterial&&(e.meshMaterial.map=null,e.meshMaterial.dispose(),e.meshMaterial=null)}getBoundingBox(){let e=(new THREE.Box3).setFromObject(this);const t=this.viewer.getScene().getInverseMatrixGlobal();return e.applyMatrix4(t)}update(){var e=this,t=(new Date).getTime();1==e.directionReverse?e.meshMaterial.uniforms.time.value=r.Math.tweens(1,0,t,e.duration):e.meshMaterial.uniforms.time.value=r.Math.tweens(0,1,t,e.duration)}effectOpt(e){var t=this;t.setOpts(e),null!=t.resetPath&&(t.createUpdateMesh(),t.resetPath=null),t.refreshUniforms()}refreshUniforms(){var e=this;if(e.meshMaterial.color=e.color,e.meshMaterial.opacity=e.alpha,e.meshMaterial.uniforms.blendingRatio.value=e.blendingRatio,e.meshMaterial.uniforms.directionType.value=e.directionType,e.meshMaterial.uniforms.directionReverse.value=e.directionReverse,e.meshMaterial.uniforms.repeat.value=e.repeat?1:0,e.meshMaterial.map=e.wallTexture,0==e.stretch){var t=e.imageWidth/e.imageHeight;0==e.directionType?e.unitLength=e.sideSum/e.height/t:e.unitLength=e.height/e.sideSum/t}else e.unitLength=1;e.meshMaterial.uniforms.unitLength.value=e.unitLength}hide(){this.meshMaterial.visible=!1}show(){this.meshMaterial.visible=!0}setOpts(e){var t=this;e&&(void 0!==e.color&&null!==e.color&&(t.color=e.color),void 0!==e.alpha&&null!==e.alpha&&(t.alpha=e.alpha),void 0!==e.duration&&null!==e.duration&&(t.duration=e.duration),void 0!==e.blendingRatio&&null!==e.blendingRatio&&(t.blendingRatio=e.blendingRatio),void 0!==e.directionType&&null!==e.directionType&&("Tangent"==e.directionType?t.directionType=0:t.directionType=1),void 0!==e.directionReverse&&null!==e.directionReverse&&(0==e.directionReverse?t.directionReverse=0:t.directionReverse=1),void 0!==e.height&&null!==e.height&&(t.height=e.height),void 0!==e.wallTexture&&null!==e.wallTexture&&(t.wallTexture=e.wallTexture),void 0!==e.path&&null!==e.path&&(t.path=e.path),void 0!==e.stretch&&null!==e.stretch&&(t.stretch=e.stretch),void 0!==e.repeat&&null!==e.repeat&&(t.repeat=e.repeat),void 0!==e.imageWidth&&null!==e.imageWidth&&(t.imageWidth=e.imageWidth),void 0!==e.imageHeight&&null!==e.imageHeight&&(t.imageHeight=e.imageHeight))}}r.Wall=e}(),function(){class e extends THREE.Group{constructor(e){super();var t=this;t.disPickable=!0,t.autoAnimation=!0,t.viewer=e.viewer,t.modelManager=t.viewer.getModelManager(),null!=e.scene?t.scene=e.scene:t.scene=t,t.mesh=[],t.meshGeometry=[],t.angle=0,t.hiddenIds=[],t.externalObjectConverter=new r.ExternalObjectConverter(t.viewer),t.setOpts(e),t._updateGeometry(),t.createUpdateMesh(),t.show(),t.translateZ(.01)}_getRandomName(){return Math.floor(1e3*Math.random())+"_"+(new Date).getTime()}_cancelAllHidden(){for(var e=this,t=0;t<e.hiddenIds.length;t++)e.viewer.gisMode?e.viewer.getFilter().addToOverrideListByColor([e.hiddenIds[t].featureId],null,e.hiddenIds[t].modelId):e.viewer.getFilter().showByIds([e.hiddenIds[t].featureId],e.hiddenIds[t].modelId);e.hiddenIds=[]}_updateGeometry(){var e=this;if(e._cancelAllHidden(),e.meshLen=0,null!=e.boundaryGeometry)e._addGeometry(e.boundaryGeometry,new THREE.Matrix4);else{for(var t=0;t<e.ids.length;t++){var i=e.ids[t].objectIds;if(null==i)return void console.log("objectIds不能为空.");var r=e.ids[t].modelId;for(let t=0;t<i.length;t++)e.hiddenIds.push({modelId:r,featureId:i[t]});if(e.viewer.gisMode)e.viewer.getFilter().addToOverrideListByColor(i,{color:0,opacity:0},r);else{e.viewer.getFilter().hideByIds(i,r);for(let t=0;t<i.length;t++){var a=e.externalObjectConverter.convertToExternalObject(e._getRandomName(),i[t],!1);if(!(a.children.length<=0))for(var n=0,s=a.children.length;n<s;n++)e._addGeometry(a.children[n].geometry,a.children[n].matrix)}}}e.viewer.gisMode&&(e.tempMaterial=new THREE.ShaderMaterial)}e.meshGeometry.length>e.meshLen&&e.segmentationClear(e.meshLen)}createUpdateMesh(){var e=this;null==e.meshMaterial&&(e.meshMaterial=new r.PlaneScanMaterial({side:THREE.DoubleSide,depthTest:!0,transparent:!0,depthWrite:!1,blending:THREE.NormalBlending}),e.refreshUniforms());for(var t=!1,i=e.mesh.length;i<e.meshGeometry.length;i++){var a=new THREE.Mesh(e.meshGeometry[i],e.meshMaterial);a.renderOrder=r.EnumRenderOrder.Effect,e.scene.add(a),e.mesh.push(a),t=!0}t&&e.updateMatrixWorld()}_checkGeomtry(){var e=this;e.meshLen=e.meshGeometry.length;var t={};e.featureIdData={};for(var i=0;i<e.ids.length;i++)for(var r=e.ids[i].objectIds,a=e.ids[i].modelId,n=0;n<r.length;n++){var s={};s[r[n]]=!0,e.modelManager.traverseModels((function(i){i.id==a&&i.getPickingMeshes({skinningWireframeMaterial:e.tempMaterial,skinningSelectedMaterial:e.tempMaterial,selectedLineMaterial:e.tempMaterial,selectedMaterial:e.tempMaterial,wireframeMaterial:e.tempMaterial,instancedSelectedMaterial:e.tempMaterial,instancedWireFrameMaterial:e.tempMaterial},t,[r[n]],s,e.id+a)})),null!=t[a]&&e._getGeometry(t[a],a+"|"+r[n])}var o=!1;if(null!=e.featureIdDataBak){for(let t in e.featureIdDataBak)null==e.featureIdData[t]&&1==e.featureIdDataBak[t].visible&&(o=!0,e.featureIdDataBak[t].visible=!1);for(let t in e.featureIdData)if(null!=e.featureIdDataBak[t])if(e.featureIdData[t].drawcalls==e.featureIdDataBak[t].drawcalls)0==e.featureIdDataBak[t].visible&&(o=!0,e.featureIdDataBak[t].visible=!0),delete e.featureIdData[t];else{o=!0,e.featureIdDataBak[t]=e.featureIdData[t];for(n=e.mesh.length-1;n>=0;n--)e.mesh[n].geometry.mfKey==t&&(e.scene.remove(e.mesh[n]),e.mesh.splice(n,1),e.meshLen--)}else o=!0,e.featureIdDataBak[t]=e.featureIdData[t]}else e.featureIdDataBak=e.featureIdData,o=!0;if(0!=o){for(n=e.mesh.length-1;n>=0;n--)e.mesh[n].visible=e.featureIdDataBak[e.mesh[n].geometry.mfKey].visible;for(let i in e.featureIdData)for(let r=0;r<e.featureIdData[i].geometry.length;r++){var l=i.split("|")[0],d=t[l].matrix.clone();d=d.multiply(e.featureIdData[i].matrix[r]),e._addGeometry(e.featureIdData[i].geometry[r],d,i)}e.createUpdateMesh()}}_getGeometry(e,t){var i=this;if(null!=e.geometry){if(!e.isMesh)return;null==i.featureIdData[t]&&(i.featureIdData[t]={geometry:[],matrix:[],drawcalls:0,visible:!0}),i.featureIdData[t].geometry.push(e.geometry),i.featureIdData[t].matrix.push(e.matrix);for(var r=e.geometry.groups,a=0;a<r.length;a++)i.featureIdData[t].drawcalls+=e.geometry.groups[a].count}for(var n=e.children,s=0,o=n.length;s<o;s++)i._getGeometry(n[s],t)}_addGeometry(e,t,i){var r=this;let a=[],n=[],s=[];var o,l=e.getIndex().array,d=e.attributes.position.array;null!=e.attributes.uv?s=e.attributes.uv.array:(e.computeBoundingBox(),e.boundingBox.clone().applyMatrix4(t)),r.meshGeometry.length<=r.meshLen?(o=new THREE.BufferGeometry,r.meshGeometry.push(o)):o=r.meshGeometry[r.meshLen];for(var h={x:Number.MAX_VALUE,y:Number.MAX_VALUE},c={x:-Number.MAX_VALUE,y:-Number.MAX_VALUE},u=new THREE.Vector3,p=0;p<d.length;p+=3)u.set(d[p],d[p+1],d[p+2]),u.applyMatrix4(t),a.push(u.x),a.push(u.y),a.push(u.z),null==e.attributes.uv&&(s.push(u.x),s.push(u.y));var m=e.groups;if(null!=m&&0!=m.length)for(let t=0;t<m.length;t++)for(var f=m[t],g=f.start;g<f.start+f.count;g++)n.push(l[g]),null==e.attributes.uv&&(c.x=Math.max(c.x,a[3*l[g]]),c.y=Math.max(c.y,a[3*l[g]+1]),h.x=Math.min(h.x,a[3*l[g]]),h.y=Math.min(h.y,a[3*l[g]+1]));else if(n=l,null==e.attributes.uv)for(g=0;g<l.length;g++)c.x=Math.max(c.x,a[3*l[g]]),c.y=Math.max(c.y,a[3*l[g]+1]),h.x=Math.min(h.x,a[3*l[g]]),h.y=Math.min(h.y,a[3*l[g]+1]);if(null==e.attributes.uv)for(p=0;p<s.length;p++)if(p%2==0){var v=(s[p]-h.x)/(c.x-h.x);s[p]=v}else{var y=(s[p]-h.y)/(c.y-h.y);s[p]=y}o.setIndex(new THREE.Uint32BufferAttribute(n,1)),o.setAttribute("uv",new THREE.Float32BufferAttribute(s,2)),o.setAttribute("position",new THREE.Float32BufferAttribute(a,3)),null!=i&&(o.mfKey=i),r.meshLen++}destroy(){this.clear(),this.externalObjectConverter.destroy()}clear(){var e=this;if(null!=e.mesh&&e.mesh.length>0){for(var t=0;t<e.mesh.length;t++)e.scene.remove(e.mesh[t]);e.mesh=[]}if(null!=e.meshGeometry&&e.meshGeometry.length>0){for(t=0;t<e.meshGeometry.length;t++)e.meshGeometry[t].dispose();e.meshGeometry=[]}null!=e.meshMaterial&&e.meshMaterial.dispose(),e._cancelAllHidden()}segmentationClear(e=0){var t=this;if(t.featureIdDataBak=null,null!=t.mesh&&t.mesh.length>0){for(var i=e;i<t.mesh.length;i++)t.scene.remove(t.mesh[i]);t.mesh.length=e}if(null!=t.meshGeometry&&t.meshGeometry.length>0){for(i=e;i<t.meshGeometry.length;i++)t.meshGeometry[i].dispose();t.meshGeometry.length=e}}update(){var e=this;e.ids.length>0&&e.viewer.gisMode&&e._checkGeomtry();var t=(new Date).getTime();e.meshMaterial.uniforms.time.value=r.Math.tweens(0,1,t,e.duration)}effectOpt(e){var t=this;t.setOpts(e),null!=t.resetPath&&(t._updateGeometry(),t.createUpdateMesh(),t.resetPath=null),t.refreshUniforms()}refreshUniforms(){var e=this;null!=e.meshMaterial&&(e.meshMaterial.color=e.color,e.meshMaterial.opacity=e.alpha,e.meshMaterial.uniforms.blendingRatio.value=e.blendingRatio,e.meshMaterial.uniforms.angle.value=e.angle,e.meshMaterial.map=e.planeScanTexture)}hide(){null!=this.meshMaterial&&(this.meshMaterial.visible=!1)}show(){null!=this.meshMaterial&&(this.meshMaterial.visible=!0)}setOpts(e){var t=this;e&&(void 0!==e.color&&null!==e.color&&(t.color=e.color),void 0!==e.alpha&&null!==e.alpha&&(t.alpha=e.alpha),void 0!==e.duration&&null!==e.duration&&(t.duration=e.duration),void 0!==e.blendingRatio&&null!==e.blendingRatio&&(t.blendingRatio=e.blendingRatio),void 0!==e.direction&&null!==e.direction&&(t.direction=e.direction,0==t.direction.x&&0==t.direction.y?t.angle=0:0==t.direction.x&&0!=t.direction.y?t.angle=t.direction.y>0?Math.PI/2:3*Math.PI/2:0!=t.direction.x&&0==t.direction.y?t.angle=t.direction.x>0?0:Math.PI:(t.angle=Math.atan(t.direction.y/t.direction.x),t.direction.x<0&&(t.angle=t.angle+Math.PI))),void 0!==e.planeScanTexture&&null!==e.planeScanTexture&&(t.planeScanTexture=e.planeScanTexture,t.planeScanTexture.encoding=THREE.sRGBEncoding),void 0===e.ids||null===e.ids||e.boundaryGeometry?void 0!==e.boundaryGeometry&&null!==e.boundaryGeometry&&(t.boundaryGeometry=e.boundaryGeometry,t.ids=[]):(t.ids=e.ids,t.boundaryGeometry=null))}}r.PlaneScan=e}(),function(){class e extends THREE.Group{constructor(e){super();var t=this;t._running=!0,t._paused=!1,t._tickTimeFirst=void 0,t._tickTimeLast=void 0,t.disPickable=!0,t.autoAnimation=!0,null!=e.scene?t.scene=e.scene:t.scene=t,t.setOpts(e),t.createUpdateMesh(),t.show()}createUpdateMesh(){var e=this;null==e.meshGeometry&&(e.meshGeometry=new THREE.BufferGeometry);var t=2*Math.PI;let i=new Float32Array(195);i.set([0,0,0]);let a=new Uint32Array(192),n=3,s=0;for(var o=0;o<64;o++){var l=o/64*t,d=Math.cos(l),h=Math.sin(l);i[n++]=e.radius*d,i[n++]=e.radius*h,i[n++]=0,o<63?(a[s++]=0,a[s++]=o+1,a[s++]=o+2):(a[s++]=0,a[s++]=o+1,a[s++]=1)}e.meshGeometry.setAttribute("position",new THREE.BufferAttribute(i,3)),e.meshGeometry.setIndex(new THREE.BufferAttribute(a,1)),null===e.meshGeometry.boundingSphere&&e.meshGeometry.computeBoundingSphere(),null==e.meshMaterial&&(e.meshMaterial=new r.FanScanMaterial({side:THREE.DoubleSide,depthTest:!0,transparent:!0,depthWrite:!1,blending:THREE.NormalBlending}),e.refreshUniforms(),e.mesh=new THREE.Mesh(e.meshGeometry,e.meshMaterial),e.scene.add(e.mesh))}destroy(){this._clear()}_clear(){var e=this;null!=e.mesh&&(e.scene.remove(e.mesh),e.mesh=null),null!=e.meshGeometry&&(e.meshGeometry.dispose(),e.meshGeometry=null),null!=e.meshMaterial&&(e.meshMaterial.dispose(),e.meshMaterial=null)}update(){if(void 0===this._tickTimeFirst&&(this._tickTimeFirst=(new Date).getTime(),this._tickTimeLast=this._tickTimeFirst),!this._running)return void(this.meshMaterial.uniforms.time.value=1);if(this._paused)return void(this.meshMaterial.uniforms.time.value=r.Math.tweens(1,0,this._tickTimeLast,this.duration));const e=this._tickTimeLast;this._tickTimeLast=(new Date).getTime(),this.meshMaterial.uniforms.time.value=r.Math.tweens(1,0,e,this.duration)}effectOpt(e){var t=this;t.setOpts(e),null!=t.resetMesh&&t.createUpdateMesh(),t.refreshUniforms(),t.resetMesh=null}refreshUniforms(){var e=this;e.meshMaterial.color=e.color,e.meshMaterial.opacity=e.alpha,e.meshMaterial.uniforms.backgroundColor.value=e.backgroundColor,e.meshMaterial.uniforms.backgroundOpacity.value=e.backgroundAlpha,e.meshMaterial.uniforms.fanAngle.value=e.fanAngle/(2*Math.PI)}hide(){this.visible=!1}show(){this.visible=!0}setOpts(e){var t=this;e&&(void 0!==e.color&&null!==e.color&&(t.color=e.color),void 0!==e.alpha&&null!==e.alpha&&(t.alpha=e.alpha),void 0!==e.backgroundColor&&null!==e.backgroundColor&&(t.backgroundColor=e.backgroundColor),void 0!==e.backgroundAlpha&&null!==e.backgroundAlpha&&(t.backgroundAlpha=e.backgroundAlpha),null!=e.fanAngle&&(t.fanAngle=e.fanAngle),null!=e.radius&&(t.radius=e.radius),void 0!==e.duration&&null!==e.duration&&(t.duration=e.duration),void 0!==e.originPosition&&null!==e.originPosition&&(t.originPosition=e.originPosition,t.position.set(t.originPosition.x,t.originPosition.y,t.originPosition.z),t.updateMatrixWorld()))}play(){this._running&&!this._paused||(this._running=!0,this._paused=!1)}pause(){!1===this._paused&&(this._paused=!0)}stop(){this._running&&(this._running=!1,this._paused=!1)}}r.FanScan=e}(),function(){class e extends THREE.Group{constructor(e){super(),this._running=!0,this._paused=!1,this._tickTimeFirst=void 0,this._tickTimeLast=void 0,this.disPickable=!1,this.autoAnimation=!0,this.radius=500,this.emitPosition=new THREE.Vector3(0,1,0),this.originPosition=new THREE.Vector3(0,0,0),this.progressive=10,this.duration=3e3,this.color=new THREE.Vector3(1,1,1),this.alpha=1,this.range=[],this.meshGeometry=null,this.setOpts(e),this.createUpdateMesh()}destroy(){this.clear(),this.radius=void 0,this.emitPosition=null,this.originPosition=null,this.progressive=void 0,this.duration=void 0,this.color=null,this.alpha=void 0,this.range=null,this.meshGeometry.dispose(),this.meshGeometry=null,this.meshMaterial.dispose(),this.meshMaterial=null}updateGeometry(){const e=[this.originPosition.x-this.radius,this.originPosition.y+this.radius,this.originPosition.z,this.originPosition.x+this.radius,this.originPosition.y+this.radius,this.originPosition.z,this.originPosition.x-this.radius,this.originPosition.y-this.radius,this.originPosition.z,this.originPosition.x+this.radius,this.originPosition.y-this.radius,this.originPosition.z];this.meshGeometry.setIndex([0,2,1,2,3,1]),this.meshGeometry.setAttribute("position",new THREE.Float32BufferAttribute(e,3)),this.meshGeometry.setAttribute("normal",new THREE.Float32BufferAttribute([0,0,1,0,0,1,0,0,1,0,0,1],3)),this.meshGeometry.attributes.position.needsUpdate=!0,this.meshGeometry.computeBoundingBox(),this.meshGeometry.computeBoundingSphere()}createUpdateMesh(){null==this.meshGeometry&&(this.meshGeometry=new THREE.BufferGeometry,this.updateGeometry()),null===this.meshGeometry.boundingSphere&&this.meshGeometry.computeBoundingSphere(),null==this.meshMaterial&&(this.meshMaterial=new r.RingScanMaterial({side:THREE.DoubleSide,depthTest:!0,transparent:!0,depthWrite:!1,blending:THREE.NormalBlending,polygonOffset:!0,polygonOffsetFactor:-1,polygonOffsetUnits:-10}),this.refreshUniforms()),this.mesh=new THREE.Mesh(this.meshGeometry,this.meshMaterial),this.add(this.mesh)}update(){if(void 0===this._tickTimeFirst&&(this._tickTimeFirst=(new Date).getTime(),this._tickTimeLast=this._tickTimeFirst),!this._running)return void(this.meshMaterial.uniforms.time.value=1);if(this._paused)return void(this.meshMaterial.uniforms.time.value=r.Math.tweens(0,1,this._tickTimeLast,this.duration));const e=this._tickTimeLast;this._tickTimeLast=(new Date).getTime(),this.meshMaterial.uniforms.time.value=r.Math.tweens(0,1,e,this.duration)}effectOpt(e){this.setOpts(e),null!=this.resetPath&&(this.updateGeometry(),this.resetPath=null),this.refreshUniforms()}refreshUniforms(){null!=this.meshMaterial&&(this.meshMaterial.opacity=this.alpha,this.meshMaterial.uniforms.backGroundColor.value=this.color,this.meshMaterial.uniforms.radius.value=this.radius,this.meshMaterial.uniforms.progressive.value=this.progressive,this.meshMaterial.uniforms.scanCenter.value=this.originPosition)}hide(){null!=this.meshMaterial&&(this.visible=!1)}show(){null!=this.meshMaterial&&(this.visible=!0)}setOpts(e){e&&(null!=e.originPosition&&(this.originPosition=new THREE.Vector3(e.originPosition.x,e.originPosition.y,e.originPosition.z)),null!=e.progressive&&(this.progressive=e.progressive),null!=e.radius&&(this.radius=e.radius),null!=e.duration&&(this.duration=e.duration),void 0!==e.color&&null!==e.color&&(this.color=e.color),void 0!==e.alpha&&null!==e.alpha&&(this.alpha=e.alpha))}play(){this._running&&!this._paused||(this._running=!0,this._paused=!1)}pause(){!1===this._paused&&(this._paused=!0)}stop(){this._running&&(this._running=!1,this._paused=!1)}}r.RingScan=e}(),function(){class e extends THREE.Group{constructor(e){super();var t=this;t.viewer=e.engineViewer,t.modelManager=t.viewer.getModelManager(),t.scene=t.viewer.getScene(),t.refleRefraManager=t.viewer.refleRefraManager,t.modelsColorInfo=[],t.externalObjectConverter=new r.ExternalObjectConverter(t.viewer),t.initNormalMap(e),t.initOption(e),t.saveOriginalModelsColor(),t.modelUserIdTileMapVisibility={},t.modelUserIdTileMapState={},t._updateGeometry(),t.addMesh(),t.translateZ(.01),t._enableAnimation=!0}saveOriginalModelsColor(){let e=this;for(let t=0;t<e.ids.length;t++){let i=e.ids[t].modelId;e.viewer.modelManager.getModel(i).getFilter().filterActionList.forEach((r=>{if(r.material&&r.ids){let a=r.material.color,n=r.material.opacity,s=new Glodon.Web.Graphics.Color(255*a.r,255*a.g,255*a.b,n),o=parseInt(s.getHEX(),16),l=s.getAlpha();for(let a=0;a<e.ids[t].objectIds.length;a++){if(r.ids.includes(e.ids[t].objectIds[a])){let r=new Array;r.push(e.ids[t].objectIds[a]),e.modelsColorInfo.push({modelId:i,objectIds:r,modelColor:o,modelOpacity:l})}}}}))}}_cancelAllHidden(){for(var e=this,t=0;t<e.ids.length;t++){var i=e.ids[t].objectIds,r=e.ids[t].modelId;e.viewer.getFilter().addToOverrideListByColor(i,null,r),e.viewer.getFilter().showByIds(i,r)}e.modelsColorInfo.forEach((t=>{let i=t.modelId,r=t.modelColor,a=t.modelOpacity,n=t.objectIds;e.viewer.getFilter().addToOverrideListByColor(n,{color:r,opacity:a},i),e.viewer.getFilter().showByIds(n,i)}))}getBoundingBox(){let e=(new THREE.Box3).setFromObject(this);const t=this.viewer.getScene().getInverseMatrixGlobal();return e.applyMatrix4(t)}_getRandomName(){return Math.floor(1e3*Math.random())+"_"+(new Date).getTime()}_updateGeometry(){var e=this;if(e._cancelAllHidden(),e.meshLen=0,e.featureCount=0,e.isLoadedMeshes=!1,e.isAddUpdate=!1,null!=e.boundaryGeometry)e._addGeometry(e.boundaryGeometry,new THREE.Matrix4);else{for(var t=0;t<e.ids.length;t++){var i=e.ids[t].objectIds;if(null==i)return void console.log("objectIds不能为空.");var r=e.ids[t].modelId;let o=e.modelManager.getModel(r).transformMatrix;for(let t=0;t<i.length;t++){var a=e.externalObjectConverter.convertToExternalObject(e._getRandomName(),i[t],!1);if(a.children.length<=0)continue;let l=r+"|"+i[t];for(var n=0,s=a.children.length;n<s;n++){let t=(new THREE.Matrix4).copy(o).multiply(a.children[n].matrix);e._addGeometry(a.children[n].geometry,t,l)}}e.viewer.getFilter().addToOverrideListByColor(i,{color:0,opacity:0},r),e.featureCount+=i.length}e.viewer.gisMode&&(e.tempMaterial=new THREE.ShaderMaterial)}e.meshGeometry.length>e.meshLen&&e.segmentationClear(e.meshLen)}createMesh(e){var t=this,i=t.initMaterial(e);t.meshMaterial.push(i);var a=new THREE.Mesh(e,i);return a.type="Water",a.renderOrder=r.GlobalData.IncrementRender?r.EnumRenderOrder.Effect:r.EnumRenderOrder.BeforeComponent,t.shadow&&t.refleRefraManager.addWaterManager({textureWidth:t.textureWidth,textureHeight:t.textureHeight,clipBias:t.clipBias,mesh:a}),a}addMesh(){for(var e=this,t=e.mesh.length;t<e.meshGeometry.length;t++){var i=e.createMesh(e.meshGeometry[t]);e.add(i),i.translateZ(e.meshGeometry[t].initialOffset),e.mesh.push(i),e.isAddUpdate=!0}e.isAddUpdate&&e.updateMatrixWorld()}_checkVisible(){var e=this;for(var t in e.featureIdDataBak){var i=t.split("|"),r=i[0],a=i[1];let n=!e.viewer.getFilter().isHidden(a,r);if(e.viewer.gisMode||!0===e.isGisMode){const t=e.modelManager.getModel(r);n=n&&t.isUserIdVisible(a)}n!=e.featureIdDataBak[t].visible&&(e.featureIdDataBak[t].visible=n,e.isAddUpdate=!0)}e.updateVisible()}updateVisible(){for(var e=this,t=e.mesh.length-1;t>=0;t--)void 0!==e.mesh[t]&&e.featureIdDataBak[e.mesh[t].geometry.mfKey]&&(e.mesh[t].visible=e.featureIdDataBak[e.mesh[t].geometry.mfKey].visible,e.mesh[t].material.visible=e.mesh[t].visible)}_checkGeomtry(){var e=this;e.meshLen=e.meshGeometry.length,e.featureIdData={};for(var t={},i=0;i<e.ids.length;i++)for(var r=e.ids[i].objectIds,a=e.ids[i].modelId,n=0;n<r.length;n++){var s={};s[r[n]]=!0,e.modelManager.traverseModels((function(i){i.id==a&&i.isVisible()&&i.getPickingMeshes({skinningWireframeMaterial:e.tempMaterial,skinningSelectedMaterial:e.tempMaterial,selectedLineMaterial:e.tempMaterial,selectedMaterial:e.tempMaterial,wireframeMaterial:e.tempMaterial,instancedSelectedMaterial:e.tempMaterial,instancedWireFrameMaterial:e.tempMaterial},t,[r[n]],s,e.id+a)})),null!=t[a]&&e._getGeometry(t[a],a+"|"+r[n])}var o=!1;if(null!=e.featureIdDataBak){for(let t in e.featureIdDataBak)null==e.featureIdData[t]&&1==e.featureIdDataBak[t].visible&&(o=!0,e.featureIdDataBak[t].visible=!1);for(let t in e.featureIdData)if(null!=e.featureIdDataBak[t])if(e.featureIdData[t].drawcalls==e.featureIdDataBak[t].drawcalls)0==e.featureIdDataBak[t].visible&&(o=!0,e.featureIdDataBak[t].visible=!0),delete e.featureIdData[t];else{o=!0,e.featureIdDataBak[t]=e.featureIdData[t];for(n=e.mesh.length-1;n>=0;n--)e.mesh[n].geometry.mfKey==t&&(e.shadow&&e.refleRefraManager.removeWaterManager(e.mesh[n].material.refleRefraId),e.remove(e.mesh[n]),e.mesh.splice(n,1),e.meshGeometry[n].dispose(),e.meshGeometry.splice(n,1),e.meshMaterial[n].dispose(),e.meshMaterial.splice(n,1),e.meshLen--)}else o=!0,e.featureIdDataBak[t]=e.featureIdData[t]}else e.featureIdDataBak=e.featureIdData,o=!0;0!=o&&(e.updateVisible(),e.isLoadedMeshes=e.featureCount==Object.keys(e.featureIdDataBak).length)}_getGeometry(e,t){var i=this;if(null!=e.geometry){if(!e.isMesh)return;null==i.featureIdData[t]&&(i.featureIdData[t]={geometry:[],matrix:[],drawcalls:0,visible:!0}),i.featureIdData[t].geometry.push(e.geometry),i.featureIdData[t].matrix.push(e.matrix);for(var r=e.geometry.groups,a=0;a<r.length;a++)i.featureIdData[t].drawcalls+=e.geometry.groups[a].count}for(var n=e.children,s=0,o=n.length;s<o;s++)i._getGeometry(n[s],t)}_addGeometry(e,t,i){var r=this,a=function(e){return e>=p.z-r.heightTolerance&&e<=p.z+r.heightTolerance};let n=[],s=[],o=[],l=[];var d=e.getIndex().array,h=e.attributes.position.array;e.computeBoundingBox();var c,u={x:Number.MAX_VALUE,y:Number.MAX_VALUE},p={x:-Number.MAX_VALUE,y:-Number.MAX_VALUE,z:-Number.MAX_VALUE};r.meshGeometry.length<=r.meshLen?(c=new THREE.BufferGeometry,r.meshGeometry.push(c)):c=r.meshGeometry[r.meshLen];var m=[],f=[],g=e.groups;if(null!=g&&0!=g.length){var v={},y=0;for(let e=0;e<g.length;e++)for(var M=g[e],E=M.start;E<M.start+M.count;E++)null==v[d[E]]?(m.push(y),v[d[E]]=y,y++,f.push(h[3*d[E]]),f.push(h[3*d[E]+1]),f.push(h[3*d[E]+2])):m.push(v[d[E]])}else m=d,f=h;for(var b,I,x,T,_=new THREE.Vector3,S=0;S<f.length;S+=3)_.set(f[S],f[S+1],f[S+2]),_.applyMatrix4(t),n.push(_.x),n.push(_.y),n.push(_.z),l.push(0),l.push(0),l.push(1),o.push(_.x),o.push(_.y);for(S=0;S<m.length;S++)b=m[S],I=void 0,x=void 0,T=void 0,I=n[3*b],x=n[3*b+1],T=n[3*b+2],p.x=Math.max(p.x,I),p.y=Math.max(p.y,x),p.z=Math.max(p.z,T),u.x=Math.min(u.x,I),u.y=Math.min(u.y,x);for(S=0;S<m.length;S+=3){let e=m[S],t=m[S+1],i=m[S+2];(null==r.heightTolerance||a(n[3*e+2])&&a(n[3*t+2])&&a(n[3*i+2]))&&(s.push(e),s.push(t),s.push(i))}for(S=2;S<n.length;S+=3)n[S]=0;for(S=0;S<o.length;S++)if(S%2==0){var C=(o[S]-u.x)/(p.x-u.x);o[S]=C}else{var w=(o[S]-u.y)/(p.y-u.y);o[S]=w}c.setIndex(new THREE.Uint32BufferAttribute(s,1)),c.setAttribute("uv",new THREE.Float32BufferAttribute(o,2)),c.setAttribute("position",new THREE.Float32BufferAttribute(n,3)),c.setAttribute("normal",new THREE.Float32BufferAttribute(l,3)),c.initialOffset=p.z,null!=i&&(c.mfKey=i),c.computeBoundingBox(),null==r.box&&(r.box=new THREE.Box3),r.box.expandByPoint(c.boundingBox.min),r.box.expandByPoint(c.boundingBox.max),r.meshLen++}destroy(){this.clear(),this.externalObjectConverter.destroy()}clear(){var e=this;if(null!=e.mesh&&e.mesh.length>0){for(var t=0;t<e.mesh.length;t++)e.shadow&&e.refleRefraManager.removeWaterManager(e.mesh[t].material.refleRefraId),e.remove(e.mesh[t]);e.mesh=[]}if(null!=e.meshGeometry&&e.meshGeometry.length>0){for(t=0;t<e.meshGeometry.length;t++)e.meshGeometry[t].dispose();e.meshGeometry=[]}if(null!=e.meshMaterial&&e.meshMaterial.length>0){for(t=0;t<e.meshMaterial.length;t++)e.meshMaterial[t].dispose();e.meshMaterial=[]}e._cancelAllHidden()}segmentationClear(e=0){var t=this;if(t.featureIdDataBak=null,null!=t.mesh&&t.mesh.length>0){for(var i=e;i<t.mesh.length;i++)t.shadow&&t.refleRefraManager.removeWaterManager(t.mesh[i].material.refleRefraId),t.remove(t.mesh[i]);t.mesh.length=e}if(null!=t.meshGeometry&&t.meshGeometry.length>0){for(i=e;i<t.meshGeometry.length;i++)t.meshGeometry[i].dispose();t.meshGeometry.length=e}}_updateBoundaryGeometry(e){let t=this,i=[],r=[];t.box=new THREE.Box3;const a=e.getIndex().array,n=e.attributes.position.array;for(let e=0;e<n.length;e+=3)r.push(0),r.push(0),r.push(1),i.push(n[e]),i.push(n[e+1]);e.computeBoundingBox();const s=e.boundingBox;for(var o=0;o<i.length;o++)if(o%2==0){var l=(i[o]-s.min.x)/(s.max.x-s.min.x);i[o]=l}else{var d=(i[o]-s.min.y)/(s.max.y-s.min.y);i[o]=d}let h=t.mesh[0].geometry;h.setIndex(new THREE.Uint32BufferAttribute(a,1)),h.setAttribute("uv",new THREE.Float32BufferAttribute(i,2)),h.setAttribute("position",new THREE.Float32BufferAttribute(n,3)),h.setAttribute("normal",new THREE.Float32BufferAttribute(r,3)),h.attributes.uv.needsUpdate=!0,h.attributes.position.needsUpdate=!0,h.attributes.normal.needsUpdate=!0,h.computeBoundingBox(),h.computeBoundingSphere(),t.meshGeometry[0]=h,null==t.box&&(t.box=new THREE.Box3),t.box.expandByPoint(h.boundingBox.min),t.box.expandByPoint(h.boundingBox.max),this.boundaryGeometry=e}update(){var e=this;if(e.unrender=!1,e.isAddUpdate=!1,e.ids.length>0&&(null!=e.featureIdDataBak&&e.isLoadedMeshes?e._checkVisible():e._checkGeomtry()),e.flow){if(e._enableAnimation)for(var t=e.clock.getDelta(),i=0;i<e.mesh.length;i++)if(e.mesh[i].visible){e.meshMaterial[i].uniforms.sunDirection.value=e.scene.sunDirection,e.meshMaterial[i].uniforms.flowTime.value+=1/120;var r=e.meshMaterial[i].uniforms.config;r.value.x+=e.flowSpeed*t,r.value.y=r.value.x+e.halfCycle,r.value.x>=e.cycle?(r.value.x=0,r.value.y=e.halfCycle):r.value.y>=e.cycle&&(r.value.y=r.value.y-e.cycle)}}else e.isAddUpdate||(e.unrender=!0)}setColor(e,t){var i=this;i.color=e,i.alpha=t;for(var r=0;r<i.meshMaterial.length;r++)i.meshMaterial[r].isUndersea=i.alpha<1,i.meshMaterial[r].uniforms.waterColor.value=new THREE.Vector4(i.color.r,i.color.g,i.color.b,i.alpha)}setScale(e){var t=this;t.wavesScale=e;for(var i=0;i<t.meshMaterial.length;i++)t.meshMaterial[i].uniforms.config.value.w=t.wavesScale}setDirection(e,t){var i=this;i.flowDirection=new THREE.Vector2(e,t);for(var r=0;r<i.meshMaterial.length;r++)i.meshMaterial[r].uniforms.flowDirection.value=i.flowDirection}initOption(e){var t=this;t.color=e.color,t.alpha=e.alpha,void 0!==e.ids&&null!==e.ids&&e.ids.length>0?(t.ids=e.ids,t.boundaryGeometry=null,t.componentIds=[]):void 0!==e.boundaryGeometry&&null!==e.boundaryGeometry&&(t.boundaryGeometry=e.boundaryGeometry,t.ids=[],t.componentIds=[]),void 0!==e.heightTolerance&&null!==e.heightTolerance?t.heightTolerance=e.heightTolerance:t.heightTolerance=null,t.flowDirection=e.flowDirection||new THREE.Vector2(1,0),t.flowMap=e.flowMap||void 0,t.flowSpeed=e.flowSpeed||.03,t.reflectivity=e.reflectivity||.1,t.wavesScale=e.scale||1,e.shadow?t.shadow=!0:t.shadow=!1,e.flow?t.flow=!0:t.flow=!1,t.cycle=e.cycle||.4,t.halfCycle=.5*t.cycle,t.clock=new THREE.Clock,t.hiddenIds=[],t.meshMaterial=[],t.mesh=[],t.meshGeometry=[]}initNormalMap(e){var t=this,i=new THREE.TextureLoader;t.textureWidth=e.textureWidth||512,t.textureHeight=e.textureHeight||512,t.clipBias=e.clipBias||0;var r=e.map0,a=e.map1;t.normalMap0=e.normalMap0||i.load(r),t.normalMap1=e.normalMap1||i.load(a),t.normalMap0.wrapS=t.normalMap0.wrapT=THREE.RepeatWrapping,t.normalMap1.wrapS=t.normalMap1.wrapT=THREE.RepeatWrapping}initMaterial(e){var t=new r.WaterMaterial;return t.initUniforms(this),t}show(){this.visible=!0}hide(){this.visible=!1}enableAnimation(e){this._enableAnimation=e}}r.Water=e}(),r.RefleRefraManager=class{constructor(e){var t=this;t.viewer=e,t.scene=t.viewer.getScene(),t.refleRefraManager={}}getReflectorTexture(e){if(null!=this.refleRefraManager[e])return this.refleRefraManager[e].reflector.getRenderTarget().texture}getRefractorTexture(e){if(null!=this.refleRefraManager[e])return this.refleRefraManager[e].refractor.getRenderTarget().texture}_getRandomId(){return"RefleRefra-"+Math.floor(1e3*Math.random())+"-"+(new Date).getTime()}removeWaterManager(e){var t=this;null!=t.refleRefraManager[e]&&(t.refleRefraManager[e]=null,delete t.refleRefraManager[e])}addWaterManager(e){var t=this,i=t._getRandomId(),r=e.mesh,a=new THREE.Reflector(r.geometry,{textureWidth:e.textureWidth,textureHeight:e.textureHeight,clipBias:e.clipBias});a.matrixAutoUpdate=!1;var n=new THREE.Refractor(r.geometry,{textureWidth:e.textureWidth,textureHeight:e.textureHeight,clipBias:e.clipBias});n.matrixAutoUpdate=!1,t.refleRefraManager[i]={reflector:a,refractor:n,mesh:r},r.material.refleRefraId=i,r.material.uniforms.tReflectionMap.value=t.getReflectorTexture(i),r.material.uniforms.tRefractionMap.value=t.getRefractorTexture(i)}hideAllMesh(){for(var e in this.refleRefraManager)this.refleRefraManager[e].mesh.visible=!1}showAllMesh(){for(var e in this.refleRefraManager)this.refleRefraManager[e].mesh.visible=!0}render(e){var t=this;for(var i in t.refleRefraManager){var r=t.refleRefraManager[i],a=r.mesh;if(0!=r.mesh.visible){var n=a.material;n.textureMatrix.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),n.textureMatrix.multiply(t.viewer.camera.projectionMatrix),n.textureMatrix.multiply(t.viewer.camera.matrixWorldInverse),n.textureMatrix.multiply(a.matrixWorld),t.hideAllMesh(),r.reflector.matrixWorld.copy(a.matrixWorld),r.reflector.onBeforeRender(e,t.scene,t.viewer.camera),n.isUndersea&&(r.refractor.matrixWorld.copy(a.matrixWorld),r.refractor.onBeforeRender(e,t.scene,t.viewer.camera)),t.showAllMesh()}}}dispose(){var e=this;e.viewer=null,e.scene=null,e.refleRefraManager=null}},function(){class e extends THREE.Mesh{constructor(t,i={}){super(t),this.isReflector=!0,this.type="Reflector",this.camera=new THREE.PerspectiveCamera;const r=this,a=void 0!==i.color?new THREE.Color(i.color):new THREE.Color(8355711),n=i.textureWidth||512,s=i.textureHeight||512,o=i.clipBias||0,l=i.shader||e.ReflectorShader,d=void 0!==i.multisample?i.multisample:4,h=new THREE.Plane,c=new THREE.Vector3,u=new THREE.Vector3,p=new THREE.Vector3,m=new THREE.Matrix4,f=new THREE.Vector3(0,0,-1),g=new THREE.Vector4,v=new THREE.Vector3,y=new THREE.Vector3,M=new THREE.Vector4,E=new THREE.Matrix4,b=this.camera,I=new THREE.WebGLRenderTarget(n,s,{samples:d}),x=new THREE.ShaderMaterial({uniforms:THREE.UniformsUtils.clone(l.uniforms),fragmentShader:l.fragmentShader,vertexShader:l.vertexShader});x.uniforms.tDiffuse.value=I.texture,x.uniforms.color.value=a,x.uniforms.textureMatrix.value=E,this.material=x,this.onBeforeRender=function(e,t,i){if(u.setFromMatrixPosition(r.matrixWorld),p.setFromMatrixPosition(i.matrixWorld),m.extractRotation(r.matrixWorld),c.set(0,0,1),c.applyMatrix4(m),v.subVectors(u,p),v.dot(c)>0)return;v.reflect(c).negate(),v.add(u),m.extractRotation(i.matrixWorld),f.set(0,0,-1),f.applyMatrix4(m),f.add(p),y.subVectors(u,f),y.reflect(c).negate(),y.add(u),b.position.copy(v),b.up.set(0,1,0),b.up.applyMatrix4(m),b.up.reflect(c),b.lookAt(y),b.far=i.far,b.updateMatrixWorld(),b.projectionMatrix.copy(i.projectionMatrix),E.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),E.multiply(b.projectionMatrix),E.multiply(b.matrixWorldInverse),E.multiply(r.matrixWorld),h.setFromNormalAndCoplanarPoint(c,u),h.applyMatrix4(b.matrixWorldInverse),g.set(h.normal.x,h.normal.y,h.normal.z,h.constant);const a=b.projectionMatrix;M.x=(Math.sign(g.x)+a.elements[8])/a.elements[0],M.y=(Math.sign(g.y)+a.elements[9])/a.elements[5],M.z=-1,M.w=(1+a.elements[10])/a.elements[14],g.multiplyScalar(2/g.dot(M)),a.elements[2]=g.x,a.elements[6]=g.y,a.elements[10]=g.z+1-o,a.elements[14]=g.w,I.texture.encoding=e.outputEncoding,r.visible=!1;const n=e.getRenderTarget(),s=e.xr.enabled,l=e.shadowMap.autoUpdate;e.xr.enabled=!1,e.shadowMap.autoUpdate=!1,e.setRenderTarget(I),e.state.buffers.depth.setMask(!0),!1===e.autoClear&&e.clear(),e.render(t,b),e.xr.enabled=s,e.shadowMap.autoUpdate=l,e.setRenderTarget(n);const d=i.viewport;void 0!==d&&e.state.viewport(d),r.visible=!0},this.getRenderTarget=function(){return I},this.dispose=function(){I.dispose(),r.material.dispose()}}}e.ReflectorShader={uniforms:{color:{value:null},tDiffuse:{value:null},textureMatrix:{value:null}},vertexShader:"\n\t\tuniform mat4 textureMatrix;\n\t\tvarying vec4 vUv;\n\n\t\t#include <common>\n\t\t#include <logdepthbuf_pars_vertex>\n\n\t\tvoid main() {\n\n\t\t\tvUv = textureMatrix * vec4( position, 1.0 );\n\n\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n\t\t\t#include <logdepthbuf_vertex>\n\n\t\t}",fragmentShader:"\n\t\tuniform vec3 color;\n\t\tuniform sampler2D tDiffuse;\n\t\tvarying vec4 vUv;\n\n\t\t#include <logdepthbuf_pars_fragment>\n\n\t\tfloat blendOverlay( float base, float blend ) {\n\n\t\t\treturn( base < 0.5 ? ( 2.0 * base * blend ) : ( 1.0 - 2.0 * ( 1.0 - base ) * ( 1.0 - blend ) ) );\n\n\t\t}\n\n\t\tvec3 blendOverlay( vec3 base, vec3 blend ) {\n\n\t\t\treturn vec3( blendOverlay( base.r, blend.r ), blendOverlay( base.g, blend.g ), blendOverlay( base.b, blend.b ) );\n\n\t\t}\n\n\t\tvoid main() {\n\n\t\t\t#include <logdepthbuf_fragment>\n\n\t\t\tvec4 base = texture2DProj( tDiffuse, vUv );\n\t\t\tgl_FragColor = vec4( blendOverlay( base.rgb, color ), 1.0 );\n\n\t\t\t#include <encodings_fragment>\n\n\t\t}"},THREE.Reflector=e}(),function(){class e extends THREE.Mesh{constructor(t,i={}){super(t),this.isRefractor=!0,this.type="Refractor",this.camera=new THREE.PerspectiveCamera;const r=this,a=void 0!==i.color?new THREE.Color(i.color):new THREE.Color(8355711),n=i.textureWidth||512,s=i.textureHeight||512,o=i.clipBias||0,l=i.shader||e.RefractorShader,d=void 0!==i.multisample?i.multisample:4,h=this.camera;h.matrixAutoUpdate=!1,h.userData.refractor=!0;const c=new THREE.Plane,u=new THREE.Matrix4,p=new THREE.WebGLRenderTarget(n,s,{samples:d});this.material=new THREE.ShaderMaterial({uniforms:THREE.UniformsUtils.clone(l.uniforms),vertexShader:l.vertexShader,fragmentShader:l.fragmentShader,transparent:!0}),this.material.uniforms.color.value=a,this.material.uniforms.tDiffuse.value=p.texture,this.material.uniforms.textureMatrix.value=u;const m=function(){const e=new THREE.Vector3,t=new THREE.Vector3,i=new THREE.Matrix4,a=new THREE.Vector3,n=new THREE.Vector3;return function(s){return e.setFromMatrixPosition(r.matrixWorld),t.setFromMatrixPosition(s.matrixWorld),a.subVectors(e,t),i.extractRotation(r.matrixWorld),n.set(0,0,1),n.applyMatrix4(i),a.dot(n)<0}}(),f=function(){const e=new THREE.Vector3,t=new THREE.Vector3,i=new THREE.Quaternion,a=new THREE.Vector3;return function(){r.matrixWorld.decompose(t,i,a),e.set(0,0,1).applyQuaternion(i).normalize(),e.negate(),c.setFromNormalAndCoplanarPoint(e,t)}}(),g=function(){const e=new THREE.Plane,t=new THREE.Vector4,i=new THREE.Vector4;return function(r){h.matrixWorld.copy(r.matrixWorld),h.matrixWorldInverse.copy(h.matrixWorld).invert(),h.projectionMatrix.copy(r.projectionMatrix),h.far=r.far,e.copy(c),e.applyMatrix4(h.matrixWorldInverse),t.set(e.normal.x,e.normal.y,e.normal.z,e.constant);const a=h.projectionMatrix;i.x=(Math.sign(t.x)+a.elements[8])/a.elements[0],i.y=(Math.sign(t.y)+a.elements[9])/a.elements[5],i.z=-1,i.w=(1+a.elements[10])/a.elements[14],t.multiplyScalar(2/t.dot(i)),a.elements[2]=t.x,a.elements[6]=t.y,a.elements[10]=t.z+1-o,a.elements[14]=t.w}}();this.onBeforeRender=function(e,t,i){p.texture.encoding=e.outputEncoding,!0!==i.userData.refractor&&!0!=!m(i)&&(f(),function(e){u.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),u.multiply(e.projectionMatrix),u.multiply(e.matrixWorldInverse),u.multiply(r.matrixWorld)}(i),g(i),function(e,t,i){r.visible=!1;const a=e.getRenderTarget(),n=e.xr.enabled,s=e.shadowMap.autoUpdate;e.xr.enabled=!1,e.shadowMap.autoUpdate=!1,e.setRenderTarget(p),!1===e.autoClear&&e.clear(),e.render(t,h),e.xr.enabled=n,e.shadowMap.autoUpdate=s,e.setRenderTarget(a);const o=i.viewport;void 0!==o&&e.state.viewport(o),r.visible=!0}(e,t,i))},this.getRenderTarget=function(){return p},this.dispose=function(){p.dispose(),r.material.dispose()}}}e.RefractorShader={uniforms:{color:{value:null},tDiffuse:{value:null},textureMatrix:{value:null}},vertexShader:"\n\n\t\tuniform mat4 textureMatrix;\n\n\t\tvarying vec4 vUv;\n\n\t\tvoid main() {\n\n\t\t\tvUv = textureMatrix * vec4( position, 1.0 );\n\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n\t\t}",fragmentShader:"\n\n\t\tuniform vec3 color;\n\t\tuniform sampler2D tDiffuse;\n\n\t\tvarying vec4 vUv;\n\n\t\tfloat blendOverlay( float base, float blend ) {\n\n\t\t\treturn( base < 0.5 ? ( 2.0 * base * blend ) : ( 1.0 - 2.0 * ( 1.0 - base ) * ( 1.0 - blend ) ) );\n\n\t\t}\n\n\t\tvec3 blendOverlay( vec3 base, vec3 blend ) {\n\n\t\t\treturn vec3( blendOverlay( base.r, blend.r ), blendOverlay( base.g, blend.g ), blendOverlay( base.b, blend.b ) );\n\n\t\t}\n\n\t\tvoid main() {\n\n\t\t\tvec4 base = texture2DProj( tDiffuse, vUv );\n\t\t\tgl_FragColor = vec4( blendOverlay( base.rgb, color ), 1.0 );\n\n\t\t\t#include <encodings_fragment>\n\n\t\t}"},THREE.Refractor=e}(),function(){class e extends r.Water{constructor(e){super(e),this.isGisMode=!0,this.translateZ(-99e-5)}_updateGeometry(){if(this._cancelAllHidden(),this.meshLen=0,this.featureCount=0,this.isLoadedMeshes=!1,this.isAddUpdate=!1,null==this.boundaryGeometry)for(let e=0;e<this.ids.length;e++){const t=this.ids[e].objectIds;if(null==t)return void console.log("objectIds不能为空.");const i=this.ids[e].modelId,r=this.modelManager.getModel(i);let a=r.transformMatrix;const n=r.getUserIdTileMap(t);r.getUserIdTileMapVisibility(n),this.modelUserIdTileMapVisibility[r.id]||(this.modelUserIdTileMapVisibility[r.id]=n,this.modelUserIdTileMapState[r.id]={});for(const e in n){const t=n[e];let i=!0,a=!1;this.modelUserIdTileMapState[r.id][e]=0;for(const e in t)if(!0===t[e]&&(a=!0),null===t[e]){i=!1;break}!0===i&&!0===a&&(this.modelUserIdTileMapState[r.id][e]=1)}for(let e=0;e<t.length;e++){if(0===this.modelUserIdTileMapState[r.id][t[e]])continue;const n=this.externalObjectConverter.convertToExternalObject(this._getRandomName(),t[e],!1);if(n.children.length<=0)continue;let s=i+"|"+t[e];for(let e=0,t=n.children.length;e<t;e++){let t=(new THREE.Matrix4).copy(a).multiply(n.children[e].matrix);this._addGeometry(n.children[e].geometry,t,s)}}this.featureCount+=t.length,this.viewer.getFilter().addToOverrideListByColor(t,{color:0,opacity:0},i)}else this._addGeometry(this.boundaryGeometry,new THREE.Matrix4)}clear(){super.clear(),this.modelUserIdTileMapVisibility={},this.modelUserIdTileMapState={}}update(){for(let e=0;e<this.ids.length;e++){const t=this.ids[e].objectIds;if(null==t)return void console.log("objectIds不能为空.");const i=this.ids[e].modelId,r=this.modelManager.getModel(i);let a=r.transformMatrix;const n=r.getUserIdTileMap(t);r.getUserIdTileMapVisibility(n);for(const e in n){const t=n[e];let r=!0,s=!1;for(const e in t)if(!0===t[e]&&(s=!0),null===t[e]){r=!1;break}if(!0===r&&!0===s&&0===this.modelUserIdTileMapState[i][e]){this.modelUserIdTileMapState[i][e]=1;const t=this.externalObjectConverter.convertToExternalObject(this._getRandomName(),e,!1);if(t.children.length<=0)continue;let r=i+"|"+e;const n=this.meshLen;for(let e=0,i=t.children.length;e<i;e++){let i=(new THREE.Matrix4).copy(a).multiply(t.children[e].matrix);this._addGeometry(t.children[e].geometry,i,r)}for(let e=n;e<this.meshLen;e++){const t=this.createMesh(this.meshGeometry[e]);this.add(t),t.translateZ(this.meshGeometry[e].initialOffset),this.mesh.push(t)}this.updateMatrixWorld()}}}super.update()}}r.BimtilesWater=e}(),r.PickingEffecter=class{constructor(e){this.viewer=e;var t=1170103;this.wireframeMaterial=new r.MeshBasicClipMaterial({color:t,opacity:1,transparent:!0,blending:THREE.CustomBlending,blendSrc:THREE.OneFactor,blendDst:THREE.ZeroFactor,blendEquation:THREE.AddEquation}),this._enableUpdateScene=!0,this.selectedMaterial=r.MaterialUtil.getDefaultSelectedMaterial(),this.skinningWireframeMaterial=new r.MeshBasicClipMaterial({color:t,opacity:1,transparent:!0,blending:THREE.CustomBlending,blendSrc:THREE.OneFactor,blendDst:THREE.ZeroFactor,blendEquation:THREE.AddEquation,skinning:!0}),this.skinningSelectedMaterial=new r.MeshBasicClipMaterial({color:t,opacity:.3,transparent:!0,skinning:!0}),this.selectedLineMaterial=new THREE.LineMaterial({color:t,opacity:1,transparent:!0,linewidth:2,dashed:!1}),this.instancedWireFrameMaterial=new r.InstancedMeshBasicMaterial({color:t,opacity:1,transparent:!0,blending:THREE.CustomBlending,blendSrc:THREE.OneFactor,blendDst:THREE.ZeroFactor,blendEquation:THREE.AddEquation}),this.instancedSelectedMaterial=new r.InstancedMeshBasicMaterial({color:t,opacity:.3,transparent:!0}),this.selectionScene=new THREE.Scene,this.selectionScene.autoUpdate=!1,this.selectionObjectGroup=new r.ObjectGroup,this.selectionObjectGroup.name="PickingObjectGroup",this.selectionObjectGroup.matrixAutoUpdate=!1,this.selectionScene.add(this.selectionObjectGroup),this.lastSelectedUserIdMap=null,this.lastSelectedUserIds=null,this.selectedMaterialForClip=this.selectedMaterial.clone(),this.wireframeMaterialForClip=this.wireframeMaterial.clone(),this.instancedSelectedMaterialForClip=this.instancedSelectedMaterial.clone(),this.instancedWireFrameMaterialForClip=this.instancedWireFrameMaterial.clone(),this.selectedMaterialId=void 0}destroy(){this.wireframeMaterial.dispose(),this.wireframeMaterial=null,this.wireframeMaterialForClip.dispose(),this.wireframeMaterialForClip=null,this.selectedMaterial.dispose(),this.selectedMaterial=null,this.selectedMaterialForClip.dispose(),this.selectedMaterialForClip=null,this.skinningWireframeMaterial.dispose(),this.skinningWireframeMaterial=null,this.skinningSelectedMaterial.dispose(),this.skinningSelectedMaterial=null,this.selectedLineMaterial.dispose(),this.selectedLineMaterial=null,this.instancedWireFrameMaterial.dispose(),this.instancedWireFrameMaterial=null,this.instancedWireFrameMaterialForClip.dispose(),this.instancedWireFrameMaterialForClip=null,this.instancedSelectedMaterial.dispose(),this.instancedSelectedMaterial=null,this.instancedSelectedMaterialForClip.dispose(),this.instancedSelectedMaterialForClip=null,this.selectionObjectGroup.clear(),this.selectionObjectGroup=null,this.selectionScene=null,this.lastSelectedUserIdMap=null,this.lastSelectedUserIds=null,this.viewer=null}apply(e){var t=this.viewer,i=t.getSelectionWithModelId();if(!i||!i.length)return this._clearSelectedUserIdsCache(),void this._clearMeshesFromScene();(e||this.isSelectionsChanged())&&(this._cacheSelectedUserIds(i),this._updateScene(i)),e&&!1===this._enableUpdateScene&&t.modelManager.traverseModels((e=>{e.getFilter()&&e.getFilter().isVisibleStateChanged()&&(e.applySelection(),this.viewer.modelManager.setRenderStateChanged(!0))})),this._render(t.rendererManager.getRenderer(),t.camera)}isSelectionsChanged(){const e=this.lastSelectedUserIdMap;if(!r.Utils.defined(e))return!0;const t=this.viewer.getSelectionWithModelId();if(t.length!==Object.keys(e).length)return!0;let i=!1;for(var a=t.length-1;a>=0;a--){const n=t[a],s=e[n.selectedId];if(!r.Utils.defined(s)){i=!0;break}if(s.modelId!==n.modelId){i=!0;break}}return!0===i||i}_cacheSelectedUserIds(e){this.lastSelectedUserIdMap={};for(let t=0;t<e.length;++t)this.lastSelectedUserIdMap[e[t].selectedId]=e[t]}_clearSelectedUserIdsCache(){this.lastSelectedUserIdMap=null}_render(e,t){var i=e.autoClearColor,r=e.autoClearDepth,a=e.autoClearStencil;e.autoClearColor=!1,e.autoClearDepth=!0,e.autoClearStencil=!1,e.render(this.selectionScene,t),e.autoClearColor=i,e.autoClearDepth=r,e.autoClearStencil=a}_updateScene(e){this._clearMeshesFromScene(),this._addMeshesToScene(this._getSelectedMeshes(e)),this._updateMatrixWorldForScene(),this._updateSelectedLineMaterial()}_clearMeshesFromScene(){this._enableUpdateScene?this.selectionObjectGroup.clear():this.selectionObjectGroup.children.map((e=>{e.pickTile||this.selectionObjectGroup.remove(e)}))}_addMeshesToScene(e){let t=Object.keys(e);for(const i of t)this.selectionObjectGroup.add(e[i])}_updateMatrixWorldForScene(){this.selectionObjectGroup.matrix.copy(this.viewer.getScene().getMatrixGlobal()),this.selectionObjectGroup.updateMatrixWorld(!0)}enableUpdateScene(e){this._enableUpdateScene=e}_getSelectedMeshes(e){var t={},i=this;return this.viewer.getModelManager().traverseLoadedModels((function(a){const n=[];for(let t=0;t<e.length;++t){const i=e[t];i.modelId===a.databagId&&n.push(i.selectedId)}if(0===n.length)return;if(a.pickingManager)return;const s=r.Utils.arrayToMap(n);a.getPickingMeshes(i,t,n,s)})),t}_updateSelectedLineMaterial(){r.GlobalData.PickingLineWidthEnabled&&this.selectedLineMaterial.resolution.set(this.viewer.domElement.offsetWidth,this.viewer.domElement.offsetHeight)}},r.PickingNodeGenerator=class{constructor(e){this.manager=e,this.pickingNodeMap=null,this.pickingNodeGroup=null,this.nodeGroupName="PickingNodeGroup"}destroy(){this.clearData(),this.pickingNodeGroup=null,this.manager=null}clearData(){this.clearAllFromPickingNodeGroup(),this.clearAllFromPickingNodeMap()}addToPickingNodeMap(e,t){this.pickingNodeMap||(this.pickingNodeMap={}),this.pickingNodeMap[e]=t,this.addToPickingNodeGroup(t)}removeFromPickingNodeMap(e){this.pickingNodeMap&&this.pickingNodeMap[e]&&(this.removeFormPickingNodeGroup(e),this.disposePickingNodeById(e),delete this.pickingNodeMap[e])}addToPickingNodeGroup(e){this.pickingNodeGroup||(this.pickingNodeGroup=new THREE.Group,this.pickingNodeGroup.name=this.nodeGroupName);for(var t=0,i=e.length;t<i;t++)this.pickingNodeGroup.add(e[t])}removeFormPickingNodeGroup(e){if(this.pickingNodeGroup)for(var t=this.pickingNodeMap[e],i=0,r=t.length;i<r;i++)this.pickingNodeGroup.remove(t[i])}disposePickingNodeById(e){for(var t=this.pickingNodeMap[e],i=0,r=t.length;i<r;i++)t[i].material=null,t[i].geometry.dispose(),t[i]=null}clearAllFromPickingNodeMap(){if(this.pickingNodeMap){for(var e=this.pickingNodeMap,t=Object.keys(e),i=0,r=t.length;i<r;i++)this.disposePickingNodeById(t[i]);this.pickingNodeMap=null}}clearAllFromPickingNodeGroup(){this.pickingNodeGroup&&(this.pickingNodeGroup.children.length=0)}isPickingMeshesGenerated(){return!!this.pickingNodeMap}generatePickingMeshes(){}updatePickingMeshesState(e,t,i,r){}resetPickingMeshesState(){}updatePickingMeshes(e,t,i,r){return this.isPickingMeshesGenerated()||(this.generatePickingMeshes(),this.isPickingMeshesGenerated())?(this.resetPickingMeshesState(),this.updatePickingMeshesState(e,t,i,r),this.getPickingNodeGroup()):null}getPickingNodeGroup(){return this.pickingNodeGroup}getMeshesForCap(e,t){}updatePickingMeshesStateForCap(e,t,i){}},function(){class e extends r.PickingNodeGenerator{constructor(e){super(e),this.nodeGroupName="PickingBatchedMeshGroup"}disposePickingNodeById(e){for(var t=this.pickingNodeMap[e],i=0,r=t.length;i<r;i++)t[i]._indicesGroup=null,t[i].material=null,t[i].geometry.dispose(),t[i]=null}generatePickingMeshes(){for(var e=this.manager,t=Object.keys(e.mapMaterialIdToMergedNode),i=0,a=t.length;i<a;i++){for(var n=t[i],s=e.getPropertyValueByMaterialKey(n),o=e.mapMaterialIdToMergedNode[n],l=[],d=0,h=o.length;d<h;d++){var c=o[d],u=c.geometry,p=c.indices,m=new THREE.BufferGeometry;m.setAttribute("position",u.getAttribute("position")),m.setIndex(u.getIndex());var f="lines"===s.type?THREE.LineSegments:THREE.Mesh,g=r.MaterialUtil.DefaultMaterial;if(this.reserveMaterial){g=(g=c.mesh.material)instanceof Array?g[0]:g,u.getAttribute("uv")&&m.setAttribute("uv",u.getAttribute("uv"))}var v=new f(m,[g]);v.name=n,v.frustumCulled=!1,v.renderOrder=r.EnumRenderOrder.Component,v._indicesGroup=p,v.matrix.copy(c.mesh.matrix),v.matrixAutoUpdate=!1,v.updateMatrixWorld(!0),l.push(v)}this.addToPickingNodeMap(n,l)}}getMeshesForCap(e,t){for(var i=this.manager,a=Object.keys(i.mapMaterialIdToMergedNode),n=0,s=a.length;n<s;n++){for(var o=a[n],l=i.getPropertyValueByMaterialKey(o),d=i.mapMaterialIdToMergedNode[o],h=[],c=0,u=d.length;c<u;c++){var p=d[c],m=p.geometry,f=p.indices,g=new THREE.BufferGeometry;g.setAttribute("position",m.getAttribute("position")),g.setIndex(m.getIndex());var v="lines"===l.type?THREE.LineSegments:THREE.Mesh,y=p.mesh.material;if((y=y instanceof Array?y[0]:y).side==THREE.DoubleSide)continue;var M=new v(g,[y]);M.name=o,M.frustumCulled=!1,M.renderOrder=r.EnumRenderOrder.Component,M._indicesGroup=f,M.matrix.copy(p.mesh.matrix),M.matrixAutoUpdate=!1,M.updateMatrixWorld(!0);let i=[],a=[t[y.name]],n=[y.name];for(var E in f){let r=e[E][0].materialId,s=f[E];var b=n.indexOf(r);-1==b&&(n.push(r),a.push(t[r]),b=a.length-1);for(let e=0;e<s.length;e++)i.push({indexStart:s[e].indexStart,indexCount:s[e].indexCount,state:b}),s[e].capMaterialIndex=b}i.sort((function(e,t){return e.indexStart-t.indexStart}));for(let e=0,t=i.length;e<t;e++){var I=i[e].indexStart,x=i[e].indexCount,T=i[e].state;if(0===e)g.addGroup(I,x,T);else{var _=i[e-1].indexStart,S=i[e-1].indexCount;T===i[e-1].state&&I===_+S?g.groups[g.groups.length-1].count+=x:g.addGroup(I,x,T)}}M.material=a,h.push(M)}this.addToPickingNodeMap(o,h)}return this.getPickingNodeGroup()}updatePickingMeshesStateForCap(e,t,i){this.isPickingMeshesGenerated()||this.getMeshesForCap(t,i);for(var r,a,n,s,o=this.manager.manager,l=this.pickingNodeMap,d=Object.keys(l),h=e.getFilter(),c=0,u=d.length;c<u;c++)for(var p=l[d[c]],m=0,f=p.length;m<f;m++){let e=p[m];var g=e._indicesGroup;let t=Object.keys(g),i=g;var v=[];for(n=0,s=t.length;n<s;n++){var y=t[n];if(o.isPickableNode(y)&&i[y]){var M=g[y];if(M&&M.length>0){if(h.isHidden(y))continue;for(r=0,a=M.length;r<a;r++)v.push({indexStart:M[r].indexStart,indexCount:M[r].indexCount,state:M[r].capMaterialIndex})}}}e.visible=!0;var E=e.geometry;if(E.clearGroups(),0!==v.length)for(v.sort((function(e,t){return e.indexStart-t.indexStart})),r=0,a=v.length;r<a;r++){var b=v[r].indexStart,I=v[r].indexCount,x=v[r].state;if(0===r)E.addGroup(b,I,x);else{var T=v[r-1].indexStart,_=v[r-1].indexCount;x===v[r-1].state&&b===T+_?E.groups[E.groups.length-1].count+=I:E.addGroup(b,I,x)}}else e.visible=!1}return this.getPickingNodeGroup()}_rebuildGeometryGroup(e,t,i,a,n){var s,o,l,d,h,c,u=this.manager.manager,p=e._indicesGroup,m=Object.keys(p);m.length<t.length?(h=m,c=i):(h=t,c=p);var f=null,g=a.getFilter();g&&(f=g.getLocalClippingList());var v=[],y=[];let M={},E=r.Model.EnumFilterState.OVERRIDED;for(l=0,d=h.length;l<d;l++){var b=h[l];if(!u.isPickableNode(b)||!c[b])continue;const e=g._getOverrideMaterialById(b);var I=p[b];if(I&&I.length>0){if(f&&f[b]){var x="localClipping|"+b;y.push(x);var T=y.length-1;for(s=0,o=I.length;s<o;s++)v.push({indexStart:I[s].indexStart,indexCount:I[s].indexCount,state:1+T});continue}for(s=0,o=I.length;s<o;s++){let t=0;e&&!n.selectedMaterial&&(void 0===M[e.name]?(t=E,E++,M[e.name]={material:e,state:t}):t=M[e.name].state),v.push({indexStart:I[s].indexStart,indexCount:I[s].indexCount,state:t})}}}e.visible=!0;var _=e.geometry;if(_.clearGroups(),0===v.length)return void(e.visible=!1);for(v.sort((function(e,t){return e.indexStart-t.indexStart})),s=0,o=v.length;s<o;s++){var S=v[s].indexStart,C=v[s].indexCount,w=v[s].state;if(0===s)_.addGroup(S,C,w);else{var R=v[s-1].indexStart,B=v[s-1].indexCount;w===v[s-1].state&&S===R+B?_.groups[_.groups.length-1].count+=C:_.addGroup(S,C,w)}}var L=[n.selectedMaterial||e.material[0]];for(s=0,o=y.length;s<o;s++){var O;"localClipping"==y[s].split("|")[0]&&(O=n.selectedMaterialForClip),L.push(O)}for(const e in M){const t=M[e];L[t.state]=t.material}e.material=L}updatePickingMeshesState(e,t,i,r){for(var a=this.pickingNodeMap,n=Object.keys(a),s=0,o=n.length;s<o;s++){let o=!0;this.manager.getPropertyValueByMaterialKey(n[s]).materialId!=e.selectedMaterialId&&null!=e.selectedMaterialId&&(o=!1);for(var l=a[n[s]],d=0,h=l.length;d<h;d++)l[d].visible=!1,o&&this._rebuildGeometryGroup(l[d],t,i,r,e)}}}r.PickingBatchedMeshGenerator=e}(),function(){class e extends r.PickingNodeGenerator{constructor(e){super(e),this.nodeGroupName="PickingBatchedWireFrameGroup"}disposePickingNodeById(e){for(var t=this.pickingNodeMap[e],i=0,r=t.length;i<r;i++)t[i]._indicesGroup=null,t[i].material=null,t[i].geometry.dispose(),t[i]=null}generatePickingMeshes(){var e=this.manager.getWireFrameLineSegments();if(e)for(var t=0,i=e.length;t<i;t++){var a=e[t].geometry,n=new THREE.BufferGeometry;n.setAttribute("position",a.getAttribute("position")),n.setIndex(a.getIndex());var s=new THREE.LineSegments(n,r.MaterialUtil.DefaultMaterial);s._indicesGroup=e[t]._indicesGroup,s.frustumCulled=!1,s.renderOrder=r.EnumRenderOrder.WireFrame,s.matrix.copy(e[t].matrix),s.matrixAutoUpdate=!1,s.updateMatrixWorld(!0),this.addToPickingNodeMap(t,[s])}}_rebuildGeometryGroup(e,t,i,r,a){var n,s,o,l,d,h,c=this.manager.manager,u=e._indicesGroup,p=Object.keys(u);p.length<t.length?(d=p,h=i):(d=t,h=u);var m=null,f=r.getFilter();f&&(m=f.getLocalClippingList());var g=[],v=[];for(o=0,l=d.length;o<l;o++){var y=d[o];if(c.isPickableNode(y)&&h[y]){var M=u[y];if(M&&M.length>0){if(m&&m[y]){var E="localClipping|"+y;v.push(E);var b=v.length-1;for(n=0,s=M.length;n<s;n++)g.push({indexStart:M[n].indexStart,indexCount:M[n].indexCount,state:1+b});continue}for(n=0,s=M.length;n<s;n++)M[n].materialId!=a.selectedMaterialId&&null!=a.selectedMaterialId||g.push({indexStart:M[n].indexStart,indexCount:M[n].indexCount,state:0})}}}e.visible=!0;var I=e.geometry;if(I.clearGroups(),0!==g.length){for(g.sort((function(e,t){return e.indexStart-t.indexStart})),n=0,s=g.length;n<s;n++){var x=g[n].indexStart,T=g[n].indexCount,_=g[n].state;if(0===n)I.addGroup(x,T,_);else{var S=g[n-1].indexStart,C=g[n-1].indexCount;_===g[n-1].state&&x===S+C?I.groups[I.groups.length-1].count+=T:I.addGroup(x,T,_)}}var w=[a.wireframeMaterial];for(n=0,s=v.length;n<s;n++){var R;"localClipping"==v[n].split("|")[0]&&(R=a.wireframeMaterialForClip),w.push(R)}e.material=w}else e.visible=!1}updatePickingMeshesState(e,t,i,r){for(var a=this.pickingNodeMap,n=Object.keys(a),s=0,o=n.length;s<o;s++)for(var l=a[n[s]],d=0,h=l.length;d<h;d++)l[d].visible=!1,this._rebuildGeometryGroup(l[d],t,i,r,e)}}r.PickingBatchedWireFrameGenerator=e}(),function(){class e extends r.PickingNodeGenerator{constructor(e){super(e),this.nodeGroupName="PickingMeshGroup"}disposePickingNodeById(e){for(var t=Object.keys(this.pickingNodeMap[e]),i=0,r=t.length;i<r;i++)for(var a=this.pickingNodeMap[e][t[i]],n=0,s=a.length;n<s;n++)a[n].material=null,a[n].geometry.dispose(),a[n]=null}removeFormPickingNodeGroup(e){if(this.pickingNodeGroup)for(var t=Object.keys(this.pickingNodeMap[e]),i=0,r=t.length;i<r;i++)for(var a=0,n=this.pickingNodeMap[e][t[i]].length;a<n;a++)this.pickingNodeGroup.remove(nodes[a])}addToPickingNodeMap(e,t,i){this.pickingNodeMap||(this.pickingNodeMap={}),this.pickingNodeMap[e]||(this.pickingNodeMap[e]={}),this.pickingNodeMap[e][t]=i,this.addToPickingNodeGroup(i)}generatePickingMeshes(e){var t=this;this.manager.traverseActiveMeshMap(e,(function(e,i,a){if(!t._isExistNode(e,i)){for(var n=[],s=0,o=a.length;s<o;s++){var l=a[s],d=new THREE.BufferGeometry;d.setAttribute("position",l.geometry.getAttribute("position")),d.setIndex(l.geometry.getIndex()),d._withDrawRange&&d.setDrawRange(l.geometry.drawRange.start,l.geometry.drawRange.count);var h=new(l.isLineSegments?THREE.LineSegments:THREE.Mesh)(d,r.MaterialUtil.DefaultMaterial);r.GeomUtil.copyMeshProperties(h,l),h.renderOrder=r.EnumRenderOrder.WireFrame,n.push(h)}t.addToPickingNodeMap(e,i,n)}}))}_isExistNode(e,t){return!!(this.pickingNodeMap&&this.pickingNodeMap[e]&&this.pickingNodeMap[e][t])}updatePickingMeshesState(e,t,i){if(this.pickingNodeMap)for(var r=e.selectedMaterial,a=this.pickingNodeMap,n=this.manager,s=0,o=t.length;s<o;s++){var l=t[s];if(a[l]&&n.isPickableNode(l)){var d=n.getActiveMeshMapById(l);if(d)for(var h=Object.keys(a[l]),c=0,u=h.length;c<u;c++){var p=h[c];if(d[p]){var m=a[l][p];if(m)for(var f=0,g=m.length;f<g;f++)m[f].material=r,m[f].visible=!0}}}}}resetPickingMeshesState(){if(this.pickingNodeMap)for(var e=this.pickingNodeMap,t=Object.keys(e),i=0,r=t.length;i<r;i++)for(var a=t[i],n=Object.keys(e[a]),s=0,o=n.length;s<o;s++)for(var l=e[a][n[s]],d=0,h=l.length;d<h;d++)l[d].visible=!1}updatePickingMeshes(e,t,i){return this.generatePickingMeshes(t),this.resetPickingMeshesState(),this.updatePickingMeshesState(e,t,i),this.getPickingNodeGroup()}}r.PickingMeshGenerator=e}(),function(){class e extends r.PickingNodeGenerator{constructor(e){super(e),this.nodeGroupName="PickingWireFrameGroup"}disposePickingNodeById(e){for(var t=Object.keys(this.pickingNodeMap[e]),i=0,r=t.length;i<r;i++)for(var a=this.pickingNodeMap[e][t[i]],n=0,s=a.length;n<s;n++)a[n].material=null,a[n].geometry.dispose(),a[n]=null}addToPickingNodeMap(e,t,i){this.pickingNodeMap||(this.pickingNodeMap={}),this.pickingNodeMap[e]||(this.pickingNodeMap[e]={}),this.pickingNodeMap[e][t]=i,this.addToPickingNodeGroup(i)}removeFormPickingNodeGroup(e){if(this.pickingNodeGroup)for(var t=Object.keys(this.pickingNodeMap[e]),i=0,r=t.length;i<r;i++)for(var a=0,n=this.pickingNodeMap[e][t[i]].length;a<n;a++)this.pickingNodeGroup.remove(nodes[a])}generatePickingMeshes(e){var t=this,i=this.manager;this.manager.manager.getMeshManager().traverseActiveMeshMap(e,(function(e,a,n){if(!(n&&n.length&&n[0].isLineSegments||t._isExistNode(e,a))){var s,o,l=n[0].geometryId,d=[];for(s=0,o=n.length;s<o;s++)d.push(n[s].geometry);var h=i._getWireframeGeometryById(l,d),c=[];for(s=0,o=h.length;s<o;s++){var u=new THREE.LineSegments(h[s],r.MaterialUtil.DefaultMaterial);r.GeomUtil.copyMeshProperties(u,n[s]),u.renderOrder=r.EnumRenderOrder.Component,c.push(u)}t.addToPickingNodeMap(e,a,c)}}))}_isExistNode(e,t){return!!(this.pickingNodeMap&&this.pickingNodeMap[e]&&this.pickingNodeMap[e][t])}updatePickingMeshesState(e,t,i){if(this.pickingNodeMap)for(var r=e.selectedMaterial,a=this.pickingNodeMap,n=this.manager.manager.getMeshManager(),s=0,o=t.length;s<o;s++){var l=t[s];if(a[l]&&n.isPickableNode(l)){var d=n.getActiveMeshMapById(l);if(d)for(var h=Object.keys(a[l]),c=0,u=h.length;c<u;c++){var p=h[c];if(d[p]){var m=a[l][p];if(m)for(var f=0,g=m.length;f<g;f++)m[f].material=r,m[f].visible=!0}}}}}resetPickingMeshesState(){if(this.pickingNodeMap)for(var e=this.pickingNodeMap,t=Object.keys(e),i=0,r=t.length;i<r;i++)for(var a=t[i],n=Object.keys(e[a]),s=0,o=n.length;s<o;s++)for(var l=e[a][n[s]],d=0,h=l.length;d<h;d++)l[d].visible=!1}updatePickingMeshes(e,t,i){return this.generatePickingMeshes(t),this.resetPickingMeshesState(),this.updatePickingMeshesState(e,t,i),this.getPickingNodeGroup()}}r.PickingWireFrameGenerator=e}(),function(){class e extends r.PickingNodeGenerator{constructor(e){super(e),this.nodeGroupName="PickingInstancedMeshGroup"}generatePickingMeshes(){var e=this,t=this.manager,i=t.cachedInstance,a=!r.GlobalData.BatchMergeEnabled;t.traverseInstanceNodeMap(null,(function(t,n){for(var s=[],o=n[0],l=0,d=o.length;l<d;l++){var h=o[l].geometry,c=new THREE.InstancedBufferGeometry;c.setAttribute("position",h.getAttribute("position")),c.setAttribute("mcol0",h.getAttribute("mcol0")),c.setAttribute("mcol1",h.getAttribute("mcol1")),c.setAttribute("mcol2",h.getAttribute("mcol2")),c.setAttribute("mcol3",h.getAttribute("mcol3")),c.setAttribute("vState",new THREE.InstancedBufferAttribute(new Float32Array(i.vState[t]),1,!1,1)),c.setIndex(h.getIndex());var u=r.MaterialUtil.DefaultMaterial;e.reserveMaterial&&(u=o[l].material,c.setAttribute("muvCol0",h.getAttribute("muvCol0")),c.setAttribute("muvCol1",h.getAttribute("muvCol1")),c.setAttribute("muvCol2",h.getAttribute("muvCol2")));var p=new THREE.Mesh(c,u);p.name=t,p.frustumCulled=!1,p.matrix.copy(o[l].matrix),p.matrixAutoUpdate=!1,p.updateMatrixWorld(!0),p.renderOrder=a?r.EnumRenderOrder.AfterComponent:r.EnumRenderOrder.Component,s.push(p)}e.addToPickingNodeMap(t,s)}))}getMeshesForCap(e,t){var i=this,a=this.manager,n=a.cachedInstance,s=!r.GlobalData.BatchMergeEnabled;return a.traverseInstanceNodeMap(null,(function(e,a){for(var o=[],l=a[0],d=0,h=l.length;d<h;d++){var c=l[d].geometry,u=new THREE.InstancedBufferGeometry;u.setAttribute("position",c.getAttribute("position")),u.setAttribute("mcol0",c.getAttribute("mcol0")),u.setAttribute("mcol1",c.getAttribute("mcol1")),u.setAttribute("mcol2",c.getAttribute("mcol2")),u.setAttribute("mcol3",c.getAttribute("mcol3")),u.setAttribute("vState",new THREE.InstancedBufferAttribute(new Float32Array(n.vState[e]),1,!1,1)),u.setAttribute("aColor",c.getAttribute("aColor")),u.setIndex(c.getIndex());var p=t[l[d].material.name],m=new THREE.Mesh(u,p);m.name=e,m.frustumCulled=!1,m.matrix.copy(l[d].matrix),m.matrixAutoUpdate=!1,m.updateMatrixWorld(!0),m.renderOrder=s?r.EnumRenderOrder.AfterComponent:r.EnumRenderOrder.Component,o.push(m)}i.addToPickingNodeMap(e,o)})),this.getPickingNodeGroup()}updatePickingMeshesStateForCap(e,t,i){this.isPickingMeshesGenerated()||this.getMeshesForCap(t,i);for(var a=this.pickingNodeMap,n=0,s=(m=Object.keys(a)).length;n<s;n++)for(var o=0,l=(f=a[m[n]]).length;o<l;o++)f[o].visible=!0,f[o].geometry.getAttribute("vState").array.fill(r.EnumInstanceState.NONE),f[o].geometry.getAttribute("vState").needsUpdate=!0;var d=this.manager.manager;let h=e.filter,c=e.getModelDescriptor().getInstancedUserIds();for(n=0,s=c.length;n<s;n++){var u=c[n];if(h.isHidden(u)){var p=d.getMeshManager().getNodeIdxMapByUserId(u);if(p){var m;for(o=0,l=(m=Object.keys(p)).length;o<l;o++){var f,g=m[o];if(f=a[g])for(var v=p[g],y=0,M=f.length;y<M;y++){var E=f[y];E.visible=!0;for(var b=E.geometry,I=b.getAttribute("vState").array,x=0,T=v.length;x<T;x++)I[v[x]]=r.EnumInstanceState.HIDDEN;b.getAttribute("vState").needsUpdate=!0}}}}}return this.getPickingNodeGroup()}updatePickingMeshesState(e,t,i,a){if(this.pickingNodeMap){var n=this.manager.manager,s=this.pickingNodeMap,o=a.getFilter(),l=null;o&&(l=o.getLocalClippingList());for(var d=0,h=t.length;d<h;d++){var c=t[d];if(!n.isPickableNode(c))continue;var u=n.getMeshManager().getNodeIdxMapByUserId(c);if(!u)continue;let i=(e,t)=>{const i=[];for(let r=0;r<t;++r){const t=null!=e.opacity?e.opacity:1;i.push(e.r,e.g,e.b,t)}return new THREE.InstancedBufferAttribute(new Float32Array(i),4,!1,1)};const a=o._getOverrideMaterialById(c);for(var p=Object.keys(u),m=0,f=p.length;m<f;m++){var g=p[m];if(g.split("&")[0]==e.selectedMaterialId||null==e.selectedMaterialId){var v=s[g];if(v)for(var y=u[g],M=0,E=v.length;M<E;M++){var b=v[M];l&&l[c]?b.material=e.instancedSelectedMaterialForClip:e.instancedSelectedMaterial&&(b.material=e.instancedSelectedMaterial),b.visible=!0;var I=b.geometry,x=I.getAttribute("vState").array;if(a&&!e.instancedSelectedMaterial&&!I.getAttribute("aColor")){const e=i(b.material.color,x.length);I.setAttribute("aColor",e)}for(var T=0,_=y.length;T<_;T++)if(x[y[T]]=r.EnumInstanceState.NONE,a&&!e.instancedSelectedMaterial){const e=I.getAttribute("aColor").array;e[4*y[T]]=a.color.r,e[4*y[T]+1]=a.color.g,e[4*y[T]+2]=a.color.b,e[4*y[T]+3]=a.opacity,x[y[T]]=r.EnumInstanceState.OVERRIDED}I.getAttribute("vState").needsUpdate=!0}}}}}}resetPickingMeshesState(){if(this.pickingNodeMap)for(var e=this.pickingNodeMap,t=Object.keys(e),i=0,a=t.length;i<a;i++)for(var n=e[t[i]],s=0,o=n.length;s<o;s++)n[s].visible=!1,n[s].geometry.getAttribute("vState").array.fill(r.EnumInstanceState.HIDDEN),n[s].geometry.getAttribute("vState").needsUpdate=!0}}r.PickingInstancedMeshGenerator=e}(),function(){class e extends r.PickingNodeGenerator{constructor(e){super(e),this.nodeGroupName="PickingInstancedWireFrameGroup"}generatePickingMeshes(){var e=this,t=this.manager,i=t.manager.getCachedInstanceData(),a=!r.GlobalData.BatchMergeEnabled;t._traverseWireframeGeometryMap((function(t,n){for(var s=[],o=0,l=n.length;o<l;o++){var d=n[o],h=new THREE.InstancedBufferGeometry;h.setAttribute("position",d.getAttribute("position")),h.setAttribute("mcol0",d.getAttribute("mcol0")),h.setAttribute("mcol1",d.getAttribute("mcol1")),h.setAttribute("mcol2",d.getAttribute("mcol2")),h.setAttribute("mcol3",d.getAttribute("mcol3")),h.setAttribute("vState",new THREE.InstancedBufferAttribute(new Float32Array(i.vState[t]),1,!1,1)),h.setIndex(d.getIndex());var c=new THREE.LineSegments(h,r.MaterialUtil.DefaultMaterial);c.name=t,c.frustumCulled=!1,d.getAttribute("mcol3").originMatrix&&(c.matrix.copy(d.getAttribute("mcol3").originMatrix),c.matrixAutoUpdate=!1,c.updateMatrixWorld(!0)),c.renderOrder=a?r.EnumRenderOrder.Component:r.EnumRenderOrder.WireFrame,s.push(c)}e.addToPickingNodeMap(t,s)}))}updatePickingMeshesState(e,t,i,a){if(this.pickingNodeMap){var n=this.manager.manager,s=this.pickingNodeMap,o=a.getFilter(),l=null;o&&(l=o.getLocalClippingList());for(var d=0,h=t.length;d<h;d++){var c=t[d];if(n.isPickableNode(c)){var u=n.getMeshManager().getNodeIdxMapByUserId(c);if(u)for(var p=Object.keys(u),m=0,f=p.length;m<f;m++){var g=p[m],v=s[g];if((g.split("&")[0]==e.selectedMaterialId||null==e.selectedMaterialId)&&v)for(var y=u[g],M=0,E=v.length;M<E;M++){var b=v[M];l&&l[c]?b.material=e.instancedWireFrameMaterialForClip:b.material=e.instancedWireFrameMaterial,b.visible=!0;for(var I=b.geometry,x=I.getAttribute("vState").array,T=0,_=y.length;T<_;T++)x[y[T]]=r.EnumInstanceState.NONE;I.getAttribute("vState").needsUpdate=!0}}}}}}resetPickingMeshesState(){if(this.pickingNodeMap)for(var e=this.pickingNodeMap,t=Object.keys(e),i=0,a=t.length;i<a;i++)for(var n=e[t[i]],s=0,o=n.length;s<o;s++)n[s].visible=!1,n[s].geometry.getAttribute("vState").array.fill(r.EnumInstanceState.HIDDEN),n[s].geometry.getAttribute("vState").needsUpdate=!0}}r.PickingInstancedWireFrameGenerator=e}(),function(){class e extends r.PickingNodeGenerator{constructor(e){super(e),this.nodeGroupName="PickingIncrementInstancedMeshGroup"}_isExistNode(e){return!(!this.pickingNodeMap||!this.pickingNodeMap[e])}generatePickingMeshes(){var e=this,t=this.manager,i=t.getCachedInstanceData(),a=!r.GlobalData.BatchMergeEnabled;t.traverseActiveMeshMap(null,(function(t,n){if(!e._isExistNode(t)){for(var s=[],o=0,l=n.length;o<l;o++){var d=n[o].geometry,h=new THREE.InstancedBufferGeometry;h.setAttribute("position",d.getAttribute("position")),h.setAttribute("mcol0",d.getAttribute("mcol0")),h.setAttribute("mcol1",d.getAttribute("mcol1")),h.setAttribute("mcol2",d.getAttribute("mcol2")),h.setAttribute("mcol3",d.getAttribute("mcol3")),h.setAttribute("vState",new THREE.InstancedBufferAttribute(new Float32Array(i.vState[t]),1,!1,1)),h.setIndex(d.getIndex());var c=new THREE.Mesh(h,r.MaterialUtil.DefaultMaterial);c.name=t,c.frustumCulled=!1,c.renderOrder=a?r.EnumRenderOrder.AfterComponent:r.EnumRenderOrder.Component,s.push(c)}e.addToPickingNodeMap(t,s)}}))}updatePickingMeshesState(e,t,i){if(this.pickingNodeMap)for(var a=e.selectedMaterial,n=this.manager.manager,s=this.pickingNodeMap,o=0,l=t.length;o<l;o++){var d=t[o];if(n.isPickableNode(d)){var h=n.getMeshManager().getNodeIdxMapByUserId(d);if(h){var c=Object.keys(h);n.getMeshManager().traverseActiveMeshMap(c,(function(e,t){if(s[e])for(var i=h[e],n=s[e],o=0,l=n.length;o<l;o++){var d=n[o];d.material=a,d.visible=!0;for(var c=d.geometry,u=c.getAttribute("vState").array,p=0,m=i.length;p<m;p++)u[i[p]]=r.EnumInstanceState.NONE;c.getAttribute("vState").needsUpdate=!0}}))}}}}resetPickingMeshesState(){if(this.pickingNodeMap)for(var e=this.pickingNodeMap,t=Object.keys(e),i=0,a=t.length;i<a;i++)for(var n=e[t[i]],s=0,o=n.length;s<o;s++)n[s].visible=!1,n[s].geometry.getAttribute("vState").array.fill(r.EnumInstanceState.HIDDEN),n[s].geometry.getAttribute("vState").needsUpdate=!0}updatePickingMeshes(e,t,i){return this.generatePickingMeshes(),this.resetPickingMeshesState(),this.updatePickingMeshesState(e,t,i),this.getPickingNodeGroup()}}r.PickingIncrementInstancedMeshGenerator=e}(),function(){class e extends r.PickingNodeGenerator{constructor(e){super(e),this.nodeGroupName="PickingIncrementInstancedWireFrameGroup"}_isExistNode(e){return!(!this.pickingNodeMap||!this.pickingNodeMap[e])}generatePickingMeshes(){var e=this,t=this.manager.manager,i=t.getMeshManager(),a=t.getWireFrameManager(),n=i.getCachedInstanceData(),s=!r.GlobalData.BatchMergeEnabled;i.traverseActiveMeshMap(null,(function(t,i){if(!e._isExistNode(t)){var o=[];a._createGeometryById(t),a._traverseWireframeGeometryMapById(t,(function(e,t){var i=new THREE.InstancedBufferGeometry;i.setAttribute("position",e.getAttribute("position")),i.setAttribute("mcol0",e.getAttribute("mcol0")),i.setAttribute("mcol1",e.getAttribute("mcol1")),i.setAttribute("mcol2",e.getAttribute("mcol2")),i.setAttribute("mcol3",e.getAttribute("mcol3")),i.setAttribute("vState",new THREE.InstancedBufferAttribute(new Float32Array(n.vState[t]),1,!1,1)),i.setIndex(e.getIndex());var a=new THREE.Mesh(i,r.MaterialUtil.DefaultMaterial);a.name=t,a.frustumCulled=!1,a.renderOrder=s?r.EnumRenderOrder.AfterComponent:r.EnumRenderOrder.Component,o.push(a)})),e.addToPickingNodeMap(t,o)}}))}updatePickingMeshesState(e,t,i){if(this.pickingNodeMap)for(var a=e.selectedMaterial,n=this.manager.manager,s=this.pickingNodeMap,o=0,l=t.length;o<l;o++){var d=t[o];if(n.isPickableNode(d)){var h=n.getMeshManager().getNodeIdxMapByUserId(d);if(h){var c=Object.keys(h);n.getMeshManager().traverseActiveMeshMap(c,(function(e,t){if(s[e])for(var i=h[e],n=s[e],o=0,l=n.length;o<l;o++){var d=n[o];d.material=a,d.visible=!0;for(var c=d.geometry,u=c.getAttribute("vState").array,p=0,m=i.length;p<m;p++)u[i[p]]=r.EnumInstanceState.NONE;c.getAttribute("vState").needsUpdate=!0}}))}}}}resetPickingMeshesState(){if(this.pickingNodeMap)for(var e=this.pickingNodeMap,t=Object.keys(e),i=0,a=t.length;i<a;i++)for(var n=e[t[i]],s=0,o=n.length;s<o;s++)n[s].visible=!1,n[s].geometry.getAttribute("vState").array.fill(r.EnumInstanceState.HIDDEN),n[s].geometry.getAttribute("vState").needsUpdate=!0}updatePickingMeshes(e,t,i){return this.generatePickingMeshes(),this.resetPickingMeshesState(),this.updatePickingMeshesState(e,t,i),this.getPickingNodeGroup()}}r.PickingIncrementInstancedWireFrameGenerator=e}(),function(){class e extends r.PickingNodeGenerator{constructor(e){super(e),this.nodeGroupName="PickingExternalMeshGroup",this.pickingEffecter=this.manager.getModelManager().viewer.rendererManager.getPickingEffecter()}destroy(){this.pickingEffecter=null,super.destroy()}_disposeGeometryByNode(e){e.traverseVisible((function(t){t!==e&&(t.isMesh||t.isLine)&&(t.material=null,t.geometry.dispose())}))}disposePickingNodeById(e){for(var t=this.pickingNodeMap[e],i=0,r=t.length;i<r;i++)this._disposeGeometryByNode(t[i]),t[i]=null}updatePickingMeshes(e,t,i){if(this.pickingNodeMap){for(var r=Object.keys(this.pickingNodeMap),a=0,n=r.length;a<n;a++){var s,o,l=r[a],d=this.pickingNodeMap[l];if(i[l]&&this.manager.isPickableNode({userId:l,name:l}))for(s=0,o=d.length;s<o;s++)d[s].visible=!0;else for(s=0,o=d.length;s<o;s++)d[s].visible=!1}return this.getPickingNodeGroup()}}addNode(e,t){this.addToPickingNodeMap(e,t)}removeNodeById(e){this.removeFromPickingNodeMap(e)}clearNodes(){this.clearData()}addToPickingNodeMap(e,t){for(var i=[],a=!r.GlobalData.BatchMergeEnabled,n=0,s=t.length;n<s;n++){var o=this._createPickingNodeBy(t[n],a);if(o)if(Array.isArray(o))for(var l=0,d=o.length;l<d;l++)o[l].name=e,i.push(o[l]),t[n]._oriMatrix&&(o[l]._oriMatrix=(new THREE.Matrix4).compose(o[l].position,o[l].quaternion,o[l].scale));else o.name=e,i.push(o),t[n]._oriMatrix&&(o._oriMatrix=(new THREE.Matrix4).compose(o.position,o.quaternion,o.scale))}this.pickingNodeMap||(this.pickingNodeMap={}),this.pickingNodeMap[e]=i,this.addToPickingNodeGroup(i)}_createPickingNodeBy(e,t){var i=this,a={},n={};if("Object3D"===e.type||e instanceof THREE.Group||e instanceof r.ObjectGroup){var s,o,l,d=new THREE.Group;d.copy(e,!1),e.animations&&(d.animations=e.animations),e.traverseVisible((function(s){if(s!==e){var o=null;if("Object3D"===s.type||s instanceof THREE.Group||s instanceof r.ObjectGroup||s instanceof THREE.Bone)(o=s instanceof THREE.Bone?new THREE.Bone:new THREE.Group).copy(s,!1),a[s.uuid]={destination:o,source:s};else{if(!s.isMesh&&!s.isLine)return;(o=i._createPickingMeshesBy(s,t))&&(n[s.uuid]={destination:o,source:s})}o=null}}));var h=Object.keys(a);for(s=0,o=h.length;s<o;s++){var c=a[h[s]];c.source.parent!==e?(l=c.source.parent.uuid,a[l]&&a[l].destination.add(c.destination)):d.add(c.destination)}var u=Object.keys(n);for(s=0,o=u.length;s<o;s++){var p,m,f=n[u[s]];if(f.source.parent===e)if(Array.isArray(f.destination))for(p=0,m=f.destination.length;p<m;p++)d.add(f.destination[p]);else d.add(f.destination);else if(l=f.source.parent.uuid,Array.isArray(f.destination))for(p=0,m=f.destination.length;p<m;p++){(a[l]?a[l].destination:n[l].destination[p]).add(f.destination[p])}else{(a[l]?a[l].destination:n[l].destination).add(f.destination)}}return d}return e.isMesh||e.isLine?i._createPickingMeshesBy(e,t):null}_createLineMeshBy(e,t,i){var a,n,s=this.pickingEffecter;if(r.GlobalData.PickingLineWidthEnabled){a=this.reserveMaterial?e.material:s.selectedLineMaterial;var o=new THREE.LineSegmentsGeometry;e.isLineSegments?o.fromLineSegments(e):e.isLineLoop?o.fromLineLoop(e):o.fromLine(e),n=new THREE.LineSegments2(o,a),r.GeomUtil.copyMeshProperties(n,e),n.renderOrder=i?r.EnumRenderOrder.AfterComponent:r.EnumRenderOrder.Component}else a=s.selectedMaterial,n=e.isLineSegments?new THREE.LineSegments(t,a):e.isLineLoop?new THREE.LineLoop(t,a):new THREE.Line(t,a),r.GeomUtil.copyMeshProperties(n,e),n.renderOrder=i?r.EnumRenderOrder.AfterComponent:r.EnumRenderOrder.Component;return n}_createMeshBy(e,t,i){var a=this.reserveMaterial||e._originMaterial&&e._originMaterial instanceof r.MeshLineMaterial?e._originMaterial:this.pickingEffecter.selectedMaterial,n=new THREE.Mesh(t,a);return r.GeomUtil.copyMeshProperties(n,e),n.renderOrder=i?r.EnumRenderOrder.AfterComponent:r.EnumRenderOrder.Component,n._originMaterial||e._originMaterial||(n._originMaterial=e.material),n}_createSkinnedMeshBy(e,t,i){var a=this.reserveMaterial?e._originMaterial:this.pickingEffecter.skinningSelectedMaterial,n=new(e.isSkinnedMeshEx?THREE.SkinnedMeshEx:THREE.SkinnedMesh)(t,a);return r.GeomUtil.copyMeshProperties(n,e),n.renderOrder=i?r.EnumRenderOrder.AfterComponent:r.EnumRenderOrder.Component,n.bindMatrix.copy(e.bindMatrix),n.bindMatrixInverse.copy(e.bindMatrixInverse),n.bindMode=e.bindMode,n.userData=e.userData,n.skeleton=e.skeleton,n._originMaterial||e._originMaterial||(n._originMaterial=e.material),n}_createSkinnedWireFrameBy(e,t,i){if(!t.index)return null;var a=this.pickingEffecter.skinningWireframeMaterial,n=r.BuildEdge(t.attributes.position.array,t.index.array),s=new THREE.BufferGeometry;s.setIndex(new THREE.Uint32BufferAttribute(n,1)),s.setAttribute("position",t.getAttribute("position")),s.setAttribute("skinIndex",t.getAttribute("skinIndex")),s.setAttribute("skinWeight",t.getAttribute("skinWeight"));var o=new(e.isSkinnedMeshEx?r.SkinnedLineEx:r.SkinnedLine)(s,a);return r.GeomUtil.copyMeshProperties(o,e),o.bindMatrix.copy(e.bindMatrix),o.bindMatrixInverse.copy(e.bindMatrixInverse),o.bindMode=e.bindMode,o.userData=e.userData,o.skeleton=e.skeleton,o.renderOrder=i?r.EnumRenderOrder.Component:r.EnumRenderOrder.AfterComponent,o}_createWireFrameBy(e,t,i){if(!t.index||t.getAttribute("previous"))return null;var a=this.pickingEffecter.wireframeMaterial,n=r.BuildEdge(t.attributes.position.array,t.index.array),s=new THREE.BufferGeometry;s.setIndex(new THREE.Uint32BufferAttribute(n,1)),s.setAttribute("position",t.getAttribute("position"));var o=new THREE.LineSegments(s,a);return r.GeomUtil.copyMeshProperties(o,e),o.renderOrder=i?r.EnumRenderOrder.Component:r.EnumRenderOrder.AfterComponent,o}_createPickingMeshesBy(e,t){var i,a,n=r.GeomUtil.createBufferGeometryWithPosAndSkin(e.geometry,this.reserveMaterial);return n?e.isLineSegments?this._createLineMeshBy(e,n,t):(e.isSkinnedMesh?(i=this._createSkinnedMeshBy(e,n,t),a=this._createSkinnedWireFrameBy(e,n,t)):(i=this._createMeshBy(e,n,t),a=this._createWireFrameBy(e,n,t)),a?[i,a]:i):null}_hasObjectId(e){return!(!this.pickingNodeMap||!this.pickingNodeMap[e])}setAccumulateTransform(e,t,i,r){if(this._hasObjectId(e))for(var a=this.pickingNodeMap[e],n=0,s=a.length;n<s;n++)this.manager.setAccumulateTransformForMesh(a[n],t,i,r)}setTransform(e,t,i,r,a){if(this._hasObjectId(e))for(var n=this.pickingNodeMap[e],s=0,o=n.length;s<o;s++)this.manager.setTransformForMesh(n[s],t,i,r,a)}rotateOnBasePoint(e,t,i,r){if(this._hasObjectId(e))for(var a=this.pickingNodeMap[e],n=0,s=a.length;n<s;n++){let e=a[n],s=e.quaternion.clone().clone().invert(),o=e.position.clone(),l=(new THREE.Quaternion).setFromAxisAngle(i,r);e.quaternion.multiply(l);let d=t.clone().sub(o).applyQuaternion(s).applyQuaternion(e.quaternion);e.position.sub(d).add(t.clone().sub(o)),e.updateMatrixWorld()}}scaleOnBasePoint(e,t,i){if(this._hasObjectId(e))for(var r=this.pickingNodeMap[e],a=0,n=r.length;a<n;a++){let e=r[a];e.scale.multiply(i);let n=i.clone().sub(new THREE.Vector3(1,1,1)),s=e.quaternion.clone(),o=s.clone().invert(),l=e.position.clone(),d=t.clone().sub(l).applyQuaternion(o).multiply(n).applyQuaternion(s);e.position.sub(d),e.updateMatrixWorld()}}applyTransform(e,t,i,r){if(this._hasObjectId(e)){var a=this.manager.getTransformMatrix(t,i,r);this.applyTransformMatrix(e,a)}}applyTransformMatrix(e,t,i){if(this._hasObjectId(e))for(var r=this.pickingNodeMap[e],a=0,n=r.length;a<n;a++)this.manager.updateMatrixWorldForMesh(r[a],t,i)}}r.PickingExternalMeshGenerator=e}(),function(){class e extends r.PickingNodeGenerator{constructor(e){super(e),this.nodeGroupName="PickingSegmentMeshGroup",this.pickingEffecter=this.manager.viewer.rendererManager.getPickingEffecter()}destroy(){this.pickingEffecter=null,super.destroy()}_createPickingMeshBy(e,t){var i=this.pickingEffecter.selectedMaterial,a=e.geometry,n=new THREE.BufferGeometry;n.setAttribute("position",a.getAttribute("position")),n.setIndex(a.getIndex());var s=new(e.isLineSegments?THREE.LineSegments:THREE.Mesh)(n,i);return r.GeomUtil.copyMeshProperties(s,e),s.renderOrder=t?r.EnumRenderOrder.AfterComponent:r.EnumRenderOrder.Component,s}_createPickingWireFrameBy(e,t){if(e.isLineSegments)return null;var i=this.pickingEffecter.wireframeMaterial,a=e.geometry,n=r.BuildEdge(a.attributes.position.array,a.index.array),s=new THREE.BufferGeometry;s.setAttribute("position",a.getAttribute("position")),s.setIndex(new THREE.Uint32BufferAttribute(n,1));var o=new THREE.LineSegments(s,i);return r.GeomUtil.copyMeshProperties(o,e),o.renderOrder=t?r.EnumRenderOrder.Component:r.EnumRenderOrder.AfterComponent,o}disposePickingNodeById(e){for(var t=Object.keys(this.pickingNodeMap[e]),i=0,r=t.length;i<r;i++)for(var a=this.pickingNodeMap[e][t[i]],n=0,s=a.length;n<s;n++)a[n].material=null,a[n].geometry.dispose(),a[n]=null}removeFormPickingNodeGroup(e){if(this.pickingNodeGroup)for(var t=Object.keys(this.pickingNodeMap[e]),i=0,r=t.length;i<r;i++)for(var a=0,n=this.pickingNodeMap[e][t[i]].length;a<n;a++)this.pickingNodeGroup.remove(nodes[a])}addToPickingNodeMap(e,t,i){this.pickingNodeMap||(this.pickingNodeMap={}),this.pickingNodeMap[e]||(this.pickingNodeMap[e]={}),this.pickingNodeMap[e][t]=i,this.addToPickingNodeGroup(i)}generatePickingMeshes(e){var t=this,i=this.manager,a=!r.GlobalData.BatchMergeEnabled;i.traverseMeshNodeMapByUserIds(e,(function(e,i,r){var n=r.userId;if(!t._isExistNode(n,i)){for(var s=[],o=0,l=e.length;o<l;o++){var d=e[o],h=t._createPickingMeshBy(d,a);s.push(h);var c=t._createPickingWireFrameBy(d,a);c&&s.push(c)}t.addToPickingNodeMap(n,i,s)}}))}_isExistNode(e,t){return!!(this.pickingNodeMap&&this.pickingNodeMap[e]&&this.pickingNodeMap[e][t])}updatePickingMeshesState(e,t,i){if(this.pickingNodeMap){e.selectedMaterial;for(var r=this.pickingNodeMap,a=this.manager,n=0,s=t.length;n<s;n++){var o=t[n];if(r[o]){var l=a.getNodeIdsByUserId(o);if(l&&l.length)for(var d=0,h=l.length;d<h;d++){var c=l[d],u=a.getNodeInfoByNodeId(c);if(a.isPickableNode(u)){var p=r[o][c];if(p)for(var m=0,f=p.length;m<f;m++)p[m].visible=!0}}}}}}resetPickingMeshesState(){if(this.pickingNodeMap)for(var e=this.pickingNodeMap,t=Object.keys(e),i=0,r=t.length;i<r;i++)for(var a=t[i],n=Object.keys(e[a]),s=0,o=n.length;s<o;s++)for(var l=e[a][n[s]],d=0,h=l.length;d<h;d++)l[d].visible=!1}updatePickingMeshes(e,t,i){return this.generatePickingMeshes(t),this.resetPickingMeshesState(),this.updatePickingMeshesState(e,t,i),this.getPickingNodeGroup()}}r.PickingSegmentMeshGenerator=e}();var G,V=V||{};V.brdf_vs=["varying vec2 vUV;","void main() {","\tvUV = uv;","\tgl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","}"].join("\n"),V.brdf_fs=["varying vec2 vUV;","uniform sampler2D HammersleyTable;","const float PI = 3.14159265358979;","float GGX(float NdotV, float alpha)","{","\tfloat alpha2 = pow(alpha, 2.0);","\treturn 2.0 * NdotV / (NdotV + sqrt(alpha2 + (1.0 - alpha2) * NdotV * NdotV));","}","float G_Smith(float NdotV, float NdotL, float roughness)","{","\tfloat alpha = pow(roughness, 2.0);","\treturn GGX(NdotV, alpha) * GGX(NdotL, alpha);","}","vec3 ImportanceSampleGGX(vec2 Xi, vec3 N, float roughness)","{","\tfloat a = roughness * roughness;","\tfloat Phi = 2.0 * PI * Xi.x; ","\tfloat CosTheta = sqrt((1.0 - Xi.y) / (1.0 + (a * a - 1.0) * Xi.y)); ","\tfloat SinTheta = sqrt(1.0 - CosTheta * CosTheta);","\tvec3 H;","\tH.x = SinTheta * cos(Phi); ","\tH.y = SinTheta * sin(Phi); ","\tH.z = CosTheta;","\tvec3 UpVector = abs(N.z) < 0.999 ? vec3(0.0, 0.0, 1.0) : vec3(1.0, 0.0, 0.0); ","\tvec3 TangentX = normalize(cross(UpVector, N)); ","\tvec3 TangentY = cross(N, TangentX);","\treturn normalize(TangentX * H.x + TangentY * H.y + N * H.z);","}","vec2 IntegrateBRDF(float NdotV, float roughness)","{","\tvec3 N = vec3(0.0, 0.0, 1.0);","\tvec3 V = vec3(sqrt(1.0 - NdotV * NdotV), 0.0, NdotV);","\tvec2 result = vec2(0.0, 0.0);","\tconst int NumSamples = 1024;","\tfor (int i = 0; i < NumSamples; i++)","\t{","\t\tfloat u = float(i) / float(NumSamples);","\t\tvec2 Xi = vec2(u, texture2D(HammersleyTable, vec2(u)).r);","\t\tvec3 H = ImportanceSampleGGX(Xi, N, roughness);","\t\tvec3 L = 2.0 * dot(V, H) * H - V;","\t\tfloat NdotL = saturate(L.z);","\t\tfloat NdotH = saturate(H.z);","\t\tfloat VdotH = saturate(dot(V, H));","\t\tfloat NdotV = saturate(dot(N, V));","\t\tif (NdotL > 0.0)","\t\t{","\t\t\tfloat G = G_Smith(NdotV, NdotL, roughness);","\t\t\tfloat G_Vis = G * VdotH / (NdotH * NdotV); ","\t\t\tfloat F = pow(1.0 - VdotH, 5.0);","\t\t\tresult.x += (1.0 - F) * G_Vis;","\t\t\tresult.y += F * G_Vis;","\t\t}","\t}","\treturn result / float(NumSamples);","}","void main()","{","\tvec2 brdf = IntegrateBRDF(vUV.x, vUV.y);","\tgl_FragColor = vec4(brdf, 0.0, 1.0);","}"].join("\n"),V.BRDFMap=function(e,t){this.texture=null,this.resolution=t||512,this.brdfMaterial=new THREE.ShaderMaterial({vertexShader:V.brdf_vs,fragmentShader:V.brdf_fs,uniforms:{HammersleyTable:{value:e}},lights:!1}),this.quad=new THREE.Mesh(new THREE.PlaneBufferGeometry(window.innerWidth,window.innerHeight),this.brdfMaterial),this.quad.position.z=-100},V.BRDFMap.prototype.constructor=V.BRDFMap,V.BRDFMap.prototype.generateMap=function(e){var t=new THREE.Scene;t.add(this.quad);var i=new THREE.OrthographicCamera(window.innerWidth/-2,window.innerWidth/2,window.innerHeight/2,window.innerHeight/-2,-1e4,1e4);i.position.z=100;var r=new THREE.WebGLRenderTarget(this.resolution,this.resolution,{minFilter:THREE.LinearFilter,magFilter:THREE.NearestFilter,format:THREE.RGBAFormat});e.render(t,i,r,!0),this.texture=r.texture},function(){class e extends THREE.Loader{constructor(e){super(e),this.hdrLoader=new THREE.RGBELoader,this.type=THREE.HalfFloatType}load(e,t,i,r){Array.isArray(e)||(console.warn("THREE.HDRCubeTextureLoader signature has changed. Use .setDataType() instead."),this.setDataType(e),e=t,t=i,i=r,r=arguments[4]);const a=new THREE.CubeTexture;switch(a.type=this.type,a.type){case THREE.UnsignedByteType:a.encoding=THREE.RGBEEncoding,a.format=THREE.RGBAFormat,a.minFilter=THREE.NearestFilter,a.magFilter=THREE.NearestFilter,a.generateMipmaps=!1;break;case THREE.FloatType:case THREE.HalfFloatType:a.encoding=THREE.LinearEncoding,a.format=THREE.RGBAFormat,a.minFilter=THREE.LinearFilter,a.magFilter=THREE.LinearFilter,a.generateMipmaps=!1}const n=this;let s=0;function o(t,i,r,o){new THREE.FileLoader(n.manager).setPath(n.path).setResponseType("arraybuffer").setWithCredentials(n.withCredentials).load(e[t],(function(e){s++;const r=n.hdrLoader.parse(e);if(r){if(void 0!==r.data){const e=new THREE.DataTexture(r.data,r.width,r.height);e.type=a.type,e.encoding=a.encoding,e.format=a.format,e.minFilter=a.minFilter,e.magFilter=a.magFilter,e.generateMipmaps=a.generateMipmaps,a.images[t]=e}6===s&&(a.needsUpdate=!0,i&&i(a))}}),r,o)}for(let a=0;a<e.length;a++)o(a,t,i,r);return a}setDataType(e){return this.type=e,this.hdrLoader.setDataType(e),this}}THREE.HDRCubeTextureLoader=e}(),V.HDRTextureLoader=function(e){this.manager=void 0!==e?e:THREE.DefaultLoadingManager,this.hdrLoader=new THREE.RGBELoader},V.HDRTextureLoader.prototype.load=function(e,t,i,r){var a=new THREE.DataTexture;return this.hdrLoader.load(e,(function(e,i){e.flipY=!0,e.type=THREE.FloatType,e.format=THREE.RGBAFormat,e.minFilter=THREE.LinearFilter,e.magFilter=THREE.LinearFilter,e.encoding=THREE.LinearEncoding;for(var r=function(e,t,i,r){var a=e[t+3],n=Math.pow(2,a-128)/256;i[r+0]=e[t+0]*n,i[r+1]=e[t+1]*n,i[r+2]=e[t+2]*n,i[r+3]=1},n=e.image.width*e.image.height*4,s=new Float32Array(n),o=0;o<n;o++)r(e.image.data,4*o,s,4*o);e.image.data=s,a=e,t&&t(a)}),i,r),a},V.equirectangular_vs=["varying vec3 pos;","void main() {","\tpos = vec3(modelMatrix * vec4(position, 1.0));","\tgl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","}"].join("\n"),V.equirectangular_fs=["varying vec3 pos;","uniform sampler2D map;","const float PI = 3.14159265358979;","const float INV_PI = 1.0 / PI;","vec2 sampleSphericalMap(vec3 v)","{","\tvec2 uv = vec2(atan(v.z, v.x), asin(v.y));","\tuv *= vec2(INV_PI * 0.5, INV_PI);","\tuv += 0.5;","\treturn uv;","}","void main() {","\tvec2 uv = sampleSphericalMap(normalize(pos));","\tvec4 color = texture2D(map, uv);","\tgl_FragColor = vec4(color.rgb, 1.0);","}"].join("\n"),V.EquirectangularMaterial=function(e){THREE.ShaderMaterial.call(this),this.type="EquirectangularMaterial",this.map=null,this.lights=!1,this.side=THREE.BackSide,this.defines={},this.uniforms=THREE.UniformsUtils.merge([{map:{value:null}}]),this.vertexShader=V.equirectangular_vs,this.fragmentShader=V.equirectangular_fs,this.defaultAttributeValues={color:[1,1,1],uv:[0,0],uv2:[0,0]},void 0!==e&&(void 0!==e.attributes&&console.error("IBLMaterial: attributes should now be defined in THREE.BufferGeometry instead."),this.setValues(e)),this.refreshUniforms()},V.EquirectangularMaterial.prototype=Object.create(THREE.ShaderMaterial.prototype),V.EquirectangularMaterial.prototype.constructor=V.EquirectangularMaterial,V.EquirectangularMaterial.prototype.isShaderMaterial=!0,V.EquirectangularMaterial.prototype.copy=function(e){return THREE.ShaderMaterial.prototype.copy.call(this,e),this.map=e.map,this},V.EquirectangularMaterial.prototype.refreshUniforms=function(){this.uniforms.map.value=this.map},V.HDRToCubeMap=function(e,t,i,r){var a=new THREE.CubeCamera(.1,10,r||512);if(i){var n={type:THREE.FloatType,format:THREE.RGBAFormat,magFilter:THREE.LinearFilter,minFilter:THREE.LinearFilter};a.renderTarget=new THREE.WebGLRenderTargetCube(r||512,r||512,n)}var s=new THREE.Scene,o=new EquirectangularMaterial({map:e}),l=new THREE.Mesh(new THREE.BoxBufferGeometry(2,2,2),o);return s.add(l),a.updateCubeMap(t,s),a.renderTarget.texture},V.IBLMaps=function(e,t,i){this.environmentMap=null,this.irradianceMap=null,this.prefilterMap=null,this.brdfMap=null,e&&this.loadMaps(e,t,void 0,i)},V.IBLMaps.prototype.constructor=V.IBLMaps,V.IBLMaps.prototype.loadMaps=function(e,t,i,r){t?this.loadHDRMaps(e,i,r):this.loadJPGMaps(e,i,r)},V.IBLMaps.prototype.loadHDRMaps=function(e,t,i){for(var r=this,a=["posx.hdr","negx.hdr","posy.hdr","negy.hdr","posz.hdr","negz.hdr"],n=[],s=0;s<6;++s)n.push(e+"/EnvMap_"+a[s]);var o=new THREE.HDRCubeTextureLoader;o.setDataType(THREE.FloatType),o.load(n,(function(t){r.environmentMap=t;for(var n=[],s=0;s<6;++s)n.push(e+"/IrradianceMap_"+a[s]);o.load(n,(function(t){r.irradianceMap=t;for(var n=[],s=0;s<6;++s)n.push(e+"/PrefilterMap_"+a[s]);o.load(n,(function(t){r.prefilterMap=t;var a=new V.HDRTextureLoader,n=e+"/brdf.hdr";a.load(n,(function(e){r.brdfMap=e,i(r,!0)}))}))}))}))},V.IBLMaps.prototype.loadJPGMaps=function(e,t,i){const r=new THREE.CubeTextureLoader;r.setCrossOrigin("anonymous"),r.load(e,(e=>{this.environmentMap=e,i(this,!1)}))},function(){class e extends THREE.MeshStandardMaterial{constructor(e){super(e),this.type="IBLMaterial",this.IBLEnabled=!0,this.debug=0,this.iblFactor=1,this.gamma=2.2,this.color=new THREE.Color(16777215),this.roughness=1,this.metalness=0,this.originRoughness=1,this.originMetalness=0,this._referenceCount=1,this._imageByteSize=0,this.opacity=1,this.aoMap=null,this.IBLMaps=null,this.shift=.5,this.A=.27,this.B=.29,this.C=.052,this.D=.2,this.E=0,this.F=.18,this.scale=.897105;var t=(new THREE.Color).setHex(3330982),i=[t.r,t.g,t.b,1];this.colorState=r.EnumShaderColorState.NONE,this.blinkColor=(new THREE.Vector4).fromArray(i),this.blinkCoefficient=0,this.tintColor=new THREE.Color(16777215),this.receiveIBL=!0,this.viewshedCount=-1,this.viewshedContents=[],this.viewshedDepthMaps=[],this.videoCastCount=-1,this.videoCastContents=[],this.videoCastDepthMaps=[],this.videoCastProjectorMaps=[],this.heightLimitSampler=null,this.heightColorSampler=null,this.heightLimitOrthoMatrix=new THREE.Matrix4,this.heightLimit=0,this.useHeightLimit=!1,this.emissive=new THREE.Color(0,0,0),this.useCompressedNormal=!1,this.useCompressedColor=!1,this.useCSM=r.GlobalData.EnableCSM,this.useAlphaMap=!1,this.useCompressedUv=!1,this.uvCenter=new THREE.Vector2(0,0),this.uvHalfExtent=new THREE.Vector2(0,0),this.useClampToBorder=!1,this.defines={},this.uniforms=THREE.UniformsUtils.merge([THREE.ShaderLib.standard.uniforms,{IBLEnabled:{value:!0},debug:{value:0},iblFactor:{value:1},gamma:{value:2.2},albedo:{value:new THREE.Color(16777215)},aoMap:{value:null},irradianceMap:{value:null},prefilterMap:{value:null},brdfMap:{value:null},shift:{value:.18},A:{value:.27},B:{value:.29},C:{value:.052},D:{value:.2},E:{value:0},F:{value:.18},scale:{value:.897105},colorState:{value:0},blinkColor:{value:(new THREE.Vector4).fromArray(i)},blinkCoefficient:{value:0},tintColor:{value:new THREE.Color(16777215)}},{viewshedCount:{value:-1},viewshedContents:{value:[]},viewshedDepthMaps:{value:[]}},{uvCenter:{value:new THREE.Vector2(0,0)},uvHalfExtent:{value:new THREE.Vector2(0,0)}},{videoCastCount:{value:-1},videoCastContents:{value:[]},videoCastDepthMaps:{value:[]},videoCastProjectorMaps:{value:[]}},{heightLimitSampler:{value:null},heightColorSampler:{value:null},heightLimitOrthoMatrix:{value:new THREE.Matrix4},heightLimit:{value:0},useHeightLimit:{value:!1}},{csmCascades:{value:null}}]),this.lights=!0,this.vertexShader=V.IBLVertexShader,this.fragmentShader=V.IBLFragmentShader,this.defaultAttributeValues={color:[1,1,1],uv:[0,0],uv2:[0,0]},void 0!==e&&(void 0!==e.attributes&&console.error("IBLMaterial: attributes should now be defined in THREE.BufferGeometry instead."),this.setValues(e)),this.useCSM?this.defines.USE_CSM="":delete this.defines.USE_CSM,this.useAlphaMap?this.defines.USE_ALPHAMAP="":delete this.defines.USE_ALPHAMAP}setValues(e){if(void 0!==e)for(var t in e){var i=e[t];if(void 0!==i){var r=this[t];void 0!==r&&(r&&r.isColor?r.set(i):r&&r.isVector3&&i&&i.isVector3?r.copy(i):this[t]="overdraw"===t?Number(i):i)}else console.warn("THREE.Material: '"+t+"' parameter is undefined.")}}copy(e){return THREE.MeshStandardMaterial.prototype.copy.call(this,e),this.IBLEnabled=e.IBLEnabled,this.debug=e.debug,this.gamma=e.gamma,this.color.copy(e.color),this.aoMap=e.aoMap,this.IBLMaps=e.IBLMaps,this.shift=e.shift,this.A=e.A,this.B=e.B,this.C=e.C,this.D=e.D,this.E=e.E,this.F=e.F,this.scale=e.scale,this.colorState=e.colorState,this.blinkColor.copy(e.blinkColor),this.blinkCoefficient=e.blinkCoefficient,this.tintColor.copy(e.tintColor),this.viewshedCount=e.viewshedCount,this.viewshedContents=e.viewshedContents,this.viewshedDepthMaps=e.viewshedDepthMaps,this.videoCastCount=e.videoCastCount,this.videoCastContents=e.videoCastContents,this.videoCastDepthMaps=e.videoCastDepthMaps,this.videoCastProjectorMaps=e.videoCastProjectorMaps,this.useCompressedColor=e.useCompressedColor,this.useCompressedNormal=e.useCompressedNormal,this.useCompressedUv=e.useCompressedUv,this.uvCenter=e.uvCenter,this.uvHalfExtent=e.uvHalfExtent,this.iblFactor=e.iblFactor,this.useCSM=e.useCSM,this.heightLimitSampler=e.heightLimitSampler,this.heightColorSampler=e.heightColorSampler,this.heightLimitOrthoMatrix=e.heightLimitOrthoMatrix,this.heightLimit=e.heightLimit,this.useHeightLimit=e.useHeightLimit,this}refreshUniforms(){this.uniforms.IBLEnabled.value=this.IBLEnabled,this.uniforms.debug.value=this.debug,this.uniforms.gamma.value=this.gamma,this.uniforms.iblFactor.value=this.iblFactor,this.uniforms.albedo.value.set(this.color),this.uniforms.aoMap.value=this.aoMap,this.IBLMaps&&(this.uniforms.irradianceMap.value=this.IBLMaps.irradianceMap,this.uniforms.prefilterMap.value=this.IBLMaps.prefilterMap,this.uniforms.brdfMap.value=this.IBLMaps.brdfMap),this.uniforms.shift.value=this.shift,this.uniforms.A.value=this.A,this.uniforms.B.value=this.B,this.uniforms.C.value=this.C,this.uniforms.D.value=this.D,this.uniforms.E.value=this.E,this.uniforms.F.value=this.F,this.uniforms.scale.value=this.scale,this.uniforms.uvCenter.value=this.uvCenter,this.uniforms.uvHalfExtent.value=this.uvHalfExtent,this.uniforms.viewshedCount.value=this.viewshedCount,this.uniforms.viewshedContents.value=this.viewshedContents,this.uniforms.viewshedDepthMaps.value=this.viewshedDepthMaps,this.uniforms.videoCastCount.value=this.videoCastCount,this.uniforms.videoCastContents.value=this.videoCastContents,this.uniforms.videoCastDepthMaps.value=this.videoCastDepthMaps,this.uniforms.videoCastProjectorMaps.value=this.videoCastProjectorMaps,this.viewshedCount>0?this.defines.VIEW_SHED_MODE="":delete this.defines.VIEW_SHED_MODE,this.videoCastCount>0?this.defines.VIDEO_CAST_MODE="":delete this.defines.VIDEO_CAST_MODE,this.useCSM?this.defines.USE_CSM="":delete this.defines.USE_CSM,this.useCompressedColor?this.defines.CCOLOR="":delete this.defines.CCOLOR,this.useCompressedNormal?this.defines.CNORMAL="":delete this.defines.CNORMAL,this.uniforms.blinkColor.value.copy(this.blinkColor),this.uniforms.tintColor.value.copy(this.tintColor),this.uniforms.blinkCoefficient.value=this.blinkCoefficient,this.uniforms.colorState.value=this.colorState,this.heightLimitSampler?this.defines.HEIGHT_LIMIT_READ="":delete this.defines.HEIGHT_LIMIT_READ,this.uniforms.heightLimitOrthoMatrix.value=this.heightLimitOrthoMatrix,this.uniforms.heightLimitSampler.value=this.heightLimitSampler,this.uniforms.heightColorSampler.value=this.heightColorSampler,this.uniforms.heightLimit.value=this.heightLimit,this.uniforms.useHeightLimit.value=this.useHeightLimit,this.useClampToBorder?this.defines.USE_CLAMP_TO_BORDER="":delete this.defines.USE_CLAMP_TO_BORDER,this.useCompressedUv?this.defines.USE_COMPRESS_UV="":delete this.defines.USE_COMPRESS_UV}setBlinkColor(e){this.blinkColor.fromArray(e.toArray()),this.uniforms.blinkColor.value.copy(this.blinkColor),this.uniforms.blinkCoefficient.value=this.blinkCoefficient,this.uniforms.colorState.value=r.EnumShaderColorState.BLINK}updateBlinkUniformValue(e,t,i){this.uniforms.colorState.value=e,this.uniforms.blinkColor.value.copy(t),this.uniforms.blinkCoefficient.value=i}resetBlinkUniformValue(){this.uniforms.colorState.value=this.colorState,this.uniforms.blinkColor.value.copy(this.blinkColor),this.uniforms.blinkCoefficient.value=this.blinkCoefficient}}V.IBLMaterial=e}(),V.IBLProbe=function(e,t,i,r,a,n,s){this.environmentMap=e,this.hammersleyTable=null,this.irradianceMap=null,this.prefilterMap=null,this.brdfMap=null,this.hammersleyUrl=t,this.irradianceResolution=r||32,this.prefilterResolution=a||128,this.brdfResolution=n||512,this.maxMipLevel=s||1,this.isHDR=!1,this.isComputed=!1,this.onSuccess=i,this.loadHammersleyTable()},V.IBLProbe.prototype.constructor=V.IBLProbe,V.IBLProbe.prototype.loadHammersleyTable=function(){var e=this;(new THREE.TextureLoader).load(this.hammersleyUrl,(function(t){e.hammersleyTable=t,e.initMap(),e.onSuccess&&e.onSuccess()}))},V.IBLProbe.prototype.initMap=function(){this.irradianceMap=new V.IrradianceMap(this.environmentMap,this.irradianceResolution),this.prefilterMap=new V.PrefilterMap(this.environmentMap,this.hammersleyTable,this.prefilterResolution,this.maxMipLevel),this.brdfMap=new V.BRDFMap(this.hammersleyTable,this.brdfResolution)},V.IBLProbe.prototype.setEnvironmentMap=function(e){this.environmentMap=e,this.irradianceMap.irradianceMaterial.uniforms.environmentMap.value=this.environmentMap,this.prefilterMap.prefilterMaterial.uniforms.environmentMap.value=this.environmentMap},V.IBLProbe.prototype.computed=function(e){this.irradianceMap.generateMap(e,this.isHDR),this.prefilterMap.generateMap(e,this.isHDR),this.brdfMap.generateMap(e),this.isComputed=!0},V.IBLVertexShader=["uniform mat3 uvTransform; ","varying vec2 vUv;","varying vec3 Normal;","varying vec3 Pos;","varying vec3 mvPosition;","varying vec3 mvNormal;","varying vec3 vViewPosition;","#include <shadowmap_pars_vertex>","#include <view_shed_pars_vertex>","#include <video_cast_pars_vertex>","#include <common>","#include <logdepthbuf_pars_vertex>","#include <heightLimit_pars_vertex>","#include <uv2_pars_vertex>","#include <CompressNormal_vertex>","#include <CompressColor_vertex>","#include <color_pars_vertex>","#ifdef USE_INSTANCE","   attribute float vState;","   attribute float vState2;","   attribute float vClipping;","   varying float fClipping;","   varying float fState;","   attribute vec4 aColor;","   varying vec4 vaColor;","   attribute vec3 mcol0;","   attribute vec3 mcol1;","   attribute vec3 mcol2;","   attribute vec3 mcol3;","   #if defined(USE_MAP)||defined(USE_BUMPMAP) ","       attribute vec2 muvCol0;","       attribute vec2 muvCol1;","       attribute vec2 muvCol2;","   #endif","   #if defined(USE_LIGHTMAP)","       attribute vec4 uv2OffsetRepeat;","   #endif","#endif","mat3 inverse_mat3(in mat3 m)","{","   float determinant =","    m[0][0] * (m[1][1] * m[2][2] - m[2][1] * m[1][2])","    - m[1][0] * (m[0][1] * m[2][2] - m[2][1] * m[0][2])","    + m[2][0] * (m[0][1] * m[1][2] - m[1][1] * m[0][2]);","    mat3 inverse;","    inverse[0][0] = + (m[1][1] * m[2][2] - m[2][1] * m[1][2]);","    inverse[1][0] = - (m[1][0] * m[2][2] - m[2][0] * m[1][2]);","    inverse[2][0] = + (m[1][0] * m[2][1] - m[2][0] * m[1][1]);","    inverse[0][1] = - (m[0][1] * m[2][2] - m[2][1] * m[0][2]);","    inverse[1][1] = + (m[0][0] * m[2][2] - m[2][0] * m[0][2]);","    inverse[2][1] = - (m[0][0] * m[2][1] - m[2][0] * m[0][1]);","    inverse[0][2] = + (m[0][1] * m[1][2] - m[1][1] * m[0][2]);","    inverse[1][2] = - (m[0][0] * m[1][2] - m[1][0] * m[0][2]);","    inverse[2][2] = + (m[0][0] * m[1][1] - m[1][0] * m[0][1]);","    inverse /= determinant;","    return inverse;","}","#ifdef USE_COMPRESS_UV","   uniform vec2 uvCenter;","   uniform vec2 uvHalfExtent;","   vec2 uvDecode(vec2 myuv) {","       myuv = (myuv + 32768.0)* 2.0 / 65535.0 - 1.0;","       return myuv * uvHalfExtent + uvCenter;","   }","#endif","void main()","{","    vec3 vertexNormal = normal;","    #ifdef CNORMAL","       vertexNormal = octDecode();","    #endif","   #ifdef USE_COMPRESS_UV","       vUv = uvDecode(uv);","       vUv = ( uvTransform * vec3( vUv, 1 ) ).xy;","   #else","       vUv = ( uvTransform * vec3( uv, 1 ) ).xy;","   #endif","    Pos = vec3(modelMatrix * vec4(position, 1.0));","    Normal = normalize(mat3(modelMatrix) * vertexNormal);","    mvPosition = vec3(modelViewMatrix * vec4(position, 1.0));","    mvNormal = normalize(normalMatrix * vertexNormal);","#include <begin_vertex>","#include <beginnormal_vertex>","#include <defaultnormal_vertex>","#include <color_vertex>","#if (defined(USE_MAP)||defined(USE_BUMPMAP)) && defined(USE_INSTANCE)  ","   vUv = vec2(mat3(vec3(muvCol0, 0.0),","                   vec3(muvCol1, 0.0),","                   vec3(muvCol2, 1.0)) * vec3(uv, 1.0));","vUv = ( uvTransform * vec3( vUv, 1 ) ).xy;","#endif","#include <uv2_vertex>","#if defined(USE_COMPRESS_UV) && (defined(USE_LIGHTMAP) || defined(USE_AOMAP))","   vUv2 = uvDecode(vUv2);","#endif","#if defined(USE_LIGHTMAP) && defined(USE_INSTANCE)  ","   vUv2.x = uv2OffsetRepeat.x*vUv2.x/ 65535.0 + uv2OffsetRepeat.z ;","   vUv2.y = uv2OffsetRepeat.y*vUv2.y/ 65535.0 + uv2OffsetRepeat.w ;","#endif","#ifdef USE_INSTANCE","   vaColor = aColor;","   fClipping = vClipping;","   #ifdef INSTANCE_STATE_SECONDARY","       fState = vState2;","   #else","       fState = vState;","   #endif","   transformed = vec3(mat4(vec4(mcol0, 0.0),","                   vec4(mcol1, 0.0),","                   vec4(mcol2, 0.0),","                   vec4(mcol3, 1.0)) * vec4(transformed, 1.0));","   #ifdef USE_INSTANCE_NORMAL","       mat3 normalMat = mat3(mcol0, mcol1, mcol2);","       normalMat = inverse_mat3(normalMat);","       normalMat = transposeMat3(normalMat);","       objectNormal = normalMat * vertexNormal;","       transformedNormal = normalMatrix * vertexNormal;","   #ifdef FLIP_SIDED","       transformedNormal = - transformedNormal;","   #endif","       transformedNormal = normalize( transformedNormal );","   #endif","   mvNormal = transformedNormal;","   Normal = normalize(mat3(modelMatrix) * objectNormal);","    Pos = vec3(modelMatrix * vec4(transformed, 1.0));","#endif","#ifdef CCOLOR","ocColor = decodeColor();","#endif","#include <project_vertex>","#include <heightLimit_vertex>","#include <worldpos_vertex>","#include <shadowmap_vertex>","#include <logdepthbuf_vertex>","vViewPosition = - mvPosition.xyz;","vec3 vsWorldPosition = Pos;","#include <view_shed_vertex>","#include <video_cast_vertex>","}"].join("\n"),V.varying_pars=["varying vec2 vUv;","varying vec3 Normal;","varying vec3 Pos;","varying vec3 mvPosition;","varying vec3 mvNormal;"].join("\n"),V.clipping_pars=["#if NUM_CLIPPING_PLANES > 0","    uniform vec4 clippingPlanes[NUM_CLIPPING_PLANES];","#endif"].join("\n"),V.maps_pars=["#ifdef USE_MAP","    uniform sampler2D map;","#endif","#ifdef USE_NORMALMAP","    uniform sampler2D normalMap;","    uniform vec2 normalScale;","vec3 perturbNormal2Arb(vec3 pos, vec3 normal)","{","    vec3 q0 = vec3(dFdx(pos.x), dFdx(pos.y), dFdx(pos.z));","    vec3 q1 = vec3(dFdy(pos.x), dFdy(pos.y), dFdy(pos.z));","    vec2 st0 = dFdx(vUv.st);","    vec2 st1 = dFdy(vUv.st);","    vec3 S = normalize(q0 * st1.t - q1 * st0.t);","    vec3 T = normalize(-q0 * st1.s + q1 * st0.s);","    vec3 N = normalize(normal);","    vec3 mapN = texture2D(normalMap, vUv).xyz * 2.0 - 1.0;","    mapN.xy = normalScale * mapN.xy;","    mat3 tsn = mat3(S, T, N);","    return normalize(tsn * mapN);","}","#endif","#ifdef USE_ROUGHNESSMAP","    uniform sampler2D roughnessMap;","#endif","#ifdef USE_METALNESSMAP","    uniform sampler2D metalnessMap;","#endif","#ifdef USE_AOMAP","    uniform sampler2D aoMap;","    uniform float aoMapIntensity;","#endif"].join("\n"),V.iblMaps_pars=["uniform samplerCube irradianceMap;","uniform samplerCube prefilterMap;","uniform sampler2D brdfMap;"].join("\n"),V.lighting_pars=["#include <packing>","#include <common>","#include <shadowmap_pars_fragment>","#include <lights_pars_begin>","float punctualLightIntensityToIrradianceFactor(const in float lightDistance, const in float cutoffDistance, const in float decayExponent)","{","    if(decayExponent > 0.0)","    {","        float distanceFalloff = 1.0 / max(pow(abs(lightDistance), decayExponent), 0.01);","        float maxDistanceCutoffFactor = pow(abs(clamp(1.0 - pow(abs(lightDistance / cutoffDistance), 4.0), 0.0, 1.0)), 2.0);","        return distanceFalloff * maxDistanceCutoffFactor;","    }","    float distanceFalloff = 1.0 / max(pow(abs(lightDistance), 2.0), 0.01);","    return distanceFalloff;","}"].join("\n"),V.toneMap_pars=["uniform float shift;","uniform float A;","uniform float B;","uniform float C;","uniform float D;","uniform float E;","uniform float F;","uniform float scale;","vec3 toneMapCanonFilmic(vec3 color)","{","    color *= (1.0 / shift);","    return (((color * (A * color + C * B)) / (color * (A * color + B) + D * F))) * (1.0 / scale);","}"].join("\n"),V.Uniforms=[V.varying_pars,V.clipping_pars,"uniform bool IBLEnabled;","uniform int debug;","uniform float gamma;","uniform vec3 albedo;","uniform float metalness;","uniform float roughness;","uniform float opacity;","uniform float iblFactor;","uniform vec4 blinkColor;","uniform float blinkCoefficient;","uniform float colorState;","uniform vec3 tintColor;",V.maps_pars,V.iblMaps_pars,V.lighting_pars,V.toneMap_pars].join("\n"),V.IBLFragmentShader=[V.Uniforms,"#include <uv2_pars_fragment>","#include <lightmap_pars_fragment>","vec3 hdrDecode(in vec4 rgbm) {","const float rgbmScale = 2.82842712;","vec3 r = rgbm.rgb * (rgbmScale * (1.0 - rgbm.a));","return r * r;","}","#include <heightLimit_pars_fragment>","#include <bumpmap_pars_fragment>","#include <view_shed_pars_fragment>","#include <video_cast_pars_fragment>","#include <fog_pars_fragment>","#include <logdepthbuf_pars_fragment>","varying vec3 vViewPosition;","#include <csm_fragment>","#include <color_pars_fragment>","float D_GGX(float NdotH, float roughness)","{","    float alpha = pow(roughness, 2.0);","    float alpha2 = pow(alpha, 2.0);","    return alpha2 / (PI * pow(abs(NdotH * NdotH * (alpha2 - 1.0) + 1.0), 2.0));","}","float GGX_Schlick(float NdotV, float roughness)","{","    float k = (roughness + 1.0) * 0.125;","    return NdotV / (NdotV * (1.0 - k) + k);","}","float G_Smith(float NdotV, float NdotL, float roughness)","{","    return GGX_Schlick(NdotV, roughness) * GGX_Schlick(NdotL, roughness);","}","vec3 F_Schlick(float HdotV, vec3 F0)","{","    return F0 + (vec3(1.0) - F0) * pow((1.0 - HdotV), 5.0);","}","vec3 F_SchlickRoughness(float NdotV, vec3 F0, float roughness)","{","    return F0 + (max(vec3(1.0 - roughness), F0) - F0) * pow(1.0 - NdotV, 5.0);","}","#ifdef CCOLOR","   varying vec4 ocColor;","#endif","vec3 postProcessing(vec3 color, bool toneMap)","{","    vec3 result = toneMap ? toneMapCanonFilmic(color) : color;","    result = pow(result, vec3(1.0 / gamma));","    return result;","}","#ifdef USE_INSTANCE","   varying vec4 vaColor;","   varying float fState;","   varying float fClipping;","#endif","bool floatEqual(in float x, in float y) {","    return (x >= y - 0.01) && (x <= y + 0.01);","}","bool floatNotEqual(in float x, in float y) {","    return (x <= y - 0.01) || (x >= y + 0.01);","}","void main()","{","#if NUM_CLIPPING_PLANES > 0","    for (int i = 0; i < UNION_CLIPPING_PLANES; ++ i)","    {","        vec4 plane = clippingPlanes[ i ];","        if (dot(vViewPosition, plane.xyz) > plane.w) discard;","    }","    #if UNION_CLIPPING_PLANES < NUM_CLIPPING_PLANES","        bool clipped = true;","        for (int i = UNION_CLIPPING_PLANES; i < NUM_CLIPPING_PLANES; ++ i)","        {","            vec4 plane = clippingPlanes[ i ];","            clipped = (dot(vViewPosition, plane.xyz) > plane.w) && clipped;","        }","        if (clipped) discard;","    #endif","#endif","vec4 diffuseColor = vec4(albedo.rgb, opacity) ;","#include <vertex_color_frag>","vec3 baseColor = pow(diffuseColor.rgb, vec3(gamma));","#ifdef CCOLOR","       baseColor = pow(ocColor.rgb, vec3(gamma));","#endif","float realOpacity = opacity;","#ifdef USE_INSTANCE","   if (floatEqual(fState, -1.0)) ","       discard;","   if (floatNotEqual(fState, 0.0)){","       baseColor =  pow(vaColor.rgb, vec3(gamma));","       realOpacity = vaColor.a; }","#endif","vec3 keepColor = baseColor;","#ifdef USE_MAP","    baseColor = pow(texture2D(map, vUv).rgb, vec3(gamma));","   #ifdef USE_CLAMP_TO_BORDER","       baseColor = (vUv.x > 1.0 ||vUv.x < 0.0 || vUv.y < 0.0|| vUv.y > 1.0) ?keepColor:pow(texture2D(map, vUv).rgb, vec3(gamma));","   #endif","   #ifdef USE_INSTANCE","       if (floatNotEqual(fState, 0.0)) ","           realOpacity = vaColor.a;","         if (floatEqual(fState, 3.0))","             baseColor = keepColor;","   #endif","#endif","#ifdef USE_ALPHAMAP","   realOpacity *= texture2D( map, vUv ).a;","#endif","#ifdef DOUBLE_SIDED","    float flipNormal = float(gl_FrontFacing) * 2.0 - 1.0;","#else","    float flipNormal = 1.0;","#endif","    vec3 normal = Normal * flipNormal;","    vec3 vNormal = mvNormal * flipNormal;","#ifdef USE_NORMALMAP","    normal = perturbNormal2Arb(Pos, normal);","    vNormal = perturbNormal2Arb(mvPosition, vNormal);","#endif","#ifdef USE_BUMPMAP","    normal = perturbNormalArb( mvPosition, normal, dHdxy_fwd(), 1.0);","#endif","    float roughnessFactor = roughness;","#ifdef USE_ROUGHNESSMAP","    roughnessFactor = texture2D(roughnessMap, vUv).r;","#endif","    float metalnessFactor = metalness;","#ifdef USE_METALNESSMAP","    metalnessFactor = texture2D(metalnessMap, vUv).r;","#endif","#ifdef USE_INSTANCE","   if (floatEqual(fState, 3.0)){","       roughnessFactor = 1.0;","       metalnessFactor = 0.0;","   }","#endif","    float aoFactor = 1.0;","#ifdef USE_AOMAP","    aoFactor = texture2D(aoMap, vUv).r;","#endif","    vec3 N = normal;","    vec3 V = normalize(cameraPosition - Pos);","    vec3 R = reflect(-V, N);","    vec3 F0 = vec3(0.04);","    F0 = mix(F0, baseColor, metalnessFactor);","    vec3 totalLightColor = vec3(0.0);","    vec3 viewVector = normalize(-mvPosition);","    vec3 normalVector = normalize(vNormal);","    float NdotV = max(dot(normalVector, viewVector), 0.0);","    totalLightColor += ambientLightColor * baseColor / PI;","#if NUM_DIR_LIGHTS > 0","    vec3 dirColor = vec3(0.0);","\n        #if defined(USE_CSM)\n            DirectionalLight directionalLight;\n            float shadowValue = calcShadowFactor(normalVector);\n            for (int i = 4; i < NUM_DIR_LIGHTS; ++i)\n            {\n                directionalLight = directionalLights[i];\n                vec3 dirVector = normalize(directionalLight.direction);\n                vec3 halfVector = normalize(dirVector + viewVector);\n    \n                float NdotL = max(dot(normalVector, dirVector), 0.0);\n                float NdotH = max(dot(normalVector, halfVector), 0.0);\n                float HdotV = max(dot(halfVector, viewVector), 0.0);\n    \n                vec3 F = F_Schlick(HdotV, F0);\n                vec3 kS = F;\n                vec3 kD = 1.0 - kS;\n                kD *= 1.0 - metalnessFactor;\n    \n                float D = D_GGX(NdotH, roughnessFactor);\n                float G = G_Smith(NdotV, NdotL, roughnessFactor);\n                vec3 specular = D * G * F / (4.0 * NdotV * NdotL + 0.001);\n    \n                #ifdef USE_SHADOWMAP\n                if(realOpacity > 0.9)\n                directionalLight.color *= shadowValue;\n                #endif\n    \n    \n                dirColor += (kD * baseColor / PI + specular) * directionalLight.color * NdotL;\n            }\n        #else\n            #if defined( USE_SHADOWMAP ) && NUM_DIR_LIGHT_SHADOWS > 0\n                DirectionalLightShadow directionalLightShadow;\n            #endif\n\n            DirectionalLight directionalLight;\n            vec3 dirVector;\n            vec3 halfVector;\n            float NdotL;\n            float NdotH;\n            float HdotV;\n \n            vec3 F;\n            vec3 kS;\n            vec3 kD;\n\n            float D;\n            float G;\n            vec3 specular;\n\n            #pragma unroll_loop_start\n            for (int i = 0; i < NUM_DIR_LIGHTS; i++)\n            {\n                directionalLight = directionalLights[i];\n                \n                dirVector = normalize(directionalLight.direction);\n                halfVector = normalize(dirVector + viewVector);\n    \n                NdotL = max(dot(normalVector, dirVector), 0.0);\n                NdotH = max(dot(normalVector, halfVector), 0.0);\n                HdotV = max(dot(halfVector, viewVector), 0.0);\n    \n                F = F_Schlick(HdotV, F0);\n                kS = F;\n                kD = 1.0 - kS;\n                kD *= 1.0 - metalnessFactor;\n    \n                D = D_GGX(NdotH, roughnessFactor);\n                G = G_Smith(NdotV, NdotL, roughnessFactor);\n                specular = D * G * F / (4.0 * NdotV * NdotL + 0.001);\n    \n                #if defined( USE_SHADOWMAP ) && (NUM_DIR_LIGHT_SHADOWS > 0) && (UNROLLED_LOOP_INDEX < NUM_DIR_LIGHT_SHADOWS )\n                directionalLightShadow = directionalLightShadows[ i ];\n                if(realOpacity > 0.9)\n                directionalLight.color *= all( bvec2(receiveShadow, true ) ) ? getShadow( directionalShadowMap[ i ], directionalLightShadow.shadowMapSize, directionalLightShadow.shadowBias, directionalLightShadow.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;\n                #endif\n    \n                dirColor += (kD * baseColor / PI + specular) * directionalLight.color * NdotL;\n            }\n            #pragma unroll_loop_end\n        #endif\n    ","    totalLightColor += dirColor;","#endif","#if NUM_POINT_LIGHTS > 0","    vec3 pointColor  = vec3(0.0);","    for (int i = 0; i < NUM_POINT_LIGHTS; ++i)","    {","        PointLight pointLight = pointLights[i];","        vec3 dirVector = pointLight.position - mvPosition;","        float distance = length(dirVector);","        dirVector = normalize(dirVector);","        vec3 halfVector = normalize(dirVector + viewVector);","        float NdotL = max(dot(normalVector, dirVector), 0.0);","        float NdotH = max(dot(normalVector, halfVector), 0.0);","        float HdotV = max(dot(halfVector, viewVector), 0.0);","        vec3 F = F_Schlick(HdotV, F0);","        vec3 kS = F;","        vec3 kD = 1.0 - kS;","        kD *= 1.0 - metalnessFactor;","        float D = D_GGX(NdotH, roughnessFactor);","        float G = G_Smith(NdotV, NdotL, roughnessFactor);","        vec3 specular = D * G * F / (4.0 * NdotV * NdotL + 0.001);","        pointColor += (kD * baseColor / PI + specular) * pointLight.color * NdotL * punctualLightIntensityToIrradianceFactor(distance, pointLight.distance, pointLight.decay);","    }","    totalLightColor += pointColor;","#endif","#if NUM_SPOT_LIGHTS > 0","    vec3 spotColor  = vec3(0.0);","    for (int i = 0; i < NUM_SPOT_LIGHTS; ++i)","    {","        SpotLight spotLight = spotLights[i];","        vec3 dirVector = spotLight.position - mvPosition;","        float distance = length(dirVector);","        dirVector = normalize(dirVector);","        vec3 halfVector = normalize(dirVector + viewVector);","        float angleCos = dot(dirVector, spotLight.direction);","        if (angleCos > spotLight.coneCos)","        {","            float spotEffect = smoothstep(spotLight.coneCos, spotLight.penumbraCos, angleCos);","            float NdotL = max(dot(normalVector, dirVector), 0.0);","            float NdotH = max(dot(normalVector, halfVector), 0.0);","            float HdotV = max(dot(halfVector, viewVector), 0.0);","            vec3 F = F_Schlick(HdotV, F0);","            vec3 kS = F;","            vec3 kD = 1.0 - kS;","            kD *= 1.0 - metalnessFactor;","            float D = D_GGX(NdotH, roughnessFactor);","            float G = G_Smith(NdotV, NdotL, roughnessFactor);","            vec3 specular = D * G * F / (4.0 * NdotV * NdotL + 0.001);","            spotColor += (kD * baseColor / PI + specular) * spotLights[i].color * spotEffect * NdotL","                * punctualLightIntensityToIrradianceFactor(distance, spotLight.distance, spotLight.decay);","            totalLightColor += spotColor;","        }","    }","#endif","vec3 diffuseSpecularEmissive = vec3(0.0);","#ifdef USE_LIGHTMAP","   #ifdef USE_COMPONENT_LIGHTMAP","       vec3 lightMapIrradiance = (texture2D(lightMap, vUv2)).rgb * lightMapIntensity;","   #else","       vec3 lightMapIrradiance = hdrDecode(texture2D(lightMap, vUv2)) * lightMapIntensity;","   #endif","   vec3 diffuseSpecular =  clamp(baseColor.rgb, vec3(0.0, 0.0, 0.0), vec3(1.0, 1.0, 1.0)) * lightMapIrradiance;","   diffuseSpecularEmissive = diffuseSpecular + baseColor.rgb * 0.0;","#endif","totalLightColor += diffuseSpecularEmissive;","    if (IBLEnabled)","    {","        vec3 Fr = F_SchlickRoughness(max(dot(N, V), 0.0), F0, roughnessFactor);","        vec3 kS = Fr;","        vec3 kD = 1.0 - kS;","        kD *= 1.0 - metalnessFactor;","        vec3 irradiance = textureCube(irradianceMap, N, 0.0).rgb;","        vec3 diffuse = irradiance * baseColor;","        const float MAX_REFLECTION_LOD = 1.0;","        vec3 prefilteredColor = textureCube(prefilterMap, R, roughnessFactor * MAX_REFLECTION_LOD).rgb;","        vec2 brdf = texture2D(brdfMap, vec2(max(dot(N, V), 0.0), roughnessFactor)).rg;","        vec3 specular = prefilteredColor* (Fr* brdf.x + brdf.y)*iblFactor;","        vec3 color = (kD * diffuse + specular + totalLightColor) * aoFactor;","        color = postProcessing(color, true);","        if (debug == 1) ","        {","            baseColor = postProcessing(baseColor, false);","            gl_FragColor = vec4(baseColor, realOpacity);","        }","        else if (debug == 2)","        {","            irradiance = postProcessing(irradiance, true);","            gl_FragColor = vec4(irradiance, realOpacity);","        }","        else if (debug == 3)","        {","            prefilteredColor = postProcessing(prefilteredColor, true);","            gl_FragColor = vec4(prefilteredColor, realOpacity);","        }","        else if (debug == 4)","        {","            diffuse = postProcessing(diffuse, true);","            gl_FragColor = vec4(diffuse, realOpacity);","        }","        else if (debug == 5)","        {","            specular = postProcessing(specular, true);","            gl_FragColor = vec4(specular, realOpacity);","        }","        else if (debug == 6)","        {","            gl_FragColor = vec4(brdf, 0.0, realOpacity);","        }","        else if (debug == 7)","        {","            gl_FragColor = vec4(normal, realOpacity);","        }","        else","        {","           if(iblFactor > 1.0 && realOpacity < 0.6) realOpacity = 0.6;","            gl_FragColor = vec4(color, realOpacity);","        }","    }","    else","    {","        totalLightColor = postProcessing(totalLightColor, true);","        gl_FragColor = vec4(totalLightColor, realOpacity);","    }","#ifdef USE_INSTANCE","       if (floatEqual(fState, 5.0) && floatEqual(colorState, 1.0)) {","           gl_FragColor = mix(gl_FragColor, blinkColor, blinkCoefficient);","       }","#else","       if (floatEqual(colorState, 1.0)) {","           gl_FragColor = mix(gl_FragColor, blinkColor, blinkCoefficient);","       }","#endif","gl_FragColor = vec4(gl_FragColor.rgb * tintColor.rgb,gl_FragColor.a);","#include <view_shed_fragment>","#include <video_cast_fragment>","#include <heightLimit_fragment>","#include <fog_fragment>","#include <logdepthbuf_fragment>","}"].join("\n"),V.cube_vs=["varying vec3 pos;","void main()","{","    pos = position;","    gl_Position = projectionMatrix * mat4(mat3(viewMatrix)) * modelMatrix * vec4(position, 1.0);","    gl_Position = gl_Position.xyww;","}"].join("\n"),V.cube_fs=["varying vec3 pos;","uniform samplerCube environmentMap;","uniform bool hdr;","uniform float shift;","uniform float A;","uniform float B;","uniform float C;","uniform float D;","uniform float E;","uniform float F;","uniform float scale;","#include <fog_pars_fragment>","vec3 toneMapCanonFilmic(vec3 color)","{","    color *= (1.0 / shift);","    return (((color * (A * color + C * B)) / (color * (A * color + B) + D * F))) * (1.0 / scale);","}","void main()","{","    vec3 envColor = textureCube(environmentMap, pos, 0.0).rgb;","    if (hdr)","    {","        envColor = toneMapCanonFilmic(envColor);","        envColor = pow(envColor, vec3(1.0 / 2.2));","    }","    gl_FragColor = vec4(envColor, 1.0);","#include <fog_fragment>","}"].join("\n"),V.irradiance_vs=["varying vec3 pos;","void main() {","\tpos = vec3(modelMatrix * vec4(position, 1.0));","\tgl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","}"].join("\n"),V.irradiance_fs=["varying vec3 pos;","uniform samplerCube environmentMap;","const float PI = 3.14159265358979;","vec3 caluIrradiance(vec3 normal, vec3 up, vec3 right)","{","\tvec3 irradiance = vec3(0.0);","\tint count = 0;","\tconst int phiSampleCount = 1024;","\tconst int thetaSampleCount = phiSampleCount / 4;","\tfloat phiDelta = 2.0 * PI / float(phiSampleCount);","\tfloat thetaDelta = 0.5 * PI / float(thetaSampleCount);","\tfor(int i = 0; i < phiSampleCount; ++i)","\t{","\t\tfloat phi = float(i) * phiDelta;","\t\tfor(int j = 0; j < thetaSampleCount; ++j)","\t\t{","\t\t\tfloat theta = float(j) * thetaDelta;","\t\t\tvec3 tangentSample = vec3(sin(theta) * cos(phi), sin(theta) * sin(phi), cos(theta));","\t\t\tvec3 sampleVec = tangentSample.x * right + tangentSample.y * up + tangentSample.z * normal; ","\t\t\tirradiance += textureCube(environmentMap, sampleVec, 0.0).rgb * cos(theta) * sin(theta);","\t\t\t++count;","\t\t}","\t}","\tirradiance = PI * irradiance * (1.0 / float(count));","\treturn irradiance;","}","void main()","{","\tvec3 normal = normalize(pos);","\tvec3 up = vec3(0.0, 1.0, 0.0);","\tvec3 right = cross(up, normal);","\tup = cross(normal, right);","\tvec3 irradiance = caluIrradiance(normal, up, right);","\tgl_FragColor = vec4(irradiance, 1.0);","}"].join("\n"),V.IrradianceMap=function(e,t){this.cubeTexture=null,this.resolution=t||32,this.irradianceMaterial=new THREE.ShaderMaterial({vertexShader:V.irradiance_vs,fragmentShader:V.irradiance_fs,uniforms:{environmentMap:{value:e}},lights:!1,side:THREE.BackSide}),this.cube=new THREE.Mesh(new THREE.BoxBufferGeometry(2,2,2),this.irradianceMaterial)},V.IrradianceMap.prototype.constructor=V.IrradianceMap,V.IrradianceMap.prototype.generateMap=function(e,t){var i=new THREE.Scene;i.add(this.cube);var r=new THREE.CubeCamera(.1,10,this.resolution);if(t){var a={type:THREE.FloatType,format:THREE.RGBAFormat,magFilter:THREE.LinearFilter,minFilter:THREE.LinearFilter};r.renderTarget=new THREE.WebGLRenderTargetCube(this.resolution,this.resolution,a)}r.updateCubeMap(e,i),this.cubeTexture=r.renderTarget.texture},V.prefilter_vs=["varying vec3 pos;","varying vec3 Normal;","void main() {","\tpos = vec3(modelMatrix * vec4(position, 1.0));","\tNormal = mat3(modelMatrix) * normal;","\tgl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","}"].join("\n"),V.prefilter_fs=["varying vec3 pos;","varying vec3 Normal;","uniform float roughness;","uniform samplerCube environmentMap;","uniform sampler2D HammersleyTable;","const float PI = 3.14159265358979;","float D_GGX(float NdotH, float roughness)","{","\tfloat alpha = pow(roughness, 2.0);","\tfloat alpha2 = pow(alpha, 2.0);","\treturn alpha2 / (PI * pow(NdotH * NdotH * (alpha2 - 1.0) + 1.0, 2.0));","}","vec3 ImportanceSampleGGX(vec2 Xi, vec3 N, float roughness) ","{","\tfloat a = roughness * roughness;","\tfloat Phi = 2.0 * PI * Xi.x; ","\tfloat CosTheta = sqrt((1.0 - Xi.y) / (1.0 + (a * a - 1.0) * Xi.y)); ","\tfloat SinTheta = sqrt(1.0 - CosTheta * CosTheta);","\tvec3 H;","\tH.x = SinTheta * cos(Phi); ","\tH.y = SinTheta * sin(Phi); ","\tH.z = CosTheta;","\tvec3 UpVector = abs(N.z) < 0.999 ? vec3(0.0, 0.0, 1.0) : vec3(1.0, 0.0, 0.0); ","\tvec3 TangentX = normalize(cross(UpVector, N)); ","\tvec3 TangentY = cross(N, TangentX);","\treturn normalize(TangentX * H.x + TangentY * H.y + N * H.z);","}","void main()","{","\tvec3 N = normalize(pos);","\tvec3 R = N;","\tvec3 V = R;","\tconst int sampleCount = 1024;","\tfloat totalWeight = 0.0;","\tvec3 prefilteredColor = vec3(0.0);","\tfor (int i = 0; i < sampleCount; ++i) {","\t\tfloat u = float(i) / float(sampleCount);","\t\tvec2 Xi = vec2(u, texture2D(HammersleyTable, vec2(u)).r);","\t\tvec3 H = ImportanceSampleGGX(Xi, N, roughness);","\t\tvec3 L = normalize(2.0 * dot(V, H) * H - V);","\t\tfloat NdotL = max(dot(N, L), 0.0);","\t\tif(NdotL > 0.0)","\t\t{","\t\t\tfloat NdotH = max(dot(N, H), 0.0);","\t\t\tfloat D = D_GGX(NdotH, roughness);","\t\t\tfloat HdotV = max(dot(H, V), 0.0);","\t\t\tfloat pdf = D * NdotH / (4.0 * HdotV);","\t\t\tfloat resolution = 2048.0; // resolution of source cubemap (per face)","\t\t\tfloat solidAngleTexel= 4.0 * PI / (6.0 * resolution * resolution);","\t\t\tfloat solidAngleSample = 1.0 / (float(sampleCount) * pdf);","\t\t\tfloat mipLevel = roughness == 0.0 ? 0.0 : 0.5 * log2(solidAngleSample / solidAngleTexel);","\t\t\tprefilteredColor += textureCube(environmentMap, L, mipLevel).rgb * NdotL;","\t\t\ttotalWeight += NdotL;","\t\t}","\t}","\tprefilteredColor = prefilteredColor / totalWeight;","\tgl_FragColor = vec4(prefilteredColor, 1.0);","}"].join("\n"),V.PrefilterMap=function(e,t,i,r){this.cubeTexture=null,this.resolution=i||128,this.maxMipLevel=r||1,this.prefilterMaterial=new THREE.ShaderMaterial({vertexShader:V.prefilter_vs,fragmentShader:V.prefilter_fs,uniforms:{roughness:{value:0},environmentMap:{value:e},HammersleyTable:{value:t}},lights:!1,side:THREE.BackSide}),this.cube=new THREE.Mesh(new THREE.BoxBufferGeometry(2,2,2),this.prefilterMaterial)},V.PrefilterMap.prototype.constructor=V.PrefilterMap,V.PrefilterMap.prototype.generateMap=function(e,t){var i=new THREE.Scene;i.add(this.cube);var r=new THREE.CubeCamera(.1,10,this.resolution);if(t){var a={type:THREE.FloatType,format:THREE.RGBAFormat,magFilter:THREE.LinearFilter,minFilter:THREE.LinearFilter};r.renderTarget=new THREE.WebGLRenderTargetCube(this.resolution,this.resolution,a)}for(var n=this.maxMipLevel<=1?1:this.maxMipLevel-1,s=0;s<this.maxMipLevel;s++){var o=this.resolution*Math.pow(.5,s);r.renderTarget.width=r.renderTarget.height=o;var l=s/n;this.prefilterMaterial.uniforms.roughness.value=l,r.renderTarget.activeMipMapLevel=s,r.updateCubeMap(e,i)}this.cubeTexture=r.renderTarget.texture},function(){class e extends THREE.DataTextureLoader{constructor(e){super(e),this.type=THREE.UnsignedByteType}parse(e){const t=function(e,t){switch(e){case 1:console.error("THREE.RGBELoader Read Error: "+(t||""));break;case 2:console.error("THREE.RGBELoader Write Error: "+(t||""));break;case 3:console.error("THREE.RGBELoader Bad File Format: "+(t||""));break;default:console.error("THREE.RGBELoader: Error: "+(t||""))}return-1},i=function(e,t,i){t=t||1024;let r=e.pos,a=-1,n=0,s="",o=String.fromCharCode.apply(null,new Uint16Array(e.subarray(r,r+128)));for(;0>(a=o.indexOf("\n"))&&n<t&&r<e.byteLength;)s+=o,n+=o.length,r+=128,o+=String.fromCharCode.apply(null,new Uint16Array(e.subarray(r,r+128)));return-1<a&&(!1!==i&&(e.pos+=n+a+1),s+o.slice(0,a))},r=function(e,t,i,r){const a=e[t+3],n=Math.pow(2,a-128)/255;i[r+0]=e[t+0]*n,i[r+1]=e[t+1]*n,i[r+2]=e[t+2]*n,i[r+3]=1},a=function(e,t,i,r){const a=e[t+3],n=Math.pow(2,a-128)/255;i[r+0]=THREE.DataUtils.toHalfFloat(Math.min(e[t+0]*n,65504)),i[r+1]=THREE.DataUtils.toHalfFloat(Math.min(e[t+1]*n,65504)),i[r+2]=THREE.DataUtils.toHalfFloat(Math.min(e[t+2]*n,65504)),i[r+3]=THREE.DataUtils.toHalfFloat(1)},n=new Uint8Array(e);n.pos=0;const s=function(e){const r=/^\s*GAMMA\s*=\s*(\d+(\.\d+)?)\s*$/,a=/^\s*EXPOSURE\s*=\s*(\d+(\.\d+)?)\s*$/,n=/^\s*FORMAT=(\S+)\s*$/,s=/^\s*\-Y\s+(\d+)\s+\+X\s+(\d+)\s*$/,o={valid:0,string:"",comments:"",programtype:"RGBE",format:"",gamma:1,exposure:1,width:0,height:0};let l,d;if(e.pos>=e.byteLength||!(l=i(e)))return t(1,"no header found");if(!(d=l.match(/^#\?(\S+)/)))return t(3,"bad initial token");for(o.valid|=1,o.programtype=d[1],o.string+=l+"\n";l=i(e),!1!==l;)if(o.string+=l+"\n","#"!==l.charAt(0)){if((d=l.match(r))&&(o.gamma=parseFloat(d[1])),(d=l.match(a))&&(o.exposure=parseFloat(d[1])),(d=l.match(n))&&(o.valid|=2,o.format=d[1]),(d=l.match(s))&&(o.valid|=4,o.height=parseInt(d[1],10),o.width=parseInt(d[2],10)),2&o.valid&&4&o.valid)break}else o.comments+=l+"\n";return 2&o.valid?4&o.valid?o:t(3,"missing image size specifier"):t(3,"missing format specifier")}(n);if(-1!==s){const e=s.width,i=s.height,o=function(e,i,r){const a=i;if(a<8||a>32767||2!==e[0]||2!==e[1]||128&e[2])return new Uint8Array(e);if(a!==(e[2]<<8|e[3]))return t(3,"wrong scanline width");const n=new Uint8Array(4*i*r);if(!n.length)return t(4,"unable to allocate buffer space");let s=0,o=0;const l=4*a,d=new Uint8Array(4),h=new Uint8Array(l);let c=r;for(;c>0&&o<e.byteLength;){if(o+4>e.byteLength)return t(1);if(d[0]=e[o++],d[1]=e[o++],d[2]=e[o++],d[3]=e[o++],2!=d[0]||2!=d[1]||(d[2]<<8|d[3])!=a)return t(3,"bad rgbe scanline format");let i,r=0;for(;r<l&&o<e.byteLength;){i=e[o++];const a=i>128;if(a&&(i-=128),0===i||r+i>l)return t(3,"bad scanline data");if(a){const t=e[o++];for(let e=0;e<i;e++)h[r++]=t}else h.set(e.subarray(o,o+i),r),r+=i,o+=i}const u=a;for(let e=0;e<u;e++){let t=0;n[s]=h[e+t],t+=a,n[s+1]=h[e+t],t+=a,n[s+2]=h[e+t],t+=a,n[s+3]=h[e+t],s+=4}c--}return n}(n.subarray(n.pos),e,i);if(-1!==o){let t,n,l;switch(this.type){case THREE.UnsignedByteType:t=o;THREE.RGBEFormat;n=THREE.UnsignedByteType;break;case THREE.FloatType:l=o.length/4;const e=new Float32Array(4*l);for(let t=0;t<l;t++)r(o,4*t,e,4*t);t=e,n=THREE.FloatType;break;case THREE.HalfFloatType:l=o.length/4;const i=new Uint16Array(4*l);for(let e=0;e<l;e++)a(o,4*e,i,4*e);t=i,n=THREE.HalfFloatType;break;default:console.error("THREE.RGBELoader: unsupported type: ",this.type)}return{width:e,height:i,data:t,header:s.string,gamma:s.gamma,exposure:s.exposure,type:n}}}return null}setDataType(e){return this.type=e,this}load(e,t,i,r){return super.load(e,(function(e,i){switch(e.type){case THREE.UnsignedByteType:e.encoding=THREE.RGBEEncoding,e.minFilter=THREE.NearestFilter,e.magFilter=THREE.NearestFilter,e.generateMipmaps=!1,e.flipY=!0;break;case THREE.FloatType:case THREE.HalfFloatType:e.encoding=THREE.LinearEncoding,e.minFilter=THREE.LinearFilter,e.magFilter=THREE.LinearFilter,e.generateMipmaps=!1,e.flipY=!0}t&&t(e,i)}),i,r)}}THREE.RGBELoader=e}(),r.IBLManager=function(e){this.viewer=e,this.IBLConfig=null,this.host="",this.isHDR=!0,this.textureLoad=!1;var t=0,i=null,a=null;this.enableIBL=function(e){r.GlobalData.IBL!==e&&(r.GlobalData.IBL=e,this.viewer.setRenderStateChanged(!0),e?null!=i?this.initIBLByName(i):this.initIBLByIndex(t):(this.viewer.modelManager.changeAllMaterials(!1),this.removeSkyBox()))},this.loadIBLConfig=function(e){var t=this,i=this.viewer;(new THREE.FileLoader).load(e,(function(e){t.IBLConfig=JSON.parse(e),r.GlobalData.IBL&&t.initIBLByIndex(0)}),void 0,(function(){i.modelManager.dispatchEvent({type:r.LOADERROREVENTS.LOAD_ERROR,errorType:r.LOADERROREVENTS.LOAD_IBLCONFIG_ERROR,event:event})}))},this.initIBLByIndex=function(e){if(r.GlobalData.IBL&&null!=this.IBLConfig){var a=Object.keys(this.IBLConfig);if(a.length>e){var n=this.IBLConfig[a[e]];this.loadIBLMaps(this.host+n.url,n.isHDR,!0,n.uniforms),t=e,i=a[e]}}},this.initIBLByName=function(e){if(r.GlobalData.IBL&&null!=this.IBLConfig&&this.IBLConfig.hasOwnProperty(e)){var t=this.IBLConfig[e];this.loadIBLMaps(this.host+t.url,t.isHDR,!0,t.uniforms),i=e}},this.loadIBLMaps=function(e,t,i,a,n){function s(e){for(var r in o.modelManager.changeAllMaterials(!0),o.modelManager.updateMaterialsValue("IBLMaps",e,!0),a)"shift"!=r&&o.modelManager.updateMaterialsValue(r,a[r],!0);i&&l.addSkyBox(t,a),l.textureLoad=!0,o.setRenderStateChanged(!0),o.render()}if(r.GlobalData.IBL){var o=this.viewer;!a.iblFactor&&o.modelManager.isMeterUnit()&&(a.iblFactor=10),this.IBLParams=a;var l=this,d=o.getScene();n?s(d.IBLMaps):d.IBLMaps.loadMaps(e,t,!1,s)}},this.loadSkyBox=function(e,t){var i=this,r=this.viewer;r.getScene().IBLMaps.loadMaps(e,t,!0,(function(e,t){i.addSkyBox(t),r.render()}))},this.addSkyBox=function(e,t){e=null==e?this.isHDR:e;this.isHDR=e;var i=null,a=this.viewer.getScene();a.hasObjectGroup(r.ObjectGroupType.IBLCUBE)?((i=a.getObjectGroup(r.ObjectGroupType.IBLCUBE).children[0]).material.uniforms.environmentMap.value=a.IBLMaps.environmentMap,i.material.uniforms.hdr.value=e):((i=new THREE.Mesh(new THREE.BoxBufferGeometry(2e3,2e3,2e3),new THREE.ShaderMaterial({uniforms:{environmentMap:{value:a.IBLMaps.environmentMap},hdr:{value:e},shift:{value:.18},A:{value:.27},B:{value:.29},C:{value:.052},D:{value:.2},E:{value:0},F:{value:.18},scale:{value:.897105},fogDensity:{value:25e-5},fogNear:{value:1},fogFar:{value:2e3},fogColor:{value:new THREE.Color(16777215)},postProcessMap:{value:null},postProcessAdditiveMap:{value:null},postProcessMixRate:{value:0},postProcessAdditiveRate:{value:0},viewportWidth:{value:0},viewportHeight:{value:0}},vertexShader:V.cube_vs,fragmentShader:V.cube_fs,side:THREE.DoubleSide,depthTest:!0,depthWrite:!0,fog:!0}))).frustumCulled=!1,a.getOrCreateObjectGroup(r.ObjectGroupType.IBLCUBE,{priority:10}).add(i));if(t){var n=i.material;for(var s in t)n.uniforms.hasOwnProperty(s)&&(n.uniforms[s].value=t[s])}},this.renderWithOrthCamera=function(e,t,i,a){var n=e.getScene(),s=i||e.camera;if(n.hasObjectGroup(r.ObjectGroupType.IBLCUBE)&&(n.getOrCreateObjectGroup(r.ObjectGroupType.IBLCUBE).visible=!0,!s.isPerspective)){t.autoClear=!0,e.switchToCamera("persp"),r.GlobalData.IncrementRender&&0==a&&t.setObjectListUpdateState(!0);for(var o=n.getObjectGroups(),l=o.length,d=new Array(l),h=0;h<l;++h)d[h]=o[h].visible,o[h].visible=!1;n.getOrCreateObjectGroup(r.ObjectGroupType.IBLCUBE).visible=!0,t.render(n,s);for(h=0;h<l;++h)o[h].visible=d[h];d=null,n.getOrCreateObjectGroup(r.ObjectGroupType.IBLCUBE).visible=!1,e.switchToCamera("orth"),t.autoClear=!1,r.GlobalData.IncrementRender&&t.resetIncrementRender()}},this.removeSkyBox=function(){var e=this.viewer.getScene();e.hasObjectGroup(r.ObjectGroupType.IBLCUBE)&&(e.removeObjectGroupByName(r.ObjectGroupType.IBLCUBE),this.viewer.render())},this.setSkyBoxType=function(e){a=e},this.getSkyBoxType=function(){return a}},r.VolumeShader={uniforms:{backWorldPositionMap:{type:"t",value:null},densityMap:{type:"t",value:null},paletteMap:{type:"t",value:null},normalizeMatrix:{type:"m4",value:new THREE.Matrix4},resolution:{type:"f",value:81}},vertexShader:"\n    varying vec3 worldSpaceCoords;\n    varying vec4 projectedCoords;\n    uniform mat4 normalizeMatrix;\n\n    void main()\n    {\n        //worldSpaceCoords = (modelMatrix * vec4(position + vec3(0.5, 0.5,0.5), 1.0 )).xyz;\n        worldSpaceCoords = (normalizeMatrix * vec4(position , 1.0 )).xyz;\n        gl_Position = projectionMatrix *  modelViewMatrix * vec4( position, 1.0 );\n        projectedCoords =  gl_Position;\n    }\n    ",fragmentShader:"\n\n    varying vec3 worldSpaceCoords;\n    varying vec4 projectedCoords;\n    uniform sampler2D backWorldPositionMap;\n    uniform sampler2D densityMap;\n    uniform sampler2D paletteMap;\n    uniform float resolution;\n    float steps = 256.0;\n    float alphaCorrection = 0.8;//1.0;\n    // The maximum distance through our rendering volume is sqrt(3).\n    // The maximum number of steps we take to travel a distance of 1 is 512.\n    // ceil( sqrt(3) * 512 ) = 887\n    // This prevents the back of the image from getting cut off when steps=512 & viewing diagonally.\n    const int MAX_STEPS = 887;\n\n\n    float getRealAlpha(float a){\n        a = min(0.85, a) / 0.85;\n        return a < 0.03 ? 0.02: a;\n    }\n\n    //Acts like a texture3D using Z slices and trilinear filtering.\n    vec4 sampleAs3DTexture( vec3 texCoord )\n    {\n        float texLen = resolution - 1.0;\n        float sqrLen = sqrt(resolution);\n\n        vec4 colorSlice1, colorSlice2;\n        vec2 texCoordSlice1, texCoordSlice2;\n\n        //The z coordinate determines which Z slice we have to look for.\n        //Z slice number goes from 0 to 255.\n        float zSliceNumber1 = floor(texCoord.z  * texLen);\n\n        //As we use trilinear we go the next Z slice.\n        float zSliceNumber2 = min( zSliceNumber1 + 1.0, texLen); //Clamp to 255\n\n        //The Z slices are stored in a matrix of 16x16 of Z slices.\n        //The original UV coordinates have to be rescaled by the tile numbers in each row and column.\n        texCoord.xy /= sqrLen;\n\n        texCoordSlice1 = texCoordSlice2 = texCoord.xy;\n\n        //Add an offset to the original UV coordinates depending on the row and column number.\n        texCoordSlice1.x += (mod(zSliceNumber1, sqrLen ) / sqrLen);\n        texCoordSlice1.y += floor((texLen - zSliceNumber1) / sqrLen) / sqrLen;\n\n        texCoordSlice2.x += (mod(zSliceNumber2, sqrLen ) / sqrLen);\n        texCoordSlice2.y += floor((texLen - zSliceNumber2) / sqrLen) / sqrLen;\n\n        //Get the opacity value from the 2D texture.\n        //Bilinear filtering is done at each texture2D by default.\n        colorSlice1.a = getRealAlpha(texture2D( densityMap, texCoordSlice1 ).x);//0.01\n        colorSlice2.a = getRealAlpha(texture2D( densityMap, texCoordSlice2 ).x);\n\n        //Based on the opacity obtained earlier, get the RGB color in the transfer function texture.\n        colorSlice1.rgb = texture2D( paletteMap, vec2( colorSlice1.a, 1.0) ).rgb;\n        colorSlice2.rgb = texture2D( paletteMap, vec2( colorSlice2.a, 1.0) ).rgb;\n\n        //How distant is zSlice1 to ZSlice2. Used to interpolate between one Z slice and the other.\n        float zDifference = mod(texCoord.z * texLen, 1.0);\n\n        //Finally interpolate between the two intermediate colors of each Z slice.\n        return mix(colorSlice1, colorSlice2, zDifference) ;\n    }\n       \n    void main( void ) {\n        //Transform the coordinates it from [-1;1] to [0;1]\n        vec2 texc = vec2(((projectedCoords.x / projectedCoords.w) + 1.0 ) / 2.0,\n                        ((projectedCoords.y / projectedCoords.w) + 1.0 ) / 2.0 );\n\n        //The back position is the world space position stored in the texture.\n        vec3 backPos = texture2D(backWorldPositionMap, texc).xyz;\n\n        //The front position is the world space position of the second render pass.\n        vec3 frontPos = worldSpaceCoords;\n\n        //Using NearestFilter for rtTexture mostly eliminates bad backPos values at the edges\n        //of the cube, but there may still be no valid backPos value for the current fragment.\n        if ((backPos.x == 0.0) && (backPos.y == 0.0))\n        {\n            gl_FragColor = vec4(0.0);\n            return;\n        }\n\n        //The direction from the front position to back position.\n        vec3 dir = backPos - frontPos;\n\n        float rayLength = length(dir);\n\n        //Calculate how long to increment in each step.\n        float delta = 1.0 / steps;\n\n        //The increment in each direction for each step.\n        vec3 deltaDirection = normalize(dir) * delta;\n        float deltaDirectionLength = length(deltaDirection);\n\n        //Start the ray casting from the front position.\n        vec3 currentPosition = frontPos;\n\n        //The color accumulator.\n        vec4 accumulatedColor = vec4(0.0);\n\n        //The alpha value accumulated so far.\n        float accumulatedAlpha = 0.0;\n\n        //How long has the ray travelled so far.\n        float accumulatedLength = 0.0;\n\n        //If we have twice as many samples, we only need ~1/2 the alpha per sample.\n        //Scaling by 256/10 just happens to give a good value for the alphaCorrection slider.\n        float alphaScaleFactor = 25.6 * delta;\n\n        vec4 colorSample;\n        float alphaSample;\n\n        //Perform the ray marching iterations\n        for(int i = 0; i < MAX_STEPS; i++)\n        {\n            //Get the voxel intensity value from the 3D texture.\n            colorSample = sampleAs3DTexture( currentPosition );\n\n            //Allow the alpha correction customization.\n            alphaSample = colorSample.a * alphaCorrection;\n\n            //Applying this effect to both the color and alpha accumulation results in more realistic transparency.\n            alphaSample *= (1.0 - accumulatedAlpha);\n\n            //Scaling alpha by the number of steps makes the final color invariant to the step size.\n            alphaSample *= alphaScaleFactor;\n\n            //Perform the composition.\n            accumulatedColor += colorSample * alphaSample;\n\n            //Store the alpha accumulated so far.\n            accumulatedAlpha += alphaSample;\n\n            //Advance the ray.\n            currentPosition += deltaDirection;\n            accumulatedLength += deltaDirectionLength;\n\n            //If the length traversed is more than the ray length, or if the alpha accumulated reaches 1.0 then exit.\n            if(accumulatedLength >= rayLength || accumulatedAlpha >= 1.0 )\n                break;\n        }\n        gl_FragColor  = accumulatedColor;\n\n    }\n    "},r.BackWorldPosShader={uniforms:{normalizeMatrix:{type:"m4",value:new THREE.Matrix4}},vertexShader:"\n    varying vec3 worldSpaceCoords;\n    uniform mat4 normalizeMatrix;\n    // #include <clipping_planes_pars_vertex>\n    void main()\n    {\n        //Set the world space coordinates of the back faces vertices as output.\n        worldSpaceCoords = (normalizeMatrix * vec4(position , 1.0 )).xyz; \n        gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n        // #include <begin_vertex>\n        // #include <project_vertex>\n        // #include <clipping_planes_vertex>\n    }\n    ",fragmentShader:"\n    varying vec3 worldSpaceCoords;\n    // #include <clipping_planes_pars_fragment>\n    void main()\n    {\n        //#include <clipping_planes_fragment>\n        //The fragment's world space coordinates as fragment output.\n        gl_FragColor = vec4( worldSpaceCoords.x , worldSpaceCoords.y, worldSpaceCoords.z, 1 );\n    }\n    "},function(){class e extends THREE.Mesh{constructor(e,t,i){super(t,i),this.viewer=e.viewer;let a=this.viewer.getRenderer();this.size=new THREE.Vector2,a.getDrawingBufferSize(this.size),this.radiusScale=e.radiusScale,this.resolution=e.resolution,this.gradient={.25:"rgb(0,0,255)",.55:"rgb(0,255,0)",.85:"yellow",1:"rgb(255,0,0)"},this.backSceneRenderTarget=new THREE.WebGLRenderTarget(this.size.x,this.size.y,{minFilter:THREE.NearestFilter,magFilter:THREE.NearestFilter,wrapS:THREE.ClampToEdgeWrapping,wrapT:THREE.ClampToEdgeWrapping,format:THREE.RGBAFormat,type:THREE.FloatType,generateMipmaps:!1}),this.heatmapNum=0,this.sceneForBackPos=new THREE.Scene;var n=this.viewer.getScene().getRawMatrixGlobal();this.meshGroup=new r.ObjectGroup("backScene"),this.meshGroup.matrix.copy(n),this.meshGroup.matrixAutoUpdate=!1,this.meshGroup.updateMatrixWorld(!0),this.sceneForBackPos.add(this.meshGroup),this.material=new THREE.ShaderMaterial({uniforms:r.VolumeShader.uniforms,vertexShader:r.VolumeShader.vertexShader,fragmentShader:r.VolumeShader.fragmentShader,side:THREE.DoubleSide,transparent:!0}),this.material.uniforms.backWorldPositionMap.value=this.backSceneRenderTarget.texture,this.material.uniforms.densityMap.value=this._getDensityMap(e.data),this.material.uniforms.paletteMap.value=this._getPaletteMap(),this.material.uniforms.normalizeMatrix.value=e.normalizeMatrix,this.material.uniforms.resolution.value=e.resolution.x,this.geometry=this._getGeometry(e.boundary,e.height),this.position.z=e.offsetZ,this.updateMatrixWorld(),this.backMaterial=new THREE.ShaderMaterial({uniforms:r.BackWorldPosShader.uniforms,vertexShader:r.BackWorldPosShader.vertexShader,fragmentShader:r.BackWorldPosShader.fragmentShader,side:THREE.BackSide}),this.backMaterial.uniforms.normalizeMatrix.value=e.normalizeMatrix,this.backMesh=new THREE.Mesh(this.geometry,this.backMaterial),this.backMesh.position.z=e.offsetZ,this.backMesh.updateMatrixWorld(),this.meshGroup.add(this.backMesh),this.meshGroup.updateMatrixWorld(),this.renderOrder=r.GlobalData.IncrementRender?100:-1}onBeforeRender(e,t,i){e.getDrawingBufferSize(this.size);let r=this.backSceneRenderTarget;this.size.x==r.width&&this.size.y==r.height||r.setSize(this.size.x,this.size.y);var a=e.getRenderTarget();e.setRenderTarget(this.backSceneRenderTarget),e.clear(),e.render(this.sceneForBackPos,i),e.setRenderTarget(a)}_getGeometry(e,t){var i=new THREE.Shape(e),r={depth:t,bevelEnabled:!1};return new THREE.ExtrudeGeometry(i,r)}_getDensityMap(e){var t=this.resolution.x,i=this.resolution.y,r=this.resolution.z;let a=Math.sqrt(r),n=Math.sqrt(r),s=new Uint8Array(t*i*r);const o=!0===this.viewer.webgl2Support?THREE.RedFormat:THREE.LuminanceFormat;this._updateDensityMapData(s,e);var l=new THREE.DataTexture(s,t*a,i*n,o);return l.minFilter=THREE.LinearFilter,l.magFilter=THREE.LinearFilter,l.generateMipmaps=!1,l.needsUpdate=!0,this.densityMap=l,this.densityMap}updateDensityMap(e){let t=this.densityMap.image.data;this._updateDensityMapData(t,e),this.densityMap.needsUpdate=!0}_updateDensityMapData(e,t){var i=this.resolution.x,r=this.resolution.y,a=this.resolution.z;let n=Math.sqrt(a),s=Math.sqrt(a);function o(e,t,i,r,a,n,s){return Math.sqrt(Math.pow((e-r)/s.x,2)+Math.pow((t-a)/s.y,2)+Math.pow((i-n)/s.z,2))}e.fill(0);let l=this.radiusScale;for(var d=0;d<t.length;d++){let m=t[d],f=Math.floor(Math.max(0,m.x-m.radius*l.x)),g=Math.floor(Math.max(0,m.y-m.radius*l.y)),v=Math.floor(Math.max(0,m.z-m.radius*l.z)),y=Math.ceil(Math.min(i,m.x+m.radius*l.x)),M=Math.ceil(Math.min(r,m.y+m.radius*l.y)),E=Math.ceil(Math.min(a,m.z+m.radius*l.z));for(var h=v;h<E;h++)for(var c=g;c<M;c++)for(var u=f;u<y;u++){var p=o(u,c,h,m.x,m.y,m.z,l);let t=u+h%s*i,d=a-h-1,f=c+Math.floor(d/n)*r,g=p<0*m.radius?m.value:(1-p/m.radius+0)*m.value,v=f*r*s+t;e[v]=Math.max(255*g,e[v])}}}_getPaletteMap(){var e=this.gradient,t=document.createElement("canvas"),i=t.getContext("2d");t.width=256,t.height=1;var r=i.createLinearGradient(0,0,256,1);for(var a in e)r.addColorStop(a,e[a]);i.fillStyle=r,i.fillRect(0,0,256,1);let n=new THREE.Texture(t);return n.wrapS=n.wrapT=THREE.ClampToEdgeWrapping,n.needsUpdate=!0,n}dispose(){this.geometry.dispose(),this.material.dispose()}setGradient(e){this.gradient=e,this.material.uniforms.paletteMap.value=this._getPaletteMap()}}r.Heatmap3D=e}();r.Storage=r.Storage||{},r.Storage.IndexedDBHelper=class{constructor(e){this.indexedDB=window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB||window.msIndexedDB,this.indexedDB||console.log("IndexedDB not supported"),this._db=null,this._opt=e,this._onOpening=!1,this._onOpeningResolves=[],this._onOpeningRejects=[],this._temp={}}open(e,t){this._onOpening=!0;const i=e||this._opt.name,r=t||this._opt.version,a=this.indexedDB.open(i,r);return new Promise(((e,t)=>{a.onsuccess=i=>{let r=a.result,n=!1;if(this._opt.storeList){let i=Object.values(r.objectStoreNames);this._opt.storeList.some((a=>{if(-1===i.indexOf(a)){let{name:i,version:a}=r;return a++,r.close(),this.open(i,a).then(e).catch(t),n=!0}}))}n||(this._db=r,e(r))},a.onupgradeneeded=e=>{let t=this._db=e.target.result,i=this._opt.storeList||[];i.forEach((e=>!t.objectStoreNames.contains(e)&&t.createObjectStore(e))),Object.values(t.objectStoreNames).forEach((e=>-1===i.indexOf(e)&&t.deleteObjectStore(e)))},a.onerror=e=>{t(e)}}))}getDB(){return new Promise(((e,t)=>{this._db?e(this._db):this._onOpening?(this._onOpeningResolves.push(e),this._onOpeningRejects.push(t)):this.open().then((t=>{e(t),this._onOpeningResolves.forEach((e=>e(t)))})).catch((e=>{t(e),this._onOpeningRejects.forEach((t=>t(e)))}))}))}addObject(e,t,i){return new Promise(((r,a)=>{this.getDB().then((n=>{if(!n.objectStoreNames.contains(e))return void a();const s=n.transaction(e,"readwrite");s.objectStore(e).put(t,i).onsuccess=a=>{this._temp[e]&&this._temp[e].keys&&(this._temp[e].keys.push(i),this._temp[e].map[i]=t),r(a.target.result)},s.onerror=a})).catch(a)}))}getObject(e,t,i=!1){return new Promise(i?(i,r)=>{if(this._temp[e]){let a=this._temp[e].map[t];if(a)return void i(a);if(-1===this._temp[e].keys.indexOf(t))return void r()}this.getDB().then((a=>{if(!a.objectStoreNames.contains(e))return void r();const n=a.transaction(e,"readonly"),s=n.objectStore(e);let o=new Promise((e=>s.getAllKeys().onsuccess=t=>e(t.target.result))),l=new Promise((e=>s.getAll().onsuccess=t=>e(t.target.result)));Promise.all([o,l]).then((a=>{let[n,s]=a;this._temp[e]={keys:n,map:{}};let o=!1;n.forEach(((r,a)=>{t===r?(i(s[a]),o=!0):this._temp[e].map[r]=s[a]})),o||r()})),n.onerror=r})).catch(r)}:(i,r)=>{this.getDB().then((a=>{if(!a.objectStoreNames.contains(e))return void r();const n=a.transaction(e,"readonly");n.objectStore(e).get(t).onsuccess=e=>{let t=e.target.result;t?i(t):r(e)},n.onerror=r})).catch(r)})}deleteObject(e,t){return new Promise(((i,r)=>{this.getDB().then((a=>{if(!a.objectStoreNames.contains(e))return void r();const n=a.transaction(e,"readwrite");n.objectStore(e).delete(t).onsuccess=e=>{i(e.target.result)},n.onerror=r})).catch(r)}))}},r.Storage.IndexedDBHelper.loadWithStorage=(e,t,i,a,n,s=!1)=>{let o=()=>{i(t).then((i=>{let n=s?JSON.stringify(i):i;r.EnableStorage&&r.storageManager[`add${e}`](n,t),a&&a(i)})).catch((e=>n&&n(e)))};r.EnableStorage?r.storageManager[`get${e}`](t).then((e=>{let t=s?JSON.parse(e):e;a&&a(t)})).catch((e=>{o()})):o()};r.Storage.StorageManager=class{constructor(){this.helperMap={},r.storageManager=this}getHelper(e){return this.helperMap[e]=this.helperMap[e]||new r.Storage.IndexedDBHelper({name:`Bf_${e}`,storeList:["i","m","t"]}),this.helperMap[e]}getDatabagIdAndKeyByUrl(e){let t=/\/\/.*?\/(.+?)\/resource\/v3\/model\/(.+?)(\.gz)?(\?.+)?$/.exec(e);return t?{databagId:t[1],key:t[2]}:{databagId:"i",key:e}}getDatabagIdAndRootKeyByUrl(e){let t=/\/\/.*?\/(.+?)\/(.+?)(\.gz)?(\?.+)?$/.exec(e);return t?{databagId:t[1],key:t[2]}:{databagId:"i",key:e}}addData(e,t,i,r=!0){return new Promise(((a,n)=>{let s=r?this.getDatabagIdAndRootKeyByUrl(i):this.getDatabagIdAndKeyByUrl(i),{databagId:o,key:l}=s;this.getHelper(o).addObject(e,t,l).then((e=>a(e))).catch((e=>n(e)))}))}addModelData(e,t){return this.addData("m",e,t)}addInfoData(e,t){return this.addData("i",e,t)}getData(e,t,i=!0){return new Promise(((r,a)=>{let n=i?this.getDatabagIdAndRootKeyByUrl(e):this.getDatabagIdAndKeyByUrl(e),{databagId:s,key:o}=n;this.getHelper(s).getObject(t,o).then((e=>{r(e)})).catch((e=>a(e)))}))}getModelData(e){return this.getData(e,"m")}getInfoData(e){return this.getData(e,"i")}addTexture(e,t){const i=(e,t)=>{let i=this._canvas=this._canvas||document.createElement("canvas"),r=i.getContext("2d");return r.clearRect(0,0,i.width,i.height),i.width=t,i.height=t,r.drawImage(e,0,0,t,t),r.getImageData(0,0,t,t)};return new Promise(((a,n)=>{let s,o=this.getDatabagIdAndKeyByUrl(t),{databagId:l,key:d}=o;e.image instanceof HTMLImageElement?(e.image=r.MaterialUtil.ensurePowerOfTwo(e.image),s={type:"DataTexture",data:{image:i(e.image,e.image.width)}}):s={type:"CompressedTexture",data:{image:e.image}},["anisotropy","encoding","flipY","format","generateMipmaps","magFilter","mapping","minFilter","mipmaps","premultiplyAlpha","rotateMatrix","type","unpackAlignment","wrapS","wrapT"].forEach((t=>s.data[t]=e[t])),this.getHelper(l).addObject("t",s,d).then((e=>a(e))).catch((e=>n(e)))}))}getTexture(e){return new Promise(((t,i)=>{let r=this.getDatabagIdAndKeyByUrl(e),{databagId:a,key:n}=r;this.getHelper(a).getObject("t",n).then((e=>{if(!["DataTexture","CompressedTexture"].includes(e.type)||!e.data)return void this.getHelper(a).deleteObject("t",n).then((e=>i(e)));let r=new THREE[e.type];Object.keys(e.data).forEach((t=>r[t]=e.data[t])),r.needsUpdate=!0,t(r)})).catch((e=>i(e)))}))}addBimtiles(e,t){return new Promise(((i,r)=>{let a=this.getDatabagIdAndKeyByUrl(t),{databagId:n,key:s}=a;this.getHelper(n).addObject("t",e,s).then((e=>i(e))).catch((e=>r(e)))}))}getBimtiles(e){return new Promise(((t,i)=>{let r=this.getDatabagIdAndKeyByUrl(e),{databagId:a,key:n}=r;this.getHelper(a).getObject("t",n).then((e=>{t(e)})).catch((e=>i(e)))}))}};r.Storage.SceneStorageManager=class{constructor(e){this.helper=new r.Storage.IndexedDBHelper({name:`Bg_${e.sceneId}`,storeList:["i",...e.databagIdList]}),r.storageManager=this}getStoreNameAndKeyByUrl(e){let t=/\/\/.*?\/(.+?)\/resource\/v3\/model\/bimtiles\/(.+?)(\.gz)?$/.exec(e);return t?{storeName:t[1],key:t[2]}:{storeName:"i",key:e}}addTexture(e,t){const i=(e,t,i)=>{let r=this._canvas=this._canvas||document.createElement("canvas"),a=r.getContext("2d");return a.clearRect(0,0,r.width,r.height),r.width=t,r.height=i,a.drawImage(e,0,0,t,i),a.getImageData(0,0,t,i)};return new Promise(((r,a)=>{let n,s=this.getStoreNameAndKeyByUrl(t),{storeName:o,key:l}=s;n=e.image instanceof HTMLImageElement?{type:"Texture",data:{image:i(e.image,e.image.width,e.image.height)}}:{type:"CompressedTexture",data:{image:e.image}},["anisotropy","encoding","flipY","format","generateMipmaps","magFilter","mapping","minFilter","mipmaps","premultiplyAlpha","rotateMatrix","type","unpackAlignment","wrapS","wrapT"].forEach((t=>n.data[t]=e[t])),this.helper.addObject(o,n,l).then((e=>r(e))).catch((e=>a(e)))}))}getTexture(e){return new Promise(((t,i)=>{let r=this.getStoreNameAndKeyByUrl(e),{storeName:a,key:n}=r;this.helper.getObject(a,n).then((e=>{if(!["Texture","CompressedTexture"].includes(e.type)||!e.data)return void this.helper.deleteObject(a,n).then((e=>i(e)));let r=new THREE[e.type];Object.keys(e.data).forEach((t=>r[t]=e.data[t])),"Texture"===e.type&&(r.image=(e=>{let t=document.createElement("canvas"),i=t.getContext("2d");return t.width=e.width,t.height=e.height,i.putImageData(e,0,0),t})(e.data.image)),r.needsUpdate=!0,t(r)})).catch((e=>i(e)))}))}addBimtiles(e,t){return new Promise(((i,r)=>{let a=this.getStoreNameAndKeyByUrl(t),{storeName:n,key:s}=a;this.helper.addObject(n,e,s).then((e=>i(e))).catch((e=>r(e)))}))}getBimtiles(e){return new Promise(((t,i)=>{let r=this.getStoreNameAndKeyByUrl(e),{storeName:a,key:n}=r;this.helper.getObject(a,n).then((e=>{t(e)})).catch((e=>i(e)))}))}addInfoData(e,t){return this.addBimtiles(e,t)}getInfoData(e){return this.getBimtiles(e)}},(()=>{let e=new THREE.Vector3;r.ExplosionManager=class{constructor(e){this.modelManager=e,this.totalHeightMap={},this.explosionParamMap={},this.explodeCount=0,this.isElementExplodedMap={},this.isFloorExplodedMap={}}destroy(){this.modelManager=null,this.totalHeightMap=null,this.explosionParamMap=null,this.isElementExplodedMap=null,this.isFloorExplodedMap=null}getExplosionParam(e){return this.explosionParamMap[e]||(this.explosionParamMap[e]={explosionExtent:0,floorExplosionExtent:0,floorExplosionList:[],floorInfos:void 0,floorExplosionDirection:void 0}),this.explosionParamMap[e]}getExplosionExtent(e){if(e)return this.getExplosionParam(e).explosionExtent}setFloorInfos(t,i){if(i&&!this.getExplosionParam(i).floorInfos){for(var r=0,a=t.length;r<a;r++)t[r].explodedHeight=t[r].elevation,t[r].preExplodedHeight=t[r].elevation,t[r].preExplodedTranslation=null;this.getExplosionParam(i).floorInfos=t,this.totalHeightMap[i]={};const n=this.modelManager.getModel(i).getRawBoundingBox();this.totalHeightMap[i].totalHeight=n.getSize(e).z}}setExplosionExtent(t,i){if(!i)return;var a,n=t-this.getExplosionParam(i).explosionExtent;if(0==n)return;this.modelManager.modelCollection.traverse((e=>{var r=e.id,n=new THREE.Box3,s=r==i?t:this.getExplosionParam(r).explosionExtent;r!=i&&0===s?n=e.getBoundingBoxWorld():e.modelExplosion.preElementExplode(n,s),n&&(a?a.union(n):a=n)}));const s=this.modelManager.getModel(i),o=s.getBoundingBoxWorld().getCenter(e);let l=this.modelManager.modelCollection.getById("ExternalComponent");l&&l.elementExplode(s,n,o);let d=this.modelManager.modelCollection.getById("ExtrudeBodyManager");d&&d.elementExplode(s,t,o),this.explodeCount=1e4==this.explodeCount?0:this.explodeCount+1,this.isElementExplodedMap[i]=0!==t,this.modelManager.scene.setBoundingBoxWorld(a),4==r.GlobalData.LightPreset&&(this.modelManager.scene.lightManager.updateShadowLight(),this.modelManager.scene.lightManager.updateReceivingPlane()),r.GlobalData.EnableShadowMap&&this.modelManager.viewer.updateShadowMap(),this.modelManager.modelCollection.getById(i).modelExplosion.explode(),this.getExplosionParam(i).explosionExtent=t,this.modelManager.dispatchEvent({type:r.EVENTS.ON_EXPLOSION,extent:t})}setFloorExplosion(e,t,i,a){if(!a)return;if(a=a.toString(),this.getExplosionParam(a).floorExplosionDirection=i,null==this.getExplosionParam(a).floorInfos)return;this.getExplosionParam(a).floorExplosionList=[];var n=!0,s={};if(t){for(var o=0,l=t.length;o<l;o++)s[t[o]]=!0;if(n=!1,0==t.length)return}for(var d=this.getExplosionParam(a).floorInfos,h=d.length,c=e*this.totalHeightMap[a].totalHeight/(h-1),u=0,p=0;p<h;p++){d[p].name;var m=d[p].elevation+u*c;(n||s[d[p].id])&&(u++,this.getExplosionParam(a).floorExplosionList.push(d[p].id)),d[p].preExplodedHeight=d[p].explodedHeight,d[p].explodedHeight=m,d[p].preExplodedDirection=d[p].explodedDirection,d[p].explodedDirection=i}let f=this.modelManager.modelCollection.getById("ExtrudeBodyManager");f&&f.explode(a);let g=this.modelManager.modelCollection.getById("ExternalComponent");const v=this.modelManager.getModel(a);var y;g&&g.explode(v),this.modelManager.modelCollection.traverse((e=>{var t=e.id.toString();const i=this.getExplosionParam(t).floorExplosionDirection;var r=new THREE.Box3,a=this.getExplosionParam(t).floorInfos;if(i&&a&&a.length>0){let t=(new THREE.Matrix4).copy(e.getTransformMatrix()).invert();const n=i.clone().applyMatrix4(t).sub(new THREE.Vector3(0,0,0).applyMatrix4(t));e.modelExplosion.preFloorExplode(r,a,n),r&&(y?y.union(r):y=r)}else r=e.getBoundingBoxWorld(),y?y.union(r):y=r})),this.explodeCount=1e4==this.explodeCount?0:this.explodeCount+1,this.isFloorExplodedMap[a]=0!==e,this.modelManager.scene.setBoundingBoxWorld(y),this.modelManager.scene.updateBoundingBoxWorldWithoutDEM(y),this.modelManager.getFilter().needUpdateBoxAfterExplode(),this.modelManager.modelCollection.getById(a).modelExplosion.explode(),4==r.GlobalData.LightPreset&&this.modelManager.scene.lightManager.updateShadowLight(),r.GlobalData.EnableShadowMap&&this.modelManager.viewer.updateShadowMap(),this.getExplosionParam(a).floorExplosionExtent=e,0===e&&(this.getExplosionParam(a).floorExplosionList=[]),this.modelManager.dispatchEvent({type:r.EVENTS.ON_FLOOR_EXPLOSION,floorInfos:d,modelId:a})}getFloorInfos(e){if(e)return this.getExplosionParam(e).floorInfos}getFloorExplosionList(e){if(e)return this.getExplosionParam(e).floorExplosionList}getFloorExplosionExtent(e){if(e)return this.getExplosionParam(e).floorExplosionExtent}getFloorExplosionDirection(e){if(e)return this.getExplosionParam(e).floorExplosionDirection}destroy(){delete this.explosionParamMap}isExploded(e){return this.isElementExplodedMap[e]||this.isFloorExplodedMap[e]}}})(),r.BaseModelExplosion=class{constructor(e){this.model=e,this.explosionTranslation={}}explode(){this.model.explode()}preFloorExplode(e,t,i){}preElementExplode(e,t){}getExplosionTranslationByObjId(e){}getLevelNameByObjId(e){}},r.ModelView=r.ModelView||{},function(){class e{constructor(e,t){this.manager=e,this.setValues(t),this.castShadow=!0,this.receiveShadow=!0,t.loadConfig&&(this.castShadow=!r.Utils.isDefined(t.loadConfig.castShadow)||t.loadConfig.castShadow,this.receiveShadow=!r.Utils.isDefined(t.loadConfig.receiveShadow)||t.loadConfig.receiveShadow),this.localClippingMode=!1,this.localClippingPlanes=null,this.innerClippingMode=!1,this.innerClippingMatrix=null,this.filter=null,this.visible=!0,this.loaded=!1,this.emptyScene=!1,this.statistics={renderableCount:0,renderableTotal:r.GlobalData.maxObjectNumInPool,renderableTotalForPool:r.GlobalData.maxObjectNumInPool,numOfElements:0,numOfTriangles:0,numOfVertices:0,memoeryInfo:{maxMemorySize:0,minMemorySize:0,triangleNumber:0,instanceEnabled:r.GlobalData.Instance}},this.transformInfos={octreeTransformed:!1,boundingBox:new THREE.Box3,position:new THREE.Vector3,rotation:(new THREE.Quaternion).setFromEuler((new THREE.Euler).fromArray([-1.5708,0,0]),!1),scale:new THREE.Vector3(1,1,1),transformMatrix:new THREE.Matrix4},this.containsCamera=!1,this.destroyed=!1,this.boundaryPoints=[new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3],this.modelExplosion=new r.BaseModelExplosion(this),this.objectGroup=void 0}get sequence(){return this._sequence}set sequence(e){this._sequence=e}set config(e){this._config=e}get config(){return this._config}destroy(){this.destroyed=!0,this.statistics=null,this.transformInfos=null,this.transformMatrix=void 0,this.transformMatrixInverse=void 0,this.boundaryPoints=void 0,this._lengthUnitsMatrix=void 0,this.filter&&(this.filter.destroy(),this.filter=null),this.manager=null,this._config=void 0}setValues(e){this.id=e.modelId,this.databagId=this.id,this.fileId=e.fileId,this._sequence=e.priority,this._config=e.config,this._config&&this._config.metadata&&this._config.metadata.model_unit?this._unit="m"===this._config.metadata.model_unit?r.EnumLengthlUnits.Meter:r.EnumLengthlUnits.Millimeter:this._unit=this.getDefaultUnit(),this._lengthUnitsMatrix=void 0,this.transform={translation:new THREE.Vector3,rotation:new THREE.Quaternion,scale:new THREE.Vector3(1,1,1)},this.transformMatrix=new THREE.Matrix4,this.transformMatrixInverse=new THREE.Matrix4,this.setupTransformMatrix(e)}setupTransformMatrix(e){let t=e.loadConfig?e.loadConfig.transformMatrix:void 0;if(!t){let i=new THREE.Vector3,r=new THREE.Quaternion,a=new THREE.Vector3(1,1,1);e.loadConfig&&e.loadConfig.translation&&i.fromArray(e.loadConfig.translation),e.loadConfig&&e.loadConfig.rotation&&r.setFromEuler((new THREE.Euler).fromArray(e.loadConfig.rotation)),e.loadConfig&&e.loadConfig.scale&&a.fromArray(e.loadConfig.scale),t=(new THREE.Matrix4).compose(i,r,a)}this.setTransformMatrix(t)}calculateClippingIds(){}load(e){}prepare(e,t){}isEmptyScene(){return!1}isLayerData(){return!1}isLoaded(){return!0}isDataReady(){return!0}isVisible(){return this.visible}setVisible(e){this.visible=e}isUseable(){return this.isLoaded()&&this.isVisible()}isCulled(){return!0}getTransforms(){return this.transformInfos}getStatistics(){return this.statistics}getBoundingBoxWorld(){return this.getTransforms().boundingBox}getRawBoundingBox(){return this.getTransforms().boundingBox}applyFilter(){}applySelection(){}clearSelection(){}applyHover(){}clearHover(){}applyBlink(){}clearBlink(){}applyReplacement(){}getId(){return this.id}getDatabagId(){return this.databagId}getEncodedDatabagId(){return this.databagId}getOctreeRoots(e){}updateOctreeNode(e){}disposeBufferAfterVbo(){}setRenderableCount(e){}updateMeshNodes(){}getNodeInfosByUserId(e){return[]}getAllNodeInfos(){return{}}getMaterialByMaterialId(e){return null}updateMaterialsValue(e,t,i,r){}updateMaterials(){}switchNewStyleMaterial(e){}changeAllMaterials(e){}getImageByUrl(e){}getMeshesForCap(e,t){}getWireframeElementCount(){return 0}getCameraNameList(){return[]}getCamera(e){return null}calculateCameraModelRelation(e){this.containsCamera=!1}isUserIdExist(e){return!1}hasUserId(e){return!1}isHiddenUserId(e){return!1}hasTransforms(){return!0}explode(){}getFilter(){return this.filter}getModelManager(){return this.manager}isDestroyed(){return this.destroyed}getPickingMeshes(e,t,i,r,a){}getBlinkMaterials(){return[]}getLoadedUserIdsObject(){return null}dispatchEvent(e){}enableColorWithoutLight(e){}adjustVisibility(e){}changeVisibilityOfSelectedObjects(e){}changeVisibilityOfNonSelectedObjects(e){}adjustInstanceVisibility(e){}changeInstanceVisibilityOfSelectedObjects(e){}changeInstanceVisibilityOfNonSelectedObjects(e){}restoreVisibilityOfObjects(){}calculateClippingContours(){}preUpdate(){}update(){}postUpdate(){}getTransformMatrix(){return this.transformMatrix.clone()}setTransformMatrix(e){this.transformMatrix.copy(e),this.applyLengthUnitsMatrix(this.transformMatrix),this.transformMatrixInverse.copy(this.transformMatrix).invert(),e.decompose(this.transform.translation,this.transform.rotation,this.transform.scale)}rotateOnBasePoint(e,t,i){let r=this.transform.rotation.clone().clone().invert(),a=this.transform.translation.clone(),n=(new THREE.Quaternion).setFromAxisAngle(t,i);this.transform.rotation.multiply(n);let s=e.clone().sub(a).applyQuaternion(r).applyQuaternion(this.transform.rotation);this.transform.translation.sub(s).add(e.clone().sub(a)),this.updateTransformMatrix()}scaleOnBasePoint(e,t){this.transform.scale.multiply(t);let i=t.clone().sub(new THREE.Vector3(1,1,1)),r=this.transform.rotation.clone(),a=r.clone().invert(),n=this.transform.translation.clone(),s=e.clone().sub(n).applyQuaternion(a).multiply(i).applyQuaternion(r);this.transform.translation.sub(s),this.updateTransformMatrix()}translate(e){this.transform.translation.add(e),this.updateTransformMatrix(),this.updateMatrix(),this.manager.updateSceneBoundingBox()}updateMatrix(){}updateTransformMatrix(){let e=this.transform.translation,t=this.transform.scale,i=this.transform.rotation;this.transformMatrix.compose(e,i,t),this.applyLengthUnitsMatrix(this.transformMatrix),this.transformMatrixInverse.copy(this.transformMatrix).invert()}getBoundaryPoints(){let e=this.getRawBoundingBox();const t=this.getTransformMatrix(),i=this.boundaryPoints;return i[0].set(e.min.x,e.min.y,e.min.z).applyMatrix4(t),i[1].set(e.max.x,e.min.y,e.min.z).applyMatrix4(t),i[2].set(e.max.x,e.max.y,e.min.z).applyMatrix4(t),i[3].set(e.min.x,e.max.y,e.min.z).applyMatrix4(t),i[4].set(e.min.x,e.min.y,e.max.z).applyMatrix4(t),i[5].set(e.max.x,e.min.y,e.max.z).applyMatrix4(t),i[6].set(e.max.x,e.max.y,e.max.z).applyMatrix4(t),i[7].set(e.min.x,e.max.y,e.max.z).applyMatrix4(t),i}getGeometryBuffersByUserId(e){return this._handler?this._handler.getGeometryBuffersByUserId(e):[]}getRealUserId(e){return e}setCastShadow(e){this.castShadow=e}setReceiveShadow(e){this.receiveShadow=e}enableLocalClippingMode(e){this.localClippingMode=e}clone(t,i){i=r.Utils.defaultValue(i,{});const a=r.Utils.defaultValue(i.modelId,this.databagId);return r.Utils.defined(t)||(t=new e({modelId:a})),t}_copy(e){this.manager=e.manager,this.transform={translation:e.transform.translation.clone(),rotation:e.transform.rotation.clone(),scale:e.transform.scale.clone()},this.emptyScene=e.emptyScene,this.statistics=r.Utils.clone(e.statistics,!0),this.transformInfos={octreeTransformed:e.transformInfos.octreeTransformed,boundingBox:e.transformInfos.boundingBox.clone(),position:e.transformInfos.position.clone(),rotation:e.transformInfos.rotation.clone(),scale:e.transformInfos.scale.clone(),transformMatrix:e.transformInfos.transformMatrix.clone()},this._config=r.Utils.clone(e._config,!0),this._unit=e._unit,this._sequence=e._sequence,this.modelExplosion=new r.BaseModelExplosion(this)}isVisibleMesh(e){return!0}getDefaultUnit(){return r.EnumLengthlUnits.Meter}getUnit(){return this._unit}setLengthUnitsMatrix(e){e&&(this._lengthUnitsMatrix=e,this.updateTransformMatrix())}applyLengthUnitsMatrix(e){this._lengthUnitsMatrix&&e.multiply(this._lengthUnitsMatrix)}getLengthUnitsMatrix(){return this._lengthUnitsMatrix}getAllNodeGroups(){return this.objectGroup?this.objectGroup.children:[]}hideWireframeGroup(){const e=this.getAllWireframeGroupNames();this.getAllNodeGroups().forEach((t=>{if(this._isActiveNodeGroup(t))for(let i=0,r=e.length;i<r;i++)if(t.name===e[i]){t.visible=!1;break}}))}showWireframeGroup(){const e=this.getAllWireframeGroupNames();this.getAllNodeGroups().forEach((t=>{if(this._isActiveNodeGroup(t))for(let i=0,r=e.length;i<r;i++)if(t.name===e[i]){t.visible=!0;break}}))}hideExcludeWireframeGroup(){const e=this.getAllWireframeGroupNames();this.getAllNodeGroups().forEach((t=>{if(!this._isActiveNodeGroup(t))return;let i=!1;for(let r=0,a=e.length;r<a;r++)if(t.name===e[r]){i=!0;break}i||(t.visible=!1)}))}showExcludeWireframeGroup(){const e=this.getAllWireframeGroupNames();this.getAllNodeGroups().forEach((t=>{if(!this._isActiveNodeGroup(t))return;let i=!1;for(let r=0,a=e.length;r<a;r++)if(t.name===e[r]){i=!0;break}i||(t.visible=!0)}))}holdNodeGroupVisibility(){this.getAllNodeGroups().forEach((e=>{e._oriVisible=e.visible}))}resetNodeGroupVisibility(){this.getAllNodeGroups().forEach((e=>{e._oriVisible=void 0}))}_isActiveNodeGroup(e){return!!e._oriVisible}getAllWireframeGroupNames(){return[]}collectBlinkedMaterial(e,t){}getAllUserIds(){return[]}}r.BaseModel=e}(),r.TaskWorker=function(e,t){this.MaxThreadCount=e||8;var i=this;i.todoList={},i.todoCount=0,i.doingCount=0,this.hasTask=function(){return i.todoCount>0},this.addItem=function(e,t){i.todoList[e]=t,i.todoCount++},this.clearTasks=function(){i.todoList={},i.todoCount=0},this.run=function(e,i){var a=this;if(!(a.doingCount>0)){var n=[],s=a.todoList;for(var o in s)s.hasOwnProperty(o)&&n.push(o);a.todoList={},a.todoCount=0;var l=n.length;if(0!==l){i&&n.sort(i);var d=Math.min(this.MaxThreadCount,r.GlobalData.ConcurrencyRequestCount,l);a.doingCount=l;for(var h=0;h<d;++h)c(h)}}function c(i){if(i>=l)a.doingCount<1&&t();else{var r=n[i];e(r,i+d,c)}}}},r.TaskWorker2=function(e){this.MaxThreadCount=e||8,this.todoList=[],this.doingCount=0,this.addItem=function(e){void 0!==e&&this.todoList.push(e)},this.run=function(e,t,i){if(!(this.doingCount>0))if(0!==this.todoList.length){var a=this.todoList,n=a.length;this.todoList=[],this.doingCount=n;for(var s=Math.min(this.MaxThreadCount,r.GlobalData.ConcurrencyRequestCount,n),o=this,l=0;l<s;++l)d(l)}else i();function d(r){r>=n?o.doingCount<1&&(t(o.doingCount,n),i()):(t(o.doingCount,n),e(a[r],r+s,d))}}},r.TaskManager=function(){this.worker=new r.TaskWorker2(8)},r.TaskManager.prototype={constructor:r.TaskManager,addTask:function(e){this.worker.addItem(e)},processTasks:function(e,t,i){t=t||function(){},i=i||function(){};var r=this.worker;this.worker.run((function(t,i,a){e(t,(function(){--r.doingCount,a(i)}))}),t,i)}},function(){function e(e,t,i){if(!t.receiveIBL)return null;var a,n=r.MaterialUtil.getMaterialParameters(t);return""!=t.defines.USE_INSTANCE&&""!=t.defines.USE_INSTANCE_NORMAL||(n.defines=t.defines),i?(delete n.textureColor,delete n.pureColor,delete n.imageFade,n.lights=!0,(a=new V.IBLMaterial(n)).type="IBL",a.refreshUniforms()):(delete n.iblProbe,n.lights=!e.lightmap,(a=r.MaterialUtil.createStandardMaterial(n)).roughness=n.originRoughness,a.metalness=n.originMetalness,a.refreshUniforms()),a.name=t.name,a._primary=t._primary,a.overrideColor=t.overrideColor,n=null,a}r.MaterialManager=class{constructor(e){this.instanceMaterials={},this.materials={},this.textures={},this.lightmaps={},this.ensureImagePowerOfTwo=!1,this.handlerUrl=null,this.textureLoader=null,this.textureManager=new r.TaskManager,this.enableCompressedTexture=!1,this.enableSmallTexture=!1,this.enablePkgTexture=!1,this.enableTexturePkgGz=!0,this.enableOrgTexture=!1,this.enableDdsTexture=!1,this.texturePkgLoadState=void 0,this.textureCount=0,this.pkgTextureMap={},this.pkgTextureArrayBufferMap={},this.texturePkgMap={},this.delayLoadTexture=!1,this.delayMaxCount=50,this.pkgCount=0,this.pkgLoadedCount=0,this.pkgLoadedParseCount=10,this.taskRunner=new r.LoadTaskRunner(5),this.delayLoadedTextureMap={},this.parsedMaterialMap={},this.textureNameMap={},this.basisTextureLoader=r.MaterialUtil.getBasisTextureLoader(),this.viewer=e,this.alphaMapArray=[],this.materialParams={}}destroy(){this.instanceMaterials=null,this.materials=null,this.textures=null,this.lightmaps=null,this.textureCount=void 0,this.handlerUrl=null,this.textureLoader=null,this.textureConfig=null,this.textureManager=null,this.pkgTextureMap=null,this.pkgTextureArrayBufferMap=null,this.texturePkgMap=null,this.delayLoadTexture=void 0,this.delayMaxCount=void 0,this.pkgCount=void 0,this.pkgLoadedCount=void 0,this.taskRunner=null,this.textureNameMap=null,this.alphaMapArray=null,this.parsedMaterialMap=null}disposeInstanceMaterials(e){var t=this.instanceMaterials;for(var i in t){var r=t[i];if(r instanceof Array)for(var a=0,n=r.length;a<n;a++)r[a].dispose();else r.dispose()}}disposeMaterials(e){for(var t in this.materials)this.materials[t].dispose();this.disposeInstanceMaterials(e)}updateMaterialsValue(e,t,i,r){let a=(e,t,i,r)=>{e&&e.hasOwnProperty(t)&&(r&&0==e.receiveIBL||(e[t]=i,void 0!==e.refreshUniforms&&e.refreshUniforms(),e.needsUpdate=!0))},n=this.materials;for(const e in n){let s=n[e];a(s,t,i,r)}let s=this.instanceMaterials;for(const e in s){let n=s[e];if(n instanceof Array)for(let e=0,s=n.length;e<s;e++)a(n[e],t,i,r);else a(n,t,i,r)}e.filter.materialSelector.getCustomizedMaterials({override:!0,isolate:!0,frozen:!0}).map((e=>{a(e,t,i,r)}))}enableColorWithoutLight(e){var t,i=this.materials,r=this.instanceMaterials;if(e){for(var a in i)(t=i[a])&&(t.defines.USE_COLORWITHOUTLIGHT="",t.needsUpdate=!0);for(var a in r)if(t=r[a])if(t instanceof Array)for(var n=0,s=t.length;n<s;n++)t[n].defines.USE_COLORWITHOUTLIGHT="",t[n].needsUpdate=!0;else t.defines.USE_COLORWITHOUTLIGHT="",t.needsUpdate=!0}else{for(var a in i)(t=i[a])&&(delete t.defines.USE_COLORWITHOUTLIGHT,t.needsUpdate=!0);for(var a in r)if(t=r[a])if(t instanceof Array)for(n=0,s=t.length;n<s;n++)delete t[n].defines.USE_COLORWITHOUTLIGHT,t[n].needsUpdate=!0;else delete t.defines.USE_COLORWITHOUTLIGHT,t.needsUpdate=!0}}_onLoadTexture(e){this.textureCount--,this.textureCount<=0&&e&&e()}_loadTextureByCrypto(e,t,i,a){let n=null,s=THREE.DefaultLoadingManager.getHandler(e);if(null!==s)n=s.load(e,t);else{n=new THREE.Texture,n.src=e;const i=e.lastIndexOf("/"),o=e.substring(i+1);if(this.textureNameMap[o]=n,this.enablePkgTexture&&o in this.pkgTextureMap){const e=new THREE.FileLoader;e.setResponseType("arraybuffer");const i=this.handlerUrl.texturePkgFileName(r.Compatibility.useMergeTexturePkg,this.enableTexturePkgGz,this.pkgTextureMap[o].pkg,this.pkgTextureMap[o].type),s=this.handlerUrl.textureUrl(i),l=this.pkgTextureMap[o].offset,d=this.pkgTextureMap[o].length;if(i in this.pkgTextureArrayBufferMap){const e=this.pkgTextureArrayBufferMap[i].slice(l,l+d);this.creatTextureImage(n,e,t,a)}else e.load(s,(e=>{this.pkgTextureArrayBufferMap[i]=e;const r=e.slice(l,l+d);this.creatTextureImage(n,r,t,a)}),(e=>{void 0!==a&&a(e)}))}else{const i=i=>{const a=new Blob([i],{type:"jpeg"});let s=new Image;s.onload=function(){n.image=r.MaterialUtil.ensurePowerOfTwo(s),n.needsUpdate=!0,t&&t(n)},s.onerror=i=>{console.log(`${e} load failed`),t(n)},s.src=URL.createObjectURL(a)},o=e=>{void 0!==a&&a(e)},l=()=>new Promise(((t,i)=>{s=new TEST.CryptoResourceLoader,s.loadURL(e,t,i)}));r.Storage.IndexedDBHelper.loadWithStorage("ModelData",e,l,i,o)}}return n}_loadCompressedTexture(e,t,i,a){const n=(e=e.substring(0,e.lastIndexOf("."))+".dds").lastIndexOf("/"),s=e.substring(n+1),o=new THREE.DDSLoader;if(this.enableDdsTexture&&s in this.pkgTextureMap){const e=this.handlerUrl.texturePkgFileName(r.Compatibility.useMergeTexturePkg,this.enableTexturePkgGz,this.pkgTextureMap[s].pkg,this.pkgTextureMap[s].type),i=(this.handlerUrl.textureUrl(e),this.pkgTextureMap[s].offset),a=this.pkgTextureMap[s].length,n=this.pkgTextureArrayBufferMap[e].slice(i,i+a);o.loadBuffer(n,t)}else o.load(e,t,i,(e=>{void 0!==a&&a(e)}))}_loadBasisTexture(e,t,i,a){const n=(e=e.substring(0,e.lastIndexOf("."))+".basis").lastIndexOf("/"),s=e.substring(n+1),o=this.basisTextureLoader;if(o.detectedSupport||o.detectSupport(this.viewer.getRenderer()),s in this.pkgTextureMap){const e=this.handlerUrl.texturePkgFileName(r.Compatibility.useMergeTexturePkg,this.enableTexturePkgGz,this.pkgTextureMap[s].pkg,this.pkgTextureMap[s].type),i=(this.handlerUrl.textureUrl(e),this.pkgTextureMap[s].offset),a=this.pkgTextureMap[s].length,n=this.pkgTextureArrayBufferMap[e].slice(i,i+a),l=new Blob([n],{});if(o.supportsImageBitmap&&o.supportsImageBitmap(l)){const i=e;o.loadFromBlob(i,l,t)}else{const e=(window.URL||window.webkitURL).createObjectURL(l);o.load(e,t)}}else o.load(e,t,i,(e=>{void 0!==a&&a(e)}))}creatTextureImage(e,t,i,a){(new TEST.CryptoResourceLoader).load(t,(t=>{const n=new Blob([t],{type:"jpeg"});let s=new Image;s.onload=()=>{e.image=r.MaterialUtil.ensurePowerOfTwo(s),e.needsUpdate=!0,i&&i(e)},s.onerror=e=>{a&&a(e)},s.src=URL.createObjectURL(n)}))}_parseTextureJson(e,t,i,a){let n=[];const s=window.TEST||{},o=i.type,l=i.data;let d=t.textureUrl(l.sourceFile);const h=this.enableSmallTexture&&l.texture_small;if(this.textureLoader=null,l.basis)this.textureLoader=this._loadBasisTexture;else if(!h&&this.enableCompressedTexture&&l.dds)this.textureLoader=this._loadCompressedTexture;else if(s.CryptoResourceLoader&&(this.textureLoader=this._loadTextureByCrypto),h){const e=d.lastIndexOf(".");d=d.substring(0,e)+"_s"+d.substring(e)}this.textures[e.name]=n,this.textureLoader(d,(t=>{t.encoding=THREE.GammaEncoding,t.repeat.fromArray([l.scale[0],l.scale[1]]),t.offset.fromArray([l.offset[0],l.offset[1]]),t.rotation=THREE.Math.degToRad(l.angle),r.MaterialUtil.updateUVMatrix(t),l.repeatU&&(t.wrapS=THREE.RepeatWrapping),l.repeatV&&(t.wrapT=THREE.RepeatWrapping),t.texturetype=o,"reliefMap"==o&&(t.texturetype="bumpMap"),l.dataType&&"NormalMap"==l.dataType&&(t.texturetype="normalMap"),l.alpha&&"map"==o&&(t.texturetype="alphaMap"),null!=l.depth&&(t.depth=l.depth),t&&n.push(t),this._updateMaterialTexture(e,n),this._onLoadTexture(a)}),void 0,(()=>{this._updateMaterialTexture(e,n),this._onLoadTexture(a)}))}_updateMaterialTexture(e,t){if(t){if(void 0===t.length)e.map=t;else for(var i=0;i<t.length;i++){switch(!this.ensureImagePowerOfTwo&&t[i].image&&(t[i]instanceof THREE.CompressedTexture?THREE.Math.isPowerOfTwo(t[i].image.width)&&THREE.Math.isPowerOfTwo(t[i].image.height)||console.log("Warning: THREE.CompressedTexture is not power of two."):t[i].image=r.MaterialUtil.ensurePowerOfTwo(t[i].image)),t[i].texturetype){case"map":e.map=t[i];break;case"bumpMap":e.bumpMap=t[i],null!=t[i].depth&&(e.bumpScale=t[i].depth);break;case"specularMap":e.specularMap=t[i];break;case"alphaMap":e.useAlphaMap=!0,e.alphaTest=.01,e.map=t[i],this._initAlphaMapProperty(e),this.alphaMapArray.push(e);break;case"emissiveMap":e.emissiveMap=t[i];break;case"environmentMap":e.envMap=t[i];break;case"normalMap":e.normalMap=t[i],t[i].depth&&e.normalScale.set(t[i].depth,t[i].depth);break;default:console.warn("This map type is not supported yet:",t[i].texturetype)}t[i].wrapS!=THREE.RepeatWrapping&&(e.useClampToBorder=!0)}e.refreshUniforms(),e.needsUpdate=!0}else e.textureColor&&e.color.setStyle(e.textureColor),e.needsUpdate=!0}updateTexturePkgMapping(e,t){!0===this.texturePkgLoadState&&(this._updateTextureMapping(e,t),t&&t()),void 0===this.texturePkgLoadState&&(this.texturePkgLoadState=!1,this._getPgkTexture((()=>{!0!==this.delayLoadTexture?(this.lastTextureEnabled=!1,this._updateTextureMapping(e,t),t&&t()):t&&t()})))}delayUpdateTexturePkgMapping(e,t){if(!1===this.delayLoadTexture)return void(t&&t());const i=new THREE.FileLoader;i.setResponseType("arraybuffer");for(let a=0;a<this.pkgCount;++a){const n=this.pkgTextureArrayBufferMap[a],s=this.handlerUrl.textureUrl(n);this.taskRunner.push(i,s,void 0,(i=>{this.pkgLoadedCount++,this.pkgTextureArrayBufferMap[n]=i.context;this.texturePkgMap[a].map((e=>{this.delayLoadedTextureMap[e]=!0})),this.pkgLoadedCount%this.pkgLoadedParseCount!=this.pkgLoadedParseCount-1&&this.pkgLoadedCount!==this.pkgCount||(this.lastTextureEnabled=!1,r.GlobalData.EnableTextureMapping=!0,this._updateTextureMapping(e,t))}))}}_parseMapTexture(e,t,i,r){for(let a=0,n=i.length;a<n;a++)this.textureCount++,this._parseTextureJson(e,t,i[a],r)}_createTextureMap(e){this.textures;const t=this.materials;let i=this.handlerUrl,a=this.textureDataArray;this.textureCount=0;for(const n in t){let s=t[n];if(s){const t=r.Utils.splitCombinedKeyString(n,"_")[0];let o=a[parseInt(t)];o&&this._parseMapTexture(s,i,o,e)}}}_updateTextureMapping(e,t){let i=r.GlobalData.EnableTextureMapping;this.ensureImagePowerOfTwo;if(this.lastTextureEnabled!==i){var a=this.textures,n=this.materials;let v=this.handlerUrl,y=this.textureDataArray;if(e)var s=e.manager.getMaterialOverrideSet(),o=s?s.materialsByName:null,l=s?s.textures:null;var d=this.instanceMaterials;let M=e=>{const t=e.data;let i=t.sourceFile;if(!0===t.basis){const e=i.lastIndexOf(".");return i=i.substring(0,e)+".basis",i}if(this.enableSmallTexture&&t.texture_small){const e=i.lastIndexOf(".");i=i.substring(0,e)+"_s"+i.substring(e)}return i};var h,c;if(i){for(h in this.textureCount=0,n)if(c=n[h]){var u=a[p=r.Utils.splitCombinedKeyString(h,"_")[0]];let e=y?y[parseInt(p)]:null;if(e&&this.delayLoadTexture){let i=!0;const r=e.length;for(let t=0;t<r;++t){const r=M(e[t]);i=i&&this.delayLoadedTextureMap[r]}i&&!this.parsedMaterialMap[p]&&(this.parsedMaterialMap[p]=!0,this._parseMapTexture(c,v,e,t));continue}if(!this.delayLoadTexture||this.delayLoadTexture&&!e||!0!==this.texturePkgLoadState){this._updateMaterialTexture(c,u);continue}}for(h in d)if(c=d[h]){u=a[p=r.Utils.splitCombinedKeyString(h,"_")[0]];var p,m=p.split("#")[0];if(l&&l[m]&&(u=l[m]),c instanceof Array)for(var f=0,g=c.length;f<g;f++)this._updateMaterialTexture(c[f],u);else this._updateMaterialTexture(c,u)}for(h in o)if(c=o[h]){u=l[m=h.split("#")[0]];this._updateMaterialTexture(c,u)}this.ensureImagePowerOfTwo=!0}else{for(h in n)(c=n[h])&&(c.map=null,c.needsUpdate=!0);for(h in d)if(c=d[h])if(c instanceof Array)for(f=0,g=c.length;f<g;f++)c[f].pureColor&&(c[f].color.setStyle(c[f].pureColor),c[f].map=null,c[f].needsUpdate=!0),c[f].map=null,c[f].needsUpdate=!0;else c.pureColor&&(c.color.setStyle(c.pureColor),c.map=null,c.needsUpdate=!0),c.map=null,c.needsUpdate=!0;for(h in o)(c=o[h])&&(c.map=null,c.needsUpdate=!0,c.pureColor&&c.color.setStyle(c.pureColor))}this.lastTextureEnabled=i}}updateMaterials(e){this._updateBasicMaterialsForIBL(e),this._updateInstanceMaterialsForIBL(e),this._updateFilterMaterialsForIBL(e)}_updateBasicMaterialsForIBL(e){const t=this.materials,i=Object.keys(t),r=e.manager.scene.IBLMaps;i.forEach((e=>{const i=t[e];i.IBLMaps=r,i.refreshUniforms()}))}_updateInstanceMaterialsForIBL(e){const t=this.instanceMaterials,i=Object.keys(t),r=e.manager.scene.IBLMaps;i.forEach((e=>{const i=t[e];i instanceof Array?i.forEach((e=>{e.IBLMaps=r,e.refreshUniforms()})):(i.IBLMaps=r,i.refreshUniforms())}))}_updateFilterMaterialsForIBL(e){const t=e.filter.materialSelector.getCustomizedMaterials({override:!0,isolate:!0,frozen:!0}),i=e.manager.scene.IBLMaps;t.forEach((e=>{e.IBLMaps=i,e.refreshUniforms()}))}_updateIBL(e){if(r.GlobalData.IBL){this.updateMaterials(e);var t=e.manager.viewer.getIBLManager().IBLParams;for(var i in t)this.updateMaterialsValue(e,i,t[i])}}_changeBasicMaterials(t,i){const r=this.materials;Object.keys(r).forEach((a=>{const n=r[a],s=e(t,n,i);s&&(r[a]=s)}))}_changeInstanceMaterials(t,i){const r=this.instanceMaterials;Object.keys(r).forEach((a=>{const n=r[a];if(n instanceof Array)n.forEach(((r,a)=>{const s=e(t,r,i);s&&(n[a]=s)}));else{const s=e(t,n,i);s&&(r[a]=s)}}))}_changeFilterMaterials(t,i){const r=t.filter.materialSelector.getAll();t.filter.materialSelector.getCustomizedMaterials({override:!0,isolate:!0,frozen:!0}).forEach((a=>{const n=e(t,a,i);n&&(r[a.name]=n)}))}changeAllMaterials(e,t){this._changeBasicMaterials(e,t),this._changeInstanceMaterials(e,t),this._changeFilterMaterials(e,t)}_switchNewStyleBasicMaterials(e,t){const i=this.materials;Object.keys(i).forEach((e=>{const a=i[e],n=r.MaterialUtil.getMaterialParameters(a),s=t?r.MaterialUtil.createNewStyleMaterial(n):r.MaterialUtil.createStandardMaterial(n);s.name=e,i[e]=s}))}_switchNewStyleInstanceMaterials(e,t){const i=this.instanceMaterials;Object.keys(i).forEach((e=>{const a=i[e];if(a instanceof Array)a.forEach(((e,i)=>{const n=r.MaterialUtil.getMaterialParameters(e),s=t?r.MaterialUtil.createNewStyleMaterial(n):r.MaterialUtil.createStandardMaterial(n);s.name=i,a[i]=s}));else{const n=r.MaterialUtil.getMaterialParameters(a),s=t?r.MaterialUtil.createNewStyleMaterial(n):r.MaterialUtil.createStandardMaterial(n);s.name=e,i[e]=s}}))}_switchNewStyleFilterMaterials(e,t){const i=e.filter.materialSelector.getAll();e.filter.materialSelector.getCustomizedMaterials({override:!0,isolate:!0,frozen:!0}).forEach((e=>{const a=r.MaterialUtil.getMaterialParameters(e),n=t?r.MaterialUtil.createNewStyleMaterial(a):r.MaterialUtil.createStandardMaterial(a);n.name=e.name,i[e.name]=n}))}switchNewStyleMaterial(e,t){this._switchNewStyleBasicMaterials(e,t),this._switchNewStyleInstanceMaterials(e,t),this._switchNewStyleFilterMaterials(e,t)}updateLightmapMaterial(e){if(!this.materials[e]){var t=this.materials,i=r.Utils.splitCombinedKeyString(e,"_"),a=i[0],n=i[1];if(n){var s=r.MaterialUtil.getMaterialParameters(t[a]);s.lights=!1;var o=this.lightmaps[n];s.lightMap=o,s.lightMapIntensity=r.GlobalData.LightmapIntensity,this.materials[e]=r.MaterialUtil.createStandardMaterial(s)}}}getInstanceMaterialById(e,t){if(this.instanceMaterials[e])return this.instanceMaterials[e];var i=r.Utils.splitCombinedKeyString(e,"_"),a=i[0],n=i[1],s=r.MaterialUtil.getMaterialParameters(t.manager.getOverrideMaterialByName(a)||this.getMaterialById(a)),o=s.transparent;if(t.lightmap&&n){s.lights=!1;var l=this.lightmaps[n];s.lightMap=l,s.lightMapIntensity=r.GlobalData.LightmapIntensity}var d=r.MaterialUtil.createInstanceMaterial(s,!0);d.transparent=!1,d.name=e;var h=r.MaterialUtil.createInstanceMaterial(s,!0);return h.transparent=!0,h.name=e,r.GlobalData.TranslucentDepthDisabled&&(h.depthWrite=!1),o===d.transparent?d._primary=!0:h._primary=!0,void 0===this.materials[e]&&(this.materials[e]=r.MaterialUtil.createStandardMaterial(s)),this.instanceMaterials[e]=[d,h],this.instanceMaterials[e]}getMaterialById(e){return this.materials[e]||r.MaterialUtil.getDefaultStandardMaterial()}_loadFileByPromise(e,t){let i=new THREE.FileLoader;return new Promise((function(a,n){r.Storage.IndexedDBHelper.loadWithStorage("ModelData",e,(()=>new Promise(((r,a)=>{i.setResponseType(t),i.load(e,r)}))),(e=>{"string"==typeof e?a(JSON.parse(e)):null==e.metadata?n(e):a(e)}))}))}_loadTexturePkgByIndex(e,t){const i=this.pkgTextureArrayBufferMap[e],a=this.handlerUrl.textureUrl(i),n=new THREE.FileLoader;r.Storage.IndexedDBHelper.loadWithStorage("ModelData",a,(()=>new Promise(((e,t)=>{n.setResponseType("arraybuffer"),n.load(a,e,void 0,t)}))),(e=>{this.pkgTextureArrayBufferMap[i]=e,t()}))}_getPgkTexture(e){if(!this.enablePkgTexture)return this._createTextureMap(e),void(this.texturePkgLoadState=!0);const t=this.handlerUrl;let i=[];this.pkgTextureMap={},this.texturePkgMap={};const a=1==this.enableTexturePkgGz?"gzip":"json",n=".gz"==r.GlobalData.ZipResourcePostfix?"gzip":"json";r.Compatibility.useMergeTexturePkg?i.push(this._loadFileByPromise(t.texturePkgIndexUrl(this.enableTexturePkgGz),a)):(this.enableOrgTexture&&i.push(this._loadFileByPromise(t.texturePkgOrgIndexUrl(),n)),this.enableSmallTexture&&i.push(this._loadFileByPromise(t.texturePkgSmallIndexUrl(),n))),Promise.all(i.map((e=>e.catch((e=>e))))).then((t=>{let i=0;for(const e in t)for(const a in t[e].textures){this.pkgTextureMap[a]=t[e].textures[a],null==this.pkgTextureMap[a].type&&(this.pkgTextureMap[a].type=t[e].metadata.type);const n=this.pkgTextureMap[a].pkg;void 0===this.texturePkgMap[n]?this.texturePkgMap[n]=[a]:this.texturePkgMap[n].push(a);const s=this.handlerUrl.texturePkgFileName(r.Compatibility.useMergeTexturePkg,this.enableTexturePkgGz,t[e].textures[a].pkg,t[e].metadata.type);s in this.pkgTextureArrayBufferMap||(this.pkgTextureArrayBufferMap[i]=s,this.pkgTextureArrayBufferMap[s]={},this.textureManager.addTask(i),i++)}if(this.pkgCount=i,i>this.delayMaxCount)return this.delayLoadTexture=!0,void(e&&e());this.textureManager.processTasks(this._loadTexturePkgByIndex.bind(this),void 0,(()=>{this.texturePkgLoadState=!0,this._createTextureMap(e)}))})).catch((function(e){console.log("promise reject failed reason",e)}))}getImageByUrl(e){const t=e.lastIndexOf("/"),i=e.substring(t+1),r=this.textureNameMap[i];return r&&r.image}_initAlphaMapProperty(e){e.forInstance||(e.transparent=e.opacity<1),e._transparent=e.transparent,e._transparent||(e.transparent=!1,e.blending=THREE.CustomBlending,e.blendSrc=THREE.SrcAlphaFactor,e.blendDst=THREE.OneMinusSrcAlphaFactor,e.blendSrcAlpha=THREE.OneFactor,e.blendDstAlpha=THREE.OneMinusSrcAlphaFactor,e.priorityOrderId=1)}updateAlphaMapProperties(e){const t=e?THREE.NormalBlending:THREE.CustomBlending,i=!!e,r=e?0:1;this.alphaMapArray.forEach((e=>{e._transparent||(e.transparent=i,e.blending=t,e.blendSrc=THREE.SrcAlphaFactor,e.blendDst=THREE.OneMinusSrcAlphaFactor,e.blendSrcAlpha=THREE.OneFactor,e.blendDstAlpha=THREE.OneMinusSrcAlphaFactor,e.priorityOrderId=r)}))}getBackMaterials(){if(this.backMaterials)return this.backMaterials;let e={},t=this.materials;for(const i in t){let r=t[i].clone();r.transparent=!1,r.useForCap=!0,r.uniforms.useForCap.value=!0,r.side=THREE.BackSide,r.shift=.5,r.uniforms.shift.value=.5,e[i]=r}let i=this.instanceMaterials,r={};for(const e in i){let t=i[e][0].clone();t.transparent=!1,t.useForCap=!0,t.uniforms.useForCap.value=!0,t.side=THREE.BackSide,t.shift=.5,t.uniforms.shift.value=.5,r[e]=t}return this.backMaterials={batchMaterials:e,instanceMaterials:r},this.backMaterials}storeMaterialParam(e){this.materialParams[e.name]||(this.materialParams[e.name]={color:e.color.clone(),opacity:e.opacity,transparent:e.transparent,map:e.map})}restoreMaterialParam(e){let t=this.materialParams[e.name];t&&(e.color.setRGB(t.color.r,t.color.g,t.color.b),e.opacity=t.opacity,e.transparent=t.transparent,e.map=t.map,e.needsUpdate=!0)}}}(),r.SourceObjectManager=class{constructor(){this.hiddenUserIdMap={}}destroy(){this.hiddenUserIdMap=null}hideByUserId(e,t,i){this.hiddenUserIdMap||(this.hiddenUserIdMap={}),this.hiddenUserIdMap[i]||(this.hiddenUserIdMap[i]={}),this.hiddenUserIdMap[i][e]=!!t}cancelHiddenByUserId(e){if(this.hiddenUserIdMap)for(const t in this.hiddenUserIdMap)delete this.hiddenUserIdMap[t][e]}cancelAllHidden(){this.hiddenUserIdMap=null}isHidden(e,t){if(!this.hiddenUserIdMap)return!1;if(t)return!!this.hiddenUserIdMap[t]&&this.hiddenUserIdMap[t][e];for(const t in this.hiddenUserIdMap)if(this.hiddenUserIdMap[t][e])return!0;return!1}hasHidden(){return!r.Utils.isEmptyObject(this.hiddenUserIdMap)}},function(){class e extends THREE.EventDispatcher{constructor(e){super(),r.GlobalData.IsMobile&&(r.GlobalData.maxObjectNumInPool=6e3,r.GlobalData.maxDrawCacheNum=4e3),this.viewer=e,this.scene=new r.Scene({gisMode:e.gisMode}),this.filterHelper=new r.ModelView.FilterHelper(this),this.filter=new r.ModelView.FilterDirector(this),this.interactionScene=new THREE.Scene,this.crossOrigin=!0,this.loadingModels={},this.materialPool=null,this.occlusionCamera=null,this.containsCamera=!1,this.highPriorityCategories={inner:{},outer:{}},this.octantToObjectMap={},this.sceneState=new r.SceneStateHelper(this),this.rotation=new THREE.Quaternion,this.boundingBox=new THREE.Box3,this.boundingBoxLast=void 0,this.IBLMaterial=!1,this.selectPriority=!0,this.materialOverrideSet=null,this._renderStateChanged=!1,this.explosionManager=new r.ExplosionManager(this),this.isDrawableModel=!1,this.filterApplied=!1,this.modelLoader=new r.ModelLoader,this.modelCollection=new r.ModelView.LayerCollection,this.blinkManager=new r.BlinkManager(this),this.rootMatrix=void 0,this.rootMatrixLast=void 0,this.firstLoadedBmdLayer=void 0,this.demLoaded=!1,this.tilesCacheScheduler=new r.TilesCacheScheduler({maximumMemoryUsage:e._options.maxMemoryUsage}),this._unifiedLengthUnits=r.GlobalData.SceneUnit,this._firstModelLoaded=!1,this.scratchVector=new THREE.Vector3,this.scratchBoundingBox=new THREE.Box3}destroy(){this.removeAllEventListener(),this.modelCollection.destroy(),this.blinkManager.destroy(),this.modelCollection=null,this.octantToObjectMap=null,this.materialPool&&(this.materialPool.destroy(),this.materialPool=null),this.occlusionCamera&&(this.occlusionCamera=null),this.loadOnDemandDirector&&(this.loadOnDemandDirector.destroy(),this.loadOnDemandDirector=null),this.highPriorityCategories=null,this.rotation=null,this.boundingBox=null,this.boundingBoxLast=void 0,this.scene.destroy(),this.scene=null,this.interactionScene=null,this.filter.destroy(),this.filter=null,this.sceneState.destroy(),this.sceneState=null,this.filterHelper.destroy(),this.filterHelper=null,this.explosionManager.destroy(),this.explosionManager=null,this.rootMatrix=void 0,this.rootMatrixLast=void 0,this.tilesCacheScheduler.destroy(),this.tilesCacheScheduler=void 0,this.viewer=void 0}getFilter(){return this.filter}getFilterHelper(){return this.filterHelper}removeAllEventListener(){this._listeners=void 0}_updateOcclusionCamera(e){var t=e.near,i=e.distanceFromWorldToDrawing(this.getMatrixWorldGlobal(),r.GlobalData.OcclusionDistanceToCamera);this.occlusionCamera?this.occlusionCamera.copy(e):this.occlusionCamera=e.clone(),this.occlusionCamera.setNearFar(t,i),this.occlusionCamera.updateMVP()}_clearMaterialPool(){this.materialPool&&this.materialPool.clear()}acquireMaterial(){return this.materialPool?this.materialPool.acquire():null}getObjectPool(){return this.scene.getObjectPool()}getFrustumFromOcclusionCamera(){return this.occlusionCamera.getFrustum(!1)}getOcclusionCamera(){return this.occlusionCamera}prepareScene(e,t){r.GlobalData.BatchMergeEnabled||(this.clearPool(),this.clearObjectRangeFromOctantMap()),r.GlobalData.OcclusionTranslucentEnabled&&(null==this.materialPool&&(this.materialPool=new r.ExpandableObjectPool,this.materialPool.init(r.MaterialEx,50)),this._clearMaterialPool(),this._updateOcclusionCamera(e)),this.modelCollection.traverse((i=>{i.isLoaded()&&!i.isEmptyScene()&&i.prepare(e,t)})),this.dealStateChanged()}clearPool(){this.scene.getObjectPool().clear()}clearObjectRangeFromOctantMap(){this.octantToObjectMap&&this.octantToObjectMap.pool&&(this.octantToObjectMap.pool={})}setDrawableModel(e){this.isDrawableModel=e}isDrawable(){return this.isDrawableModel}load(e,t,i){const a=this._preLoad(e);return r.Utils.isDefined(a)?(this._loadModels(a,t,i),a.modelId):null}_preLoad(e){let t=e.modelId;const i=r.Utils.clone(e,!0);if(i.notifyProgress=void 0===e.notifyProgress||e.notifyProgress,r.Utils.isDefined(t)){t=`${t}`;const e=this.modelCollection.getById(t);if(r.Utils.isDefined(e))return this.setDrawableModel(!0),e.isVisible()||(e.setVisible(!0),e.dispatchEvent({type:r.EVENTS.ON_LOAD_COMPLETE,modelId:t})),console.log(`[BIMFACE ERROR]: Failed to load model with id ${t}, a model with the same ID already exists`),null}else{t=e.modelFileId,t=r.Utils.isDefined(t)?`${t}`:r.Utils.getEncodedString(e.databagId);const i=this.modelCollection.getById(t);if(r.Utils.isDefined(i)){t=`${t}_${(new Date).getTime()}`}}return i.modelId=t,i.fileId=e.modelFileId||t,i}_loadModels(e,t,i){const a=this,{modelId:n}=e;return new Promise(((s,o)=>{this.modelLoader.load({viewer:this.viewer,manager:this,parameters:e,parseCfgFinish:t,debut:i},(function(t){a.modelCollection.add(t);const i=!r.Utils.isDefined(e.defaultVisible)||e.defaultVisible;t.setVisible(i),a.checkIfFirstLodedModelLayer({isBmdLayer:t.isBmdLayer,unit:t.getUnit()}),t.setLengthUnitsMatrix(a.getModelLengthUnitsMatrix(t)),delete a.loadingModels[n];const o=t.load(e.notifyProgress);o&&o.then((()=>{a.updateRenderLoopState(),s(t)})).catch((()=>{a.modelCollection.remove(n,!0),console.log(`[BIMFACE ERROR]:some error occurred when load config of model ${n}`)}))}),(function(){a.modelCollection.remove(n,!0),delete a.loadingModels[n],console.log(`[BIMFACE ERROR]:some error occurred when load model ${n}`)}))}))}_loadModelWithShell(e,t,i){if(!e.shell)return null;if(!e.shell.databagId)return null;const a=r.Utils.clone(e.shell,!0),n=void 0!==a.modelId?`${a.modelId}_shell`:`${r.Utils.getEncodedString(a.databagId)}_shell`;a.modelId=n,a.loadShell=!0,a.serverUrl=void 0!==a.serverUrl?a.serverUrl:e.serverUrl;const s=void 0===e.visible||e.visible,o=!s;return a.visible=s,a.notifyProgress=!1,e.visible=o,this._loadModels(a,t,i).then((r=>{this._loadModels(e,t,i).then((e=>{e.shellModel=r}))})).catch((()=>{this._loadModels(e,t,i),console.log(`can not load shell-${e.shell.databagId}`)})),n}setModelShellVisibility(e,t){var i=this.modelCollection.getById(e);i&&i.shellModel&&(t?(i.setVisible(!1),i.shellModel.setVisible(!0)):(i.setVisible(!0),i.shellModel.setVisible(!1)))}unload(e,t){e+="",this.modelCollection.remove(e,!0)&&(this.updateScene(),this.updateFilterManager(),this.getFilter().calculateVisibleComponentsBbox(),t&&t())}unloadAll(){const e=this.modelCollection.getIds();for(let t=0,i=e.length;t<i;++t)this.unload(e[t]);this.clearPool()}addModel(e){this.modelCollection.add(e)}removeModel(e){this.modelCollection.remove(e)}getModelIds(e){if(e){var t=[];return this.modelCollection.traverse((function(e){e.isUseable()&&t.push(e.id)})),t}return this.modelCollection.getIds()}setModelVisibility(e,t,i){var r=this.getModel(e);r&&(r.setVisible(t),i&&i())}updateScene(e,t){this._needUpdateScene()&&(t=r.Utils.defaultValue(t,{}),this.updateSceneBoundingBox(e),this.updateSceneRootMatrix(t.forceUpdate),this.updateSceneRenderable(),this.updateOctreeNode())}_needUpdateScene(){return this.modelCollection.some((e=>{if(!e.isEmptyScene()){let t=e.getBoundingBoxWorld();if(t&&!t.isEmpty())return!0}}))}_calculateSceneBoundingBox(){this.scratchBoundingBox.makeEmpty();const e=this.boundingBox.clone();e.makeEmpty();const t=[];if(this.modelCollection.traverse((i=>{if(i.isEmptyScene())return;if(i.loadMpkOnDemand)return void t.push(i);const a=i.getBoundingBoxWorld();a&&!a.isEmpty()&&(this.scratchBoundingBox.isEmpty()?(this.scratchBoundingBox.copy(a),i.id!=r.ObjectGroupType.TILEGROUP&&e.copy(a)):(this.scratchBoundingBox.union(a),i.id!=r.ObjectGroupType.TILEGROUP&&e.union(a)))})),this.hasLoadOnDemandDirector()){const t=this.getLoadOnDemandDirector().getBoundingBoxOnDemand();t&&(this.scratchBoundingBox.union(t),e.union(t))}else t.forEach((t=>{const i=t.getBoundingBoxWorld();i&&(this.scratchBoundingBox.union(i),e.union(i))}));this.scratchBoundingBox.isEmpty()&&(this.scratchBoundingBox=new THREE.Box3(new THREE.Vector3(-r.GlobalData.SceneSize,-r.GlobalData.SceneSize,-r.GlobalData.SceneSize),new THREE.Vector3(r.GlobalData.SceneSize,r.GlobalData.SceneSize,r.GlobalData.SceneSize)),e.copy(this.scratchBoundingBox)),this.boundingBox.copy(this.scratchBoundingBox),this.scene.setBoundingBoxWorld(this.scratchBoundingBox),this.scene.setBoundingBoxWorldWithoutDEM(e);let i=this.viewer.getUserInputEditor();i.resetMobileParamsByBox&&i.resetMobileParamsByBox(this.scratchBoundingBox)}updateSceneBoundingBox(e){if(r.Utils.isDefined(e)){const t=e.getBoundingBoxWorld();if(!r.Utils.isDefined(t))return;return this.scene.updateBoundingBoxWorld(t),e.id!=r.ObjectGroupType.TILEGROUP&&this.scene.updateBoundingBoxWorldWithoutDEM(t),this.boundingBox.expandByPoint(t.min),void this.boundingBox.expandByPoint(t.max)}this._calculateSceneBoundingBox()}updateSceneRootMatrix(e){var t=!1,i=new THREE.Matrix4,a=new THREE.Matrix4,n=new THREE.Quaternion;if(this.modelCollection.some((e=>{if(!e.isEmptyScene()&&e.hasTransforms())return n.copy(e.getTransforms().rotation),i.copy(e.getTransforms().transformMatrix),t=e.getTransforms().octreeTransformed,!0})),e=r.Utils.defaultValue(e,!1),void 0===this.rootMatrix||e){if(this.scene.setTransformMatrixGlobal(i),t)a.copy(i);else{var s=new THREE.Vector3(1,1,1),o=r.GlobalData.SceneSize,l=this.boundingBox.getSize(this.scratchVector),d=o/Math.max(l.x,l.y,l.z);s.multiplyScalar(d),a.makeRotationFromQuaternion(n),a.scale(s)}this.rootMatrix=a}this.scene.updateWorldMatrixByMatrix(this.rootMatrix),this.traverseValidModels((function(e){e.updateMatrix()}))}updateSceneRenderable(){var e=r.GlobalData.maxObjectNumInPool,t=[],i=0;this.modelCollection.traverse((e=>{e.isEmptyScene()||(i+=e.getStatistics().renderableTotalForPool,t.push(e.id))}));for(var a=0,n=0,s=t.length;n<s;++n){var o=t[n],l=this.modelCollection.getById(o),d=Math.floor(l.getStatistics().renderableTotalForPool/i*e);d>l.getStatistics().renderableTotalForPool&&(d=l.getStatistics().renderableTotalForPool),l.setRenderableCount(d),a+=d}this.scene.resizePool(a>e?e:a)}getVisibleLayersBoundingBox(){const e=new THREE.Box3;return this.modelCollection.traverse((t=>{if(t.id==r.ObjectGroupType.TILEGROUP)return;if(!t.isCulled())return;if(t.isEmptyScene())return;const i=t.getBoundingBoxWorld();r.Utils.isDefined(i)&&(i.isEmpty()||(e.expandByPoint(i.min),e.expandByPoint(i.max)))})),e.applyMatrix4(this.scene.geometryGroup.matrix),e}updateOctreeNode(){this.modelCollection.traverse((e=>{e.isLoaded()&&!e.isEmptyScene()&&e.updateOctreeNode(!0)}))}updateMaterials(){this.modelCollection.traverse((e=>{e.isLoaded()&&!e.isEmptyScene()&&e.updateMaterials()}))}updateMaterialsValue(e,t,i){this.modelCollection.traverse((r=>{r.isLoaded()&&!r.isEmptyScene()&&r.updateMaterialsValue(e,t,i)})),this.materialOverrideSet&&this.materialOverrideSet.updateMaterialsValue(e,t)}enableColorWithoutLight(e){this.modelCollection.traverse((t=>{t.isLoaded()&&!t.isEmptyScene()&&t.enableColorWithoutLight(e)}))}switchNewStyleMaterial(e){this.modelCollection.traverse((t=>{t.isLoaded()&&!t.isEmptyScene()&&t.switchNewStyleMaterial(e)}))}changeAllMaterials(e){this.IBLMaterial!=e&&(this.modelCollection.traverse((t=>{t.isEmptyScene()||t.changeAllMaterials(e)})),this.IBLMaterial=e)}setCrossOrigin(e){this.crossOrigin=e}getMatrixWorldGlobal(){return this.scene.getMatrixWorldGlobal()}hasModel(){return this.modelCollection.some((e=>e.isLoaded()))}hasModelDataReady(){if(0===this.modelCollection.length)return!1;return!this.modelCollection.some((e=>!e.emptyScene&&!e.isDataReady()||e.emptyScene&&!1))}isLayerData(){return this.modelCollection.some((e=>e.isLayerData()))}getModel(e){return this.modelCollection.getById(e+"")}getFirstModel(){return this.modelCollection.getByIndex(0)}showOctreeBox(e){if(r.GlobalData.ShowOctant){var t=this.scene.getOrCreateObjectGroup(r.ObjectGroupType.OCTREENODE,{pickable:0,priority:2});function n(e){for(var i=0,a=e.childOctants.length;i<a;i++){var s=e.childOctants[i],o=new THREE.Box3(s.min,s.max),l=255;l<<=5*s.depth;var d=new r.BBoxNode(o,l);t.add(d),d.updateMatrixWorld(!0),n(s)}}if(t.visible=!0,0===t.children.length){var i=new THREE.Box3(e.min,e.max),a=new r.BBoxNode(i,16711680);t.add(a),a.updateMatrixWorld(!0),n(e)}}else this.scene.removeObjectGroupByName(r.ObjectGroupType.OCTREENODE)}setCategoriesToHighPriority(e,t){var i=e.length;if(!(i<1))for(var r=this.highPriorityCategories[t]={},a=0;a<i;++a)r[e[a]]=!0}getCategoriesFromHighPriority(e){return this.highPriorityCategories[e]}clearCategoriesFromHighPriority(e){this.highPriorityCategories[e]={}}clearAllCategoriesFromHighPriority(){this.clearCategoriesFromHighPriority("inner"),this.clearCategoriesFromHighPriority("outer")}calculateCameraModelRelation(e){var t=!1;this.modelCollection.traverse((i=>{i.isLoaded()&&!i.isEmptyScene()&&(i.calculateCameraModelRelation(e),t=t||i.containsCamera)})),this.containsCamera=t}getCameraNameList(){var e=[];return this.modelCollection.traverse((t=>{t.isEmptyScene()||(e=e.concat(t.getCameraNameList()))})),e}getCamera(e){var t=null;return this.modelCollection.some((i=>{if(!i.isEmptyScene()&&(t=i.getCamera(e)))return!0})),t}getNumOfElements(e){var t=0;if(e){var i=this.modelCollection.getById(e);i&&!i.isEmptyScene()&&(t+=i.getStatistics().numOfElements)}else this.modelCollection.traverse((e=>{e.isEmptyScene()||(t+=e.getStatistics().numOfElements)}));return t}getNumOfRenderables(e){var t=0;if(e){var i=this.modelCollection.getById(e);i&&!i.isEmptyScene()&&(t+=i.getStatistics().renderableTotal)}else this.modelCollection.traverse((e=>{e.isEmptyScene()||(t+=e.getStatistics().renderableTotal)}));return t}getNumOfTriangles(e){var t=0;if(e){var i=this.modelCollection.getById(e);i&&!i.isEmptyScene()&&(t+=i.getStatistics().numOfTriangles)}else this.modelCollection.traverse((e=>{e.isEmptyScene()||(t+=e.getStatistics().numOfTriangles)}));return t}getNumOfVertices(e){var t=0;if(e){var i=this.modelCollection.getById(e);i&&!i.isEmptyScene()&&(t+=i.getStatistics().numOfVertices)}else this.modelCollection.traverse((e=>{e.isEmptyScene()||(t+=e.getStatistics().numOfVertices)}));return t}getScene(){return this.scene}getOctreeRoots(){var e={};return this.modelCollection.traverse((t=>{if(t.isLoaded()&&!t.isEmptyScene()){var i=t.getEncodedDatabagId();e[i]=[],t.getOctreeRoots(e[i])}})),e}addMeshToOctantMap(e,t,i){var r=this.octantToObjectMap;r[e]||(r[e]={}),r[e].mesh||(r[e].mesh={}),r[e].mesh[t]||(r[e].mesh[t]=[]),r[e].mesh[t].push(i)}addNodeInfoToOctantMap(e,t,i){var r=this.octantToObjectMap;r[e]||(r[e]={}),r[e].info||(r[e].info={}),r[e].info[t]||(r[e].info[t]=[]),r[e].info[t].push(i)}removeNodeInfoFromOctantMap(e,t){var i=this.octantToObjectMap;if(i[e]&&i[e].info&&i[e].info[t.cellId])for(var r=i[e].info[t.cellId],a=r.length-1;a>=0;a--)if(t.nodeId===r[a].nodeId){r.splice(a);break}}clearNodeInfosFromOctantMap(e){var t=this.octantToObjectMap;t[e]&&t[e].info&&(t[e]=null)}removeAllFromOctantMap(e){var t=this.octantToObjectMap;t[e]&&delete t[e]}clearMeshFromOctantMap(e){var t=this.octantToObjectMap;t[e]&&t[e].mesh&&delete t[e].mesh}removeMeshFromOctantMap(e,t){var i=this.octantToObjectMap;if(i[e]&&i[e].mesh&&i[e].info){var r,a=i[e].info[t.cellId];for(r=a.length-1;r>=0;r--)if(t.nodeId===a[r].nodeId){a.splice(r);break}i[e].mesh[t.nodeId]&&delete i[e].mesh[t.nodeId]}}getOctantMap(){return this.octantToObjectMap}isFilterApplied(){return this.filterApplied}setFilterApplied(e){this.filterApplied=e}applyFilter(e){if(void 0===e)this.traverseValidModels((function(e){e.applyFilter()}));else{var t=this.getModel(e);t&&t.applyFilter()}this.setFilterApplied(!0)}applySelection(e){if(this.selectPriority=!0,void 0===e)this.traverseValidModels((function(e){e.applySelection()}));else{var t=this.getModel(e);t&&t.applySelection()}}clearSelection(e){if(this.selectPriority=!0,void 0===e)this.traverseValidModels((function(e){e.clearSelection()}));else{var t=this.getModel(e);t&&t.clearSelection()}}applyHover(e){if(r.GlobalData.Hover)if(void 0===e)this.traverseValidModels((function(e){e.applyHover()}));else{var t=this.getModel(e);t&&t.applyHover()}}clearHover(e){if(r.GlobalData.Hover)if(void 0===e)this.traverseValidModels((function(e){e.clearHover()}));else{var t=this.getModel(e);t&&t.clearHover()}}chooseRendering(e,t,i){if(!this.firstChooseRendering){if(this.firstChooseRendering=!0,t)return r.GlobalData.DynamicScheduling=!0,r.GlobalData.BatchMergeEnabled=!0,void(r.GlobalData.IncrementRender=!1);switch(console.log("Maximum Memory (M):",e.maxMemorySize),r.GlobalData.Renderer){case r.EnumRendererType.FULL:r.GlobalData.BatchMergeEnabled=!0,r.GlobalData.IncrementRender=!1;break;case r.EnumRendererType.INCREMENT:r.GlobalData.BatchMergeEnabled=!1,r.GlobalData.IncrementRender=!0;break;default:if(r.GlobalData.BatchMergeEnabled=!1,r.GlobalData.IncrementRender=!0,r.Compatibility.isUseDoubleMatrix(i.metadata.version)&&r.Compatibility.isUseINCREMENTByBmpkCount(i.metadata.bmpks,i.metadata.mpks))break;e.maxMemorySize<=r.GlobalData.MaxMemeorySizeToFullRender&&(r.GlobalData.BatchMergeEnabled=!0,r.GlobalData.IncrementRender=!1)}}}isUserIdExist(e,t){if(void 0===t)return this.modelCollection.some((t=>t.isUserIdExist(e)));const i=this.getModel(t);return!(!i||!i.isUserIdExist(e))}getNodeInfosByUserId(e,t){var i;return this.filterHelper.executeId(e,((e,t)=>{i&&0!==i.length||(i=e.getNodeInfosByUserId(t))}),t),i&&i.length>0?i:null}getNodeInfos(){let e={};return this.modelCollection.traverse((t=>{t.updateNodeInfosForPlugins&&t.updateNodeInfosForPlugins();let i=t.getAllNodeInfos();i&&(e[t.id]=i)})),e}getMaterialByNodeId(e,t,i){var r=this.modelCollection.getById(e);if(!r)return null;for(var a=r.getNodeInfosByUserId(t),n=-1,s=0,o=a.length;s<o;s++)if(a[s].nodeId===i){n=s;break}return-1!==n?r.getMaterialByMaterialId(a[n].materialId):null}getImageByUrl(e){const t=this.modelCollection._layers;for(let i=0;i<t.length;i++){if(!t[i].dataUrl)continue;const r=e.lastIndexOf("/")-8;if(e.substring(0,r)!=t[i].dataUrl.databagPath)continue;const a=t[i].getImageByUrl(e);if(a)return a}return null}getNodeInfoByNodeId(e,t,i){var r=this.modelCollection.getById(e);if(!r)return null;for(var a=r.getNodeInfosByUserId(t),n=-1,s=0,o=a.length;s<o;s++)if(a[s].nodeId===i){n=s;break}return-1!==n?a[n]:null}getComponentInfoByUserId(e,t){var i=this.getNodeInfosByUserId(e,t);if(i&&i.length>0){for(var r=new THREE.Box3,a=[],n=0,s=i.length;n<s;n++){let e=i[0].transformMatrix||new THREE.Matrix4,t=i[n].boundingBox.clone().applyMatrix4(e);r.union(t),-1===a.indexOf(i[n].materialId)&&a.push(i[n].materialId)}return{userId:e,state:0,materials:a,boundingBox:r,userData:i[0].userData}}return null}getBoundingBoxByIds(e,t){var i=this.viewer,a=new THREE.Box3;for(var n in e)if(!this.isHiddenUserId(n)){var s=this.getComponentInfoByUserId(n,t);if(s)a.union(s.boundingBox);else{var o=r.ExtrudeBodyManager.getInstance(i).getNode(n);if(o){var l=o.geometry.boundingBox.clone();o.matrix&&l.applyMatrix4(o.matrix),a.union(l)}}}return a}createMaterialOverrideSet(e,t){this.materialOverrideSet=new r.MaterialOverriderSet(e,t),r.GlobalData.EnableTextureMapping=!0}getMaterialOverrideSet(){return this.materialOverrideSet}getOverrideMaterialByNodeInfo(e,t){return this.materialOverrideSet?this.materialOverrideSet.getOverrideMaterialByNodeInfo(e,t):null}getOverrideMaterialByName(e){return this.materialOverrideSet?this.materialOverrideSet.getOverrideMaterialByName(e):null}loadOverrideMaterialsByDemand(e,t){if(this.materialOverrideSet){var i=this.getConditions();this.materialOverrideSet.loadByDemand(i,e,t)}else t&&t()}getConditions(){let e={},t={},i={};return this.modelCollection.traverse((r=>{const a=r.getAllNodeInfos();if(a)for(const r in a)if(a.hasOwnProperty(r))for(let n=0,s=a[r].length;n<s;n++){const s=a[r][n].userData;t[a[r][n].userId]=!0,i[s.systemTypeId]=!0,e[s.familyId]=!0}})),{familyIds:e,elementIds:t,systemTypeIds:i}}isHiddenUserId(e){return this.modelCollection.some((t=>t.isHiddenUserId(e)))}updateMeshNodes(){r.GlobalData.BatchMergeEnabled&&this.modelCollection.traverse((e=>{!e.isEmptyScene()&&e.isLoaded()&&e.updateMeshNodes()}))}getMinDistanceObjects(e,t){var i={},{modelId:a,objectId:n}=this.filterHelper.distributeId(e),{modelId:s,objectId:o}=this.filterHelper.distributeId(t);if(a&&s&&a===s){var l=this.modelCollection.getById(a);l.minDistanceObjects={},l.getMeshesByUserIds(n,o),l.minDistanceObjects[n].length>0&&l.minDistanceObjects[o].length>0&&(i[e]=l.minDistanceObjects[n],i[t]=l.minDistanceObjects[o])}else{if(a){var d=this.modelCollection.getById(a);d.minDistanceObjects={},d.getMeshesByUserIds(n,n),d.minDistanceObjects[n].length>0&&(i[e]=d.minDistanceObjects[n])}if(s){var h=this.modelCollection.getById(s);h.minDistanceObjects={},h.getMeshesByUserIds(o,o),h.minDistanceObjects[o].length>0&&(i[t]=h.minDistanceObjects[o])}if(a&&s||this.modelCollection.traverse((r=>{"ExtrudeBodyManager"!==r.id&&"ExternalComponent"!==r.id&&(r.minDistanceObjects={},r.getMeshesByUserIds(n,o),!i[e]&&r.minDistanceObjects[n].length>0&&(i[e]=r.minDistanceObjects[n]),!i[t]&&r.minDistanceObjects[o].length>0&&(i[t]=r.minDistanceObjects[o]))})),!i[e]||!i[t]){function g(e,t,r){var a={};a.mesh=e;var n=new THREE.Matrix4;r?n.multiplyMatrices(r,e.matrix):n=e.matrix,a.matrix=n;var s=e.geometry.boundingBox;s||(e.geometry.computeBoundingBox(),s=a.mesh.geometry.boundingBox);var o=s.clone().applyMatrix4(n);a.boundingBox=o,i[t]||(i[t]=[]),i[t].push(a)}var c=this.scene.getObjectGroup("ExternalComponentManager");if(!c)return;for(var u=c.children,p=0,m=u.length;p<m;p++){var f=u[p];f.name!=e&&f.name!=t||(r.Utils.isGroupObject(f)?f.traverseVisible((function(e){r.Utils.isMeshObject(e)&&g(e,f.name,f.matrix)})):g(f,f.name))}}}return i[e]&&i[t]?i:null}adjustVisibility(e){r.GlobalData.BatchMergeEnabled&&this.modelCollection.traverse((t=>{t.adjustVisibility&&t.adjustVisibility(e)}))}changeVisibilityOfSelectedObjects(e){r.GlobalData.BatchMergeEnabled&&this.modelCollection.traverse((t=>{t.changeVisibilityOfSelectedObjects&&t.changeVisibilityOfSelectedObjects(e)}))}changeVisibilityOfNonSelectedObjects(e){r.GlobalData.BatchMergeEnabled&&this.modelCollection.traverse((t=>{t.changeVisibilityOfNonSelectedObjects&&t.changeVisibilityOfNonSelectedObjects(e)}))}adjustInstanceVisibility(e){r.GlobalData.BatchMergeEnabled&&this.modelCollection.traverse((t=>{t.adjustInstanceVisibility&&t.adjustInstanceVisibility(e)}))}changeInstanceVisibilityOfSelectedObjects(e){r.GlobalData.BatchMergeEnabled&&this.modelCollection.traverse((t=>{t.changeInstanceVisibilityOfSelectedObjects&&t.changeInstanceVisibilityOfSelectedObjects(e)}))}changeInstanceVisibilityOfNonSelectedObjects(e){r.GlobalData.BatchMergeEnabled&&this.modelCollection.traverse((t=>{t.changeInstanceVisibilityOfNonSelectedObjects&&t.changeInstanceVisibilityOfNonSelectedObjects(e)}))}adjustDemVisibility(e){r.GlobalData.BatchMergeEnabled&&this.modelCollection.traverse((t=>{t.isDemLayer&&t.tileManager&&(e?t.tileManager.showAllLayers(!0):t.tileManager.hideAllLayers(!1))}))}restoreVisibilityOfObjects(){r.GlobalData.BatchMergeEnabled&&this.modelCollection.traverse((e=>{e.restoreVisibilityOfObjects&&e.restoreVisibilityOfObjects()}))}isSelectPriority(){return this.selectPriority}getSceneState(){return this.sceneState}disposeBufferAfterVbo(){r.GlobalData.EnableDisposeBufferAfterVbo&&this.modelCollection.traverse((e=>{e.disposeBufferAfterVbo()}))}getSourceObjectManager(){return this.sourceObjectManager||(this.sourceObjectManager=new r.SourceObjectManager),this.sourceObjectManager}isHiddenSourceObjectUserId(e,t){return!!this.sourceObjectManager&&this.sourceObjectManager.isHidden(e,t)}hasHiddenSourceObjectUserId(){return!!this.sourceObjectManager&&this.sourceObjectManager.hasHidden()}traverseModels(e,t){this.modelCollection.traverseIf(e,t)}traverseLoadedModels(e){this.traverseValidModels(e)}traverseValidModels(e){this.viewer.globalRendering||this.modelCollection.traverse((t=>{t.isUseable()&&e(t)}))}dealStateChanged(){if(this.hasModelDataReady()&&(this.isRenderStateChanged()||this.filter.isStateChanged()||this.filter.isTileLoadedStateChanged())){if(this.isRenderStateChanged()&&this.setRenderStateChanged(!1),this.filter.isStateChanged()||this.filter.isTileLoadedStateChanged())r.GlobalData.EnableShadowMap&&this.viewer.updateShadowMap(),(e=this.scene.fillClipPlane)&&e.update(),this._updateMaterialProperties(),this.filter.disableStateChanged(),this.filter.disableTileLoadedStateChanged();if(this.filter.isVisibleStateChanged()){var e=this.scene.fillClipPlane,t=this.scene.clipPlanes,i=e&&e.isEnabled()?e:t;i&&r.GlobalData.ClippingCapsType>0&&(i.clearCapsWireframe(),i.reCalculateClippingIds(!0))}this.applyFilter(),this.viewer.viewshedManager&&this.viewer.viewshedManager.update()}}_updateMaterialProperties(){this._updateExposureShift()}_updateExposureShift(){const e=this.viewer.getExposureShift();void 0!==e&&this.setExposureShift(e)}setExposureShift(e){const t=e>0?-.4*e+.5:-4*e+.5;this.updateMaterialsValue("shift",t)}setRenderStateChanged(e){this._renderStateChanged=e}isRenderStateChanged(){return this._renderStateChanged}hasLoadOnDemandDirector(){return!!this.loadOnDemandDirector}getLoadOnDemandDirector(){return this.loadOnDemandDirector||(this.loadOnDemandDirector=new r.LoadOnDemandDirector(this)),this.loadOnDemandDirector}checkLayerDataLoading(){return!!(this.isLayerData()&&this.hasLoadOnDemandDirector()&&this.getLoadOnDemandDirector().isLoading())&&(this.filter.isStateChanged()&&this.filter.disableStateChanged(),!0)}updateFilterManager(){var e=this.getNodeInfos(),t=this.getFilter();t.clearFilterManager(),t.initFilterManager(e),t.isStateChanged()&&t.disableStateChanged(),this.updateMeshNodes(),this.applyFilter()}isDrawingBoardlineEnabled(){return!(!r.GlobalData.DrawingBoardlineEnabled||r.GlobalData.DrawingStyle!==r.DrawingStyle.BOARDLINE&&r.GlobalData.DrawingStyle!==r.DrawingStyle.SHADINGWITHLINE)}isOnlyWireframe(){return r.GlobalData.DrawingStyle===r.DrawingStyle.BOARDLINE}calculateClippingIds(e,t){this.modelCollection.traverse((i=>{i.calculateClippingIds(e,t)}))}calculateClippingContours(e){this.modelCollection.traverse((t=>{t.calculateClippingContours(e)}))}getInstanceDepthMaterial(){if(this.instanceDepthMaterial)return this.instanceDepthMaterial;var e=new r.InstancedDepthMaterial;return e.depthPacking=THREE.RGBADepthPacking,this.instanceDepthMaterial=e,this.instanceDepthMaterial}createDemModel(e,t){if(this.removeModel(r.ObjectGroupType.TILEGROUP),e=e||{},!r.GlobalData.EnableLodDemDom&&!t){const t=new r.DemModel(this.viewer,this,{});return t.loadTile(this.viewer,e),this.addModel(t),t}const i=e.loadConfig?e:{loadConfig:e};i.manager=this,this.checkIfFirstLodedModelLayer({isDemLayer:!0});const a=r.ModelFactory.globe(this.viewer,i);return this.addModel(a),a.load(),a}createLineModel(e){const t=new r.LineModel(this.viewer,this,e);return this.addModel(t),t.load(),t}setDemLoadedState(e){this.demLoaded=e,this.updateRenderLoopState()}isSceneChanged(){return this.isRenderStateChanged()||this.filter.isStateChanged()}isMeterUnit(){const e=this.getSceneUnit();if(e)return e===r.EnumLengthlUnits.Meter;let t=!1;return this.modelCollection.traverse((e=>{e._config&&e._config.metadata&&("bimtile"===e._config.metadata.asset||"bimtiles"===e._config.metadata.asset||"m"===e._config.metadata.model_unit)&&(t=!0)})),t}isBimtilesAsset(){let e=!1;return this.modelCollection.traverse((t=>{t._config&&t._config.metadata&&("bimtile"===t._config.metadata.asset||"bimtiles"===t._config.metadata.asset)&&(e=!0)})),e}checkIfFirstLodedModelLayer(e){void 0===this.firstLoadedBmdLayer&&(this.firstLoadedBmdLayer=!!e.isBmdLayer,this._setDefaultSceneUnit(this.firstLoadedBmdLayer,e.unit),r.Tile.TileMath.unitScale=r.GlobalData.SceneUnit===r.EnumLengthlUnits.Millimeter?1e3:1)}updateRenderLoopState(){if(!this.viewer||!this.viewer.rendererManager)return;const e=this.viewer.rendererManager.renderer;e&&e.isBatched&&(this._isLoadedBmdModelOnly()?e.setRenderLoop(!1):e.setRenderLoop(!0))}_isLoadedBmdModelOnly(){return this.firstLoadedBmdLayer&&!this.demLoaded}_setDefaultSceneUnit(e,t){e||(t=r.EnumLengthlUnits.Meter),void 0===this.getSceneUnit()&&this.setSceneUnit(t)}setSceneUnit(e){r.GlobalData.SceneUnit=e}getSceneUnit(){return r.GlobalData.SceneUnit}getModelUnit(e){const t=this.getModel(e);return t?t.getUnit():this.getSceneUnit()}getModelLengthUnitsMatrix(e){const t=this.getSceneUnit()===r.EnumLengthlUnits.Meter;if(t!==(e.getUnit()===r.EnumLengthlUnits.Meter))return t?r.Utils.MatrixFromMillimeterToMeter:r.Utils.MatrixFromMeterToMillimeter}hasLoadedModel(){return this._firstModelLoaded}checkIfFirstModelLoaded(){this._firstModelLoaded||(this._firstModelLoaded=!0)}holdAllNodeGroupVisibility(){this.modelCollection.traverse((e=>{e.holdNodeGroupVisibility&&e.holdNodeGroupVisibility()}))}resetAllNodeGroupVisibility(){this.modelCollection.traverse((e=>{e.resetNodeGroupVisibility&&e.resetNodeGroupVisibility()}))}hideAllWireframes(){this.modelCollection.traverse((e=>{e.hideWireframeGroup&&e.hideWireframeGroup()}))}showAllWireframes(){this.modelCollection.traverse((e=>{e.showWireframeGroup&&e.showWireframeGroup()}))}hideAllExcludeWireframes(){this.modelCollection.traverse((e=>{e.hideExcludeWireframeGroup&&e.hideExcludeWireframeGroup()}))}showAllExcludeWireframes(){this.modelCollection.traverse((e=>{e.showExcludeWireframeGroup&&e.showExcludeWireframeGroup()}))}updateAlphaMapProperties(e){this.modelCollection.traverse((t=>{t.materialManager&&t.materialManager.updateAlphaMapProperties&&t.materialManager.updateAlphaMapProperties(e)}))}fireTilesLoadEvent(e){const t=this,i=this.tilesCacheScheduler,a=i._statistics,n=i._statisticsLast,s=a.numberOfTilesWithContentReady,o=a.numberOfPendingRequests,l=a.numberOfTilesProcessing,d=n.numberOfPendingRequests,h=n.numberOfTilesProcessing;n.copy(a);const c=o!==d||l!==h;c&&e.afterRenderFns.push((function(){t.dispatchEvent({type:r.EVENTS.ON_TILES_LOAD_PROGRESS,data:{numPendingRequests:o,numTilesProcessing:l}})}));const u=s>0;!this._initialTilesLoaded&&u&&(this._initialTilesLoaded=!0,e.afterRenderFns.push((function(){t.dispatchEvent({type:r.EVENTS.ON_TILES_LOAD_INITIAL})}))),this._tilesLoaded=0===a.numberOfPendingRequests&&0===a.numberOfTilesProcessing&&0===a.numberOfAttemptedRequests,c&&this._tilesLoaded&&e.afterRenderFns.push((function(){t.dispatchEvent({type:r.EVENTS.ON_TILES_LOAD_COMPLETE})}))}}r.ModelManager=e}(),r.ModelView.FilterDirector=class{constructor(e){this.modelManager=e,this.observerForSceneState=null,this.filterHelper=this.modelManager.getFilterHelper(),this.originOpacityMap={}}destroy(){this.modelManager=null,this.observerForSceneState=null,this.filterHelper=null,this.originOpacityMap=null}clear(e){if(void 0===e)this.modelManager.traverseValidModels((function(e){e.getFilter()&&e.getFilter().clear()}));else{var t=this.modelManager.getModel(e);t&&t.getFilter()&&t.getFilter().clear()}}setIsolateMaterial(e,t){if(void 0===t)this.modelManager.traverseValidModels((function(t){t.getFilter()&&t.getFilter().setIsolateMaterial(e)}));else{var i=this.modelManager.getModel(t);i&&i.getFilter()&&i.getFilter().setIsolateMaterial(e)}}resetIsolateMaterial(e){if(void 0===e)this.modelManager.traverseValidModels((function(e){e.getFilter()&&e.getFilter().resetIsolateMaterial()}));else{var t=this.modelManager.getModel(e);t&&t.getFilter()&&t.getFilter().resetIsolateMaterial()}}setFrozonMaterial(e,t){if(void 0===t)this.modelManager.traverseValidModels((function(t){t.getFilter()&&t.getFilter().setFrozonMaterial(e)}));else{var i=this.modelManager.getModel(t);i&&i.getFilter()&&i.getFilter().setFrozonMaterial(e)}}getFrozonMaterial(e){var t,i=[];if(void 0===e)this.modelManager.traverseValidModels((function(e){e.getFilter()&&(t=e.getFilter().getFrozonMaterial())&&i.push(t)}));else{var r=this.modelManager.getModel(e);r&&r.getFilter()&&(t=r.getFilter().getFrozonMaterial())&&i.push(t)}return i[0]}_getMaterialByName(e,t){var i,r=[];if(void 0===t)this.modelManager.traverseValidModels((function(t){t.getFilter()&&(i=t.getFilter()._getMaterialByName(e))&&r.push(i)}));else{var a=this.modelManager.getModel(t);a&&a.getFilter()&&(i=a.getFilter()._getMaterialByName(e))&&r.push(i)}return r[0]}_isolate(e,t,i){var a=e.getFilter();switch(i){case"hide":a.setIsolateConditions(t,r.EnumIsolateState.HIDDEN_OTHERS);break;case"translucent":a.setIsolateConditions(t,r.EnumIsolateState.TRANSLUCENT_OTHERS);break;default:console.log("no this isolate state : "+i)}}isolate(e,t,i){this.filterHelper.executeConditions(e,((e,i)=>{this._isolate(e,i,t)}),i)}setConditions(e,t,i){this.filterHelper.executeConditions(t,((t,i)=>{t.getFilter().setConditions(e,i)}),i)}setWireFrameVisibilityCondition(e,t){const i=this.modelManager.getModel(t);i&&i.getFilter()&&i.getFilter().setWireFrameVisibilityCondition(e)}isHidden(e,t){var i=!1;return this.filterHelper.executeId(e,((e,t)=>{i||(i=e.getFilter().isHidden(t))}),t),i}isFrozen(e,t){var i=!1;return this.filterHelper.executeId(e,((e,t)=>{i||(i=e.getFilter().isFrozen(t))}),t),i}isIsolate(e){var t=!1;if(void 0===e)this.modelManager.traverseModels((function(e){e.getFilter()&&(t=e.getFilter().isIsolate())}),(function(e){return t||!e.isUseable()}));else{var i=this.modelManager.getModel(e);i&&i.getFilter()&&(t=i.getFilter().isIsolate())}return t}isFiltering(e){var t=!1;if(void 0===e)this.modelManager.traverseModels((function(e){e.getFilter()&&(t=e.getFilter().isFiltering())}),(function(e){return t||!e.isUseable()}));else{var i=this.modelManager.getModel(e);i&&i.getFilter()&&(t=i.getFilter().isFiltering())}return t}getMatchIds(e,t){var i=[];return this.filterHelper.executeConditions(e,((e,t)=>{i=i.concat(e.getFilter().getMatchIds(t))}),t),i}isMatchConditions(e,t,i){var r=!1;return this.filterHelper.executeConditions(t,((t,i)=>{r=r||t.getFilter().getObjectInfoManager().isMatchConditions(e,i)}),i),r}deactivateByIds(e,t){this.filterHelper.executeIds(e,((e,t)=>{e.getFilter().deactivateByIds(t)}),t)}addAllComponentsToOverrideListByColor(e,t){var i=this.modelManager.getModel(t);this.filterHelper.executeIds(i.getAllUserIds(),((t,i)=>{t.getFilter().addToOverrideListWithAllIdsByColor(i,e)}),t)}addToOverrideListForAllWireFrame(e,t){var i=this.modelManager.getModel(t);this.filterHelper.executeIds(i.getAllUserIds(),((t,i)=>{t.getFilter().addToOverrideListForAllWireFrameByColor(i,e)}),t)}addToOverrideListForRestoreAllWireFrame(e){var t=this.modelManager.getModel(e);this.filterHelper.executeIds(t.getAllUserIds(),((e,t)=>{e.getFilter().addToOverrideListForAllWireFrameByColor(t,null)}),e)}addToOverrideListWithOpacityByConditions(e,t,i){var r=this;this.filterHelper.executeConditions(e,((e,a)=>{e.getFilter().addToOverrideListWithOpacityByConditions(r.modelManager,i,a,t)}),i)}_addToOverrideListAboutBimtilesByOpacity(e,t,i){let r={};for(let a=0;a<t.length;a++){let n=!0;const s=t[a];let o=null,l=null;const d=e.getFilter()._parseIds([s])[0],h=e.getFilter().getObjectInfoManager().getMaterial(d);if(h)o=h,o.originOpacity=h.opacity,o.name.indexOf("_opacity")<0&&(n=!1),o.map&&(l=o.map);else{const t=e.getNodeInfosByUserId(s);if(t&&t.length>0){l=null;for(let i=0;i<t.length;i++){const r=t[i],a=e.getMaterialByMaterialId(r.materialId,r);if(a){if(a.map){l=a.map,o=a;break}a.dispose()}}const i=t[0];o||(o=e.getMaterialByMaterialId(i.materialId,i),o.defines.CNORMAL="",o.useCompressedNormal=!0)}}if(o){const e=o.color.getHex();o.dispose();let t=e+"";l&&(t+="_"+l.uuid),n&&(t+="_opacity"),r[t]?r[t].ids.push(s):(r[t]={color:{color:e,opacity:i,useVertexColor:o.vertexColors},ids:[s]},n&&(r[t].color.setByOpacity=n),l&&(r[t].color.map=l)),l&&l.dispose(),l=null}}for(const t in r){const i=r[t];e.getFilter().addToOverrideListByColor(i.ids,i.color)}}addToOverrideListByColor(e,t,i){this.filterHelper.executeIds(e,((e,i)=>{e.getFilter().addToOverrideListByColor(i,t)}),i)}addToOverrideListByOpacity(e,t,i,a){let n=(e,i)=>{if(e&&e instanceof r.BimTilesModel){if(a){for(let r=0;r<i.length;r++)e.getFilter().addToModifyOpacityList(i[r],t);e.getFilter().enableStateChanged()}else this._addToOverrideListAboutBimtilesByOpacity(e,i,t);return}let n={};for(let r=0;r<i.length;r++){let a=!0;const s=i[r];let o=null,l=null;const d=e.getFilter().getObjectInfoManager().getMaterial(s);if(d)o=d,o.originOpacity=d.opacity,o.name.indexOf("_opacity")<0&&(a=!1,this.originOpacityMap[s]=d.opacity),o.map&&(l=o.map);else{const t=e._handler.getGeometryBuffersByUserId(s);if(t&&t.length>0){l=null;for(let e=0;e<t.length;e++){const i=t[e],r=this.modelManager.getMaterialByNodeId(i.databagId,s,i.nodeId);if(r.map){l=r.map,o=r;break}r.dispose()}const e=t[0];o||(o=this.modelManager.getMaterialByNodeId(e.databagId,s,e.nodeId))}}if(o){const e=o.color.getHex();o.dispose();let i=e+"";l&&(i+="_"+l.uuid),a&&(i+="_opacity"),n[i]?n[i].ids.push(s):(n[i]={color:{color:e,opacity:t},ids:[s]},a&&(n[i].color.setByOpacity=a),l&&(n[i].color.map=l)),l&&l.dispose(),l=null}}for(const t in n){const i=n[t];e.getFilter().addToOverrideListByColor(i.ids,i.color)}};if("conditions"===e.type){var s=e.param,o=(e,t)=>{e.getFilter().addToOpacityListByConditions(t,((t,i)=>{i&&n(e,t)}))};this.filterHelper.executeConditions(s,o,i)}else{var l=e.param;o=(e,t)=>{n(e,t)},this.filterHelper.executeIds(l,o,i)}}removeOverrideListByOpacity(e,t,i){let a=(e,a)=>{if(e&&e instanceof r.BimTilesModel){if(i)e.getFilter().removeModifyOpacityList(a),e.getFilter().enableStateChanged();else{let i=[];for(let t=0;t<a.length;t++){const r=a[t],n=e.getFilter()._parseIds([r])[0];let s=e.getFilter().getObjectInfoManager().getMaterial(n);s&&s.name.indexOf("_opacity")<0||i.push(r)}this.addToOverrideListByColor(i,null,t)}return}let n=[];for(let t=0;t<a.length;t++){const i=a[t];let s=e.getFilter().getObjectInfoManager().getMaterial(i);s&&s.name.indexOf("_opacity")<0?r.Utils.isDefined(this.originOpacityMap[i])&&(e.getFilter().addToOverrideListByColor([i],{color:s.color.getHex(),opacity:this.originOpacityMap[i]}),delete this.originOpacityMap[i]):n.push(i)}this.addToOverrideListByColor(n,null,t)};if("conditions"===e.type){const i=e.param,r=(e,t)=>{e.getFilter().addToOpacityListByConditions(t,((t,i)=>{i&&a(e,t)}))};this.filterHelper.executeConditions(i,r,t)}else{const i=e.param,r=(e,t)=>{a(e,t)};this.filterHelper.executeIds(i,r,t)}}addToOverrideListByMaterial(e,t,i){this.filterHelper.executeConditions(e,((e,i)=>{e.getFilter().addToOverrideListByMaterial(i,t)}),i)}addToOverrideListByConditions(e,t,i){this.filterHelper.executeConditions(e,((e,i)=>{e.getFilter().addToOverrideListByConditions(i,t)}),i)}addToOverrideListByMaterialAndId(e,t,i){this.filterHelper.executeIds(e,((e,i)=>{e.getFilter().addToOverrideListByMaterialAndId(i,t)}),i)}clearAllOverrideList(e){if(void 0===e)this.modelManager.traverseValidModels((function(e){e.getFilter()&&e.getFilter().clearAllOverrideList()}));else{var t=this.modelManager.getModel(e);t&&t.getFilter()&&t.getFilter().clearAllOverrideList()}}addToOverrideListForWireFrameByColor(e,t,i){this.filterHelper.executeIds(e,((e,i)=>{e.getFilter().addToOverrideListForWireFrameByColor(i,t)}),i)}addToOverrideListForWireFrameByConditions(e,t,i){this.filterHelper.executeConditions(e,((e,i)=>{e.getFilter().addToOverrideListForWireFrameByConditions(i,t)}),i)}addToLocalClippingList(e,t){var i=this,a=function(e,t){if(e&&e instanceof r.BimTilesModel)for(var a=e.getFilter().getLocalClippingList(),n=0;n<t.length;n++)a[s=t[n]]||e.getFilter().addToLocalClippingList(s);else if(e&&e.getFilter()&&e._handler)for(a=e.getFilter().getLocalClippingList(),n=0;n<t.length;n++){var s;if(!a[s=t[n]]){var o=e._handler.instancedManager.meshManager;o.traverseNodeIdxMapByUserId(s,(function(t,i){if(o.getInstanceGeometries(t)){var r=o.getMaterialIdByMeshId(t),a=e.materialManager.getInstanceMaterialById(r,e);if(a)if(a instanceof Array)for(var n=0;n<a.length;n++){var s=a[n];e.getFilter().addInstanceMaterialForClip(s.uuid,s)}else e.getFilter().addInstanceMaterialForClip(a.uuid,a)}}));var l=!0,d=i.modelManager.getNodeInfosByUserId(s,e.id);if(d)for(var h=0;h<d.length;h++)if(!d[h].instanceOrNot){l=!1;break}if(l)e.getFilter().addToLocalClippingList(s);else{var c=e._handler.getGeometryBuffersByUserId(s);if(c&&c.length>0)for(var u=0;u<c.length;u++){var p=c[u],m=i.modelManager.getMaterialByNodeId(p.databagId,s,p.nodeId);if(m){var f={};f.color=m.color.getHex(),f.opacity=m.opacity,f.side=m.side,m.map&&(f.map=m.map);var g=e.getWireframeMaterial(),v={};v.color=g.color.getHex(),v.opacity=g.opacity,v.side=g.side,e.getFilter().addToLocalClippingList(s,f,v,p.nodeId)}}}}}};if("conditions"===e.type){var n=e.param,s=(e,t)=>{e.getFilter().addToLocalClippingListByConditions(t,((t,i)=>{i&&a(e,t)}))};this.filterHelper.executeConditions(n,s,t)}else{var o=e.param;s=(e,t)=>{a(e,t)},this.filterHelper.executeIds(o,s,t)}}clearLocalClippingList(e){if(e){var t=this.modelManager.getModel(e);t&&t.getFilter()&&t.getFilter().clearLocalClippingList()}else this.modelManager.traverseValidModels((function(e){e.getFilter()&&e.getFilter().clearLocalClippingList()}))}addToIsolateList(e,t,i){this.filterHelper.executeIds(e,((e,i)=>{e.getFilter().addToIsolateList(i,t)}),i)}setIsolateConditions(e,t,i){this.filterHelper.executeConditions(e,((e,i)=>{e.getFilter().setIsolateConditions(i,t)}),i)}clearIsolation(e){if(void 0===e)this.modelManager.traverseValidModels((function(e){e.getFilter()&&e.getFilter().clearIsolation()}));else{var t=this.modelManager.getModel(e);t&&t.getFilter()&&t.getFilter().clearIsolation()}}clearAllIsolateConditions(e){if(void 0===e)this.modelManager.traverseValidModels((function(e){e.getFilter()&&e.getFilter().clearAllIsolateConditions()}));else{var t=this.modelManager.getModel(e);t&&t.getFilter()&&t.getFilter().clearAllIsolateConditions()}}showByIds(e,t){this.filterHelper.executeIds(e,((e,t)=>{e.getFilter().showByIds(t)}),t)}showByConditions(e,t){this.filterHelper.executeConditions(e,((e,t)=>{e.getFilter().showByConditions(t)}),t)}hideByIds(e,t){this.filterHelper.executeIds(e,((e,t)=>{e.getFilter().hideByIds(t)}),t)}hideByConditions(e,t){this.filterHelper.executeConditions(e,((e,t)=>{e.getFilter().hideByConditions(t)}),t)}hideOthersByConditions(e,t){this.filterHelper.executeConditions(e,((e,t)=>{e.getFilter().hideOthersByConditions(t)}),t)}showAll(e){if(void 0===e)this.modelManager.traverseValidModels((function(e){e.getFilter()&&e.getFilter().showAll()}));else{var t=this.modelManager.getModel(e);t&&t.getFilter()&&t.getFilter().showAll()}}hideAll(e){if(void 0===e)this.modelManager.traverseValidModels((function(e){e.getFilter()&&e.getFilter().hideAll()}));else{var t=this.modelManager.getModel(e);t&&t.getFilter()&&t.getFilter().hideAll()}}showScene(e){if(void 0===e)this.modelManager.traverseValidModels((function(e){e.getFilter()&&e.getFilter().showScene()}));else{var t=this.modelManager.getModel(e);t&&t.getFilter()&&t.getFilter().showScene()}}clearInactivatedIdMap(e){if(void 0===e)this.modelManager.traverseValidModels((function(e){e.getFilter()&&e.getFilter().clearInactivatedIdMap()}));else{var t=this.modelManager.getModel(e);t&&t.getFilter()&&t.getFilter().clearInactivatedIdMap()}}makeTranslucentByIds(e,t){this.filterHelper.executeIds(e,((e,t)=>{e.getFilter().makeTranslucentByIds(t)}),t)}makeTranslucentByConditions(e,t){this.filterHelper.executeConditions(e,((e,t)=>{e.getFilter().makeTranslucentByConditions(t)}),t)}makeTranslucentOthersByIds(e,t){this.filterHelper.executeIds(e,((e,t)=>{e.getFilter().makeTranslucentOthersByIds(t)}),t)}opaqueByIds(e,t){this.filterHelper.executeIds(e,((e,t)=>{e.getFilter().opaqueByIds(t)}),t)}opaqueByConditions(e,t){this.filterHelper.executeConditions(e,((e,t)=>{e.getFilter().opaqueByConditions(t)}),t)}opaqueAll(e){if(void 0===e)this.modelManager.traverseValidModels((function(e){e.getFilter()&&e.getFilter().opaqueAll()}));else{var t=this.modelManager.getModel(e);t&&t.getFilter()&&t.getFilter().opaqueAll()}}_hasVisibleFilter(e){var t=!1;if(void 0===e)this.modelManager.traverseModels((function(e){e.getFilter()&&(t=e.getFilter()._hasVisibleFilter())}),(function(e){return t||!e.isUseable()}));else{var i=this.modelManager.getModel(e);i&&i.getFilter()&&(t=i.getFilter()._hasVisibleFilter())}return t}_hasPickableFilter(e){var t=!1;if(void 0===e)this.modelManager.traverseModels((function(e){e.getFilter()&&(t=e.getFilter()._hasPickableFilter())}),(function(e){return t||!e.isUseable()}));else{var i=this.modelManager.getModel(e);i&&i.getFilter()&&(t=i.getFilter()._hasPickableFilter())}return t}_hasHiddenFileIdFilter(e){var t=!1;if(void 0===e)this.modelManager.traverseModels((function(e){e.getFilter()&&(t=e.getFilter()._hasHiddenFileIdFilter())}),(function(e){return t||!e.isUseable()}));else{var i=this.modelManager.getModel(e);i&&i.getFilter()&&(t=i.getFilter()._hasHiddenFileIdFilter())}return t}_hasOverrideMaterialFilter(e){var t=!1;if(void 0===e)this.modelManager.traverseModels((function(e){e.getFilter()&&(t=e.getFilter()._hasOverrideMaterialFilter())}),(function(e){return t||!e.isUseable()}));else{var i=this.modelManager.getModel(e);i&&i.getFilter()&&(t=i.getFilter()._hasOverrideMaterialFilter())}return t}_hasTransparentFilter(e){var t=!1;if(void 0===e)this.modelManager.traverseModels((function(e){e.getFilter()&&(t=e.getFilter()._hasTransparentFilter())}),(function(e){return t||!e.isUseable()}));else{var i=this.modelManager.getModel(e);i&&i.getFilter()&&(t=i.getFilter()._hasTransparentFilter())}return t}_hasOverrideMaterialFilterForWireFrame(e){var t=!1;if(void 0===e)this.modelManager.traverseModels((function(e){e.getFilter()&&(t=e.getFilter()._hasOverrideMaterialFilterForWireFrame())}),(function(e){return t||!e.isUseable()}));else{var i=this.modelManager.getModel(e);i&&i.getFilter()&&(t=i.getFilter()._hasOverrideMaterialFilterForWireFrame())}return t}_hasRenderWithBoardlineFilter(e){var t=!1;if(void 0===e)this.modelManager.traverseModels((function(e){e.getFilter()&&(t=e.getFilter()._hasRenderWithBoardlineFilter())}),(function(e){return t||!e.isUseable()}));else{var i=this.modelManager.getModel(e);i&&i.getFilter()&&(t=i.getFilter()._hasRenderWithBoardlineFilter())}return t}_isRenderWithBoardline(e,t){var i=!1;if(void 0===t)this.modelManager.traverseModels((function(t){t.getFilter()&&(i=t.getFilter()._isRenderWithBoardline(e))}),(function(e){return i||!e.isUseable()}));else{var r=this.modelManager.getModel(t);r&&r.getFilter()&&(i=r.getFilter()._isRenderWithBoardline(e))}return i}_isVisible(e,t){var i=!0;if(void 0===t)this.modelManager.traverseModels((function(t){t.getFilter()&&(i=t.getFilter()._isVisible(e))}),(function(e){return!i||!e.isUseable()}));else{var r=this.modelManager.getModel(t);r&&r.getFilter()&&(i=r.getFilter()._isVisible(e))}return i}_isPickable(e,t){var i=!0;if(void 0===t)this.modelManager.traverseModels((function(t){t.getFilter()&&(i=t.getFilter()._isPickable(e))}),(function(e){return!i||!e.isUseable()}));else{var r=this.modelManager.getModel(t);r&&r.getFilter()&&(i=r.getFilter()._isPickable(e))}return i}initFilterManager(e,t){if(void 0===t)this.modelManager.traverseValidModels((function(t){if(t.getFilter()){var i={};i[t.id]=e[t.id]||{},t.getFilter().initFilterManager(i)}}));else{var i=this.modelManager.getModel(t);if(i&&i.getFilter()){var r={};r[t]=e[t]||{},i.getFilter().initFilterManager(r)}}}reinitFilterManager(e,t){if(void 0===t)this.modelManager.traverseValidModels((function(t){if(t.getFilter()){var i={};i[t.id]=e[t.id]||{},t.getFilter().reinitFilterManager(i)}}));else{var i=this.modelManager.getModel(t);if(i&&i.getFilter()){var r={};r[t]=e[t]||{},i.getFilter().reinitFilterManager(r)}}}clearFilterManager(e){if(void 0===e)this.modelManager.traverseValidModels((function(e){e.getFilter()&&e.getFilter().clearFilterManager()}));else{var t=this.modelManager.getModel(e);t&&t.getFilter()&&t.getFilter().clearFilterManager()}}isStateChanged(e){var t=!1,i=this.modelManager;if(void 0===e)i.traverseModels((function(e){e.getFilter()&&(t=e.getFilter().isStateChanged())}),(function(e){return t||!e.isUseable()}));else{var r=i.getModel(e);r&&r.getFilter()&&(t=r.getFilter().isStateChanged())}return t}disableStateChanged(e){var t=this.modelManager;if(void 0===e)t.traverseValidModels((function(e){e.getFilter()&&e.getFilter().disableStateChanged()}));else{var i=t.getModel(e);i&&i.getFilter()&&i.getFilter().disableStateChanged()}}isVisibleStateChanged(e){var t=!1,i=this.modelManager;if(void 0===e)i.traverseModels((e=>{e.getFilter()&&(t=t||e.getFilter().isVisibleStateChanged())}));else{var r=i.getModel(e);r&&r.getFilter()&&(t=r.getFilter().isVisibleStateChanged())}return t}disableVisibleStateChanged(e){var t=this.modelManager;if(void 0===e)t.traverseValidModels((function(e){e.getFilter()&&e.getFilter().disableVisibleStateChanged()}));else{var i=t.getModel(e);i&&i.getFilter()&&i.getFilter().disableVisibleStateChanged()}}isTileLoadedStateChanged(e){let t=!1;const i=this.modelManager;if(void 0===e)i.traverseModels((e=>{e.getFilter()instanceof r.BimTileFilterManager&&(t=e.getFilter().isTileLoadedStateChanged())}),(e=>t||!e.isUseable()));else{const a=i.getModel(e).getFilter();a instanceof r.BimTileFilterManager&&(t=a.isTileLoadedStateChanged())}return t}disableTileLoadedStateChanged(e){const t=this.modelManager;if(void 0===e)t.traverseValidModels((e=>{const t=e.getFilter();t instanceof r.BimTileFilterManager&&t.disableTileLoadedStateChanged()}));else{const i=t.getModel(e).getFilter();i instanceof r.BimTileFilterManager&&i.disableTileLoadedStateChanged()}}calculateVisibleComponentsBbox(){this.modelManager.traverseValidModels((function(e){if(e.getFilter()){var t=!0;"ExternalComponent"==e.id&&(e.checkVisibleComponentsBox()||(t=!1)),t&&e.getFilter().getObjectInfoManager().calculateVisibleComponentsBbox()}}))}getVisibleComponentsBbox(){var e,t=new THREE.Box3;return this.modelManager.traverseValidModels((function(i){if(i.getFilter()&&!(e=i.getFilter().getVisibleComponentsBbox()).isEmpty()){let r=i.getTransformMatrix();e.applyMatrix4(r),t.union(e)}})),t}setObserverForSceneState(e){this.observerForSceneState=e}getObserverForSceneState(){return this.observerForSceneState}isComponentActive(e,t){var i=!1;return this.filterHelper.executeId(e,((e,t)=>{i||(i=e.getFilter().isComponentActive(t))}),t),i}needUpdateBoxAfterExplode(){var e=!1;return this.modelManager.traverseModels((function(t){t.getFilter()&&(e=t.getFilter().needUpdateBoxAfterExplode())}),(function(t){return e||!t.isUseable()})),e}getVisibleComponentSet(e){var t={};return this.modelManager.traverseValidModels((function(i){if(i.getFilter()){var r=i.getFilter().getVisibleComponentSet(e);for(var a in r)i.isUserIdExist(a)&&(t[a]=r[a])}})),t}saveState(){var e={};this.modelManager.traverseValidModels((function(t){t.getFilter()&&(e[t.id]=t.getFilter().saveState())}));for(let t in e){const i=e[t].actions;if(!i)return;const r=i.length;for(let e=0;e<r;++e){const t=i[e];if(!t.material||!t.material.map)continue;const r=t.material.clone();r.map=null,t.material=r}}return JSON.stringify(e)}loadState(e){var t=JSON.parse(e);t.version?this.modelManager.traverseValidModels((function(e){e.getFilter()&&e.getFilter().loadState(t)})):this.modelManager.traverseValidModels((function(e){e.getFilter()&&t[e.id]&&e.getFilter().loadState(t[e.id])}))}getObjectsMap(e){var t={},i=this.modelManager;if(void 0===e)i.traverseValidModels((function(e){if(e.getFilter()){var i=e.getFilter().getObjectInfoManager().getObjectsMap();for(var r in i)t[r]=i[r]}}));else{var r=i.getModel(e);if(r&&r.getFilter()){var a=r.getFilter().getObjectInfoManager().getObjectsMap();for(var n in a)t[n]=a[n]}}return t}deactivateAll(e){var t=this.modelManager;if(void 0===e)t.traverseValidModels((function(e){e.getFilter()&&e.getFilter().deactivateAll()}));else{var i=t.getModel(e);i&&i.getFilter()&&i.getFilter().deactivateAll()}}activateAll(e){var t=this.modelManager;if(void 0===e)t.traverseValidModels((function(e){e.getFilter()&&e.getFilter().activateAll()}));else{var i=t.getModel(e);i&&i.getFilter()&&i.getFilter().activateAll()}}getInactivatedIdMap(e){const t=this.modelManager;if(e){const i=t.getModel(e);if(!i||!i.getFilter())return;return i.getFilter().getInactivatedIdMap()}let i={};return t.traverseValidModels((e=>{e.getFilter()&&(i[e.id]=e.getFilter().getInactivatedIdMap())})),i}},r.ModelView.FilterHelper=class{constructor(e){this.modelManager=e}destroy(){this.modelManager=null}distributeIdsByModelId(e){for(var t={},i=this.modelManager.getModelIds(!0),r=[],a=function(e,i){e&&(e=e.toString(),t[e]||(t[e]=[]),"[object String]"===Object.prototype.toString.call(i)?t[e].push(i):"[object Array]"===Object.prototype.toString.call(i)&&(t[e]=t[e].concat(i)))},n=0;n<e.length;n++){var{modelId:s,objectId:o}=this.distributeId(e[n]);s?a(s,o):r.push(o)}if(r.length>0)for(var l=0;l<i.length;l++)a(i[l],r);return t}distributeId(e){if(!e)return{modelId:void 0,objectId:e};var t,i,r=/\[(.*?)\](.*)/.exec(e.toString());return r?(t=r[1],i=r[2],this.modelManager.getModelIds(!0).indexOf(t)<0&&(t=void 0,i=e)):i=e,{modelId:t,objectId:i}}distributeConditionsByModelId(e){for(var t={},i=this.modelManager.getModelIds(!0),r=[],a=function(e,r){e&&(e=e.toString(),i.indexOf(e)>=0&&(t[e]||(t[e]=[]),"[object Object]"===Object.prototype.toString.call(r)?t[e].push(r):"[object Array]"===Object.prototype.toString.call(r)&&(t[e]=t[e].concat(r))))},n=0;n<e.length;n++){var s=e[n];if(s.hasOwnProperty("modelId")){var o=s.modelId;delete s.modelId,a(o,s)}else r.push(s)}if(r.length>0)for(var l=0;l<i.length;l++)a(i[l],r);return t}executeConditions(e,t,i){if(i)(n=this.modelManager.getModel(i))&&n.getFilter()&&(e&&0!==e.length?(r=this.distributeConditionsByModelId(e))[i]&&"[object Function]"===Object.prototype.toString.call(t)&&t(n,r[i]):"[object Function]"===Object.prototype.toString.call(t)&&t(n,e));else if(e&&0!==e.length){var r=this.distributeConditionsByModelId(e);for(var a in r){var n=this.modelManager.getModel(a),s=r[a];n&&n.getFilter()&&s&&s.length>0&&"[object Function]"===Object.prototype.toString.call(t)&&t(n,s)}}else this.modelManager.traverseValidModels((function(i){i.getFilter()&&"[object Function]"===Object.prototype.toString.call(t)&&t(i,e)}))}executeIds(e,t,i){if(i)(n=this.modelManager.getModel(i))&&n.getFilter()&&(e&&0!==e.length?(r=this.distributeIdsByModelId(e))[i]&&"[object Function]"===Object.prototype.toString.call(t)&&t(n,r[i]):"[object Function]"===Object.prototype.toString.call(t)&&t(n,e));else if(e&&0!==e.length){var r=this.distributeIdsByModelId(e);for(var a in r){var n=this.modelManager.getModel(a),s=r[a];n&&n.getFilter()&&s&&s.length>0&&"[object Function]"===Object.prototype.toString.call(t)&&t(n,s)}}else this.modelManager.traverseValidModels((function(i){i.getFilter()&&"[object Function]"===Object.prototype.toString.call(t)&&t(i,e)}))}executeId(e,t,i){var r,{modelId:a,objectId:n}=this.distributeId(e);i?a&&a.toString()!==i.toString()||(r=this.modelManager.getModel(i))&&r.getFilter()&&"[object Function]"===Object.prototype.toString.call(t)&&t(r,n):a?(r=this.modelManager.getModel(a))&&r.getFilter()&&"[object Function]"===Object.prototype.toString.call(t)&&t(r,n):this.modelManager.traverseValidModels((function(e){e.getFilter()&&"[object Function]"===Object.prototype.toString.call(t)&&t(e,n)}))}},r.BlinkManager=class{constructor(e){this._manager=e,this.modelCollection=e.modelCollection,this.sceneState=e.sceneState,this.blinkStartTimeMap={},this.blinkLastTimeMap={},this.positiveSequenceMap={},this.blinkTimesMap={},this.blinkEnabled=!1,this.blinkPermited=!1,this.defaultBlinkColor=r.Blink.DefaultBlinkColor.color,this.defaultBlinkAlpha=r.Blink.DefaultBlinkColor.opacity,this.blinkColorMap={},this.blinkIntervalTimeMap={}}destroy(){this.blinkIntervalTimeMap=null,this.defaultBlinkColor=null,this.blinkColorMap=null,this.blinkStartTimeMap=null,this.blinkLastTimeMap=null,this.positiveSequenceMap=null,this.blinkTimesMap=null,this.sceneState=null,this.modelCollection=null,this._manager=null}getBlinkMaterials(e){if(e)return this.modelCollection.getById(e).getBlinkMaterials();let t={};return this.modelCollection.traverse((e=>{e.getBlinkMaterials&&(t[e.id]=e.getBlinkMaterials())})),t}resetBlinkMaterial(e){const t=this.getBlinkMaterials(e);if(e)for(let e=0,i=t.length;e<i;e++)t[e].resetBlinkUniformValue();else for(let e in t){const i=t[e];for(let e=0,t=i.length;e<t;e++)i[e].resetBlinkUniformValue()}}updateBlinkMaterial(e){const t=e=>{var t=this.getBlinkColor(e),i=this.getBlinkMaterials(e);if(0!=i.length){var a=this._manager.getModel(e),n=0,s=r.EnumShaderColorState.BLINK;this.blinkIntervalTimeMap[e]=this.blinkIntervalTimeMap[e]||600;var o=this.blinkIntervalTimeMap[e];if(a&&a.updateBlinkMaterial)a.updateBlinkMaterial(o);else{var l=Date.now();if(void 0===this.blinkStartTimeMap[e]&&(this.positiveSequenceMap[e]=!0,this.blinkStartTimeMap[e]=l,this.blinkLastTimeMap[e]=l),!(l-this.blinkLastTimeMap[e]<=100)){l-this.blinkStartTimeMap[e]>o&&(this.positiveSequenceMap[e]=!this.positiveSequenceMap[e],this.blinkStartTimeMap[e]=l,this.blinkLastTimeMap[e]=l);var d=(l-this.blinkStartTimeMap[e])/o;n=this.positiveSequenceMap[e]?d:1-d;for(var h=0,c=i.length;h<c;h++)i[h].updateBlinkUniformValue(s,t,n);this.blinkLastTimeMap[e]=l}}}},i=this.sceneState.getBlinkComponentIdsDetailMap();if(Object.keys(i).length>0)this.updateBlinkMaterialByMap(i);else if(e)t(e);else{var a=this.getBlinkMaterials();Object.keys(a).forEach((e=>{t(e)}))}}clearTime(e){this.blinkTimesMap[e]=0}updateBlinkMaterialByMap(e){for(const t in e){const i=e[t];if(!1===i.enable)continue;if(void 0===i.materials){i.models.map((e=>{const t=e.modelId;var i=this._manager.getModel(t);i&&i.updateBlinkMaterial&&i.updateBlinkMaterial()}));continue}const a=i.detail,n=i.materials;let s=0;const o=r.EnumShaderColorState.BLINK,l=a.interval,d=100,h=Date.now();this.blinkTimesMap[t]=null==this.blinkTimesMap[t]?0:this.blinkTimesMap[t],a.color&&(this.blinkColorMap[t]=this.blinkColorMap[t]||new THREE.Vector4,this.blinkColorMap[t].set(a.color.red/255,a.color.green/255,a.color.blue/255,a.color.alpha));const c=this.blinkColorMap[t];if(void 0===this.blinkStartTimeMap[t]&&(this.positiveSequenceMap[t]=!0,this.blinkStartTimeMap[t]=h,this.blinkLastTimeMap[t]=h),h-this.blinkLastTimeMap[t]<=d)return;if(h-this.blinkStartTimeMap[t]>l&&(this.positiveSequenceMap[t]=!this.positiveSequenceMap[t],this.blinkStartTimeMap[t]=h,this.blinkLastTimeMap[t]=h,a.times&&(this.blinkTimesMap[t]++,this.blinkTimesMap[t]==2*a.times)))return this.blinkTimesMap[t]=0,void this.sceneState.clearBlinkComponentsByDetail(t);const u=(h-this.blinkStartTimeMap[t])/l;s=this.positiveSequenceMap[t]?u:1-u,this.blinkLastTimeMap[t]=h;for(const e of n)e.updateBlinkUniformValue(o,c,s)}}getBlinkColor(e){return this.blinkColorMap[e]||this.setBlinkColor(void 0,void 0,e),this.blinkColorMap[e]}setBlinkColor(e,t,i){const a=i=>{if(!this.blinkColorMap[i]&&(this.blinkColorMap[i]=new THREE.Vector4),e){var a=r.Utils.hexToRgb(e);this.blinkColorMap[i].fromArray([a.r,a.g,a.b,t||1])}else this.blinkColorMap[i].set(this.defaultBlinkColor.r,this.defaultBlinkColor.g,this.defaultBlinkColor.b,this.defaultBlinkAlpha)};if(i)a(i);else{var n=this.getBlinkMaterials();Object.keys(n).forEach((e=>{a(e)}))}}setBlinkIntervalTime(e,t){const i=t=>{this.blinkIntervalTimeMap[t]<=0||(this.blinkIntervalTimeMap[t]=e)};if(t)i(t);else{var r=this.getBlinkMaterials();Object.keys(r).forEach((e=>{i(e)}))}}enableBlink(e){this.blinkEnabled=e,!1===e&&(this.blinkStartTime=null,this.resetBlinkMaterial()),this.applyBlink()}getBlinkEnabled(){return!this.isBlinkPermited()&&this.blinkEnabled}getBlinkComponentsIdMap(e){return this.isBlinkPermited()?null:this.sceneState.getBlinkComponentsIdMap(e)}applyBlink(e){this.isBlinkPermited()||(this._manager.selectPriority=!1,e?this.modelCollection.getById(e).applyBlink():this.modelCollection.traverse((e=>{e.applyBlink()})))}clearBlink(e){this.isBlinkPermited()||(this._manager.selectPriority=!1,e?this.modelCollection.getById(e).clearBlink():this.modelCollection.traverse((e=>{e.clearBlink()})))}permitBlink(e){this.blinkPermited=e}isBlinkPermited(){return this.blinkPermited}},r.ModelView.LayerCollection=class{constructor(){this._layers=[],this._destroyed=!1,this.eventDispatcher=new r.EventDispatcher}get length(){return this._layers.length}destroy(){this._destroyed=!0,this.removeAll(!0),this.eventDispatcher.destroy(),this.eventDispatcher=null,this._layers=null}isDestroyed(){return this._destroyed}add(e){return!!e&&(!this.getById(e.id)&&(this._layers.push(e),void(void 0===e.sequence?e.sequence=this._layers.length-1:this.moveToIdx(e,e.sequence))))}remove(e,t){t=r.Utils.isDefined(t,!0);const i=this.getById(e);if(!i)return!1;this._layers.splice(this._layers.findIndex((t=>t.id==e)),1);const a=this._getByFilter();for(const e of a)!e.isDestroyed()&&e.sequence>i.sequence&&e.sequence--;return t&&i.destroy(),!0}removeAll(e){if(e){const e=this._getByFilter();for(let t=0,i=e.length;t<i;++t){if(e[t].isDestroyed())return;e[t].destroy()}}this._layers=[]}_getByFilter(e){const t=[];for(const i of this._layers)e&&!e(i)||t.push(i);return t}getById(e){return e&&(e=e.toString()),this._getByFilter((t=>t.id===e))[0]}getByIndex(e){return this._layers[e]}getMaxSequence(){return this._layers.length-1}getOrderedIds(){const e=Array.from(this._layers);return e.sort(((e,t)=>e.sequence-t.sequence)),e.map((e=>e.id))}getIds(){return this._layers.map((e=>e.id))}traverse(e,t){const i=t?Array.from(this._layers):this._layers;t&&i.sort(((e,t)=>e.sequence-t.sequence)),i.forEach((t=>e(t)))}traverseIf(e,t){const i=this._layers;for(let r=0,a=i.length;r<a;++r){let a=i[r];if(t&&t(a))break;e&&e(a)}}some(e){return this._layers.some((t=>e(t)))}moveToIdx(e,t){const i=this._layers,a=r.Math.clamp(t,0,i.length-1),n=e.sequence;for(const t of i)t.id===e.id?t.sequence=a:t.sequence>n&&t.sequence<=a?t.sequence--:t.sequence>=a&&t.sequence<n&&t.sequence++}shiftDown(e){e.sequence>0&&this.moveToIdx(e,e.sequence-1)}shiftUp(e){const t=this.getMaxSequence();e.sequence<t&&this.moveToIdx(e,e.sequence+1)}},r.ModelLoader=class{constructor(){this.loader=new THREE.FileLoader}destroy(){this.loader=null}load(e,t,i){var a=new r.Loader.Url({serverUrl:e.parameters.serverUrl,databagId:e.parameters.databagId,lightmapDatabagId:e.parameters.lightmapDatabagId});if(null==e.parameters.metaData){var n=this,s=this.loader;s.setResponseType("");var o=a.projectUrl();r.Storage.IndexedDBHelper.loadWithStorage("InfoData",o,(()=>new Promise(((e,t)=>{s.load(o,e,void 0,t)}))),(a=>{var s;try{s=JSON.parse(a)}catch(e){return i(e),void r.eventsDispatcher.dispatchEvent({type:r.EVENTS.ON_LOAD_INVALID_SCENE})}var o=n.getModel(s,e);t&&t(o)}),(e=>{console.log("Config load error!"),i(e),r.eventsDispatcher.dispatchEvent({type:r.EVENTS.ON_LOAD_INVALID_SCENE})}))}else{let i={};i.metadata=e.parameters.metaData,i.coordinateSystem=e.parameters.coordinateSystem;let r=this.getModel(i,e);t&&t(r)}}getModel(e,t){let i=e.metadata.asset?e.metadata.asset:"bmd";r.Utils.isDefined(e.metadata.FeatureType)&&"point"===e.metadata.FeatureType&&"0.0.1"===e.metadata.version&&(i="point"),"bmd"!==i&&"point"!==i&&e.metadata.content&&"bim"!==e.metadata.content&&(i="standardtiles"),"bmd"!==i&&"point"!==i&&e.metadata.content&&"osgb"===e.metadata.content&&(i="ObliquePhotography");const a=e.metadata.root?e.metadata.root:void 0;t.parameters.rootPath=a;const n=e.metadata.FeatureType?"shp":e.metadata.content?e.metadata.content:"bim";t.parameters.resourceType=n;const s=!!(!0===e.metadata.onDemand||t.parameters.loadConfig&&!0===t.parameters.loadConfig.onDemand);t.parameters.onDemand=s;const o=!0===e.metadata.layer;t.parameters.demandConditions=t.parameters.loadConfig&&t.parameters.loadConfig.condition,t.parameters.hasLayerInfo=o;const l=void 0===e.metadata.detailLevel?[]:e.metadata.detailLevel;if(t.parameters.detailLevelList=l,t.parameters.visualRange=t.parameters.loadConfig&&t.parameters.loadConfig.visualRange,t.parameters.disableUserData=!(!t.parameters.loadConfig||!0!==t.parameters.loadConfig.disableUserData),t.parameters.enableBorderLine=!(!t.parameters.loadConfig||!0!==t.parameters.loadConfig.enableBorderLine),t.parameters.maxDetailLevel=t.parameters.loadConfig&&t.parameters.loadConfig.maxDetailLevel,t.parameters.wireFrameVisibilityOption=!t.parameters.loadConfig||void 0===t.parameters.loadConfig.wireFrameVisibilityOption||t.parameters.loadConfig.wireFrameVisibilityOption,t.parameters.dataVersion=r.BimTilesVersionControl.VERSION_1,t.parameters.config=e,t.parameters.sequence=t.priority,e.metadata&&"BimtilesCompiler v0.02"===e.metadata.generateTool)t.parameters.dataVersion=r.BimTilesVersionControl.VERSION_2;else if(e.metadata&&"BimtilesCompiler v0.03"===e.metadata.generateTool)return t.parameters.dataVersion=r.BimTilesVersionControl.VERSION_3,r.ModelFactory.bimtilesV3(t.viewer,t.manager,t.parameters,t.index,t.parseCfgFinish,t.debut);return r.ModelFactory[i](t.viewer,t.manager,t.parameters,t.index,t.parseCfgFinish,t.debut)}},r.ModelFactory={pointCloud:function(e,t,i,a,n,s){return new r.PointCloudModel(e,t,i,a,n,s)},"3dtiles":function(e,t,i,a,n,s){return new r.$3dTilesModel(e,t,i,a,n,s)},dem:function(e,t,i,a,n,s){return new r.DemModel(e,t,i,a,n,s)},bimtile:function(e,t,i,a,n,s){return new(r.GlobalData.WorkerEnabled?r.Workers.TilesModel:r.BimTilesModel)(e,t,i,a,n,s)},bimtiles:function(e,t,i,a,n,s){return new(r.GlobalData.WorkerEnabled?r.Workers.TilesModel:r.BimTilesModel)(e,t,i,a,n,s)},bimtilesV3:function(e,t,i,a,n,s){return new(r.GlobalData.WorkerEnabled?r.Workers.TilesModel:r.BimTilesModelV3)(e,t,i,a,n,s)},standardtiles:function(e,t,i,a,n,s){return new r.StandardTilesModel(e,t,i,a,n,s)},ObliquePhotography:function(e,t,i,a,n,s){return new r.ObliquePhotographyModel(e,t,i,a,n,s)},point:function(e,t,i,a,n,s){return new r.PointModel(e,t,i,n,s)},bmd:function(e,t,i,a,n,s){return new r.Model(t,i,a,n,s)},globe:function(e,t){return new r.Layer.GlobeLayer(e,t)}},function(){const e={split(e,t){if(e.indexOf("m.bimface.com")>=0||e.indexOf("m-test.bimface.com")>=0||window.hostConfig&&window.hostConfig.enableUrlSplit){let i=/http[s]?(:\/\/m[1]?[0-9]?(-test)?.)/.exec(e);if(i){let r=i[1],a=r.indexOf("-test")>=0?"-test":"";e=e.replace(r,`://m${t}${a}.`)}}return e},getHostNumByReg(e,t){let i=t.exec(e),r=i?i[1].charCodeAt()%10:0;return r+=1,r},splitByDatabagId(e){return this.split(e,this.getHostNumByReg(e,/.*\/(.+?).*\/resource/))},splitByTextureName(e){return this.split(e,this.getHostNumByReg(e,/texture\/(.+?).*/))},splitByContextId(e,t){const i=parseInt(t)%10+1;return this.split(e,i)},splitByUrlMd5(e){if(!0!==r.GlobalData.EnableDomainDiversion)return e;const t=r.Utils.charCodeUrl(e)%10+1;return this.split(e,t)}};r.RequestSpliter=e}(),function(){class e{static getBox(e,t){const i=new THREE.Box3;if(Array.isArray(e)&&e.length>=6&&i.setFromArray(e),e.region){const t=e.region;i.set(THREE.Math.radToDeg(t[0]),THREE.Math.radToDeg(t[2]),THREE.Math.radToDeg(t[1]),THREE.Math.radToDeg(t[3]))}if(e.box){const t=e.box,r=new THREE.Vector3(t[0],t[1],t[2]),a=r.x-Math.abs(t[3]),n=r.x+Math.abs(t[3]),s=r.y-Math.abs(t[7]),o=r.y+Math.abs(t[7]),l=r.z-Math.abs(t[11]),d=r.z+Math.abs(t[11]);i.set(new THREE.Vector3(a,s,l),new THREE.Vector3(n,o,d))}if(e.sphere){const t=new THREE.Sphere(new THREE.Vector3(e.sphere[0],e.sphere[1],e.sphere[2]),e.sphere[3]);i.copy(t.getBoundingBox())}return t&&i.applyMatrix4(t),i}static getDracoLibUrl(){return r.GlobalData.DracoLibUrl?r.GlobalData.DracoLibUrl:window.BimfaceLoaderConfig&&window.BimfaceLoaderConfig.fullStaticHost?(r.GlobalData.DracoLibUrl=window.BimfaceLoaderConfig.fullStaticHost+"/lib/draco/",r.GlobalData.DracoLibUrl):(r.GlobalData.DracoLibUrl="../../lib/draco/",r.GlobalData.DracoLibUrl)}static getDracoLoader(){return void 0===this.dracoLoader&&(this.dracoLoader=new THREE.DRACOLoader,this.dracoLoader.setDecoderPath(r.TilesUtil.getDracoLibUrl())),this.dracoLoader}static getProtobufLibUrl(){return r.GlobalData.ProtobufLibUrl?r.GlobalData.ProtobufLibUrl:window.BimfaceLoaderConfig&&window.BimfaceLoaderConfig.fullStaticHost?(r.GlobalData.ProtobufLibUrl=window.BimfaceLoaderConfig.fullStaticHost+"/lib/protobuf/",r.GlobalData.ProtobufLibUrl):(r.GlobalData.ProtobufLibUrl="../../lib/protobuf/",r.GlobalData.ProtobufLibUrl)}static getProtobufDecoder(){return void 0===this.protobufDecoder&&(this.protobufDecoder=new r.Loader.TilesWorkerDecoder,this.protobufDecoder.setDecoderPath(r.TilesUtil.getProtobufLibUrl())),this.protobufDecoder}static praseUserData(e){if(void 0===e)return;if(!(e.length>0))return e;let t={};return e.map((e=>{t[e[0]]=e[1]})),t}static getDebugColor(e,t){if(-1===e)return r.Debug.DebugColor.BLACK;if(!t)return r.Debug.DebugColor.GRAY;const i=r.Debug.DebugColorArray;return i[e%i.length]}static nodeIndexGroupsSort(e){let t=[];for(const[i,r]of e)for(const e of r.values())t.push({userId:i,indexGroup:e});return t.sort(((e,t)=>e.indexGroup.indexStart-t.indexGroup.indexStart)),t}static matchWireFrameVisibilityOption(e,t){return t instanceof Object?void 0!==t.ids&&t.ids[e]?t.isVisible:!t.isVisible:t}static isNodeInVisible(e){return!(e&&!1!==e.visible&&(!e.parent||!1!==e.parent.visible))}static isInstanceNodeInVisible(e){return!e||!1===e.visible||void 0===e.geometry}}e.max_uncompressed_blob_size=8388608,e.TILE_DATA_INDEX="INDEX",e.TILE_DATA_USERDATA="USERDATA",e.TILE_DATA_MATERIAL="MATERIAL",e.TILE_TEXTURE_NONE="TEXTURENONE",e.TILE_TEXTURE_LOADING="TEXTURE_LOADING",e.TILE_TEXTURE_LOADED="TEXTURELOADED",e.TWO_ACCURACY=.01,e.SIX_ACCURACY=1e-7,e.BMD_GEOMETRIC_ERROR_COEFFICIENT=1,e.OP_GEOMETRIC_ERROR_COEFFICIENT=.25,e.Minimum_Setting_SSEHold=.001,e.MODEL_SSE_Threshold_MAP={"3dtiles":e.OP_GEOMETRIC_ERROR_COEFFICIENT,osgb:e.OP_GEOMETRIC_ERROR_COEFFICIENT,shp:e.OP_GEOMETRIC_ERROR_COEFFICIENT,bim:e.BMD_GEOMETRIC_ERROR_COEFFICIENT},e.PICK_EFFECT_MODEL_TYPE={bim:!0,shp:!0,kml:!0,citygml:!0,dwg:!0},r.TilesUtil=e}(),function(){const e=(new THREE.FileLoader).setResponseType("json"),t=(new THREE.FileLoader).setResponseType("arraybuffer");class i{constructor(e){this._url=e.url,this._request=e.request,this._retryCallback=e.retryCallback,this._retryTimes=r.Utils.defaultValue(e.retryTimes,0),this._retryCount=0}destroy(){this._request&&(this._request.destroy(),this._request=void 0),this._retryCallback=void 0}clone(e){return e||(e=new i),e._url=this._url,e._retryCallback=this._retryCallback,e._retryTimes=this._retryTimes,e._retryCount=0,this._request&&(e._request=this._request.clone()),e}fetch(e){return this._makeRequest(e)}_checkRequest(e){return e.state===r.RequestState.ISSUED||e.state===r.RequestState.ACTIVE?(console.log("The Resource is already being fetched."),!1):(e.state=r.RequestState.UNISSUED,e.deferred=void 0,!0)}_getFetchCallback(i){return i.fetchCallback?i.fetchCallback:"arraybuffer"===i.responseType?t.load:e.load}_makeRequest(e){const t=this._request;if(!this._checkRequest(this._request))return;const i=this._getFetchCallback(e);t.url=this._url,t.requestCallback=function(){const e=new r.Deferred;return i(t.url,(function(t){e.resolve(t)}),(function(t){e.reject(t)})),t.cancelCallback=function(){},e.promise};const a=r.RequestScheduler.request(t);return a?a.then((function(e){return t.cancelCallback=void 0,e})).catch((function(e){return t.cancelCallback=void 0,Promise.reject(e)})):void 0}retryOnError(e){const t=this._retryCallback;return"function"!=typeof t||this._retryCount>=this.retryTimes?new Promise.resolve(!1):new Promise.resolve(t(this,e)).then((e=>(++this._retryCount,e)))}_fetchArrayBuffer(){return this._makeRequest({fetchCallback:t.load})}static fetchArrayBuffer(e){return i.create(e)._fetchArrayBuffer()}_fetchJson(){return this._makeRequest({fetchCallback:e.load})}static fetchJson(e){return i.create(e)._fetchJson()}static create(e){return new i(e)}static fromUrl(e,t){const r=i.create({url:e});return t.request&&(r._request=t.request),t.retryCallback&&(r._retryCallback=t.retryCallback),t.retryTimes&&(r._retryTimes=t.retryTimes),r}static createIfNeeded(e){return e instanceof i?e.fromResource({request:e.request}):"string"!=typeof e?e:i.create({url:e})}fromResource(e){const t=this.clone();return e.request&&(t._request=e.request),e.retryCallback&&(t._retryCallback=e.retryCallback),e.retryTimes&&(t._retryTimes=e.retryTimes),t}}r.Resource=i}(),function(){r.RequestState=Object.freeze({UNISSUED:0,ISSUED:1,ACTIVE:2,RECEIVED:3,CANCELLED:4,FAILED:5});r.RequestType=Object.freeze({TERRAIN:0,IMAGERY:1,BIMTILES:2,OTHER:3})}(),function(){class e{constructor(e){e=e||{},this.url=e.url,this.requestCallback=e.requestCallback,this.cancelCallback=e.cancelCallback,this.priorityCallback=e.priorityCallback,this.priority=r.Utils.defaultValue(e.priority,0),this.throttle=r.Utils.defaultValue(e.throttle,!0),this.throttleByServer=r.Utils.defaultValue(e.throttleByServer,!0),this.type=r.Utils.defaultValue(e.type,r.RequestType.OTHER),this.state=r.RequestState.UNISSUED,this.deferred=void 0,this.cancelled=!1,this.destroyed=!1}destroy(){this.destroyed=!0,this.requestCallback=void 0,this.cancelCallback=void 0,this.priorityCallback=void 0,this.deferred=this.deferred&&this.deferred.destroy()}isDestroyed(){return this.destroyed}cancel(){this.cancelled=!0}clone(t){return t?(t.url=this.url,t.requestCallback=this.requestCallback,t.cancelCallback=this.cancelCallback,t.priorityCallback=this.priorityCallback,t.priority=this.priority,t.state=r.RequestState.UNISSUED,t.deferred=void 0,t.cancelled=!1,t):new e(this)}}r.Request=e}(),function(){function e(e){e.priorityCallback&&(e.priority=e.priorityCallback())}function t(e){if(!e.isDestroyed())return e.state===r.RequestState.UNISSUED&&(e.state=r.RequestState.ISSUED,e.deferred=new r.Deferred),e.deferred.promise}function i(e){if(e.isDestroyed())return;const i=t(e);return e.state=r.RequestState.ACTIVE,l.push(e),++n.numberOfActiveRequests,++c,e.requestCallback().then(function(e){return function(t){if(e.state===r.RequestState.CANCELLED)return;--n.numberOfActiveRequests,--c,u.fireEvent(),e.state=r.RequestState.RECEIVED;const i=e.deferred;e.deferred=void 0,i.resolve(t)}}(e)).catch(function(e){return function(t){e.state!==r.RequestState.CANCELLED&&(++n.numberOfFailedRequests,--n.numberOfActiveRequests,--c,u.fireEvent(t),e.state=r.RequestState.FAILED,e.deferred&&e.deferred.reject(t))}}(e)),i}function a(e){const t=e.state===r.RequestState.ACTIVE;if(e.state=r.RequestState.CANCELLED,++n.numberOfCancelledRequests,e.deferred){const t=e.deferred;e.deferred=void 0,t.reject("cancelRequest:"+e.url)}t&&(--n.numberOfActiveRequests,--c,++n.numberOfCancelledActiveRequests),e.cancelCallback&&e.cancelCallback()}let n={numberOfAttemptedRequests:0,numberOfActiveRequests:0,numberOfCancelledRequests:0,numberOfCancelledActiveRequests:0,numberOfFailedRequests:0,numberOfActiveRequestsEver:0,lastNumberOfActiveRequests:0},s=20,o=new r.Heap({comparator:function(e,t){return e.priority-t.priority}});o.maximumLength=s,o.reserve(s);let l=[],d=50,h=18,c=0;const u=new r.Event;class p{static get maxRequests(){return d}static set maxRequests(e){d=e}static get throttleRequests(){return true}static get maxRequestsByServer(){return h}static set maxRequestsByServer(e){h=e}static get statistics(){return n}static get priorityHeapLength(){return s}static set priorityHeapLength(e){if(e<s)for(;o.length>e;){a(o.pop())}s=e,o.maximumLength=e,o.reserve(e)}static hasOpenServerSlots(){const e=r.Utils.defaultValue(h,6);return c+1<=e}static update(){let t,n,s,d=0;for(t=0,n=l.length;t<n;++t)s=l[t],s.cancelled&&a(s),s.state===r.RequestState.ACTIVE?d>0&&(l[t-d]=s):++d;l.length-=d;const h=o.internalArray;for(t=0,n=o.length;t<n;++t)e(h[t]);o.resort();const c=Math.max(p.maxRequests-l.length,0);let u=0;for(;u<c&&o.length>0;)s=o.pop(),s&&(s.cancelled?a(s):!s.throttleByServer||p.hasOpenServerSlots()?(i(s),++u):a(s))}static request(r){if(++n.numberOfAttemptedRequests,p.throttleRequests&&r.throttleByServer&&!p.hasOpenServerSlots())return;if(!p.throttleRequests||!r.throttle)return i(r);if(l.length>=p.maxRequests)return;e(r);const s=o.insert(r);if(s){if(s===r)return;a(s)}return t(r)}static clear(){for(;o.length>0;){a(o.pop())}for(let e=0,t=l.length;e<t;++e)a(l[e]);l.length=0,c=0,n.numberOfAttemptedRequests=0,n.numberOfActiveRequests=0,n.numberOfCancelledRequests=0,n.numberOfCancelledActiveRequests=0,n.numberOfFailedRequests=0,n.numberOfActiveRequestsEver=0,n.lastNumberOfActiveRequests=0}static get requestHeap(){return o}}r.RequestScheduler=p}(),r.FrameState=class{constructor(){this.frameNumber=0,this.newFrame=!1,this.time=void 0,this.camera=void 0,this.cameraPositionWc=new THREE.Vector3,this.cameraDirectionWc=new THREE.Vector3,this.cullingVolume=void 0,this.pixelRatio=window.devicePixelRatio||1,this.maximumScreenSpaceError=void 0,this.viewSize={width:0,height:0},this.globalInverseMatrix=void 0,this.globalMatrix=void 0,this.transformMatrix=void 0,this.afterRenderFns=[],this.viewer=null,this.transformMatrixUpdated=!1,this.globalMatrixUpdated=!1,this.geoErrScaleFactor=1}destroy(){this.afterRenderFns=void 0,this.viewSize=void 0,this.camera=void 0,this.cameraPositionWc=void 0,this.cameraDirectionWc=void 0,this.cullingVolume=void 0,this.globalInverseMatrix=void 0,this.globalMatrix=void 0,this.viewer=null}},r.Statistics=class{constructor(){this.selected=0,this.visited=0,this.numberOfAttemptedRequests=0,this.numberOfPendingRequests=0,this.numberOfTilesProcessing=0,this.numberOfTilesWithContentReady=0,this.numberOfTilesTotal=0,this.numberOfTilesLoadedTotal=0,this.numberOfTrianglesSelected=0,this.geometryByteLength=0,this.texturesByteLength=0}destroy(){}clear(){this.selected=0,this.visited=0,this.numberOfTrianglesSelected=0,this.numberOfAttemptedRequests=0}_updateMemoryCount(e,t,i){var r=e.trianglesLength,a=e.geometryByteLength,n=e.texturesByteLength;i?(this.geometryByteLength+=t?-a:a,this.texturesByteLength+=t?-n:n):this.numberOfTrianglesSelected+=t?-r:r}incrementSelectionCount(e){this._updateMemoryCount(e,!1,!1)}incrementGeometryMemoryCount(e){this.geometryByteLength+=e.geometryByteLength}incrementTextureMemoryCount(e){this.texturesByteLength+=e.texturesByteLength}decrementTextureMemoryCount(e){this.texturesByteLength-=e.texturesByteLength}incrementLoadCount(e){this._updateMemoryCount(e,!1,!0)}decrementLoadCount(e){this._updateMemoryCount(e,!0,!0)}copy(e){this.selected=e.selected,this.visited=e.visited,this.numberOfAttemptedRequests=e.numberOfAttemptedRequests,this.numberOfPendingRequests=e.numberOfPendingRequests,this.numberOfTilesProcessing=e.numberOfTilesProcessing,this.numberOfTilesWithContentReady=e.numberOfTilesWithContentReady,this.numberOfTilesTotal=e.numberOfTilesTotal,this.numberOfTrianglesSelected=e.numberOfTrianglesSelected,this.geometryByteLength=e.geometryByteLength,this.texturesByteLength=e.texturesByteLength}clone(){return(new this.constructor).copy(this)}},r.TileContentType={DATA_NULL:"NULL",DATA_TILE:"TILE",DATA_BIMTILE:"BIMTILE",DATA_MESH:"MESH",DATA_INSTANCE:"INSTANCE",DATA_B3DM:"B3DM",DATA_POINT:"POINT",DATA_LINE:"LINE",DATA_DEM:"DEM",DATA_CMPT:"CMPT",DATA_GLOBAL_USER_DATA:"GLOBAL_USER_DATA",DATA_GLOBAL_USER_ID:"GLOBAL_USER_ID",DATA_GLOBAL_NODE_ID:"GLOBAL_NODE_ID",DATA_GLOBAL_NODE_BOX:"GLOBAL_NODE_BOX",DATA_GLOBAL_USER_ID_BOX:"GLOBAL_USER_ID_BOX",DATA_GLOBAL_TILE_ID:"GLOBAL_TILE_ID",DATA_GLOBAL_MATERIAL:"GLOBAL_MATERIAL",DATA_GLOBAL_PRECUTTING_TREE:"DATA_GLOBAL_PRECUTTING_TREE"},r.TileContentState=Object.freeze({UNLOADED:0,LOADING:1,PROCESSING:2,CONSTRUCTING:3,READY:4,FAILED:5}),r.SharedGeometryState=Object.freeze({UNLOADED:0,PROCESSING:1,PROCESSED:2,FAILED:3,DESTROYED:4,CANCELED:5}),r.TileContentProcessState=Object.freeze({PENDING:0,LOADING:1,LOADED:2,PROCESSING:3,PROCESSED:4,CONSTRUCTING:5,CONSTRUCTED:6,READY:7,FAILED:8}),r.Layer.ImageryState=Object.freeze({UNLOADED:0,TRANSITIONING:1,RECEIVED:2,TEXTURE_LOADED:3,READY:4,FAILED:5,INVALID:6,PLACEHOLDER:7}),r.Layer.TerrainState=Object.freeze({FAILED:0,UNLOADED:1,RECEIVING:2,RECEIVED:3,TRANSFORMING:4,TRANSFORMED:5,READY:6}),r.TilesCache=class{constructor(e){this._list=new r.DoublyLinkedList,this._sentinel=this._list.add(),this._trimTiles=!1,this._tilesCacheScheduler=e}destroy(){this._list=null,this._sentinel=null,this._tilesCacheScheduler=null}reset(){this._list.splice(this._list.tail,this._sentinel)}touch(e){var t=e.cacheNode;t&&this._list.splice(this._sentinel,t)}add(e){e.cacheNode||(e.cacheNode=this._list.add(e))}unloadTile(e){var t=e.cacheNode;t&&(e._tileset.unloadTile(e),e.cacheNode=void 0,this._list.remove(t))}unloadTiles(){const e=this._trimTiles;this._trimTiles=!1;const t=this._list,i=this._sentinel;let a=t.head;for(;a!==i;){const t=a.item;a=a.next;const i=t._tileset;if(!r.Utils.isDefined(i))continue;const n=1024*i.maximumMemoryUsage*1024;(this._tilesCacheScheduler.totalMemoryUsageInBytes>n||e)&&this.unloadTile(t)}}trim(){this._trimTiles=!0}},function(){function e(e,t){return e._priority-t._priority}let t=new THREE.Box3;class i{constructor(e){e=r.Utils.defaultValue(e,{}),this._destroyed=!1,this._id=e.id||"DefaultTileset",this._databagId=e.databagId||this._id,this._fileId=e.fileId||this._databagId,this._type=e.type||r.RequestType.BIMTILES,this._objectGroup=e.objectGroup||null,this._debugShowBoundingBox=e.debugShowBoundingBox||!1,this._debugShowGeometricError=e.debugShowGeometricError||!1,this.debugShowGeometricErrorHelper=e.debugShowGeometricErrorHelper,this._debugShowStatistics=e.debugShowStatistics||!1,this._transformMatrix=e.transformMatrix||new THREE.Matrix4,this._maxDetailLevel=e.maxDetailLevel,this._visualRange=e.visualRange,this._userInputWorking=e.userInputWorking,this._sequence=0,this._geometricError=void 0,this._root=void 0,this._boundingBox=void 0,this._tilesCacheScheduler=e.tilesCacheScheduler,this._processingTiles=[],this._selectedTiles=[],this._requestedTiles=[],this._requestedTilesInFlight=[],this._priorityRange={max:{depth:0,distance:0,sse:0,foveate:0},min:{depth:0,distance:0,sse:0,foveate:0}},this._skipLodEnabled=e.skipLodEnabled||!1,this.maximumScreenSpaceError=r.Utils.defaultValue(e.maximumScreenSpaceError,16),this._foveatedConeLimit=r.Utils.defaultValue(e.foveatedConeLimit,{priorityEnabled:!1,foveatedConeFactor:1,foveatedSseRelaxation:0,degradedFactor:1}),this.tileLoadedEvent=new r.Event,this.tileUnloadEvent=new r.Event,this.tileFailedEvent=new r.Event,this.onDemandManager=e.onDemandManager,this.hasLayerInfo=e.hasLayerInfo,this._traversalController=void 0,this._createTraversalController()}destroy(){this._destroyed=!0,this._destroyAllTiles(),this._boundingBox=void 0,this._objectGroup=void 0,this._objectWireframeGroup=void 0,this._transformMatrix=void 0,this._tilesCacheScheduler=void 0,this._processingTiles=void 0,this._selectedTiles=void 0,this._requestedTiles=void 0,this._requestedTilesInFlight=void 0,this._priorityRange=void 0,this.tileLoadedEvent=void 0,this.tileUnloadEvent=void 0,this.tileFailedEvent=void 0,this.onDemandManager&&this.onDemandManager.destroy(),this.onDemandManager=null,this._traversalController.destroy(),this._traversalController=void 0}_destroyAllTiles(){if(!this._root)return;const e=[];for(e.push(this._root);e.length>0;){const t=e.pop(),i=t.childrenTree;for(let t=0,r=i.length;t<r;++t)e.push(i[t]);t.destroy()}this._root=void 0}isDestroyed(){return this._destroyed}set root(e){this._root=e}get root(){return this._root}get ready(){return!!this._root}get statistics(){return this._tilesCacheScheduler.statistics}get cache(){return this._tilesCacheScheduler.tilesCache}get maximumMemoryUsage(){return this._tilesCacheScheduler.maximumMemoryUsage}get totalMemoryUsageInBytes(){return this._tilesCacheScheduler.totalMemoryUsageInBytes}set sequence(e){this._sequence=e}get sequence(){return this._sequence}set type(e){this._type=e}get type(){return this._type}get foveatedConeFactor(){return this._foveatedConeLimit.foveatedConeFactor}get foveatedSseRelaxation(){return this._foveatedConeLimit.foveatedSseRelaxation}get degradedFactor(){return this._foveatedConeLimit.degradedFactor}get foveatedConePriorityEnabled(){return this._foveatedConeLimit.priorityEnabled}preUpdate(e){this.ready&&this.processTiles(e)}update(e){return!!this.ready&&(this.updateFrameState(e),this.resetMaxAndMinPriority(),this.selectTiles(e),this.requestTiles(e),this.updateTiles(e),!0)}postUpdate(e){this.ready&&this.cancelTileRequests(e)}selectTiles(e){this._requestedTiles.length=0,this._selectedTiles.length=0,this._clearDrawableOfTiles(),this.updateTile(this.root,e),this.root.visible&&this._inVisualRange(e)&&(this._traverseTiles(this.root,e),this._updatePriorityForRequestedTiles())}requestTiles(t){if(this._userInputWorking&&t.viewer.inputStatusMonitor.needsStopUpdateScene())return;let i=this._requestedTiles;i.sort(e);for(let e=0,t=i.length;e<t;++e)this.requestContent(i[e])}updateTiles(e){const t=this.statistics,i=this._selectedTiles;for(let r=0,a=i.length;r<a;++r){let a=i[r];a.update(e),t.incrementSelectionCount(a.content),++t.selected}this.debugShowStatistics(e)}processTiles(t){this._removeTilesFromProcessingQueue(t);let i=this._processingTiles;i.sort(e);for(let e=0,r=i.length;e<r;++e)i[e].process(t)}updateTile(e,t){this.updateTileVisibility(e,t),this.updateMaxAndMinPriority(e)}updateTileVisibility(e,t){e.updateVisibility(t),e.visible&&(e.meetsSSE(t)?e.refineReplace&&e.hasChildren()&&!this.anyChildrenVisible(e,t)&&(e._visible=!1):e._visible=!1)}anyChildrenVisible(e,t){let i=!1;return e.childrenTree.forEach((e=>{e.updateVisibility(t),i=i||e.visible})),i}touchTile(e,t){e._touchedFrame!==t.frameNumber&&(this.cache.touch(e),e._touchedFrame=t.frameNumber)}visitTile(e,t){++this.statistics.visited,e._visitedFrame=t.frameNumber}cacheTile(e){const t=this.statistics;--t.numberOfTilesProcessing,++t.numberOfTilesWithContentReady,++t.numberOfTilesLoadedTotal,e.getTexturesByteLength(),t.incrementLoadCount(e.content),this.cache.add(e),this.tileLoadedEvent.fireEvent(e)}updateTextureMemoryUsage(e){const t=this.statistics;t.decrementTextureMemoryCount(e.content),e.getTexturesByteLength(),t.incrementTextureMemoryCount(e.content)}resetCache(e){}requestContent(e){if(e.contentTypeNull)return;const t=this.statistics;e.requestContent()?(++t.numberOfPendingRequests,this._requestedTilesInFlight.push(e),e.contentProcessPromise&&e.contentProcessPromise.then(this._addTileToProcessingQueue(this,e)).catch((function(e){})),e.contentReadyPromise&&e.contentReadyPromise.then(this._handleTileContentSuccess(this,e)).catch(this._handleTileContentFailure(this,e))):++t.numberOfAttemptedRequests}cancelTileRequests(e){const t=this._requestedTilesInFlight;let i=0;for(let a=0,n=t.length;a<n;++a){const n=t[a];if(n._contentState!==r.TileContentState.LOADING){++i;continue}e.frameNumber-n._touchedFrame>=1?(n._request.cancel(),++i):i>0&&(t[a-i]=n)}t.length-=i}_canBeTraverse(e,t){return!!e.hasChildren()&&e.passSSE(t)}onDemandJudgment(e){return this.onDemandManager.onDemandJudgment(e)}_traverseTiles(e,t){this._traversalController.traverseTiles(this,e,t)}isCheckChildrenPassSSE(){return!1}anyChildrenPassSSE(e,t){let i=!1;return e.childrenTree.forEach((e=>{i=i||e.passSSE(t)})),i}_fetchChildrenOfTile(e,t){this.needLoadChildrenOfTile(e)&&(e._childrenState=r.TileContentState.READY,e.contentTypeTile&&this.loadChildrenOfTile(e,void 0,(function(){t.afterRenderFns.push((function(){}))})))}needLoadChildrenOfTile(e){return e.childrenUnload}loadChildrenOfTile(e,t,i){}updateFrameState(e){}_clearDrawableOfTiles(){this._objectGroup&&this._objectGroup.children.forEach((e=>{e.visible=!1})),this.debugShowGeometricErrorHelper&&this.debugShowGeometricErrorHelper.hideAll()}_updatePriorityForRequestedTiles(){const e=this._requestedTiles;for(let t=0,i=e.length;t<i;++t)e[t].clearPriority();for(let t=0,i=e.length;t<i;++t)e[t].computePriority();for(let t=0,i=e.length;t<i;++t)e[t].updatePriority()}resetMaxAndMinPriority(){let e=this._priorityRange.max,t=this._priorityRange.min;t.depth=Number.MAX_VALUE,t.distance=Number.MAX_VALUE,t.sse=Number.MAX_VALUE,t.foveate=Number.MAX_VALUE,e.depth=-Number.MAX_VALUE,e.distance=-Number.MAX_VALUE,e.sse=-Number.MAX_VALUE,e.foveate=-Number.MAX_VALUE}updateMaxAndMinPriority(e){let t=this._priorityRange.max,i=this._priorityRange.min;i.distance=Math.min(e._distance,i.distance),i.depth=Math.min(e._depth,i.depth),i.sse=Math.min(e.sse,i.sse),i.foveate=Math.min(e._foveatedFactor,i.foveate),t.distance=Math.max(e._distance,t.distance),t.depth=Math.max(e._depth,t.depth),t.sse=Math.max(e.sse,t.sse),t.foveate=Math.max(e._foveatedFactor,t.sse)}_addTileToSelectedQueue(e,t){e.contentAvailable&&e.isContentVisible(t)&&this._isAvailableDetailLevel(e,1)&&this._selectedTiles.push(e)}_addTileToRequestedQueue(e,t){e._requestedFrame!==t.frameNumber&&e.contentUnloaded&&this._isAvailableDetailLevel(e,1)&&(e._requestedFrame=t.frameNumber,this._requestedTiles.push(e))}_addTileToProcessingQueue(e,t){return function(){e._processingTiles.push(t),--e.statistics.numberOfPendingRequests,++e.statistics.numberOfTilesProcessing}}_removeTilesFromProcessingQueue(e){const t=this._processingTiles;let i=0;for(let r=0,a=t.length;r<a;++r){const a=t[r];if(a.contentProcessing){{const t=e.frameNumber-a._touchedFrame;if(e.newFrame?t>=2:t>=1){a.unloadContent(),++i;continue}}i>0&&(t[r-i]=a)}else++i}t.length-=i}_handleTileContentFailure(e,t){return function(i){var r=t.contentIndex,a=i.message?i.message:i;e.tileFailedEvent.numberOfListeners>0&&e.tileFailedEvent.fireEvent({url:r,message:a})}}_handleTileContentSuccess(e,t){return function(){t.isTilesetContent||e.cacheTile(t)}}unloadTile(e){this.tileUnloadEvent.fireEvent(e),--this.statistics.numberOfTilesWithContentReady,e.unloadContent()}createTile(){return null}loadTileset(e,t){}debugShowStatistics(e){if(!this._debugShowStatistics||0===this._selectedTiles.length)return;let t=0,i=0,a="";const n=this._selectedTiles;for(let e=0,s=n.length;e<s;++e){const s=n[e];a+="\nUrl: "+s._contentUrl,a+="\nLodLevel: "+s._debugLodLevel,s.content.trianglesLength>0&&(a+="\nTriangles: "+s.content.trianglesLength),a+="\nTexture Memory: "+r.Utils.toMemoryString(s.content.texturesByteLength),a+="\nGeometry Memory: "+r.Utils.toMemoryString(s.content.geometryByteLength),a+="\n",t+=s.content.geometryByteLength,i+=s.content.texturesByteLength}let s="";s+="\n -------------------------------- ",s+="\n[Statistics]",s+="\nFrameNumber: "+e.frameNumber,s+="\nTiles: "+n.length,s+="\nTotal Texture Memory: "+r.Utils.toMemoryString(i),s+="\nTotal Geometry Memory: "+r.Utils.toMemoryString(t),s+="\n",s+="\n[Detail]",s+=a,console.log(s)}explode(){}clone(e){return r.Utils.defined(e)||(e=new i),e.tileLoadedEvent=new r.Event,e.tileUnloadEvent=new r.Event,e.tileFailedEvent=new r.Event,e._copy(this),e}_copy(e){this._type=e._type,this._maximumMemoryUsage=e._maximumMemoryUsage,this._debugShowBoundingBox=e._debugShowBoundingBox,this._debugShowStatistics=e._debugShowStatistics,this._priorityRange=e._priorityRange,this._boundingBox=e._boundingBox.clone(),this._geometricError=e._geometricError,this.onDemand=e.onDemand,this.hasLayerInfo=e.hasLayerInfo,this._destroyed=e._destroyed}get maxDetailLevel(){return this._maxDetailLevel}set maxDetailLevel(e){this._maxDetailLevel=e}get visualRange(){return this._visualRange}set visualRange(e){this._visualRange=e}_isAvailableDetailLevel(e,t){return t=void 0===t?0:t,void 0===this._maxDetailLevel||void 0===e.detailLevel||e.detailLevel<this._maxDetailLevel+t}_inVisualRange(e){if(!this._boundingBox||!this._visualRange)return!0;const i=t.copy(this._boundingBox);i.copy(this._boundingBox),e.transformMatrix&&i.applyMatrix4(e.transformMatrix);const r=i.distanceToPoint(e.cameraPositionWc),a=void 0===this._visualRange.max?1/0:this._visualRange.max,n=void 0===this._visualRange.min?-1/0:this._visualRange.min;return r<=a&&r>=n}_createTraversalController(){this._traversalController=new r.TilesetTraversal}}r.AbstractTileset=i}(),function(){let e=new THREE.Sphere,t=new THREE.Vector3;class i{constructor(e,t){this._tileset=r.Utils.defaultValue(e,null),this._parent=t,this._destroyed=!1,this._databagId=e._databagId,this._fileId=e._fileId,this._childrenTree=[],this._boundingBox=void 0,this._transformedBoundingBox=void 0,this._transformMatrix=new THREE.Matrix4,t?(t.childrenTree.push(this),this._depth=t._depth+1):this._depth=0,this._visible=!1,this._content=void 0,this._contentUrl=void 0,this._contentOutlineUrl=void 0,this._contentType=void 0,this._contentIndex=void 0,this._contentState=r.TileContentState.UNLOADED,this._childrenState=r.TileContentState.UNLOADED,this._priority=0,this._visibilityPriority=5,this._distance=0,this._projectedDistanceFromCenter=0,this._contentProcessDeferred=void 0,this._contentReadyDeferred=void 0,this._request=void 0,this._instanceInfoArray=null,this._debugLodLevel=-1,this.refineReplace=void 0,this.geometricError=0,this.sse=0,t&&t.layerInfo?this.layerInfo=Object.assign({},t.layerInfo):this.layerInfo={},this._id=null,this.labelAdded=!1,this.buffer=null,this._foveatedFactor=0,this.priorityDegradation=!1,this.stateChangedRenderer=r.EnumChangedState.NONE,this.stateWireFrameChangedRenderer=r.EnumChangedState.START,this.selectionChangedRenderer=r.EnumChangedState.NONE,this.selectionWireFrameChangedRenderer=r.EnumChangedState.NONE,this.selectionMeshes=[],this.selectionWireFrames=[],this.forceUpdateWireFrame=!1,this._globaledBoundingBox=new THREE.Box3,this.numberOfUpdateVisibilityFrame=-1}destroy(){this._destroyed=!0,this._clearContent(),this._tileset=void 0,this._parent=void 0,this._childrenTree=void 0,this._boundingBox=void 0,this._transformedBoundingBox=void 0,this._transformMatrix=void 0,this._contentType=void 0,this._contentState=void 0,this._contentUrl=void 0,this._contentOutlineUrl=void 0,this._ancestorWithContent=void 0,this._ancestorWithAvailableContent=void 0,this.labelAdded=void 0,this.debugShowGeometricErrorHelper&&this.debugShowGeometricErrorHelper.destroy(),this.debugShowGeometricErrorHelper=null,this.forceUpdateWireFrame=void 0,this.stateChangedRenderer=void 0,this.stateWireFrameChangedRenderer=void 0}isDestroyed(){return this._destroyed}get visible(){return this._visible}set visible(e){this._visible=e}get nodeId(){return this._id}set nodeId(e){this._id=e}set contentVisible(e){this._content&&(this._content.visible=e),this.selectionMeshes.map((t=>{t.visible=e})),this.selectionWireFrames.map((t=>{t.visible=e}))}get contentVisible(){return!!this._content&&this._content.visible}get parent(){return this._parent}get childrenTree(){return this._childrenTree}get boundingBox(){return this._boundingBox}set boundingBox(e){return this._boundingBox=e}get depth(){return this._depth}set depth(e){return this._depth=e}get contentUrl(){return this._contentUrl}get contentOutlineUrl(){return this._contentOutlineUrl}set contentIndex(e){return this._contentIndex=e}get contentIndex(){return this._contentIndex}set contentUrl(e){return this._contentUrl=e}set contentOutlineUrl(e){return this._contentOutlineUrl=e}get content(){return this._content}set content(e){return this._content=e}get contentType(){return this._contentType}set contentType(e){this._contentType=e}get contentState(){return this._contentState}set contentState(e){this._contentState=e}get contentUnloaded(){return this._contentState===r.TileContentState.UNLOADED}get contentLoading(){return this._contentState===r.TileContentState.LOADING}get contentProcessing(){return this._contentState===r.TileContentState.PROCESSING}get contentConstructing(){return this._contentState===r.TileContentState.CONSTRUCTING}get childrenUnload(){return this._childrenState===r.TileContentState.UNLOADED}get childrenReady(){return this._childrenState===r.TileContentState.READY}get contentReady(){return this._contentState===r.TileContentState.READY}get contentAvailable(){return this.contentReady&&!this.contentTypeEmpty}get contentTypeTile(){return this.contentType===r.TileContentType.DATA_TILE||this.contentType===r.TileContentType.DATA_BIMTILE}get contentTypeMesh(){return this.contentType===r.TileContentType.DATA_MESH||this.contentType===r.TileContentType.DATA_B3DM}get contentTypeCMPT(){return this.contentType===r.TileContentType.DATA_CMPT}get contentTypePoint(){return this.contentType===r.TileContentType.DATA_POINT}get contentTypeInstance(){return this.contentType===r.TileContentType.DATA_INSTANCE}get contentTypeLine(){return this.contentType===r.TileContentType.DATA_LINE}get contentTypeMeshAvailable(){return this.contentTypeMesh||this.contentTypeInstance||this.contentTypePoint||this.contentTypeLine||this.contentTypeCMPT}get contentTypeEmpty(){return this.contentType===r.TileContentType.DATA_NULL||this.contentType===r.TileContentType.DATA_TILE||this.contentType===r.TileContentType.DATA_BIMTILE}get contentTypeNull(){return this.contentType===r.TileContentType.DATA_NULL}get contentProcessPromise(){if(this._contentProcessDeferred)return this._contentProcessDeferred.promise}get contentReadyPromise(){if(this._contentReadyDeferred)return this._contentReadyDeferred.promise}get instanceInfo(){return this._instanceInfoArray}set instanceInfo(e){this._instanceInfoArray=e}isContentVisible(e){return this.contentReady&&this.visible}getAbsoluteContentUrl(){return this._contentIndex}getOutlineContentUrl(){return this._contentOutlineUrl}update(e){if(!this.contentTypeEmpty){if(e.viewer.showTileType!=r.EnumShowTileType.All){if(e.viewer.showTileType==r.EnumShowTileType.OnlyInstance&&!this.contentTypeInstance)return;if(e.viewer.showTileType==r.EnumShowTileType.ExceptInstance&&this.contentTypeInstance)return}this.explode(),this.updateContent(e),this.applySelection(),this.applyFilter(),this.activateRenderables(),this.debugShowBoundingBox(e),this.debugShowGeometricError(e)}}process(e){this._content.update(e)}_makeRequest(e,t){const i=this;e.url=t.url,e.requestCallback=function(){const t=new r.Deferred;return i.fetchContentBlock(e.url,(function(e){t.resolve(e)}),(function(e){t.reject(e)})),e.cancelCallback=function(){},t.promise};const a=r.RequestScheduler.request(e);if(a)return a.then((function(t){return e.cancelCallback=void 0,t})).catch((function(t){return e.cancelCallback=void 0,Promise.reject(t)}))}requestContent(){const e=this.getAbsoluteContentUrl(),t=new r.Request({type:this._tileset.type,priorityCallback:this._createPriorityCallback(this)});this._request=t;let i=[e];const a=this.getOutlineContentUrl();a&&i.push(a);const n=this._makeRequest(t,{url:i});if(!n)return!1;const s=this._contentState;this._contentState=r.TileContentState.LOADING,this._contentProcessDeferred=new r.Deferred,this._contentReadyDeferred=new r.Deferred;const o=this._handleFailedContent(this,this._tileset),l=this;return n.then((function(e){l.isDestroyed()?o():l.parseContentBlock(e,(function(e){l._initialContent(e)}))})).catch((function(e){if(t.state===r.RequestState.CANCELLED)return l._contentState=s,--l._tileset.statistics.numberOfPendingRequests,++l._tileset.statistics.numberOfAttemptedRequests,void l._cancelSharedGeometryRequest();o(e)})),!0}parseContentBlock(e,t){t(e)}fetchContentBlock(e,t,i){r.Error.throwError(r.ERRORS.DEVELOPE_EXCEPTION,"Needs to be overridden by subclasses!")}createContent(e){return null}_initialContent(e){const t=this;t._content=t.createContent(e),t._contentState=r.TileContentState.PROCESSING,t._contentProcessDeferred.resolve(t._content),t._content.readyPromise.then((function(e){t._contentState=r.TileContentState.READY,t._contentReadyDeferred.resolve(e)}))}_createPriorityCallback(e){return function(){return e._priority}}_handleFailedContent(e,t){return function(i){e._contentState===r.TileContentState.PROCESSING?--t.statistics.numberOfTilesProcessing:--t.statistics.numberOfPendingRequests,e._contentState=r.TileContentState.FAILED,e._contentReadyDeferred&&e._contentReadyDeferred.reject(i),e._contentProcessDeferred&&e._contentProcessDeferred.reject(i)}}updateContent(e){this._content.update(e)}_clearContent(){this.cacheNode?this._tileset.cache.unloadTile(this):(this.unloadContent(),this._clearAllBuffer())}unloadContent(){this.disposeMeshIdMap(),this.disposeDebugBoundingBox(),this.disposeDebugGeometricError(),this._content&&this._content.destroy(),r.Utils.defined(this._content)&&this._tileset.statistics.decrementLoadCount(this._content),this._content=void 0,this._contentState=r.TileContentState.UNLOADED,this._request=this._request&&this._request.destroy(),this._contentProcessDeferred=this._contentProcessDeferred&&this._contentProcessDeferred.destroy(),this._contentReadyDeferred=this._contentReadyDeferred&&this._contentReadyDeferred.destroy(),this._clearAllBuffer(),this.stateChangedRenderer=r.EnumChangedState.NONE,this.stateWireFrameChangedRenderer=r.EnumChangedState.START,this.forceUpdateWireFrame=!1}updateVisibility(e){if(this.numberOfUpdateVisibilityFrame==e.frameNumber)return;this.numberOfUpdateVisibilityFrame=e.frameNumber;const t=this.computeTransformedBoundingBox(e);this.visible=this.culling(e,t),this.visible?(this.computeDistanceToCamera(e),this.computeSSE(e),this.priorityDegradation=this.isPriorityDegradation(e),this.adjustSseIfNeeded()):(this.sse=0,this._distance=9999,this.priorityDegradation=!0)}adjustSseIfNeeded(){1!==this._tileset.degradedFactor&&this.priorityDegradation&&this._ancestorWithContent&&(this.sse=this.sse*this._tileset.degradedFactor)}isPriorityDegradation(i){const a=this._tileset,n=i.camera,s=this._transformedBoundingBox.getBoundingSphere(e),o=s.radius,l=t.copy(i.cameraDirectionWc).multiplyScalar(this._projectedDistanceFromCenter),d=l.addVectors(i.cameraPositionWc,l).sub(s.center);if(d.length()>o){const e=d.normalize().multiplyScalar(o).add(s.center).sub(i.cameraPositionWc);this._foveatedFactor=1-Math.abs(e.normalize().dot(i.cameraDirectionWc))}else this._foveatedFactor=0;if(!a.foveatedConePriorityEnabled)return!1;if(1===a.foveatedConeFactor)return!1;const h=1-Math.cos(THREE.Math.degToRad(.5*n.fov)),c=a.foveatedConeFactor*h;if(this._foveatedFactor<=c)return!1;const u=r.Math.clamp((this._foveatedFactor-c)/(h-c),0,1),p=THREE.Math.lerp(a.foveatedSseRelaxation,a.maximumScreenSpaceError,u);return(0===this.sse&&this.parent?.5*this.parent.sse:this.sse)+p>=a.maximumScreenSpaceError}clearPriority(){this.parent&&(this.parent._minChildPriority=Number.MAX_VALUE)}computePriority(){const e=this._tileset,t=e._priorityRange.max,i=e._priorityRange.min,a=r.Math.isolateDigits(r.Math.normalize(e.type,0,10),1,16),n=r.Math.isolateDigits(r.Math.normalize(e.sequence,0,1e3),3,13),s=r.Math.isolateDigits(r.Math.normalize(this.detailLevel,0,10),1,12),o=r.Math.isolateDigits(r.Math.normalize(this._visibilityPriority,0,10),1,11),l=this.priorityDegradation?r.Math.isolateDigits(.1,1,10):0,d=r.Math.isolateDigits(r.Math.normalize(this._foveatedFactor,i.foveate,t.foveate),4,6),h=r.Math.isolateDigits(r.Math.normalize(this._depth,i.depth,t.depth),2,4),c=this.refineReplace?r.Math.isolateDigits(r.Math.normalize(this._distance,i.distance,t.distance),4,0):r.Math.isolateDigits(r.Math.normalize(t.sse-this.sse,i.sse,t.sse),4,0);this._priority=a,this._priority+=n,this._priority+=s,this._priority+=o,this._priority+=l,this._priority+=d,this._priority+=h,this._priority+=c,this.parent&&(this.parent._minChildPriority=Math.min(this.parent._minChildPriority,this._priority))}updatePriority(){this.parent&&(this._priority=this.parent._minChildPriority)}subdivideNodeSubstractive(e){}culling(e,t){return(e.globalMatrixUpdated||t)&&(this._globaledBoundingBox.copy(this._transformedBoundingBox),this._globaledBoundingBox.applyMatrix4(e.globalMatrix)),!!e.frustum.intersectsBox(this._globaledBoundingBox)}needUpdateTransformedBoundingBox(e){return void 0===this._transformedBoundingBox||void 0!==e.transformMatrix&&!e.transformMatrix.equals(this._transformMatrix)}computeTransformedBoundingBox(e){return!!this.needUpdateTransformedBoundingBox(e)&&(void 0===this._transformedBoundingBox&&(this._transformedBoundingBox=new THREE.Box3),this._transformedBoundingBox.copy(this._boundingBox),e.transformMatrix&&(this._transformedBoundingBox.applyMatrix4(e.transformMatrix),this._transformMatrix.copy(e.transformMatrix)),!0)}computeDistanceToCamera(e){const i=this._transformedBoundingBox;this._distance=i.distanceToPoint(e.cameraPositionWc),this._distance=this._distance<r.Math.EPSILON2?r.Math.EPSILON2:this._distance,i.getCenter(t),t.sub(e.cameraPositionWc),this._projectedDistanceFromCenter=t.dot(e.cameraDirectionWc)}passSSE(e){return this.sse>=e.maximumScreenSpaceError}passSSE_instanceLeafTile(e){return!!this.geScale_instanceLeafTile&&this.sse*this.geScale_instanceLeafTile>=e.maximumScreenSpaceError}meetsSSE(e){const t=this.parent;if(!t||t.refineReplace)return!0;return t.sse>e.maximumScreenSpaceError}computeSSE(e){const t=void 0!==e.geoErrScaleFactor?e.geoErrScaleFactor:1,i=this.geometricError*t;return this.sse=e.cameraPreSSE*(i/this._distance),this.sse}disposeMeshIdMap(){const e=this._content&&this._content._meshes;e&&e.traverse((e=>{"MeshEx"!==e.type&&"LineSegmentsEx"!==e.type||!e.name?"LineSegments"===e.type&&e.tileId&&(!0===e.isInstanceMeshNode?this.disposeInstanceLineNodeById(e.tileId):this.disposeLineNodeById(e.tileId)):!0===e.isInstanceMeshNode?this.disposeInstanceMeshNodeById(e.name):this.disposeMeshNodeById(e.name)}))}disposeMeshNodeById(e){}disposeInstanceLineNodeById(e){}disposeLineNodeById(e){}hasChildren(){return this._childrenTree.length>0}debugShowBoundingBox(){if(this._tileset._debugShowBoundingBox){if(!this._debugBoundingBox){const e=this._tileset._objectGroup,t=r.TilesUtil.getDebugColor(this._debugLodLevel,this.refineReplace);this._debugBoundingBox=new r.BBoxNode(this._boundingBox,t),this._debugBoundingBox.renderOrder=r.EnumRenderOrder.Effect-1,this._debugBoundingBox.matrixAutoUpdate=!1,e.add(this._debugBoundingBox),e.updateMatrixWorld(!0)}this._debugBoundingBox.visible=!0}}disposeDebugBoundingBox(){this._debugBoundingBox&&(this._debugBoundingBox.parent&&this._debugBoundingBox.parent.remove(this._debugBoundingBox),this._debugBoundingBox.geometry.dispose(),this._debugBoundingBox.material.dispose(),this._debugBoundingBox=void 0)}debugShowGeometricError(){if(!this._tileset._debugShowGeometricError)return;const e=this._tileset.debugShowGeometricErrorHelper;if(!1===this.labelAdded){this.labelAdded=!0;let i=this._boundingBox.getCenter(t);i.applyMatrix4(this._tileset._transformMatrix);const r={id:this._id,position:i,size:100,text:`${this._contentUrl}:${this.geometricError}`,tooltip:this.geometricError};e.addLabel(r)}e.showById(this._id),e.update()}disposeDebugGeometricError(){if(!this._tileset._debugShowGeometricError)return;this._tileset.debugShowGeometricErrorHelper.removeById(this._id),this.labelAdded=!1}applyFilter(){}applySelection(){}activateRenderables(){this.contentVisible=!0}explode(){}getTexturesByteLength(){this.content.getTexturesByteLength()}sharedGeometryDestroy(){return!1}_cancelSharedGeometryRequest(){}_clearAllBuffer(){}clone(e){return r.Utils.defined(e)||(e=new i),e._copy(this),e}_copy(e){this.refineReplace=e.refineReplace,this.geometricError=e.geometricError,this._boundingBox=e._boundingBox,this._contentUrl=e._contentUrl,this._contentType=e._contentType,this._contentIndex=e._contentIndex,this._childrenState=e._childrenState,this._destroyed=e._destroyed,this._childrenTree=[],this._transformMatrix=e._transformMatrix.clone(),this._depth=e._depth,this._visible=e._visible,this._priority=e._priority,this._instanceInfoArray=null,this._debugLodLevel=e._debugLodLevel,this.layerInfo=e.layerInfo}}r.AbstractTile=i}(),function(){class e{constructor(e,t){this._tile=e,this._ready=!1,this._destroyed=!1,this._contentBuffer=t,this._geometryByteLength=0;for(const e in t)this._geometryByteLength+=t[e].byteLength;this._texturesByteLength=0,this._trianglesLength=0,this._state=r.TileContentProcessState.PENDING,this._meshes=new THREE.Group,this._meshes.name=r.Utils.getEncodedString(this._tile.getAbsoluteContentUrl())||e.name,this._meshes.databagId=e._databagId,this._meshes.fileId=e._fileId,this._meshes.tileId=e.contentId,this._meshes.matrixAutoUpdate=!1,this._readyDeferred=new r.Deferred,this._geometryOwner=0}destroy(){this._destroyed=!0,this._contentBuffer=void 0,this._readyDeferred=this._readyDeferred.destroy(),this.disposeGeometry(),this._tile=void 0}isDestroyed(){return this._destroyed}get tile(){return this._tile}get ready(){return this._ready}get geometryByteLength(){return this._geometryByteLength}set geometryByteLength(e){this._geometryByteLength=e}get texturesByteLength(){return this._texturesByteLength}get trianglesLength(){return this._trianglesLength}get readyPromise(){return this._readyDeferred.promise}get meshes(){return this._meshes}set visible(e){this._meshes.visible=e,this._outlineContent&&(this._outlineContent.visible=e),this._copyMeshes&&(this._copyMeshes.visible=e)}get visible(){return this._meshes.visible}getTexturesByteLength(){const e=this._meshes.children;for(let t of e)if(t.children&&t.children.length>0){for(let e of t)if(e.material)for(let t of e.material)t._imageByteSize&&!t._sizeCached&&(this._texturesByteLength+=t._imageByteSize,t._sizeCached=!0)}else if(t.material)for(let e of t.material)e._imageByteSize&&!e._sizeCached&&(this._texturesByteLength+=e._imageByteSize,e._sizeCached=!0)}disposeGeometry(){if(this._meshes.parent&&this._meshes.parent.remove(this._meshes),!this.disposeShareGeometry())return;this._texturesByteLength=0;const e=this._meshes.children;for(let t=0,i=e.length;t<i;++t){const i=e[t];if(i.children&&i.children.length)for(let e=0,t=i.children.length;e<t;++e){const t=i.children[e],r=t.geometry;r&&r.dispose(),r.groups=void 0,r.index=void 0,r.attributes=void 0,t.geometry=void 0,this._disposeMaterials(t.material),t.material=void 0}else if(i.geometry){const e=i.geometry;e.dispose(),e.groups=void 0,e.index=void 0,e.attributes=void 0,i.geometry=void 0,this._disposeMaterials(i.material),i.material=void 0}}this._meshes=void 0}update(e){const t=this;let i=!1;this._state===r.TileContentProcessState.PENDING?(this._state=r.TileContentProcessState.PROCESSING,t.parseTileContent((function(e){t.attachToTilesGroup(e),t.disposeContentBuffer(),t._state=r.TileContentProcessState.PROCESSED}))):this._state===r.TileContentProcessState.PROCESSING||this._state===r.TileContentProcessState.PROCESSED&&(t._tile._clearAllBuffer(),i=!0),this._ready||i&&e.afterRenderFns.push((function(){t._ready=!0,t._readyDeferred&&t._readyDeferred.resolve(t)}))}parseTileContent(e){e&&e(this._tile)}attachToTilesGroup(e){const t=this._tile._tileset._objectGroup;t.add(this.meshes),t.updateMatrixWorld(!0)}disposeContentBuffer(){this._contentBuffer=void 0}disposeShareGeometry(){return!0}clone(t,i){return i=r.Utils.defaultValue(i,{}),(t=r.Utils.defaultValue(t,new e))._copy(this,i),t}_copy(e,t){this._tile=r.Utils.defaultValue(t.tile,e._tile),this._ready=e._ready,this._destroyed=e._destroyed,this._contentBuffer=e._contentBuffer,this._geometryByteLength=e._geometryByteLength,this._texturesByteLength=e._texturesByteLength,this._trianglesLength=0,this._state=r.TileContentProcessState.PENDING,this._meshes=e._meshes}_disposeMaterials(e){const t=this._tile._tileset.materialManager;if(r.Utils.isDefined(t)){let i=(e,t)=>{const i=t._imageByteSize;e.disposeMaterial(t)&&i&&(this._texturesByteLength+=i)};if(!(e instanceof Array))return void i(t,e);for(let r of e)r&&i(t,r)}}}r.AbstractTileContent=e}(),r.TileEmptyContent=class{constructor(e){this._tile=e}destroy(){this._tile=void 0}get geometryByteLength(){return 0}get texturesByteLength(){return 0}get trianglesLength(){return 0}get readyPromise(){}update(e){}},r.TileTilesetContent=class{constructor(e,t){this._tile=e,this._destroyed=!1,this._ready=!1,this._readyDeferred=new r.Deferred,this._initialize(t)}destroy(){this._destroyed=!0,this._tile=void 0,this._readyDeferred.destroy(),this._readyDeferred=void 0}isDestroyed(){return this._destroyed}_initialize(e){const t=this._tile;t._tileset.createChildrenOfTile(t,e)}get geometryByteLength(){return 0}get texturesByteLength(){return 0}get trianglesLength(){return 0}get readyPromise(){return this._readyDeferred.promise}update(e){this._ready||(this._ready=!0,this._readyDeferred&&this._readyDeferred.resolve(this),e.afterRenderFns.push((function(){})))}},r.TilesCacheScheduler=class{constructor(e){e=r.Utils.defaultValue(e,{}),this._maximumMemoryUsage=e.maximumMemoryUsage||2048,this._destroyed=!1,this._statistics=new r.Statistics,this._statisticsLast=new r.Statistics,this._tilesCache=new r.TilesCache(this)}destroy(){this._destroyed=!0,this._tilesCache.destroy(),this._tilesCache=void 0,this._statistics.destroy(),this._statistics=void 0,this._statisticsLast.destroy(),this._statisticsLast=void 0}isDestroyed(){return this._destroyed}get statistics(){return this._statistics}get tilesCache(){return this._tilesCache}get maximumMemoryUsage(){return this._maximumMemoryUsage}set maximumMemoryUsage(e){this._maximumMemoryUsage=e}get totalMemoryUsageInBytes(){var e=this._statistics;return e.texturesByteLength+e.geometryByteLength}clearStatistics(){this._statistics.clear()}resetTilesCache(e){e.newFrame&&this._tilesCache.reset()}update(){this._tilesCache.unloadTiles()}},r.TextureManager=class{constructor(e,t={}){this._textureMap={},this._imageUrlMap={},this._typicalTextureLoader=new r.TextureLoader,this._typicalTextureLoader.crossOrigin=!0,this._basisTextureLoader=r.MaterialUtil.getBasisTextureLoader(),this._ktx2TextureLoader=r.MaterialUtil.getKTX2TextureLoader(),this._textureLoader=this._typicalTextureLoader,this._viewer=e,this._textureEncoding=r.Utils.defaultValue(t.textureEncoding,THREE.GammaEncoding);const i=document.createElement("canvas"),a=i.getContext("2d");a.fillStyle="#FFFFFF",a.fillRect(0,0,1,1),this.defaultTexture=new THREE.CanvasTexture(i),this.defaultTexture.generateMipmaps=!1}destroy(){this._textureMap=null,this._typicalTextureLoader=null,this._basisTextureLoader=null,this._textureLoader=null,this._viewer=null}_dealWithTexturePara(e,t){const{textureName:i,textureEncoding:a,textureParm:n,fromWorker:s}=t;e.name=i,this._textureMap[i]=e,e._referenceCount=1,e.encoding=a,s?(e.bumpScale=n.depth,e.repeat.fromArray([n.scaleU,n.scaleV]),e.offset.fromArray([n.offsetU,n.offsetV]),e.rotation=THREE.Math.degToRad(n.angle),n.repeatU&&(e.wrapS=THREE.RepeatWrapping),n.repeatV&&(e.wrapT=THREE.RepeatWrapping)):(e.bumpScale=n.getDepth(),e.repeat.fromArray([n.getScaleU(),n.getScaleV()]),e.offset.fromArray([n.getOffsetU(),n.getOffsetV()]),e.rotation=THREE.Math.degToRad(n.getAngle()),n.getRepeatU()&&(e.wrapS=THREE.RepeatWrapping),n.getRepeatV()&&(e.wrapT=THREE.RepeatWrapping)),r.MaterialUtil.updateUVMatrix(e)}getTextureFromURL(e,t,i){const a=r.Utils.defaultValue(i.textureEncoding,this._textureEncoding);e=r.RequestSpliter.splitByUrlMd5(e);const n=r.Utils.defaultValue(i.imageType,".png"),s=i.textureParm,o=i.fromWorker;return this._chooseTextureLoader(n),new Promise((i=>{const l=this._textureMap[t];if(r.Utils.isDefined(l))return l._referenceCount++,void i(l);if(r.EnableStorage)this._createTextureWithIndexDB(e,n).then((e=>{this._dealWithTexturePara(e,{textureName:t,textureEncoding:a,textureParm:s,fromWorker:o}),i(e)}));else if(".org"===n){const n=new THREE.FileLoader;n.setResponseType("arraybuffer"),n.load(e,(n=>{let l=new THREE.Texture;l.src=e,(new TEST.CryptoResourceLoader).load(n,(e=>{const n=new Blob([e],{type:"jpeg"});let d=new Image;d.onload=()=>{l.image=r.MaterialUtil.ensurePowerOfTwo(d),l.needsUpdate=!0,this._dealWithTexturePara(l,{textureName:t,textureEncoding:a,textureParm:s,fromWorker:o}),i(l)},d.src=URL.createObjectURL(n)}))}))}else this._loadTextureFromURL(e,n).then((e=>{this._dealWithTexturePara(e,{textureName:t,textureEncoding:a,textureParm:s,fromWorker:o}),i(e)}))}))}getTextureFromBuffer(e,t,i){const a=r.Utils.defaultValue(i.textureEncoding,this._textureEncoding),n=i.textureParm,s=i.fromWorker,o=r.Utils.defaultValue(i.imageType,".png");return this._chooseTextureLoader(o),new Promise((i=>{const o=this._textureMap[t];if(r.Utils.isDefined(o))o._referenceCount++,i(o);else{const r=new Blob([e],{type:"image/jpeg"});if(this._textureLoader.supportsImageBitmap&&this._textureLoader.supportsImageBitmap(r)){const e=t;this._textureLoader.loadFromBlob(e,r,(e=>{e.flipY=!1,this._dealWithTexturePara(e,{textureName:t,textureEncoding:a,textureParm:n,fromWorker:s}),i(e)}))}else{const e=(window.URL||window.webkitURL).createObjectURL(r);this._textureLoader.load(e,(e=>{e.flipY=!1,this._dealWithTexturePara(e,{textureName:t,textureEncoding:a,textureParm:n,fromWorker:s}),i(e)}))}}}))}disposeTexture(e){return e._referenceCount--,!e._referenceCount&&(e.dispose(),delete this._textureMap[e.name],e=null,!0)}_createTextureWithIndexDB(e,t){return new Promise(((i,a)=>{r.storageManager.getTexture(e).then((t=>{let a=t;!0===this._imageUrlMap[e]?(a=t.clone(),a.needsUpdate=!0):this._imageUrlMap[e]=!0,a.image=r.MaterialUtil.ensurePowerOfTwo(t.image),a.wrapS=THREE.RepeatWrapping,a.wrapT=THREE.RepeatWrapping,i(a)})).catch((()=>{this._loadTextureFromURL(e,t).then((t=>{r.storageManager.addTexture(t,e).catch((e=>{})),i(t)})).catch((e=>{console.log(e),a()}))}))}))}_loadTextureFromURL(e,t){return new Promise((i=>{t&&this._chooseTextureLoader(t),this._textureLoader.load(e,(t=>{let a=t;!0===this._imageUrlMap[e]?(a=t.clone(),a.needsUpdate=!0):this._imageUrlMap[e]=!0,a.image=r.MaterialUtil.ensurePowerOfTwo(t.image),a.wrapS=THREE.RepeatWrapping,a.wrapT=THREE.RepeatWrapping,i(a)}),void 0,(()=>{i(this.defaultTexture)}))}))}_chooseTextureLoader(e){switch(e){case".basis":this._textureLoader=this._basisTextureLoader,this._textureLoader.detectedSupport||this._textureLoader.detectSupport(this._viewer.getRenderer());break;case".ktx2":this._textureLoader=this._ktx2TextureLoader,this._textureLoader.basisLoader.detectedSupport||this._textureLoader.basisLoader.detectSupport(this._viewer.getRenderer());break;default:this._textureLoader=this._typicalTextureLoader}return this._textureLoader}},function(){function e(e,t){return t._distance-e._distance}r.TilesetTraversal=class{constructor(){this.traversalStack=[],this.emptyTraversalStack=[],this.traversalDescendants=[]}destroy(){this.traversalStack=null,this.emptyTraversalStack=null,this.traversalDescendants=null}traverseTiles(e,t,i){const r=this.traversalStack;for(r.push(t);r.length>0;){const t=r.pop(),a=t.refineReplace,n=!t.parent||t.parent._refines;let s=!1;if(this.updateTileContentLinksToAncestor(t,i),e._isAvailableDetailLevel(t)){if(e._fetchChildrenOfTile(t,i),e.onDemandJudgment(t))continue;e._canBeTraverse(t,i)&&(s=this.subdivideTile(e,t,i),s=s&&n)}if(e._addTileToRequestedQueue(t,i),a){!s&&n&&e._addTileToSelectedQueue(t,i)}else e._addTileToSelectedQueue(t,i);e.visitTile(t,i),e.touchTile(t,i),t._refines=s}}subdivideTile(t,i,r){const a=this.traversalStack,n=i.childrenTree;n.forEach((e=>{t.updateTile(e,r)})),n.sort(e);const s=i.refineReplace&&!i.contentTypeEmpty;let o=!0,l=!1;return n.forEach((e=>{if(e.visible?(a.push(e),l=!0):s&&(t._addTileToRequestedQueue(e,r),t.visitTile(e,r),t.touchTile(e,r)),!s)return;const i=e.contentTypeEmpty?this.traverseTileWithEmptyContent(t,e,r):e.contentAvailable;o=o&&i})),l||(o=!1),o}traverseTileWithEmptyContent(e,t,i){const r=this.emptyTraversalStack;r.push(t);let a=!0;for(;r.length>0;){const t=r.pop();if(e._fetchChildrenOfTile(t,i),t.contentTypeTile&&!t.hasChildren()){a=!1;continue}let n=t.contentTypeEmpty&&e._canBeTraverse(t,i),s=t.contentTypeEmpty&&!t.hasChildren();n||t.contentAvailable||s||(a=!1),n&&t.childrenTree.forEach((t=>{e.updateTile(t,i),t.visible||(e._addTileToRequestedQueue(t,i),e.visitTile(t,i),e.touchTile(t,i)),r.push(t)}))}return a}updateTileContentLinksToAncestor(e,t){e._ancestorWithContent=void 0,e._ancestorWithAvailableContent=void 0;const i=e.parent;i&&(e._ancestorWithContent=i.contentTypeEmpty?i._ancestorWithContent:i,e._ancestorWithAvailableContent=i.contentAvailable?i:i._ancestorWithAvailableContent)}}}(),(()=>{let e=new THREE.Matrix4,t=new THREE.Vector3;class i extends r.BaseModelExplosion{constructor(e){super(e)}explode(){var e=this.model._getHandler();e&&e.explode()}preFloorExplode(e,t,i){let r={};for(var a=0,n=t.length;a<n;a++){let e=t[a].explodedHeight-t[a].elevation,n=new THREE.Vector3(i.x*e,i.y*e,i.z*e);t[a].preExplodedTranslation?r[t[a].name]=n.clone().sub(t[a].preExplodedTranslation):r[t[a].name]=n,t[a].preExplodedTranslation=n}const s=this,o=this.model.getAllNodeInfos(),l=Object.keys(o);let d=new THREE.Matrix4;for(let t=0,i=l.length;t<i;t++){const i=l[t],a=o[i];for(let t=0,n=a.length;t<n;t++){if(0==t){let e=r[a[t].userData.levelName]||new THREE.Vector3;d.makeTranslation(e.x,e.y,e.z),s.explosionTranslation[i]=e}a[t].boundingBox.applyMatrix4(d),a[t].matrix.multiplyMatrices(d,a[t].matrix),e.union(a[t].boundingBox)}}e.applyMatrix4(this.model.getTransformMatrix())}getExplosionTranslation(e){return this.explosionTranslation[e]||new THREE.Vector3}getExplosionTranslationByObjId(e){return this.explosionTranslation[e]||new THREE.Vector3}getLevelNameByObjId(e){return this.model.getAllNodeInfos()[e][0].userData.levelName}preElementExplode(i,a){const n=this.model.getBoundingBoxWorld();if(!n)return;const s=a-this.model.manager.explosionManager.getExplosionExtent(this.model.id);if(0==s)return;let o=new THREE.Matrix4;e.copy(this.model.transformMatrix).invert();const l=n.getCenter(t).applyMatrix4(e),d=this.model.getAllNodeInfos(),h=Object.keys(d);let c=this.explosionTranslation;for(let e=0,t=h.length;e<t;e++){let t=h[e],a=d[t],n=new THREE.Box3;for(let e=0,t=a.length;e<t;e++)a[e].originBox||(a[e].originBox=a[e].boundingBox.clone()),n.union(a[e].originBox);let u=r.Utils.computeExplodeTranslation(l,n,s);c[t]=u,o.makeTranslation(u.x,u.y,u.z);for(let e=0,t=a.length;e<t;e++)a[e].boundingBox.applyMatrix4(o),a[e].matrix.multiplyMatrices(o,a[e].matrix),i.union(a[e].boundingBox)}i.applyMatrix4(this.model.getTransformMatrix())}}r.BMDModelExplosion=i})(),r.Loader=r.Loader||{},r.Loader.Url=class{constructor(e){this.databagPath=`${e.serverUrl}${e.databagId}`,this.lightmapPath=e.lightmapDatabagId?`${e.serverUrl}${e.lightmapDatabagId}`:e.lightmapDatabagId,this.shellDatabagId=e.shellDatabagId?`${e.serverUrl}${e.shellDatabagId}`:null}projectUrl(){return this.databagPath+"/config.json"}sceneUrl(e){return e=e||0,this.databagPath+"/scene/scene_"+e+r.GlobalData.ZipResourcePostfix}sceneIdUrl(){return this.databagPath+"/scene/scene_id"+r.GlobalData.ZipResourcePostfix}userIdUrl(){return this.databagPath+"/scene/user_id"+r.GlobalData.ZipResourcePostfix}octreeUrl(e){return e=e||"o",this.databagPath+"/scene/octree_"+e+r.GlobalData.ZipResourcePostfix}symbolUrl(){return this.databagPath+"/symbol/symbol"+r.GlobalData.ZipResourcePostfix}mpkUrl(e){return e=e||0,this.databagPath+"/mpk/mpk_"+e+r.GlobalData.ZipResourcePostfix}bmpkUrl(e){e=e||0;const t=this.databagPath+"/bmpk/bmpk_"+e+r.GlobalData.ZipResourcePostfix;return r.RequestSpliter.splitByContextId(t,e)}bmpkIndexUrl(){return this.databagPath+"/bmpk/index"+r.GlobalData.ZipResourcePostfix}meshIdUrl(){return this.databagPath+"/mpk/mesh_id"+r.GlobalData.ZipResourcePostfix}materialUrl(){return this.databagPath+"/material/material"+r.GlobalData.ZipResourcePostfix}uv2Url(){return this.lightmapPath?this.lightmapPath+"/uv2/uvs1-export.buf":this.databagPath+"/uv2/uvs1-export.buf"}uv2MapItemUrl(){return this.lightmapPath?this.lightmapPath+"/uv2/uvs1-export.json":this.databagPath+"/uv2/uvs1-export.json"}lightmapTexUrl(e){return this.lightmapPath?this.lightmapPath+"/texture/"+e:this.databagPath+"/texture/"+e}lightmapProjectUrl(){return this.lightmapPath?this.lightmapPath+"/config.json":this.lightmapPath}materialIdUrl(){return this.databagPath+"/material/material_id"+r.GlobalData.ZipResourcePostfix}texturePkgOrgIndexUrl(){return this.databagPath+"/texture/pkg_org_index"+r.GlobalData.ZipResourcePostfix}texturePkgSmallIndexUrl(){return this.databagPath+"/texture/pkg_s_index"+r.GlobalData.ZipResourcePostfix}texturePkgIndexUrl(e){return e?this.databagPath+"/texture/pkg_index"+r.GlobalData.ZipResourcePostfix:this.databagPath+"/texture/pkg_index"+r.GlobalData.JsonResourcePostfix}texturePkgFileName(e,t,i,a){var n=void 0;return n=e?`pkg_${i}`:`pkg_${a}_${i}`,t&&(n+=r.GlobalData.ZipResourcePostfix),n}bmpkPkgIndexUrl(){return this.databagPath+"/bmpk/pkg_index"+r.GlobalData.ZipResourcePostfix}userDataUrl(){return this.databagPath+"/userdata/userdata"+r.GlobalData.ZipResourcePostfix}cameraUrl(){return this.databagPath+"/scene/camera"+r.GlobalData.ZipResourcePostfix}textureUrl(e){const t=this.databagPath+"/texture/"+e,i=e.replace(/[^0-9]/gi,"");return r.RequestSpliter.splitByContextId(t,i)}layerUrl(){return this.databagPath+"/scene/layer"+r.GlobalData.ZipResourcePostfix}layerKeyUrl(){return this.databagPath+"/scene/layer_key"+r.GlobalData.ZipResourcePostfix}lineUrl(){return this.databagPath+"/line/line"+r.GlobalData.ZipResourcePostfix}layerSceneUrl(e){return e=e||0,this.databagPath+"/layer/layer_"+e+r.GlobalData.ZipResourcePostfix}layerSceneCell(){return this.databagPath+"/layer/layer_cell"+r.GlobalData.ZipResourcePostfix}layerOctree(){return this.databagPath+"/layer/layer_octree"+r.GlobalData.ZipResourcePostfix}borderLineUrl(e){return e=e||0,this.databagPath+"/outline/outline_"+e+r.GlobalData.ZipResourcePostfix}mpkBorderLineUrl(e){return e=e||0,this.databagPath+"/outline/outline_mpk_"+e+r.GlobalData.ZipResourcePostfix}terrainUrl(e,t,i){return this.databagPath+"/terrain/"+e+"/"+t+"/"+i+"/"+r.GlobalData.TerrainResourceFileName}sceneStatisticsUrl(){return this.databagPath+"/sceneStatistics.json"}shellModelUrl(){return this.shellDatabagId?`${this.shellDatabagId}/config.json`:null}},r.ModelView.WireframeManager=class{constructor(){this.defaultWireframeColor=r.MaterialUtil.DefaultWireframeColor,this.wireframeMaterial=new r.MeshBasicClipMaterial(this.defaultWireframeColor),!1===r.GlobalData.TranslucentDepthDisabled&&(this.wireframeMaterial.transparent=!0),this.instanceWireframeMaterial=r.MaterialUtil.createInstanceMaterial(r.MaterialUtil.getMaterialParameters(this.wireframeMaterial)),!1===r.GlobalData.TranslucentDepthDisabled&&(this.instanceWireframeMaterial.transparent=!0),this.wireframeGeometryMap={}}destroy(){this.wireframeMaterial.dispose(),this.wireframeMaterial=null,this.instanceWireframeMaterial.destroy(),this.instanceWireframeMaterial=null,this.wireframeGeometryMap=null,this.defaultWireframeColor=null}setWireframeColor(e,t){this.wireframeMaterial.color=e,this.wireframeMaterial.opacity=t,this.wireframeMaterial.transparent=1!=t,this.instanceWireframeMaterial.color=e,this.instanceWireframeMaterial.opacity=t,this.instanceWireframeMaterial.transparent=1!=t}getWireframeColor(){var e=this.wireframeMaterial.color.clone();return e.opacity=this.wireframeMaterial.opacity,e}restoreWireframeColor(){var e=this.defaultWireframeColor;this.setWireframeColor(e.color,e.opacity)}},r.ModelView.ConfigLoader=class{constructor(e){this.model=e,this.config=null,this.statistics={renderableCount:0,renderableTotal:r.GlobalData.maxObjectNumInPool,renderableTotalForPool:r.GlobalData.maxObjectNumInPool,numOfElements:0,numOfTriangles:0,numOfVertices:0,memoeryInfo:null},this.transformInfos={octreeTransformed:!0,boundingBox:null,position:new THREE.Vector3,rotation:new THREE.Quaternion,scale:new THREE.Vector3(1,1,1),transformMatrix:new THREE.Matrix4},this.sceneStatistics=void 0}destroy(){this.model=null,this.config=null,this.statistics=null,this.transformInfos=null,this.sceneStatistics=null}load(e){var t=this,i=this.model,a=i.dataUrl,n=i.fileLoader;n.setResponseType(""),n.load(a.projectUrl(),(function(a){var n;try{n=JSON.parse(a)}catch(e){return console.log("Config data exceptions!"),void i.dispatchEvent({type:r.EVENTS.ON_LOAD_INVALID_SCENE})}if(r.Utils.checkVersionMatch(r.Version,n.metadata.version)){if(0===n.metadata.scenes)return i.setEmptyScene(!0),void i.dispatchEvent({type:r.EVENTS.ON_LOAD_EMPTY_SCENE});0==n.metadata.gz?r.GlobalData.ZipResourcePostfix="":r.GlobalData.ZipResourcePostfix=".gz",i.setEmptyScene(!1),t._loadDataForSceneStatistics((function(){t._parse(n),e&&e()}))}else i.dispatchEvent({type:r.EVENTS.ON_VERSION_NO_MATCH,version:{engine:r.Version,data:n.metadata.version}})}),void 0,(function(){console.log("Config load error!"),i.dispatchEvent({type:r.EVENTS.ON_LOAD_INVALID_SCENE})}))}loadWithConfig(e,t){var i=this,a=this.model;if(r.Utils.checkVersionMatch(r.Version,e.metadata.version)){if(0===e.metadata.scenes)return a.setEmptyScene(!0),console.warn("The scene is Empty!"),a.dispatchEvent({type:r.EVENTS.ON_LOAD_EMPTY_SCENE,modelId:a.id}),void i._loadDataForSceneStatistics((function(){i._parse(e),t&&t()}));0==e.metadata.gz?r.GlobalData.ZipResourcePostfix="":r.GlobalData.ZipResourcePostfix=".gz",a.setEmptyScene(!1),i._loadDataForSceneStatistics((function(){i._parse(e),t&&t()}))}else a.dispatchEvent({type:r.EVENTS.ON_VERSION_NO_MATCH,version:{engine:r.Version,data:e.metadata.version}})}_loadDataForSceneStatistics(e){var t=this,i=this.model.fileLoader;const a=this.model.dataUrl.sceneStatisticsUrl();r.Storage.IndexedDBHelper.loadWithStorage("InfoData",a,(()=>new Promise(((e,t)=>{i.setResponseType(""),i.load(a,e,void 0,t)}))),(i=>{var r=JSON.parse(i);t.sceneStatistics=r.sceneStatistics,e&&e()}),e)}_parse(e){this.config=e,this._setMetadata(e),this._toStatistics(e),this._setTransformInfos(e),this._chooseRendering(e),this._setHandler(e)}_setMetadata(e){e.metadata.scenes=e.metadata.scenes?1:0,e.metadata.symbol=e.metadata.symbol?1:0,e.metadata.octree_o=e.metadata.octree_o?1:0,e.metadata.octree_i=e.metadata.octree_i?1:0,e.metadata.userdata=e.metadata.userdata?1:0,e.metadata.userId=1,e.metadata.camera=e.metadata.camera?1:0,e.metadata.material=e.metadata.material||0,e.metadata.material_json=e.metadata.material_json?1:0,e.metadata.lines=r.Compatibility.isLoadLinesEnabled(e.metadata.version)&&e.metadata.lines?1:0,e.metadata.outline_0=e.metadata.outline_0?1:0,e.metadata.outline_1=e.metadata.outline_1?1:0,e.metadata.outline_mpk=e.metadata.outline_mpk||0,e.metadata.mpk_shared_index=e.metadata.mpk_shared_index||e.metadata.outline_mpk}_getDataProvider(e){if(r.GlobalData.DataProvider===r.EnumDataProvider.MERGED&&void 0!==e.bmpks&&e.bmpks>0)return r.EnumDataProvider.MERGED;if(r.GlobalData.EnableLoadOnDemand&&e.layers){if(r.GlobalData.DataProvider===r.EnumDataProvider.LAYER_SCENE)return e.layers>1&&r.Compatibility.isLoadLayerSceneEnabled(e.version)?r.EnumDataProvider.LAYER_SCENE:r.EnumDataProvider.LAYER;if(r.GlobalData.DataProvider===r.EnumDataProvider.LAYER)return r.EnumDataProvider.LAYER}if(r.GlobalData.DataProvider===r.EnumDataProvider.AUTO){if(r.GlobalData.EnableLoadOnDemand&&e.layers)return e.layers>1&&r.Compatibility.isLoadLayerSceneEnabled(e.version)?r.EnumDataProvider.LAYER_SCENE:r.EnumDataProvider.LAYER;if(r.GlobalData.BatchMergeEnabled&&r.Compatibility.isLoadBMpkEnabled(e.version)&&void 0!==e.bmpks&&e.bmpks>0)return r.EnumDataProvider.MERGED}return r.EnumDataProvider.DEFAULT}_chooseRendering(e){this.model.manager.chooseRendering(this.statistics.memoeryInfo,!1,e)}_setHandler(e){var t=!(!r.GlobalData.CanUseWireframeFromData||!e.metadata.outline_0&&!e.metadata.outline_1),i=this._getDataProvider(e.metadata),a=null,n=this.model;const s={useDataWireframe:t,version:e.metadata.version};if(r.GlobalData.BatchMergeEnabled)switch(i){case r.EnumDataProvider.LAYER:r.GlobalData.HasLayerData=!0,r.GlobalData.LoadMpkOnDemand=!0,a=new r.ModelView.LayerBatchedHandler(n,t),n.loadMpkOnDemand=!0;break;case r.EnumDataProvider.LAYER_SCENE:r.GlobalData.HasLayerData=!0,r.GlobalData.LoadMpkOnDemand=!0,a=new r.ModelView.LayerSceneBatchedHandler(n,s),n.loadMpkOnDemand=!0;break;case r.EnumDataProvider.MERGED:a=new r.ModelView.DataBatchedHandler(n,s);break;default:a=new r.ModelView.BatchedHandler(n,s)}else if(r.GlobalData.OrganizeNodesByCameraView)switch(i){case r.EnumDataProvider.LAYER:r.GlobalData.HasLayerData=!0,r.GlobalData.LoadMpkOnDemand=!0,a=new r.ModelView.LayerIncrementHandler(n),n.loadMpkOnDemand=!0;break;case r.EnumDataProvider.LAYER_SCENE:r.GlobalData.HasLayerData=!0,r.GlobalData.LoadMpkOnDemand=!0,a=new r.ModelView.LayerSceneIncrementHandler(n),n.loadMpkOnDemand=!0;break;case r.EnumDataProvider.MERGED:a=new r.ModelView.DataBatchedHandler(n,s);break;default:a=new r.ModelView.IncrementHandler(n)}else switch(i){case r.EnumDataProvider.LAYER:r.GlobalData.HasLayerData=!0,r.GlobalData.LoadMpkOnDemand=!0,a=new r.ModelView.FreeLayerIncrementHandler(n);break;case r.EnumDataProvider.LAYER_SCENE:r.GlobalData.HasLayerData=!0,r.GlobalData.LoadMpkOnDemand=!0,a=new r.ModelView.FreeLayerSceneIncrementHandler(n),n.loadMpkOnDemand=!0;break;case r.EnumDataProvider.MERGED:a=new r.ModelView.DataBatchedHandler(n,s);break;default:e.metadata.mpk_batched?(console.log("use batched mpks"),a=new r.ModelView.IncrementBatchedHandler(n)):a=new r.ModelView.FreeIncrementHandler(n)}n._handler=a}_setTransformInfos(e){if(0!==e.view.transform?this.transformInfos.octreeTransformed=!0:this.transformInfos.octreeTransformed=!1,this.transformInfos.boundingBox=r.Utils.box3FromArray(e.view.bbox),e.view.rotation){var t=new THREE.Euler;t.fromArray(e.view.rotation),this.transformInfos.rotation.setFromEuler(t,!1)}e.view.position&&this.transformInfos.position.fromArray(e.view.position),e.view.scale&&this.transformInfos.scale.fromArray(e.view.scale),this.transformInfos.transformMatrix.compose(this.transformInfos.position,this.transformInfos.rotation,this.transformInfos.scale)}_toStatistics(e){e.count.texture_pixels&&e.count.texture_pixels>r.GlobalData.MaxTexturePixels&&(r.GlobalData.EnableTextureLoading=!1),void 0!==e.count&&(void 0!==e.count.mesh_face&&(this.statistics.numOfTriangles+=e.count.mesh_face),this.statistics.renderableTotal=0,this.statistics.renderableTotalForPool=0,void 0!==e.count.geom_box&&void 0!==e.count.geom_pipe&&void 0!==e.count.geom_tube&&void 0!==e.count.mesh?(this.statistics.renderableTotal+=e.count.geom_box,this.statistics.renderableTotal+=e.count.geom_pipe,this.statistics.renderableTotal+=e.count.geom_tube,this.statistics.renderableTotal+=e.count.mesh,this.statistics.renderableTotalForPool+=6*e.count.geom_box,this.statistics.renderableTotalForPool+=3*e.count.geom_pipe,this.statistics.renderableTotalForPool+=e.count.geom_tube,this.statistics.renderableTotalForPool+=e.count.mesh,this.statistics.numOfTriangles+=12*e.count.geom_box,this.statistics.numOfTriangles+=32*e.count.geom_pipe,this.statistics.numOfTriangles+=32*e.count.geom_tube):void 0!==e.count.geom&&void 0!==e.count.mesh&&(this.statistics.renderableTotal+=e.count.geom,this.statistics.renderableTotal+=e.count.mesh,this.statistics.numOfTriangles+=12*e.count.geom,this.statistics.numOfElements=this.statistics.renderableTotal,this.statistics.renderableTotalForPool=this.statistics.renderableTotal),void 0!==e.count.item&&(this.statistics.numOfElements=e.count.element||e.count.item)),this.sceneStatistics?(this.statistics.numOfTriangles=this.sceneStatistics.triangleTotalCount,this.statistics.numOfVertices=this.sceneStatistics.vertexTotalCount,this.statistics.numOfElements=this.sceneStatistics.elementCount,this.statistics.memoeryInfo=this._computeMaximumMemoryUsage(e)):(this.statistics.numOfVertices=this._computeNumOfVertices(e),this.statistics.memoeryInfo=this._computeApproximateMemoryUsage(e))}_computeNumOfVertices(e){return void 0===e.count?0:(e.count.mesh_vertex||0)+24*(e.count.geom_box||0)+130*(e.count.geom_pipe||0)+24*(e.count.geom_box_m||0)}_computeMaximumMemoryUsage(e){var t=this.sceneStatistics,i=t.vertexTotalCount,a=t.triangleTotalCount,n=0;n+=8*i,n+=3*a;var s=e.count.texture_pixels||0;return r.GlobalData.EnableTextureLoading&&(n+=4*s),n*=4,n*=1/1048576,{maxMemorySize:n=Math.ceil(n),triangleNumber:a}}_computeApproximateMemoryUsage(e){var t=0,i=0,a=1/1048576,n=e.count.mesh_vertex||0,s=e.count.mesh_face||0,o=e.count.geom_box||0,l=e.count.geom_pipe||0,d=130,h=124,c=e.count.texture_pixels||0;i+=8*n,i+=3*s,i+=0,i+=0,t+=6*n,t+=3*s,t+=0,t+=0;var u=0;return u+=s,o>0&&(u+=12*o),l>0&&(u+=h*l),u+=0,r.GlobalData.Instance?(o>0&&(i+=192,i+=36,i+=24*o,t+=144,t+=36,t+=18*o),l>0&&(i+=1040,i+=372,i+=24*l,t+=780,t+=372,t+=18*l)):(o>0&&(i+=24*o*8,i+=12*o*3,t+=24*o*6,t+=12*o*3),l>0&&(i+=l*d*8,i+=l*h*3,t+=l*d*6,t+=l*h*3)),r.GlobalData.EnableTextureLoading&&(i+=4*c,t+=4*c),i*=4,t*=4,i*=a,t*=a,{maxMemorySize:i=Math.ceil(i),minMemorySize:t=Math.ceil(t),triangleNumber:u,instanceEnabled:r.GlobalData.Instance}}getMemoryInfo(){return this.statistics.memoeryInfo}getStatistics(){return this.statistics}getConfig(){return this.config}getTransforms(){return this.transformInfos}setRenderableCount(e){this.statistics.renderableCount=e}getVersion(){return this.config.metadata.version}},function(){class e extends r.BaseModel{constructor(e,t,i,a,n){super(e,t),this.isBmdLayer=!0,this.filter=new r.FilterManager,this.filter.setObserverForSceneState(this.manager.getFilter().getObserverForSceneState()),this.debut=n,this.dataUrl=new r.Loader.Url(t),this.fileLoader=new THREE.FileLoader(new THREE.LoadingManager),this.configLoader=new r.ModelView.ConfigLoader(this),this.pool=e.getObjectPool(),this.firstOctreeTransform=!0,this.selectedMaterial=this.manager.sceneState.selectionMaterial,this.materialManager=new r.MaterialManager(e.viewer),this.wireframeManager=new r.ModelView.WireframeManager,this.cameraList=[],this.index=i,this.parseCfgFinish=a,this.progressPercentage={load:.4,collect:.5,merge:.1};const s=r.GlobalData.BatchAsyncProcessingFrequency;this.progressFrequency="number"==typeof s?s:10,this._rootNodeGroupName=r.ObjectGroupType.MODEL+"|"+this.databagId,this._rootNodeGroup=this._createRootNodeGroup(),this._rootNodeGroup.transformMatrix=this.transformMatrix,this._handler=null,this.lightmap=null!=t.lightmapDatabagId,this.lightmapNum=0,this.enableLightmap=!1,this.lightmapIntensity=r.GlobalData.LightmapIntensity,this.minDistanceObjects={},this.prioritizedNodeCount=0,this.plugins=[],this.modelExplosion=new r.BMDModelExplosion(this),this.isAllMaterialChanged=!1,this.loadMpkOnDemand=!1,this._vertexOffsetMatrix=void 0}destroy(){this.selectedMaterial=null,this.cameraList=null,this.occlusionCamera&&(this.occlusionCamera=null),this._handler&&(this._handler.destroy(),this._handler=null),this.wireframeManager.destroy(),this.wireframeManager=null,this.materialManager.disposeMaterials(this),this.materialManager.destroy(),this.materialManager=null,this.pool=null;for(var e=0,t=this.plugins.length;e<t;e++)this.plugins[e].destroy(),this.plugins[e]=null;this.plugins=null,this.configLoader.destroy(),this.configLoader=null,this._removeMeshNodeGroup(),this.removeAllFromOctantMap(),this.dataUrl=null,this.fileLoader=null,this.debut=null,this.parseCfgFinish=null,this.progressPercentage=null,this.minDistanceObjects=null,this._vertexOffsetMatrix=void 0,super.destroy()}_createRootNodeGroup(){return this.manager.scene.getOrCreateObjectGroup(this._rootNodeGroupName,{pickableType:r.PICKABLETYPE.Geometry,globalSpace:!0})}_getWireframeGroupName(){return r.ObjectGroupType.WIREFRAME+"|"+this.getEncodedDatabagId()}load(e){var t=this;return new Promise(((i,r)=>{this.configLoader.loadWithConfig(this.config,(function(){t.parseCfgFinish&&t.parseCfgFinish(),t.manager.updateScene(),t._getHandler().load(e),i()}))}))}setCrossOrigin(e){this.fileLoader.setCrossOrigin(e)}prepare(e,t){var i=this._getHandler();i&&i.prepare(e,t)}dispatchEvent(e){this.manager.dispatchEvent(e)}setLoaded(e){this.loaded=e}isLoaded(){return!!this._handler&&this.loaded}isEmptyScene(){return this.emptyScene}setEmptyScene(e){this.emptyScene=e}isLayerData(){return!(!this._handler||"layer"!==this._handler.tag)}isVisible(){return this.visible}setVisible(e){this.visible=e,this._rootNodeGroup.visible!==e&&(this._rootNodeGroup.visible=e,this._rootNodeGroup.pickableType=e?r.PICKABLETYPE.Geometry:r.PICKABLETYPE.UnPickable,this.manager.setRenderStateChanged(!0))}calculateCameraModelRelation(e){this.containsCamera=this.getModelDescriptor().isOctreeOuter(e)}addCamera(e){this.cameraList.push(e)}getCameraNameList(){for(var e=[],t=this.cameraList.length-1;t>=0;t--)e.push(this.cameraList[t].name);return e}getCamera(e){for(var t=this.cameraList.length-1;t>=0;t--)if(this.cameraList[t].name===e)return this.cameraList[t];return null}updateOctreeNode(e){if(e||this.firstOctreeTransform){this.firstOctreeTransform&&(this.firstOctreeTransform=!1);var t=this.manager.scene.getMatrixGlobal();this.getModelDescriptor().updateOctreeNode(t,this.getTransformMatrix())}}isDataReady(){var e=this._handler;return!!e&&e.isDataReady()}updateMeshNodes(){var e=this._getHandler();e&&e.updateNodes()}_getHandler(){return this._handler}getMeshesByUserIds(e,t){if(e&&t){this.minDistanceObjects[e]=[],this.minDistanceObjects[t]=[];var i=this._getHandler();i&&i.getMeshesByUserIds(e,t);for(var r=0,a=this.plugins.length;r<a;r++)this.plugins[r].getMeshesByUserIds([e,t])}}applyFilter(){for(var e=0,t=this.plugins.length;e<t;e++)this.plugins[e].applyFilter();var i=this._getHandler();i&&i.applyFilter()}applySelection(){for(var e=0,t=this.plugins.length;e<t;e++)this.plugins[e].applySelection();var i=this._getHandler();i&&i.applySelection()}clearSelection(){for(var e=0,t=this.plugins.length;e<t;e++)this.plugins[e].clearSelection();var i=this._getHandler();i&&i.clearSelection()}applyHover(){for(var e=0,t=this.plugins.length;e<t;e++)this.plugins[e].applyHover();var i=this._getHandler();i&&i.applyHover()}clearHover(){for(var e=0,t=this.plugins.length;e<t;e++)this.plugins[e].clearHover();var i=this._getHandler();i&&i.clearHover()}applyBlink(){var e=this._getHandler();e&&e.applyBlink()}clearBlink(){var e=this._getHandler();e&&e.clearBlink()}applyReplacement(){var e=this._getHandler();e&&(e.applyReplacement(),this.manager.setRenderStateChanged(!0))}_removeMeshNodeGroup(){this._removeNodeGroup(r.ObjectGroupType.GEOMETRY),this._removeNodeGroup(r.ObjectGroupType.INSTANCEGEOMETRY),this._removeNodeGroup(r.ObjectGroupType.WIREFRAME),this._removeNodeGroup(r.ObjectGroupType.INSTANCEWIREFRAMEGEOMETRY),this._removeSceneGroup(),this._rootNodeGroup.transformMatrix=null,this._rootNodeGroup=null}_getNodeGroup(e,t){for(var i=this._rootNodeGroup.children,a=0,n=i.length;a<n;a++)if(i[a].name==e)return i[a];var s=new r.ObjectGroup(e,t);switch(this._rootNodeGroup.add(s),s.globalSpace&&(s.matrixAutoUpdate=!1,s.updateMatrixWorld(!0)),e){case r.ObjectGroupType.GEOMETRY:case r.ObjectGroupType.INSTANCEGEOMETRY:s.renderOrder=r.EnumRenderOrder.Component;break;case r.ObjectGroupType.WIREFRAME:case r.ObjectGroupType.INSTANCEWIREFRAMEGEOMETRY:s.renderOrder=r.EnumRenderOrder.WireFrame}return s}_removeNodeGroup(e){this._rootNodeGroup.removeByName(e)}_hasNodeGroup(e){return this._rootNodeGroup.hasChild(e)}_removeSceneGroup(){this.manager.scene.removeObjectGroupByName(this._rootNodeGroupName),this.manager.scene.removeObjectGroupByName(this._getWireframeGroupName())}removeAllFromOctantMap(){this.manager.removeAllFromOctantMap(this.getEncodedDatabagId())}clearMeshFromOctantMap(){this.manager.clearMeshFromOctantMap(this.getEncodedDatabagId())}getMaterialManager(){return this.materialManager}clearWireframeElementCount(){this.wireframeElementCount=void 0}getWireframeElementCount(){if(void 0!==this.wireframeElementCount)return this.wireframeElementCount;var e=this.getModelDescriptor().getAllNodeInfos(),t=this.getFilter(),i=0;for(var r in e){var a=e[r];t._hasRenderWithBoardlineFilter()&&!t._isRenderWithBoardline(a[0])||(i+=a.length)}return this.wireframeElementCount=i,i}isActivateWireframe(){return this.manager.isDrawingBoardlineEnabled()}isOnlyWireframe(){return this.manager.isOnlyWireframe()}getLoadedUserIdsObject(){return this._handler&&this._handler.getLoadedUserIdsObject?this._handler.getLoadedUserIdsObject():null}clearNodeGroup(){var e=this._getNodeGroup(r.ObjectGroupType.GEOMETRY,{globalSpace:!0});e.clear(),(e=this._getNodeGroup(r.ObjectGroupType.WIREFRAME,{globalSpace:!0})).clear(),(e=this._getNodeGroup(r.ObjectGroupType.INSTANCEGEOMETRY,{globalSpace:!0})).clear(),(e=this._getNodeGroup(r.ObjectGroupType.INSTANCEWIREFRAMEGEOMETRY,{globalSpace:!0})).clear(),(e=this.manager.scene.getObjectGroup(this._getWireframeGroupName()))&&e.clear()}getWireframeMaterial(){return this.wireframeManager.wireframeMaterial}getInstanceWireframeMaterial(){return this.wireframeManager.instanceWireframeMaterial}getMaterialByMaterialId(e){return this.materialManager.materials[e]}adjustProgressPercentage(e,t,i){this.progressPercentage.load=e,this.progressPercentage.collect=t,this.progressPercentage.merge=i}setReplacedUserIdMap(e){r.Utils.isOwnEmptyObject(e)?this.replacedUserIdMap=null:this.replacedUserIdMap=e}hasReplacedUserId(){return!r.Utils.isEmptyObject(this.replacedUserIdMap)}isReplacedUserId(e){return this.replacedUserIdMap&&this.replacedUserIdMap[e]}registerPlugin(e){this.plugins.push(e)}disposeBufferAfterVbo(){var e=this._getHandler();e&&e.disposeBufferAfterVbo()}isHiddenUserId(e){var t=this._getHandler();return!!t&&t.isHiddenNode(e)}isHiddenSourceObjectUserId(e){return this.manager.isHiddenSourceObjectUserId(e,this.id)}hasHiddenSourceObjectUserId(){return this.manager.hasHiddenSourceObjectUserId()}getModelDescriptor(){return this._handler?this._handler.loader.getDescriptor():null}getLoader(){return this._handler.loader}getConfig(){return this.configLoader.getConfig()}getVersion(){return this.configLoader.getVersion()}getTransforms(){return this.configLoader.getTransforms()}getStatistics(){return this.configLoader.getStatistics()}setRenderableCount(e){this.configLoader.setRenderableCount(e),this._handler&&this._handler.clearPriorityNodesSet&&this._handler.clearPriorityNodesSet(!0)}getRenderableCount(){return this.configLoader.getStatistics().renderableCount}getBoundingBoxWorld(){if(!this.configLoader.getTransforms().boundingBox)return null;return this.configLoader.getTransforms().boundingBox.clone().applyMatrix4(this.getTransformMatrix())}calculateClippingIds(e,t){var i=this._getHandler();i&&i.calculateClippingIds(e,t)}calculateClippingContours(e){var t=this._getHandler();t&&t.calculateClippingContours(e)}getOctreeRoots(e){this.getModelDescriptor().getOctreeRoots(e)}isUserIdExist(e){return this.getModelDescriptor().isUserIdExist(e)}getNodeInfosByUserId(e){let t=this.getModelDescriptor().getNodeInfosByUserId(e);return t&&t instanceof Array&&(t[0].transformMatrix=this.getTransformMatrix()),t}getAllNodeInfos(){return this.getModelDescriptor()?this.getModelDescriptor().getAllNodeInfos():null}updateMaterialsValue(e,t,i){this.materialManager.updateMaterialsValue(this,e,t,i)}updateMaterials(){this.materialManager.updateMaterials(this)}switchNewStyleMaterial(e){this.materialManager.switchNewStyleMaterial(this,e)}changeAllMaterials(e){this.materialManager.changeAllMaterials(this,e),this.isAllMaterialChanged=!0}adjustVisibility(e){this._getHandler().adjustVisibility(e)}changeVisibilityOfSelectedObjects(e){this._getHandler().changeVisibilityOfSelectedObjects(e)}changeVisibilityOfNonSelectedObjects(e){this._getHandler().changeVisibilityOfNonSelectedObjects(e)}adjustInstanceVisibility(e){this._getHandler().adjustInstanceVisibility(e)}changeInstanceVisibilityOfSelectedObjects(e){this._getHandler().changeInstanceVisibilityOfSelectedObjects(e)}changeInstanceVisibilityOfNonSelectedObjects(e){this._getHandler().changeInstanceVisibilityOfNonSelectedObjects(e)}restoreVisibilityOfObjects(){this._getHandler().restoreVisibilityOfObjects()}isUseable(){return this.isLoaded()&&this.isVisible()}getFilter(){return this.filter}getMeshesForCap(e,t){let i=this.getId();if(e[i]=new r.ObjectGroup,e[i].matrix.copy(this.getTransformMatrix()),e[i].matrixAutoUpdate=!1,!this._handler)return;let a=this.getModelDescriptor().getAllNodeInfos(),n=this.materialManager.getBackMaterials();var s=this._handler.instancedManager;if(s.hasNodeInfo(this)){(l=s.getMeshManager().getPickingNodeGenerator(t).updatePickingMeshesStateForCap(this,a,n.instanceMaterials))&&e[i].add(l)}var o=this._handler.defaultManager;if(o.hasNodeInfo(this)){var l=o.getMeshManager().getPickingNodeGenerator(t).updatePickingMeshesStateForCap(this,a,n.batchMaterials);l&&e[i].add(l)}}getPickingMeshes(e,t,i,a,n){let s=this.getId();t[s]=new r.ObjectGroup,t[s].matrix.copy(this.getTransformMatrix()),t[s].matrixAutoUpdate=!1,this._dealNonInstancedNodesForPicking(e,t[s],i,a,n),this._dealInstancedNodesForPicking(e,t[s],i,a,n),this._dealPluginNodesForPicking(e,t[s],i,a,n)}_dealNonInstancedNodesForPicking(e,t,i,r,a){if(this._handler){var n=this._handler.defaultManager;if(n.hasNodeInfo(this)){var s=n.getMeshManager().getPickingNodeGenerator(a),o=s.updatePickingMeshes(e,i,r,this);if(o&&t.add(o),!s.reserveMaterial){var l=n.getWireFrameManager().getPickingNodeGenerator(a).updatePickingMeshes(e,i,r,this);l&&t.add(l)}}}}_dealInstancedNodesForPicking(e,t,i,r,a){if(this._handler){var n=this._handler.instancedManager;if(n.hasNodeInfo(this)){var s=n.getMeshManager().getPickingNodeGenerator(a),o=s.updatePickingMeshes(e,i,r,this);if(o&&t.add(o),!s.reserveMaterial){var l=n.getWireFrameManager().getPickingNodeGenerator(a).updatePickingMeshes(e,i,r,this);l&&t.add(l)}}}}_dealPluginNodesForPicking(e,t,i,r,a){if(this._handler)for(var n=this.plugins,s=0,o=n.length;s<o;s++){var l=n[s].getPickingNodeGenerator(a).updatePickingMeshes(e,i,r);l&&t.add(l)}}getBlinkMaterials(){var e=this._getHandler();return e?e.getBlinkMaterials():[]}hasTransforms(){return!0}enableColorWithoutLight(e){this.materialManager.enableColorWithoutLight(e)}enableLocalClippingMode(e){this.localClippingMode=e;var t=this._handler.instancedManager.meshManager,i=this._handler.instancedManager.wireframeManager;if(t.updateInstanceClipping(e),i.updateInstanceWireframeClipping(e),!e){for(var r in this.localClippingPlanes=null,this.materialManager.materials){(a=this.materialManager.materials[r]).clippingPlanes=null}for(var r in this.materialManager.instanceMaterials){var a;if((a=this.materialManager.instanceMaterials[r])instanceof Array)for(var n=0,s=a.length;n<s;n++)a[n].clippingPlanes=null;else a.clippingPlanes=null}}}clone(){}getImageByUrl(e){return this.materialManager.getImageByUrl(e)}getDefaultUnit(){return r.EnumLengthlUnits.Millimeter}getVertexOffsetMatrix(){if(void 0!==this._vertexOffsetMatrix)return this._vertexOffsetMatrix;const e=this.config.view.translation;return this._vertexOffsetMatrix=e?(new THREE.Matrix4).makeTranslation(-e[0],-e[1],-e[2]):null,this._vertexOffsetMatrix}getAllNodeGroups(){return this._rootNodeGroup.children}getAllWireframeGroupNames(){return[r.ObjectGroupType.WIREFRAME,r.ObjectGroupType.INSTANCEWIREFRAMEGEOMETRY,this._getWireframeGroupName()]}collectBlinkedMaterial(e,t){for(const i of e){const e=this.getAllNodeInfos()[i];e&&e.map((e=>{if(!0===e.instanceOrNot){this.materialManager.instanceMaterials[e.materialId].map((e=>{t.push(e)}))}else{const r=this.filter._getOverrideMaterialById(i)||this.materialManager.materials[e.materialId],a=`blink#${r.name}#${i}`,n=this.manager.sceneState.getBlinkMaterial(r,a);t.push(n)}}))}}getAllUserIds(){return Object.keys(this.getModelDescriptor().getAllNodeInfos())}updateNodeInfosForPlugins(){this.plugins&&this.plugins.length&&this.plugins.forEach((e=>{e.addToNodeInfoMap&&e.addToNodeInfoMap()}))}}e.EnumFilterState={CLIPPING:-2,HIDDEN:-1,NONE:0,SELECTED:1,BLINK:2,HOVER:3,TRANSPARENT:4,LOCALCLIPPING:5,OVERRIDED:6},r.Model=e}(),r.Loader.IdReader=function(e){var t=new Uint32Array(e,0,2);this.size=t[0],this.count=t[1],this.cache={},this.idBuffer=e.slice(8),t=null},r.Loader.IdReader.prototype={constructor:r.Loader.IdReader,getSize:function(){return this.size},getCount:function(){return this.count},getString:function(e){if(void 0!==this.cache[e])return this.cache[e];if(e>=0&&e<this.count){var t=new Uint8Array(this.idBuffer,this.size*e,this.size),i=String.fromCharCode.apply(null,t),r=i.indexOf("\0");return this.cache[e]=-1!==r?i.substring(0,r):i,this.cache[e]}},getIndex:function(e){if(null==e)return-1;for(var t=0,i=this.count-1,r=e.length;t<=i;){var a=Math.floor((t+i)/2),n=new Uint8Array(this.idBuffer,this.size*a,r),s=String.fromCharCode.apply(null,n),o=s.indexOf("\0"),l=0;if(0==(l=-1!==o?e.localeCompare(s.substring(0,o)):e.localeCompare(s)))return a;l<0?i=a-1:l>0&&(t=a+1)}return-1}},r.Loader.UserDataReader=function(e){for(var t in this.userData=JSON.parse(e),this.count=0,this.userData)this.userData.hasOwnProperty(t)&&this.count++;this.getCount=function(){return this.count},this.getData=function(){return this.userData},this.getUserData=function(e){if(e>=0&&e<this.count)return this.userData[e+""]}},r.Loader.OctNode=function(e,t){var i=new Uint32Array(e,t,5);this.cell_id=i[0],this.child_s=i[3],this.child_e=i[4];var r=new Float32Array(e,t+20,6);this.boundingBox=new THREE.Box3(new THREE.Vector3(r[0],r[1],r[2]),new THREE.Vector3(r[3],r[4],r[5]))},r.Loader.OctreeReader=function(e){var t=new Uint32Array(e,0,1);this.count=t[0],this.data=new Array(this.count);for(var i=0;i<this.count;++i)this.data[i]=new r.Loader.OctNode(e,4*(1+11*i))},r.Loader.OctreeReader.prototype={constructor:r.Loader.OctreeReader,getCount:function(){return this.count},getNode:function(e){if(e>=0&&e<this.count)return this.data[e]}},r.Loader.Material=function(e,t){var i=new Uint32Array(e,t,8);this.id=i[0],this.type=i[1],this.metal=i[2],this.color=i[3],this.emissive=i[4],this.specular=i[5],this.side=i[6],this.texture_n=i[7],this.texture_id=new Uint32Array(e,t+32,8);var r=new Float32Array(e,t+64,3);this.shininess=r[0],this.opacity=r[1],this.reflectivity=r[2],i=null,r=null},r.Loader.Texture=function(e,t){var i=new Uint32Array(e,t,4);this.id=i[0],this.type=i[1],this.repeat_u=i[2],this.repeat_v=i[3];var r=new Float32Array(e,t+16,5);this.angle=r[0],this.offset_u=r[1],this.offset_v=r[2],this.scale_u=r[3],this.scale_v=r[4];var a=new Uint8Array(e,t+36,8),n=String.fromCharCode.apply(null,a);this.file_name_ext=n.substring(0,n.indexOf("\0")),i=null,r=null,a=null},r.Loader.MaterialReader=function(e){var t=new Uint32Array(e,0,4);this.materialCount=t[0],this.materialOffset=t[1],this.textureCount=t[2],this.textureOffset=t[3],this.materialSize=76,this.textureSize=44,this.materialBuffer=e.slice(this.materialOffset,this.materialOffset+this.materialCount*this.materialSize),this.textureBuffer=e.slice(this.textureOffset,this.textureOffset+this.textureCount*this.textureSize),this.material_id=-1,this.texture_id=-1;var i=new ArrayBuffer(this.materialSize);this.material_cur=new r.Loader.Material(i,0),this.texture_cur=new r.Loader.Texture(i,0),t=null,i=null},r.Loader.MaterialReader.prototype={constructor:r.Loader.MaterialReader,getMaterial:function(e){if(e>=0&&e<this.materialCount)return new r.Loader.Material(this.materialBuffer,e*this.materialSize)},getTexture:function(e){if(e>=0&&e<this.textureCount)return new r.Loader.Texture(this.textureBuffer,e*this.textureSize)},getMaterialInfo:function(e){if(e==this.material_id)return this.material_cur;if(e>=0&&e<this.materialCount){var t=new Uint32Array(this.materialBuffer,e*this.materialSize,8);this.material_cur.id=t[0],this.material_cur.type=t[1],this.material_cur.metal=t[2],this.material_cur.color=t[3],this.material_cur.emissive=t[4],this.material_cur.specular=t[5],this.material_cur.side=t[6],this.material_cur.texture_n=t[7],this.material_cur.texture_id=new Uint32Array(this.materialBuffer,e*this.materialSize+32,8);var i=new Float32Array(this.materialBuffer,e*this.materialSize+64,3);return this.material_cur.shininess=i[0],this.material_cur.opacity=i[1],this.material_cur.reflectivity=i[2],t=null,i=null,this.material_id=e,this.material_cur}},getTextureInfo:function(e){if(e==this.texture_id)return this.texture_cur;if(e>=0&&e<this.textureCount){var t=new Uint32Array(this.textureBuffer,e*this.textureSize,4);this.texture_cur.id=t[0],this.texture_cur.type=t[1],this.texture_cur.repeat_u=t[2],this.texture_cur.repeat_v=t[3];var i=new Float32Array(this.textureBuffer,e*this.textureSize+16,5);this.texture_cur.angle=i[0],this.texture_cur.offset_u=i[1],this.texture_cur.offset_v=i[2],this.texture_cur.scale_u=i[3],this.texture_cur.scale_v=i[4];var r=new Uint8Array(this.textureBuffer,e*this.textureSize+36,8),a=String.fromCharCode.apply(null,r);return this.texture_cur.file_name_ext=a.substring(0,a.indexOf("\0")),t=null,i=null,r=null,this.texture_id=e,this.texture_cur}}},r.Loader.MaterialReaderJson=function(e){if(this.count=0,this.Data=JSON.parse(e),this.Data.hasOwnProperty("materials")&&(this.materials=this.Data.materials),this.Data.hasOwnProperty("metadata")&&(this.metadata=this.Data.metadata,this.metadata.hasOwnProperty("count")&&(this.count=this.metadata.count)),0===this.count)for(var t in this.materials)this.materials.hasOwnProperty(t)&&this.count++;this.getCount=function(){return this.count},this.getMaterial=function(e){if(e>=0&&e<this.count)return this.materials[e+""]}},r.Loader.LayerKeyReader=function(e){for(var t in this.LayerKey=JSON.parse(e),this.count=0,this.LayerKey)this.LayerKey.hasOwnProperty(t)&&this.count++;this.getCount=function(){return this.count},this.getData=function(){return this.LayerKey},this.getLayerKey=function(e){if(e>=0&&e<this.count)return this.LayerKey[e+""]}},r.Loader.LayerHeader=function(e){var t=new Uint32Array(e,0,4);this.layerCount=t[0],this.mpkBufferSize=t[1],this.layerOffset=t[2],this.mpkOffset=t[3];var i=new Float32Array(e,24,4);this.boundingBox=new THREE.Box3(new THREE.Vector3(i[0],i[1],i[2]),new THREE.Vector3(i[3],i[4],i[5])),t=null,i=null},r.Loader.LayerData=function(e,t){var i=new Int32Array(e,t,3);this.layer_id=i[0],this.layer_mpk_index=i[1],this.layer_mpk_count=i[2];var r=new Float32Array(e,t+12,6);this.boundingBox=new THREE.Box3(new THREE.Vector3(r[0],r[1],r[2]),new THREE.Vector3(r[3],r[4],r[5])),i=null,r=null},r.Loader.LayerReader=function(e){this.header=new r.Loader.LayerHeader(e),this.DataSize=36,this.dataBuffer=e.slice(this.header.layerOffset,this.header.layerOffset+this.header.layerCount*this.DataSize),this.mpkBuffer=e.slice(this.header.mpkOffset,this.header.mpkOffset+this.header.mpkBufferSize)},r.Loader.LayerReader.prototype={constructor:r.Loader.LayerReader,getLayerData:function(e){if(e>=0&&e<this.header.layerCount)return new r.Loader.LayerData(this.dataBuffer,e*this.DataSize)},getMpkList:function(e){var t=this.getLayerData(e);if(null!=t)return new Uint32Array(this.mpkBuffer,4*t.layer_mpk_index,t.layer_mpk_count)},getLayerCount:function(){return this.header.layerCount}},r.Loader.SymbolHeader=function(e){var t=new Uint32Array(e,0,9);this.blockId=t[0],this.symbolCount=t[1],this.itemCount=t[2],this.matrixCount=t[3],this.geomBuffSize=t[4],this.symbolOffset=t[5],this.itemOffset=t[6],this.matrixOffset=t[7],this.geomOffset=t[8];var i=new Float32Array(e,36,6);this.boundingBox=new THREE.Box3(new THREE.Vector3(i[0],i[1],i[2]),new THREE.Vector3(i[3],i[4],i[5])),t=null,i=null},r.Loader.Symbol=function(e,t){var i=new Int32Array(e,t,3);this.symbolId=i[0],this.itemIndex=i[1],this.itemCount=i[2];var r=new Float32Array(e,t+12,6);this.boundingBox=new THREE.Box3(new THREE.Vector3(r[0],r[1],r[2]),new THREE.Vector3(r[3],r[4],r[5])),i=null,r=null},r.Loader.SymbolReader=function(e,t){this.header=new r.Loader.SymbolHeader(e),this.symbolSize=36,this.itemSize=52,this.matrixSize=r.Compatibility.getMatrixSize(t),this.matrixDataType=r.Compatibility.getMatrixDatatype(t),this.geomSize=32,this.maxSize=256,this.boxUvSize=36,this.pipeUvSize=18,this.symbolBuffer=e.slice(this.header.symbolOffset,this.header.symbolOffset+this.header.symbolCount*this.symbolSize),this.itemBuffer=e.slice(this.header.itemOffset,this.header.itemOffset+this.header.itemCount*this.itemSize),this.matrixBuffer=e.slice(this.header.matrixOffset,this.header.matrixOffset+this.header.matrixCount*this.matrixSize),this.geomBuffer=e.slice(this.header.geomOffset,this.header.geomOffset+this.header.geomBuffSize),this.matr_cur_id=-1,this.pt_symb_min=new THREE.Vector3(0,0,0),this.pt_symb_max=new THREE.Vector3(0,0,0),this.pt_item_min=new THREE.Vector3(0,0,0),this.pt_item_max=new THREE.Vector3(0,0,0);var i=new ArrayBuffer(this.maxSize);this.symb_cur=new r.Loader.Symbol(i,0),this.item_cur=new r.Loader.Item(i,0),this.matr_cur=new r.Loader.Matrix(i,0,this.matrixDataType),this.pipe_cur=new r.Loader.GeomPipe(i,0),this.symb_cur.boundingBox.set(this.pt_symb_min,this.pt_symb_max),this.item_cur.boundingBox.set(this.pt_item_min,this.pt_item_max)},r.Loader.SymbolReader.prototype={constructor:r.Loader.SymbolReader,getSymbol:function(e){if(e>=0&&e<this.header.symbolCount)return new r.Loader.Symbol(this.symbolBuffer,e*this.symbolSize)},getItem:function(e){if(e>=0&&e<this.header.itemCount)return new r.Loader.Item(this.itemBuffer,e*this.itemSize)},getMatrix:function(e){if(e>=0&&e<this.header.matrixCount)return new r.Loader.Matrix(this.matrixBuffer,e*this.matrixSize,this.matrixDataType)},getGeomPipe:function(e){if(e>=0&&index<this.header.geomBuffSize)return new r.Loader.GeomPipe(this.geomBuffer,e)},getSymbolInfo:function(e){if(e>=0&&e<this.header.symbolCount){var t=new Int32Array(this.symbolBuffer,e*this.symbolSize,3);this.symb_cur.symbolId=t[0],this.symb_cur.itemIndex=t[1],this.symb_cur.itemCount=t[2];var i=new Float32Array(this.symbolBuffer,e*this.symbolSize+12,6);return this.pt_symb_min.set(i[0],i[1],i[2]),this.pt_symb_max.set(i[3],i[4],i[5]),this.symb_cur.boundingBox.set(this.pt_symb_min,this.pt_symb_max),this.symb_cur}},getItemInfo:function(e){if(e>=0&&e<this.header.itemCount){var t=new Int32Array(this.itemBuffer,e*this.itemSize,7);this.item_cur.ItemId=t[0],this.item_cur.originalId=t[1],this.item_cur.materialId=t[2],this.item_cur.userDataId=t[3],this.item_cur.matrixId=t[4],this.item_cur.type=t[5],this.item_cur.toData=t[6];var i=new Float32Array(this.itemBuffer,e*this.itemSize+28,6);return this.pt_item_min.set(i[0],i[1],i[2]),this.pt_item_max.set(i[3],i[4],i[5]),this.item_cur.boundingBox.set(this.pt_item_min,this.pt_item_max),this.item_cur}},getMatrixInfo:function(e){if(e==this.matr_cur_id)return this.matr_cur;if(e>=0&&e<this.header.matrixCount){const t=new this.matrixDataType(this.matrixBuffer,e*this.matrixSize,16);return this.matr_cur.matrix.fromArray(t),this.matr_cur_id=e,this.matr_cur}},getGeomPipeInfo:function(e){if(e>=0&&e<this.header.geomBuffSize){var t=new Float32Array(this.geomBuffer,e,8);return this.pipe_cur.startPt.set(t[0],t[1],t[2]),this.pipe_cur.endPt.set(t[3],t[4],t[5]),this.pipe_cur.radius=t[6],this.pipe_cur.thickness=t[7],this.pipe_cur}},getGeomBoxUvInfo:function(e){if(e>=0&&e+4*this.boxUvSize<=this.header.geomBuffSize)return new Float32Array(this.geomBuffer,e,this.boxUvSize)},getGeomPipeUvInfo:function(e){if(e>=0&&e+4*this.pipeUvSize<=this.header.geomBuffSize)return new Float32Array(this.geomBuffer,e,this.pipeUvSize)},getMpkID:function(e){return parseInt(e/65536)},getMeshIndex:function(e){return parseInt(e%65536)}},r.Loader.MPKHeader=function(e){var t=new Uint32Array(e,0,6);this.blockId=t[0],this.vtFormat=t[1],this.meshCount=t[2],this.meshOffset=t[3],this.bufferSize=t[4],this.bufferOffset=t[5],t=null},r.Loader.MeshData=function(e,t){var i=new Uint32Array(e,t,5);this.mesh_id=i[0],this.ptCount=i[1],this.idxCount=i[2],this.dataOffset=i[3],this.vertexFormat=i[4];var r=new Float32Array(e,t+20,4);this.baseScale=r[0],this.baseX=r[1],this.baseY=r[2],this.baseZ=r[3],i=null,r=null},r.Loader.MPKReader=function(e){this.header=new r.Loader.MPKHeader(e),this.meshSize=36,this.maxSize=256,this.meshBuffer=e.slice(this.header.meshOffset,this.header.meshOffset+this.header.meshCount*this.meshSize),this.geomBuffer=e.slice(this.header.bufferOffset,this.header.bufferOffset+this.header.bufferSize),this.mesh_cur_id=-1;var t=new ArrayBuffer(this.maxSize);this.mesh_cur=new r.Loader.MeshData(t,0)},r.Loader.MPKReader.prototype={constructor:r.Loader.MPKReader,getMeshData:function(e){if(e>=0&&e<this.header.meshCount)return new r.Loader.MeshData(this.meshBuffer,e*this.meshSize)},getMeshInfo:function(e){if(e==this.mesh_cur_id)return this.mesh_cur;if(e>=0&&e<this.header.meshCount){var t=new Uint32Array(this.meshBuffer,e*this.meshSize,5);this.mesh_cur.mesh_id=t[0],this.mesh_cur.ptCount=t[1],this.mesh_cur.idxCount=t[2],this.mesh_cur.dataOffset=t[3],this.mesh_cur.vertexFormat=t[4];var i=new Float32Array(this.meshBuffer,e*this.meshSize+20,4);return this.mesh_cur.baseScale=i[0],this.mesh_cur.baseX=i[1],this.mesh_cur.baseY=i[2],this.mesh_cur.baseZ=i[3],this.mesh_cur_id=e,this.mesh_cur}},getPtBuffer:function(e){if(e>=0&&e<this.header.meshCount){var t=this.getMeshInfo(e);if(void 0===t)return;return 0==t.baseScale?new Float32Array(this.geomBuffer,t.dataOffset,3*t.ptCount):new Uint16Array(this.geomBuffer,t.dataOffset,3*t.ptCount)}},getIdxBuffer:function(e){if(e>=0&&e<this.header.meshCount){var t=this.getMeshInfo(e);if(void 0===t)return;var i=t.dataOffset;return 0==t.baseScale?i+=3*t.ptCount*4:(i+=3*t.ptCount*2,t.ptCount%2==1&&(i+=2)),r.Compatibility.use32MpkData||t.ptCount>65535?new Uint32Array(this.geomBuffer,i,t.idxCount):new Uint16Array(this.geomBuffer,i,t.idxCount)}},getNormalBuffer:function(e){if(2==(2&this.header.vtFormat)&&e>=0&&e<this.header.meshCount){var t=this.getMeshInfo(e);if(void 0===t)return;var i=t.dataOffset;return 0==t.baseScale?i+=3*t.ptCount*4:(i+=3*t.ptCount*2,t.ptCount%2==1&&(i+=2)),r.Compatibility.use32MpkData||t.ptCount>65535?i+=4*t.idxCount:(i+=2*t.idxCount,t.idxCount%2==1&&(i+=2)),new Float32Array(this.geomBuffer,i,3*t.ptCount)}},getUVBuffer:function(e){if(e>=0&&e<this.header.meshCount){var t=this.getMeshInfo(e);if(void 0===t||4!=(4&t.vertexFormat))return;var i=t.dataOffset;return 0==t.baseScale?i+=3*t.ptCount*4:(i+=3*t.ptCount*2,t.ptCount%2==1&&(i+=2)),r.Compatibility.use32MpkData||t.ptCount>65535?i+=4*t.idxCount:(i+=2*t.idxCount,t.idxCount%2==1&&(i+=2)),2==(2&this.header.vtFormat)&&(i+=3*t.ptCount*4),new Float32Array(this.geomBuffer,i,2*t.ptCount)}},getOffsetIndexInfo:function(e,t){if(!(e<0||e>=this.header.meshCount)){var i=this.getMeshInfo(e),r=void 0!==t?!t:4==(4&i.vFormat);return{meshId:i.mesh_id,positionStart:i.vOffset/4,positionCount:3*i.ptCount,indexStart:i.iOffset/4,indexCount:i.idxCount,uvStart:r?i.tOffset/4:0,uvCount:r?2*i.ptCount:0}}},hasUV:function(e){if(!(e<0||e>=this.header.meshCount))return 4==(4&this.getMeshInfo(e).vFormat)}},r.Loader.BMPKHeader=function(e){var t=new Uint32Array(e,0,12);this.blockId=t[0],this.vtFormat=t[1],this.meshCount=t[2],this.meshOffset=t[3],this.ptBufferSize=t[4],this.ptBufferOffset=t[5],this.idxBufferSize=t[6],this.idxBufferOffset=t[7],this.norBufferSize=t[8],this.norBufferOffset=t[9],this.uvBufferSize=t[10],this.uvBufferOffset=t[11],this.matCount=0,t=null},r.Loader.BMPKMatrixHeader=function(e){var t=new Uint32Array(e,0,14);this.blockId=t[0],this.vtFormat=t[1],this.meshCount=t[2],this.meshOffset=t[3],this.ptBufferSize=t[4],this.ptBufferOffset=t[5],this.idxBufferSize=t[6],this.idxBufferOffset=t[7],this.norBufferSize=t[8],this.norBufferOffset=t[9],this.uvBufferSize=t[10],this.uvBufferOffset=t[11],this.matCount=t[12],this.matBufferOffset=t[13],t=null},r.Loader.BMeshData=function(e,t){var i=new Uint32Array(e,t,8);this.mesh_id=i[0],this.ptCount=i[1],this.idxCount=i[2],this.vFormat=i[3],this.vOffset=i[4],this.iOffset=i[5],this.nOffset=i[6],this.tOffset=i[7],i=null},r.Loader.BMPKReader=function(e,t){this.header=null,r.Compatibility.isUseDoubleMatrixMPKHeader(t)?this.header=new r.Loader.BMPKMatrixHeader(e):this.header=new r.Loader.BMPKHeader(e),this.meshSize=32,this.maxSize=256,this.meshBuffer=e.slice(this.header.meshOffset,this.header.meshOffset+this.header.meshCount*this.meshSize),this.vBuffer=e.slice(this.header.ptBufferOffset,this.header.ptBufferOffset+this.header.ptBufferSize),this.iBuffer=e.slice(this.header.idxBufferOffset,this.header.idxBufferOffset+this.header.idxBufferSize),this.nBuffer=e.slice(this.header.norBufferOffset,this.header.norBufferOffset+this.header.norBufferSize),this.tBuffer=e.slice(this.header.uvBufferOffset,this.header.uvBufferOffset+this.header.uvBufferSize),1===this.header.matCount&&(this.curMatrix=new r.Loader.Matrix(e,this.header.matBufferOffset,Float64Array).matrix.clone()),this.mesh_cur_id=-1;var i=new ArrayBuffer(this.maxSize);this.mesh_cur=new r.Loader.BMeshData(i,0)},r.Loader.BMPKReader.prototype={constructor:r.Loader.BMPKReader,getMeshData:function(e){if(e>=0&&e<this.header.meshCount)return new r.Loader.BMeshData(this.meshBuffer,e*this.meshSize)},getMeshInfo:function(e){if(e==this.mesh_cur_id)return this.mesh_cur;if(e>=0&&e<this.header.meshCount){var t=new Uint32Array(this.meshBuffer,e*this.meshSize,8);return this.mesh_cur.mesh_id=t[0],this.mesh_cur.ptCount=t[1],this.mesh_cur.idxCount=t[2],this.mesh_cur.vFormat=t[3],this.mesh_cur.vOffset=t[4],this.mesh_cur.iOffset=t[5],this.mesh_cur.nOffset=t[6],this.mesh_cur.tOffset=t[7],this.mesh_cur_id=e,this.mesh_cur}},getPtBuffer:function(e){if(e>=0&&e<this.header.meshCount){var t=this.getMeshInfo(e);if(void 0===t)return;return new Float32Array(this.vBuffer,t.vOffset,3*t.ptCount)}},getIdxBuffer:function(e){if(e>=0&&e<this.header.meshCount){var t=this.getMeshInfo(e);if(void 0===t)return;return new Uint32Array(this.iBuffer,t.iOffset,t.idxCount)}},getNormalBuffer:function(e){if(2==(2&this.header.vtFormat)&&e>=0&&e<this.header.meshCount){var t=this.getMeshInfo(e);if(void 0===t)return;return new Float32Array(this.nBuffer,t.nOffset,3*t.ptCount)}},getUVBuffer:function(e){if(e>=0&&e<this.header.meshCount){var t=this.getMeshInfo(e);if(void 0===t||4!=(4&t.vFormat))return;return new Float32Array(this.tBuffer,t.tOffset,2*t.ptCount)}},getOffsetIndexInfo:function(e,t){if(!(e<0||e>=this.header.meshCount)){var i=this.getMeshInfo(e),r=void 0!==t?!t:4==(4&i.vFormat);return{meshId:i.mesh_id,positionStart:i.vOffset/4,positionCount:3*i.ptCount,indexStart:i.iOffset/4,indexCount:i.idxCount,uvStart:r?i.tOffset/4:0,uvCount:r?2*i.ptCount:0}}},hasUV:function(e){if(!(e<0||e>=this.header.meshCount))return 4==(4&this.getMeshInfo(e).vFormat)},getMatrix:function(){return this.curMatrix}},r.Loader.BMeshIdReader=function(e){var t=new Uint32Array(e,0,1);this.count=t[0],this.cache={};for(var i=new Uint32Array(e,4,this.count),r=0;r<this.count;r+=2){var a=i[r];this.cache[a]=i[r+1]}t=null,i=null},r.Loader.BMeshIdReader.prototype={constructor:r.Loader.BMeshIdReader,getCount:function(){return this.count},getBMeshId:function(e){return this.cache[e]}},r.Loader.LineHeader=function(e){var t=new Uint32Array(e,0,7);this.blockId=t[0],this.lineCount=t[1],this.lineOffset=t[2],this.ptBufferSize=t[3],this.ptBufferOffset=t[4],this.idxBufferSize=t[5],this.idxBufferOffset=t[6],t=null},r.Loader.LineMatrixHeader=function(e){let t=new Uint32Array(e,0,9);this.blockId=t[0],this.lineCount=t[1],this.lineOffset=t[2],this.ptBufferSize=t[3],this.ptBufferOffset=t[4],this.idxBufferSize=t[5],this.idxBufferOffset=t[6],this.matCount=t[7],this.matBufferOffset=t[8],t=null},r.Loader.LineData=function(e,t){var i=new Uint32Array(e,t,6);this.line_id=i[0],this.lineType=i[1],this.ptCount=i[2],this.ptOffset=i[3],this.idxCount=i[4],this.idxOffset=i[5],i=null},r.Loader.LineReader=function(e,t){this.header=null,r.Compatibility.isUseDoubleMatrixMPKHeader(t)?this.header=new r.Loader.LineMatrixHeader(e):this.header=new r.Loader.LineHeader(e),this.lineSize=24,this.ptSize=12,this.lineBuffer=e.slice(this.header.lineOffset,this.header.lineOffset+this.header.lineCount*this.lineSize),this.ptBuffer=e.slice(this.header.ptBufferOffset,this.header.ptBufferOffset+this.header.ptBufferSize),this.idxBuffer=e.slice(this.header.idxBufferOffset,this.header.idxBufferOffset+this.header.idxBufferSize),1===this.header.matCount&&(this.curMatrix=new r.Loader.Matrix(e,this.header.matBufferOffset,Float64Array).matrix.clone()),this.line_cur_id=-1;var i=new ArrayBuffer(this.lineSize);this.line_cur=new r.Loader.LineData(i,0)},r.Loader.LineReader.prototype={constructor:r.Loader.LineReader,getLineData:function(e){if(e>=0&&e<this.header.lineCount)return new r.Loader.LineData(this.lineBuffer,e*this.lineSize)},getLineInfo:function(e){if(e==this.line_cur_id)return this.line_cur;if(e>=0&&e<this.header.lineCount){var t=new Uint32Array(this.lineBuffer,e*this.lineSize,6);return this.line_cur.line_id=t[0],this.line_cur.lineType=t[1],this.line_cur.ptCount=t[2],this.line_cur.ptOffset=t[3],this.line_cur.idxCount=t[4],this.line_cur.idxOffset=t[5],this.line_cur_id=e,this.line_cur}},getPtBuffer:function(e){if(e>=0&&e<this.header.lineCount){var t=this.getLineInfo(e);if(void 0===t)return;return new Float32Array(this.ptBuffer,t.ptOffset,3*t.ptCount)}},getIdxBuffer:function(e){if(e>=0&&e<this.header.lineCount){var t=this.getLineInfo(e);if(void 0===t)return;var i=new Uint32Array(this.idxBuffer,t.idxOffset,t.idxCount),r=t.ptOffset/this.ptSize;return i.forEach((function(e,t,i){i[t]-=r})),i}},getMatrix:function(){return this.curMatrix}},r.Loader.CameraReader=function(e){this.cameras=JSON.parse(e)},r.Loader.CameraReader.prototype.parse=function(e,t){function i(e,i){i.uuid=e.uuid,void 0!==e.name&&(i.name=e.name);var r=new THREE.Matrix4;if(void 0!==e.matrix)r.fromArray(e.matrix);else{var a=new THREE.Vector3,n=new THREE.Quaternion,s=new THREE.Vector3;if(void 0!==e.position&&a.fromArray(e.position),void 0!==e.rotation){var o=new THREE.Vector3;o.fromArray(e.rotation);var l=new THREE.Euler(o[0]*Math.PI/180,o[1]*Math.PI/180,o[2]*Math.PI/180,"XYZ");n.setFromEuler(l)}void 0!==e.quaternion&&n.fromArray(e.quaternion,0),void 0!==e.scale&&i.scale.fromArray(e.scale),r.compose(a,n,s)}r.multiply(t),r.decompose(i.position,i.quaternion,i.scale)}var a,n,s=this.cameras;if(s.Orthographic){var o=s.Orthographic;for(var l in o)i(n=o[l],a=new r.Camera(r.CAMERATYPE.ORTHOGRAPHIC,n)),e.addCamera(a)}if(s.Perspective){var d=s.Perspective;for(var l in d)n=d[l],a=new r.Camera(r.CAMERATYPE.PERSPECTIVE,n),void 0!==n.focus&&(a.focus=n.focus),void 0!==n.zoom&&(a.zoom=n.zoom),void 0!==n.filmGauge&&(a.filmGauge=n.filmGauge),void 0!==n.filmOffset&&(a.filmOffset=n.filmOffset),void 0!==n.view&&(a.view=Object.assign({},n.view)),i(n,a),e.addCamera(a)}},r.Loader.SceneHeader=function(e){var t=new Uint32Array(e,0,11);this.blockId=t[0],this.cellCount=t[1],this.itemCount=t[2],this.matrixCount=t[3],this.geomBuffSize=t[4],this.layerBuffSize=t[5],this.cellOffset=t[6],this.itemOffset=t[7],this.matrixOffset=t[8],this.geomOffset=t[9],this.layerOffset=t[10];var i=new Float32Array(e,44,6);this.boundingBox=new THREE.Box3(new THREE.Vector3(i[0],i[1],i[2]),new THREE.Vector3(i[3],i[4],i[5])),t=null,i=null},r.Loader.Cell=function(e,t){var i=new Int32Array(e,t,5);this.cellId=i[0],this.depth=i[1],this.itemIndex=i[2],this.itemCount=i[3],this.layerType=i[4],this.layerSize=new Int32Array(e,t+20,8),this.layerOffset=new Int32Array(e,t+52,8);var r=new Float32Array(e,t+84,6);this.boundingBox=new THREE.Box3(new THREE.Vector3(r[0],r[1],r[2]),new THREE.Vector3(r[3],r[4],r[5])),i=null,r=null},r.Loader.Item=function(e,t){var i=new Int32Array(e,t,7);this.ItemId=i[0],this.originalId=i[1],this.materialId=i[2],this.userDataId=i[3],this.matrixId=i[4],this.type=i[5],this.toData=i[6];var r=new Float32Array(e,t+28,6);this.boundingBox=new THREE.Box3(new THREE.Vector3(r[0],r[1],r[2]),new THREE.Vector3(r[3],r[4],r[5])),i=null,r=null},r.Loader.Matrix=function(e,t,i){const r=4*i.BYTES_PER_ELEMENT*4;let a=new i(e.slice(t,t+r),0,16);this.matrix=(new THREE.Matrix4).fromArray(a),a=null},r.Loader.GeomPipe=function(e,t){var i=new Float32Array(e,t,8);this.startPt=new THREE.Vector3(i[0],i[1],i[2]),this.endPt=new THREE.Vector3(i[3],i[4],i[5]),this.radius=i[6],this.thickness=i[7],i=null},r.Loader.SceneReader=function(e,t){this.header=new r.Loader.SceneHeader(e),this.cellSize=108,this.itemSize=52,this.matrixSize=r.Compatibility.getMatrixSize(t),this.matrixDataType=r.Compatibility.getMatrixDatatype(t),this.maxSize=1024,this.boxUvSize=36,this.pipeUvSize=18,this.cellBuffer=e.slice(this.header.cellOffset,this.header.cellOffset+this.header.cellCount*this.cellSize),this.itemBuffer=e.slice(this.header.itemOffset,this.header.itemOffset+this.header.itemCount*this.itemSize),this.matrixBuffer=e.slice(this.header.matrixOffset,this.header.matrixOffset+this.header.matrixCount*this.matrixSize),this.geomBuffer=e.slice(this.header.geomOffset,this.header.geomOffset+this.header.geomBuffSize),this.layerBuffer=e.slice(this.header.layerOffset,this.header.layerOffset+this.header.layerBuffSize),this.matr_cur_id=-1,this.pt_cell_min=new THREE.Vector3(0,0,0),this.pt_cell_max=new THREE.Vector3(0,0,0),this.pt_item_min=new THREE.Vector3(0,0,0),this.pt_item_max=new THREE.Vector3(0,0,0);var i=new ArrayBuffer(this.maxSize);this.cell_cur=new r.Loader.Cell(i,0),this.item_cur=new r.Loader.Item(i,0),this.matr_cur=new r.Loader.Matrix(i,0,this.matrixDataType),this.pipe_cur=new r.Loader.GeomPipe(i,0),this.cell_cur.boundingBox.set(this.pt_cell_min,this.pt_cell_max),this.item_cur.boundingBox.set(this.pt_item_min,this.pt_item_max)},r.Loader.SceneReader.prototype={constructor:r.Loader.SceneReader,getCellMpks:function(e){if(e>=0&&e<this.header.cellCount){for(var t=[],i=this.getCellInfo(e),r=i.itemIndex;r<i.itemCount;++r){var a=this.getItemInfo(r);if(1===a.type){var n=this.getMpkID(a.toData);t.push(n)}}for(var s={},o=[],l=0;l<t.length;++l)s[t[l]]||(s[t[l]]=!0,o.push(t[l]));return o}},getCell:function(e){if(e>=0&&e<this.header.cellCount)return new r.Loader.Cell(this.cellBuffer,e*this.cellSize)},getItem:function(e){if(e>=0&&e<this.header.itemCount)return new r.Loader.Item(this.itemBuffer,e*this.itemSize)},getMatrix:function(e){if(e>=0&&e<this.header.matrixCount)return new r.Loader.Matrix(this.matrixBuffer,e*this.matrixSize,this.matrixDataType)},getGeomPipe:function(e){if(e>=0&&e<this.header.geomBuffSize)return new r.Loader.GeomPipe(this.geomBuffer,e)},getCellInfo:function(e){if(e>=0&&e<this.header.cellCount){var t=new Int32Array(this.cellBuffer,e*this.cellSize,5);this.cell_cur.cellId=t[0],this.cell_cur.depth=t[1],this.cell_cur.itemIndex=t[2],this.cell_cur.itemCount=t[3],this.cell_cur.layerType=t[4],this.cell_cur.layerSize=new Int32Array(this.cellBuffer,e*this.cellSize+20,8),this.cell_cur.layerOffset=new Int32Array(this.cellBuffer,e*this.cellSize+52,8);var i=new Float32Array(this.cellBuffer,e*this.cellSize+84,6);return this.pt_cell_min.set(i[0],i[1],i[2]),this.pt_cell_max.set(i[3],i[4],i[5]),this.cell_cur.boundingBox.set(this.pt_cell_min,this.pt_cell_max),this.cell_cur}},getItemInfo:function(e){if(e>=0&&e<this.header.itemCount){var t=new Int32Array(this.itemBuffer,e*this.itemSize,7);this.item_cur.ItemId=t[0],this.item_cur.originalId=t[1],this.item_cur.materialId=t[2],this.item_cur.userDataId=t[3],this.item_cur.matrixId=t[4],this.item_cur.type=t[5],this.item_cur.toData=t[6];var i=new Float32Array(this.itemBuffer,e*this.itemSize+28,6);return this.pt_item_min.set(i[0],i[1],i[2]),this.pt_item_max.set(i[3],i[4],i[5]),this.item_cur.boundingBox.set(this.pt_item_min,this.pt_item_max),this.item_cur}},getMatrixInfo:function(e){if(e==this.matr_cur_id)return this.matr_cur;if(e>=0&&e<this.header.matrixCount){const t=new this.matrixDataType(this.matrixBuffer,e*this.matrixSize,16);return this.matr_cur.matrix.fromArray(t),this.matr_cur_id=e,this.matr_cur}},getGeomPipeInfo:function(e){if(e>=0&&e<this.header.geomBuffSize){var t=new Float32Array(this.geomBuffer,e,8);return this.pipe_cur.startPt.set(t[0],t[1],t[2]),this.pipe_cur.endPt.set(t[3],t[4],t[5]),this.pipe_cur.radius=t[6],this.pipe_cur.thickness=t[7],this.pipe_cur}},getGeomBoxUvInfo:function(e){if(e>=0&&e+4*this.boxUvSize<=this.header.geomBuffSize)return new Float32Array(this.geomBuffer,e,this.boxUvSize)},getGeomPipeUvInfo:function(e){if(e>=0&&e+4*this.pipeUvSize<=this.header.geomBuffSize)return new Float32Array(this.geomBuffer,e,this.pipeUvSize)},getLayerInfo:function(e,t){if(e>=0&&e+t<=this.header.layerBuffSize){new Uint32Array(this.layerBuffer,e,t);return this.data}},getMpkID:function(e){return parseInt(e/65536)},getMeshIndex:function(e){return parseInt(e%65536)}},r.Loader.LayerIndex=function(e,t){var i=new Uint32Array(e,t,2);this.layer_id=i[0],this.item_index=i[1]},r.Loader.LayerIndexReader=function(e){var t=new Uint32Array(e,0,2);this.cell_count=t[0],this.data_count=t[1],this.headerSize=8,this.cellSize=108,this.dataSize=8;var i=this.cell_count*this.cellSize,r=this.data_count*this.dataSize;this.cellBuffer=e.slice(this.headerSize,this.headerSize+i),this.dataBuffer=e.slice(this.headerSize+i,this.headerSize+i+r)},r.Loader.LayerIndexReader.prototype={constructor:r.Loader.LayerIndexReader,getCell:function(e){if(e>=0&&e<this.cell_count)return new r.Loader.Cell(this.cellBuffer,e*this.cellSize)},getLayerIndex:function(e){if(e>=0&&e<this.data_count)return new r.Loader.LayerIndex(this.dataBuffer,e*this.dataSize)}},r.ModelView.MeshBaseManager=class{constructor(){this.geometries={}}destroy(){this.disposeGeometries(),this.geometries=null}disposeGeometries(){for(var e in this.geometries)this.disposeGeometry(e)}disposeGeometry(e){var t=this.geometries[e];if(t){if(t instanceof Array)for(var i=0,r=t.length;i<r;i++)t[i].dispose();else t.dispose();delete this.geometries[e]}}_hasGeometry(e){return!!this.geometries[e]}_cacheGeometry(e,t){void 0===this.geometries[e]&&(this.geometries[e]=t)}getGeometryById(e){return this.geometries[e]}getGeometryByNodeInfo(e,t){return this._hasGeometry(t.geometryIdCode)?this.getGeometryById(t.geometryIdCode):this._createGeometryByNodeInfo(e,t)}_createGeometryByNodeInfo(e,t){return this._createGeometry(t.type,t.geometryIdCode,t.fromMirror,e.getModelDescriptor().getReferencedMeshBufferById(t.geometryId),e.lightmap)}_createGeometry(e,t,i,r,a){if(this._hasGeometry(t))return this.getGeometryById(t);const n=this._createBufferGeometry(e,i,r,a);return n?(this._cacheGeometry(t,n),n):null}_createBufferGeometry(e,t,i,a){const n=r.ModelView.BaseDescriptor.EnumNodeItemType;let s=null;switch(e){case n.MESH:case n.MESH_REF:s=r.GeomUtil.getBufferGeometry(i,t);break;case n.LINE:s=r.GeomUtil.getLineBufferGeometry(i,t);break;case n.TUBE:case n.PIPE:s=r.GeomUtil.getPipeBufferGeometry(t,a);break;case n.PIPE_M:s=r.GeomUtil.getPipeMBufferGeometry(t,a);break;case n.BOX:s=r.GeomUtil.getBoxBufferGeometry(t,a);break;case n.BOX_M:s=r.GeomUtil.getBoxMBufferGeometry(t,a)}return s}createBufferByBufferDataWithUV2(e,t,i,a){var n=this.createBufferByBufferData(t,i,a,r.Compatibility.isUseDoubleMatrixMPKHeader(this.version));if(!n)return null;if(!e.lightmap)return n;var s=[],o=n.index,l=e.getLoader().getUV2ById(t.itemIdUV2,o.length);return l&&(t.lightmapIdx=l.lightmapIdx,t.materialId=t.materialId+"_"+t.lightmapIdx,s=l.uv2),this._expandNodeBufferWithUV2(n,s)}_expandNodeBufferWithUV2(e,t){for(var i=e.position,r=e.normal,a=e.uv,n=e.index,s=[],o=[],l=[],d=[],h=[],c=0,u=0;u<n.length;u++){var p=n[u];null==h[p]||t[2*h[p]]!=t[2*u]||t[2*h[p]+1]!=t[2*u+1]?(s.push(i[3*p]),s.push(i[3*p+1]),s.push(i[3*p+2]),r&&(o.push(r[3*p]),o.push(r[3*p+1]),o.push(r[3*p+2])),a&&(l.push(a[2*p]),l.push(a[2*p+1])),d.push(t[2*u]),d.push(t[2*u+1]),n[u]=c,c++,null==h[p]&&(h[p]=u)):n[u]=n[h[p]]}return i=null,r=null,a=null,t=null,h=null,e.uv2=d,e.position=s,e.normal=o,e.uv=l,e}createBufferForSharedMeshByBufferDataWithUV2(e,t,i,r){var a=this.createBufferByBufferData(t,i,r);if(!a)return null;if(!e.lightmap)return a;var n=[],s=a.index,o=e.getLoader().getInstanceUV2ForSharedMeshById(t.itemIdUV2,s.length);return o&&(t.uv2Info=o,t.lightmapIdx=o.lightmapIdx,t.materialId=t.materialId+"_"+t.lightmapIdx,n=o.uv2),this._expandNodeBufferWithUV2(a,n)}createBufferByBufferData(e,t,i,a){const n=r.ModelView.BaseDescriptor.EnumNodeItemType;let s=null;switch(e.type){case n.MESH:case n.MESH_REF:s=r.GeomUtil.getGeometryBuffer(t,e.matrix,e.fromMirror,i,a);break;case n.LINE:s=r.GeomUtil.getLineGeometryBuffer(t,e.matrix,e.fromMirror,i);break;case n.TUBE:case n.PIPE:s=r.GeomUtil.getPipeGeometryBuffer(e.matrix,e.fromMirror,i);break;case n.PIPE_M:s=r.GeomUtil.getPipeMGeometryBuffer(e.uvArrayBuffer,e.matrix,e.fromMirror,i);break;case n.BOX:case n.BOX_M:s=r.GeomUtil.getBoxMGeometryBuffer(e.uvArrayBuffer,e.matrix,e.fromMirror,i);break;default:console.log("error data!")}return s&&(e.uv=!!s.uv),s}},(()=>{new THREE.Vector3;let e=new THREE.Vector3;class t{constructor(){this.symbolReader=null,this.userIdReader=null,this.userDataReader=null,this.mapSceneReader={},this.lightmap=!1,this.mapNodeInfoByCategory={},this.mapNodeInfoByUserId={},this.mapNodeInfoByCellId={},this.mapNodeInfoByParameterizedDesc={},this.mapStandardNodeInfoByGeometryId=null,this.mapInstancedNodeInfoByGeometryId=null,this.referencedMeshCache={},this.cellCount=0,this.borderLines={},this.fullNodeInfoArray=[],this.sharedGeometryCounter={},this.octreeRootNode={inner:null,outer:null,layer:null},this._config=null}destroy(){this.destroyReader(),this.mapNodeInfoByCategory=null,this.mapNodeInfoByUserId=null,this.mapNodeInfoByCellId=null,this.mapNodeInfoByParameterizedDesc=null,this.mapStandardNodeInfoByGeometryId=null,this.mapInstancedNodeInfoByGeometryId=null,this.referencedMeshCache=null,this.borderLines=null,this.octreeRootNode=null,this.fullNodeInfoArray=null,this.sharedGeometryCounter=null,this._config=null}destroyReader(){this.userIdReader=null,this.userDataReader=null,this.symbolReader=null,this.mapSceneReader=null}setConfigure(e){this._config=e}getConfigure(){return this._config}getSceneReaderMap(){return this.mapSceneReader}isValidScene(){return!r.Utils.isEmptyObject(this.getSceneReaderMap())||(r.Logger.log("model load not started!"),!1)}_classifyNodeInfo(e){this._cacheNodeInfoByCellId(e),this._cacheNodeInfoByUserId(e),this._cacheNodeInfoByCategory(e),this._cacheNodeInfoByParameterizedDesc(e)}classifyAllNodeInfo(){this.fullNodeInfoArray.forEach((e=>{e.instanceOrNot=this._isInstancedNode(e),this._classifyNodeInfo(e)})),this.fullNodeInfoArray.length=0,this.sharedGeometryCounter={}}_cacheNodeInfoByCellId(e){void 0===this.mapNodeInfoByCellId[e.cellId]&&(this.mapNodeInfoByCellId[e.cellId]=[]),this.mapNodeInfoByCellId[e.cellId].push(e)}_cacheNodeInfoByUserId(e){void 0===this.mapNodeInfoByUserId[e.userId]&&(this.mapNodeInfoByUserId[e.userId]=[]),this.mapNodeInfoByUserId[e.userId].push(e)}_cacheNodeInfoByCategory(e){var t;t=e.instanceOrNot?r.ModelView.BaseDescriptor.NodeInfoCategory.INSTANCED:r.ModelView.BaseDescriptor.NodeInfoCategory.STANDARD,void 0===this.mapNodeInfoByCategory[t]&&(this.mapNodeInfoByCategory[t]={}),void 0===this.mapNodeInfoByCategory[t][e.userId]&&(this.mapNodeInfoByCategory[t][e.userId]=[]),this.mapNodeInfoByCategory[t][e.userId].push(e)}_cacheNodeInfoByParameterizedDesc(e){e.parameterizedDesc&&(void 0===this.mapNodeInfoByParameterizedDesc[e.type]&&(this.mapNodeInfoByParameterizedDesc[e.type]=[]),this.mapNodeInfoByParameterizedDesc[e.type].push(e))}_clearNodeInfoCacheWithParameterizedDesc(){this.mapNodeInfoByParameterizedDesc={}}_clearNodeInfoCacheWithCellId(){this.mapNodeInfoByCellId={}}_clearNodeInfoCacheWithCategory(){this.mapNodeInfoByCategory={}}_clearNodeInfoCacheWithUserId(){this.mapNodeInfoByUserId={}}clearNodeInfoCache(){this._clearNodeInfoCacheWithCellId(),this._clearNodeInfoCacheWithUserId(),this._clearNodeInfoCacheWithCategory(),this._clearNodeInfoCacheWithParameterizedDesc()}getNodeInfosByCellId(e){return this.mapNodeInfoByCellId[e]}getNodeInfosWithCellId(){return this.mapNodeInfoByCellId}getNodeInfosWithParameterizedDesc(){return this.mapNodeInfoByParameterizedDesc}getAllNodeInfos(){return this.mapNodeInfoByUserId}getNodeInfosByUserId(e){return this.mapNodeInfoByUserId[e]}getStandardNodeInfos(){return this.mapNodeInfoByCategory[r.ModelView.BaseDescriptor.NodeInfoCategory.STANDARD]}getInstancedNodeInfos(){return this.mapNodeInfoByCategory[r.ModelView.BaseDescriptor.NodeInfoCategory.INSTANCED]}getStandardUserIds(){return this.getStandardNodeInfos()?Object.keys(this.getStandardNodeInfos()):[]}getInstancedUserIds(){return this.getInstancedNodeInfos()?Object.keys(this.getInstancedNodeInfos()):[]}getStandardNodeInfosById(e){var t=this.getStandardNodeInfos();return t?t[e]:null}getInstancedNodeInfosById(e){var t=this.getInstancedNodeInfos();return t?t[e]:null}_getUserIdsByCategory(e,t){var i,a=[];if(i=t===r.ModelView.BaseDescriptor.NodeInfoCategory.INSTANCED?this.getInstancedNodeInfos():this.getStandardNodeInfos())for(var n=0,s=e.length;n<s;n++)i[e[n]]&&a.push(e[n]);return a}getInstancedUserIdsByCategory(e){return this._getUserIdsByCategory(e,r.ModelView.BaseDescriptor.NodeInfoCategory.INSTANCED)}getStandardUserIdsByCategory(e){return this._getUserIdsByCategory(e,r.ModelView.BaseDescriptor.NodeInfoCategory.STANDARD)}_traverseNodeInfosByIds(e,t,i){for(var r=0,a=t.length;r<a;r++){var n=t[r];i(n,e[n])}}traverseStandardNodeInfos(e,t){var i=this.getStandardNodeInfos();i&&(e=e||this.getStandardUserIds(),this._traverseNodeInfosByIds(i,e,t))}traverseInstancedNodeInfos(e,t){var i=this.getInstancedNodeInfos();i&&(e=e||this.getInstancedUserIds(),this._traverseNodeInfosByIds(i,e,t))}traverseNodeInfosByCell(e){for(var t=Object.keys(this.mapNodeInfoByCellId),i=0,r=t.length;i<r;i++)for(var a=t[i],n=this.mapNodeInfoByCellId[a],s=0,o=n.length;s<o;s++)e(a,n[s])}clearReferencedMeshCache(){for(var e in this.referencedMeshCache)delete this.referencedMeshCache[e];this.referencedMeshCache=null}cacheReferencedMeshBufferData(e,t){this.referencedMeshCache.bufferData||(this.referencedMeshCache.bufferData={}),this.referencedMeshCache.bufferData[e]=t}getReferencedMeshBufferData(){return this.referencedMeshCache.bufferData}getReferencedMeshBufferById(e){return this.referencedMeshCache&&this.referencedMeshCache.bufferData?this.referencedMeshCache.bufferData[e]:null}cacheReferencedMeshMpkIds(e,t){this.referencedMeshCache.mpkIds||(this.referencedMeshCache.mpkIds={}),this.referencedMeshCache.mpkIds[e]||(this.referencedMeshCache.mpkIds[e]=[]),this.referencedMeshCache.mpkIds[e].push(t)}clearReferencedMeshCacheByMpkIdxs(e,t){if(this.referencedMeshCache.mpkIds)for(var i=0,r=e.length;i<r;i++){var a=e[i],n=this.referencedMeshCache.mpkIds[a];if(n){for(var s=0,o=n.length;s<o;s++)t&&t(n[s]),delete this.referencedMeshCache[n[s]];delete this.referencedMeshCache.mpkIds[a]}}}cacheBorderLine(e,t){var i=e?"shared":"unique";this.borderLines[i]||(this.borderLines[i]=[]),this.borderLines[i].push(t)}getSharedBorderLineCache(){return this.borderLines.shared}getUniqueBorderLineCache(){return this.borderLines.unique}_isParameterizedNode(e){return t.isParameterizedNode(e)}_isGeometrySharedNode(e){return t.isGeometrySharedNode(e)}_isInstancedNode(e){if(!r.GlobalData.Instance)return!1;if(e.parameterizedDesc)return!0;if(!r.GlobalData.InstanceSharedMeshEnabled)return!1;if(!this._isGeometrySharedNode(e))return!1;const t=r.GlobalData.InstanceSharedMeshThreshold;return(this.sharedGeometryCounter[e.geometryId]||0)>t}getCellCount(){return this.cellCount}getOctreeRootNode(){return this.octreeRootNode}isUseInnerAndOuterOctree(){return!0}isOctreeOuter(e){var t=this.octreeRootNode.inner||this.octreeRootNode.outer;return!(e.x<t.min.x||e.x>t.max.x||e.y<t.min.y||e.y>t.max.y||e.z<t.min.z||e.z>t.max.z)}getOctreeRoots(e){this.octreeRootNode.outer&&e.push(this.octreeRootNode.outer),this.octreeRootNode.inner&&e.push(this.octreeRootNode.inner)}updateOctreeNodeBy(t,i){var r=new THREE.Box3;function a(t,i){r.copy(t.boundingBoxWorld),r.applyMatrix4(i),t.min.copy(r.min),t.max.copy(r.max),t.center=r.getCenter(t.center),t.size=r.getSize(e).lengthSq()}a(t,i),function e(t,i){for(var r=0,n=t.childOctants.length;r<n;++r){var s=t.childOctants[r];a(s,i),e(s,i)}}(t,i)}updateOctreeNode(e,t){let i=t.clone().premultiply(e);var r=this.getOctreeRootNode();r.outer&&this.updateOctreeNodeBy(r.outer,i),r.inner&&this.updateOctreeNodeBy(r.inner,i)}removeFromSceneReaderMap(e){for(var t=0,i=e.length;t<i;t++)this.mapSceneReader[e[t]]&&delete this.mapSceneReader[e[t]]}isUserIdExist(e){return!!this.getNodeInfosByUserId(e)}addToNodeInfoMap(e){for(var t=0,i=e.length;t<i;t++)this._cacheNodeInfoByUserId(e[t])}removeFromNodeInfoMap(e){for(var t=this.getAllNodeInfos(),i=0,r=e.length;i<r;i++){var a=e[i].userId;t[a]&&delete t[a]}}cacheNodeInfosOnGeometryId(){this.cacheStandardNodeInfosOnGeometryId(),this.cacheInstancedNodeInfosOnGeometryId()}cacheStandardNodeInfosOnGeometryId(){this.mapStandardNodeInfoByGeometryId={},this._cacheNodeInfosOnGeometryIdBy(this.getStandardNodeInfos(),this.mapStandardNodeInfoByGeometryId)}cacheInstancedNodeInfosOnGeometryId(){this.mapInstancedNodeInfoByGeometryId={},this._cacheNodeInfosOnGeometryIdBy(this.getInstancedNodeInfos(),this.mapInstancedNodeInfoByGeometryId)}_cacheNodeInfosOnGeometryIdBy(e,t){if(!e)return;Object.keys(e).forEach((i=>{e[i].forEach((e=>{e.geometryId=this.convertGeometryId(e.geometryId),t[e.geometryId]||(t[e.geometryId]=[]),t[e.geometryId].push(e)}))}))}getStandardNodeInfosOnGeometryId(){return this.mapStandardNodeInfoByGeometryId||this.cacheStandardNodeInfosOnGeometryId(),this.mapStandardNodeInfoByGeometryId}getInstancedNodeInfosOnGeometryId(){return this.mapInstancedNodeInfoByGeometryId||this.cacheInstancedNodeInfosOnGeometryId(),this.mapInstancedNodeInfoByGeometryId}clearNodeInfosWithGeometryId(){this.mapStandardNodeInfoByGeometryId=null,this.mapInstancedNodeInfoByGeometryId=null}convertGeometryId(e){return e}static getMeshIdFromOctantMap(e){return e.single?e.nodeId:e.instanceOrNot?e.uv2Info?r.Utils.getCombinedKeyString([e.materialId,e.geometryIdCode,e.uv2Info.byteOffset]):r.Utils.getCombinedKeyString([e.materialId,e.geometryIdCode]):r.GlobalData.BatchMergeEnabled?r.Utils.getCombinedKeyString([e.materialId,e.uv?"1":"0",e.type===t.EnumNodeItemType.LINE?"lines":"meshes"]):e.nodeId}static isParameterizedNode(e){return e.type===t.EnumNodeItemType.TUBE||e.type===t.EnumNodeItemType.PIPE||e.type===t.EnumNodeItemType.BOX||e.type===t.EnumNodeItemType.BOX_M||e.type===t.EnumNodeItemType.PIPE_M}static isParameterizedNodeType(e){return e===t.parameterizedNodeType.TUBE||e===t.parameterizedNodeType.PIPE||e===t.parameterizedNodeType.PIPE_M||e===t.parameterizedNodeType.BOX||e===t.parameterizedNodeType.BOX_M}static isGeometrySharedNode(e){return e.type===t.EnumNodeItemType.MESH_REF}static isLineNode(e){return e.type===t.EnumNodeItemType.LINE}}t.EnumNodeItemType={SYMBOL:0,MESH:1,TUBE:2,PIPE:3,BOX:4,BOX_M:5,PIPE_M:6,MESH_REF:7,LINE:8},t.NodeInfoCategory={INSTANCED:0,STANDARD:1},t.parameterizedNodeType={BOX:"box",BOX_M:"boxM",PIPE:"pipe",PIPE_M:"pipeM",TUBE:"tube"},r.ModelView.BaseDescriptor=t})(),(()=>{let e=new THREE.Vector3,t=new THREE.Vector3;r.ModelView.BaseLoader=class{constructor(e,t){this.handler=e,this.model=e.model,this.url=e.model.dataUrl,this.fileLoader=e.model.fileLoader,this.descriptor=null,this.loadTaskCount=0,this.maxLoadTaskCount=0,this.loadTextureCount=0,this.maxLoadTextureCount=0,this.textruesLoaded=!1,this.dataLoaded=!1,this.mpkTaskManager=new r.TaskManager,this.enableCompressedTexture=!1,this.startCallback=null,this.progressCallback=null,this.finishCallback=null,this.version=t}destroy(){this.mpkTaskManager=null,this.textureManager=null,this.url=null,this.fileLoader=null,this.descriptor&&(this.descriptor.destroy(),this.descriptor=null),this.model=null,this.handler=null,this.startCallback=null,this.progressCallback=null,this.finishCallback=null,this.version=void 0}getDescriptor(){return this.descriptor}setNotifyProgress(e){this.notifyProgress=e}load(e,t,i){this.startCallback=e,this.progressCallback=t,this.finishCallback=i;var r=this.url.lightmapProjectUrl();if(r){var a=this;this._loadLightmapConfig(r,(function(){a.loadData()}))}else this.loadData()}loadData(){var e=this,t=e.model,i=t.getConfig().metadata;let a=this.model.materialManager;this.descriptor.setConfigure(t.getConfig()),r.GlobalData.CanUseCompressedTexture&&i.texture_dds&&(a.enableCompressedTexture=!0,this.enableCompressedTexture=!0),r.GlobalData.CanUseSmallTexture&&i.texture_small&&(a.enableSmallTexture=!0),i.texture_pkg&&(a.enablePkgTexture=!0),i.texture_org&&(a.enableOrgTexture=!0),i.texture_dds&&(a.enableDdsTexture=!0),0==i.texture_pkg_gz&&(a.enableTexturePkgGz=!1),r.Compatibility.isUseMergeTexturePkg(i.version)?r.Compatibility.useMergeTexturePkg=!0:r.Compatibility.useMergeTexturePkg=!1,r.Compatibility.isUse32MpkData(i.version)?r.Compatibility.use32MpkData=!0:r.Compatibility.use32MpkData=!1;var n=this.getSceneTaskCount(i);e.maxLoadTaskCount=0,e.maxLoadTaskCount+=n,e.maxLoadTaskCount+=i.material,e.maxLoadTaskCount+=i.userId,e.maxLoadTaskCount+=i.userdata,e.maxLoadTaskCount+=i.camera,e.maxLoadTaskCount+=i.octree_o,e.maxLoadTaskCount+=i.octree_i,t.lightmap&&(e.maxLoadTaskCount+=2),e.startCallback&&e.startCallback();this.url;i.material?e._loadMaterial(i.material_json):e.textruesLoaded=!0,i.userId&&e._loadUserId(),i.userdata&&e._loadUserData(),i.camera&&e._loadCamera(),(i.octree_o||i.octree_i)&&e._loadOctree(i.octree_o,i.octree_i),t.lightmap&&e._loadUV2(),n&&e.loadSceneAndMpks(i)}loadSceneAndMpks(e){}getSceneTaskCount(e){return 0}loadWithStorage(e,t,i,a){r.Storage.IndexedDBHelper.loadWithStorage("ModelData",e,t,i,a)}_loadLightmapConfig(e,t){var i=this.model,a=this.descriptor;const n=e;this.loadWithStorage(n,(()=>new Promise(((e,t)=>{this.fileLoader.load(n,e)}))),(e=>{var n;try{n=JSON.parse(e)}catch(e){return void console.log("Lightmap config data exceptions!")}void 0!==n.count.lightmapNum&&n.count.lightmapNum>0&&(i.lightmapNum=n.count.lightmapNum,a.lightmap=!0,r.GlobalData.EnableLightmap=!0),t&&t()}))}_onTaskFinished(){var e=this.model;this.loadTaskCount++;var t=this.dealProgressSegment(e,this.loadTaskCount);if(this.notifyProgress){var i={total:this.maxLoadTaskCount,loaded:t};this.progressCallback&&this.progressCallback(i)}this.loadTaskCount>=this.maxLoadTaskCount&&(this.dataLoaded=!0,this.textruesLoaded&&this.finishCallback&&this.finishCallback())}_onLoadTexture(){this.loadTextureCount++,this.loadTextureCount>=this.maxLoadTextureCount&&(this.textruesLoaded=!0,this.pkgTextureMap=null,this.pkgTextureArrayBufferMap=null,this.textureManager=null,this.dataLoaded&&this.finishCallback&&this.finishCallback())}_loadScene(e){var t=this,i=this.model,a=this.url,n=this.fileLoader;const s=a.sceneUrl(e);this.loadWithStorage(s,(()=>new Promise(((e,t)=>{n.setResponseType("arraybuffer"),n.load(s,e,void 0,t)}))),(i=>{t._parseScene(i,e),t._onTaskFinished()}),(e=>{i.dispatchEvent({type:r.LOADERROREVENTS.LOAD_ERROR,errorType:r.LOADERROREVENTS.LOAD_SCENE_ERROR,event:e}),t._onTaskFinished()}))}_parseScene(e,t){const i=this.model.getConfig().metadata.version;let a=new r.Loader.SceneReader(e,i);this.descriptor.mapSceneReader[t]=a,a=null}_loadLine(){var e=this,t=this.model,i=this.url,a=this.fileLoader;const n=i.lineUrl();this.loadWithStorage(n,(()=>new Promise(((e,t)=>{a.setResponseType("arraybuffer"),a.load(n,e,void 0,t)}))),(t=>{e._parseLine(t),e._onTaskFinished()}),(i=>{t.dispatchEvent({type:r.LOADERROREVENTS.LOAD_ERROR,errorType:r.LOADERROREVENTS.LOAD_MATERIAL_ERROR,event:i}),e._onTaskFinished()}))}_parseLine(e){for(var t=new r.Loader.LineReader(e,this.version),i=0,a=t.header.lineCount;i<a;++i){var n=t.getPtBuffer(i),s=t.getIdxBuffer(i);if(null!=n&&null!=s){var o=t.getLineData(i);if(0===o.lineType){for(var l=[],d=1,h=s.length;d<h;d++)l.push(s[d-1]),l.push(s[d]);l.length&&(s=l)}this.descriptor.cacheReferencedMeshBufferData("line-"+o.line_id,{P:n,I:s,mpkMatrix:t.getMatrix()})}else r.Logger.log("Error Geometry!")}t=null}_loadMaterial(e){var t=this,i=this.model,a=this.url,n=this.fileLoader;const s=a.materialUrl();this.loadWithStorage(s,(()=>new Promise(((t,i)=>{e?n.setResponseType(""):n.setResponseType("arraybuffer"),n.load(s,t,void 0,i)}))),(i=>{t._parseMaterial(i,e),t._onTaskFinished()}),(e=>{i.dispatchEvent({type:r.LOADERROREVENTS.LOAD_ERROR,errorType:r.LOADERROREVENTS.LOAD_MATERIAL_ERROR,event:e}),t.textruesLoaded=!0,t._onTaskFinished()}))}_loadMaterialId(e,t){var i=this,r=this.url,a=this.fileLoader;const n=r.materialIdUrl();this.loadWithStorage(n,(()=>new Promise(((e,t)=>{a.setResponseType(""),a.load(n,e,void 0,t)}))),(t=>{let r=JSON.parse(t);i.model.materialManager.materialIdMap=r.materials,e&&e(Object.keys(r.materials))}),(e=>{console.log("ERROR: there is no material_id.zip, please reTranslate the model"),t&&t()}))}_parseMaterial(e,t){t?this._parseMaterialJson(e):this._parseMaterialBinary(e)}_parseMaterialBinary(e){var t,i=this.url,a=this.model.materialManager,n=a.materials,s=a.textures,o=new r.Loader.MaterialReader(e),l=o.materialCount,d=this,h=[];if(!(l<0)){var c=this.model.manager.scene;for(t=0;t<l;++t){var u,p={},m=o.getMaterial(t);if(void 0!==m.color&&(p.color=m.color),void 0!==m.opacity&&(p.opacity=m.opacity,m.opacity<1&&(p.transparent=!0)),void 0!==m.side&&m.side&&(p.side=THREE.DoubleSide),void 0!==m.emissive&&(p.emissive=m.emissive),void 0!==m.environment&&(p.envMapIntensity=m.environment),void 0!==m.roughness&&(p.roughness=m.roughness,p.originRoughness=m.roughness),void 0!==m.metalness&&(p.metalness=m.metalness,p.originMetalness=m.metalness),r.GlobalData.IBL?(p.iblProbe=c.iblProbe,(u=new V.IBLMaterial(p)).type="IBL"):u=r.MaterialUtil.createStandardMaterial(p),u.name=t,n[t]=u,p=null,r.GlobalData.EnableTextureLoading){var f=null;m.texture_n>0&&(f=o.getTexture(m.texture_id[0])),f&&h.push({id:t,data:f})}}if(h.length>0){for(l=this.maxLoadTextureCount=h.length,t=0;t<l;t++)this._parseTexture(i,h[t],s);h=null}if(this.model.lightmap){var g=this.model.lightmapNum;for(this.maxLoadTextureCount+=g,t=0;t<g;t++){var v=this._loadTexture(i.textureUrl("lightmap-rgbm"+t+".png"),(function(){d._onLoadTexture()}),void 0,(function(){d._onLoadTexture()}));a.lightmaps[t]=v}}0==this.maxLoadTextureCount&&d._onLoadTexture(),o=null}}_parseMaterialJson(e){var t,i=this.url,a=this.model.materialManager,n=a.materials,s=(a.textures,new r.Loader.MaterialReaderJson(e)),o=s.count,l=this;let d={};if(!(o<0)){var h=this.model.manager.scene;for(t=0;t<o;++t){var c,u={},p=s.getMaterial(t),m=p.parameters;if(void 0!==m.color&&(u.color=m.color),void 0!==m.opacity&&(u.opacity=m.opacity,m.opacity<1&&(u.transparent=!0)),void 0!==m.side&&"double"==m.side&&(u.side=THREE.DoubleSide),void 0!==m.emissive&&(u.emissive=m.emissive),void 0!==m.environment&&(u.envMapIntensity=m.environment),void 0!==m.roughness&&(u.roughness=m.roughness,u.originRoughness=m.roughness),void 0!==m.metalness&&(u.metalness=m.metalness,u.originMetalness=m.metalness),void 0!==m.refractionRatio&&(u.refractionRatio=m.refractionRatio),void 0!==m.imageFade&&(u.imageFade=m.imageFade),void 0!==m.tintColor&&(u.tintColor=m.tintColor),null!=p.fillPattern){u.fillMap=r.MaterialUtil.loadFillMap(p.fillPattern);var f=this.model.getModelManager().viewer.domElement;u.viewportSize=new THREE.Vector2(f.offsetWidth,f.offsetHeight)}if("user"==p.tag&&(u.tag="user"),null!=p.receiveIBL&&(u.receiveIBL=p.receiveIBL),r.GlobalData.IBL?(u.iblProbe=h.iblProbe,(c=new V.IBLMaterial(u)).type="IBL"):(c=r.MaterialUtil.createStandardMaterial(u)).refreshUniforms(),c.name=t,n[t]=c,u=null,r.GlobalData.EnableTextureLoading){var g=[],v=p.textures;for(var y in v){var M=v[y];"reliefMap"==y&&v.bumpMap||g.push({type:y,data:M})}g.length>0&&(d[t]=g)}}if(a.handlerUrl=i,a.textureDataArray=d,Object.keys(d).length>0&&(this.maxLoadTextureCount++,a.updateTexturePkgMapping(void 0,(()=>{this._onLoadTexture()}))),this.model.lightmap){var E=this.model.lightmapNum;for(this.maxLoadTextureCount+=E,t=0;t<E;t++){var b=this._loadTexture(i.lightmapTexUrl("lightmap-rgbm"+t+".png"),(function(e){e.encoding=THREE.GammaEncoding,l._onLoadTexture()}),void 0,(function(){l._onLoadTexture()}));a.lightmaps[t]=b}}0==this.maxLoadTextureCount&&l._onLoadTexture(),s=null}}_loadTexture(e,t,i,a){var n,s=THREE.DefaultLoadingManager.getHandler(e),o=this;if(null!==s)n=s.load(e,t);else{n=new THREE.Texture;const l=e=>{let i=document.createElement("canvas");i.width=e.width,i.height=e.height,i.getContext("2d").putImageData(e,0,0),n.image=r.MaterialUtil.ensurePowerOfTwo(i),n.needsUpdate=!0,t&&t(n)},d=e=>{void 0!==a&&a(e),o.model.dispatchEvent({type:r.LOADERROREVENTS.LOAD_ERROR,errorType:r.LOADERROREVENTS.LOAD_TEXTURE_ERROR,event:e})},h=()=>new Promise(((t,r)=>{(s=new THREE.ImageLoader).setCrossOrigin("anonymous"),s.load(e,(function(e){let i=document.createElement("canvas");i.width=e.width,i.height=e.height;let r=i.getContext("2d");r.drawImage(e,0,0),t(r.getImageData(0,0,i.width,i.height))}),i,r)}));this.loadWithStorage(e,h,l,d)}return n}_parseTexture(e,t,i){var r=window.TEST||{},a=t.id,n=t.data,s=n.id+n.file_name_ext;const o=this.model.materialManager;this.enableCompressedTexture&&n.dds?this.textureLoader=o._loadCompressedTexture:r.CryptoResourceLoader?this.textureLoader=o._loadTextureByCrypto:this.textureLoader=o._loadTexture;var l=this;this.textureLoader(e.textureUrl(s),(function(e){e.repeat.fromArray([n.scale_u,n.scale_v]),e.offset.fromArray([n.offset_u,n.offset_v]),e.setRotateAngle&&e.setRotateAngle(n.angle),n.repeat_u&&(e.wrapS=THREE.RepeatWrapping),n.repeat_v&&(e.wrapT=THREE.RepeatWrapping),e&&(i[a]=e),l._onLoadTexture()}),void 0,(function(){l._onLoadTexture()}))}_loadUV2(){var e=this,t=this.url,i=this.fileLoader;(()=>{const r=t.uv2Url();this.loadWithStorage(r,(()=>new Promise(((e,t)=>{i.setResponseType("arraybuffer"),i.load(r,e,void 0,t)}))),(t=>{e.uv2Buffer=new Uint16Array(t),e._onTaskFinished()}),(t=>{e._onTaskFinished()}))})();(()=>{const r=t.uv2MapItemUrl();this.loadWithStorage(r,(()=>new Promise(((e,t)=>{i.setResponseType(""),i.load(r,e,void 0,t)}))),(t=>{e.uv2MapItem=JSON.parse(t),e._onTaskFinished()}),(t=>{e._onTaskFinished()}))})()}getUV2ById(e,t){if(this.uv2MapItem&&t){var i=this.uv2MapItem[e];if(i){var r=i.uv1Scale,a=i.uv1Translation,n=i.uv1ByteOffset/2,s=2*t;if(this.uv2Buffer){for(var o=this.uv2Buffer,l=[],d=n;d<n+s;d+=2)l.push(r[0]*(o[d]/65535)+a[0]),l.push(r[1]*(o[d+1]/65535)+a[1]);return{lightmapIdx:i.lightmapIdx,uv2:l}}}}}getInstanceUV2ForSharedMeshById(e,t){if(this.uv2MapItem&&t){var i=this.uv2MapItem[e];if(i){var r=i.uv1Scale,a=i.uv1Translation,n=i.uv1ByteOffset/2,s=2*t;if(this.uv2Buffer){for(var o=this.uv2Buffer,l=[],d=n;d<n+s;d+=2)l.push(o[d]),l.push(o[d+1]);var h=[];return h.push(r[0]),h.push(r[1]),h.push(a[0]),h.push(a[1]),{lightmapIdx:i.lightmapIdx,uv2:l,offsetRepeat:h}}}}}getInstanceUV2InfoById(e){if(this.uv2MapItem){var t=this.uv2MapItem[e];if(t){var i=t.uv1Scale,r=t.uv1Translation,a=[];return a.push(i[0]),a.push(i[1]),a.push(r[0]),a.push(r[1]),{lightmapIdx:t.lightmapIdx,byteOffset:t.uv1ByteOffset,offsetRepeat:a}}}}getInstanceUV2ById(e,t){var i=e/2;if(this.uv2Buffer)return this.uv2Buffer.slice(i,i+t)}_loadSymbol(e){var t=this,i=this.url,a=this.fileLoader;const n=i.symbolUrl();this.loadWithStorage(n,(()=>new Promise(((e,t)=>{a.setResponseType("arraybuffer"),a.load(n,e,void 0,t)}))),(i=>{t.parseSymbol(i),t._onTaskFinished(),e&&e()}),(i=>{t.model.dispatchEvent({type:r.LOADERROREVENTS.LOAD_ERROR,errorType:r.LOADERROREVENTS.LOAD_SYMBOL_ERROR,event:i}),t._onTaskFinished(),e&&e()}))}parseSymbol(e){const t=this.model.getConfig().metadata;this.descriptor.symbolReader=new r.Loader.SymbolReader(e,t.version)}_loadOctree(e,t){var i=null,r=this.model.configLoader.transformInfos.transformMatrix;this.model.configLoader.transformInfos.octreeTransformed&&(i=new THREE.Matrix4).copy(r).invert(),e&&this._loadOctreeBy(i,!1),t&&this._loadOctreeBy(i,!0)}_loadOctreeBy(e,t){var i=this,a=this.url,n=this.fileLoader;const s=t?a.octreeUrl("i"):a.octreeUrl("o");this.loadWithStorage(s,(()=>new Promise(((e,t)=>{n.setResponseType("arraybuffer"),n.load(s,e,void 0,t)}))),(r=>{i._parseOctree(r,e,t),i._onTaskFinished()}),(e=>{i.model.dispatchEvent({type:r.LOADERROREVENTS.LOAD_ERROR,errorType:r.LOADERROREVENTS.LOAD_OCTREEINNER_ERROR,event:e}),i._onTaskFinished()}))}_parseOctree(e,t,i){this.descriptor.octreeRootNode[i?"inner":"outer"]=this._getOctreeRootNode(e,t)}_getOctreeRootNode(i,a){function n(i,r){a&&r.boundingBox.applyMatrix4(a),i.boundingBoxWorld=r.boundingBox.clone(),i.min=r.boundingBox.min,i.max=r.boundingBox.max,i.center=r.boundingBox.getCenter(e).clone(),i.size=r.boundingBox.getSize(t).lengthSq(),i.childStart=r.child_s,i.childEnd=r.child_e}function s(e,t){e.octType=0,e.center.x<t.center.x&&(e.octType+=1),e.center.y<t.center.y&&(e.octType+=2),e.center.z<t.center.z&&(e.octType+=4)}var o=null,l=new r.Loader.OctreeReader(i);if(l.getCount()>0){var d=l.getNode(0),h=d.cell_id;n(o=new r.Loader.OctreeNode(h,0),d),function e(t,i){for(var a=t.childStart,o=t.childEnd,l=a;l<o;++l){var d=i.getNode(l),h=d.cell_id,c=new r.Loader.OctreeNode(h,t.depth);n(c,d),t.add(c),s(c,t),c.updateMaxDepth(),e(c,i)}}(o,l)}return l=null,o}_loadUserId(){var e=this,t=this.url,i=this.fileLoader;const a=t.userIdUrl();this.model.emptyScene?e._onTaskFinished():this.loadWithStorage(a,(()=>new Promise(((e,t)=>{i.setResponseType("arraybuffer"),i.load(a,e,void 0,t)}))),(t=>{e._parseUserId(t),e._onTaskFinished()}),(t=>{e.model.dispatchEvent({type:r.LOADERROREVENTS.LOAD_ERROR,errorType:r.LOADERROREVENTS.LOAD_USERID_ERROR,event:t}),e._onTaskFinished()}))}_parseUserId(e){this.descriptor.userIdReader=new r.Loader.IdReader(e)}_loadUserData(){var e=this,t=this.url,i=this.fileLoader;const a=t.userDataUrl();this.loadWithStorage(a,(()=>new Promise(((e,t)=>{i.setResponseType(""),i.load(a,e,void 0,t)}))),(t=>{e._parseUserData(t),e._onTaskFinished()}),(t=>{e.model.dispatchEvent({type:r.LOADERROREVENTS.LOAD_ERROR,errorType:r.LOADERROREVENTS.LOAD_USERDATA_ERROR,event:t}),e._onTaskFinished()}))}_parseUserData(e){this.descriptor.userDataReader=new r.Loader.UserDataReader(e)}_loadCamera(){var e=this,t=this.url,i=this.fileLoader;const a=t.cameraUrl();this.loadWithStorage(a,(()=>new Promise(((e,t)=>{i.setResponseType(""),i.load(a,e,void 0,t)}))),(t=>{e._parseCamera(t),e._onTaskFinished()}),(t=>{e.model.dispatchEvent({type:r.LOADERROREVENTS.LOAD_ERROR,errorType:r.LOADERROREVENTS.LOAD_CAMERA_ERROR,event:t}),e._onTaskFinished()}))}_parseCamera(e){var t=this.model.configLoader.transformInfos.transformMatrix;new r.Loader.CameraReader(e).parse(this.model,t)}_loadMpk(e,t){var i=this,a=this.fileLoader;const n=this.url.mpkUrl(e);this.loadWithStorage(n,(()=>new Promise(((e,t)=>{a.setResponseType("arraybuffer"),a.load(n,e,void 0,t)}))),(r=>{i._parseMpk(r,e),t(),i._onTaskFinished()}),(e=>{i.model.dispatchEvent({type:r.LOADERROREVENTS.LOAD_ERROR,errorType:r.LOADERROREVENTS.LOAD_MPK_ERROR,event:e}),t(),i._onTaskFinished()}))}_loadAllMpks(e){for(var t=0;t<e;++t)this.mpkTaskManager.addTask(t);this.mpkTaskManager.processTasks(this._loadMpk.bind(this))}_parseMpk(e,t){for(var i=new(this.model.getConfig().metadata.mpk_batched?r.Loader.BMPKReader:r.Loader.MPKReader)(e),a=new THREE.Matrix4,n=0,s=i.header.meshCount;n<s;++n){var o=i.getPtBuffer(n),l=i.getIdxBuffer(n),d=i.getNormalBuffer(n),h=i.getMeshData(n),c=i.getUVBuffer(n);null!=o&&null!=l?(void 0!==h.baseScale&&0!==h.baseScale&&(o=new Float32Array(o),a.identity(),a.setPosition(new THREE.Vector3(h.baseX,h.baseY,h.baseZ)),a.scale(new THREE.Vector3(h.baseScale,h.baseScale,h.baseScale)),r.GeomUtil.applyMatrix4ToBuffer(a,o)),this.descriptor.cacheReferencedMeshBufferData(h.mesh_id,{P:o,I:l,N:d,UV:c}),this.descriptor.cacheReferencedMeshMpkIds(t,h.mesh_id)):r.Logger.log("Error Geometry!")}i=null}_loadBorderline(e){var t=this,i=this.url,a=this.fileLoader;const n=e?i.borderLineUrl(1):i.borderLineUrl(0);this.loadWithStorage(n,(()=>new Promise(((e,t)=>{a.setResponseType("arraybuffer"),a.load(n,e,void 0,t)}))),(i=>{t._parseBorderLine(i,e),t._onTaskFinished()}),(e=>{t.model.dispatchEvent({type:r.LOADERROREVENTS.LOAD_ERROR,errorType:r.LOADERROREVENTS.LOAD_MATERIAL_ERROR,event:e}),t._onTaskFinished()}))}_parseBorderLine(e,t){for(var i=new r.Loader.LineReader(e,this.version),a=[],n=0,s=i.header.lineCount;n<s;++n){var o=i.getLineData(n);a.push({meshId:o.line_id,positionStart:o.ptOffset/4,positionCount:3*o.ptCount,indexStart:o.idxOffset/4,indexCount:o.idxCount})}this.descriptor.cacheBorderLine(t,{P:i.ptBuffer,I:i.idxBuffer,IndexInfos:a,mpkMatrix:i.getMatrix()}),i=null}_isLoadMpkBorderlines(){var e=this.model.getConfig().metadata;return!(!r.GlobalData.BorderLineBatched||!e.outline_mpk)}getAllBorderlineCount(){var e=this.model.getConfig().metadata;return this._isLoadMpkBorderlines()?e.outline_mpk:e.outline_0+e.outline_1}_loadAllBorderlines(e){this._isLoadMpkBorderlines()?e.outline_mpk&&this._loadAllMpkBorderLines(e.outline_mpk):(e.outline_0&&this._loadBorderline(!1),e.outline_1&&this._loadBorderline(!0))}delayLoadBorderlines(e){this._isLoadMpkBorderlines()?this._delayLoadMpkBorderlines(e):this._delayLoadTogetherBorderlines(e)}_delayLoadMpkBorderlines(e){var t=this.model.getConfig().metadata;this.startCallback=null,this.progressCallback=null,this.finishCallback=e,this.loadTaskCount=0,this.maxLoadTaskCount=t.outline_mpk,t.outline_mpk&&this._loadAllMpkBorderLines(t.outline_mpk)}_delayLoadTogetherBorderlines(e){var t=this.model.getConfig().metadata;this.startCallback=null,this.progressCallback=null,this.finishCallback=e,this.loadTaskCount=0,this.maxLoadTaskCount=t.outline_0+t.outline_1,t.outline_0&&this._loadBorderline(!1),t.outline_1&&this._loadBorderline(!0)}_loadAllMpkBorderLines(e){this.mpkBorderLineTaskManager||(this.mpkBorderLineTaskManager=new r.TaskManager);for(var t=0;t<e;++t)this.mpkBorderLineTaskManager.addTask(t);this.mpkBorderLineTaskManager.processTasks(this._loadMpkBorderLine.bind(this))}_loadMpkBorderLine(e,t){var i=this,r=this.fileLoader,a=this.url,n=e>=this.model.getConfig().metadata.mpk_shared_index;const s=a.mpkBorderLineUrl(e);this.loadWithStorage(s,(()=>new Promise(((e,t)=>{r.setResponseType("arraybuffer"),r.load(s,e,void 0,t)}))),(e=>{i._parseMpkBorderLine(e,n),t(),i._onTaskFinished()}),(e=>{i._onTaskFinished()}))}_parseMpkBorderLine(e,t){for(var i=new r.Loader.LineReader(e,this.version),a=[],n=0,s=i.header.lineCount;n<s;++n){var o=i.getLineData(n);a.push({meshId:o.line_id,positionStart:o.ptOffset/4,positionCount:3*o.ptCount,indexStart:o.idxOffset/4,indexCount:o.idxCount})}this.descriptor.cacheBorderLine(t,{P:i.ptBuffer,I:i.idxBuffer,IndexInfos:a,mpkMatrix:i.getMatrix()}),i=null}dealProgressSegment(e,t){return r.GlobalData.BatchMergeEnabled?t*e.progressPercentage.load:t}}})(),function(){class e extends r.ModelView.BaseLoader{constructor(e){super(e),this.descriptor=null}loadSceneAndMpks(e){e.symbol&&this._loadSymbol(),this._loadScene(0),e.lines&&this._loadLine(),e.mpks&&this._loadAllMpks(e.mpks),r.GlobalData.BorderLineDelayLoaded||this._loadAllBorderlines(e)}getSceneTaskCount(e){var t=e.scenes;return t+=e.symbol,t+=e.lines,t+=e.mpks,r.GlobalData.BorderLineDelayLoaded||(t+=this.getAllBorderlineCount()),t}}r.ModelView.DefaultBaseLoader=e}(),r.ModelView.ModelBaseHandler=class{constructor(e){this.model=e,this.defaultManager=null,this.instancedManager=null,this.loader=null,this.loaded=!1,this.dataReady=!1,this.borderlinesLoaded=!1,this.borderlinesGenerated=!1}destroy(){this.model=null,this.defaultManager.destroy(),this.defaultManager=null,this.instancedManager.destroy(),this.instancedManager=null,this.loader&&(this.loader.destroy(),this.loader=null)}load(e){var t=this,i=this.model;this.loader.setNotifyProgress(e),this.loader.load((function(){i.manager.dispatchEvent({type:r.EVENTS.ON_LOAD_START})}),(function(e){i.manager.dispatchEvent({type:r.EVENTS.ON_LOAD_PROGRESS,progress:e})}),(function(){console.time("PrepareData:"),t.prepareData((function(){console.timeEnd("PrepareData:"),t.processLoadCompleted((function(){i.manager.dispatchEvent({type:r.EVENTS.ON_LOAD_COMPLETE,modelId:i.id})}))}))}))}processLoadCompleted(e){var t=this.model;t.materialManager._updateTextureMapping(),t.materialManager._updateIBL(t),t.updateOctreeNode();var i=t.getFilter();let r={};r[t.fileId]=this.model.getAllNodeInfos(),i.initFilterManager(r),requestAnimationFrame((function(){t.setLoaded(!0),e&&e(),t.updateMeshNodes(),t.applyFilter(),t.debut(t)}))}prepareData(e){if(!this.dataReady){var t=this;this.loader.getDescriptor().parseItemData((function(){t.dataReady=!0,t.settleData(e)}))}}prepareWireframe(e,t){if(e.isActivateWireframe())if(r.GlobalData.BorderLineDelayLoaded&&this.loader.getAllBorderlineCount())if(this.borderlinesLoaded)this.borderlinesGenerated&&(this.defaultManager.asyncGenerateWireframe(e),this.instancedManager.generateWireframe(e));else{this.borderlinesLoaded=!0;var i=this;this.loader.delayLoadBorderlines((function(){i.instancedManager.generateWireframe(e),i.defaultManager.asyncGenerateWireframe(e,(function(){console.log("Delay loading borderline OK!"),i.borderlinesGenerated=!0,t&&t()}))}))}else this.defaultManager.generateWireframe(e),this.instancedManager.generateWireframe(e)}prepare(e){}needUpdate(){return!0}updateNodes(){this.needUpdate()&&(this.defaultManager.updateNodes(this.model),r.GlobalData.Instance&&this.instancedManager.updateNodes(this.model))}isLoaded(){return this.loaded}isDataReady(){return this.loaded}isAllReady(){return!0}isHidden(){var e=this.model;return!e.visible&&(e.manager.scene.removeObjectGroupByName(e._getWireframeGroupName()),!0)}settleData(e){}addNodeInfoToOctantMap(){}applyFilter(){this.isLoaded()&&(this.defaultManager.applyFilter(this.model),r.GlobalData.Instance&&this.instancedManager.applyFilter(this.model))}applySelection(){this.isLoaded()&&(this.defaultManager.applySelection(this.model),r.GlobalData.Instance&&this.instancedManager.applySelection(this.model))}clearSelection(){this.isLoaded()&&(this.defaultManager.clearSelection(this.model),r.GlobalData.Instance&&this.instancedManager.clearSelection(this.model))}applyHover(){this.isLoaded()&&(this.defaultManager.applyHover(this.model),r.GlobalData.Instance&&this.instancedManager.applyHover(this.model))}clearHover(){this.isLoaded()&&(this.defaultManager.clearHover(this.model),r.GlobalData.Instance&&this.instancedManager.clearHover(this.model))}applyBlink(){this.isLoaded()&&(this.defaultManager.applyBlink(this.model),r.GlobalData.Instance&&this.instancedManager.applyBlink(this.model))}clearBlink(){this.isLoaded()&&(this.defaultManager.clearBlink(this.model),r.GlobalData.Instance&&this.instancedManager.clearBlink(this.model))}applyReplacement(){this.isLoaded()&&(this.defaultManager.applyReplacement(this.model),r.GlobalData.Instance&&this.instancedManager.applyReplacement(this.model))}getMeshesByUserIds(e,t){this.isLoaded()&&(this.defaultManager.getMeshesByUserIds(this.model,e,t),r.GlobalData.Instance&&(this.instancedManager.getMeshesByUserId(this.model,e),this.instancedManager.getMeshesByUserId(this.model,t)))}rebuildIndicesforLightmap(){this.defaultManager.rebuildIndices(this.model)}adjustVisibility(e){this.defaultManager.adjustVisibility(this.model,e)}changeVisibilityOfSelectedObjects(e){this.defaultManager.changeVisibilityOfSelectedObjects(this.model,e)}changeVisibilityOfNonSelectedObjects(e){this.defaultManager.changeVisibilityOfNonSelectedObjects(this.model,e)}adjustInstanceVisibility(e){this.instancedManager.adjustVisibility(this.model,e)}changeInstanceVisibilityOfSelectedObjects(e){this.instancedManager.changeVisibilityOfSelectedObjects(this.model,e)}changeInstanceVisibilityOfNonSelectedObjects(e){this.instancedManager.changeVisibilityOfNonSelectedObjects(this.model,e)}restoreVisibilityOfObjects(){this.defaultManager.restoreVisibilityOfObjects(),this.instancedManager.restoreVisibilityOfObjects()}getBlinkMaterials(){var e=[],t=this.model.materialManager.instanceMaterials;for(var i in t)for(var r=t[i],a=0,n=r.length;a<n;a++)e.push(r[a]);return e=e.concat(this.defaultManager.meshManager.getBlinkMaterials())}disposeBufferAfterVbo(){this.isLoaded()&&(this.defaultManager.disposeBufferAfterVbo(),this.instancedManager.disposeBufferAfterVbo())}getGeometryBuffersByUserId(e){if(!this.isLoaded())return[];var t=[];return t=(t=t.concat(this.defaultManager.getGeometryBuffersByUserId(this.model,e))).concat(this.instancedManager.getGeometryBuffersByUserId(this.model,e))}explode(){this.isLoaded()&&(this.defaultManager.explode(this.model),r.GlobalData.Instance&&this.instancedManager.explode(this.model))}calculateClippingIds(e,t){if(!this.isLoaded()||!r.GlobalData.BatchMergeEnabled)return;if(e){let e=this.model.getModelDescriptor().getStandardUserIds(),t=this.model.getModelDescriptor().getStandardNodeInfos();if(this.defaultManager._collectFilteredUserIds(this.model,e,t),r.GlobalData.Instance){let e=this.model.getModelDescriptor().getInstancedUserIds(),t=this.model.getModelDescriptor().getInstancedNodeInfos();this.instancedManager._collectFilteredUserIds(this.model,e,t)}}var i=this.model.manager.scene.fillClipPlane;let a=i&&i.isEnabled();var n=this.model.manager.scene.clipPlanes;let s=a?i:n,o=s.renderClipPlane,l=a?s.capsIntersectPosition:s.capsIntersectPosition[s.selectIndex];l.length=0;let d=a?-1:s.selectIndex;n&&t&&this.defaultManager.clearClippingIdsForBox(),this.defaultManager.calculateClippingIds(o,l,d,this.model),r.GlobalData.Instance&&this.instancedManager.calculateClippingIds(o,l,this.model),s.addToCapsWireframe(this.model)}calculateClippingContours(e){const t=this.model.manager.scene;var i=r.FillClipPlaneManager.getInstance(t);const a=i.planeMesh;var n=i.renderClipPlane;const s=r.FillClipPlaneManager.getFillClipPlaneBoundingBoxWorld(t),o=this.model.id;i.capsIntersectContour[o]={},this.defaultManager.calculateClippingContours(o,n,a,s,e,i.capsIntersectContour),r.GlobalData.Instance&&this.instancedManager.calculateClippingContours(o,n,a,s,e,i.capsIntersectContour)}isHiddenNode(e){return this.defaultManager.isHiddenNode(e)||this.defaultManager.isHiddenNode(e)}},(()=>{class e extends r.ModelView.BaseDescriptor{constructor(){super()}parseItemData(e){var t=this.getSceneReaderMap();for(var i in t)for(var r=t[i],a=0,n=r.header.cellCount;a<n;++a)for(var s=r.getCellInfo(a),o=s.itemIndex;o<s.itemCount;++o)this._readItemData(r,o,a);e&&e()}asyncParseItemData(e){for(var t=this.getSceneReaderMap(),i=Object.keys(t),a=i.length,n=0,s=this,o=0;o<a;o++){i[o];var l=t[i[o]];r.Utils.asyncProcess(l,l.header.cellCount,100,(function(e,t){s._parseItemDataBy(e,t)}),(function(){++n===a&&e&&e()}))}}_parseItemDataBy(e,t){for(var i=e.getCellInfo(t),r=i.itemIndex;r<i.itemCount;++r)this._readItemData(e,r,t)}parseItemDataByCellId(e){var t=this.getSceneReaderMap();for(var i in t)this._parseItemDataBy(t[i],e)}_readItemData(e,t,i){var a=e.getItemInfo(t);void 0!==a&&(a.type===r.ModelView.BaseDescriptor.EnumNodeItemType.SYMBOL?this._readSymbolInfo(e,i,a):this._readMeshInfo(e,i,a,null))}_readSymbolInfo(e,t,i){var a=this.symbolReader;if(a){var n=a.header.symbolCount,s=i.toData,o=e.getMatrixInfo(i.matrixId).matrix.clone(),l={matrix:o,ItemId:i.ItemId,originalId:i.originalId,userDataId:i.userDataId,materialId:i.materialId};if(s>=0&&s<n)for(var d=a.getSymbolInfo(s),h=d.itemIndex;h<d.itemCount;++h){var c=a.getItemInfo(h);c.type!==r.ModelView.BaseDescriptor.EnumNodeItemType.SYMBOL&&this._readMeshInfo(a,t,c,l)}o=null,l=null,a=null}}_readMeshInfo(e,t,i,a){var n,s,o;if(null===a)n=i.userDataId,s=i.originalId,o=i.materialId;else{n=a.userDataId,s=a.originalId;var l=this.getConfigure();o=(!l||0===l.metadata.material_override||1===l.metadata.material_override&&(-1===i.materialId||void 0===i.materialId))&&a.materialId>-1?a.materialId:i.materialId}var d=null,h=r.ModelView.BaseDescriptor.EnumNodeItemType;switch(i.type){case h.MESH:d=this._getMeshNodeAttr(e,i,a);break;case h.TUBE:d=this._getMeshNodeAttrOfTube(e,i,a);break;case h.PIPE:d=this._getMeshNodeAttrOfPipe(e,i,a);break;case h.BOX:d=this._getMeshNodeAttrOfBox(e,i,a);break;case h.BOX_M:d=this._getMeshNodeAttrOfBoxM(e,i,a);break;case h.PIPE_M:d=this._getMeshNodeAttrOfPipeM(e,i,a);break;case h.MESH_REF:d=this._getMeshNodeAttrOfMeshRef(e,i,a);break;case h.LINE:d=this._getLineNodeAttr(e,i,a)}if(d){if(d.userId=this.userIdReader?this.userIdReader.getString(s):s,d.userData=this.userDataReader?this.userDataReader.getUserData(n):null,d.name=d.userId,d.type=i.type,d.cellId=t,d.materialId=o,d.state=r.EnumObjectState.Visible,d.material=null,this.lightmap){var c=i.ItemId;a&&(c=a.ItemId+"_"+i.ItemId),d.itemIdUV2=c}d.parameterizedDesc=this._isParameterizedNode(d),this._isGeometrySharedNode(d)&&(void 0===this.sharedGeometryCounter[d.geometryId]&&(this.sharedGeometryCounter[d.geometryId]=0),this.sharedGeometryCounter[d.geometryId]+=1),this.fullNodeInfoArray.push(d),d=null}}_getMeshNodeAttrOfPipe(e,t,i){const a=e.getMatrixInfo(t.matrixId).matrix.clone();i&&a.multiplyMatrices(i.matrix,a);const n=r.Utils.scratchVector_1,s=r.Utils.scratchVector_2,o=r.Utils.scratchVector_3,l=r.Utils.scratchMatrix4_1,d=r.Utils.scratchQuaternion_1,h=t.boundingBox.clone();h.applyMatrix4(a);let c=e.getGeomPipeInfo(t.toData);const u=c.startPt,p=c.endPt,m=o.copy(p).sub(u),f=m.length();m.normalize();let g=c.radius;const v=n.set(0,1,0),y=s.set(g,f,g),M=d.setFromUnitVectors(v,m),E=n.copy(u).addScaledVector(m,.5*f),b=l.identity().compose(E,M,y);a.multiply(b),c=null;const I=r.Math.isMirror(a),x=r.ModelView.BaseDescriptor.parameterizedNodeType.PIPE,T=I?x+"Mirror":x;return{nodeId:(i?i.ItemId+"_"+t.ItemId:t.ItemId)+"_"+x,geometryId:x,geometryIdCode:T,boundingBox:h,matrix:a,fromMirror:I}}_getMeshNodeAttrOfTube(e,t,i){return this._getMeshNodeAttrOfPipe(e,t,i)}_getMeshNodeAttrOfBox(e,t,i){const a=e.getMatrixInfo(t.matrixId).matrix.clone();i&&a.multiplyMatrices(i.matrix,a);const n=r.Utils.scratchVector_1,s=r.Utils.scratchMatrix4_1,o=t.boundingBox.clone();o.applyMatrix4(a);const l=t.boundingBox,d=l.getSize(n),h=s.identity().scale(d),c=l.getCenter(n);h.setPosition(c),a.multiply(h);const u=r.Math.isMirror(a),p=r.ModelView.BaseDescriptor.parameterizedNodeType.BOX,m=u?p+"Mirror":p;return{nodeId:(i?i.ItemId+"_"+t.ItemId:t.ItemId)+"_"+p,geometryId:p,geometryIdCode:m,boundingBox:o,matrix:a,fromMirror:u}}_getMeshNodeAttrOfBoxM(e,t,i){const a=e.getMatrixInfo(t.matrixId).matrix.clone();i&&a.multiplyMatrices(i.matrix,a);const n=t.boundingBox.clone();n.applyMatrix4(a);const s=r.Math.isMirror(a),o=r.ModelView.BaseDescriptor.parameterizedNodeType.BOX_M,l=s?o+"Mirror":o,d=e.getGeomBoxUvInfo(t.toData);return{nodeId:(i?i.ItemId+"_"+t.ItemId:t.ItemId)+"_"+o,geometryId:o,geometryIdCode:l,boundingBox:n,matrix:a,fromMirror:s,uvArrayBuffer:d}}_getMeshNodeAttrOfPipeM(e,t,i){const a=e.getMatrixInfo(t.matrixId).matrix.clone();i&&a.multiplyMatrices(i.matrix,a);const n=t.boundingBox.clone();n.applyMatrix4(a);const s=r.Math.isMirror(a),o=r.ModelView.BaseDescriptor.parameterizedNodeType.PIPE_M,l=s?o+"Mirror":o,d=e.getGeomPipeUvInfo(t.toData);return{nodeId:(i?i.ItemId+"_"+t.ItemId:t.ItemId)+"_"+o,geometryId:o,geometryIdCode:l,boundingBox:n,matrix:a,fromMirror:s,uvArrayBuffer:d}}_getMeshNodeAttrOfMeshRef(e,t,i){const a=e.getMatrixInfo(t.matrixId).matrix.clone();i&&a.multiplyMatrices(i.matrix,a);const n=t.boundingBox.clone();n.applyMatrix4(a);const s=r.Math.isMirror(a),o=t.toData,l=s?o+"Mirror":o;return{nodeId:"refMesh|"+(i?i.ItemId+"_"+t.ItemId:t.ItemId),geometryId:o,geometryIdCode:l,boundingBox:n,matrix:a,fromMirror:s}}_getMeshNodeAttr(e,t,i){const a=t.boundingBox.clone(),n=new THREE.Matrix4;-1!==t.matrixId?(n.copy(e.getMatrixInfo(t.matrixId).matrix),i&&n.multiplyMatrices(i.matrix,n),a.applyMatrix4(n)):i&&a.applyMatrix4(i.matrix);const s=r.Math.isMirror(n),o=t.toData,l=s?o+"Mirror":o;return{nodeId:i?i.ItemId+"_"+t.ItemId:t.ItemId,geometryId:o,geometryIdCode:l,boundingBox:a,matrix:n,fromMirror:s}}_getLineNodeAttr(e,t,i){const r=t.boundingBox.clone(),a=new THREE.Matrix4;-1!==t.matrixId?(a.copy(e.getMatrixInfo(t.matrixId).matrix),i&&a.multiplyMatrices(i.matrix,a),r.applyMatrix4(a)):i&&r.applyMatrix4(i.matrix);const n="line-"+t.toData,s=n;return{nodeId:i?"line-"+i.ItemId+"-"+t.ItemId:"line-"+t.ItemId,geometryId:n,geometryIdCode:s,boundingBox:r,matrix:a}}}r.ModelView.DefaultDescriptor=e})(),function(){class e extends r.ModelView.DefaultBaseLoader{constructor(e){super(e),this.descriptor=new r.ModelView.DefaultDescriptor}}r.ModelView.DefaultLoader=e}(),r.ModelView.InstancedBaseManager=class{constructor(){this.meshManager=null,this.wireframeManager=null}destroy(){this.meshManager.destroy(),this.meshManager=null,this.wireframeManager.destroy(),this.wireframeManager=null}clearData(){this.meshManager.clearData(),this.wireframeManager.clearData()}getGeometryByNodeInfo(e,t){return this.meshManager.getGeometryByNodeInfo(e,t)}getInstanceGeometries(){return this.meshManager.instanceGeometryMap}traverseInstanceGeometryMap(e){this.meshManager.traverseInstanceGeometryMap(e)}getCachedInstanceData(){return this.meshManager.cachedInstance}getBufferAttributesBy(e){return this.meshManager.getBufferAttributesBy(e)}traverseNodeIdxMapByUserId(e,t){this.meshManager.traverseNodeIdxMapByUserId(e,t)}traverseNodeIdxMap(e,t){this.meshManager.traverseNodeIdxMap(e,t)}getMeshesByUserId(e,t){this.meshManager.getMeshesByUserId(e,t)}_updateInstanceMaterialByUserId(e,t,i,r){this.meshManager.updateInstanceStateByUserId(e,t,i,r)}_updateInstanceClippingByUserId(e){this.meshManager.updateInstanceClippingByUserId(e)}_updateInstanceMaterialForWireFrameByUserId(e,t,i,r){this.wireframeManager.updateInstanceWireframeByUserId(e,t,i,r)}_updateInstanceWireframeClippingByUserId(e){this.wireframeManager.updateInstanceWireframeClippingByUserId(e)}_updateInstanceMaterial(e){r.Logger.time("update instance material");var t=r.Model.EnumFilterState;this.clearSelectedObjectIds();var i=null,a=e.getFilter();if(a&&(i=a.getLocalClippingList()),i)for(var n in i)this._updateInstanceClippingByUserId(n),this._updateInstanceWireframeClippingByUserId(n);for(var n in this.filteredIds){var s=this.filteredIds[n];if(s[t.HIDDEN])this._updateInstanceMaterialByUserId(e,n,r.EnumInstanceState.HIDDEN),this._updateInstanceMaterialForWireFrameByUserId(e,n,r.EnumInstanceState.HIDDEN);else if(s[t.TRANSPARENT])this._updateInstanceMaterialByUserId(e,n,r.EnumInstanceState.TRANSPARENT);else{if(e.manager.isSelectPriority()){if(s[t.SELECTED]){r.GlobalData.PickingEffect?s[t.OVERRIDED]&&this._updateInstanceMaterialByUserId(e,n,r.EnumInstanceState.OVERRIDED,s[t.OVERRIDED]):this._updateInstanceMaterialByUserId(e,n,r.EnumInstanceState.SELECTED);continue}if(s[t.BLINK]){s[t.OVERRIDED]?this._updateInstanceMaterialByUserId(e,n,r.EnumInstanceState.BLINK,s[t.OVERRIDED]):this._updateInstanceMaterialByUserId(e,n,r.EnumInstanceState.BLINK);continue}}else{if(s[t.BLINK]){s[t.OVERRIDED]?this._updateInstanceMaterialByUserId(e,n,r.EnumInstanceState.BLINK,s[t.OVERRIDED]):this._updateInstanceMaterialByUserId(e,n,r.EnumInstanceState.BLINK);continue}if(s[t.SELECTED]){r.GlobalData.PickingEffect?s[t.OVERRIDED]&&this._updateInstanceMaterialByUserId(e,n,r.EnumInstanceState.OVERRIDED,s[t.OVERRIDED]):this._updateInstanceMaterialByUserId(e,n,r.EnumInstanceState.SELECTED);continue}}s[t.HOVER]?s[t.OVERRIDED]?this._updateInstanceMaterialByUserId(e,n,r.EnumInstanceState.HOVER,s[t.OVERRIDED]):this._updateInstanceMaterialByUserId(e,n,r.EnumInstanceState.HOVER):s[t.OVERRIDED]&&this._updateInstanceMaterialByUserId(e,n,r.EnumInstanceState.OVERRIDED,s[t.OVERRIDED])}}this._updateInstanceMaterialForWireFrame(e),r.Logger.timeEnd("update instance material")}_updateInstanceMaterialForWireFrame(e){var t=this.mapFilteredUserIdsForWireFrame;if(t)for(var i=Object.keys(t),a=0,n=i.length;a<n;a++){var s=i[a];this.filteredIds&&this.filteredIds[s]&&this.filteredIds[s][r.Model.EnumFilterState.HIDDEN]||this._updateInstanceMaterialForWireFrameByUserId(e,s,r.EnumInstanceState.OVERRIDED,t[s])}}_resetInstanceMaterial(e,t){this.meshManager.resetInstanceMaterial(e),this.wireframeManager.resetInstanceMaterial(t)}_collectFilteredUserIds(e,t,i){var a=e.getFilter(),n=a._hasHiddenFileIdFilter(),s=a._hasVisibleFilter(),o=a._hasOverrideMaterialFilter(),l=a._hasTransparentFilter(),d=e.hasReplacedUserId(),h=e.hasHiddenSourceObjectUserId(),c=this.filteredIds={};if(n||s||o||l||d||h)for(var u=r.Model.EnumFilterState,p=0;p<t.length;++p){var m=t[p],f=i[m];if(f&&f.length){var g=f[0];if(n&&a._isHiddenFileId(g)||s&&!1===a._isVisible(g)||e.isReplacedUserId(m)||e.isHiddenSourceObjectUserId(m))c[m]||(c[m]={}),c[m][u.HIDDEN]=!0;else if(l&&a._isTransparent(g))c[m]||(c[m]={}),c[m][u.TRANSPARENT]=!0;else if(o&&a._hasOverrideMaterial(g)){var v=a._getOverrideMaterial(g),y=null!=v?v.name:"";""!==y&&(c[m]||(c[m]={}),c[m][u.OVERRIDED]=y)}}}}_collectFilteredUserIdsForWireFrame(e,t,i){var a=e.getFilter(),n=a._hasOverrideMaterialFilterForWireFrame();if(this.mapFilteredUserIdsForWireFrame={},n)for(var s=r.Model.EnumFilterState,o=0;o<t.length;++o){var l=t[o];if(!(this.filteredIds&&this.filteredIds[l]&&this.filteredIds[l][s.HIDDEN])){var d=i[l];if(d&&d.length){var h=d[0];if(a._hasOverrideMaterialForWireFrame(h)){var c=a._getOverrideMaterialForWireFrame(h),u=null!=c?c.name:"";""!==u&&(this.mapFilteredUserIdsForWireFrame[l]=u)}}}}}_collectSelectedUserIds(e,t){var i=this.filteredIds=this.filteredIds||{},a=r.Model.EnumFilterState,n={};for(var s in e)t[s]&&(i[s]||(i[s]={}),i[s][a.SELECTED]=!0,n[s]=!0);this.selectedUserIds=Object.keys(n)}_clearSelectedState(e){if(this.filteredIds&&this.selectedUserIds&&this.selectedUserIds.length){for(var t=0,i=this.selectedUserIds.length;t<i;t++){var a=this.selectedUserIds[t];this.filteredIds[a]&&(this.meshManager.clearInstanceStateByUserId(a),delete this.filteredIds[a][r.Model.EnumFilterState.SELECTED])}this.selectedUserIds=null}}_collectHoveredUserIds(e,t){var i=this.filteredIds=this.filteredIds||{};this.hoverdUserId=void 0,e&&t[e]&&(i[e]||(i[e]={}),i[e][r.Model.EnumFilterState.HOVER]=!0,this.hoverdUserId=e)}_clearHoveredState(e){this.filteredIds&&this.hoverdUserId&&this.filteredIds[this.hoverdUserId]&&(this.meshManager.clearInstanceStateByUserId(this.hoverdUserId),delete this.filteredIds[this.hoverdUserId][r.Model.EnumFilterState.HOVER],this.hoverdUserId=void 0)}_collectBlinkedUserIds(e,t){var i=this.filteredIds=this.filteredIds||{},a=r.Model.EnumFilterState,n={};for(var s in e)t[s]&&(i[s]||(i[s]={}),i[s][a.BLINK]=!0,n[s]=!0);this.blinkUserIds=Object.keys(n)}_clearBlinkedState(e){if(this.filteredIds&&this.blinkUserIds&&this.blinkUserIds.length){for(var t=0,i=this.blinkUserIds.length;t<i;t++){var a=this.blinkUserIds[t];this.filteredIds[a]&&(this.meshManager.clearInstanceStateByUserId(a),delete this.filteredIds[a][r.Model.EnumFilterState.BLINK])}this.blinkUserIds=null}}applyFilter(e,t){if(this.hasNodeInfo(e)){var i;this.updateNodes(e),this.meshManager.resetInstanceMeshVisible(),this._resetInstanceMaterial(e.isAllMaterialChanged?e.materialManager.instanceMaterials:null,e),e.isAllMaterialChanged=!1,i=t||e.getModelDescriptor().getInstancedUserIds();var r=e.getModelDescriptor().getInstancedNodeInfos();this._collectFilteredUserIds(e,i,r),this._collectFilteredUserIdsForWireFrame(e,i,r),this._collectSelectedUserIds(e.manager.sceneState.selectionSet,r),this._collectBlinkedUserIds(e.manager.sceneState.getBlinkComponentsIdMap(e.id),r),this._collectHoveredUserIds(e.manager.sceneState.hoverId,r),this._updateInstanceMaterial(e)}}applySelection(e){if(this.hasNodeInfo(e)){var t=e.getModelDescriptor().getInstancedNodeInfos();this._clearSelectedState(e),this._clearHoveredState(e),this._collectSelectedUserIds(e.manager.sceneState.selectionSet,t),this._collectHoveredUserIds(e.manager.sceneState.hoverId,t),this._updateInstanceMaterial(e),this.updateNodes(e)}}clearSelection(e){this._clearSelectedState(e),this.applyHover(e)}applyHover(e){if(this.hasNodeInfo(e)){var t=e.getModelDescriptor().getInstancedNodeInfos();this._clearHoveredState(e),this._collectHoveredUserIds(e.manager.sceneState.hoverId,t),this._updateInstanceMaterial(e),this.updateNodes(e)}}clearHover(e){this._clearHoveredState(e),this._updateInstanceMaterial(e),this.updateNodes(e)}applyBlink(e){if(this.hasNodeInfo(e)){var t=e.getModelDescriptor().getInstancedNodeInfos();this._clearBlinkedState(e),this._clearHoveredState(e),this._collectBlinkedUserIds(e.manager.sceneState.getBlinkComponentsIdMap(e.id),t),this._collectHoveredUserIds(e.manager.sceneState.hoverId,t),this._updateInstanceMaterial(e),this.updateNodes(e)}}clearBlink(e){this._clearBlinkedState(e),this.applyHover(e)}applyReplacement(e){this._updateInstanceMaterial(e),this.updateNodes(e)}hasNodeInfo(e){return!!e.getModelDescriptor().getInstancedNodeInfos()}updateNodes(e){this.hasNodeInfo(e)&&(this.meshManager.updateNodes(e),this.wireframeManager.updateNodes(e))}generateWireframe(e,t){this.wireframeManager.generateWireframe(e,t)}createMeshNodes(e,t){this.meshManager.createMeshNodes(e,t)}asyncCreateMeshNodes(e,t,i){this.meshManager.asyncCreateMeshNodes(e,t,i)}clearCachedData(){}getMeshesByUserIds(e,t,i){this.meshManager.getMeshesByUserIds(e,t,i)}clearSelectedObjectIds(){this.meshManager.clearSelectedObjectIds()}adjustVisibility(e,t){this.meshManager.adjustVisibility(e,t),this.wireframeManager.adjustVisibility(e,t)}changeVisibilityOfSelectedObjects(e,t){this.meshManager.changeVisibilityOfSelectedObjects(e,t),this.wireframeManager.changeVisibilityOfSelectedObjects(e,t)}changeVisibilityOfNonSelectedObjects(e,t){this.meshManager.changeVisibilityOfNonSelectedObjects(e,t),this.wireframeManager.changeVisibilityOfNonSelectedObjects(e,t)}restoreVisibilityOfObjects(){this.meshManager.restoreVisibilityOfObjects(),this.wireframeManager.restoreVisibilityOfObjects()}disposeBufferAfterVbo(){this.meshManager.disposeBufferAfterVbo(),this.wireframeManager.disposeBufferAfterVbo()}addAllInstanceNodeToScene(e){this.meshManager.addAllInstanceNodeToScene(e)}getGeometryBuffersByUserId(e,t){return this.meshManager.getGeometryBuffersByUserId(e,t)}explode(e){this.meshManager.explode(e)}calculateClippingIds(e,t,i){this.meshManager.calculateClippingIds(e,t,i)}calculateClippingContours(e,t,i,r,a,n){this.meshManager.calculateClippingContours(e,t,i,r,a,n)}isPickableNode(e){if(!this.filteredIds||!this.filteredIds[e])return!0;var t=this.filteredIds[e],i=r.Model.EnumFilterState;return!t[i.HIDDEN]&&!t[i.TRANSPARENT]}isHiddenNode(e){return!!(this.filteredIds&&this.filteredIds[e]&&this.filteredIds[e][r.Model.EnumFilterState.HIDDEN])}getMeshManager(){return this.meshManager}getWireFrameManager(){return this.wireframeManager}},function(){function e(e,t,i){e.forEach((e=>{!function(e,t,i){const r=e.getAttribute("vState").array;for(let e=0,a=t.length;e<a;++e)r[t[e]]=i;e.getAttribute("vState").needsUpdate=!0}(e.geometry,t,i)}))}function t(e,t,i,r){e.forEach((e=>{!function(e,t,i,r){const a=e.getAttribute("vState").array,n=e.getAttribute("aColor"),s=n?n.array:null;for(let e=0,n=t.length;e<n;++e){const n=t[e];a[n]=i,null!==s&&null!==r&&(s[4*n]=r[0],s[4*n+1]=r[1],s[4*n+2]=r[2],s[4*n+3]=r[3])}e.getAttribute("vState").needsUpdate=!0,n&&(n.needsUpdate=!0)}(e.geometry,t,i,r)}))}function i(e,t,i){e.forEach((e=>{const r=e.geometry.getAttribute("vState");if(r.array.fill(t),r.needsUpdate=!0,i){var a=i[e.material.name];e.material=e.material.transparent?a[1]:a[0]}}))}class a extends r.ModelView.MeshBaseManager{constructor(e,t){super(),this.manager=e,this.instanceGeometryMap={},this.bufferAttributeMap={},this.instanceNodeMap={},this.nodeIdxMapFromUserId={},this.matrixInfoMapFromUserId={},this.cachedInstance={vState:{},vClipping:{},vColor:{},mcol0:{},mcol1:{},mcol2:{},mcol3:{},muvCol0:{},muvCol1:{},muvCol2:{},uv2OffsetRepeat:{},uv2:{}},this.selectedMeshes=[],this.nonSelectedMeshes=[],this.selectedObjectIds=[],this.meshesVisible=!0,this.version=t}destroy(){if(super.destroy(),this.cachedInstance=null,this.instanceNodeMap=null,this.bufferAttributeMap=null,this.nodeIdxMapFromUserId=null,this.matrixInfoMapFromUserId=null,this.disposeInstanceGeometries(),this.instanceGeometryMap=null,this.manager=null,this.selectedMeshes=null,this.nonSelectedMeshes=null,this.selectedObjectIds=null,this.pickingNodeGenerators){for(var e in this.pickingNodeGenerators)this.pickingNodeGenerators.hasOwnProperty(e)&&this.pickingNodeGenerators[e].destroy();this.pickingNodeGenerators=null}}clearData(){if(this.bufferDestroyed=!1,this.disposeGeometries(),this.disposeInstanceGeometries(),this.clearInstanceCache(),this.pickingNodeGenerators)for(var e in this.pickingNodeGenerators)this.pickingNodeGenerators.hasOwnProperty(e)&&this.pickingNodeGenerators[e].clearData()}clearInstanceCache(){this.cachedInstance.vState={},this.cachedInstance.vClipping={},this.cachedInstance.vColor={},this.cachedInstance.mcol0={},this.cachedInstance.mcol1={},this.cachedInstance.mcol2={},this.cachedInstance.mcol3={},this.cachedInstance.muvCol0={},this.cachedInstance.muvCol1={},this.cachedInstance.muvCol2={},this.cachedInstance.uv2OffsetRepeat={},this.cachedInstance.uv2={},this.bufferAttributeMap={},this.nodeIdxMapFromUserId={},this.instanceNodeMap={},this.instanceGeometryMap={},this.matrixInfoMapFromUserId={},this.geometries={}}updateNodes(e){this.meshesVisible=!e.isOnlyWireframe();const t=this._getNodeGroup(e);this.meshesVisible?t._adjustActivated||(t.visible=!0):t.visible=!1}createMeshNodes(e,t){this._collectSharedMeshBufferIds(e),this._createInstanceGeometries(e,t),this._makeInstanceNodes(e)}asyncCreateMeshNodes(e,t,i){if(0===t.length)return void(i&&i());const a=this,n=r.GlobalData.InstanceAsyncProcessingStep;this._collectSharedMeshBufferIds(e),r.Utils.asyncProcess(t,t.length,n,(function(t,i){a._createInstanceGeometries(e,[t[i]])}),(function(){a._makeInstanceNodes(e),i&&i()}))}_createInstanceGeometries(e,t){var i=this;e.getModelDescriptor().traverseInstancedNodeInfos(t,(function(t,r){for(var a=0,n=r.length;a<n;a++){var s=r[a],o=i.getGeometryByNodeInfo(e,s);if(o){var l=e.manager.getOverrideMaterialByNodeInfo(s,e.materialManager.getMaterialById(s.materialId));if(l&&(s.materialId=l.name),e.lightmap&&void 0===s.uv2Info){var d=e.getLoader().getInstanceUV2InfoById(s.itemIdUV2);s.uv2Info=d,s.materialId=s.uv2Info?s.materialId+"_"+s.uv2Info.lightmapIdx:s.materialId}var h=i.getMeshIdByNodeInfo(s),c=i.cacheInstanceAttributeStateBy(e,h,o,s,l);i.cacheNodeIdxByUserId(s.userId,h,c),i.cacheMatrixInfoByUserId(s.userId,h,{matrix:s.matrix,boundingBox:s.boundingBox}),i.cacheInstanceGeometries(h,o,s.uv2Info,e)}}}))}getBufferAttributesBy(e){if(this.bufferAttributeMap[e])return this.bufferAttributeMap[e];var t=this.cachedInstance;let i=Float32Array;r.Compatibility.isUseDoubleMatrixMPKHeader(this.version);var a=new THREE.InstancedBufferAttribute(new Float32Array(t.mcol0[e]),3,!1,1),n=new THREE.InstancedBufferAttribute(new Float32Array(t.mcol1[e]),3,!1,1),s=new THREE.InstancedBufferAttribute(new Float32Array(t.mcol2[e]),3,!1,1),o=new THREE.InstancedBufferAttribute(new i(t.mcol3[e]),3,!1,1),l=[],d=[],h=[];if(t.muvCol0[e])for(var c=0,u=t.muvCol0[e].length;c<u;c++)l.push(new THREE.InstancedBufferAttribute(new Float32Array(t.muvCol0[e][c]),2,!1,1)),d.push(new THREE.InstancedBufferAttribute(new Float32Array(t.muvCol1[e][c]),2,!1,1)),h.push(new THREE.InstancedBufferAttribute(new Float32Array(t.muvCol2[e][c]),2,!1,1));var p=new THREE.InstancedBufferAttribute(new Float32Array(t.uv2OffsetRepeat[e]),4,!1,1);new THREE.BufferAttribute(t.uv2[e],2);return this.bufferAttributeMap[e]={attributeMcol0:a,attributeMcol1:n,attributeMcol2:s,attributeMcol3:o,attributeMuvCol0Array:l,attributeMuvCol1Array:d,attributeMuvCol2Array:h,attributeUv2OffsetRepeat:p},this.bufferAttributeMap[e]}_addInstanceNodeToScene(e,t,i){this._getNodeGroup(e).add(i),i.updateMatrixWorld(!0),e.manager.addMeshToOctantMap(e.getEncodedDatabagId(),t,new r.InstancedCapsuleObject(t,i))}addAllInstanceNodeToScene(e){const t=e.getEncodedDatabagId();this.traverseInstanceNodeMap(null,(function(i,a){const n=a[0],s=a[1];let o,l;for(o=0,l=n.length;o<l;++o)e.manager.addMeshToOctantMap(t,i,new r.InstancedCapsuleObject(i,n[o]));for(o=0,l=s.length;o<l;++o)e.manager.addMeshToOctantMap(t,i,new r.InstancedCapsuleObject(i,s[o]))}))}_getMeshFrom(e,t,i,a,n,s,o){i.setAttribute("mcol0",o.attributeMcol0),i.setAttribute("mcol1",o.attributeMcol1),i.setAttribute("mcol2",o.attributeMcol2);const l=r.GeomUtil.getMatrixFromInstancedBufferAttribute(o.attributeMcol3);i.setAttribute("mcol3",o.attributeMcol3),o.attributeMuvCol0Array.length>0&&(i.setAttribute("muvCol0",o.attributeMuvCol0Array[a]),i.setAttribute("muvCol1",o.attributeMuvCol1Array[a]),i.setAttribute("muvCol2",o.attributeMuvCol2Array[a])),e.lightmap&&i.setAttribute("uv2OffsetRepeat",o.attributeUv2OffsetRepeat),i.setAttribute("aColor",new THREE.InstancedBufferAttribute(new Float32Array(s.vColor[t]),4,!1,1)),i.setAttribute("vState",new THREE.InstancedBufferAttribute(new Float32Array(s.vState[t]),1,!1,1)),i.setAttribute("vClipping",new THREE.InstancedBufferAttribute(new Float32Array(s.vClipping[t]),1,!1,1));i.getAttribute("vClipping").array.fill(e.localClippingMode?r.EnumInstanceState.CLIPPING:r.EnumInstanceState.NONE);const d=new r.MeshEx(i,n);return d.databagId=e.databagId,d.fileId=e.fileId,d.frustumCulled=!1,l&&(d.matrix.copy(l),d.matrixAutoUpdate=!1,d.updateMatrixWorld(!0)),r.GlobalData.EnableShadowMap&&(d.customDepthMaterial=e.manager.getInstanceDepthMaterial(),d.castShadow=e.castShadow,d.receiveShadow=e.receiveShadow),d}_cloneMeshFrom(e,t){const i=e.geometry,a=new THREE.InstancedBufferGeometry;a.setAttribute("position",i.getAttribute("position")),a.setAttribute("normal",i.getAttribute("normal")),i.getAttribute("uv")&&a.setAttribute("uv",i.getAttribute("uv")),i.getAttribute("uv2")&&a.setAttribute("uv2",i.getAttribute("uv2")),a.setAttribute("mcol0",i.getAttribute("mcol0")),a.setAttribute("mcol1",i.getAttribute("mcol1")),a.setAttribute("mcol2",i.getAttribute("mcol2")),a.setAttribute("mcol3",i.getAttribute("mcol3")),a.setAttribute("mcol0",i.getAttribute("mcol0")),a.setAttribute("mcol1",i.getAttribute("mcol1")),a.setAttribute("mcol2",i.getAttribute("mcol2")),a.setAttribute("mcol3",i.getAttribute("mcol3")),i.getAttribute("muvCol0")&&(a.setAttribute("muvCol0",i.getAttribute("muvCol0")),a.setAttribute("muvCol1",i.getAttribute("muvCol1")),a.setAttribute("muvCol2",i.getAttribute("muvCol2"))),i.getAttribute("uv2OffsetRepeat")&&a.setAttribute("uv2OffsetRepeat",i.getAttribute("uv2OffsetRepeat")),a.setAttribute("aColor",i.getAttribute("aColor")),a.setAttribute("vClipping",i.getAttribute("vClipping")),a.setAttribute("vState",i.getAttribute("vState").clone()),a.setIndex(i.getIndex());const n=new r.MeshEx(a,t);return n.databagId=e.databagId,n.fileId=e.fileId,n.frustumCulled=e.frustumCulled,e.customDepthMaterial&&(n.customDepthMaterial=e.customDepthMaterial,n.castShadow=e.castShadow,n.receiveShadow=e.receiveShadow),e.matrix&&(n.matrix=e.matrix,n.matrixAutoUpdate=!1,n.updateMatrixWorld()),n}_makeInstanceNodeById(e,t,a){const n=e.materialManager,s=this.getMaterialIdByMeshId(t),o=n.getInstanceMaterialById(s,e);if(2!==o.length)return void console.log("instance material error!");const l=this.cachedInstance,d=this.getBufferAttributesBy(t),h=o[0],c=o[1],u=[],p=[];let m,f=a.length;for(m=0;m<f;m++){const i=this._getMeshFrom(e,t,a[m],m,h,l,d);u.push(i),1==c._primary&&(i.visible=!1),this._addInstanceNodeToScene(e,t,i)}for(m=0;m<f;m++){const i=this._cloneMeshFrom(u[m],c);p.push(i),1==h._primary&&(i.visible=!1),this._addInstanceNodeToScene(e,t,i)}const g=h._primary,v=r.EnumInstanceState.NONE,y=r.EnumInstanceState.HIDDEN;i(u,g?v:y),i(p,g?y:v),this.instanceNodeMap[t]=[u,p]}_makeInstanceNodes(e){var t=this;this.traverseInstanceGeometryMap((function(i,r){t._makeInstanceNodeById(e,i,r)}))}resetInstanceMaterial(e){const t=r.EnumInstanceState.NONE,a=r.EnumInstanceState.HIDDEN;this.traverseInstanceNodeMap(null,(function(r,n){const s=n[0],o=n[1],l=!!s[0].material._primary;i(s,l?t:a,e),i(o,l?a:t,e)}))}resetInstanceMeshVisible(){this.traverseInstanceNodeMap(null,((e,t)=>{const i=t[0],r=t[1];i.forEach((e=>{!0!==e.material._primary&&(e.visible=!1)})),r.forEach((e=>{!0!==e.material._primary&&(e.visible=!1)}))}))}clearInstanceStateByUserId(t){const i=this,a=r.EnumInstanceState.NONE,n=r.EnumInstanceState.HIDDEN;this.traverseNodeIdxMapByUserId(t,(function(t,r){const s=i.getInstanceNodesById(t),o=s[0],l=s[1],d=!!o[0].material._primary;e(o,r,d?a:n),e(l,r,d?n:a)}))}updateInstanceStateByUserId(i,a,n,s){const o=i.materialManager,l=this;this.traverseNodeIdxMapByUserId(a,(function(d,h){const c=l.getInstanceNodesById(d);if(!c)return;const u=c[0],p=c[1];u.forEach((e=>{e.visible=!0})),p.forEach((e=>{e.visible=!0}));const m=l.getMaterialIdByMeshId(d),f=o.getInstanceMaterialById(m,i),g=f[0],v=f[1],y=!!g._primary,M=l.getOriginalMaterialIdByMeshId(d),E=l.getUsableMaterialColorParamsBy(i,M,n,s),b=E.rgbaColor;let I=n,x=r.EnumInstanceState.HIDDEN;if(n===r.EnumInstanceState.TRANSPARENT&&(I=r.EnumInstanceState.OVERRIDED),n===r.EnumInstanceState.SELECTED&&l.cacheSelectedObjectIds(a,d),I===r.EnumInstanceState.BLINK){const e=i.manager.blinkManager.getBlinkColor(i.id);if(Object.keys(i.getModelManager().sceneState.blinkComponentIdsDetailMap).length>0){const e=i.getModelManager().sceneState.getBlinkComponentsColor(i.id,a);let t=t=>{let i=t.geometry.getAttribute("bColor");t.geometry.getAttribute("bColor")||(i=t.geometry.attributes.aColor.clone(),t.geometry.setAttribute("bColor",i));for(let t=0,r=h.length;t<r;++t){const r=h[t];i.array[4*r]=e.x,i.array[4*r+1]=e.y,i.array[4*r+2]=e.z,i.array[4*r+3]=e.w}t.geometry.getAttribute("bColor").needsUpdate=!0};u.map((e=>{t(e)})),p.map((e=>{t(e)})),g.useMultiBlinkColor=!0,v.useMultiBlinkColor=!0}else g.setBlinkColor(e),v.setBlinkColor(e)}if(I===r.EnumInstanceState.OVERRIDED&&(v.isOverrideOpacity=E.transparent),y){const i=g.transparent===E.transparent;t(u,h,i?I:x,b),e(p,h,i?x:I)}else{const i=v.transparent===E.transparent;t(p,h,i?I:x,b),e(u,h,i?x:I)}}))}updateInstanceClippingByUserId(e){function t(e,t){for(var i=e.getAttribute("vClipping").array,a=0;a<t.length;++a){i[t[a]]=r.EnumInstanceState.CLIPPING}e.getAttribute("vClipping").needsUpdate=!0}var i=this;this.traverseNodeIdxMapByUserId(e,(function(e,r){var a=i.getInstanceGeometries(e);if(a)for(var n=0,s=a.length;n<s;n++)t(a[n],r)}))}updateInstanceClipping(e){var t=this,i=e?r.EnumInstanceState.CLIPPING:r.EnumInstanceState.NONE;this.traverseNodeIdxMap((function(e,r){var a=t.getInstanceNodesById(e),n=a[0],s=a[1];n.forEach((e=>{const t=e.geometry.getAttribute("vClipping").array;for(let e=0,a=r.length;e<a;++e)t[r[e]]=i;e.geometry.getAttribute("vClipping").needsUpdate=!0})),s.forEach((e=>{const t=e.geometry.getAttribute("vClipping").array;for(let e=0,a=r.length;e<a;++e)t[r[e]]=i;e.geometry.getAttribute("vClipping").needsUpdate=!0}))}))}getUsableMaterialColorParamsBy(e,t,i,a){var n,s,o=e.selectedMaterial,l=e.getFilter()._getMaterialByName("scene"),d=e.materialManager,h=e.manager.getOverrideMaterialByName(t)||d.getMaterialById(t);switch(i){case r.EnumInstanceState.HOVER:a?(n=e.getFilter()._getMaterialByName(a),s=e.manager.sceneState.getHoverColorByMaterial(n)):s=e.manager.sceneState.getHoverColorByMaterial(h);break;case r.EnumInstanceState.SELECTED:s=r.MaterialUtil.getColorParamsByMaterial(o);break;case r.EnumInstanceState.TRANSPARENT:s=r.MaterialUtil.getColorParamsByMaterial(l);break;case r.EnumInstanceState.OVERRIDED:case r.EnumInstanceState.BLINK:a?(n=e.getFilter()._getMaterialByName(a),s=r.MaterialUtil.getColorParamsByMaterial(n)):s=r.MaterialUtil.getColorParamsByMaterial(h);break;default:s=r.MaterialUtil.getColorParamsByMaterial(h)}return s}getInstanceNodesById(e){return this.instanceNodeMap[e]}traverseInstanceNodeMap(e,t){for(var i=this.instanceNodeMap,r=0,a=(e=e||Object.keys(this.instanceNodeMap)).length;r<a;r++){var n=e[r];t(n,i[n])}}getInstanceGeometries(e){return this.instanceGeometryMap[e]}cacheInstanceGeometries(e,t,i,r){if(!this.instanceGeometryMap[e]){var a=this.instanceGeometryMap[e]=[];t instanceof Array||(t=[t]);for(var n=i?i.byteOffset:0,s=0,o=t.length;s<o;++s)if(a[s]=new THREE.InstancedBufferGeometry,a[s].setIndex(t[s].index),a[s].setAttribute("position",t[s].attributes.position),a[s].setAttribute("normal",t[s].attributes.normal),t[s].attributes.uv&&a[s].setAttribute("uv",t[s].attributes.uv),t[s].attributes.uv2)a[s].setAttribute("uv2",t[s].attributes.uv2);else if(i){var l=2*t[s].index.count,d=r.getLoader().getInstanceUV2ById(n,l);a[s].setAttribute("uv2",new THREE.Float32BufferAttribute(d,2)),n+=2*l}}}traverseInstanceGeometryMap(e){var t=this.instanceGeometryMap;for(var i in t)e(i,t[i])}disposeInstanceGeometries(){this.traverseInstanceGeometryMap((function(e,t){for(var i=0,r=t.length;i<r;i++)t[i].dispose()}))}cacheInstanceAttributeStateBy(e,t,i,a,n){var s=a.uv2Info?r.Utils.splitCombinedKeyString(a.materialId,"_")[0]:a.materialId,o=a.uvArrayBuffer;i instanceof Array||(i=[i]);var l=i.length,d=this.cachedInstance;if(!d.vState[t]){d.vState[t]=[],d.vClipping[t]=[],d.vColor[t]=[],d.mcol0[t]=[],d.mcol1[t]=[],d.mcol2[t]=[],d.mcol3[t]=[],d.muvCol0[t]=[],d.muvCol1[t]=[],d.muvCol2[t]=[];for(var h=0;h<l;++h)d.muvCol0[t][h]=[],d.muvCol1[t][h]=[],d.muvCol2[t][h]=[];a.uv2Info&&(d.uv2OffsetRepeat[t]=[])}var c=n||e.materialManager.getMaterialById(s);d.vColor[t].push(c.color.r,c.color.g,c.color.b,c.opacity),d.vState[t].push(0),d.vClipping[t].push(0);var u=a.matrix.elements;if(d.mcol0[t].push(u[0],u[1],u[2]),d.mcol1[t].push(u[4],u[5],u[6]),d.mcol2[t].push(u[8],u[9],u[10]),d.mcol3[t].push(u[12],u[13],u[14]),a.uv2Info){var p=a.uv2Info.offsetRepeat;d.uv2OffsetRepeat[t].push(p[0],p[1],p[2],p[3])}if(o)for(h=0;h<l;++h)d.muvCol0[t][h].push(o[6*h],o[6*h+1]),d.muvCol1[t][h].push(o[6*h+2],o[6*h+3]),d.muvCol2[t][h].push(o[6*h+4],o[6*h+5]);else for(h=0;h<l;++h)d.muvCol0[t][h].push(1,0),d.muvCol1[t][h].push(0,1),d.muvCol2[t][h].push(0,0);return d.vState[t].length-1}cacheNodeIdxByUserId(e,t,i){var r=this.nodeIdxMapFromUserId;r[e]||(r[e]={}),r[e][t]||(r[e][t]=[]),r[e][t].push(i)}getNodeIdxMapByUserId(e){return this.nodeIdxMapFromUserId[e]}traverseNodeIdxMapByUserId(e,t){var i=this.nodeIdxMapFromUserId[e];for(var r in i)t(r,i[r])}traverseNodeIdxMap(e,t){for(var i=Object.keys(this.nodeIdxMapFromUserId),r=0,a=i.length;r<a;r++){var n=i[r],s=this.nodeIdxMapFromUserId[n];if(!t||!t(n))for(var o in s)e(o,s[o])}}cacheMatrixInfoByUserId(e,t,i){var r=this.matrixInfoMapFromUserId;r[e]||(r[e]={}),r[e][t]||(r[e][t]=[]),r[e][t].push(i)}traverseMatrixInfoMapByUserId(e,t){var i=this.matrixInfoMapFromUserId[e];for(var r in i)t(r,i[r])}getMeshesByUserId(e,t){const i=this,r=e.getLengthUnitsMatrix();this.traverseMatrixInfoMapByUserId(t,(function(a,n){const s=i.getInstanceNodesById(a)[0];for(let i=0,a=n.length;i<a;i++)for(let a=0,o=s.length;a<o;a++){const l=n[i].matrix,d=s[a];let h;1===o?h=n[i].boundingBox:(h=d.geometry.boundingBox,h?h=h.clone():(d.geometry.computeBoundingBox(),h=d.geometry.boundingBox.clone()),h.applyMatrix4(l)),e.minDistanceObjects[t].push({mesh:s[a],matrix:l,unitsMatrix:r,boundingBox:h})}}))}_getNodeGroup(e){return e._getNodeGroup(r.ObjectGroupType.INSTANCEGEOMETRY,{globalSpace:!0})}_hasNodeGroup(e){return e._hasNodeGroup(r.ObjectGroupType.INSTANCEGEOMETRY)}clearSelectedObjectIds(){this.selectedObjectIds.length=0}cacheSelectedObjectIds(e,t){this.selectedObjectIds.push({uid:e,mgId:t})}adjustVisibility(e,t){if(!this.meshesVisible)return;const i=this._getNodeGroup(e);i._adjustActivated=!t,i.visible!==t&&(i.visible=t)}changeVisibilityOfSelectedObjects(e,t){function i(e,t){for(let i=0,a=e.length;i<a;i++){const a=e[i],n=[],s=a.geometry.getAttribute("vState").array;for(let e=0,t=s.length;e<t;e++)s[e]===r.EnumInstanceState.SELECTED&&(n.push({idx:e,state:s[e]}),s[e]=r.EnumInstanceState.HIDDEN);n.length?(a.geometry.getAttribute("vState").needsUpdate=!0,t.push({object:a,indices:n})):(t.push({object:a,indices:null,visibility:a.visible}),a.visible=!1)}}let a;if(t){a=this.selectedMeshes;for(let e=0,t=a.length;e<t;e++){const t=a[e].object,i=a[e].indices;if(i){if(i.length){const e=t.geometry.getAttribute("vState").array;for(var n=0,s=i.length;n<s;n++)i[n].state&&(e[i[n].idx]=i[n].state);t.geometry.getAttribute("vState").needsUpdate=!0}}else t.visible=a[e].visibility}}else{this.selectedMeshes.length=0,a=this.selectedMeshes;let e={};for(var o=0,l=this.selectedObjectIds.length;o<l;o++)e[this.selectedObjectIds[o].mgId]=!0;const t=Object.keys(e);this.traverseInstanceNodeMap(t,(function(e,t){const r=t[0],n=t[1];i(r,a),i(n,a)}))}}changeVisibilityOfNonSelectedObjects(e,t){function i(e,t,i){if(i)for(let i=0,a=e.length;i<a;i++){const a=e[i],n=[],s=a.geometry.getAttribute("vState").array;for(let e=0,t=s.length;e<t;e++)s[e]!==r.EnumInstanceState.SELECTED&&s[e]!==r.EnumInstanceState.HIDDEN&&(n.push({idx:e,state:s[e]}),s[e]=r.EnumInstanceState.HIDDEN);n.length?(a.geometry.getAttribute("vState").needsUpdate=!0,t.push({object:a,indices:n})):(t.push({object:a,indices:null,visibility:a.visible}),a.visible=!1)}else for(let i=0,r=e.length;i<r;i++){var a=e[i];t.push({object:a,indices:null,visibility:a.visible}),a.visible=!1}}let a;if(t){a=this.nonSelectedMeshes;for(let e=0,t=a.length;e<t;e++){const t=a[e].object,i=a[e].indices;if(i){if(i.length){const e=t.geometry.getAttribute("vState").array;for(let t=0,r=i.length;t<r;t++)i[t].state&&(e[i[t].idx]=i[t].state);t.geometry.getAttribute("vState").needsUpdate=!0}}else t.visible=a[e].visibility}}else{this.nonSelectedMeshes.length=0,a=this.nonSelectedMeshes;let e={};for(var n=0,s=this.selectedObjectIds.length;n<s;n++)e[this.selectedObjectIds[n].mgId]=!0;this.traverseInstanceNodeMap(null,(function(t,r){const n=r[0],s=r[1],o=e[t];i(n,a,o),i(s,a,o)}))}}restoreVisibilityOfObjects(){this.selectedMeshes.length=0,this.nonSelectedMeshes.length=0}getMeshIdByNodeInfo(e){return e.uv2Info?r.Utils.getCombinedKeyString([e.materialId,e.geometryIdCode,e.uv2Info.byteOffset]):r.Utils.getCombinedKeyString([e.materialId,e.geometryIdCode])}getMaterialIdByMeshId(e){return r.Utils.splitCombinedKeyString(e)[0]}getOriginalMaterialIdByMeshId(e){var t=r.Utils.splitCombinedKeyString(e);return r.Utils.splitCombinedKeyString(t[0],"_")[0]}disposeBufferAfterVbo(){var e;this.bufferDestroyed||(this.bufferDestroyed=!0,r.GlobalData.PickingEffect?e=["muvCol0","muvCol1","muvCol2","uv2OffsetRepeat"]:(e=["muvCol0","muvCol1","muvCol2","uv2OffsetRepeat","mcol0","mcol1","mcol2","mcol3"],r.GlobalData.EnableExplosion&&e.pop()),this.traverseInstanceGeometryMap((function(t,i){for(var a=0,n=i.length;a<n;a++)r.GeomUtil.disposeBufferFromGeometry(i[a],e)})))}getGeometryBuffersByUserId(e,t){var i=e.getModelDescriptor().getInstancedNodeInfosById(t);if(!i)return[];for(var a=[],n=e.getDatabagId(),s=r.ModelView.BaseDescriptor.EnumNodeItemType,o=0,l=i.length;o<l;o++){var d,h=i[o];switch(h.type){case s.BOX_M:d=r.GeomUtil.getBoxBufferGeometryWithUvMatrices(h.uvArrayBuffer);break;case s.PIPE_M:d=r.GeomUtil.getPipeBufferGeometryWithUvMatrices(h.uvArrayBuffer);break;default:d=this.getGeometryByNodeInfo(e,h)}var c=r.ModelView.BaseDescriptor.isLineNode(h);if(d instanceof Array)for(var u=0,p=d.length;u<p;u++){var m=d[u].getAttribute("uv");a.push({isLines:c,databagId:n,nodeId:h.nodeId,position:d[u].getAttribute("position").array,index:d[u].getIndex().array,matrix:h.matrix,uv:m?m.array:null})}else{m=d.getAttribute("uv");a.push({isLines:c,databagId:n,nodeId:h.nodeId,position:d.getAttribute("position").array,index:d.getIndex().array,matrix:h.matrix,uv:m?m.array:null})}}return a}explode(e){function t(e,t,i){for(var r=e.getAttribute("mcol3").array,a=0;a<t.length;++a){var n=t[a];r[3*n]+=i.x,r[3*n+1]+=i.y,r[3*n+2]+=i.z}e.getAttribute("mcol3").needsUpdate=!0}var i=this;for(var r in i.nodeIdxMapFromUserId)i.traverseNodeIdxMapByUserId(r,(function(a,n){var s=e.modelExplosion.getExplosionTranslation(r),o=i.getInstanceGeometries(a);o&&t(o[0],n,s)}))}getPickingNodeGenerator(e){return e=null==e?"pick":e,this.pickingNodeGenerators||(this.pickingNodeGenerators={}),this.pickingNodeGenerators[e]||(this.pickingNodeGenerators[e]=new r.PickingInstancedMeshGenerator(this),this.pickingNodeGenerators[e].reserveMaterial=!!e.startsWith("glow")),this.pickingNodeGenerators[e]}_traverseIntersectNode(e,t,i){for(let a in this.nodeIdxMapFromUserId)this.manager.isHiddenNode(a)||this.traverseMatrixInfoMapByUserId(a,((n,s)=>{const o=this.getInstanceNodesById(n)[0];for(let n=0,l=s.length;n<l;n++)for(let l=0,d=o.length;l<d;l++)r.GeomUtil.boxIntersectsPlaneWithMatrix(e,s[n].boundingBox,t)&&i&&i(a,o[l],s[n])}))}_traverseIntersectNodeLimit(e,t,i){for(let a in this.nodeIdxMapFromUserId)this.manager.isHiddenNode(a)||this.traverseMatrixInfoMapByUserId(a,((n,s)=>{const o=this.getInstanceNodesById(n)[0];for(let n=0,l=s.length;n<l;n++)for(let l=0,d=o.length;l<d;l++){const d=o[l].matrixWorld.clone().setPosition(0,0,0);r.GeomUtil.boxIntersectsPlaneWithMatrix(e,s[n].boundingBox,d)&&o[l].intersectBoxWithPlaneMesh(t,s[n])&&i&&i(a,o[l],s[n])}}))}calculateClippingIds(e,t,i){let a=i.getFilter().getLocalClippingList(),n=i.manager.viewer.getRenderer().localClippingEnabled&&Object.keys(a).length>0;const s=i.manager.getScene().getMatrixGlobal().clone(),o=i.manager.getModelLengthUnitsMatrix(i),l=o?s.multiply(o):s;this._traverseIntersectNode(e,l,((i,s,o)=>{if(!n||n&&a[i]){let i=[];s.getIntersectionPoints(e,o,i,!0),t.push.apply(t,r.GeomUtil.applyMatrix4ToList(i,s.matrix))}}))}calculateClippingContours(e,t,i,r,a,n){this._traverseIntersectNodeLimit(t,i,((i,s,o)=>{if(-1===a.indexOf(i))return;let l=[];if(s.getIntersectionContours(t,o,l,!0),0===l.length)return;let d=[];const h=s.material.color,c={red:parseInt(255*h.r),green:parseInt(255*h.g),blue:parseInt(255*h.b)};l.map((e=>{let t=[];e.map((e=>{r.containsPoint(e)&&t.push(e)})),t.length>0&&d.push(t)})),void 0===n[e][i]?n[e][i]={clippingContours:[d],colors:[c]}:(n[e][i].clippingContours.push(d),n[e][i].colors.push(c))}))}_createGeometryByNodeInfo(e,t){if(r.ModelView.BaseDescriptor.isParameterizedNode(t))return this._createGeometry(t.type,t.geometryIdCode,t.fromMirror,null,e.lightmap);const i=void 0!==t.bufferId?t.bufferId:t.geometryId;let a=e.getModelDescriptor().getReferencedMeshBufferById(i);if(!a)return null;if(a.IndexInfos){let i={buffer:a,indexInfo:a.IndexInfos[t.indexInfoIdx]};return this._createNodeBufferByMpkBufferData(e,t,i)}return this._createGeometry(t.type,t.geometryIdCode,t.fromMirror,a,e.lightmap)}_collectSharedMeshBufferIds(e){const t=e.getModelDescriptor().getInstancedNodeInfosOnGeometryId();let i=!1;for(let e in t)if(!r.ModelView.BaseDescriptor.isParameterizedNodeType(e)){i=!0;break}if(!i)return;const a=e.getModelDescriptor().getReferencedMeshBufferData();Object.keys(a).forEach((e=>{const i=a[e].IndexInfos;if(i)for(let r=0,a=i.length;r<a;r++){const a=t[i[r].meshId];a&&a.length&&a.forEach((t=>{t.bufferId=e,t.indexInfoIdx=r}))}}))}_createNodeBufferByMpkBufferData(e,t,i){let r=this.createBufferForSharedMeshByBufferDataWithUV2(e,t,i,!1);if(!r)return null;let a=new THREE.BufferGeometry;return a.setIndex(new THREE.BufferAttribute(new Uint32Array(r.index),1)),a.setAttribute("position",new THREE.BufferAttribute(new Float32Array(r.position),3)),r.normal&&a.setAttribute("normal",new THREE.BufferAttribute(new Float32Array(r.normal),3)),r.uv&&a.setAttribute("uv",new THREE.BufferAttribute(new Float32Array(r.uv),2)),r.uv2&&a.setAttribute("uv2",new THREE.BufferAttribute(new Float32Array(r.uv2),2)),e.lightmap&&void 0!==t.itemIdUV2&&(t.geometryIdCode=t.geometryIdCode+"_"+t.itemIdUV2),this._cacheGeometry(t.geometryIdCode,a),a}}r.ModelView.InstancedMeshManager=a}(),r.ModelView.InstancedWireframeManager=class{constructor(e){this.manager=e,this.wireframeGeometryMap={},this.noNeedWireframingIdMap={},this.generated=!1,this.meshesVisible=!0}destroy(){if(this.disposeGeometries(),this.wireframeGeometryMap=null,this.noNeedWireframingIdMap=null,this.manager=null,this.pickingNodeGenerators){for(var e in this.pickingNodeGenerators)this.pickingNodeGenerators.hasOwnProperty(e)&&this.pickingNodeGenerators[e].destroy();this.pickingNodeGenerators=null}}clearData(){if(this.generated=!1,this.bufferDestroyed=!1,this.disposeGeometries(),this.wireframeGeometryMap={},this.noNeedWireframingIdMap={},this.pickingNodeGenerators)for(var e in this.pickingNodeGenerators)this.pickingNodeGenerators.hasOwnProperty(e)&&this.pickingNodeGenerators[e].clearData()}disposeGeometries(){this._traverseWireframeGeometryMap((function(e,t){for(var i=0,r=t.length;i<r;i++)t[i].dispose()}))}updateNodes(e){this.meshesVisible=e.isActivateWireframe();const t=this._getNodeGroup(e);this.meshesVisible?t._adjustActivated||(t.updateMatrixWorld(!0),t.visible=!0):t.visible=!1}resetInstanceMaterial(e){var t=r.EnumInstanceState.NONE,i=e.localClippingMode?r.EnumInstanceState.CLIPPING:r.EnumInstanceState.NONE;this._traverseWireframeGeometryMap((function(e,r){for(var a=0,n=r.length;a<n;++a){for(var s=r[a].getAttribute("vState").array,o=r[a].getAttribute("vClipping").array,l=0,d=s.length;l<d;l++)s[l]=t,o[l]=i;r[a].getAttribute("vState").needsUpdate=!0,r[a].getAttribute("vClipping").needsUpdate=!0}})),this._updateNoWireframingState()}updateInstanceWireframeByUserId(e,t,i,a){if(i===r.EnumInstanceState.HIDDEN||i===r.EnumInstanceState.NONE||i===r.EnumInstanceState.OVERRIDED){if(!this._isNeedWireframing(t))return;var n;if(a){var s=e.getFilter()._getMaterialByName(a),o=r.MaterialUtil.getColorParamsByMaterial(s);n=o.rgbaColor}var l=this;this.manager.traverseNodeIdxMapByUserId(t,(function(e,t){l._setInstanceWireframeState(e,t,i,n)}))}}updateInstanceWireframeClippingByUserId(e){var t=this;this.manager.traverseNodeIdxMapByUserId(e,(function(e,i){var a=t._getWireframeGeometryById(e);if(a)for(var n=0,s=a.length;n<s;++n){for(var o=a[n].getAttribute("vClipping").array,l=0,d=i.length;l<d;++l)o[i[l]]=r.EnumInstanceState.CLIPPING;a[n].getAttribute("vClipping").needsUpdate=!0}}))}updateInstanceWireframeClipping(e){var t=this,i=e?r.EnumInstanceState.CLIPPING:r.EnumInstanceState.NONE;this.manager.traverseNodeIdxMap((function(e,r){var a=t._getWireframeGeometryById(e);if(a)for(var n=0,s=a.length;n<s;++n){for(var o=a[n].getAttribute("vClipping").array,l=0,d=r.length;l<d;++l)o[r[l]]=i;a[n].getAttribute("vClipping").needsUpdate=!0}}))}_updateNoWireframingState(){var e=this,t=r.EnumInstanceState.HIDDEN;this.manager.traverseNodeIdxMap((function(i,r){e._setInstanceWireframeState(i,r,t)}),(function(t){return e._isNeedWireframing(t)}))}_setInstanceWireframeState(e,t,i,r){var a=this._getWireframeGeometryById(e);if(a)for(var n=0,s=a.length;n<s;++n){var o=a[n].getAttribute("vState").array,l=null,d=null;r&&(d=(l=a[n].getAttribute("aColor"))?l.array:null);for(var h=0,c=t.length;h<c;++h){var u=t[h];o[u]=i,null!==d&&(d[4*u]=r[0],d[4*u+1]=r[1],d[4*u+2]=r[2],d[4*u+3]=r[3])}a[n].getAttribute("vState").needsUpdate=!0,l&&(l.needsUpdate=!0)}}_generateInstanceWireframe(e){this._collectNoWireframingIds(e),this._createInstanceWireframeGeometries(),this._makeInstanceWireframe(e),this._updateNoWireframingState()}generateWireframe(e){this.generated||(this._generateInstanceWireframe(e),this.generated=!0)}_collectNoWireframingIds(e){var t=this,i=e.getFilter();e.getModelDescriptor().traverseInstancedNodeInfos(null,(function(e,r){r&&i.getWireFrameVisibilityCondition()?i._isRenderWithWireFrame(r[0])||(t.noNeedWireframingIdMap[e]=!0):r&&i._hasRenderWithBoardlineFilter()&&!i._isRenderWithBoardline(r[0])&&(t.noNeedWireframingIdMap[e]=!0)}))}_createInstanceWireframeGeometries(){var e=this,t={};this.manager.traverseInstanceGeometryMap((function(i,r){for(var a=e._getWireframeBufferById(i,r,t),n=e.wireframeGeometryMap[i]=[],s=0,o=a.length;s<o;s++){var l=new THREE.InstancedBufferGeometry;l.setIndex(a[s].index),l.setAttribute("position",a[s].position),n.push(l)}})),t=null}_makeInstanceWireframe(e){var t=this,i=this.manager,a=i.getCachedInstanceData(),n=this._getWireframeMaterial(e),s=e.localClippingMode?r.EnumInstanceState.CLIPPING:r.EnumInstanceState.NONE;this._traverseWireframeGeometryMap((function(o,l){for(var d=i.getBufferAttributesBy(o),h=0,c=l.length;h<c;h++){l[h].setAttribute("vState",new THREE.InstancedBufferAttribute(new Float32Array(a.vState[o]),1,!1,1)),l[h].setAttribute("vClipping",new THREE.InstancedBufferAttribute(new Float32Array(a.vClipping[o]),1,!1,1)),l[h].setAttribute("mcol0",d.attributeMcol0),l[h].setAttribute("mcol1",d.attributeMcol1),l[h].setAttribute("mcol2",d.attributeMcol2);const i=r.GeomUtil.getMatrixFromInstancedBufferAttribute(d.attributeMcol3);l[h].setAttribute("mcol3",d.attributeMcol3),l[h].getAttribute("vClipping").array.fill(s),t._setDefaultColorAttribute(e,l[h],a.vState[o].length);var u=new THREE.LineSegments(l[h],n);u.frustumCulled=!1,i&&(u.matrix.copy(i),u.matrixAutoUpdate=!1,u.updateMatrixWorld(!0)),t._addWireframeNodeToScene(e,u)}}))}_setDefaultColorAttribute(e,t,i){for(var r=this._getWireframeMaterial(e),a=[],n=0;n<i;n++)a.push(r.color.r,r.color.g,r.color.b,r.opacity);t.setAttribute("aColor",new THREE.InstancedBufferAttribute(new Float32Array(a),4,!1,1))}_addWireframeNodeToScene(e,t){this._getNodeGroup(e).add(t),t.updateMatrixWorld(!0)}_isNeedWireframing(e){return!this.noNeedWireframingIdMap||!this.noNeedWireframingIdMap[e]}_getWireframeMaterial(e){return e.getInstanceWireframeMaterial()}_getWireframeBufferById(e,t,i){var a=this.getGeometryIdByMeshId(e);if(i[a])return i[a];i[a]=[];for(var n=0,s=t.length;n<s;n++){var o=t[n];i[a].push({index:r.BuildEdge(o.attributes.position.array,o.index.array),position:o.attributes.position})}return i[a]}_getWireframeGeometryById(e){return this.wireframeGeometryMap[e]}_traverseWireframeGeometryMap(e){var t=this.wireframeGeometryMap;for(var i in t)e(i,t[i])}_getNodeGroup(e){return e._getNodeGroup(r.ObjectGroupType.INSTANCEWIREFRAMEGEOMETRY,{globalSpace:!0})}_hasNodeGroup(e){return e._hasNodeGroup(r.ObjectGroupType.INSTANCEWIREFRAMEGEOMETRY)}getGeometryIdByMeshId(e){return r.Utils.splitCombinedKeyString(e)[1]}adjustVisibility(e,t){if(!this.meshesVisible)return;const i=this._getNodeGroup(e);i._adjustActivated=!t,i.visible!==t&&(i.visible=t)}changeVisibilityOfSelectedObjects(e,t){}changeVisibilityOfNonSelectedObjects(e,t){this.adjustVisibility(e,t)}restoreVisibilityOfObjects(){}disposeBufferAfterVbo(){if(this.generated&&!this.bufferDestroyed){this.bufferDestroyed=!0;var e=["mcol0","mcol1","mcol2","mcol3"];r.GlobalData.EnableExplosion&&e.pop(),this._traverseWireframeGeometryMap((function(t,i){for(var a=0,n=i.length;a<n;a++)r.GeomUtil.disposeBufferFromGeometry(i[a],e)}))}}getPickingNodeGenerator(e){return e=null==e?"pick":e,this.pickingNodeGenerators||(this.pickingNodeGenerators={}),this.pickingNodeGenerators[e]||(this.pickingNodeGenerators[e]=new r.PickingInstancedWireFrameGenerator(this)),this.pickingNodeGenerators[e]}},function(){class e extends r.ModelView.InstancedBaseManager{constructor(e){super(),this.meshManager=new r.ModelView.InstancedMeshManager(this,e),this.wireframeManager=new r.ModelView.InstancedWireframeManager(this,e)}}r.ModelView.InstancedManager=e}(),function(){class e extends r.ModelView.ModelBaseHandler{constructor(e){super(e),this.tag="default",this.defaultManager=null,this.instancedManager=null,this.loader=null}prepare(e,t){if(this.isLoaded()&&!this.isHidden()){this.prepareWireframe(this.model,t);var i=this.model.getMaterialManager().lastTextureEnabled;this.model.getMaterialManager()._updateTextureMapping(this.model,t),!this.model.lightmap||this.model.enableLightmap==r.GlobalData.EnableLightmap&&this.model.lightmapIntensity==r.GlobalData.LightmapIntensity&&i==r.GlobalData.EnableTextureMapping||(this.model.enableLightmap=r.GlobalData.EnableLightmap,this.model.lightmapIntensity=r.GlobalData.LightmapIntensity,this.rebuildIndicesforLightmap(),this.updateNodes())}}settleData(e){this.model.getModelDescriptor().classifyAllNodeInfo(),this.addNodeInfoToOctantMap(),this.createMeshNodes(e)}addNodeInfoToOctantMap(){var e=this.model.manager,t=this.model.getEncodedDatabagId();this.loader.getDescriptor().traverseNodeInfosByCell((function(i,r){e.addNodeInfoToOctantMap(t,i,r)}))}createMeshNodes(e){var t=this,i=this.model,r=this.loader.getDescriptor();this.instancedManager.createMeshNodes(i,r.getInstancedUserIds()),this.defaultManager.asyncCreateMeshNodes(i,r.getStandardUserIds(),(function(){i.getMaterialManager()._updateTextureMapping(),t.clearCachedData(i),t.loaded=!0,e&&e()}))}clearCachedData(){this.loader.getDescriptor().destroyReader(),this.loader.getDescriptor().clearReferencedMeshCache(),this.defaultManager.clearCachedData(),this.instancedManager.clearCachedData()}}r.ModelView.BatchedBaseHandler=e}(),r.ModelView.BatchedBaseManager=class{constructor(){this.meshManager=null,this.wireframeManager=null}destroy(){this.meshManager.destroy(),this.meshManager=null,this.wireframeManager.destroy(),this.wireframeManager=null,this._clearFilteredState(),this._clearSelectedState(),this._clearHoveredState(),this._clearBlinkedState()}updateNodes(e){this.meshManager.update(e),this.wireframeManager.update(e)}generateWireframe(e,t){this.wireframeManager.generateWireframe(e,t)}asyncGenerateWireframe(e,t){this.wireframeManager.asyncGenerateWireframe(e,t)}rebuildIndices(e){this._rebuildIndices(e)}clearData(){this.meshManager.clearData(),this.wireframeManager.clearData(),this._clearFilteredState(),this._clearSelectedState(),this._clearHoveredState(),this._clearBlinkedState()}createMeshNodes(e,t){this.meshManager.createMeshNodes(e,t)}asyncCreateMeshNodes(e,t,i){this.meshManager.asyncCreateMeshNodes(e,t,i)}hasNodeInfo(e){return!!e.getModelDescriptor().getStandardNodeInfos()}disposeGeometry(e){this.meshManager.disposeGeometry(e)}getMeshNode(){return this.meshManager.getMeshNode()}getPropertyValueByMaterialKey(e){return this.meshManager.getPropertyValueByMaterialKey(e)}getFilteredUserIds(){return this.mapMaterialIdToUserIdsForFilter}getSelectedUserIds(){return this.mapMaterialIdToUserIdsForSelection}getHoveredUserIds(){return this.mapMaterialIdToUserIdsForHover}getBlinkedUserIds(){return this.mapBlinkUserIds}getHiddenUserIds(){return this.hiddenUserIdSetObject}getTransparentUserIds(){return this.transparentUserIdSetObject}applyFilter(e,t){if(this.hasNodeInfo(e)){var i;i=t||e.getModelDescriptor().getStandardUserIds();var r=e.getModelDescriptor().getStandardNodeInfos();this._collectFilteredUserIds(e,i,r),this._collectSelectedUserIds(e.manager.sceneState.selectionSet,r),this._collectHoveredUserIds(e.manager.sceneState.hoverId,r),this._rebuildIndices(e),this.updateNodes(e)}}applySelection(e){if(this.hasNodeInfo(e)){var t=e.getModelDescriptor().getStandardNodeInfos();this._clearSelectedState(e),this._clearHoveredState(e),this._collectSelectedUserIds(e.manager.sceneState.selectionSet,t),this._collectHoveredUserIds(e.manager.sceneState.hoverId,t),this._rebuildIndices(e),this.updateNodes(e)}}clearSelection(e){this._clearSelectedState(e),this.applyHover(e)}applyHover(e){if(this.hasNodeInfo(e)){var t=e.getModelDescriptor().getStandardNodeInfos();this._clearHoveredState(e),this._collectHoveredUserIds(e.manager.sceneState.hoverId,t),this._rebuildIndices(e),this.updateNodes(e)}}clearHover(e){this._clearHoveredState(e),this._rebuildIndices(e),this.updateNodes(e)}applyBlink(e){if(this.hasNodeInfo(e)){var t=e.getModelDescriptor().getStandardNodeInfos();this._clearBlinkedState(e),this._clearHoveredState(e),this._collectBlinkedUserIds(e.manager.sceneState.getBlinkComponentsIdMap(e.id),t),this._collectHoveredUserIds(e.manager.sceneState.hoverId,t),this._rebuildIndices(e),this.updateNodes(e)}}clearBlink(e){this._clearBlinkedState(e),this.applyHover(e)}applyReplacement(e){this._rebuildIndices(e),this.updateNodes(e)}_collectFilteredUserIds(e,t,i){var a=e.getFilter(),n=a._hasHiddenFileIdFilter(),s=a._hasVisibleFilter(),o=a._hasOverrideMaterialFilter(),l=a._hasTransparentFilter(),d=e.hasReplacedUserId(),h=e.hasHiddenSourceObjectUserId(),c=this.mapMaterialIdToUserIdsForFilter={};if(this.hiddenUserIdSetObject={},this.overrideUserIdSetObject={},this.transparentUserIdSetObject={},n||s||o||l||d||h)for(var u=0;u<t.length;++u){var p=t[u],m=i[p];if(m&&m.length)for(var f=0,g=m.length;f<g;f++){var v=m[f];if(n&&a._isHiddenFileId(v)||s&&!1===a._isVisible(v)||e.isReplacedUserId(p)||e.isHiddenSourceObjectUserId(p))void 0===c[v.materialId]&&(c[v.materialId]={}),void 0===c[v.materialId][r.Model.EnumFilterState.HIDDEN]&&(c[v.materialId][r.Model.EnumFilterState.HIDDEN]={}),c[v.materialId][r.Model.EnumFilterState.HIDDEN][p]=!0,this.hiddenUserIdSetObject[p]=!0;else if(l&&a._isTransparent(v))void 0===c[v.materialId]&&(c[v.materialId]={}),void 0===c[v.materialId][r.Model.EnumFilterState.TRANSPARENT]&&(c[v.materialId][r.Model.EnumFilterState.TRANSPARENT]={}),c[v.materialId][r.Model.EnumFilterState.TRANSPARENT][p]=!0,this.transparentUserIdSetObject[p]=!0;else if(o&&a._hasOverrideMaterial(v)){var y=a._getOverrideMaterial(v),M=null!=y?y.name:"";""!==M&&(void 0===c[v.materialId]&&(c[v.materialId]={}),void 0===c[v.materialId][r.Model.EnumFilterState.OVERRIDED]&&(c[v.materialId][r.Model.EnumFilterState.OVERRIDED]={}),c[v.materialId][r.Model.EnumFilterState.OVERRIDED][p]=M,this.overrideUserIdSetObject[p]=M)}}}}_clearFilteredState(){this.mapMaterialIdToUserIdsForFilter=null}_collectSelectedUserIds(e,t){var i=this.mapMaterialIdToUserIdsForSelection={};for(var r in e){var a=t[r];if(a&&a.length)for(var n=0,s=a.length;n<s;n++)void 0===i[a[n].materialId]&&(i[a[n].materialId]={}),void 0===i[a[n].materialId][r]&&(i[a[n].materialId][r]=!0)}}_clearSelectedState(){this.mapMaterialIdToUserIdsForSelection&&(this.mapMaterialIdToUserIdsForSelection=null)}_collectHoveredUserIds(e,t){var i=this.mapMaterialIdToUserIdsForHover={};if(e&&t[e])for(var r=t[e],a=0,n=r.length;a<n;a++)void 0===i[r[a].materialId]&&(i[r[a].materialId]={}),void 0===i[r[a].materialId][e]&&(i[r[a].materialId][e]=!0)}_clearHoveredState(){this.mapMaterialIdToUserIdsForHover&&(this.mapMaterialIdToUserIdsForHover=null)}_collectBlinkedUserIds(e,t){var i=this.mapBlinkUserIds={};for(var r in e){var a=t[r];if(a&&a.length)for(var n=0,s=a.length;n<s;n++)void 0===i[a[n].materialId]&&(i[a[n].materialId]={}),void 0===i[a[n].materialId][r]&&(i[a[n].materialId][r]=!0)}}_clearBlinkedState(){this.mapBlinkUserIds&&(this.mapBlinkUserIds=null)}_rebuildIndices(e){this.meshManager.rebuildIndices(e),this.wireframeManager.rebuildIndices(e)}clearCachedData(){this.meshManager.clearAllNodeBuffer()}getMeshesByUserIds(e,t,i){this.meshManager.getMeshesByUserIds(e,t,i)}adjustVisibility(e,t){this.meshManager.adjustVisibility(e,t),this.wireframeManager.adjustVisibility(e,t)}changeVisibilityOfSelectedObjects(e,t){this.meshManager.changeVisibilityOfSelectedObjects(e,t),this.wireframeManager.changeVisibilityOfSelectedObjects(e,t)}changeVisibilityOfNonSelectedObjects(e,t){this.meshManager.changeVisibilityOfNonSelectedObjects(e,t),this.wireframeManager.changeVisibilityOfNonSelectedObjects(e,t)}restoreVisibilityOfObjects(){this.meshManager.restoreVisibilityOfObjects(),this.wireframeManager.restoreVisibilityOfObjects()}disposeBufferAfterVbo(){this.meshManager.disposeBufferAfterVbo(),this.wireframeManager.disposeBufferAfterVbo()}getGeometryBuffersByUserId(e,t){return this.meshManager.getGeometryBuffersByUserId(e,t)}explode(e){this.meshManager.explode(e),this.wireframeManager.explode(e)}isPickableNode(e){var t=this.getHiddenUserIds();if(t&&t[e])return!1;var i=this.getTransparentUserIds();return!i||!i[e]}isHiddenNode(e){var t=this.getHiddenUserIds();return!(!t||!t[e])}getMeshManager(){return this.meshManager}getWireFrameManager(){return this.wireframeManager}},function(){class e extends r.ModelView.DefaultBaseLoader{constructor(e){super(e),this.descriptor=new r.ModelView.BatchedDescriptor}}r.ModelView.BatchedLoader=e}(),function(){class e extends r.ModelView.DefaultDescriptor{constructor(){super()}}r.ModelView.BatchedDescriptor=e}(),function(){class e extends r.ModelView.MeshBaseManager{constructor(e,t){super(),this.manager=e,this._maxIndiceseNum=0,this._materialList=[],this.mapMaterialIdToMergedNode={},this.selectedMeshes=[],this.nonSelectedMeshes=[],this.selectedObjectIds=[],this.blinkMaterials=[],this.mapDestroyedBufferKey={},this.mapClippingIds={},this.mapClippingIdsBox=[[],[],[],[],[],[]],this.clippingIdsForInstance=[],this.isCalculatedClippingIds=!1,this.clippingMaterialMap={},this.version=t}destroy(){if(super.destroy(),this.clearData(),this.mapMaterialIdToMergedNode=null,this.manager=null,this._materialList=null,this.selectedMeshes=null,this.nonSelectedMeshes=null,this.selectedObjectIds=null,this.blinkMaterials=null,this.mapDestroyedBufferKey=null,this.clippingMaterialMap=null,this.pickingNodeGenerators){for(var e in this.pickingNodeGenerators)this.pickingNodeGenerators.hasOwnProperty(e)&&this.pickingNodeGenerators[e].destroy();this.pickingNodeGenerators=null}}clearData(){if(this.bufferDestroyed=!1,this.clearAllNodeBuffer(),this._disposeMergedGeometries(),this.pickingNodeGenerators)for(var e in this.pickingNodeGenerators)this.pickingNodeGenerators.hasOwnProperty(e)&&this.pickingNodeGenerators[e].clearData()}getMeshesByUserIds(e,t,i){const r=e.getLengthUnitsMatrix();for(let a in this.mapMaterialIdToMergedNode){const n=this.mapMaterialIdToMergedNode[a];for(let a=0,s=n.length;a<s;a++){const s=n[a],o=s.indices;for(let a in o)if(a==t||a==i){const t=o[a];for(let i=0,n=t.length;i<n;i++)e.minDistanceObjects[a].push({mesh:s.mesh,indexInfo:t[i],boundingBox:t[i].boundingBox,unitsMatrix:r})}}}}_traverseIntersectNodeLimit(e,t,i){const a=this.manager.getHiddenUserIds();for(let n in this.mapMaterialIdToMergedNode){const s=this.mapMaterialIdToMergedNode[n];for(let n=0,o=s.length;n<o;n++){const o=s[n],l=o.mesh,d=l.matrixWorld.clone().setPosition(0,0,0),h=o.indices;for(const n in h){if(a&&a[n])continue;const s=h[n];for(let a=0,n=s.length;a<n;a++)"LineSegmentsEx"!=l.type&&r.GeomUtil.boxIntersectsPlaneWithMatrix(e,s[a].boundingBox,d)&&l.intersectBoxWithPlaneMesh(t,s[a])&&i&&i(l,s[a])}}}}_traverseIntersectNode(e,t,i){const a=this.manager.getHiddenUserIds();for(let n in this.mapMaterialIdToMergedNode){const s=this.mapMaterialIdToMergedNode[n];for(let n=0,o=s.length;n<o;n++){const o=s[n],l=o.mesh,d=o.indices;for(const n in d){if(a&&a[n])continue;const s=d[n];for(let a=0,n=s.length;a<n;a++)"LineSegmentsEx"!=l.type&&r.GeomUtil.boxIntersectsPlaneWithMatrix(e,s[a].boundingBox,t)&&i&&i(l,s[a])}}}}preCalculateClippingIdsForInstance(e){if(this.isCalculatedClippingIds)return;let t=e.getModelDescriptor(),i=t.getStandardUserIds(),a=t.getInstancedNodeInfos();if(a){for(var n=0;n<i.length;n++){let e=i[n],t=a[e];if(t&&t instanceof Array)for(let i=0;i<t.length;i++)if(t[i].type==r.ModelView.BaseDescriptor.EnumNodeItemType.MESH_REF){this.clippingIdsForInstance.push(e);break}}this.isCalculatedClippingIds=!0}}clearClippingIdsForBox(){for(let e=0;e<this.mapClippingIdsBox.length;e++)this.mapClippingIdsBox[e].length=0}calculateClippingIds(e,t,i,a){let n=a.getFilter().getLocalClippingList(),s=a.manager.viewer.getRenderer().localClippingEnabled&&Object.keys(n).length>0;const o=a.manager.getScene().getMatrixGlobal().clone(),l=a.manager.getModelLengthUnitsMatrix(a),d=l?o.multiply(l):o;if(this.mapClippingIds={},this._traverseIntersectNode(e,d,((i,a)=>{if(!s||s&&n[a.userId]){let n=[];i.getIntersectionPoints(e,a,n),t.push.apply(t,r.GeomUtil.applyMatrix4ToList(n,i.matrix)),this.mapClippingIds[a.userId]=!0}})),i>=0){this.mapClippingIdsBox[i].length=0,this.mapClippingIdsBox[i]=Object.keys(this.mapClippingIds);let e=this.mapClippingIdsBox;for(let t=0;t<e.length;t++){let i=e[t];for(let e=0;e<i.length;e++)this.mapClippingIds[i[e]]=!0}}this.preCalculateClippingIdsForInstance(a);let h=this.clippingIdsForInstance;for(let e=0;e<h.length;e++)this.mapClippingIds[h[e]]=!0}calculateClippingContours(e,t,i,r,a,n){this._traverseIntersectNodeLimit(t,i,((i,s)=>{const o=s.userId;if(-1===a.indexOf(o))return;let l=[];if(i.getIntersectionContours(t,s,l),0===l.length)return;let d=[];const h=i.material[0].color,c={red:parseInt(255*h.r),green:parseInt(255*h.g),blue:parseInt(255*h.b)};l.map((e=>{let t=[];e.map((e=>{r.containsPoint(e)&&t.push(e)})),t.length>0&&d.push(t)})),void 0===n[e][o]?n[e][o]={clippingContours:[d],colors:[c]}:(n[e][o].clippingContours.push(d),n[e][o].colors.push(c))}))}rebuildIndices(e){this._materialList.length=0,this.clearSelectedObjectIds();var t=this.manager.getFilteredUserIds(),i=this.manager.getSelectedUserIds(),a=this.manager.getHoveredUserIds(),n=this.manager.getBlinkedUserIds(),s=this.mapClippingIds,o=!1,l=null,d=e.getFilter();for(var h in d&&(o=d._hasLocalClipping(),l=d.getLocalClippingList()),this.mapMaterialIdToMergedNode){var c,u,p,m,f=this.getPropertyValueByMaterialKey(h).materialId,g=null,v=null,y=null,M=null,E=null,b=null;i&&i[f]&&(M=i[f]),a&&a[f]&&(E=a[f]),n&&n[f]&&(b=n[f]),t&&t[f]&&(g=t[f][r.Model.EnumFilterState.HIDDEN],v=t[f][r.Model.EnumFilterState.OVERRIDED],y=t[f][r.Model.EnumFilterState.TRANSPARENT]);var I=this.mapMaterialIdToMergedNode[h];for(p=0,m=I.length;p<m;p++){var x=I[p],T=(x.mesh,x.indices),_=x.geometry;if(_.clearGroups(),_._visible=!0,M||g||v||E||y||s||o||b){var S=[];for(var C in T)if(T.hasOwnProperty(C)){if(g&&g[C])continue;var w=T[C];if(w&&w.length>0){if(w.sort((function(e,t){return e.indexStart-t.indexStart})),l&&l[C]){var R="localClipping#"+C+"#"+w[0].nodeId;y&&y[C]?R+="#transparent":b&&b[C]?(R+="#blink",v&&v[C]&&(R+="#"+v[C])):E&&E[C]?(R+="#hover",v&&v[C]&&(R+="#"+v[C])):v&&v[C]&&(R+="#override#"+v[C]),this._materialList.push(R);var B=this._materialList.length-1;for(c=0,u=w.length;c<u;c++)S.push({indexStart:w[c].indexStart,indexCount:w[c].indexCount,state:r.Model.EnumFilterState.OVERRIDED+B});continue}if(y&&y[C]){for(c=0,u=w.length;c<u;c++)S.push({indexStart:w[c].indexStart,indexCount:w[c].indexCount,state:r.Model.EnumFilterState.TRANSPARENT});continue}if(e.manager.isSelectPriority()){if(M&&M[C]){if(this.cacheSelectedObjectIds(C,h,p),r.GlobalData.PickingEffect){if(v&&v[C]){var L="selected#"+v[C];for(-1===(B=this._materialList.indexOf(L))&&(this._materialList.push(L),B=this._materialList.length-1),c=0,u=w.length;c<u;c++)S.push({indexStart:w[c].indexStart,indexCount:w[c].indexCount,state:r.Model.EnumFilterState.OVERRIDED+B});continue}for(c=0,u=w.length;c<u;c++)S.push({indexStart:w[c].indexStart,indexCount:w[c].indexCount,state:r.Model.EnumFilterState.NONE});continue}for(c=0,u=w.length;c<u;c++)S.push({indexStart:w[c].indexStart,indexCount:w[c].indexCount,state:r.Model.EnumFilterState.SELECTED});continue}if(b&&b[C]){let e;e=`blink#${f}#${C}`,v&&v[C]&&(e=`blink#${v[C]}#${C}`);B=this._materialList.indexOf(e);for(-1===B&&(this._materialList.push(e),B=this._materialList.length-1),c=0,u=w.length;c<u;c++)S.push({indexStart:w[c].indexStart,indexCount:w[c].indexCount,state:r.Model.EnumFilterState.OVERRIDED+B});continue}}else{if(b&&b[C]){let e;e=`blink#${f}#${C}`,v&&v[C]&&(e=`blink#${v[C]}#${C}`);B=this._materialList.indexOf(e);for(-1===B&&(this._materialList.push(e),B=this._materialList.length-1),c=0,u=w.length;c<u;c++)S.push({indexStart:w[c].indexStart,indexCount:w[c].indexCount,state:r.Model.EnumFilterState.OVERRIDED+B});continue}if(M&&M[C]){if(this.cacheSelectedObjectIds(C,h,p),r.GlobalData.PickingEffect){if(v&&v[C]){L="selected#"+v[C];for(-1===(B=this._materialList.indexOf(L))&&(this._materialList.push(L),B=this._materialList.length-1),c=0,u=w.length;c<u;c++)S.push({indexStart:w[c].indexStart,indexCount:w[c].indexCount,state:r.Model.EnumFilterState.OVERRIDED+B});continue}for(c=0,u=w.length;c<u;c++)S.push({indexStart:w[c].indexStart,indexCount:w[c].indexCount,state:r.Model.EnumFilterState.NONE});continue}for(c=0,u=w.length;c<u;c++)S.push({indexStart:w[c].indexStart,indexCount:w[c].indexCount,state:r.Model.EnumFilterState.SELECTED});continue}}if(E&&E[C]){if(v&&v[C]){L="hover#"+v[C];for(-1===(B=this._materialList.indexOf(L))&&(this._materialList.push(L),B=this._materialList.length-1),c=0,u=w.length;c<u;c++)S.push({indexStart:w[c].indexStart,indexCount:w[c].indexCount,state:r.Model.EnumFilterState.OVERRIDED+B});continue}for(c=0,u=w.length;c<u;c++)S.push({indexStart:w[c].indexStart,indexCount:w[c].indexCount,state:r.Model.EnumFilterState.HOVER});continue}if(v&&v[C]){L=v[C];for(-1===(B=this._materialList.indexOf(L))&&(this._materialList.push(L),B=this._materialList.length-1),c=0,u=w.length;c<u;c++)S.push({indexStart:w[c].indexStart,indexCount:w[c].indexCount,state:r.Model.EnumFilterState.OVERRIDED+B});continue}if(s[C])for(c=0,u=w.length;c<u;c++)S.push({indexStart:w[c].indexStart,indexCount:w[c].indexCount,state:r.Model.EnumFilterState.CLIPPING});for(c=0,u=w.length;c<u;c++)S.push({indexStart:w[c].indexStart,indexCount:w[c].indexCount,state:0})}}if(S.length>0)for(c=0,u=S.length;c<u;c++){var O=S[c].indexStart,P=S[c].indexCount,D=S[c].state;if(0===c)_.addGroup(O,P,D);else{var A=S[c-1].indexStart,N=S[c-1].indexCount;D===S[c-1].state&&O===A+N?_.groups[_.groups.length-1].count+=P:_.addGroup(O,P,D)}}else _._visible=!1}}}}update(e){var t,i,a,n,s=e.getFilter(),o=e.materialManager,l=e.materialManager.materials,d=e.selectedMaterial,h=e.manager.sceneState;if(e.isOnlyWireframe())for(var c in this.mapMaterialIdToMergedNode){for(a=0,n=(R=this.mapMaterialIdToMergedNode[c]).length;a<n;a++){(L=R[a].mesh)&&(L.visible=!1)}}else{r.GlobalData.TranslucentDepthDisabled&&(d.transparent?d.depthWrite=!1:d.depthWrite=!0);var u=s._getMaterialByName("scene");r.GlobalData.TranslucentDepthDisabled&&(u.depthWrite=!1);var p=[];this.blinkMaterials.length=0;var m={},f=s.getLocalClippingList();for(t=0,i=this._materialList.length;t<i;t++){var g,v=this._materialList[t],y=v.split("#");if("hover"===y[0])g=s._getMaterialByName(y[1]),g=h.getHoverMaterial(g);else if("blink"===y[0])g=s._getMaterialByName(y[1])||o.getMaterialById(y[1]),g=h.getBlinkMaterial(g,v),m[v]||(m[v]=g,this.blinkMaterials.push(g));else if("localClipping"===y[0]){var M=y[1],E=y[2],b=f[M].nodeMap.get(E),I=s.getMaterialForClipBy(b);if(y[3]&&"transparent"==y[3]){var x=b+y[3];(g=s.getMaterialForClipBy(x,I)).copy(u),g.isOverrideOpacity=g.transparent}else if(y[3]&&"blink"==y[3]){if(y[4]){x=b+y[3]+y[4];g=s.getMaterialForClipBy(x,I);var T=s._getMaterialByName(y[4]);T=h.getBlinkMaterial(T,e.id),g.copy(T)}else{x=b+y[3];g=s.getMaterialForClipBy(x,I);var _=h.getBlinkMaterial(g,e.id);g.copy(_)}m[g.name]||(m[v]=g,this.blinkMaterials.push(g))}else if(y[3]&&"hover"==y[3])if(y[4]){x=b+y[3]+y[4];g=s.getMaterialForClipBy(x,I);T=s._getMaterialByName(y[4]);T=h.getHoverMaterial(T),g.copy(T)}else{x=b+y[3];g=s.getMaterialForClipBy(x,I);var S=h.getHoverMaterial(g);g.copy(S)}else if(y[3]&&"override"==y[3]){x=b+y[3]+y[4];g=s.getMaterialForClipBy(x,I);T=s._getMaterialByName(y[4]);g.copy(T),g.isOverrideOpacity=T.transparent}else g=I;g.clippingPlanes=I.clippingPlanes,this.clippingMaterialMap[g.name]=!0}else g=s._getMaterialByName(v);r.GlobalData.TranslucentDepthDisabled&&(g.transparent?g.depthWrite=!1:g.depthWrite=!0),p[t]=g}for(var c in this.mapMaterialIdToMergedNode){var C=this.getPropertyValueByMaterialKey(c).materialId,w=e.manager.getOverrideMaterialByName(C)||o.getMaterialById(C);r.GlobalData.TranslucentDepthDisabled&&(w.transparent?w.depthWrite=!1:w.depthWrite=!0);var R,B=h.getHoverMaterial(l[C]);for(r.GlobalData.TranslucentDepthDisabled&&(B.transparent?B.depthWrite=!1:B.depthWrite=!0),a=0,n=(R=this.mapMaterialIdToMergedNode[c]).length;a<n;a++){var L,O=R[a],P=O.geometry;if(null!==P)if(L=O.mesh)if(P._visible){if(P.groups.length>0){r.GeomUtil.limitGeometryBufferSize(P);var D=[w,d,void 0,B,u,void 0];for(t=0,i=p.length;t<i;t++)this.clippingMaterialMap[p[t].name]||(p[t].side=w.side),D.push(p[t]);L.material=D}else r.GeomUtil.limitGeometryBufferSize(P),L.material=P.groups.length?[w]:w;L.visible=!0}else L.visible=!1}w=null}}}explode(e){function t(e,t,i,r){for(var a=e.getAttribute("position").array,n=t;n<i;n+=3)a[n]+=r.x,a[n+1]+=r.y,a[n+2]+=r.z;e.getAttribute("position").needsUpdate=!0}for(var i in this.mapMaterialIdToMergedNode)for(var r=this.mapMaterialIdToMergedNode[i],a=0,n=r.length;a<n;a++){var s=r[a],o=s.geometry;if(null!==o){var l=s.indices;for(var d in l){var h=e.modelExplosion.getExplosionTranslation(d),c=l[d];if(c)for(var u=0,p=c.length;u<p;u++){var m=c[u].positionStart;t(o,m,m+c[u].positionCount,h)}}}}}_getNodeGroup(e){return e._getNodeGroup(r.ObjectGroupType.GEOMETRY,{globalSpace:!0})}_hasNodeGroup(e){return e._hasNodeGroup(r.ObjectGroupType.GEOMETRY)}_resetMaxIndicesNumberPerBathSegment(e){r.GlobalData.SegmentedBatchMergeEnable&&r.GlobalData.maxIndicesNumberPerBathSegment<this._maxIndiceseNum&&(console.log("adjust maxIndicesNumberPerBathSegment value from "+r.GlobalData.maxIndicesNumberPerBathSegment+" to "+this._maxIndiceseNum+"!"),r.GlobalData.maxIndicesNumberPerBathSegment=e)}asyncCreateMeshNodes(e,t,i){var r=this;t&&t.length?this._asyncMergeData(e,t,(function(){r._makeMeshNodes(e),i&&i()})):i&&i()}_asyncMergeData(e,t,i){var a={},n=this,s=e.getLoader().maxLoadTaskCount,o=e.progressPercentage.load,l=e.progressPercentage.collect,d=t.length,h=Math.ceil(d/e.progressFrequency),c=e.getModelDescriptor().getStandardNodeInfos();requestAnimationFrame(function u(p){var m=p;return function(){var p,f;for(f=m+h>d?d:m+h,p=m;p<f;p++){var g=t[p];if(n._collectMergedNodeInfosById(e,g,c,a),p===f-1)if(f!==d){var v={total:s,loaded:(p/d*l+o)*s};e.dispatchEvent({type:r.EVENTS.ON_LOAD_PROGRESS,progress:v}),requestAnimationFrame(u(p+1))}else{v={total:s,loaded:(l+o)*s};e.dispatchEvent({type:r.EVENTS.ON_LOAD_PROGRESS,progress:v}),n._asyncMergeGeometry(a,e,i)}}}}(0))}_asyncMergeGeometry(e,t,i){var a=[];for(var n in e)a.push(n);if(0!==a.length){this._resetMaxIndicesNumberPerBathSegment(this._maxIndiceseNum);var s=this,o=t.getLoader().maxLoadTaskCount,l=t.progressPercentage.load,d=t.progressPercentage.collect,h=t.progressPercentage.merge,c=a.length,u=Math.ceil(c/t.progressFrequency),p=this.mapMaterialIdToMergedNode;requestAnimationFrame(function n(m){var f=m;return function(){var m,g;for(g=f+u>c?c:f+u,m=f;m<g;m++)if(s._collectMergedGeometriesById(a[m],e,p),m===g-1)if(g!==a.length){var v={total:o,loaded:(m/c*h+l+d)*o};t.dispatchEvent({type:r.EVENTS.ON_LOAD_PROGRESS,progress:v}),requestAnimationFrame(n(m+1))}else i()}}(0))}else i()}_collectMergedNodeInfosById(e,t,i,r){for(var a=i[t],n=0,s=a.length;n<s;n++){var o=a[n];this._createNodeBuffer(e,o);var l=this._getNodeBufferBy(o.nodeId);if(l){var d=l.index;d&&d.length>this._maxIndiceseNum&&(this._maxIndiceseNum=d.length);var h=this._getMaterialKeyByNodeInfo(o,e);void 0===r[h]&&(r[h]=[]),r[h].push(o)}}}_collectMergedGeometriesById(e,t,i){var a=t[e],n=0,s=0,o=0,l=0,d=0,h=null;void 0===i[e]&&(i[e]=[]);var c=[],u=0;a.sort((function(e,t){return e.userId-t.userId}));let p=null;for(var m=0,f=a.length;m<f;m++){var g=a[m];(h=this._getNodeBufferBy(g.nodeId))?(s+=h.index.length,n+=h.position.length,h.normal&&(o+=h.normal.length),h.uv&&(l+=h.uv.length),h.uv2&&(d+=h.uv2.length),p||(p=h.position instanceof Float64Array?Float64Array:Float32Array),r.GlobalData.SegmentedBatchMergeEnable&&s>r.GlobalData.maxIndicesNumberPerBathSegment?(s-=h.index.length,n-=h.position.length,h.normal&&(o-=h.normal.length),h.uv&&(l-=h.uv.length),h.uv2&&(d-=h.uv2.length),c.push({start:u,end:m,arrayPositionLength:n,arrayIndexLength:s,arrayNormalLength:o,arrayUVLength:l,arrayUV2Length:d}),n=0,s=0,o=0,l=0,d=0,u=m,m-=1):m===f-1&&c.push({start:u,end:f,arrayPositionLength:n,arrayIndexLength:s,arrayNormalLength:o,arrayUVLength:l,arrayUV2Length:d}),h=null):m===f-1&&c.push({start:u,end:f,arrayPositionLength:n,arrayIndexLength:s,arrayNormalLength:o,arrayUVLength:l,arrayUV2Length:d})}null===p&&(p=Float32Array);for(var v=0,y=c.length;v<y;v++){var M=c[v],E=new THREE.BufferGeometry,b={},I=new p(M.arrayPositionLength),x=new Uint32Array(M.arrayIndexLength),T=new Float32Array(M.arrayNormalLength),_=new Float32Array(M.arrayUVLength),S=new Float32Array(M.arrayUV2Length),C=0,w=0,R=0,B=0,L=0,O=[];for(m=M.start,f=M.end;m<f;m++){g=a[m];if(h=this._getNodeBufferBy(g.nodeId)){O.push(g.nodeId);var P=h.index,D=h.position,A=h.normal,N=h.uv,H=h.uv2;I.set(D,C);for(var U=Uint32Array.from(P),F=0,k=U.length;F<k;F++)U[F]+=C/3;x.set(U,w),void 0===b[g.userId]&&(b[g.userId]=[]),b[g.userId].push({userId:g.userId,nodeId:g.nodeId,positionStart:C,positionCount:D.length,indexStart:w,indexCount:P.length,lightmapIdx:g.lightmapIdx,boundingBox:g.boundingBox}),w+=P.length,C+=D.length,A&&(T.set(A,R),R+=A.length),N&&(_.set(N,B),B+=N.length),H&&(S.set(H,L),L+=H.length),P=null,D=null,A=null,N=null,H=null,h=null}}this.clearNodeBufferByNodeIds(O),E._visible=!0,E.setIndex(new THREE.BufferAttribute(x,1)),E.setAttribute("position",new THREE.BufferAttribute(I,3));let t=null;r.Compatibility.isUseDoubleMatrixMPKHeader(this.version),0,R>0&&E.setAttribute("normal",new THREE.BufferAttribute(T,3)),B>0&&E.setAttribute("uv",new THREE.BufferAttribute(_,2)),L>0&&E.setAttribute("uv2",new THREE.BufferAttribute(S,2)),i[e].push({geometry:E,indices:b,matrix:t})}}clearAllNodeBuffer(){this.cachedNodeBuffer&&(this.cachedNodeBuffer=null)}clearNodeBufferByNodeIds(e){if(this.cachedNodeBuffer)for(var t=0,i=e.length;t<i;t++)this.cachedNodeBuffer[e[t]]=null}_getNodeBufferByNodeInfo(e,t){return this.cachedNodeBuffer||this._createNodeBuffer(e,t),this.cachedNodeBuffer[t.nodeId]}_getNodeBufferBy(e){return this.cachedNodeBuffer?this.cachedNodeBuffer[e]:null}_createNodeBufferByMpkBufferData(e,t,i){this.cachedNodeBuffer||(this.cachedNodeBuffer={}),this.cachedNodeBuffer[t.nodeId]||(this.cachedNodeBuffer[t.nodeId]=this.createBufferByBufferDataWithUV2(e,t,i))}_createNodeBuffer(e,t){this._createNodeBufferByMpkBufferData(e,t,{buffer:e.getModelDescriptor().getReferencedMeshBufferById(t.geometryId),isDataView:!0})}_createGeometries(e,t){var i=this,r=e.getModelDescriptor().getStandardNodeInfosOnGeometryId(),a=e.getModelDescriptor().getReferencedMeshBufferData(),n=this._getClassifiedMeshes(r,a);this._dealDataMergedMeshs(e,n,a,r,(function(){i._dealDataMergeableMeshs(e,n,a,r,t)}))}_getClassifiedMeshes(e,t){var i={},a={};for(var n in t){var s=t[n].IndexInfos,o=void 0;if(s){if(s.length<1)continue;for(var l=0,d=s.length;l<d;l++){if((h=e[s[l].meshId])&&h.length){o=s[l].meshId;break}}}else{var h;(h=e[n])&&h.length&&(o=n)}if(void 0!==o)(h=e[o])&&h.length&&(h[0].type===r.ModelView.BaseDescriptor.EnumNodeItemType.LINE||!h[0].instanceOrNot&&h[0].type===r.ModelView.BaseDescriptor.EnumNodeItemType.MESH_REF?i[n]=!0:a[n]=!0)}if(!r.GlobalData.Instance)for(var n in e)a[n]||i[n]||(i[n]=!0);return{mergeableIdxs:Object.keys(i),mergedIdxs:Object.keys(a)}}_collectMergeableMeshesByIdxId(e,t,i,r,a){i[t]&&i[t].IndexInfos?this._collectSharedMeshesByIdxId(e,t,i,r,a):this._collectLineOrIntanceMeshesByIdxId(e,t,i,r,a)}_collectLineOrIntanceMeshesByIdxId(e,t,i,r,a){for(var n=r[t],s={buffer:e.getModelDescriptor().getReferencedMeshBufferById(t)},o=0,l=n.length;o<l;o++){var d=n[o];this._createNodeBufferByMpkBufferData(e,d,s);var h=this._getMaterialKeyByNodeInfo(d);a[h]||(a[h]=[]),a[h].push(d)}}_collectSharedMeshesByIdxId(e,t,i,r,a){for(var n=i[t].IndexInfos,s=0,o=n.length;s<o;s++){var l=r[n[s].meshId];if(l)for(var d={buffer:e.getModelDescriptor().getReferencedMeshBufferById(t),indexInfo:n[s]},h=0,c=l.length;h<c;h++){var u=l[h];this._createNodeBufferByMpkBufferData(e,u,d);var p=this._getMaterialKeyByNodeInfo(u);a[p]||(a[p]=[]),a[p].push(u)}}}_mergeMergeableMeshes(e,t,i,a){var n=Object.keys(t);if(0!==n.length){var s=this,o=e.getLoader().maxLoadTaskCount,l=n.length,d=e.progressPercentage.load,h=e.progressPercentage.collect,c=e.progressPercentage.merge,u=Math.ceil(l/e.progressFrequency);requestAnimationFrame(function p(m){var f=m;return function(){var m,g;for(g=f+u>l?l:f+u,m=f;m<g;m++)s._collectMergedGeometriesById(n[m],t,i),m===g-1&&(g!==l?(e.dispatchEvent({type:r.EVENTS.ON_LOAD_PROGRESS,progress:{total:o,loaded:(m/l*c+d+h)*o}}),requestAnimationFrame(p(m+1))):s._makeMeshNodes(e,a))}}(0))}else this._makeMeshNodes(e,a)}_dealDataMergeableMeshs(e,t,i,a,n){if(0!==t.mergeableIdxs.length){var s=this,o=this.mapMaterialIdToMergedNode,l={},d=t.mergedIdxs.length,h=t.mergeableIdxs.length,c=d+h,u=t.mergeableIdxs,p=e.getLoader().maxLoadTaskCount,m=e.progressPercentage.load,f=e.progressPercentage.collect,g=Math.ceil(h/e.progressFrequency);requestAnimationFrame(function t(v){var y=v;return function(){var v,M;for(M=y+g>h?h:y+g,v=y;v<M;v++)s._collectMergeableMeshesByIdxId(e,u[v],i,a,l),v===M-1&&(M!==h?(e.dispatchEvent({type:r.EVENTS.ON_LOAD_PROGRESS,progress:{total:p,loaded:((v+d)/c*f+m)*p}}),requestAnimationFrame(t(v+1))):(e.dispatchEvent({type:r.EVENTS.ON_LOAD_PROGRESS,progress:{total:p,loaded:(f+m)*p}}),s._mergeMergeableMeshes(e,l,o,n)))}}(0))}else this._makeMeshNodes(e,n)}_collectDataMergedMeshesByIdxId(e,t,i,r,a){var n=t[e],s=n.IndexInfos;if(s&&0!==s.length){var o=!1;n.UV&&(n.UV.byteLength||n.UV.length)&&(o=!0),a.lightmap&&(n=this.getAttributeForLightmapWithDataMerged(n,a,e));for(var l=void 0,d=-1,h=0,c=s.length;h<c;h++){var u=i[s[h].meshId];if(u&&0!==u.length){if(null!=n.lightmapIdx){var p=s[h];p.positionStart=3*(d+1),p.uvStart=2*(d+1);for(var m=p.indexStart,f=p.indexCount+p.indexStart;m<f;m++)d=d<n.I[m]?n.I[m]:d;var g=d+1;p.positionCount=3*g-p.positionStart,p.uvCount=2*g-p.uvStart}l=s[h].meshId;for(var v=0,y=u.length;v<y;v++)u[v].uv=o,null!=n.lightmapIdx&&(u[v].lightmapIdx=n.lightmapIdx,u[v].materialId=u[v].materialId+"_"+u[v].lightmapIdx)}}if(void 0!==l){var M=i[l][0],E={},b=this._getMaterialKeyByNodeInfo(M);void 0===r[b]&&(r[b]=[]);for(m=0,f=s.length;m<f;m++)i[s[m].meshId]&&(void 0===E[(M=i[s[m].meshId][0]).userId]&&(E[M.userId]=[]),s[m].userId=M.userId,s[m].nodeId=M.nodeId,s[m].boundingBox=M.boundingBox,E[M.userId].push(s[m]));var I=new THREE.BufferGeometry;I._visible=!0,I.setIndex(new THREE.BufferAttribute(new Uint32Array(n.I),1)),I.setAttribute("position",new THREE.BufferAttribute(new Float32Array(n.P),3)),n.N&&(n.N.byteLength||n.N.length)&&I.setAttribute("normal",new THREE.BufferAttribute(new Float32Array(n.N),3)),o&&I.setAttribute("uv",new THREE.BufferAttribute(new Float32Array(n.UV),2)),n.UV2&&(I.setAttribute("uv2",new THREE.BufferAttribute(new Float32Array(n.UV2),2)),I.lightmapIdx=n.lightmapIdx),r[b].push({geometry:I,indices:E,matrix:n.mpkMatrix})}}}getAttributeForLightmapWithDataMerged(e,t,i){var r=[],a=new Uint32Array(e.I),n=t.getLoader().getUV2ById("bmpk_"+i,a.length);if(!n)return e;var s=n.lightmapIdx;r=n.uv2;for(var o=new Float32Array(e.P),l=new Float32Array(e.N),d=new Float32Array(e.UV),h=[],c=[],u=[],p=[],m=[],f=0,g=0;g<a.length;g++){var v=a[g];null==m[v]||r[2*m[v]]!=r[2*g]||r[2*m[v]+1]!=r[2*g+1]?(h.push(o[3*v]),h.push(o[3*v+1]),h.push(o[3*v+2]),l.length>0&&(c.push(l[3*v]),c.push(l[3*v+1]),c.push(l[3*v+2])),d.length>0&&(u.push(d[2*v]),u.push(d[2*v+1])),p.push(r[2*g]),p.push(r[2*g+1]),a[g]=f,f++,null==m[v]&&(m[v]=g)):a[g]=a[m[v]]}return o=null,l=null,d=null,r=null,m=null,{I:a,UV2:p,P:h,N:c,UV:u,lightmapIdx:s}}_dealDataMergedMeshs(e,t,i,a,n){if(0!==t.mergedIdxs.length){var s=this,o=this.mapMaterialIdToMergedNode,l=t.mergedIdxs,d=l.length,h=t.mergedIdxs.length+t.mergeableIdxs.length,c=e.getLoader().maxLoadTaskCount,u=e.progressPercentage.load,p=e.progressPercentage.collect,m=Math.ceil(d/e.progressFrequency);requestAnimationFrame(function t(f){var g=f;return function(){var f,v;for(v=g+m>d?d:g+m,f=g;f<v;f++)s._collectDataMergedMeshesByIdxId(l[f],i,a,o,e),f===v-1&&(v!==d?(e.dispatchEvent({type:r.EVENTS.ON_LOAD_PROGRESS,progress:{total:c,loaded:(f/h*p+u)*c}}),requestAnimationFrame(t(f+1))):(e.dispatchEvent({type:r.EVENTS.ON_LOAD_PROGRESS,progress:{total:c,loaded:(f/h*p+u)*c}}),n&&n()))}}(0))}else n&&n()}_makeMeshNodes(e,t){var i=e.manager,a=e.databagId;let n=e.fileId;var s=e.getEncodedDatabagId(),o=this._getNodeGroup(e),l=this.mapMaterialIdToMergedNode;for(var d in l){var h=this.getPropertyValueByMaterialKey(d),c=l[d];if(e.lightmap){var u=h.materialId;e.materialManager.updateLightmapMaterial(u)}for(var p=0,m=c.length;p<m;p++){var f=c[p].geometry,g=c[p].indices;const t=c[p].matrix;var v=null;if("lines"===h.type)(v=new r.LineSegmentsEx(f)).databagId=a,v.fileId=n,t&&v.matrix.copy(t),v.matrixAutoUpdate=!1,v.updateMatrixWorld(!0);else{var y={databagId:a,fileId:n};(v=new r.MeshEx(f)).spawn(y),t&&v.matrix.copy(t)}r.GlobalData.EnableShadowMap&&(v.castShadow=e.castShadow,v.receiveShadow=e.receiveShadow),v._indicesGroup=g,o.add(v),c[p].mesh=v,i.addMeshToOctantMap(s,d,new r.BatchedCapsuleObject(d,v)),g=null,v=null}}o.updateMatrixWorld(!0),e.dispatchEvent({type:r.EVENTS.ON_LOAD_PROGRESS,progress:{total:e.getLoader().maxLoadTaskCount,loaded:e.getLoader().maxLoadTaskCount}}),t&&t()}createMeshNodes(e,t){e.getModelDescriptor().getStandardNodeInfos()?this._createGeometries(e,(function(){t&&t()})):t&&t()}applySelection(e){}clearSelection(e){}applyHover(e){}clearHover(e){}getMeshNode(){return this.mapMaterialIdToMergedNode}_disposeMergedGeometries(){for(var e in this.mapMaterialIdToMergedNode){for(var t=this.mapMaterialIdToMergedNode[e],i=0,r=t.length;i<r;i++){t[i].geometry.dispose(),delete t[i].geometry,delete t[i].indices,t[i].mesh&&(t[i].mesh._indicesGroup=null,delete t[i].mesh)}delete this.mapMaterialIdToMergedNode[e]}}_getMaterialKeyByNodeInfo(e,t){var i=e.materialId;if(t){var a=t.manager.getOverrideMaterialByNodeInfo(e,t.materialManager.getMaterialById(e.materialId));a&&(i=a.name,e.materialId=i)}return r.Utils.getCombinedKeyString([e.materialId,e.uv?"1":"0",e.type===r.ModelView.BaseDescriptor.EnumNodeItemType.LINE?"lines":"meshes"])}getPropertyValueByMaterialKey(e){var t=r.Utils.splitCombinedKeyString(e);return{materialId:t[0],uvProp:t[1],type:t[2]}}clearSelectedObjectIds(){this.selectedObjectIds.length=0}cacheSelectedObjectIds(e,t,i){this.selectedObjectIds.push({uid:e,mKey:t,idx:i})}adjustVisibility(e,t){var i=this._getNodeGroup(e),r=i.visible;r!=t&&(t&&!i.bVisible||(i.visible=t),i.bVisible=r)}changeVisibilityOfSelectedObjects(e,t){if(t)for(a=0,n=this.selectedMeshes.length;a<n;a++)for(c=this.selectedMeshes[a].object,m=0,f=(u=this.selectedMeshes[a].indices).length;m<f;m++){(g=c.geometry.groups[u[m].idx]).start=u[m].start,g.count=u[m].count}else{this.selectedMeshes.length=0;for(var i={},a=0,n=this.selectedObjectIds.length;a<n;a++)i[this.selectedObjectIds[a].mKey+"&"+this.selectedObjectIds[a].idx]=!0;for(var s=Object.keys(i),a=0,n=s.length;a<n;a++){for(var o=s[a].split("&"),l=o[0],d=o[1],h=this.mapMaterialIdToMergedNode[l][d],c=h.mesh,u=[],p=h.geometry.groups,m=0,f=p.length;m<f;m++){var g;(g=p[m]).materialIndex===r.Model.EnumFilterState.SELECTED&&(u.push({idx:m,start:g.start,count:g.count}),g.start=0,g.count=0)}u.length&&this.selectedMeshes.push({object:c,indices:u})}}}changeVisibilityOfNonSelectedObjects(e,t){if(t)for(a=0,n=this.nonSelectedMeshes.length;a<n;a++){c=this.nonSelectedMeshes[a].object;if(u=this.nonSelectedMeshes[a].indices)for(d=0,h=u.length;d<h;d++){(m=c.geometry.groups[u[d].idx]).start=u[d].start,m.count=u[d].count}else c.visible=this.nonSelectedMeshes[a].visibility}else{this.nonSelectedMeshes.length=0;for(var i={},a=0,n=this.selectedObjectIds.length;a<n;a++){var s=this.selectedObjectIds[a];i[s.mKey]||(i[s.mKey]={}),i[s.mKey][s.idx]=!0}for(var o in this.mapMaterialIdToMergedNode){var l=this.mapMaterialIdToMergedNode[o];if(i[o])for(var d=0,h=l.length;d<h;d++){var c=l[d].mesh;if(i[o][d]){var u=[],p=c.geometry.groups;for(a=0,n=p.length;a<n;a++){var m;(m=p[a]).materialIndex!==r.Model.EnumFilterState.SELECTED&&(u.push({idx:a,start:m.start,count:m.count}),m.start=0,m.count=0)}u.length?this.nonSelectedMeshes.push({object:c,indices:u}):(this.nonSelectedMeshes.push({object:c,indices:null,visibility:c.visible}),c.visible=!1)}else this.nonSelectedMeshes.push({object:c,indices:null,visibility:c.visible}),c.visible=!1}else for(var a=0,n=l.length;a<n;a++){var c=l[a].mesh;this.nonSelectedMeshes.push({object:c,indices:null,visibility:c.visible}),c.visible=!1}}}}restoreVisibilityOfObjects(){this.selectedMeshes.length=0,this.nonSelectedMeshes.length=0}getBlinkMaterials(){return this.blinkMaterials}disposeBufferAfterVbo(){if(!this.bufferDestroyed){var e=0;for(var t in this.mapMaterialIdToMergedNode)for(var i=this.mapMaterialIdToMergedNode[t],a=0,n=i.length;a<n;a++){var s=i[a],o=s.geometry;if(null!==o){e++;var l=t+"-"+a;this.mapDestroyedBufferKey[l]||s.mesh&&s.mesh.visible&&(this.mapDestroyedBufferKey[l]=!0,r.GlobalData.EnableSplitComponent?r.GeomUtil.disposeBufferFromGeometry(o,["normal","uv2"]):r.GeomUtil.disposeBufferFromGeometry(o,["normal","uv","uv2"]))}}Object.keys(this.mapDestroyedBufferKey).length===e&&(this.mapDestroyedBufferKey={},this.bufferDestroyed=!0)}}_traverseMeshNodeMap(e){for(var t in this.mapMaterialIdToMergedNode)for(var i=this.mapMaterialIdToMergedNode[t],r=0,a=i.length;r<a;r++)e&&e(t,i[r])}getGeometryBuffersByUserId(e,t){var i=[],r=e.getDatabagId(),a=this;return this._traverseMeshNodeMap((function(e,n){var s=n.indices[t];if(s)for(var o=n.geometry,l=o.getIndex().array,d=o.getAttribute("position").array,h=o.getAttribute("uv"),c=h?h.array:null,u="lines"===a.getPropertyValueByMaterialKey(e).type,p=0,m=s.length;p<m;p++){var f=s[p],g=f.indexStart,v=f.indexStart+f.indexCount,y=l.slice(g,v),M=null;c&&(v=(g=f.positionStart/3*2)+f.positionCount/3*2,M=c.slice(g,v)),g=f.positionStart,v=f.positionStart+f.positionCount;var E=d.slice(g,v);g/=3,y.forEach((function(e,t,i){i[t]-=g})),i.push({isLines:u,databagId:r,nodeId:f.nodeId,position:E,index:y,uv:M,matrix:n.matrix})}})),i}getPickingNodeGenerator(e){return e=null==e?"pick":e,this.pickingNodeGenerators||(this.pickingNodeGenerators={}),this.pickingNodeGenerators[e]||(this.pickingNodeGenerators[e]=new r.PickingBatchedMeshGenerator(this),this.pickingNodeGenerators[e].reserveMaterial=!!e.startsWith("glow")),this.pickingNodeGenerators[e]}}r.ModelView.BatchedMeshManager=e}(),r.ModelView.BatchedWireframeManager=class{constructor(e){this.manager=e,this.generated=!1,this.wireframeLineSegment=null,this.wireframeGeometryMap=null,this.userIdMapForNoWireFrame={}}destroy(){if(this.clearData(),this.manager=null,this.userIdMapForNoWireFrame=null,this.pickingNodeGenerators){for(var e in this.pickingNodeGenerators)this.pickingNodeGenerators.hasOwnProperty(e)&&this.pickingNodeGenerators[e].destroy();this.pickingNodeGenerators=null}}clearData(){if(this.generated=!1,this.bufferDestroyed=!1,this.wireframeLineSegment&&(this.wireframeLineSegment._indicesGroup=null,this.wireframeLineSegment.geometry.dispose(),this.wireframeLineSegment=null),this.pickingNodeGenerators)for(var e in this.pickingNodeGenerators)this.pickingNodeGenerators.hasOwnProperty(e)&&this.pickingNodeGenerators[e].clearData();this.wireframeGeometryMap=null,this.userIdMapForNoWireFrame={}}_createWireframeGeometry(e,t){if(this.wireframeGeometryMap||(this.wireframeGeometryMap={}),!this.wireframeGeometryMap[t.nodeId]){for(var i=e.attributes.position.array.slice(t.positionStart,t.positionStart+t.positionCount),a=e.getIndex().array.slice(t.indexStart,t.indexStart+t.indexCount),n=0,s=a.length;n<s;n++)a[n]-=t.positionStart/3;var o=r.BuildEdge(i,a),l=new THREE.BufferGeometry;l.setIndex(new THREE.Uint32BufferAttribute(o,1)),l.setAttribute("position",new THREE.BufferAttribute(Float32Array.from(i),3)),l._userId=t.userId,this.wireframeGeometryMap[t.nodeId]=l}}_createWireframeGeometries(e){var t=e.getFilter(),i=e.getModelDescriptor().getStandardNodeInfos();function r(e){var r=i[e];return r&&t.getWireFrameVisibilityCondition()?!!t._isRenderWithWireFrame(r[0]):!(r&&t._hasRenderWithBoardlineFilter()&&!t._isRenderWithBoardline(r[0]))}var a=this.manager.getMeshNode();for(var n in a)if("meshes"===this.manager.getPropertyValueByMaterialKey(n).type)for(var s=a[n],o=0,l=s.length;o<l;o++){var d=s[o],h=d.geometry;if(null!==h){var c=d.indices;for(var u in c){r(u)||(this.userIdMapForNoWireFrame[u]=!0);for(var p=c[u],m=0,f=p.length;m<f;m++)this._createWireframeGeometry(h,p[m])}}}return!0}_makeWireframe(e){var t={},i=e.getWireframeMaterial();for(var a in this.wireframeGeometryMap){var n=this.wireframeGeometryMap[a],s=n._userId,o=new THREE.LineSegments(n,i);o.name=s,o.nodeId=s,t[s]||(t[s]=[]),t[s].push(o),o=null}var l=[];for(var s in t)for(var d=t[s],h=0,c=d.length;h<c;h++)l.push(d[h]);if(l.length>0){var u={},p=r.GeomUtil.mergeBufferGeometries(l,u);p&&(this.wireframeLineSegment=new THREE.LineSegments(p,e.getWireframeMaterial()),this.wireframeLineSegment._indicesGroup=u)}for(var s in l=null,t)delete t[s];t=null,this.wireframeGeometryMap=null}generateWireframe(e,t){this.generated||(this._createWireframeGeometries(e),this._makeWireframe(e),this.generated=!0,t&&t())}update(e){if(this.manager.hasNodeInfo(e))if(e.isActivateWireframe()){if(this.wireframeLineSegment){var t=this._getNodeGroup(e);t.clear(),t.add(this.wireframeLineSegment),t.updateMatrixWorld(!0)}}else e._hasNodeGroup(r.ObjectGroupType.WIREFRAME)&&e._removeNodeGroup(r.ObjectGroupType.WIREFRAME)}rebuildIndices(e){if(this.needDealWireframeLine(e)){this.wireframeLineSegment.visible=!0;var t=this.wireframeLineSegment._indicesGroup,i=this.wireframeLineSegment.geometry;i.clearGroups();var r=e.getWireframeMaterial();this.wireframeLineSegment.material=r;var a=this.manager.getFilteredUserIdsForWireFrame(),n=!(!a||!Object.keys(a).length);if(this._existHiddenUserId()||n){var s,o,l=[],d=[];for(var h in t)if(!this._isHiddenUserId(h)){var c=t[h];if(c&&c.length>0){if(a[h]){var u=a[h],p=l.indexOf(u);for(-1===p&&(l.push(u),p=l.length-1),s=0,o=c.length;s<o;s++)d.push({indexStart:c[s].indexStart,indexCount:c[s].indexCount,state:1+p});continue}for(s=0,o=c.length;s<o;s++)d.push({indexStart:c[s].indexStart,indexCount:c[s].indexCount,state:0})}}if(0!==d.length){for(d.sort((function(e,t){return e.indexStart-t.indexStart})),s=0,o=d.length;s<o;s++){var m=d[s].indexStart,f=d[s].indexCount,g=d[s].state;if(0===s)i.addGroup(m,f,g);else{var v=d[s-1].indexStart,y=d[s-1].indexCount;g===d[s-1].state&&m===v+y?i.groups[i.groups.length-1].count+=f:i.addGroup(m,f,g)}}var M=e.getFilter(),E=[r];for(s=0,o=l.length;s<o;s++){var b=M._getMaterialByName(l[s]);E.push(b)}this.wireframeLineSegment.material=E}else this.wireframeLineSegment.visible=!1}}}explode(e){if(this.wireframeLineSegment){var t=this.wireframeLineSegment._indicesGroup,i=this.wireframeLineSegment.geometry;for(var r in t){var a=t[r];if(a)for(var n=e.modelExplosion.getExplosionTranslation(r),s=0,o=a.length;s<o;s++){var l=a[s].indexStart;d(i,l,l+a[s].indexCount,n)}}}function d(e,t,i,r){for(var a=e.getAttribute("position").array,n=e.getIndex().array,s={},o=t;o<i;o++){var l=n[o];s[l]||(a[3*l]+=r.x,a[3*l+1]+=r.y,a[3*l+2]+=r.z,s[l]=!0)}e.getAttribute("position").needsUpdate=!0,s=null}}_getNodeGroup(e){return e._getNodeGroup(r.ObjectGroupType.WIREFRAME,{globalSpace:!0})}needDealWireframeLine(e){return!(!e.isActivateWireframe()||!this.wireframeLineSegment)}adjustVisibility(e,t){if(this.needDealWireframeLine(e)){var i=this._getNodeGroup(e),r=i.visible;r!=t&&(t&&!i.bVisible||(i.visible=t),i.bVisible=r)}}changeVisibilityOfSelectedObjects(e,t){}changeVisibilityOfNonSelectedObjects(e,t){this.adjustVisibility(e,t)}restoreVisibilityOfObjects(){}disposeBufferAfterVbo(){this.generated&&!this.bufferDestroyed&&this.wireframeLineSegment&&this.wireframeLineSegment.visible&&(this.bufferDestroyed=!0,r.GeomUtil.disposeBufferFromGeometry(this.wireframeLineSegment.geometry,["normal","uv","uv2"]))}_existHiddenUserId(){var e=this.manager.getHiddenUserIds();return!!(this.userIdMapForNoWireFrame&&Object.keys(this.userIdMapForNoWireFrame).length||e&&Object.keys(e).length)}_isHiddenUserId(e){if(this.userIdMapForNoWireFrame[e])return!0;var t=this.manager.getHiddenUserIds();return!(!t||!t[e])}getWireFrameLineSegments(){return this.wireframeLineSegment?[this.wireframeLineSegment]:null}getPickingNodeGenerator(e){return e=null==e?"pick":e,this.pickingNodeGenerators||(this.pickingNodeGenerators={}),this.pickingNodeGenerators[e]||(this.pickingNodeGenerators[e]=new r.PickingBatchedWireFrameGenerator(this)),this.pickingNodeGenerators[e]}},r.ModelView.BatchedManager=class{constructor(e,t){this.meshManager=new r.ModelView.BatchedMeshManager(this,t),this.wireframeManager=e?new r.ModelView.DataBatchedWireframeManager(this):new r.ModelView.BatchedWireframeManager(this)}destroy(){this.meshManager.destroy(),this.meshManager=null,this.wireframeManager.destroy(),this.wireframeManager=null,this._clearFilteredState(),this._clearSelectedState(),this._clearHoveredState(),this._clearBlinkedState()}updateNodes(e){this.meshManager.update(e),this.wireframeManager.update(e)}generateWireframe(e,t){this.wireframeManager.generateWireframe(e,t)}asyncGenerateWireframe(e,t){this.wireframeManager.asyncGenerateWireframe(e,t)}rebuildIndices(e){this._rebuildIndices(e)}clearData(){this.meshManager.clearData(),this.wireframeManager.clearData(),this._clearFilteredState(),this._clearSelectedState(),this._clearHoveredState(),this._clearBlinkedState()}createMeshNodes(e,t){this.meshManager.createMeshNodes(e,t)}asyncCreateMeshNodes(e,t,i){this.meshManager.asyncCreateMeshNodes(e,t,i)}hasNodeInfo(e){return!!e.getModelDescriptor().getStandardNodeInfos()}disposeGeometry(e){this.meshManager.disposeGeometry(e)}getMeshNode(){return this.meshManager.getMeshNode()}getPropertyValueByMaterialKey(e){return this.meshManager.getPropertyValueByMaterialKey(e)}getFilteredUserIds(){return this.mapMaterialIdToUserIdsForFilter}getSelectedUserIds(){return this.mapMaterialIdToUserIdsForSelection}getHoveredUserIds(){return this.mapMaterialIdToUserIdsForHover}getBlinkedUserIds(){return this.mapBlinkUserIds}getHiddenUserIds(){return this.hiddenUserIdSetObject}getTransparentUserIds(){return this.transparentUserIdSetObject}applyFilter(e,t){if(this.hasNodeInfo(e)){var i;i=t||e.getModelDescriptor().getStandardUserIds();var r=e.getModelDescriptor().getStandardNodeInfos();this._collectFilteredUserIds(e,i,r),this._collectFilteredUserIdsForWireFrame(e,i,r),this._collectSelectedUserIds(e.manager.sceneState.selectionSet,r),this._collectHoveredUserIds(e.manager.sceneState.hoverId,r),this._rebuildIndices(e),this.updateNodes(e)}}applySelection(e){if(this.hasNodeInfo(e)){var t=e.getModelDescriptor().getStandardNodeInfos();this._clearSelectedState(e),this._clearHoveredState(e),this._collectSelectedUserIds(e.manager.sceneState.selectionSet,t),this._collectHoveredUserIds(e.manager.sceneState.hoverId,t),this._rebuildIndices(e),this.updateNodes(e)}}clearSelection(e){this._clearSelectedState(e),this.applyHover(e)}applyHover(e){if(this.hasNodeInfo(e)){var t=e.getModelDescriptor().getStandardNodeInfos();this._clearHoveredState(e),this._collectHoveredUserIds(e.manager.sceneState.hoverId,t),this._rebuildIndices(e),this.updateNodes(e)}}clearHover(e){this._clearHoveredState(e),this._rebuildIndices(e),this.updateNodes(e)}applyBlink(e){if(this.hasNodeInfo(e)){var t=e.getModelDescriptor().getStandardNodeInfos();this._clearBlinkedState(e),this._clearHoveredState(e),this._collectBlinkedUserIds(e.manager.sceneState.getBlinkComponentsIdMap(e.id),t),this._collectHoveredUserIds(e.manager.sceneState.hoverId,t),this._rebuildIndices(e),this.updateNodes(e)}}clearBlink(e){this._clearBlinkedState(e),this.applyHover(e)}applyReplacement(e){this._rebuildIndices(e),this.updateNodes(e)}_collectFilteredUserIds(e,t,i){var a=e.getFilter(),n=a._hasHiddenFileIdFilter(),s=a._hasVisibleFilter(),o=a._hasOverrideMaterialFilter(),l=a._hasTransparentFilter(),d=e.hasReplacedUserId(),h=e.hasHiddenSourceObjectUserId(),c=this.mapMaterialIdToUserIdsForFilter={};if(this.hiddenUserIdSetObject={},this.overrideUserIdSetObject={},this.transparentUserIdSetObject={},n||s||o||l||d||h)for(var u=0;u<t.length;++u){var p=t[u],m=i[p];if(m&&m.length)for(var f=0,g=m.length;f<g;f++){var v=m[f];if(n&&a._isHiddenFileId(v)||s&&!1===a._isVisible(v)||e.isReplacedUserId(p)||e.isHiddenSourceObjectUserId(p))void 0===c[v.materialId]&&(c[v.materialId]={}),void 0===c[v.materialId][r.Model.EnumFilterState.HIDDEN]&&(c[v.materialId][r.Model.EnumFilterState.HIDDEN]={}),c[v.materialId][r.Model.EnumFilterState.HIDDEN][p]=!0,this.hiddenUserIdSetObject[p]=!0;else if(l&&a._isTransparent(v))void 0===c[v.materialId]&&(c[v.materialId]={}),void 0===c[v.materialId][r.Model.EnumFilterState.TRANSPARENT]&&(c[v.materialId][r.Model.EnumFilterState.TRANSPARENT]={}),c[v.materialId][r.Model.EnumFilterState.TRANSPARENT][p]=!0,this.transparentUserIdSetObject[p]=!0;else if(o&&a._hasOverrideMaterial(v)){var y=a._getOverrideMaterial(v),M=null!=y?y.name:"";""!==M&&(void 0===c[v.materialId]&&(c[v.materialId]={}),void 0===c[v.materialId][r.Model.EnumFilterState.OVERRIDED]&&(c[v.materialId][r.Model.EnumFilterState.OVERRIDED]={}),c[v.materialId][r.Model.EnumFilterState.OVERRIDED][p]=M,this.overrideUserIdSetObject[p]=M)}}}}_collectFilteredUserIdsForWireFrame(e,t,i){var r=e.getFilter(),a=r._hasOverrideMaterialFilterForWireFrame();if(this.mapFilteredUserIdsForWireFrame={},a)for(var n=0;n<t.length;++n){var s=t[n];if(!this.hiddenUserIdSetObject[s]){var o=i[s];if(o&&o.length)for(var l=0,d=o.length;l<d;l++){var h=o[l];if(r._hasOverrideMaterialForWireFrame(h)){var c=r._getOverrideMaterialForWireFrame(h),u=null!=c?c.name:"";""!==u&&(this.mapFilteredUserIdsForWireFrame[s]=u)}}}}}_clearFilteredState(){this.mapMaterialIdToUserIdsForFilter=null}_collectSelectedUserIds(e,t){var i=this.mapMaterialIdToUserIdsForSelection={};for(var r in e){var a=t[r];if(a&&a.length)for(var n=0,s=a.length;n<s;n++)void 0===i[a[n].materialId]&&(i[a[n].materialId]={}),void 0===i[a[n].materialId][r]&&(i[a[n].materialId][r]=!0)}}_clearSelectedState(){this.mapMaterialIdToUserIdsForSelection&&(this.mapMaterialIdToUserIdsForSelection=null)}_collectHoveredUserIds(e,t){var i=this.mapMaterialIdToUserIdsForHover={};if(e&&t[e])for(var r=t[e],a=0,n=r.length;a<n;a++)void 0===i[r[a].materialId]&&(i[r[a].materialId]={}),void 0===i[r[a].materialId][e]&&(i[r[a].materialId][e]=!0)}_clearHoveredState(){this.mapMaterialIdToUserIdsForHover&&(this.mapMaterialIdToUserIdsForHover=null)}_collectBlinkedUserIds(e,t){var i=this.mapBlinkUserIds={};for(var r in e){var a=t[r];if(a&&a.length)for(var n=0,s=a.length;n<s;n++)void 0===i[a[n].materialId]&&(i[a[n].materialId]={}),void 0===i[a[n].materialId][r]&&(i[a[n].materialId][r]=!0)}}clearClippingIdsForBox(){this.meshManager.clearClippingIdsForBox()}calculateClippingIds(e,t,i,r){this.meshManager.calculateClippingIds(e,t,i,r)}calculateClippingContours(e,t,i,r,a,n){this.meshManager.calculateClippingContours(e,t,i,r,a,n)}_clearBlinkedState(){this.mapBlinkUserIds&&(this.mapBlinkUserIds=null)}_rebuildIndices(e){this.meshManager.rebuildIndices(e),this.wireframeManager.rebuildIndices(e)}clearCachedData(){this.meshManager.clearAllNodeBuffer()}getMeshesByUserIds(e,t,i){this.meshManager.getMeshesByUserIds(e,t,i)}adjustVisibility(e,t){this.meshManager.adjustVisibility(e,t),this.wireframeManager.adjustVisibility(e,t)}changeVisibilityOfSelectedObjects(e,t){this.meshManager.changeVisibilityOfSelectedObjects(e,t),this.wireframeManager.changeVisibilityOfSelectedObjects(e,t)}changeVisibilityOfNonSelectedObjects(e,t){this.meshManager.changeVisibilityOfNonSelectedObjects(e,t),this.wireframeManager.changeVisibilityOfNonSelectedObjects(e,t)}restoreVisibilityOfObjects(){this.meshManager.restoreVisibilityOfObjects(),this.wireframeManager.restoreVisibilityOfObjects()}disposeBufferAfterVbo(){this.meshManager.disposeBufferAfterVbo(),this.wireframeManager.disposeBufferAfterVbo()}getGeometryBuffersByUserId(e,t){return this.meshManager.getGeometryBuffersByUserId(e,t)}explode(e){this.meshManager.explode(e),this.wireframeManager.explode(e)}isPickableNode(e){var t=this.getHiddenUserIds();if(t&&t[e])return!1;var i=this.getTransparentUserIds();return!i||!i[e]}isHiddenNode(e){var t=this.getHiddenUserIds();return!(!t||!t[e])}getMeshManager(){return this.meshManager}getWireFrameManager(){return this.wireframeManager}getFilteredUserIdsForWireFrame(){return this.mapFilteredUserIdsForWireFrame}},function(){class e extends r.ModelView.BatchedBaseHandler{constructor(e,t){super(e),this.defaultManager=new r.ModelView.BatchedManager(t),this.instancedManager=new r.ModelView.InstancedManager,this.loader=new r.ModelView.BatchedLoader(this)}}r.ModelView.BatchedHandler=e}(),function(){class e extends r.ModelView.BaseLoader{constructor(e,t){super(e),this.version=t,this.descriptor=null,this.enableBmpkMerged=!1,this.bmpkPkgIndex=null}praseBmpkPkgIndex(e){var t=this,i=this.url,a=this.fileLoader;t.bmpkPkgIndex={};const n=i.bmpkPkgIndexUrl();r.Storage.IndexedDBHelper.loadWithStorage("ModelData",n,(()=>new Promise(((e,t)=>{a.setResponseType("json"),a.load(n,e,void 0,t)}))),(i=>{for(var r in i.bmpks){var a=i.bmpks[r],n=parseInt(r.substring(5,r.length));for(var s in t.bmpkPkgIndex[n]={},a)t.bmpkPkgIndex[n][s]=a[s]}t._loadAllMpks(e)}))}loadSceneAndMpks(e){var t=this;e.bmpk_merged&&(t.enableBmpkMerged=!0),t.url.mpkUrl=t.url.bmpkUrl,e.symbol?this._loadSymbol((function(){t._loadScene(0)})):t._loadScene(0),t._loadBMpkIndex(),e.lines&&t._loadLine(),e.bmpks&&(t.enableBmpkMerged?t.praseBmpkPkgIndex(e.bmpks):t._loadAllMpks(e.bmpks)),r.GlobalData.BorderLineDelayLoaded||t._loadAllBorderlines(e)}getSceneTaskCount(e){var t=2;return t+=e.symbol,t+=e.lines,t+=e.bmpks,r.GlobalData.BorderLineDelayLoaded||(t+=this.getAllBorderlineCount()),t}_loadBMpkIndex(){var e=this,t=this.url,i=this.fileLoader;const a=t.bmpkIndexUrl();r.Storage.IndexedDBHelper.loadWithStorage("ModelData",a,(()=>new Promise(((e,t)=>{i.setResponseType("arraybuffer"),i.load(a,e,void 0,t)}))),(t=>{e._paserBMeshId(t),e._onTaskFinished()}),(t=>{e.model.dispatchEvent({type:r.LOADERROREVENTS.LOAD_ERROR,errorType:r.LOADERROREVENTS.LOAD_USERID_ERROR,event:t}),e._onTaskFinished()}))}_paserBMeshId(e){this.descriptor.bmeshIdReader=new r.Loader.BMeshIdReader(e)}_parseReferencedMeshBufferData(e,t,i,a,n,s){var o=[],l=this.model.getVersion();r.Compatibility.isUseMergeTextureOptimize(l)||n&&i>0&&(s=e.hasUV(t));for(var d=void 0!==s?!s:void 0,h=t;h<i;++h){var c=e.getOffsetIndexInfo(h,d);c&&o.push(c)}var u=o.length,p=4*o[0].positionStart,m=4*(o[u-1].positionStart+o[u-1].positionCount),f=e.vBuffer.slice(p,m),g=4*o[0].indexStart,v=4*(o[u-1].indexStart+o[u-1].indexCount),y=e.iBuffer.slice(g,v);if(n){var M=new Uint32Array(y),E=o[0].positionStart/3;M.forEach((function(e,t,i){i[t]-=E})),y=M}var b,I=e.getMeshData(t).nOffset,x=e.getMeshData(i-1).nOffset+3*e.getMeshData(i-1).ptCount*4,T=e.nBuffer.slice(I,x);if(d)b=null;else if(n){var _=4*o[0].uvStart,S=4*(o[u-1].uvStart+o[u-1].uvCount);b=e.tBuffer.slice(_,S)}else b=e.tBuffer.slice();var C=o[0].positionStart,w=o[0].indexStart,R=o[0].uvStart;if(0!=C)for(h=0;h<u;++h)o[h].positionStart-=C,o[h].indexStart-=w,o[h].uvStart-=R;this.descriptor.cacheReferencedMeshBufferData(a,{P:f,I:y,N:T,UV:b,IndexInfos:o,mpkMatrix:e.getMatrix()})}_parseMpk(e,t){var i=new r.Loader.BMPKReader(e,this.version),a=this;if(a.enableBmpkMerged){var n=65536*t;if(t in a.bmpkPkgIndex){var s=Object.keys(a.bmpkPkgIndex[t]).length;if(1===s)a._parseReferencedMeshBufferData(i,0,i.header.meshCount,n);else{for(var o,l=a.bmpkPkgIndex[t],d=0,h=1;h<=s-1;h++){var c=l[h].mesh_index;if(d!==c){var u=n+d;o=l[h-1].texture,a._parseReferencedMeshBufferData(i,d,c,u,!0,o),d=c}}d=l[s-1].mesh_index,o=l[s-1].texture;u=n+d;a._parseReferencedMeshBufferData(i,d,i.header.meshCount,u,!0,o)}}else a._parseReferencedMeshBufferData(i,0,i.header.meshCount,n)}else a._parseReferencedMeshBufferData(i,0,i.header.meshCount,t);i=null}}r.ModelView.DataBatchedBaseLoader=e}(),function(){class e extends r.ModelView.DataBatchedBaseLoader{constructor(e,t){super(e,t),this.descriptor=new r.ModelView.DataBatchedDescriptor}}r.ModelView.DataBatchedLoader=e}(),function(){class e extends r.ModelView.DefaultDescriptor{constructor(){super(),this.bmeshIdReader=null}destroy(){super.destroy(),this.bmeshIdReader=null}convertGeometryId(e){var t=this.bmeshIdReader.getBMeshId(e);return void 0===t&&(t=e),t}}r.ModelView.DataBatchedDescriptor=e}(),r.ModelView.DataBatchedWireframeManager=class{constructor(e){this.manager=e,this.generated=!1,this.wireframeLineSegments=[],this.parameterizedShapeWireframeBufferMap={},this.userIdMapForNoWireFrame={},this.processedThresholdPerShared=1e3,this.splitSegmentEnabled=!0,this.splitCountPerSegment=1e4}destroy(){this.manager=null,this.userIdMapForNoWireFrame=null;for(var e=0,t=this.wireframeLineSegments.length;e<t;e++)this.wireframeLineSegments[e]._indicesGroup=null,this.wireframeLineSegments[e].geometry.dispose(),this.wireframeLineSegments[e]=null;if(this.wireframeLineSegments=null,this.pickingNodeGenerators){for(var i in this.pickingNodeGenerators)this.pickingNodeGenerators.hasOwnProperty(i)&&this.pickingNodeGenerators[i].destroy();this.pickingNodeGenerators=null}this.parameterizedShapeWireframeBufferMap=null}clearData(){this.generated=!1,this.userIdMapForNoWireFrame={};for(var e=0,t=this.wireframeLineSegments.length;e<t;e++)this.wireframeLineSegments[e]._indicesGroup=null,this.wireframeLineSegments[e].geometry.dispose(),this.wireframeLineSegments[e]=null;if(this.wireframeLineSegments=[],this.pickingNodeGenerators)for(var i in this.pickingNodeGenerators)this.pickingNodeGenerators.hasOwnProperty(i)&&this.pickingNodeGenerators[i].clearData()}_needWireframing(e,t){var i=e.getFilter(),r=e.getModelDescriptor().getStandardNodeInfos();return!(!r||!r[t.userId]||(i.getWireFrameVisibilityCondition()?!i._isRenderWithWireFrame(t):i._hasRenderWithBoardlineFilter()&&!i._isRenderWithBoardline(t)))}_getWireframeBufferByIdForParameterizedShape(e,t){var i=this.parameterizedShapeWireframeBufferMap;if(i[e])return i[e];i[e]=[];for(var a=0,n=t.length;a<n;a++){var s=t[a];i[e].push({index:r.BuildEdge(s.attributes.position.array,s.index.array),position:s.attributes.position.array})}return i[e]}_dealWireframesForParameterizedShape(e){if(!r.GlobalData.Instance){for(var t=e.getModelDescriptor().getNodeInfosWithParameterizedDesc(),i={},a=e.getWireframeMaterial(),n=Object.keys(t),s=0,o=n.length;s<o;s++)for(var l=t[n[s]],d=0,h=l.length;d<h;d++){var c=l[d];this._needWireframing(e,c)||(this.userIdMapForNoWireFrame[c.userId]=!0);var u=this.manager.meshManager.getGeometryByNodeInfo(e,c);u instanceof Array||(u=[u]);for(var p=this._getWireframeBufferByIdForParameterizedShape(c.geometryId,u),m=0,f=p.length;m<f;m++){var g=p[m].index,v=p[m].position.slice();r.GeomUtil.applyMatrix4ToBuffer(c.matrix,v);var y=new THREE.BufferGeometry;y.setIndex(new THREE.Uint32BufferAttribute(g,1)),y.setAttribute("position",new THREE.BufferAttribute(v,3));var M=new THREE.LineSegments(y,a);M.name=c.userId,M.nodeId=c.userId,M.materialId=c.materialId,i[c.userId]||(i[c.userId]=[]),i[c.userId].push(M)}}var E=[];for(var b in i)for(var I=i[b],x=(m=0,I.length);m<x;m++)E.push(I[m]);if(E.length>0){var T={},_=r.GeomUtil.mergeBufferGeometries(E,T);if(_){var S=new THREE.LineSegments(_,a);S._indicesGroup=T,this.wireframeLineSegments.push(S)}}}}_dealSharedBorderLines(e){const t=e._config.metadata.version;var i=e.getModelDescriptor().getSharedBorderLineCache();if(i){for(var a=e.getModelDescriptor().getStandardNodeInfosOnGeometryId(),n={},s=e.getWireframeMaterial(),o=this.processedThresholdPerShared,l=0,d=i.length;l<d;l++)for(var h=i[l],c=h.IndexInfos,u=0,p=c.length;u<p;u++){var m=c[u],f=a[e.getModelDescriptor().convertGeometryId(m.meshId)];if(f&&!(f.length>o)){var g=new Uint32Array(h.I),v=new Float32Array(h.P);r.Compatibility.isUseDoubleMatrixMPKHeader(t);for(var y=0,M=f.length;y<M;y++){var E=f[y];this._needWireframing(e,E)||(this.userIdMapForNoWireFrame[E.userId]=!0);var b=v.slice(m.positionStart,m.positionStart+m.positionCount),I=m.positionStart/3,x=g.slice(m.indexStart,m.indexStart+m.indexCount);x.forEach((function(e,t,i){i[t]-=I})),r.GeomUtil.applyMatrix4ToBuffer(E.matrix,b);var T=new THREE.BufferGeometry;T.setIndex(new THREE.Uint32BufferAttribute(x,1)),T.setAttribute("position",new THREE.BufferAttribute(b,3));var _=new THREE.LineSegments(T,s);_.name=E.userId,_.nodeId=E.userId,_.materialId=E.materialId,n[E.userId]||(n[E.userId]=[]),n[E.userId].push(_)}}}var S=[];for(var C in n)for(var w=n[C],R=(u=0,w.length);u<R;u++)S.push(w[u]);if(!(S.length<1))if(this.splitSegmentEnabled){var B=this.splitCountPerSegment,L=Math.floor(S.length/B),O=S.length%B;for(u=0;u<L;u++){var P=S.slice(u*B,(u+1)*B),D={};if(N=r.GeomUtil.mergeBufferGeometries(P,D)){var A=new THREE.LineSegments(N,s);r.Compatibility.isUseDoubleMatrixMPKHeader(t),A._indicesGroup=D,this.wireframeLineSegments.push(A)}}O&&(P=S.slice(L*B,L*B+O),D={},(N=r.GeomUtil.mergeBufferGeometries(P,D))&&(A=new THREE.LineSegments(N,s),r.Compatibility.isUseDoubleMatrixMPKHeader(t),A._indicesGroup=D,this.wireframeLineSegments.push(A)))}else{var N;D={},(N=r.GeomUtil.mergeBufferGeometries(S,D))&&((A=new THREE.LineSegments(N,s))._indicesGroup=D,this.wireframeLineSegments.push(A))}}}_dealUniqueBorderLines(e){var t=e.getModelDescriptor().getUniqueBorderLineCache();if(t)for(var i=e.getModelDescriptor().getStandardNodeInfosOnGeometryId(),r={},a=0,n=t.length;a<n;a++){for(var s=t[a],o=s.IndexInfos,l=0,d=o.length;l<d;l++){var h=o[l],c=i[e.getModelDescriptor().convertGeometryId(h.meshId)];if(c)for(var u=0,p=c.length;u<p;u++){var m,f,g=c[u];r[g.userId]||(r[g.userId]=[]),this._needWireframing(e,g)||(this.userIdMapForNoWireFrame[g.userId]=!0),m=h.indexStart,f=h.indexCount,r[g.userId].push({nodeId:g.nodeId,indexStart:m,indexCount:f,materialId:g.materialId})}}var v=new THREE.BufferGeometry;v.setIndex(new THREE.Uint32BufferAttribute(new Uint32Array(s.I),1)),v.setAttribute("position",new THREE.BufferAttribute(new Float32Array(s.P),3));var y=new THREE.LineSegments(v,e.getWireframeMaterial());y._indicesGroup=r,s.mpkMatrix&&y.matrix.copy(s.mpkMatrix),y.matrixAutoUpdate=!1,y.updateMatrixWorld(!0),this.wireframeLineSegments.push(y)}}_createWireframeGeometries(e){this._dealWireframesForParameterizedShape(e),this._dealUniqueBorderLines(e),this._dealSharedBorderLines(e)}generateWireframe(e,t){e.isActivateWireframe()&&(this.generated||(this._createWireframeGeometries(e),this.generated=!0))}_asyncDealSharedBorderLines(e,t){var i=e.getModelDescriptor().getSharedBorderLineCache();if(i)for(var a=e.getModelDescriptor().getStandardNodeInfosOnGeometryId(),n={},s=e.getWireframeMaterial(),o=i.length,l=0,d=this,h=0;h<o;h++){var c=i[h];r.Utils.asyncProcess(c,c.IndexInfos.length,10,(function(t,i){var o=t,l=o.IndexInfos[i],h=e.getModelDescriptor().convertGeometryId(l.meshId),c=a[h];if(c)for(var u=new Uint32Array(o.I),p=new Float32Array(o.P),m=0,f=c.length;m<f;m++){var g=c[m];d._needWireframing(e,g)||(d.userIdMapForNoWireFrame[g.userId]=!0);var v=p.slice(l.positionStart,l.positionStart+l.positionCount),y=l.positionStart/3,M=u.slice(l.indexStart,l.indexStart+l.indexCount);M.forEach((function(e,t,i){i[t]-=y})),r.GeomUtil.applyMatrix4ToBuffer(g.matrix,v);var E=new THREE.BufferGeometry;E.setIndex(new THREE.Uint32BufferAttribute(M,1)),E.setAttribute("position",new THREE.BufferAttribute(v,3));var b=new THREE.LineSegments(E,s);b.name=g.userId,b.nodeId=g.userId,n[g.userId]||(n[g.userId]=[]),n[g.userId].push(b)}}),(function(){if(++l===o){var e=[];for(var i in n)for(var a=n[i],h=0,c=a.length;h<c;h++)e.push(a[h]);if(e.length>0){var u={},p=r.GeomUtil.mergeBufferGeometries(e,u);if(p){var m=new THREE.LineSegments(p,s);m._indicesGroup=u,d.wireframeLineSegments.push(m)}}t&&t()}}))}else t&&t()}_asyncDealUniqueBorderLines(e,t){var i=e.getModelDescriptor().getUniqueBorderLineCache();if(i)for(var a=e.getModelDescriptor().getStandardNodeInfosOnGeometryId(),n={},s=this,o=0,l=i.length,d=0;d<l;d++){var h=i[d];r.Utils.asyncProcess(h,h.IndexInfos.length,10,(function(t,i){var r=t.IndexInfos[i],o=e.getModelDescriptor().convertGeometryId(r.meshId),l=a[o];if(l)for(var d=0,h=l.length;d<h;d++){var c,u,p=l[d];n[p.userId]||(n[p.userId]=[]),s._needWireframing(e,p)||(s.userIdMapForNoWireFrame[p.userId]=!0),c=r.indexStart,u=r.indexCount,n[p.userId].push({nodeId:p.nodeId,indexStart:c,indexCount:u})}}),(function(i){o++;var r=i,a=new THREE.BufferGeometry;a.setIndex(new THREE.Uint32BufferAttribute(new Uint32Array(r.I),1)),a.setAttribute("position",new THREE.BufferAttribute(new Float32Array(r.P),3));var d=new THREE.LineSegments(a,e.getWireframeMaterial());d._indicesGroup=n,s.wireframeLineSegments.push(d),o===l&&t&&t()}))}else t&&t()}_asyncCreateWireframeGeometries(e,t){var i=this;this._dealWireframesForParameterizedShape(e),this._asyncDealUniqueBorderLines(e,(function(){i._asyncDealSharedBorderLines(e,(function(){t&&t()}))}))}asyncGenerateWireframe(e,t){e.isActivateWireframe()&&(this.generated||(this._asyncCreateWireframeGeometries(e,t),this.generated=!0))}update(e){if(this.manager.hasNodeInfo(e))if(e.isActivateWireframe()){if(this.wireframeLineSegments.length){var t=this._getNodeGroup(e);t.clear();for(var i=0,a=this.wireframeLineSegments.length;i<a;i++)t.add(this.wireframeLineSegments[i]);t.updateMatrixWorld(!0)}}else e._hasNodeGroup(r.ObjectGroupType.WIREFRAME)&&e._removeNodeGroup(r.ObjectGroupType.WIREFRAME)}rebuildIndicesForLineSegment(e,t){t.visible=!0;var i=t._indicesGroup,r=t.geometry;r.clearGroups();var a=e.getWireframeMaterial();t.material=a;var n,s,o=this.manager.getFilteredUserIdsForWireFrame(),l=null;(E=e.getFilter())&&(l=E.getLocalClippingList());var d=[],h=[];for(var c in i)if(!this._isHiddenUserId(c)){var u=i[c];if(u&&u.length>0){if(l&&l[c]){var p="localClipping|"+c;o&&o[c]&&(p+="|override|"+o[c]),d.push(p);var m=d.length-1;for(n=0,s=u.length;n<s;n++)h.push({indexStart:u[n].indexStart,indexCount:u[n].indexCount,state:1+m});continue}if(o&&o[c]){for(p=o[c],-1===(m=d.indexOf(p))&&(d.push(p),m=d.length-1),n=0,s=u.length;n<s;n++)h.push({indexStart:u[n].indexStart,indexCount:u[n].indexCount,state:1+m});continue}for(n=0,s=u.length;n<s;n++)h.push({indexStart:u[n].indexStart,indexCount:u[n].indexCount,state:0})}}if(0!==h.length){for(h.sort((function(e,t){return e.indexStart-t.indexStart})),n=0,s=h.length;n<s;n++){var f=h[n].indexStart,g=h[n].indexCount,v=h[n].state;if(0===n)r.addGroup(f,g,v);else{var y=h[n-1].indexStart,M=h[n-1].indexCount;v===h[n-1].state&&f===y+M?r.groups[r.groups.length-1].count+=g:r.addGroup(f,g,v)}}var E=e.getFilter(),b=[a];for(n=0,s=d.length;n<s;n++){var I,x=d[n].split("|");if("localClipping"==x[0]){var T=l[x[1]].wireframeMaterialName,_=E.getMaterialForClipBy(T);if(x[2]&&"override"==x[2]){var S=T+x[2]+x[3];I=E.getMaterialForClipBy(S,_);var C=E._getMaterialByName(x[3]);I.copy(C)}else I=_;I.clippingPlanes=_.clippingPlanes}else I=E._getMaterialByName(d[n]);b.push(I)}t.material=b}else t.visible=!1}rebuildIndices(e){if(this.needDealWireframeLine(e))for(var t=0,i=this.wireframeLineSegments.length;t<i;t++)this.rebuildIndicesForLineSegment(e,this.wireframeLineSegments[t])}_getNodeGroup(e){return e._getNodeGroup(r.ObjectGroupType.WIREFRAME,{globalSpace:!0})}needDealWireframeLine(e){return!!(e.isActivateWireframe()&&this.wireframeLineSegments&&this.wireframeLineSegments.length)}adjustVisibility(e,t){if(this.needDealWireframeLine(e)){var i=this._getNodeGroup(e),r=i.visible;r!=t&&(t&&!i.bVisible||(i.visible=t),i.bVisible=r)}}changeVisibilityOfSelectedObjects(e,t){}changeVisibilityOfNonSelectedObjects(e,t){this.adjustVisibility(e,t)}restoreVisibilityOfObjects(){}disposeBufferAfterVbo(){this.generated&&!this.bufferDestroyed&&this.wireframeLineSegment&&(this.bufferDestroyed=!0,r.GeomUtil.disposeBufferFromGeometry(this.wireframeLineSegment.geometry,["position","normal","uv","uv2"]))}explode(e){for(var t=0,i=this.wireframeLineSegments.length;t<i;t++){function u(e,t,i,r){for(var a=e.getAttribute("position").array,n=e.getIndex().array,s={},o=t;o<i;o++){var l=n[o];s[l]||(a[3*l]+=r.x,a[3*l+1]+=r.y,a[3*l+2]+=r.z,s[l]=!0)}e.getAttribute("position").needsUpdate=!0,s=null}var r=this.wireframeLineSegments[t],a=r._indicesGroup,n=r.geometry;for(var s in a){var o=a[s];if(o)for(var l=e.modelExplosion.getExplosionTranslation(s),d=0,h=o.length;d<h;d++){var c=o[d].indexStart;u(n,c,c+o[d].indexCount,l)}}}}_isHiddenUserId(e){if(this.userIdMapForNoWireFrame[e])return!0;var t=this.manager.getHiddenUserIds();return!(!t||!t[e])}getWireFrameLineSegments(){return this.wireframeLineSegments}getPickingNodeGenerator(e){return e=null==e?"pick":e,this.pickingNodeGenerators||(this.pickingNodeGenerators={}),this.pickingNodeGenerators[e]||(this.pickingNodeGenerators[e]=new r.PickingBatchedWireFrameGenerator(this)),this.pickingNodeGenerators[e]}},function(){class e extends r.ModelView.ModelBaseHandler{constructor(e){super(e),this.tag="merge_data",this.defaultManager=null,this.instancedManager=null,this.loader=null}prepare(e,t){if(this.isLoaded()&&!this.isHidden()){this.prepareWireframe(this.model,t);var i=this.model.getMaterialManager().lastTextureEnabled;this.model.getMaterialManager()._updateTextureMapping(this.model,t),!this.model.lightmap||this.model.enableLightmap==r.GlobalData.EnableLightmap&&this.model.lightmapIntensity==r.GlobalData.LightmapIntensity&&i==r.GlobalData.EnableTextureMapping||(this.model.enableLightmap=r.GlobalData.EnableLightmap,this.model.lightmapIntensity=r.GlobalData.LightmapIntensity,this.rebuildIndicesforLightmap(),this.updateNodes())}}settleData(e){this.model.getModelDescriptor().classifyAllNodeInfo(),this.model.getModelDescriptor().cacheNodeInfosOnGeometryId(),this.addNodeInfoToOctantMap(),this.createMeshNodes(e)}addNodeInfoToOctantMap(){var e=this.model.manager,t=this.model.getEncodedDatabagId();this.model.getModelDescriptor().traverseNodeInfosByCell((function(i,r){e.addNodeInfoToOctantMap(t,i,r)}))}createMeshNodes(e){const t=this,i=this.model;if(r.GlobalData.InstanceAsyncProcessing){const r=this.loader.getDescriptor();this.instancedManager.asyncCreateMeshNodes(i,r.getInstancedUserIds(),(()=>{this.defaultManager.createMeshNodes(i,(function(){i.getMaterialManager()._updateTextureMapping(),t.clearCachedData(i),t.loaded=!0,e&&e()}))}))}else this.instancedManager.createMeshNodes(i),this.defaultManager.createMeshNodes(i,(function(){i.getMaterialManager()._updateTextureMapping(),t.clearCachedData(i),t.loaded=!0,e&&e()}))}clearCachedData(e){e.getModelDescriptor().destroyReader(),e.getModelDescriptor().clearReferencedMeshCache(),this.defaultManager.clearCachedData(),this.instancedManager.clearCachedData()}}r.ModelView.DataBatchedBaseHandler=e}(),function(){class e extends r.ModelView.DataBatchedBaseHandler{constructor(e,t){super(e);const{useDataWireframe:i,version:a}=t;this.defaultManager=new r.ModelView.BatchedManager(i,a),this.instancedManager=new r.ModelView.InstancedManager(a),this.loader=new r.ModelView.DataBatchedLoader(this,a)}}r.ModelView.DataBatchedHandler=e}(),r.ModelView.LayerBaseProvider=class{constructor(e){this.model=e,this.conditionsChanged=!0,this.nodeInfosWithLayerKey={},this.cachedLayerData={},this.cacheAttributes=null,this.cacheSpecialtysLevels={},this.mapLayerKeys={},this.lastUsedMpkIdxsObject=null,this.lastUsedLayerIdsObject=null,this.lastUsedLayerData=null,this.mapNeededConditions=null}destroy(){this.cachedLayerData=null,this.nodeInfosWithLayerKey=null,this.cacheAttributes=null,this.cacheSpecialtysLevels=null,this.mapLayerKeys=null,this.lastUsedLayerData=null,this.lastUsedMpkIdxsObject=null,this.lastUsedLayerIdsObject=null,this.mapNeededConditions=null,this.lastLayerKeyMap=null,this.cachedLayerKeys=null}clearData(){}loadLayerDataByIdxs(e,t,i,r){}dealLayerDataLoading(e,t,i,r,a){}loadMpkOnDemand(e,t,i,r,a){var n=e?this.getAllLayerIdxData():this.getUsedLayerIdxData();this.dealLayerDataLoading(this.getLayerIdxInfoByLayerData(n),t,i,r,a)}getUsedIdxsInfoFrom(e,t){var i,a={},n={},s={},o={};if(e&&e.length)for(var l=0,d=e.length;l<d;++l)a[i=e[l]]=!0;if(t)if(r.Utils.isEmptyObject(a))s=t;else{for(i in t)a[i]&&(o[i]=!0);if(r.Utils.isEmptyObject(o))n=a,s=t;else{for(i in t)o[i]||(s[i]=!0);for(i in a)o[i]||(n[i]=!0)}}else r.Utils.isEmptyObject(a)||(n=a);return{objCurrUsedIdxs:a,addIdxs:Object.keys(n),removeIdxs:Object.keys(s)}}getLayerIdxInfoByLayerData(e){var t,i;e?(t=e.layerIds,i=e.mpkIdxs):(t=null,i=null);var r=this.getUsedIdxsInfoFrom(t,this.lastUsedLayerIdsObject);this.lastUsedLayerIdsObject=r.objCurrUsedIdxs;var a=this.getUsedIdxsInfoFrom(i,this.lastUsedMpkIdxsObject);return this.lastUsedMpkIdxsObject=a.objCurrUsedIdxs,{layerScene:r,mpk:a}}getUsedLayerIdxData(){if(!this.isConditionsChanged()&&this.lastUsedLayerData)return this.lastUsedLayerData;this.setConditionsChanged(!1);var e=this.getConditionsOnDemand();if(!e)return this.lastUsedLayerData=null,null;var t=this.getCachedLayerData(),i=[],r=[],a=[],n=[];for(var s in e)if(t[s]){for(var o=t[s].mpkIdxs,l=0,d=o.length;l<d;++l)a.push(o[l]);i.push(s),r.push(t[s].layerId),n.push(t[s].boundingBox)}return this.lastUsedLayerData={layerIds:r,layerKeys:i,boundingBoxes:n,mpkIdxs:a},this.lastUsedLayerData}getAllLayerIdxData(){this.setConditionsChanged(!1);var e=this.getCachedLayerData();if(!e)return null;var t=[],i=[],r=[],a=[];for(var n in e){for(var s=e[n].mpkIdxs,o=0,l=s.length;o<l;++o)r.push(s[o]);t.push(n),i.push(e[n].layerId),a.push(e[n].boundingBox)}return{layerIds:i,layerKeys:t,boundingBoxes:a,mpkIdxs:r}}getUserIdsOnDemand(){var e={},t=this.nodeInfosWithLayerKey,i=this.getConditionsOnDemand();if(i){for(var r in i)if(s=t[r])for(var a=0,n=s.length;a<n;a++)e[s[a].userId]=!0}else for(var r in t){var s;if(s=t[r])for(a=0,n=s.length;a<n;a++)e[s[a].userId]=!0}return e}cacheLayerData(e,t){this.cachedLayerData[e]=t}getCachedLayerData(){return this.cachedLayerData}getCachedLayerKeys(){if(this.cachedLayerKeys)return this.cachedLayerKeys;this.cachedLayerKeys={};var e=this.getCachedLayerData();for(var t in e)e.hasOwnProperty(t)&&(this.cachedLayerKeys[t]=!0);return this.cachedLayerKeys}clearNodeInfoCacheWithLayerKey(){this.nodeInfosWithLayerKey={}}cacheNodeInfoByLayerKey(e,t){this.nodeInfosWithLayerKey[e]||(this.nodeInfosWithLayerKey[e]=[]),this.nodeInfosWithLayerKey[e].push(t)}cacheNodeInfosWithLayerKey(){var e=this.model.getModelDescriptor().getAllNodeInfos();for(var t in e)for(var i=e[t],r=0,a=i.length;r<a;r++){var n=i[r],s=this.formatLayerIds(n.userData);this.cacheNodeInfoByLayerKey(s[0],n)}}cacheLayerKeys(e){this.mapLayerKeys=e;var t={},i=this.getLayerKeyAttributes();for(var r in e){var a=e[r],n=a[i[0]],s=a[i[1]];t.hasOwnProperty(n)||(t[n]=[]),t.hasOwnProperty(s)||(t[s]=[]),t[n].push(s),t[s].push(n)}this.cacheSpecialtysLevels=t}getLayerKeyAttributes(){if(this.cacheAttributes)return this.cacheAttributes;var e=[],t=Object.keys(this.mapLayerKeys)[0],i=this.mapLayerKeys[t];for(var r in i)i.hasOwnProperty(r)&&e.push(r);return this.cacheAttributes=e,this.cacheAttributes}formatLayerIds(e){var t=[];if(!e)return t.push("unknown"),t;var i=this.getLayerKeyAttributes(),r=e[i[0]],a=e[i[1]];if(e.hasOwnProperty(i[0])&&e.hasOwnProperty(i[1]))if(r instanceof Array&&a instanceof Array)for(var n=0;n<r.length;n++)for(var s=0;s<a.length;s++){var o=r[n]+"-"+a[s];t.push(o)}else if(r instanceof Array)for(s=0;s<r.length;s++)o=r[s]+"-"+a,t.push(o);else if(a instanceof Array)for(s=0;s<a.length;s++)o=r+"-"+a[s],t.push(o);else o=r+"-"+a,t.push(o);else if(e.hasOwnProperty(i[0]))if(e.hasOwnProperty(i[1]))t.push("unknown"),console.warn("Object has no "+i[0]+" and "+i[1]);else if(r instanceof Array)for(s=0;s<r.length;s++)for(l=r[s],d=this.getLevelsOrSpecialtys(l),n=0;n<d.length;n++)o=l+"-"+d[n],t.push(o);else for(l=r,d=this.getLevelsOrSpecialtys(l),n=0;n<d.length;n++)o=l+"-"+d[n],t.push(o);else if(a instanceof Array)for(var s=0;s<a.length;s++)for(var l=a[s],d=this.getLevelsOrSpecialtys(l),n=0;n<d.length;n++)o=d[n]+"-"+l,t.push(o);else for(var l=a,d=this.getLevelsOrSpecialtys(l),n=0;n<d.length;n++)o=d[n]+"-"+l,t.push(o);return t}getLevelsOrSpecialtys(e){return this.cacheSpecialtysLevels.hasOwnProperty(e)?this.cacheSpecialtysLevels[e]:(console.warn("Attribute "+e+"has no according levels or specialtys."),[])}getUnionBoundingBoxOnDemand(){var e=this.getBoundingBoxesOnDemand();if(e&&e.length>0){for(var t=new THREE.Box3,i=0,r=e.length;i<r;++i)t.union(e[i]);return t}return null}getBoundingBoxesOnDemand(){var e=this.getUsedLayerIdxData();return e?e.boundingBoxes:null}setConditionsOnDemandLoad(e){var t={};if(e&&e instanceof Array){t={};for(var i=0,r=e.length;i<r;i++)for(var a=e[i],n=this.formatLayerIds(a),s=0;s<n.length;s++)t.hasOwnProperty(n[s])||(t[n[s]]=!0)}else t=this.getCachedLayerKeys();var o=this._isLayerKeysChanged(t);return o&&(this.mapNeededConditions=t,this.setConditionsChanged(!0)),o}_isLayerKeysChanged(e){var t=!1;if(void 0!==this.lastLayerKeyMap){var i=Object.keys(this.lastLayerKeyMap),r=Object.keys(e);if(i.length!==r.length)t=!0;else for(var a=0,n=r.length;a<n;a++){var s=r[a];if(void 0===this.lastLayerKeyMap[s]){t=!0;break}}}else t=!0;return t&&(this.lastLayerKeyMap=e),t}setConditionsChanged(e){this.conditionsChanged=e}getConditionsOnDemand(){return this.mapNeededConditions}isConditionsChanged(){return this.conditionsChanged}},function(){class e extends r.ModelView.BaseLoader{constructor(e,t){super(e,t),this._loadingOnDemand=!1}loadMpkOnDemand(e,t,i){for(var r=0,a=e.length;r<a;++r)this.mpkTaskManager.addTask(e[r]);var n=this;this.mpkTaskManager.processTasks(this._loadMpk.bind(this),t,(function(){n._loadingOnDemand=!1,i&&i()}))}resetProcessState(e){this.loadTaskCount=0,this.maxLoadTaskCount=e,this._loadingOnDemand=!0}dealProgressSegment(e,t){return r.GlobalData.BatchMergeEnabled&&this._loadingOnDemand?t*e.progressPercentage.load:t}_loadLayerKey(){var e=this,t=this.fileLoader,i=this.url,a=this.model,n=this.handler.getLayerProvider();const s=i.layerKeyUrl();r.Storage.IndexedDBHelper.loadWithStorage("ModelData",s,(()=>new Promise(((e,i)=>{t.setResponseType(""),t.load(s,e,void 0,i)}))),(t=>{var i=new r.Loader.LayerKeyReader(t),a=[],s=i.getData();n.cacheLayerKeys(s);for(var o=0,l=i.getCount();o<l;++o){var d=i.getLayerKey(o),h=n.formatLayerIds(d);a.push(h[0])}e._loadLayer(a)}),(t=>{a.dispatchEvent({type:r.LOADERROREVENTS.LOAD_ERROR,errorType:r.LOADERROREVENTS.LOAD_MPK_ERROR,event:event}),e._onTaskFinished()}))}_loadLayer(e){var t=this,i=this.fileLoader,a=this.url,n=this.model,s=this.handler.getLayerProvider();const o=a.layerUrl();r.Storage.IndexedDBHelper.loadWithStorage("ModelData",o,(()=>new Promise(((e,t)=>{i.setResponseType("arraybuffer"),i.load(o,e,void 0,t)}))),(i=>{for(var a=new r.Loader.LayerReader(i),n=0,o=a.getLayerCount();n<o;++n)if(void 0!==e[n]){for(var l=[],d=a.getLayerData(n),h=a.getMpkList(n),c=0,u=h.length;c<u;++c)l.push(h[c]);s.cacheLayerData(e[n],{layerId:d.layer_id,boundingBox:d.boundingBox,mpkIdxs:l})}t._onTaskFinished()}),(e=>{n.dispatchEvent({type:r.LOADERROREVENTS.LOAD_ERROR,errorType:r.LOADERROREVENTS.LOAD_MPK_ERROR,event:event}),t._onTaskFinished()}))}delayLoadResources(e){var t=this.model.getConfig().metadata;0!==t.lines?(this.startCallback=null,this.progressCallback=null,this.finishCallback=e,this.loadTaskCount=0,this.maxLoadTaskCount=0,this.maxLoadTaskCount+=t.lines,t.lines&&this._loadLine()):e&&e()}}r.ModelView.LayerBaseLoader=e}(),function(){class e extends r.ModelView.ModelBaseHandler{constructor(e){super(e),this.layerDataLoaded=!1,this.loadedUserIdsObject=null,this.loadedUserIds=null,this.layerProvider=null,this.firstToLoad=!0}destroy(){super.destroy(),this.loadedUserIdsObject=null,this.loadedUserIds=null,this.layerProvider.destroy(),this.layerProvider=null}getLayerProvider(){return this.layerProvider}load(e){var t=this,i=this.model;this.loader.setNotifyProgress(e),this.loader.load((function(){i.manager.dispatchEvent({type:r.EVENTS.ON_LOAD_START})}),(function(e){i.manager.dispatchEvent({type:r.EVENTS.ON_LOAD_PROGRESS,progress:e})}),(function(){t.processLoadCompleted((function(){i.manager.dispatchEvent({type:r.EVENTS.ON_LOAD_COMPLETE,modelId:i.id})}))}))}unload(e,t){}loadMpkOnDemand(e,t,i,a){var n=this,s=this.model,o=!e,l=function(e){s.manager.dispatchEvent({type:r.EVENTS.ON_DEMAND_LOAD_PROGRESS,progress:e})};this.firstToLoad?this.loader.delayLoadResources((function(){n.firstToLoad=!1,n.loader.finishCallback=null,n.prepareData((function(){n.loader.progressCallback=l,n.getLayerProvider().setConditionsOnDemandLoad(e),n._loadMpkOnDemand(o,t,i,a)}))})):(n.loader.progressCallback=l,n.getLayerProvider().setConditionsOnDemandLoad(e)?n._loadMpkOnDemand(o,t,i,a):(t&&t(),a&&a()))}_loadMpkOnDemand(e,t,i,a){var n=this,s=this.model;this.layerDataLoaded=!1,t&&t(),s.manager.dispatchEvent({type:r.EVENTS.ON_DEMAND_LOAD_START}),this.getLayerProvider().loadMpkOnDemand(e,(function(e){n.dealData(e)}),(function(e,t){n.unload(e,t)}),i,(function(){n.layerDataLoaded=!0,s.manager.updateFilterManager(),console.log("load finish"),s.manager.dispatchEvent({type:r.EVENTS.ON_DEMAND_LOAD_COMPLETE,data:{boundingBox:s.manager.getLoadOnDemandDirector().getBoundingBoxForUsedComponent()}}),a&&a()}))}processLoadCompleted(e){var t=this.model;t.materialManager._updateTextureMapping(),t.materialManager._updateIBL(t),t.loaded=!0,t.updateOctreeNode(),requestAnimationFrame((function(){e&&e(),t.debut(t)}))}isAllReady(){return!(!this.isLoaded()||this.isHidden()||!this.isLayerDataLoaded())}applyFilter(){if(this.isLoaded()&&this.isLayerDataLoaded()){var e=this.model.getModelDescriptor().getStandardUserIdsByCategory(this.loadedUserIds);if(e.length&&this.defaultManager.applyFilter(this.model,e),r.GlobalData.Instance){var t=this.model.getModelDescriptor().getInstancedUserIdsByCategory(this.loadedUserIds);t.length&&this.instancedManager.applyFilter(this.model,t)}}}needUpdate(){return!!this.isLayerDataLoaded()}clearData(){}initData(e){}dealMeshNodes(e){}dealData(e){var t=this;this.clearData(),this.initData((function(){t.model.manager.loadOverrideMaterialsByDemand((function(){t.dealMeshNodes(e)}),(function(){t.dealMeshNodes(e)}))}))}getLoadedUserIdsObject(){return this.loadedUserIdsObject}isLayerDataLoaded(){return this.layerDataLoaded}clearLoadedState(){this.layerDataLoaded=!1,this.loadedUserIdsObject=null,this.loadedUserIds=null}}r.ModelView.LayerBaseHandler=e}(),function(){class e extends r.ModelView.LayerBaseHandler{constructor(e){super(e),this.layerProvider=new r.ModelView.LayerProvider(e)}settleData(e){this.model.getModelDescriptor().classifyAllNodeInfo(),this.addNodeInfoToOctantMap(),this.getLayerProvider().cacheNodeInfosWithLayerKey(),this.model.getModelDescriptor().destroyReader(),this.loaded=!0,e&&e()}clearData(){this.model.clearNodeGroup(),this.model.clearMeshFromOctantMap(),this.getLayerProvider().clearData(),this.model.clearWireframeElementCount(),this.defaultManager.clearData(),this.instancedManager.clearData(),this.clearLoadedState()}addNodeInfoToOctantMap(){var e=this.model.manager,t=this.model.getEncodedDatabagId();this.model.getModelDescriptor().traverseNodeInfosByCell((function(i,r){e.addNodeInfoToOctantMap(t,i,r)}))}initData(e){this.loadedUserIdsObject=this.getLayerProvider().getUserIdsOnDemand(),this.loadedUserIds=Object.keys(this.loadedUserIdsObject),e&&e()}unload(e,t){var i=this;this.model.getModelDescriptor().clearReferencedMeshCacheByMpkIdxs(t,(function(e){i.defaultManager.disposeGeometry(e)}))}}r.ModelView.LayerHandler=e}(),function(){class e extends r.ModelView.LayerBaseProvider{constructor(e){super(e)}loadLayerDataByIdxs(e,t,i,r){this.model.getLoader().resetProcessState(t.length),this.model.getLoader().loadMpkOnDemand(t,(function(e,t){i&&i(t-e,t)}),r)}dealLayerDataLoading(e,t,i,r,a){var n=e.mpk;if(0!==n.addIdxs.length||0!==n.removeIdxs.length){var s=!1;n.removeIdxs.length>0&&(s=!0,i&&i(null,n.removeIdxs)),n.addIdxs.length>0?this.loadLayerDataByIdxs(null,n.addIdxs,r,(function(){t&&t(a)})):s?t&&t(a):a&&a()}else t&&t(a)}}r.ModelView.LayerProvider=e}(),function(){class e extends r.ModelView.DefaultDescriptor{constructor(){super()}}r.ModelView.LayerDescriptor=e}(),function(){class e extends r.ModelView.LayerBaseLoader{constructor(e){super(e),this.descriptor=new r.ModelView.LayerDescriptor}loadSceneAndMpks(e){e.symbol&&this._loadSymbol(),this._loadScene(0),this._loadLayerKey(),r.GlobalData.BorderLineDelayLoaded||this._loadAllBorderlines(e)}getSceneTaskCount(e){var t=2;return t+=e.symbol,r.GlobalData.BorderLineDelayLoaded||(t+=this.getAllBorderlineCount()),t}}r.ModelView.LayerLoader=e}(),function(){class e extends r.ModelView.LayerHandler{constructor(e,t){super(e),this.tag="layer",this.defaultManager=new r.ModelView.BatchedManager(t),this.instancedManager=new r.ModelView.InstancedManager,this.loader=new r.ModelView.LayerLoader(this)}prepare(e,t){this.isAllReady()&&(this.prepareWireframe(this.model,t),this.model.getMaterialManager()._updateTextureMapping(this.model))}dealMeshNodes(e){var t=this.model.getModelDescriptor().getInstancedUserIdsByCategory(this.loadedUserIds);t.length&&this.instancedManager.createMeshNodes(this.model,t);var i=this.model.getModelDescriptor().getStandardUserIdsByCategory(this.loadedUserIds);i.length?this.defaultManager.asyncCreateMeshNodes(this.model,i,e):e&&e()}}r.ModelView.LayerBatchedHandler=e}(),function(){class e extends r.ModelView.LayerBaseHandler{constructor(e){super(e),this.layerProvider=new r.ModelView.LayerSceneProvider(e)}prepareData(e){this.dataReady||(this.dataReady=!0,this.settleData(e))}settleData(e){this.loaded=!0,e&&e()}clearData(){this.model.clearNodeGroup(),this.model.removeAllFromOctantMap(),this.model.getModelDescriptor().clearNodeInfosWithGeometryId(),this.getLayerProvider().clearData(),this.model.clearWireframeElementCount(),this.defaultManager.clearData(),this.instancedManager.clearData(),this.clearLoadedState()}initData(e){this.model.getModelDescriptor().parseItemData(),this.model.getModelDescriptor().classifyAllNodeInfo(),this.getLayerProvider().cacheNodeInfosWithLayerKey(),this.addNodeInfoToOctantMap(),this.loadedUserIdsObject=this.getLayerProvider().getUserIdsOnDemand(),this.loadedUserIds=Object.keys(this.loadedUserIdsObject),e&&e()}addNodeInfoToOctantMap(){var e=this.model.manager,t=this.model.getEncodedDatabagId();this.model.getModelDescriptor().traverseNodeInfosByCell((function(i,r){e.addNodeInfoToOctantMap(t,i,r)}))}unload(e,t){var i=this;this.model.getModelDescriptor().removeFromSceneReaderMap(e),this.model.getModelDescriptor().clearReferencedMeshCacheByMpkIdxs(t,(function(e){i.defaultManager.disposeGeometry(e)}))}}r.ModelView.LayerSceneHandler=e}(),function(){class e extends r.ModelView.LayerBaseProvider{constructor(e){super(e)}clearData(){this.model.getModelDescriptor().clearNodeInfoCache(),this.clearNodeInfoCacheWithLayerKey()}loadLayerDataByIdxs(e,t,i,r){var a=this.model.getLoader(),n=e.length,s=t.length;if(n&&s){var o=n+s;a.resetProcessState(o),a.loadLayerScenesOnDemand(e,(function(e,t){i&&i(t-e,o)}),(function(){a.loadMpkOnDemand(t,(function(e,t){i&&i(t-e+n,o)}),r)}))}else n?(a.resetProcessState(n),a.loadLayerScenesOnDemand(e,(function(e,t){i&&i(t-e,t)}),r)):s&&(a.resetProcessState(s),a.loadMpkOnDemand(t,(function(e,t){i&&i(t-e,t)}),r))}dealLayerDataLoading(e,t,i,r,a){var n=e.mpk,s=e.layerScene;if(0!==n.addIdxs.length||0!==n.removeIdxs.length||0!==s.addIdxs.length||0!==s.removeIdxs.length){var o=!1;(n.removeIdxs.length>0||s.removeIdxs.length>0)&&(o=!0,i&&i(s.removeIdxs,n.removeIdxs)),s.addIdxs.length>0||n.addIdxs.length>0?this.loadLayerDataByIdxs(s.addIdxs,n.addIdxs,r,(function(){t&&t(a)})):o?t&&t(a):a&&a()}else t&&t(a)}}r.ModelView.LayerSceneProvider=e}(),function(){class e extends r.ModelView.DefaultDescriptor{constructor(){super()}parseItemData(){var e=this.getSceneReaderMap();for(var t in e)for(var i=e[t],r=0,a=i.header.itemCount;r<a;++r)this._readItemData(i,r,this.getCellId(t,r));return!0}parseItemDataByCellId(e){var t=this.getSceneReaderMap();for(var i in t){var r=t[i],a=this.getItemIdsBy(e,i);if(a)for(var n=0,s=a.length;n<s;++n){var o=a[n];this._readItemData(r,o,this.getCellId(i,o))}}return!0}getLayerIdsByCellId(e){return this.cellIdMap&&this.cellIdMap[e]?Object.keys(this.cellIdMap[e]):null}getItemIdsBy(e,t){return this.cellIdMap&&this.cellIdMap[e]?this.cellIdMap[e][t]:null}cacheToCellIdMap(e,t,i){this.layerIdMap||(this.layerIdMap={}),this.layerIdMap[t]||(this.layerIdMap[t]={}),this.layerIdMap[t][i]=e,this.cellIdMap||(this.cellIdMap={}),this.cellIdMap[e]||(this.cellIdMap[e]={}),this.cellIdMap[e][t]||(this.cellIdMap[e][t]=[]),this.cellIdMap[e][t].push(i)}getCellId(e,t){return this.layerIdMap&&this.layerIdMap[e]&&this.layerIdMap[e][t]||0}isOctreeOuter(e){var t=this.octreeRootNode.layer;return t||(t=this.octreeRootNode.inner||this.octreeRootNode.outer),!(e.x<t.min.x||e.x>t.max.x||e.y<t.min.y||e.y>t.max.y||e.z<t.min.z||e.z>t.max.z)}isUseInnerAndOuterOctree(){return!this.octreeRootNode.layer}getOctreeRoots(e){this.octreeRootNode.layer?e.push(this.octreeRootNode.layer):(this.octreeRootNode.inner&&e.push(this.octreeRootNode.inner),this.octreeRootNode.outer&&e.push(this.octreeRootNode.outer))}updateOctreeNode(e){this.octreeRootNode.layer?this.updateOctreeNodeBy(this.octreeRootNode.layer,e):(this.octreeRootNode.inner&&this.updateOctreeNodeBy(this.octreeRootNode.inner,e),this.octreeRootNode.outer&&this.updateOctreeNodeBy(this.octreeRootNode.outer,e))}}r.ModelView.LayerSceneDescriptor=e}(),function(){class e extends r.ModelView.LayerBaseLoader{constructor(e,t){super(e,t),this.layerSceneTaskManager=new r.TaskManager,this.descriptor=new r.ModelView.LayerSceneDescriptor}loadLayerScenesOnDemand(e,t,i){for(var r=0,a=e.length;r<a;++r)this.layerSceneTaskManager.addTask(e[r]);this.layerSceneTaskManager.processTasks(this._loadLayerScene.bind(this),t,i)}loadSceneAndMpks(e){e.symbol&&this._loadSymbol(),this._loadLayerCellIndex(),this._loadLayerOctree(),this._loadLayerKey(),r.GlobalData.BorderLineDelayLoaded||this._loadAllBorderlines(e)}getSceneTaskCount(e){var t=3;return t+=e.symbol,r.GlobalData.BorderLineDelayLoaded||(t+=this.getAllBorderlineCount()),t}_loadLayerCellIndex(){var e=this,t=this.fileLoader;const i=this.url.layerSceneCell();r.Storage.IndexedDBHelper.loadWithStorage("ModelData",i,(()=>new Promise(((e,r)=>{t.setResponseType("arraybuffer"),t.load(i,e,void 0,r)}))),(t=>{e._parseLayerCellIndex(t),e._onTaskFinished()}),(t=>{e._onTaskFinished()}))}_parseLayerCellIndex(e){for(var t=new r.Loader.LayerIndexReader(e),i=this.descriptor,a=0,n=t.cell_count;a<n;a++)for(var s=t.getCell(a),o=s.itemIndex;o<s.itemCount;o++){var l=t.getLayerIndex(o);i.cacheToCellIdMap(s.cellId,l.layer_id,l.item_index)}}_loadLayerOctree(){var e=this.fileLoader,t=this.url,i=this;const a=t.layerOctree();r.Storage.IndexedDBHelper.loadWithStorage("ModelData",a,(()=>new Promise(((t,i)=>{e.setResponseType("arraybuffer"),e.load(a,t,void 0,i)}))),(e=>{i._parseLayerOctree(e),i._onTaskFinished()}),(e=>{i._onTaskFinished()}))}_parseLayerOctree(e){this.descriptor.octreeRootNode.layer=this._getOctreeRootNode(e)}_loadLayerScene(e,t){var i=this,a=this.model,n=this.fileLoader;const s=this.url.layerSceneUrl(e);r.Storage.IndexedDBHelper.loadWithStorage("ModelData",s,(()=>new Promise(((e,t)=>{n.setResponseType("arraybuffer"),n.load(s,e,void 0,t)}))),(r=>{i._parseScene(r,e),t(),i._onTaskFinished()}),(e=>{a.dispatchEvent({type:r.LOADERROREVENTS.LOAD_ERROR,errorType:r.LOADERROREVENTS.LOAD_MPK_ERROR,event:event}),t(),i._onTaskFinished()}))}}r.ModelView.LayerSceneLoader=e}(),function(){class e extends r.ModelView.LayerSceneHandler{constructor(e,t){super(e);const{useDataWireframe:i,version:a}=t;this.tag="layer",this.defaultManager=new r.ModelView.BatchedManager(i),this.instancedManager=new r.ModelView.InstancedManager,this.loader=new r.ModelView.LayerSceneLoader(this,a)}prepare(e,t){this.isAllReady()&&(this.prepareWireframe(this.model,t),this.model.getMaterialManager()._updateTextureMapping(this.model))}addNodeInfoToOctantMap(){var e=this.model.manager,t=this.model.getEncodedDatabagId();this.model.getModelDescriptor().traverseNodeInfosByCell((function(i,r){e.addNodeInfoToOctantMap(t,i,r)}))}dealMeshNodes(e){var t=this.model.getModelDescriptor().getInstancedUserIdsByCategory(this.loadedUserIds);t.length&&this.instancedManager.createMeshNodes(this.model,t);var i=this.model.getModelDescriptor().getStandardUserIdsByCategory(this.loadedUserIds);i.length?this.defaultManager.asyncCreateMeshNodes(this.model,i,e):e&&e()}}r.ModelView.LayerSceneBatchedHandler=e}(),r.LoadOnDemandDirector=class{constructor(e){this.manager=e,this.requestCount=0,this.maxRequestCount=1e5,this.loading=!1,this.delayIntervalTime=300}destroy(){this.manager=null,this.currentConditions=null,this.delayLoadTimer&&(clearTimeout(this.delayLoadTimer),this.delayLoadTimer=null)}isValidModel(e){return!(e.isEmptyScene()||!e.isLayerData())}loadMpkOnDemandByConditionsWithDelay(e,t,i,r){var a=this,n=this.delayIntervalTime;a.delayLoadTimer&&clearTimeout(a.delayLoadTimer),a.delayLoadTimer=setTimeout((function(){a.loadMpkOnDemandByConditions(e,t,i,r)}),n)}loadMpkOnDemandByConditions(e,t,i,r){if(this.currentConditions=e,++this.requestCount,this.requestCount>this.maxRequestCount&&(this.requestCount=0),!this.loading){this.loading=!0;var a=this;requestAnimationFrame(function e(n){var s=n,o=a.currentConditions;return function(){a._loadMpkOnDemandByConditions(o,t,i,(function(){s!==a.requestCount?requestAnimationFrame(e(a.requestCount)):(a.loading=!1,r&&r(o),o=null)}))}}(this.requestCount))}}_loadMpkOnDemandByConditions(e,t,i,r){var a=this;this.manager.traverseModels((function(n){a.isValidModel(n)&&n._getHandler().loadMpkOnDemand(e,t,i,r)}))}getBoundingBoxOnDemand(){var e=new THREE.Box3,t=this;return this.manager.traverseModels((function(i){if(t.isValidModel(i)){var r=i._getHandler().getLayerProvider().getUnionBoundingBoxOnDemand();if(r){var a=i.getVertexOffsetMatrix();a&&r.applyMatrix4(a),e.union(r)}}})),e.isEmpty()?null:e}isLoading(){return this.loading}getBoundingBoxForUsedComponent(){var e=this.manager,t=new THREE.Box3;return e.traverseModels((function(i){var r=i.getLoadedUserIdsObject();r&&t.union(e.getBoundingBoxByIds(r))})),t.isEmpty()?null:t}},function(){class e extends r.ModelView.MeshBaseManager{constructor(e){super(),this.manager=e,this.occlusionVisibleOctant=[],this.usedNodeInfoMap={},this.lineNodes={},this.activeMeshMap={}}destroy(){if(super.destroy(),this.clearData(),this.pickingNodeGenerators){for(var e in this.pickingNodeGenerators)this.pickingNodeGenerators.hasOwnProperty(e)&&this.pickingNodeGenerators[e].destroy();this.pickingNodeGenerators=null}this.activeMeshMap=null,this.manager=null,this.occlusionVisibleOctant=null,this.usedNodeInfoMap=null,this.lineNodes=null}disposeLineNodes(){for(var e in this.lineNodes){var t=this.lineNodes[e];t.geometry.dispose(),t=null,delete this.lineNodes[e]}}clearData(){if(this.pickingNodeGenerators)for(var e in this.pickingNodeGenerators)this.pickingNodeGenerators.hasOwnProperty(e)&&this.pickingNodeGenerators[e].clearData();this._clearActiveMeshMap(),this.disposeGeometries(),this.disposeLineNodes(),this.usedNodeInfoMap={},this.occlusionVisibleOctant.length=0}updateNode(e,t,i){var a,n=this,s=e.getFilter()._hasOverrideMaterialFilter(),o=e.selectedMaterial;a=0===i?n._getUsableMaterial(e,t,o,s):n._getUsableMaterial(e,t,null,s),r.ModelView.BaseDescriptor.isLineNode(t)?n._dealLineSegments(e,t,a):n._dealMeshes(e,t,a),a=null}cullNodes(e,t,i){var r=this._getUsedNodeInfosByOctantId(t),a=this;if(r||(this.manager.traverseNodeInfoMapByOctantId(t,(function(t,i){a._isSatisfied(e,i)&&a._cacheToUsedNodeInfoMap(t,i)})),r=this._getUsedNodeInfosByOctantId(t)),!r)return i;for(var n=0,s=r.length;n<s&&(i=this.collectNodeInfo(e,r[n],i),!this.manager.isFull(e,i));n++);return i}_getUsableMaterial(e,t,i,a){var n=t.materialId,s=t.userId,o=e.materialManager.materials,l=e.manager.sceneState,d=e.getFilter(),h=null,c=l.isSelected(s);1!=c||d._isPickable(t)||(c=!1),i?r.GlobalData.PickingEffect?h=d._getOverrideMaterial(t):(h=d._getOverrideMaterial(t))&&!c||(h=i):a&&(h=d._getOverrideMaterial(t));var u=e.manager.getOverrideMaterialByNodeInfo(t,e.materialManager.getMaterialById(t.materialId));return h=h||u||o[n]||r.MaterialUtil.getDefaultStandardMaterial(),r.GlobalData.Hover&&l.hoverId===s&&!1===c&&(h=l.getHoverMaterial(h)),h}collectNodeInfo(e,t,i){var r=e.getFilter(),a=r._hasHiddenFileIdFilter(),n=r._hasOverrideMaterialFilter(),s=e.manager.sceneState.selectionSet,o=r._hasRenderPromotionFilter(),l=e.manager.getCategoriesFromHighPriority("inner");return e.isReplacedUserId(t.userId)||e.isHiddenSourceObjectUserId(t.userId)||a&&r._isHiddenFileId(t)||!1===r._isVisible(t)?i:s[t.userId]||n&&r._hasHighPriorityOverrideMaterial(t)?(this.manager.addToPriorityNodesSet(0,t),++i):o&&r._isRenderPromotion(t)||t.userData&&t.userData.categoryId&&l[t.userData.categoryId]?(this.manager.addToPriorityNodesSet(1,t),++i):(this.manager.isFull(e,i)||(this.manager.addToPriorityNodesSet(2,t),i++),i)}getMeshesByUserIds(e,t,i){const r=e.pool._pool,a=t.toString(),n=i.toString(),s=e.getLengthUnitsMatrix();for(let t=0;t<r.length;t++){const i=r[t];if(i.name==a||i.name==n){let t=i.geometry.boundingBox;t||(i.geometry.computeBoundingBox(),t=i.geometry.boundingBox),e.minDistanceObjects[i.name].push({mesh:i,matrix:i.matrix,unitsMatrix:s,boundingBox:t})}}}_getUsedGeometry(e,t){if(!r.GlobalData.Instance&&t.uvArrayBuffer){var i,a=t.geometryId+"|"+t.nodeId;if(i=this.getGeometryById(a))return i;var n=this._createGeometryByNodeInfo(e,t);n instanceof Array||(n=[n]),i=[];for(var s=new THREE.Matrix3,o=new THREE.Vector3,l=t.uvArrayBuffer,d=0,h=n.length;d<h;d++){var c=new THREE.BufferGeometry;c.setIndex(n[d].index),c.setAttribute("position",n[d].attributes.position),c.setAttribute("normal",n[d].attributes.normal),s.set(l[6*d],l[6*d+2],l[6*d+4],l[6*d+1],l[6*d+3],l[6*d+5],0,0,1);for(var u=[],p=n[d].attributes.uv.array,m=0,f=p.length;m<f;m+=2)o.set(p[m],p[m+1],1),o.applyMatrix3(s),u.push(o.x),u.push(o.y);c.setAttribute("uv",new THREE.Float32BufferAttribute(u,2)),i.push(c)}this._cacheGeometry(a,i)}else i=this.getGeometryByNodeInfo(e,t);return i}_dealMeshes(e,t,i){const a=this._getNodeGroupRenderOrder(t,i);let n=this._getUsedGeometry(e,t);n instanceof Array||(n=[n]);for(var s=0,o=n.length;s<o;s++){const o=e.pool.get({databagId:e.databagId,meshId:t.nodeId,userId:t.userId,originalId:t.originalId,userData:t.userData,geometry:n[s],matrix:t.matrix,material:i,isMesh:!0,isLine:!1,isLineSegments:!1,groupOrder:a.groupRenderOrder,renderOrder:a.renderOrder});o&&(o.geometryId=t.geometryId,this._cacheActiveMesh(t.userId,t.nodeId,o),e.manager.addMeshToOctantMap(e.getEncodedDatabagId(),t.nodeId,new r.SingleCapsuleObject(t.nodeId,o)))}}_dealLineSegments(e,t,i){const a=this.getGeometryByNodeInfo(e,t);if(!a)return;const n=this._getNodeGroupRenderOrder(t,i),s=e.pool.get({databagId:e.databagId,meshId:t.nodeId,userId:t.userId,originalId:t.originalId,userData:t.userData,geometry:a,matrix:t.matrix,material:i,isMesh:!1,isLine:!0,isLineSegments:!0,groupOrder:n.groupRenderOrder,renderOrder:n.renderOrder});s&&(s.geometryId=t.geometryId,this._cacheActiveMesh(t.userId,t.nodeId,s),e.manager.addMeshToOctantMap(e.getEncodedDatabagId(),t.nodeId,new r.SingleCapsuleObject(t.nodeId,s)))}_getUsedNodeInfosByOctantId(e){return this.usedNodeInfoMap[e]}_cacheToUsedNodeInfoMap(e,t){this.usedNodeInfoMap[e]||(this.usedNodeInfoMap[e]=[]),this.usedNodeInfoMap[e].push(t)}traverseUsedNodeInfoMap(e,t){const i=this.usedNodeInfoMap[e];for(let r=0,a=i.length;r<a;r++)t(e,i[r])}_isSatisfied(e,t){const i=e.getLoadedUserIdsObject();return!i||!!i[t.userId]}_applyOcclusionTranslucent(e){if(r.GlobalData.OcclusionTranslucentEnabled){var t=e.pool.getObjects(),i=e.manager.octantToObjectMap,a=this.occlusionVisibleOctant.length;if(a>0)for(var n=e.manager.getFrustumFromOcclusionCamera(),s=0;s<a;++s){var o=i[this.occlusionVisibleOctant[s].octantId];if(o&&o.length>0)for(var l=0,d=o.length;l<d;l+=2)for(var h=o[l];h<=o[l+1];h++){var c=t[h];r.CameraUtil.intersectObjectWithFrustum(c,n)&&this._overrideOcclusionMaterial(c)}}}}_overrideOcclusionMaterial(e,t){var i=t.material;if(i&&!1===i.transparent){var a=e.manager.acquireMaterial(),n=a.material;i.color?n.color.copy(i.color):a.resetColor(),n.opacity=r.GlobalData.OcclusionOpacity,t.material=n,t.material.needsUpdate=!0}}getGeometryBuffersByUserId(e,t){var i=e.getModelDescriptor().getStandardNodeInfosById(t);if(!i)return[];for(var a=[],n=e.getDatabagId(),s=0,o=i.length;s<o;s++){var l=i[s],d=this.getGeometryByNodeInfo(e,l);if(d){var h=r.ModelView.BaseDescriptor.isLineNode(l);if(d instanceof Array)for(var c=0,u=d.length;c<u;c++)a.push({isLines:h,databagId:n,nodeId:l.nodeId,position:d[c].getAttribute("position").array,index:d[c].getIndex().array,matrix:l.matrix});else a.push({isLines:h,databagId:n,nodeId:l.nodeId,position:d.getAttribute("position").array,index:d.getIndex().array,matrix:l.matrix})}}return a}disposeBufferAfterVbo(){}traverseActiveMeshMap(e,t){for(var i=0,r=(e=e||Object.keys(this.activeMeshMap)).length;i<r;i++){var a=e[i];if(this.activeMeshMap[a])for(var n=Object.keys(this.activeMeshMap[a]),s=0,o=n.length;s<o;s++){var l=n[s];t(a,l,this.activeMeshMap[a][l])}}}getActiveMeshMapById(e){return this.activeMeshMap[e]}_cacheActiveMesh(e,t,i){this.activeMeshMap[e]||(this.activeMeshMap[e]={}),this.activeMeshMap[e][t]||(this.activeMeshMap[e][t]=[]),this.activeMeshMap[e][t].push(i)}_clearActiveMeshMap(){this.activeMeshMap={}}getPickingNodeGenerator(e){return e=null==e?"pick":e,this.pickingNodeGenerators||(this.pickingNodeGenerators={}),this.pickingNodeGenerators[e]||(this.pickingNodeGenerators[e]=new r.PickingMeshGenerator(this),this.pickingNodeGenerators[e].reserveMaterial=!!e.startsWith("glow")),this.pickingNodeGenerators[e]}_getNodeGroupRenderOrder(e,t){return{groupRenderOrder:t&&t.transparent?0:e.cellDepth,renderOrder:e.octantId}}}r.ModelView.IncrementedMeshManager=e}(),r.ModelView.IncrementedWireframeManager=class{constructor(e){this.manager=e,this.wireframeGeometryMap={},this.usedNodeInfoMap={}}destroy(){if(this.pickingNodeGenerators){for(var e in this.pickingNodeGenerators)this.pickingNodeGenerators.hasOwnProperty(e)&&this.pickingNodeGenerators[e].destroy();this.pickingNodeGenerators=null}this._disposeGeometries(),this.wireframeGeometryMap=null,this.usedNodeInfoMap=null,this.manager=null}clearData(){if(this.pickingNodeGenerators)for(var e in this.pickingNodeGenerators)this.pickingNodeGenerators.hasOwnProperty(e)&&this.pickingNodeGenerators[e].clearData();this._disposeGeometries(),this.wireframeGeometryMap={},this.usedNodeInfoMap={}}cullNodes(e,t,i){var r=this,a=this._getUsedNodeInfosByOctantId(t);if(a||(this.manager.traverseNodeInfoMapByOctantId(t,(function(t,i){r._isSatisfied(e,i)&&r._cacheToUsedNodeInfoMap(t,i)})),a=this._getUsedNodeInfosByOctantId(t)),!a)return i;for(var n=0,s=a.length;n<s&&(i=this._collectNodeInfo(e,a[n],i),!this.manager.isFull(e,i));n++);return i}updateNode(e,t){const i=e.getFilter()._getOverrideWireFrameMaterial(t)||e.getWireframeMaterial(),r=this._getWireframeGeometryByNodeInfo(e,t),a=this._getNodeGroupRenderOrder(t,i);for(let n=0,s=r.length;n<s;n++)e.pool.get({databagId:e.databagId,meshId:t.nodeId,userId:t.userId,geometry:r[n],matrix:t.matrix,material:i,isMesh:!1,isLine:!0,isLineSegments:!0,pickable:!1,groupOrder:a.groupRenderOrder,renderOrder:a.renderOrder})}_getUsedNodeInfosByOctantId(e){return this.usedNodeInfoMap[e]}_cacheToUsedNodeInfoMap(e,t){this.usedNodeInfoMap[e]||(this.usedNodeInfoMap[e]=[]),this.usedNodeInfoMap[e].push(t)}_collectNodeInfo(e,t,i){var r=e.getFilter(),a=r._hasHiddenFileIdFilter();return e.isReplacedUserId(t.userId)||e.isHiddenSourceObjectUserId(t.userId)||a&&r._isHiddenFileId(t)||!1===r._isVisible(t)||this.manager.isFull(e,i)||(this.manager.addToPriorityNodesSet(2,{nodeInfo:t,wireframe:!0}),i++),i}_getWireframeGeometryByNodeInfo(e,t){return this._getWireframeGeometryById(t.geometryId,this.manager.getGeometryByNodeInfo(e,t))}_getWireframeGeometryById(e,t){if(this.wireframeGeometryMap[e])return this.wireframeGeometryMap[e];var i,a,n=[];if(t instanceof Array)for(var s=0,o=t.length;s<o;s++)a=r.BuildEdge(t[s].attributes.position.array,t[s].index.array),(i=new THREE.BufferGeometry).setIndex(new THREE.Uint32BufferAttribute(a,1)),i.setAttribute("position",t[s].attributes.position,3),n.push(i);else a=r.BuildEdge(t.attributes.position.array,t.index.array),(i=new THREE.BufferGeometry).setIndex(new THREE.Uint32BufferAttribute(a,1)),i.setAttribute("position",t.attributes.position,3),n.push(i);return this.wireframeGeometryMap[e]=n,this.wireframeGeometryMap[e]}_traverseWireframeGeometryMap(e){for(var t=Object.keys(this.wireframeGeometryMap),i=0,r=t.length;i<r;i++){var a=this.wireframeGeometryMap[t[i]];if(a)for(var n=0,s=a.length;n<s;n++)e(a[n])}}_disposeGeometries(){this._traverseWireframeGeometryMap((function(e){e.dispose()}))}_isSatisfied(e,t){if(!this.manager.isNeedWireframing(t.userId))return!1;var i=e.getLoadedUserIdsObject();return!(i&&!i[t.userId])}disposeBufferAfterVbo(){}getPickingNodeGenerator(e){return e=null==e?"pick":e,this.pickingNodeGenerators||(this.pickingNodeGenerators={}),this.pickingNodeGenerators[e]||(this.pickingNodeGenerators[e]=new r.PickingWireFrameGenerator(this)),this.pickingNodeGenerators[e]}_getNodeGroupRenderOrder(e,t){return{groupRenderOrder:t&&t.transparent?0:e.cellDepth,renderOrder:e.octantId}}},function(){class e extends r.ModelView.MeshBaseManager{constructor(e){super(),this.manager=e,this.instanceGeometryMap={},this.bufferAttributeMap={},this.nodeIdxMapFromUserId={},this.matrixInfoMapFromUserId={},this.cachedInstance={vState:{},vColor:{},mcol0:{},mcol1:{},mcol2:{},mcol3:{},muvCol0:{},muvCol1:{},muvCol2:{}},this.selectedMeshes=[],this.nonSelectedMeshes=[],this.selectedObjectIds=[],this.mgIdMapFromOctantId={},this.activeMeshMap={}}destroy(){if(super.destroy(),this.pickingNodeGenerators){for(var e in this.pickingNodeGenerators)this.pickingNodeGenerators.hasOwnProperty(e)&&this.pickingNodeGenerators[e].destroy();this.pickingNodeGenerators=null}this.activeMeshMap=null,this.cachedInstance=null,this.bufferAttributeMap=null,this.nodeIdxMapFromUserId=null,this.matrixInfoMapFromUserId=null,this.disposeInstanceGeometries(),this.instanceGeometryMap=null,this.manager=null,this.selectedMeshes=null,this.nonSelectedMeshes=null,this.selectedObjectIds=null,this.mgIdMapFromOctantId=null}clearData(){if(this.pickingNodeGenerators)for(var e in this.pickingNodeGenerators)this.pickingNodeGenerators.hasOwnProperty(e)&&this.pickingNodeGenerators[e].clearData();this._clearActiveMeshMap(),this.bufferDestroyed=!1,this.disposeGeometries(),this.disposeInstanceGeometries(),this.clearInstanceCache()}clearInstanceCache(){this.cachedInstance.vState={},this.cachedInstance.vColor={},this.cachedInstance.mcol0={},this.cachedInstance.mcol1={},this.cachedInstance.mcol2={},this.cachedInstance.mcol3={},this.cachedInstance.muvCol0={},this.cachedInstance.muvCol1={},this.cachedInstance.muvCol2={},this.bufferAttributeMap={},this.nodeIdxMapFromUserId={},this.instanceGeometryMap={},this.matrixInfoMapFromUserId={},this.geometries={}}getBufferAttributesBy(e){if(this.bufferAttributeMap[e])return this.bufferAttributeMap[e];var t=this.cachedInstance,i=new THREE.InstancedBufferAttribute(new Float32Array(t.mcol0[e]),3,!1,1),r=new THREE.InstancedBufferAttribute(new Float32Array(t.mcol1[e]),3,!1,1),a=new THREE.InstancedBufferAttribute(new Float32Array(t.mcol2[e]),3,!1,1),n=new THREE.InstancedBufferAttribute(new Float32Array(t.mcol3[e]),3,!1,1),s=[],o=[],l=[];if(t.muvCol0[e])for(var d=0,h=t.muvCol0[e].length;d<h;d++)s.push(new THREE.InstancedBufferAttribute(new Float32Array(t.muvCol0[e][d]),2,!1,1)),o.push(new THREE.InstancedBufferAttribute(new Float32Array(t.muvCol1[e][d]),2,!1,1)),l.push(new THREE.InstancedBufferAttribute(new Float32Array(t.muvCol2[e][d]),2,!1,1));return this.bufferAttributeMap[e]={attributeMcol0:i,attributeMcol1:r,attributeMcol2:a,attributeMcol3:n,attributeMuvCol0Array:s,attributeMuvCol1Array:o,attributeMuvCol2Array:l},this.bufferAttributeMap[e]}resetInstanceMaterial(){var e=this;this.traverseInstanceGeometryMap((function(t,i){for(var a=0,n=i.length;a<n;++a)e._hasStateAttribute(i[a])&&(i[a].getAttribute("vState").array.fill(r.EnumInstanceState.NONE),i[a].getAttribute("vState").needsUpdate=!0,i[a].getAttribute("vState2").array.fill(r.EnumInstanceState.HIDDEN),i[a].getAttribute("vState2").needsUpdate=!0)}))}clearInstanceStateByUserId(e){function t(e,t,i,r){for(var a=e.getAttribute("vState").array,n=e.getAttribute("vState2").array,s=0;s<t.length;++s){var o=t[s];a[o]=i,n[o]=r}e.getAttribute("vState").needsUpdate=!0,e.getAttribute("vState2").needsUpdate=!0}var i=this,a=r.EnumInstanceState.NONE,n=r.EnumInstanceState.HIDDEN;this.traverseNodeIdxMapByUserId(e,(function(e,r){var s=i.getInstanceGeometries(e);if(s)for(var o=0,l=s.length;o<l;o++)i._hasStateAttribute(s[o])&&t(s[o],r,a,n)}))}updateInstanceStateByUserId(e,t,i,a){function n(e,t,i,r,a){for(var n=e.getAttribute("vState").array,s=e.getAttribute("vState2").array,o=e.getAttribute("aColor"),l=o?o.array:null,d=0;d<t.length;++d){var h=t[d];n[h]=i,s[h]=r,null!==l&&null!==a&&(l[4*h]=a[0],l[4*h+1]=a[1],l[4*h+2]=a[2],l[4*h+3]=a[3])}e.getAttribute("vState").needsUpdate=!0,e.getAttribute("vState2").needsUpdate=!0,o&&(o.needsUpdate=!0)}var s=e.materialManager,o=this;this.traverseNodeIdxMapByUserId(t,(function(l,d){var h=o.getInstanceGeometries(l);if(h){var c=o.manager.getMaterialIdByMeshId(l),u=o.getUsableMaterialColorParamsBy(e,c,i,a),p=u.rgbaColor,m=i;i===r.EnumInstanceState.TRANSPARENT&&(m=r.EnumInstanceState.OVERRIDED),i===r.EnumInstanceState.SELECTED&&o.cacheSelectedObjectIds(t,l);var f,g,v=s.getInstanceMaterialById(c,e)[0];v.transparent===u.transparent?(f=m,g=r.EnumInstanceState.HIDDEN):(f=r.EnumInstanceState.HIDDEN,g=m),m===r.EnumInstanceState.BLINK&&v.setBlinkColor(e.manager.blinkManager.getBlinkColor(e.id));for(var y=0,M=h.length;y<M;y++)o._hasStateAttribute(h[y])&&n(h[y],d,f,g,p)}}))}getUsableMaterialColorParamsBy(e,t,i,a){var n,s,o=e.selectedMaterial,l=e.getFilter()._getMaterialByName("scene"),d=e.materialManager,h=e.manager.getOverrideMaterialByName(t)||d.getMaterialById(t);switch(i){case r.EnumInstanceState.HOVER:a?(n=e.getFilter()._getMaterialByName(a),s=e.manager.sceneState.getHoverColorByMaterial(n)):s=e.manager.sceneState.getHoverColorByMaterial(h);break;case r.EnumInstanceState.SELECTED:s=r.MaterialUtil.getColorParamsByMaterial(o);break;case r.EnumInstanceState.TRANSPARENT:s=r.MaterialUtil.getColorParamsByMaterial(l);break;case r.EnumInstanceState.OVERRIDED:case r.EnumInstanceState.BLINK:a?(n=e.getFilter()._getMaterialByName(a),s=r.MaterialUtil.getColorParamsByMaterial(n)):s=r.MaterialUtil.getColorParamsByMaterial(h);break;default:s=r.MaterialUtil.getColorParamsByMaterial(h)}return s}getInstanceGeometries(e){return this.instanceGeometryMap[e]}_cacheInstanceGeometries(e,t){if(!this.instanceGeometryMap[e]){t instanceof Array||(t=[t]);for(var i=this.instanceGeometryMap[e]=[],r=0,a=t.length;r<a;++r)i[r]=new THREE.InstancedBufferGeometry,i[r].setIndex(t[r].index),i[r].setAttribute("position",t[r].attributes.position),i[r].setAttribute("normal",t[r].attributes.normal),i[r].setAttribute("uv",t[r].attributes.uv)}}traverseInstanceGeometryMap(e){var t=this.instanceGeometryMap;for(var i in t)e(i,t[i])}traverseInstanceGeometryMapById(e,t){var i=this.instanceGeometryMap[e];if(i)for(var r=0,a=i.length;r<a;r++)t(i[r],e)}disposeInstanceGeometries(){this.traverseInstanceGeometryMap((function(e,t){for(var i=0,r=t.length;i<r;i++)t[i].dispose()}))}cacheInstanceAttributeStateBy(e,t,i,r,a){var n=r.materialId,s=r.uvArrayBuffer;i instanceof Array||(i=[i]);var o=i.length,l=this.cachedInstance;if(!l.vState[t]){l.vState[t]=[],l.vColor[t]=[],l.mcol0[t]=[],l.mcol1[t]=[],l.mcol2[t]=[],l.mcol3[t]=[],l.muvCol0[t]=[],l.muvCol1[t]=[],l.muvCol2[t]=[];for(var d=0;d<o;++d)l.muvCol0[t][d]=[],l.muvCol1[t][d]=[],l.muvCol2[t][d]=[]}var h=a||e.materialManager.getMaterialById(n);l.vColor[t].push(h.color.r,h.color.g,h.color.b,h.opacity),l.vState[t].push(0);var c=r.matrix.elements;if(l.mcol0[t].push(c[0],c[1],c[2]),l.mcol1[t].push(c[4],c[5],c[6]),l.mcol2[t].push(c[8],c[9],c[10]),l.mcol3[t].push(c[12],c[13],c[14]),s)for(d=0;d<o;++d)l.muvCol0[t][d].push(s[6*d],s[6*d+1]),l.muvCol1[t][d].push(s[6*d+2],s[6*d+3]),l.muvCol2[t][d].push(s[6*d+4],s[6*d+5]);else for(d=0;d<o;++d)l.muvCol0[t][d].push(1,0),l.muvCol1[t][d].push(0,1),l.muvCol2[t][d].push(0,0);return l.vState[t].length-1}_cacheNodeIdxByUserId(e,t,i){var r=this.nodeIdxMapFromUserId;r[e]||(r[e]={}),r[e][t]||(r[e][t]=[]),r[e][t].push(i)}getNodeIdxMapByUserId(e){return this.nodeIdxMapFromUserId[e]}traverseNodeIdxMapByUserId(e,t){var i=this.nodeIdxMapFromUserId[e];for(var r in i)t(r,i[r])}traverseNodeIdxMap(e,t){for(var i=Object.keys(this.nodeIdxMapFromUserId),r=0,a=i.length;r<a;r++){var n=i[r];if(!t||!t(n)){var s=this.nodeIdxMapFromUserId[n];for(var o in s)e(o,s[o])}}}_cacheMatrixInfoByUserId(e,t,i){var r=this.matrixInfoMapFromUserId;r[e]||(r[e]={}),r[e][t]||(r[e][t]=[]),r[e][t].push(i)}traverseMatrixInfoMapByUserId(e,t){var i=this.matrixInfoMapFromUserId[e];for(var r in i)t(r,i[r])}getMeshesByUserId(e,t){var i=this;this.traverseMatrixInfoMapByUserId(t,(function(r,a){for(var n=i.getInstanceNodesById(r),s=0,o=a.length;s<o;s++)for(var l=0,d=n.length;l<d;l++){var h={};if(h.matrix=a[s].matrix,h.mesh=n[l],1===d)h.boundingBox=a[s].boundingBox;else{var c=h.mesh.geometry.boundingBox;c?c=c.clone():(h.mesh.geometry.computeBoundingBox(),c=h.mesh.geometry.boundingBox.clone()),c.applyMatrix4(h.matrix),h.boundingBox=c}e.minDistanceObjects[t].push(h)}}))}clearSelectedObjectIds(){}cacheSelectedObjectIds(e,t){}adjustVisibility(e,t){}changeVisibilityOfSelectedObjects(e,t){}changeVisibilityOfNonSelectedObjects(e,t){}restoreVisibilityOfObjects(){}disposeBufferAfterVbo(){}_cacheToMgIdMapFromOctantId(e,t,i){this.mgIdMapFromOctantId[e]||(this.mgIdMapFromOctantId[e]={}),this.mgIdMapFromOctantId[e][i]||(this.mgIdMapFromOctantId[e][i]={cellId:e,cellDepth:t,mgId:i})}traverseMgIdMapByOctantId(e,t,i){if(this.mgIdMapFromOctantId[e])for(var r=this.mgIdMapFromOctantId[e],a=Object.keys(r),n=0,s=a.length;n<s;n++){var o=r[a[n]];if(i&&i(o.mgId))break;t(e,o)}}_createGeometryById(e){if(this.geometryMap||(this.geometryMap={}),!this.geometryMap[e]){this.geometryMap[e]=!0;for(var t=this.cachedInstance,i=this.getBufferAttributesBy(e),a=this.getInstanceGeometries(e),n=0,s=a.length;n<s;n++){a[n].setAttribute("mcol0",i.attributeMcol0),a[n].setAttribute("mcol1",i.attributeMcol1),a[n].setAttribute("mcol2",i.attributeMcol2),a[n].setAttribute("mcol3",i.attributeMcol3),i.attributeMuvCol0Array.length>0&&(a[n].setAttribute("muvCol0",i.attributeMuvCol0Array[n]),a[n].setAttribute("muvCol1",i.attributeMuvCol1Array[n]),a[n].setAttribute("muvCol2",i.attributeMuvCol2Array[n])),a[n].setAttribute("aColor",new THREE.InstancedBufferAttribute(new Float32Array(t.vColor[e]),4,!1,1)),a[n].setAttribute("vState",new THREE.InstancedBufferAttribute(new Float32Array(t.vState[e]),1,!1,1)),a[n].setAttribute("vState2",new THREE.InstancedBufferAttribute(new Float32Array(t.vState[e]),1,!1,1));var o=a[n].getAttribute("vState").array,l=a[n].getAttribute("vState2").array;o.fill(r.EnumInstanceState.NONE),l.fill(r.EnumInstanceState.HIDDEN);var d=a[n].index;a[n].addGroup(0,d.count,0),a[n].addGroup(0,d.count,1)}}}cullNodes(e,t,i){var r=this;return this.traverseMgIdMapByOctantId(t,(function(e,t){r.manager.addToPriorityNodesSet(2,t)}),(function(t){return i+=1,!!r.manager.isFull(e,i)&&(i-=1,!0)})),i}updateNode(e,t){const i=this,a=this.manager.getMaterialIdByMeshId(t.mgId),n=e.materialManager.getInstanceMaterialById(a,e),s=this._getNodeGroupRenderOrder(t,n[0]);this._createGeometryById(t.mgId),this.traverseInstanceGeometryMapById(t.mgId,(function(a,o){const l=e.pool.get({databagId:e.databagId,meshId:o,geometry:a,material:n,isMesh:!0,isLine:!1,isLineSegments:!1,instanceOrNot:!0,groupOrder:s.groupRenderOrder,renderOrder:s.renderOrder});l&&(i._cacheActiveMesh(t.mgId,l),e.manager.addMeshToOctantMap(e.getEncodedDatabagId(),o,new r.InstancedCapsuleObject(o,l)))}))}createInstanceNodeInfo(e,t,i){var r=this;this.octantIdMap||(this.octantIdMap={}),this.octantIdMap[t]||(this.octantIdMap[t]=!0,this.manager.traverseNodeInfoMapByOctantId(t,(function(t,a){var n=r.getGeometryByNodeInfo(e,a),s=e.manager.getOverrideMaterialByNodeInfo(a,e.materialManager.getMaterialById(a.materialId));s&&(a.materialId=s.name);var o=r.manager.getMeshIdByNodeInfo(a),l=r.cacheInstanceAttributeStateBy(e,o,n,a,s);r._cacheNodeIdxByUserId(a.userId,o,l),r._cacheMatrixInfoByUserId(a.userId,o,{matrix:a.matrix,boundingBox:a.boundingBox}),r._cacheInstanceGeometries(o,n),r._cacheToMgIdMapFromOctantId(t,i,o)})))}getCachedInstanceData(){return this.cachedInstance}_hasStateAttribute(e){return!!e.attributes.vState}getGeometryBuffersByUserId(e,t){var i=e.getModelDescriptor().getInstancedNodeInfosById(t);if(!i)return[];for(var a=[],n=e.getDatabagId(),s=0,o=i.length;s<o;s++){var l=i[s],d=this.getGeometryByNodeInfo(e,l);if(d){var h=r.ModelView.BaseDescriptor.isLineNode(l);if(d instanceof Array)for(var c=0,u=d.length;c<u;c++)a.push({isLines:h,databagId:n,nodeId:l.nodeId,position:d[c].getAttribute("position").array,index:d[c].getIndex().array,matrix:l.matrix});else a.push({isLines:h,databagId:n,nodeId:l.nodeId,position:d.getAttribute("position").array,index:d.getIndex().array,matrix:l.matrix})}}return a}traverseActiveMeshMap(e,t){for(var i=0,r=(e=e||Object.keys(this.activeMeshMap)).length;i<r;i++){var a=e[i];if(this.activeMeshMap[a])t(a,this.activeMeshMap[a])}}getActiveMeshMapById(e){return this.activeMeshMap[e]}_cacheActiveMesh(e,t){this.activeMeshMap[e]||(this.activeMeshMap[e]=[]),this.activeMeshMap[e].push(t)}_clearActiveMeshMap(){this.activeMeshMap={}}getPickingNodeGenerator(e){return e=null==e?"pick":e,this.pickingNodeGenerators||(this.pickingNodeGenerators={}),this.pickingNodeGenerators[e]||(this.pickingNodeGenerators[e]=new r.PickingIncrementInstancedMeshGenerator(this),this.pickingNodeGenerators[e].reserveMaterial=!!e.startsWith("glow")),this.pickingNodeGenerators[e]}_getNodeGroupRenderOrder(e,t){return{groupRenderOrder:t&&t.transparent?0:e.cellDepth,renderOrder:e.octantId}}}r.ModelView.IncrementInstancedMeshManager=e}(),r.ModelView.IncrementInstancedWireframeManager=class{constructor(e){this.manager=e,this.wireframeGeometryMap={},this.wireframeBufferMap={}}destroy(){if(this.pickingNodeGenerators){for(var e in this.pickingNodeGenerators)this.pickingNodeGenerators.hasOwnProperty(e)&&this.pickingNodeGenerators[e].destroy();this.pickingNodeGenerators=null}this.disposeGeometries(),this.wireframeGeometryMap=null,this.wireframeBufferMap=null,this.manager=null}clearData(){if(this.pickingNodeGenerators)for(var e in this.pickingNodeGenerators)this.pickingNodeGenerators.hasOwnProperty(e)&&this.pickingNodeGenerators[e].clearData();this.disposeGeometries(),this.wireframeGeometryMap={},this.wireframeBufferMap={}}disposeGeometries(){this._traverseWireframeGeometryMap((function(e){e.dispose()}))}cullNodes(e,t,i){var r=this;return this.manager.getMeshManager().traverseMgIdMapByOctantId(t,(function(e,t){r.manager.addToPriorityNodesSet(2,{wireframe:!0,nodeInfo:t})}),(function(t){return i+=1,!!r.manager.isFull(e,i)&&(i-=1,!0)})),i}updateNode(e,t){const i=e.pool,r=e.getInstanceWireframeMaterial(),a=this._getNodeGroupRenderOrder(t,r);this._createGeometryById(t.mgId),this._traverseWireframeGeometryMapById(t.mgId,(function(t,n){i.get({databagId:e.databagId,meshId:n,geometry:t,material:r,isMesh:!1,isLine:!0,isLineSegments:!0,groupOrder:a.groupRenderOrder,renderOrder:a.renderOrder})}))}resetInstanceMaterial(){var e=r.EnumInstanceState.NONE,t=this;this._traverseWireframeGeometryMap((function(i){if(t._hasStateAttribute(i)){for(var r=i.getAttribute("vState").array,a=0,n=r.length;a<n;a++)r[a]=e;i.getAttribute("vState").needsUpdate=!0}})),this._updateNoWireframingState()}updateInstanceWireframeByUserId(e,t){if(t===r.EnumInstanceState.HIDDEN||t===r.EnumInstanceState.NONE){var i=this;this.manager.traverseNodeIdxMapByUserId(e,(function(e,r){i._setInstanceWireframeState(e,r,t)}))}}_getWireframeBufferById(e){var t=this.manager.getCombinedKeys(e).geometryId;if(this.wireframeBufferMap[t])return this.wireframeBufferMap[t];var i=this.manager.getMeshManager().getInstanceGeometries(e);if(!i)return[];for(var a=this.wireframeBufferMap[t]=[],n=0,s=i.length;n<s;n++){var o=i[n];a.push({index:r.BuildEdge(i[n].attributes.position.array,o.index.array),position:o.attributes.position})}return a}_traverseWireframeGeometryMap(e){for(var t=Object.keys(this.wireframeGeometryMap),i=0,r=t.length;i<r;i++)this._traverseWireframeGeometryMapById(t[i],e)}_traverseWireframeGeometryMapById(e,t){var i=this.wireframeGeometryMap[e];if(i)for(var r=0,a=i.length;r<a;r++)t(i[r],e)}_createGeometryById(e){if(!this.wireframeGeometryMap[e])for(var t=this.wireframeGeometryMap[e]=[],i=this.manager.getMeshManager().getBufferAttributesBy(e),r=this.manager.getMeshManager().getCachedInstanceData(),a=this._getWireframeBufferById(e),n=0,s=a.length;n<s;n++){var o=new THREE.InstancedBufferGeometry;o.setIndex(a[n].index),o.setAttribute("position",a[n].position),o.setAttribute("vState",new THREE.InstancedBufferAttribute(new Float32Array(r.vState[e]),1,!1,1)),o.setAttribute("mcol0",i.attributeMcol0),o.setAttribute("mcol1",i.attributeMcol1),o.setAttribute("mcol2",i.attributeMcol2),o.setAttribute("mcol3",i.attributeMcol3),t.push(o)}}_updateNoWireframingState(){var e=this,t=r.EnumInstanceState.HIDDEN;this.manager.traverseNodeIdxMap((function(i,r){e._setInstanceWireframeState(i,r,t)}),(function(t){return e.manager.isNeedWireframing(t)}))}_setInstanceWireframeState(e,t,i){var r=this;this._traverseWireframeGeometryMapById(e,(function(e){if(r._hasStateAttribute(e)){for(var a=e.getAttribute("vState").array,n=0,s=t.length;n<s;++n)a[t[n]]=i;e.getAttribute("vState").needsUpdate=!0}}))}adjustVisibility(e,t){}changeVisibilityOfSelectedObjects(e,t){}changeVisibilityOfNonSelectedObjects(e,t){this.adjustVisibility(e,t)}restoreVisibilityOfObjects(){}disposeBufferAfterVbo(){}_hasStateAttribute(e){return!!e.attributes.vState}getPickingNodeGenerator(e){return e=null==e?"pick":e,this.pickingNodeGenerators||(this.pickingNodeGenerators={}),this.pickingNodeGenerators[e]||(this.pickingNodeGenerators[e]=new r.PickingIncrementInstancedWireFrameGenerator(this)),this.pickingNodeGenerators[e]}_getNodeGroupRenderOrder(e,t){return{groupRenderOrder:t&&t.transparent?0:e.cellDepth,renderOrder:e.octantId}}},r.ModelView.IncrementInstancedManager=class{constructor(){this.meshManager=new r.ModelView.IncrementInstancedMeshManager(this),this.wireframeManager=new r.ModelView.IncrementInstancedWireframeManager(this),this.nodeInfoMapFromOctant={}}destroy(){this.meshManager.destroy(),this.meshManager=null,this.wireframeManager.destroy(),this.wireframeManager=null,this.nodeInfoMapFromOctant=null}clearData(){this.clearNodeInfoMap(),this.meshManager.clearData(),this.wireframeManager.clearData()}getGeometryByNodeInfo(e,t){return this.meshManager.getGeometryByNodeInfo(e,t)}traverseInstanceGeometryMap(e){this.meshManager.traverseInstanceGeometryMap(e)}traverseNodeIdxMapByUserId(e,t){this.meshManager.traverseNodeIdxMapByUserId(e,t)}traverseNodeIdxMap(e,t){this.meshManager.traverseNodeIdxMap(e,t)}getMeshesByUserId(e,t){this.meshManager.getMeshesByUserId(e,t)}_updateInstanceMaterialByUserId(e,t,i,r){this.meshManager.updateInstanceStateByUserId(e,t,i,r),this.wireframeManager.updateInstanceWireframeByUserId(t,i)}_updateInstanceMaterial(e){r.Logger.time("update instance material");var t=r.Model.EnumFilterState;for(var i in this.clearSelectedObjectIds(),this.filteredIds){var a=this.filteredIds[i];if(a[t.HIDDEN])this._updateInstanceMaterialByUserId(e,i,r.EnumInstanceState.HIDDEN);else if(a[t.TRANSPARENT])this._updateInstanceMaterialByUserId(e,i,r.EnumInstanceState.TRANSPARENT);else{if(e.manager.isSelectPriority()){if(a[t.SELECTED]){r.GlobalData.PickingEffect?a[t.OVERRIDED]&&this._updateInstanceMaterialByUserId(e,i,r.EnumInstanceState.OVERRIDED,a[t.OVERRIDED]):this._updateInstanceMaterialByUserId(e,i,r.EnumInstanceState.SELECTED);continue}if(a[t.BLINK]){a[t.OVERRIDED]?this._updateInstanceMaterialByUserId(e,i,r.EnumInstanceState.BLINK,a[t.OVERRIDED]):this._updateInstanceMaterialByUserId(e,i,r.EnumInstanceState.BLINK);continue}}else{if(a[t.BLINK]){a[t.OVERRIDED]?this._updateInstanceMaterialByUserId(e,i,r.EnumInstanceState.BLINK,a[t.OVERRIDED]):this._updateInstanceMaterialByUserId(e,i,r.EnumInstanceState.BLINK);continue}if(a[t.SELECTED]){r.GlobalData.PickingEffect?a[t.OVERRIDED]&&this._updateInstanceMaterialByUserId(e,i,r.EnumInstanceState.OVERRIDED,a[t.OVERRIDED]):this._updateInstanceMaterialByUserId(e,i,r.EnumInstanceState.SELECTED);continue}}a[t.HOVER]?a[t.OVERRIDED]?this._updateInstanceMaterialByUserId(e,i,r.EnumInstanceState.HOVER,a[t.OVERRIDED]):this._updateInstanceMaterialByUserId(e,i,r.EnumInstanceState.HOVER):a[t.OVERRIDED]&&this._updateInstanceMaterialByUserId(e,i,r.EnumInstanceState.OVERRIDED,a[t.OVERRIDED])}}r.Logger.timeEnd("update instance material")}_resetInstanceMaterial(){this.meshManager.resetInstanceMaterial(),this.wireframeManager.resetInstanceMaterial()}_collectFilteredUserIds(e,t,i){var a=e.getFilter(),n=a._hasHiddenFileIdFilter(),s=a._hasVisibleFilter(),o=a._hasOverrideMaterialFilter(),l=a._hasTransparentFilter(),d=e.hasReplacedUserId(),h=e.hasHiddenSourceObjectUserId(),c=this.filteredIds={};if(n||s||o||l||d||h)for(var u=r.Model.EnumFilterState,p=0;p<t.length;++p){var m=t[p],f=i[m];if(f&&f.length){var g=f[0];if(n&&a._isHiddenFileId(g)||s&&!1===a._isVisible(g)||e.isReplacedUserId(m)||e.isHiddenSourceObjectUserId(m))c[m]||(c[m]={}),c[m][u.HIDDEN]=!0;else if(l&&a._isTransparent(g))c[m]||(c[m]={}),c[m][u.TRANSPARENT]=!0;else if(o&&a._hasOverrideMaterial(g)){var v=a._getOverrideMaterial(g),y=null!=v?v.name:"";""!==y&&(c[m]||(c[m]={}),c[m][u.OVERRIDED]=y)}}}}_collectSelectedUserIds(e,t){var i=this.filteredIds=this.filteredIds||{},a=r.Model.EnumFilterState,n={};for(var s in e)t[s]&&(i[s]||(i[s]={}),i[s][a.SELECTED]=!0,n[s]=!0);this.selectedUserIds=Object.keys(n)}_clearSelectedState(e){if(this.filteredIds&&this.selectedUserIds&&this.selectedUserIds.length){for(var t=0,i=this.selectedUserIds.length;t<i;t++){var a=this.selectedUserIds[t];this.filteredIds[a]&&(this.meshManager.clearInstanceStateByUserId(a),delete this.filteredIds[a][r.Model.EnumFilterState.SELECTED])}this.selectedUserIds=null}}_collectHoveredUserIds(e,t){var i=this.filteredIds=this.filteredIds||{};this.hoverdUserId=void 0,e&&t[e]&&(i[e]||(i[e]={}),i[e][r.Model.EnumFilterState.HOVER]=!0,this.hoverdUserId=e)}_clearHoveredState(e){this.filteredIds&&this.hoverdUserId&&this.filteredIds[this.hoverdUserId]&&(this.meshManager.clearInstanceStateByUserId(this.hoverdUserId),delete this.filteredIds[this.hoverdUserId][r.Model.EnumFilterState.HOVER],this.hoverdUserId=void 0)}_collectBlinkedUserIds(e,t){var i=this.filteredIds=this.filteredIds||{},a=r.Model.EnumFilterState,n={};for(var s in e)t[s]&&(i[s]||(i[s]={}),i[s][a.BLINK]=!0,n[s]=!0);this.blinkUserIds=Object.keys(n)}_clearBlinkedState(e){if(this.filteredIds&&this.blinkUserIds&&this.blinkUserIds.length){for(var t=0,i=this.blinkUserIds.length;t<i;t++){var a=this.blinkUserIds[t];this.filteredIds[a]&&(this.meshManager.clearInstanceStateByUserId(a),delete this.filteredIds[a][r.Model.EnumFilterState.BLINK])}this.blinkUserIds=null}}applyFilter(e,t){if(this.hasNodeInfo(e)){var i;this.updateNodes(e),this._resetInstanceMaterial(),i=t||e.getModelDescriptor().getInstancedUserIds();var r=e.getModelDescriptor().getInstancedNodeInfos();this._collectFilteredUserIds(e,i,r),this._collectSelectedUserIds(e.manager.sceneState.selectionSet,r),this._collectBlinkedUserIds(e.manager.sceneState.getBlinkComponentsIdMap(e.id),r),this._collectHoveredUserIds(e.manager.sceneState.hoverId,r),this._updateInstanceMaterial(e)}}applySelection(e){if(this.hasNodeInfo(e)){var t=e.getModelDescriptor().getInstancedNodeInfos();this._clearSelectedState(e),this._clearHoveredState(e),this._collectSelectedUserIds(e.manager.sceneState.selectionSet,t),this._collectHoveredUserIds(e.manager.sceneState.hoverId,t),this._updateInstanceMaterial(e),this.updateNodes(e)}}clearSelection(e){this._clearSelectedState(e),this.applyHover(e)}applyHover(e){if(this.hasNodeInfo(e)){var t=e.getModelDescriptor().getInstancedNodeInfos();this._clearHoveredState(e),this._collectHoveredUserIds(e.manager.sceneState.hoverId,t),this._updateInstanceMaterial(e),this.updateNodes(e)}}clearHover(e){this._clearHoveredState(e),this._updateInstanceMaterial(e),this.updateNodes(e)}applyBlink(e){if(this.hasNodeInfo(e)){var t=e.getModelDescriptor().getInstancedNodeInfos();this._clearBlinkedState(e),this._clearHoveredState(e),this._collectBlinkedUserIds(e.manager.sceneState.getBlinkComponentsIdMap(e.id),t),this._collectHoveredUserIds(e.manager.sceneState.hoverId,t),this._updateInstanceMaterial(e),this.updateNodes(e)}}clearBlink(e){this._clearBlinkedState(e),this.applyHover(e)}applyReplacement(e){this._updateInstanceMaterial(e),this.updateNodes(e)}updateNode(e,t){t.wireframe?this.wireframeManager.updateNode(e,t.nodeInfo):this.meshManager.updateNode(e,t)}updateNodes(e){}createMeshNodes(e,t,i){this.meshManager.createMeshNodes(e,t,i)}clearCachedData(){this.meshManager.disposeGeometries()}getMeshesByUserIds(e,t,i){this.meshManager.getMeshesByUserIds(e,t,i)}clearSelectedObjectIds(){this.meshManager.clearSelectedObjectIds()}adjustVisibility(e,t){this.meshManager.adjustVisibility(e,t),this.wireframeManager.adjustVisibility(e,t)}changeVisibilityOfSelectedObjects(e,t){this.meshManager.changeVisibilityOfSelectedObjects(e,t),this.wireframeManager.changeVisibilityOfSelectedObjects(e,t)}changeVisibilityOfNonSelectedObjects(e,t){this.meshManager.changeVisibilityOfNonSelectedObjects(e,t),this.wireframeManager.changeVisibilityOfNonSelectedObjects(e,t)}restoreVisibilityOfObjects(){this.meshManager.restoreVisibilityOfObjects(),this.wireframeManager.restoreVisibilityOfObjects()}disposeBufferAfterVbo(){this.meshManager.disposeBufferAfterVbo(),this.wireframeManager.disposeBufferAfterVbo()}cullNodes(e,t,i,r,a){return this.hasOctantId(t)?(this.meshManager.createInstanceNodeInfo(e,t,i),0===r?this.meshManager.cullNodes(e,t,a):1===r?this.wireframeManager.cullNodes(e,t,a):a):a}clearNodeInfoMap(){this.nodeInfoMapFromOctant={}}cacheToNodeInfoMap(e,t){this.nodeInfoMapFromOctant[e]||(this.nodeInfoMapFromOctant[e]=[]),this.nodeInfoMapFromOctant[e].push(t)}traverseNodeInfoMapByOctantId(e,t){if(this.nodeInfoMapFromOctant[e])for(var i=0,r=this.nodeInfoMapFromOctant[e].length;i<r;i++)t(e,this.nodeInfoMapFromOctant[e][i])}traverseNodeInfoMap(e){for(var t=Object.keys(this.nodeInfoMapFromOctant),i=0,r=t.length;i<r;i++)this.traverseNodeInfoMapByOctantId(t[i],e)}traverseNodeInfoMapByIds(e,t){if(e)for(var i=Object.keys(this.nodeInfoMapFromOctant),r=0,a=i.length;r<a;r++)for(var n=i[r],s=this.nodeInfoMapFromOctant[n],o=0,l=s.length;o<l;o++)e[s[o].userId]&&t(n,s[o]);else this.traverseNodeInfoMap(t)}hasNodeInfo(){return!r.Utils.isEmptyObjectSimple(this.nodeInfoMapFromOctant)}hasOctantId(e){return!(!this.nodeInfoMapFromOctant[e]||!this.nodeInfoMapFromOctant[e].length)}addToPriorityNodesSet(e,t){this.handler.addToPriorityNodesSet(e,t)}isFull(e,t){return this.handler.isFull(e,t)}isNeedWireframing(e){return this.handler.isNeedWireframing(e)}getMeshIdByNodeInfo(e){return r.Utils.getCombinedKeyString([e.materialId,e.geometryId,e.cellId])}getMaterialIdByMeshId(e){return r.Utils.splitCombinedKeyString(e)[0]}getCombinedKeys(e){var t=r.Utils.splitCombinedKeyString(e);return{materialId:t[0],geometryId:t[1],cellId:t[2]}}getNodeInfoCountById(e){var t=this.meshManager.getCachedInstanceData();return t.vState[e]?t.muvCol0&&t.muvCol0[e]&&t.muvCol0[e].length?t.muvCol0[e].length*t.vState[e].length:t.vState[e].length:0}getGeometryBuffersByUserId(e,t){return this.meshManager.getGeometryBuffersByUserId(e,t)}isPickableNode(e){if(!this.filteredIds||!this.filteredIds[e])return!0;var t=this.filteredIds[e],i=r.Model.EnumFilterState;return!t[i.HIDDEN]&&!t[i.TRANSPARENT]}isHiddenNode(e){return!!(this.filteredIds&&this.filteredIds[e]&&this.filteredIds[e][r.Model.EnumFilterState.HIDDEN])}getMeshManager(){return this.meshManager}getWireFrameManager(){return this.wireframeManager}},r.ModelView.IncrementedManager=class{constructor(){this.meshManager=new r.ModelView.IncrementedMeshManager(this),this.wireframeManager=new r.ModelView.IncrementedWireframeManager(this),this.nodeInfoMapFromOctant={},this.handler=null}destroy(){this.meshManager.destroy(),this.meshManager=null,this.wireframeManager.destroy(),this.wireframeManager=null,this.nodeInfoMapFromOctant=null,this.handler=null}clearData(){this.clearNodeInfoMap(),this.meshManager.clearData(),this.wireframeManager.clearData()}disposeGeometry(e){this.meshManager.disposeGeometry(e)}clearNodeInfoMap(){this.nodeInfoMapFromOctant={}}cacheToNodeInfoMap(e,t){this.nodeInfoMapFromOctant[e]||(this.nodeInfoMapFromOctant[e]=[]),this.nodeInfoMapFromOctant[e].push(t)}traverseNodeInfoMapByOctantId(e,t){if(this.nodeInfoMapFromOctant[e])for(var i=0,r=this.nodeInfoMapFromOctant[e].length;i<r;i++)t(e,this.nodeInfoMapFromOctant[e][i])}hasNodeInfo(){return!r.Utils.isEmptyObjectSimple(this.nodeInfoMapFromOctant)}hasOctantId(e){return!(!this.nodeInfoMapFromOctant[e]||!this.nodeInfoMapFromOctant[e].length)}cullNodes(e,t,i,r,a){return this.hasOctantId(t)?0===r?this.meshManager.cullNodes(e,t,a):1===r?this.wireframeManager.cullNodes(e,t,a):a:a}updateNode(e,t,i){t.wireframe?this.wireframeManager.updateNode(e,t.nodeInfo,i):this.meshManager.updateNode(e,t,i)}updateNodes(e){}applyFilter(e,t){}applySelection(e){}clearSelection(e){}applyHover(e){}clearHover(e){}applyBlink(e){}clearBlink(e){}applyReplacement(e){}getGeometryByNodeInfo(e,t){return this.meshManager.getGeometryByNodeInfo(e,t)}getLoader(e){return e.loader}getMeshesByUserIds(e,t,i){this.meshManager.getMeshesByUserIds(e,t,i)}disposeBufferAfterVbo(){this.meshManager.disposeBufferAfterVbo(),this.wireframeManager.disposeBufferAfterVbo()}addToPriorityNodesSet(e,t){this.handler.addToPriorityNodesSet(e,t)}isFull(e,t){return this.handler.isFull(e,t)}isNeedWireframing(e){return this.handler.isNeedWireframing(e)}getGeometryBuffersByUserId(e,t){return this.meshManager.getGeometryBuffersByUserId(e,t)}isPickableNode(e){return!0}isHiddenNode(e){return!1}getMeshManager(){return this.meshManager}getWireFrameManager(){return this.wireframeManager}},r.ModelView.IncrementCompositedManager=class{constructor(){this.defaultManager=new r.ModelView.IncrementedManager,this.instancedManager=new r.ModelView.IncrementInstancedManager,this.defaultManager.handler=this,this.instancedManager.handler=this,this.priorityNodesSet=[[],[],[]],this.octantManager=new r.OctantManager,this.noNeedWireframingIdMap={}}destroy(){this.defaultManager.handler=null,this.instancedManager.handler=null,this.defaultManager=null,this.instancedManager=null,this.clearPriorityNodesSet(),this.priorityNodesSet=null,this.octantManager.destroy(),this.octantManager=null,this.noNeedWireframingIdMap=null}clearData(){this.clearNoNeedWireframingIdMap(),this.defaultManager.clearData(),this.instancedManager.clearData()}settleData(e,t){var i=this.octantManager.getAllOctants(e);i.length>0?this._parseItemDataByOctants(e,i,(function(){t&&t()})):t&&t()}cullNodes(e,t){this.clearPriorityNodesSet(),this._collectNoWireframingIds(e);var i=this.octantManager.getVisibleOctants(e,t,!0);if(i.length){var r=0;if(!e.isOnlyWireframe())return e.isActivateWireframe()?(r=this._cullNodesByVisibleOctant(e,i,0,r),void this._cullNodesByVisibleOctant(e,i,1,r)):void this._cullNodesByVisibleOctant(e,i,0,r);this._cullNodesByVisibleOctant(e,i,1,r)}}_cullNodesByVisibleOctant(e,t,i,r){for(var a=0,n=t.length;a<n;++a){var s=t[a].octantId,o=t[a].depth;if(r=this.defaultManager.cullNodes(e,s,o,i,r),r=this.instancedManager.cullNodes(e,s,o,i,r),this.isFull(e,r))break}return r}updateNodes(e){var t=this;this.traversePriorityNodesSet((function(i,r){t._isInstanceNode(r)?t.instancedManager.updateNode(e,r):t.defaultManager.updateNode(e,r,i)})),r.GlobalData.DEBUG&&this.octantManager.showOctreeBox(e)}_collectNoWireframingIds(e){if(!this.wireframingIdCollected){this.wireframingIdCollected=!0;var t=this,i=e.getFilter();e.getModelDescriptor().traverseNodeInfosByCell((function(e,a){(nodeInfos&&i.getWireFrameVisibilityCondition()&&!i._isRenderWithWireFrame(a)||a.type===r.ModelView.BaseDescriptor.EnumNodeItemType.LINE||i._hasRenderWithBoardlineFilter()&&!i._isRenderWithBoardline(a))&&(t.noNeedWireframingIdMap[a.userId]=!0)}))}}isNeedWireframing(e){return!this.noNeedWireframingIdMap||!this.noNeedWireframingIdMap[e]}clearNoNeedWireframingIdMap(){this.wireframingIdCollected=!1,this.noNeedWireframingIdMap={}}disposeBufferAfterVbo(){this.defaultManager.disposeBufferAfterVbo(),this.instancedManager.disposeBufferAfterVbo()}isFull(e,t){return!(t<e.getRenderableCount())}clearPriorityNodesSet(){this.priorityNodesSet[0]=[],this.priorityNodesSet[1]=[],this.priorityNodesSet[2]=[]}addToPriorityNodesSet(e,t){e=e<0||e>2?2:e,this.priorityNodesSet[e].push(t)}traversePriorityNodesSet(e){for(var t=this.priorityNodesSet,i=0,r=t.length;i<r;++i)for(var a=t[i],n=0,s=Object.keys(a).length;n<s;++n)e(i,a[n])}_parseItemDataByOctants(e,t,i){var r=this,a=t.length;requestAnimationFrame(function n(s){var o=s;return function(){var s=t[o].octantId,l=t[o].depth;r._parseItemDataByOctantId(e,s,l),o<a-1?requestAnimationFrame(n(o+1)):i&&i()}}(0))}_parseItemDataByOctantId(e,t,i){e.getModelDescriptor().parseItemDataByCellId(t);var r=e.getModelDescriptor().getNodeInfosByCellId(t);if(r)for(var a,n=0,s=r.length;n<s;n++)(a=r[n]).cellDepth=i,a.instanceOrNot?this.instancedManager.cacheToNodeInfoMap(t,a):this.defaultManager.cacheToNodeInfoMap(t,a),e.manager.addNodeInfoToOctantMap(e.getEncodedDatabagId(),t,a)}_isInstanceNode(e){return!!(e.mgId||e.nodeInfo&&e.nodeInfo.mgId)}},function(){class e extends r.ModelView.ModelBaseHandler{constructor(e){super(e),this.tag="default",this.compositedManager=new r.ModelView.IncrementCompositedManager,this.defaultManager=this.compositedManager.defaultManager,this.instancedManager=this.compositedManager.instancedManager,this.loader=new r.ModelView.DefaultLoader(this)}destroy(){this.compositedManager.destroy(),this.compositedManager=null,super.destroy()}prepareData(e){if(!this.dataReady){var t=this;this.compositedManager.settleData(this.model,(function(){t.dataReady=!0,t.settleData(e)}))}}settleData(e){this.model.getModelDescriptor().classifyAllNodeInfo(),this.model.getModelDescriptor().destroyReader(),this.loaded=!0,e&&e()}isAllReady(){return!(!this.isLoaded()||this.isHidden())}prepare(e){this.isAllReady()&&(this.model.getMaterialManager()._updateTextureMapping(),this.model.clearMeshFromOctantMap(),this.compositedManager.cullNodes(this.model,e),this.compositedManager.updateNodes(this.model))}updateNodes(){}}r.ModelView.IncrementHandler=e}(),function(){let e=new THREE.Vector3;class t extends r.ModelView.MeshBaseManager{constructor(e){super(),this.manager=e,this.nodePriority={high:[],medium:[],low:[]},this.visibleOctant=[],this.occlusionVisibleOctant=[],this.usedNodeInfosObject={},this.lineNodes={},this.blinkMaterials=[],this.activeMeshMap={},this._priorityRange={max:0,min:0}}destroy(){if(super.destroy(),this.clearData(),this.pickingNodeGenerators){for(var e in this.pickingNodeGenerators)this.pickingNodeGenerators.hasOwnProperty(e)&&this.pickingNodeGenerators[e].destroy();this.pickingNodeGenerators=null}this.activeMeshMap=null,this.manager=null,this.nodePriority=null,this.visibleOctant=null,this.occlusionVisibleOctant=null,this.nodePriority=null,this.lineNodes=null,this.blinkMaterials=null}disposeLineNodes(){for(var e in this.lineNodes){var t=this.lineNodes[e];t.geometry.dispose(),t=null,delete this.lineNodes[e]}}clearData(){if(this.pickingNodeGenerators)for(var e in this.pickingNodeGenerators)this.pickingNodeGenerators.hasOwnProperty(e)&&this.pickingNodeGenerators[e].clearData();this._clearActiveMeshMap(),this.disposeGeometries(),this.disposeLineNodes(),this._clearNodePriorityData(!0),this._clearUsedNodeInfosObject(),this.visibleOctant.length=0,this.occlusionVisibleOctant.length=0}update(e){var t=this._updateMeshNodes(e);return this._applyOcclusionTranslucent(e),t}cullNodes(e,t){this._clearNodePriorityData(!0),this._adjustLowNodePriorityLength(e);var i=0;i=r.GlobalData.EnableOctant?this._cullNodesWithOctant(e,t):this._cullNodesWithFull(e),e.prioritizedNodeCount=this._calcPrioritizedNodeCount(e,i)}getPriorityNodes(){return[this.nodePriority.high,this.nodePriority.medium,this.nodePriority.low]}_cullNodesWithInnerAndOuterOctree(e,t){var i=0,r=0,a=e.getModelDescriptor().getOctreeRootNode(),n=a.inner,s=a.outer;if(this.manager.getContainsCamera(e)||!s)return this.visibleOctant.length=0,n&&this._frustumCull(e,t,n),s&&this._frustumCull(e,t,s),(r=this.visibleOctant.length)>0&&(this._sortVisibleOctant(t),i=this._logicCull(e,!0,!0,i,r)),i;s&&(this.visibleOctant.length=0,this._frustumCull(e,t,s),(r=this.visibleOctant.length)>0&&(this._sortVisibleOctant(t),i=this._logicCull(e,!0,!1,i,r)));var o=this.manager.getFilter(e);return(Object.keys(this.nodePriority.low).length+this.nodePriority.high.length+this.nodePriority.medium.length<this.manager.getRenderableCount(e)||o._hasRenderPromotionFilter())&&n&&(this.visibleOctant.length=0,this._frustumCull(e,t,n),(r=this.visibleOctant.length)>0&&(this._sortVisibleOctant(e,t),i=this._logicCull(e,!0,!1,i,r))),i}_cullNodesWithLayerOctree(e,t){var i=0;this.visibleOctant.length=0;var r=e.getModelDescriptor().getOctreeRootNode().layer;r._isLayerOctree=!0,this._frustumCull(e,t,r),r._isLayerOctree=void 0;var a=this.visibleOctant.length;return a>0&&(this._sortVisibleOctant(t),i=this._logicCull(e,!0,!0,i,a)),i}_cullNodesWithOctant(e,t){return this._resetMaxAndMinPriority(),e.getModelDescriptor().isUseInnerAndOuterOctree()?this._cullNodesWithInnerAndOuterOctree(e,t):this._cullNodesWithLayerOctree(e,t)}_cullNodesWithFull(e){var t=e.getModelDescriptor().getCellCount();return 0===t?0:this._logicCullWithFull(e,t)}_calcPrioritizedNodeCount(e,t){var i=t+this.nodePriority.high.length+this.nodePriority.medium.length;return i>this.manager.getRenderableCount(e)&&(i=this.manager.getRenderableCount(e)),i}_updateMeshNodes(e){if(this._clearActiveMeshMap(),this._clearLineSegmentsNodeGroup(e),this.filter=e.getFilter(),e.isOnlyWireframe())return 0;var t=e.prioritizedNodeCount;if(0===t)return 0;var i=[this.nodePriority.high,this.nodePriority.medium,this.nodePriority.low],a=null;i[0].length>0&&(a=e.selectedMaterial);var n=e.getFilter()._hasOverrideMaterialFilter(),s={octantStartIndex:-1,curOctantId:-1};this.blinkMaterials.length=0;for(var o=0,l=0,d=0,h=i.length;d<h;++d)for(var c=i[d],u=0,p=Object.keys(c).length;u<p&&!(o>t);++u){l++;var m,f=c[u];m=0===d?this._getUsableMaterial(e,f,a,n):this._getUsableMaterial(e,f,null,n);var g=!f.instanceOrNot;if(r.ModelView.BaseDescriptor.isLineNode(f))this._dealLineSegments(e,f,g,m);else{var v=e.pool.counter;this._dealMeshes(e,f,g,m,s);var y=e.pool.counter-v;o+=y,t+=y-1}m=null}return a=null,i=null,l}_getUsableMaterial(e,t,i,a){var n=t.materialId,s=t.userId,o=e.materialManager.materials,l=e.manager.sceneState,d=e.getFilter(),h=null,c=l.isSelected(s);1!=c||d._isPickable(t)||(c=!1),i?r.GlobalData.PickingEffect?h=d._getOverrideMaterial(t):(h=d._getOverrideMaterial(t))&&!c||(h=i):a&&(h=d._getOverrideMaterial(t));var u=e.manager.getOverrideMaterialByNodeInfo(t,e.materialManager.getMaterialById(t.materialId));return h=h||u||o[n]||r.MaterialUtil.getDefaultStandardMaterial(),r.GlobalData.Hover&&l.hoverId===s&&!1===c&&(h=l.getHoverMaterial(h)),h}getMeshesByUserIds(e,t,i){const r=e.pool._pool,a=t.toString(),n=i.toString(),s=e.getLengthUnitsMatrix();for(let t=0;t<r.length;t++){const i=r[t];if(i.name==a||i.name==n){let t=i.geometry.boundingBox;t||(i.geometry.computeBoundingBox(),t=i.geometry.boundingBox),e.minDistanceObjects[i.name].push({mesh:i,matrix:i.matrix,unitsMatrix:s,boundingBox:t})}}}explode(e){for(var t=e.pool._pool,i=0;i<t.length;i++){var r=t[i],a=e.modelExplosion.getExplosionTranslation(r.name);r.translateZ(a.z),r.updateMatrix(),r.updateMatrixWorld()}}_getUsedGeometry(e,t){if(!r.GlobalData.Instance&&t.uvArrayBuffer){var i,a=t.geometryId+"|"+t.nodeId;if(i=this.getGeometryById(a))return i;var n=this._createGeometryByNodeInfo(e,t);n instanceof Array||(n=[n]),i=[];for(var s=new THREE.Matrix3,o=new THREE.Vector3,l=t.uvArrayBuffer,d=0,h=n.length;d<h;d++){var c=new THREE.BufferGeometry;c.setIndex(n[d].index),c.setAttribute("position",n[d].attributes.position),c.setAttribute("normal",n[d].attributes.normal),s.set(l[6*d],l[6*d+2],l[6*d+4],l[6*d+1],l[6*d+3],l[6*d+5],0,0,1);for(var u=[],p=n[d].attributes.uv.array,m=0,f=p.length;m<f;m+=2)o.set(p[m],p[m+1],1),o.applyMatrix3(s),u.push(o.x),u.push(o.y);c.setAttribute("uv",new THREE.Float32BufferAttribute(u,2)),i.push(c)}this._cacheGeometry(a,i)}else i=this.getGeometryByNodeInfo(e,t);return i}_dealMeshes(e,t,i,a,n){const s=e.pool,o=this._getNodeGroupRenderOrder(t,a);let l=this._getUsedGeometry(e,t);l instanceof Array||(l=[l]);for(let n=0,d=l.length;n<d;n++){const d=s.get({databagId:e.databagId,nodeId:t.nodeId,userId:t.userId,userData:t.userData,geometry:l[n],matrix:t.matrix,material:a,groupOrder:o.groupRenderOrder,renderOrder:o.renderOrder,visible:i});d&&(d.geometryId=t.geometryId,this._cacheActiveMesh(t.userId,t.nodeId,d),e.manager.addMeshToOctantMap(e.getEncodedDatabagId(),t.nodeId,new r.SingleCapsuleObject(t.nodeId,d)))}}_dealLineSegments(e,t,i,a){var n=this.getGeometryByNodeInfo(e,t);if(n){var s=this._getLineSegmentsNodeGroup(e),o=this.lineNodes[t.nodeId];o||((o=new r.LineSegmentsEx(n,a)).databagId=e.databagId,o.name=t.userId,o.nodeId=t.nodeId,o.geometryId=t.geometryId,t.matrix&&(o.matrix.copy(t.matrix),o.matrixAutoUpdate=!1),this.lineNodes[t.nodeId]=o),o.material=a,o.visible=i,s.add(o),o.updateMatrixWorld(!0),this._cacheActiveMesh(t.userId,t.nodeId,o)}}_frustumCull(t,i,a){var n=t.manager,s=i.getFrustum(),o=a._isLayerOctree?r.GlobalData.MaximumDepth+1:r.GlobalData.OctantDepth,l=i.projScreenMatrix,d=new THREE.Box3;function h(t,i,r,a,n){var s;if(i&&t.depth<r&&(d.set(t.min,t.max),s=i.intersectsBox(d)),s){if(a){var o=d.applyMatrix4(l),c=o.getSize(e).length(),u=o.getCenter(e).z;u=u>1e-6?u:1e-6,t.priority=c}n.push(t);for(var p=0,m=t.childOctants.length;p<m;++p)h(t.childOctants[p],i,r,a,n)}}(r.GlobalData.DEBUG&&n.showOctreeBox(a),h(a,s,o,!0,this.visibleOctant),r.GlobalData.OcclusionTranslucentEnabled)&&h(a,this.manager.getFrustumFromOcclusionCamera(),o,!1,this.occlusionVisibleOctant);return!0}_logicCull(e,t,i,a,n){var s=e.manager,o=e.getFilter(),l=o._hasHiddenFileIdFilter(),d=o._hasOverrideMaterialFilter(),h=s.sceneState.selectionSet,c=o._hasRenderPromotionFilter(),u=this.nodePriority.high,p=this.nodePriority.medium,m=this.nodePriority.low,f=this.nodePriority.low.length,g=e.getModelDescriptor().getNodeInfosWithCellId();function v(t,i){if(!e.isReplacedUserId(t.userId)&&!e.isHiddenSourceObjectUserId(t.userId)&&!(l&&o._isHiddenFileId(t)||!1===o._isVisible(t)))if(h.hasOwnProperty(t.userId)||d&&o._hasHighPriorityOverrideMaterial(t))u.push(t);else{var r=!1;if(c&&o._isRenderPromotion(t)&&(r=!0),i){var n=t.userData,s=n?n.categoryId:void 0;s&&i[s]&&(r=!0)}r?p.push(t):a<f&&(m[a]=t,a++)}}var y=s.getCategoriesFromHighPriority("outer");!0===i&&(y=s.getCategoriesFromHighPriority("inner"));for(var M,E=0,b=0;b<n;++b){var I,x=0;t?(I=this.visibleOctant[b].octantId,x=this.visibleOctant[b].depth):I=b;var T=g[I];if(T){var _=this._getUsedNodeInfosByCellId(I);if(!_){for(M=0,E=T.length;M<E;++M){(C=T[M]).octantId=I,C.cellDepth=x,C._measurement=this._calcNodeMeasurement(C),this._isSatisfied(e,C)&&this._cacheUsedNodeInfosByCellId(I,C)}_=this._getUsedNodeInfosByCellId(I)}if(_){var S=_.default;for(M=0,E=S.length;M<E;M++){var C=S[M];this._updateMaxAndMinPriority(C),v(C,y)}}}}return r.Logger.timeEnd("collectNodeInfo"),a}_clearUsedNodeInfosObject(){for(var e in this.usedNodeInfosObject)delete this.usedNodeInfosObject[e].default,delete this.usedNodeInfosObject[e].instance,delete this.usedNodeInfosObject[e];this.usedNodeInfosObject={}}_getUsedNodeInfosByCellId(e){return this.usedNodeInfosObject[e]}_cacheUsedNodeInfosByCellId(e,t){this.usedNodeInfosObject[e]||(this.usedNodeInfosObject[e]={},this.usedNodeInfosObject[e].default=[],this.usedNodeInfosObject[e].instance=[]),t.instanceOrNot||this.usedNodeInfosObject[e].default.push(t)}_isSatisfied(e,t){var i=e.getLoadedUserIdsObject();return!i||!!i[t.userId]}_logicCullWithFull(e,t){return this._logicCull(e,!1,!0,0,t)}_sortVisibleOctant(e,t){var i=null;if(this.manager.getContainsCamera(e)&&null!=this.manager.getLoader(e).octreeRootNodeI){var a=new r.OctantNeighborUtil(t,this.manager.getLoader(e).octreeRootNodeI);i=a.getAncestorAndNeighbors()}this.visibleOctant.sort((function(e,t){if(null!=i){if(null!=i[e.octantId])return-1;if(null!=i[t.octantId])return 1}return e.priority>t.priority?-1:e.priority<t.priority?1:0}))}_applyOcclusionTranslucent(e){if(r.GlobalData.OcclusionTranslucentEnabled){var t=e.pool.getObjects(),i=e.manager.octantToObjectMap,a=this.occlusionVisibleOctant.length;if(a>0)for(var n=e.manager.getFrustumFromOcclusionCamera(),s=0;s<a;++s){var o=i[this.occlusionVisibleOctant[s].octantId];if(o&&o.length>0)for(var l=0,d=o.length;l<d;l+=2)for(var h=o[l];h<=o[l+1];h++){var c=t[h];r.CameraUtil.intersectObjectWithFrustum(c,n)&&this._overrideOcclusionMaterial(c)}}}}_overrideOcclusionMaterial(e,t){var i=t.material;if(i&&!1===i.transparent){var a=e.manager.acquireMaterial(),n=a.material;i.color?n.color.copy(i.color):a.resetColor(),n.opacity=r.GlobalData.OcclusionOpacity,t.material=n,t.material.needsUpdate=!0}}_clearNodePriorityData(e){var t=this.nodePriority;t.high.length=0,t.medium.length=0,e&&(t.low.length=0)}_adjustLowNodePriorityLength(e){0===this.nodePriority.low.length&&(this.nodePriority.low.length=this.manager.getRenderableCount(e))}_clearLineSegmentsNodeGroup(e){this._getLineSegmentsNodeGroup(e).clear()}_getLineSegmentsNodeGroup(e){return e._getNodeGroup(r.ObjectGroupType.LINESEGMENTS,{globalSpace:!0})}getBlinkMaterials(){return this.blinkMaterials}getGeometryBuffersByUserId(e,t){var i=e.getModelDescriptor().getStandardNodeInfosById(t);if(!i)return[];for(var a=[],n=e.getDatabagId(),s=0,o=i.length;s<o;s++){var l=i[s],d=this.getGeometryByNodeInfo(e,l);if(d){var h=r.ModelView.BaseDescriptor.isLineNode(l);if(d instanceof Array)for(var c=0,u=d.length;c<u;c++){var p=d[c].getAttribute("uv");a.push({isLines:h,databagId:n,nodeId:l.nodeId,position:d[c].getAttribute("position").array,index:d[c].getIndex().array,matrix:l.matrix,uv:p?p.array:null})}else{p=d.getAttribute("uv");a.push({isLines:h,databagId:n,nodeId:l.nodeId,position:d.getAttribute("position").array,index:d.getIndex().array,matrix:l.matrix,uv:p?p.array:null})}}}return a}disposeBufferAfterVbo(){}traverseActiveMeshMap(e,t){for(var i=0,r=(e=e||Object.keys(this.activeMeshMap)).length;i<r;i++){var a=e[i];if(this.activeMeshMap[a])for(var n=Object.keys(this.activeMeshMap[a]),s=0,o=n.length;s<o;s++){var l=n[s];t(a,l,this.activeMeshMap[a][l])}}}getActiveMeshMapById(e){return this.activeMeshMap[e]}_cacheActiveMesh(e,t,i){this.activeMeshMap[e]||(this.activeMeshMap[e]={}),this.activeMeshMap[e][t]||(this.activeMeshMap[e][t]=[]),this.activeMeshMap[e][t].push(i)}_clearActiveMeshMap(){this.activeMeshMap={}}getPickingNodeGenerator(e){return e=null==e?"pick":e,this.pickingNodeGenerators||(this.pickingNodeGenerators={}),this.pickingNodeGenerators[e]||(this.pickingNodeGenerators[e]=new r.PickingMeshGenerator(this),this.pickingNodeGenerators[e].reserveMaterial=!!e.startsWith("glow")),this.pickingNodeGenerators[e]}isPickableNode(e){return!this.filter||this.filter._isPickable({name:e})}_getNodeGroupRenderOrder(e,t){return{groupRenderOrder:t&&t.transparent?0:e.cellDepth,renderOrder:this._getNodePriority(e)}}_calcNodeMeasurement(e){return e.boundingBox.getSize(r.Utils.scratchVector_1).length()}_resetMaxAndMinPriority(){this._priorityRange.min=Number.MAX_VALUE,this._priorityRange.max=-Number.MAX_VALUE}_updateMaxAndMinPriority(e){let t=this._priorityRange;t.min=Math.min(e._measurement,t.min),t.max=Math.max(e._measurement,t.max)}_getNodePriority(e){if(void 0===e._measurement)return e.octantId;const t=this._priorityRange.min,i=this._priorityRange.max;return e._priority=r.Math.isolateDigits(r.Math.normalize(i-e._measurement,t,i),4,0),e._priority}}r.ModelView.FreeIncrementedMeshManager=t}(),r.ModelView.FreeIncrementedWireframeManager=class{constructor(e){this.manager=e,this.wireframeGeometryMap={},this.wireframeLineMeshes={}}destroy(){if(this.pickingNodeGenerators){for(var e in this.pickingNodeGenerators)this.pickingNodeGenerators.hasOwnProperty(e)&&this.pickingNodeGenerators[e].destroy();this.pickingNodeGenerators=null}this._clearWireframeLineMeshes(),this.wireframeLineMeshes=null,this._disposeGeometries(),this.wireframeGeometryMap=null,this.manager=null}clearData(){if(this.pickingNodeGenerators)for(var e in this.pickingNodeGenerators)this.pickingNodeGenerators.hasOwnProperty(e)&&this.pickingNodeGenerators[e].clearData();this._clearWireframeLineMeshes(),this._disposeGeometries()}update(e,t){0!==t?this.isActivateWireframe(e)?(this._clearWireframeGroupNode(e),this._generateWireframeNodes(e,t),this._getWireWireframeGroupNode(e).updateMatrixWorld(!0)):this._removeWireframeGroupNode(e):this._clearWireframeGroupNode(e)}_disposeGeometries(){for(var e in this.wireframeGeometryMap)this._disposeGeometry(e)}_disposeGeometry(e){var t=this.wireframeGeometryMap[e];if(t){if(t instanceof Array)for(var i=0,r=t.length;i<r;i++)t[i].dispose();else t.dispose();delete this.wireframeGeometryMap[e]}}_clearWireframeLineMeshes(){for(var e in this.wireframeLineMeshes)delete this.wireframeLineMeshes[e];this.wireframeLineMeshes={}}_clearWireframeGroupNode(e){this._getWireWireframeGroupNode(e).clear()}_removeWireframeGroupNode(e){e.manager.scene.removeObjectGroupByName(this._getWireframeGroupName(e))}isActivateWireframe(e){return e.isActivateWireframe()}_getWireWireframeGroupNode(e){return e.manager.scene.getOrCreateObjectGroup(this._getWireframeGroupName(e),{globalSpace:!0})}_getWireframeGeometryByNodeInfo(e,t){return this._getWireframeGeometryById(t.geometryId,this.manager.getGeometryByNodeInfo(e,t))}_getWireframeGeometryById(e,t){if(this.wireframeGeometryMap[e])return this.wireframeGeometryMap[e];var i,a,n=[];if(t instanceof Array)for(var s=0,o=t.length;s<o;s++)a=r.BuildEdge(t[s].attributes.position.array,t[s].index.array),(i=new THREE.BufferGeometry).setIndex(new THREE.Uint32BufferAttribute(a,1)),i.setAttribute("position",t[s].attributes.position,3),n.push(i);else a=r.BuildEdge(t.attributes.position.array,t.index.array),(i=new THREE.BufferGeometry).setIndex(new THREE.Uint32BufferAttribute(a,1)),i.setAttribute("position",t.attributes.position,3),n.push(i);return this.wireframeGeometryMap[e]=n,this.wireframeGeometryMap[e]}_makeWireframeLineMeshes(e,t,i){if(t.type!==r.ModelView.BaseDescriptor.EnumNodeItemType.LINE){var a=this.wireframeLineMeshes[t.nodeId];if(!a){a=this.wireframeLineMeshes[t.nodeId]=[];for(var n=this._getWireframeGeometryByNodeInfo(e,t),s=0,o=n.length;s<o;s++){var l=new THREE.LineSegments(n[s],this._getWireframeMaterial(e));l.name=t.nodeId+"_"+s,l.applyMatrix4(t.matrix),a.push(l)}}var d=!e.isReplacedUserId(t.userId)&&!e.isHiddenSourceObjectUserId(t.userId)&&function(e,t){return!(r.GlobalData.Instance&&(e.geometryId===r.ModelView.BaseDescriptor.parameterizedNodeType.BOX||e.geometryId==r.ModelView.BaseDescriptor.parameterizedNodeType.BOX_M)||(e&&t.getWireFrameVisibilityCondition()?!t._isRenderWithWireFrame(e):t._hasRenderWithBoardlineFilter()&&!t._isRenderWithBoardline(e)))}(t,this._getFilter(e));if(d)for(var h=this._getFilter(e)._getOverrideWireFrameMaterial(t)||this._getWireframeMaterial(e),c=0,u=a.length;c<u;c++)a[c].material=h,i.add(a[c])}}_generateWireframeNodes(e,t){for(var i=this._getWireWireframeGroupNode(e),r=this.manager.getPriorityNodes(),a=0,n=0,s=r.length;n<s;++n)for(var o=r[n],l=0,d=Object.keys(o).length;l<d&&!(++a>t);++l){var h=o[l];this._makeWireframeLineMeshes(e,h,i)}}_getWireframeGroupName(e){return e._getWireframeGroupName()}_getWireframeMaterial(e){return e.getWireframeMaterial()}_getFilter(e){return e.getFilter()}explode(e){for(var t=new THREE.Matrix4,i=e.getModelDescriptor().getAllNodeInfos(),r=Object.keys(i),a=0,n=r.length;a<n;a++){var s=r[a],o=i[s],l=e.modelExplosion.getExplosionTranslation(s);t.makeTranslation(l.x,l.y,l.z);for(var d=0,h=o.length;d<h;d++){var c=this.wireframeLineMeshes[o[d].nodeId];if(c)for(var u=0;u<c.length;u++)c[u].applyMatrix4(t)}}}disposeBufferAfterVbo(){}getPickingNodeGenerator(e){return e=null==e?"pick":e,this.pickingNodeGenerators||(this.pickingNodeGenerators={}),this.pickingNodeGenerators[e]||(this.pickingNodeGenerators[e]=new r.PickingWireFrameGenerator(this)),this.pickingNodeGenerators[e]}},r.ModelView.FreeIncrementedManager=class{constructor(){this.meshManager=new r.ModelView.FreeIncrementedMeshManager(this),this.wireframeManager=new r.ModelView.FreeIncrementedWireframeManager(this)}destroy(){this.meshManager.destroy(),this.meshManager=null,this.wireframeManager.destroy(),this.wireframeManager=null}clearData(){this.meshManager.clearData(),this.wireframeManager.clearData()}disposeGeometry(e){this.meshManager.disposeGeometry(e)}cullNodes(e,t){this.hasNodeInfo(e)&&this.meshManager.cullNodes(e,t)}hasNodeInfo(e){return!!e.getModelDescriptor().getStandardNodeInfos()}updateNodes(e){if(this.hasNodeInfo(e)){var t=this.meshManager.update(e);this.wireframeManager.update(e,t)}}applyFilter(e,t){}applySelection(e){}clearSelection(e){}applyHover(e){}clearHover(e){}applyBlink(e){}clearBlink(e){}applyReplacement(e){}getPriorityNodes(){return this.meshManager.getPriorityNodes()}getGeometryByNodeInfo(e,t){return this.meshManager.getGeometryByNodeInfo(e,t)}getRenderableCount(e){return e.getRenderableCount()}getLoader(e){return e.getLoader()}getContainsCamera(e){return e.containsCamera}getFilter(e){return e.getFilter()}getMeshesByUserIds(e,t,i){this.meshManager.getMeshesByUserIds(e,t,i)}disposeBufferAfterVbo(){this.meshManager.disposeBufferAfterVbo(),this.wireframeManager.disposeBufferAfterVbo()}getGeometryBuffersByUserId(e,t){return this.meshManager.getGeometryBuffersByUserId(e,t)}explode(e){this.hasNodeInfo(e)&&(this.meshManager.explode(e),this.wireframeManager.explode(e))}getMeshManager(){return this.meshManager}getWireFrameManager(){return this.wireframeManager}isHiddenNode(e){return!1}},function(){class e extends r.ModelView.ModelBaseHandler{constructor(e){super(e),this.tag="default",this.defaultManager=new r.ModelView.FreeIncrementedManager,this.instancedManager=new r.ModelView.InstancedManager,this.loader=new r.ModelView.DefaultLoader(this)}prepareData(e){if(!this.dataReady){var t=this;this.loader.getDescriptor().asyncParseItemData((function(){t.dataReady=!0,t.settleData(e)}))}}prepare(e){this.isLoaded()&&!this.isHidden()&&(this.model.getMaterialManager()._updateTextureMapping(),this.model.clearMeshFromOctantMap(),this.instancedManager.addAllInstanceNodeToScene(this.model),this.defaultManager.cullNodes(this.model,e),this.prepareWireframe(this.model),this.updateNodes())}prepareWireframe(e,t){e.isActivateWireframe()&&this.instancedManager.generateWireframe(e)}settleData(e){this.model.getModelDescriptor().classifyAllNodeInfo(),this.addNodeInfoToOctantMap(),this.model.getModelDescriptor().destroyReader(),this.createMeshNodes(e)}addNodeInfoToOctantMap(){var e=this.model.manager,t=this.model.getEncodedDatabagId();this.model.getModelDescriptor().traverseNodeInfosByCell((function(i,r){e.addNodeInfoToOctantMap(t,i,r)}))}createMeshNodes(e){var t=this.model.getModelDescriptor().getInstancedUserIds();if(0===t.length)return this.loaded=!0,void(e&&e());this.instancedManager.asyncCreateMeshNodes(this.model,t,(()=>{this.loaded=!0,e&&e()}))}disposeBufferAfterVbo(){}}r.ModelView.FreeIncrementHandler=e}(),function(){class e extends r.ModelView.LayerHandler{constructor(e){super(e),this.tag="layer",this.defaultManager=new r.ModelView.FreeIncrementedManager,this.instancedManager=new r.ModelView.InstancedManager,this.loader=new r.ModelView.LayerLoader(this)}prepare(e){!this.isHidden()&&this.loaded&&this.layerDataLoaded&&(this.model.getMaterialManager()._updateTextureMapping(this.model),this.model.clearMeshFromOctantMap(),this.instancedManager.addAllInstanceNodeToScene(this.model),this.defaultManager.cullNodes(this.model,e),this.prepareWireframe(this.model),this.updateNodes())}prepareWireframe(e,t){e.isActivateWireframe()&&this.instancedManager.generateWireframe(e)}dealMeshNodes(e){var t=this.model.getModelDescriptor().getInstancedUserIdsByCategory(this.loadedUserIds);t.length&&this.instancedManager.createMeshNodes(this.model,t),e&&e()}disposeBufferAfterVbo(){}}r.ModelView.FreeLayerIncrementHandler=e}(),function(){class e extends r.ModelView.LayerSceneHandler{constructor(e){super(e),this.tag="layer",this.defaultManager=new r.ModelView.FreeIncrementedManager,this.instancedManager=new r.ModelView.InstancedManager,this.loader=new r.ModelView.LayerSceneLoader(this)}prepare(e){!this.isHidden()&&this.loaded&&this.layerDataLoaded&&(this.model.getMaterialManager()._updateTextureMapping(this.model),this.model.clearMeshFromOctantMap(),this.instancedManager.addAllInstanceNodeToScene(this.model),this.defaultManager.cullNodes(this.model,e),this.prepareWireframe(this.model),this.updateNodes())}prepareWireframe(e,t){e.isActivateWireframe()&&this.instancedManager.generateWireframe(e)}dealMeshNodes(e){var t=this.model.getModelDescriptor().getInstancedUserIdsByCategory(this.loadedUserIds);t.length&&this.instancedManager.createMeshNodes(this.model,t),e&&e()}disposeBufferAfterVbo(){}}r.ModelView.FreeLayerSceneIncrementHandler=e}(),function(){class e extends r.ModelView.LayerHandler{constructor(e){super(e),this.tag="layer",this.compositedManager=new r.ModelView.IncrementCompositedManager,this.defaultManager=this.compositedManager.defaultManager,this.instancedManager=this.compositedManager.instancedManager,this.loader=new r.ModelView.LayerLoader(this)}destroy(){this.compositedManager.destroy(),this.compositedManager=null,super.destroy()}prepareData(e){if(!this.dataReady){var t=this;this.compositedManager.settleData(this.model,(function(){t.dataReady=!0,t.settleData(e)}))}}prepare(e){this.isAllReady()&&(this.model.getMaterialManager()._updateTextureMapping(),this.model.clearMeshFromOctantMap(),this.compositedManager.cullNodes(this.model,e),this.compositedManager.updateNodes(this.model))}updateNodes(){}addNodeInfoToOctantMap(){}dealMeshNodes(e){e&&e()}disposeBufferAfterVbo(){}}r.ModelView.LayerIncrementHandler=e}(),function(){class e extends r.ModelView.LayerSceneHandler{constructor(e){super(e),this.tag="layer",this.compositedManager=new r.ModelView.IncrementCompositedManager,this.defaultManager=this.compositedManager.defaultManager,this.instancedManager=this.compositedManager.instancedManager,this.loader=new r.ModelView.LayerSceneLoader(this)}destroy(){this.compositedManager.destroy(),this.compositedManager=null,super.destroy()}initData(e){var t=this;this.compositedManager.settleData(this.model,(function(){t.model.getModelDescriptor().classifyAllNodeInfo(),t.getLayerProvider().cacheNodeInfosWithLayerKey(),t.addNodeInfoToOctantMap(),t.loadedUserIdsObject=t.getLayerProvider().getUserIdsOnDemand(),t.loadedUserIds=Object.keys(t.loadedUserIdsObject),e&&e()}))}prepare(e){this.isAllReady()&&(this.model.getMaterialManager()._updateTextureMapping(),this.model.clearMeshFromOctantMap(),this.compositedManager.cullNodes(this.model,e),this.compositedManager.updateNodes(this.model))}updateNodes(){}addNodeInfoToOctantMap(){}clearData(){this.model.removeAllFromOctantMap(),this.getLayerProvider().clearData(),this.model.clearWireframeElementCount(),this.compositedManager.clearData(),this.clearLoadedState()}dealMeshNodes(e){e&&e()}disposeBufferAfterVbo(){}}r.ModelView.LayerSceneIncrementHandler=e}(),function(){class e extends r.ModelView.DefaultDescriptor{constructor(){super(),this.bufferDataObjectMap={},this.bufferDataObjectIdMap={},this.parameterizedBufferMap={},this.geometryIdMapOnBufferDataObjectId={},this.mpkIdMapOnCellId={}}destroy(){super.destroy(),this.geometryIdMapOnbufferDataObjectId=void 0}setToBufferDataObjectMap(e,t){if(!this.bufferDataObjectMap[e]){var i=null;if(t){var a=t.bufferData,n=t.positionOffsetMap;return(i=new THREE.BufferGeometry).setIndex(new THREE.BufferAttribute(a.index,1)),i.setAttribute("position",new THREE.BufferAttribute(a.position,3)),a.normal?i.setAttribute("normal",new THREE.BufferAttribute(a.normal,3)):i.computeVertexNormals(),a.uv&&i.setAttribute("uv",new THREE.BufferAttribute(a.uv,2)),void(this.bufferDataObjectMap[e]=new r.ModelView.BatchedBufferDataObject(e,n,i))}var s=r.ModelView.BaseDescriptor.parameterizedNodeType;switch(e){case s.PIPE:i=r.GeomUtil.UnitCylinderInstance;break;case s.PIPE_M:i=r.GeomUtil.getUnitTextureCylinder();break;case s.BOX:i=r.GeomUtil.UnitBoxInstance;break;case s.BOX_M:i=r.GeomUtil.getUnitTextureBox()}i&&(i.clearGroups&&i.clearGroups(),this.bufferDataObjectMap[e]=new r.ModelView.BatchedBufferDataObject(e,void 0,i))}}removeFromBufferDataObjectMap(e){var t=this.bufferDataObjectMap[e];t&&(t.destroy(),delete this.bufferDataObjectMap[e])}getBufferDataObjectById(e){return this.bufferDataObjectMap[e]}getBufferDataObjectByGeometryId(e){var t=this.getBufferDataObjectIdByGeometryId(e);return void 0!==t?this.getBufferDataObjectById(t):void 0}setToBufferDataObjectIdMap(e,t){this.bufferDataObjectIdMap[e]=t}_isParameterizedNodeType(e){return r.ModelView.BaseDescriptor.isParameterizedNodeType(e)}getBufferDataObjectIdByGeometryId(e){var t=this.bufferDataObjectIdMap[e];if(void 0!==t)return t;if(this._isParameterizedNodeType(e)){var i=r.ModelView.BaseDescriptor.parameterizedNodeType;return t=e===i.TUBE?i.PIPE:e,this.setToBufferDataObjectMap(t),this.setToBufferDataObjectIdMap(e,t),this.setToGeometryIdMap(t,e),this.bufferDataObjectIdMap[e]}}setToGeometryIdMap(e,t){this.geometryIdMapOnBufferDataObjectId[e]||(this.geometryIdMapOnBufferDataObjectId[e]={}),this.geometryIdMapOnBufferDataObjectId[e][t]=!0}getGeometryIdsByBufferDataObjectId(e){return this.geometryIdMapOnBufferDataObjectId[e]}_classifyNodeInfo(e){super._classifyNodeInfo(e),this._cacheMpkIdsByCellId(e)}_cacheMpkIdsByCellId(e){void 0===this.mpkIdMapOnCellId[e.cellId]&&(this.mpkIdMapOnCellId[e.cellId]={});var t=this.getBufferDataObjectIdByGeometryId(e.geometryId);void 0!==t&&(this.mpkIdMapOnCellId[e.cellId][t]=!0)}getMpkIdsByCellId(){return this.mpkIdMapOnCellId[nodeInfo.cellId]}}r.ModelView.IncrementBatchedDescriptor=e,r.ModelView.BatchedBufferDataObject=class{constructor(e,t,i){this.id=e,this.positionOffsetMap=t,this.geometry=i,this.object=new r.MeshEx(i)}destroy(){this.positionOffsetMap=null,this.geometry.dispose(),this.geometry=null}getPositionAndIndexOffset(e){return this.positionOffsetMap?this.positionOffsetMap[e]:null}}}(),function(){class e extends r.ModelView.DefaultBaseLoader{constructor(e){super(e),this.descriptor=new r.ModelView.IncrementBatchedDescriptor}_parseMpkWithNoBatch(e,t){var i,a,n,s,o,l,d,h,c=new r.Loader.MPKReader(e),u=new THREE.Matrix4,p=[],m=0,f=0,g=[],v=0,y=0;for(i=0,a=c.header.meshCount;i<a;++i){var M=c.getPtBuffer(i),E=c.getIdxBuffer(i),b=c.getNormalBuffer(i);if(null!=M&&null!=E&&null!=b){var I=c.getMeshData(i),x=c.getUVBuffer(i);0!==I.baseScale&&(M=new Float32Array(M),u.identity(),u.setPosition(new THREE.Vector3(I.baseX,I.baseY,I.baseZ)),u.scale(new THREE.Vector3(I.baseScale,I.baseScale,I.baseScale)),r.GeomUtil.applyMatrix4ToBuffer(u,M)),E instanceof Uint16Array&&(E=Uint32Array.from(E)),x&&x.length?(g.push({meshId:I.mesh_id,position:M,index:E,normal:b,uv:x,positionOffset:v,indexOffset:y}),v+=M.length,y+=E.length):(p.push({meshId:I.mesh_id,position:M,index:E,normal:b,positionOffset:m,indexOffset:f}),m+=M.length,f+=E.length)}else r.Logger.log("Error Geometry!")}var T={},_={};if(g.length){for(s=new Uint32Array(y),n=new Float32Array(v),o=new Float32Array(v),l=new Float32Array(v),i=0,a=g.length;i<a;i++){var S=(L=g[i]).meshId,C=L.positionOffset,w=L.position.length,R=L.indexOffset,B=L.index.length;for(d=0,h=L.index.length;d<h;d++)L.index[d]+=C/3;n.set(L.position,C),s.set(L.index,R),o.set(L.normal,C),l.set(L.uv,2*C/3),T[S]={positionStart:C,positionCount:w,indexStart:R,indexCount:B,uvStart:2*C/3,uvCount:2*w/3},this.descriptor.setToGeometryIdMap(t,S),this.descriptor.setToBufferDataObjectIdMap(S,t)}_={index:new Uint32Array(s),position:new Float32Array(n),normal:new Float32Array(o),uv:new Float32Array(l)}}else{for(s=new Uint32Array(f),n=new Float32Array(m),o=new Float32Array(m),i=0,a=p.length;i<a;i++){var L;S=(L=p[i]).meshId,C=L.positionOffset,R=L.indexOffset,w=L.position.length,B=L.index.length;for(L.index instanceof Uint16Array&&(L.index=Uint32Array.from(L.index)),d=0,h=L.index.length;d<h;d++)L.index[d]+=C/3;n.set(L.position,C),s.set(L.index,R),o.set(L.normal,C),T[S]={positionStart:C,positionCount:w,indexStart:R,indexCount:B},this.descriptor.setToGeometryIdMap(t,S),this.descriptor.setToBufferDataObjectIdMap(S,t)}_={index:new Uint32Array(s),position:new Float32Array(n),normal:new Float32Array(o)}}this.descriptor.setToBufferDataObjectMap(t,{bufferData:_,positionOffsetMap:T}),c=null}_parseMpk(e,t){var i,a,n,s,o=new r.Loader.BMPKReader(e),l={},d={};if(o.tBuffer.byteLength){for(i=0,a=o.header.meshCount;i<a;++i)l[s=(n=o.getMeshData(i)).mesh_id]={positionStart:n.vOffset/4,positionCount:3*n.ptCount,indexStart:n.iOffset/4,indexCount:n.idxCount,uvStart:n.tOffset/4,uvCount:2*n.ptCount},this.descriptor.setToGeometryIdMap(t,s),this.descriptor.setToBufferDataObjectIdMap(s,t);d={index:new Uint32Array(o.iBuffer),position:new Float32Array(o.vBuffer),normal:new Float32Array(o.nBuffer),uv:new Float32Array(o.tBuffer)}}else{for(i=0,a=o.header.meshCount;i<a;++i)l[s=(n=o.getMeshData(i)).mesh_id]={positionStart:n.vOffset/4,positionCount:3*n.ptCount,indexStart:n.iOffset/4,indexCount:n.idxCount},this.descriptor.setToGeometryIdMap(t,s),this.descriptor.setToBufferDataObjectIdMap(s,t);d={index:new Uint32Array(o.iBuffer),position:new Float32Array(o.vBuffer),normal:new Float32Array(o.nBuffer)}}this.descriptor.setToBufferDataObjectMap(t,{bufferData:d,positionOffsetMap:l}),o=null}}r.ModelView.IncrementBatchedLoader=e}(),function(){let e=new THREE.Vector3,t=new THREE.Vector3;class i extends r.ModelView.MeshBaseManager{constructor(e){super(),this.manager=e,this.nodePriority={high:[],medium:[],low:[]},this.visibleOctant=[],this.occlusionVisibleOctant=[],this.usedNodeInfosObject={},this.lineNodes={},this.blinkMaterials=[],this.activeMeshMap={}}destroy(){if(super.destroy(),this.clearData(),this.pickingNodeGenerators){for(var e in this.pickingNodeGenerators)this.pickingNodeGenerators.hasOwnProperty(e)&&this.pickingNodeGenerators[e].destroy();this.pickingNodeGenerators=null}this.activeMeshMap=null,this.manager=null,this.nodePriority=null,this.visibleOctant=null,this.occlusionVisibleOctant=null,this.nodePriority=null,this.lineNodes=null,this.blinkMaterials=null}disposeLineNodes(){for(var e in this.lineNodes){var t=this.lineNodes[e];t.geometry.dispose(),t=null,delete this.lineNodes[e]}}clearData(){if(this.pickingNodeGenerators)for(var e in this.pickingNodeGenerators)this.pickingNodeGenerators.hasOwnProperty(e)&&this.pickingNodeGenerators[e].clearData();this._clearActiveMeshMap(),this.disposeGeometries(),this.disposeLineNodes(),this._clearNodePriorityData(!0),this._clearUsedNodeInfosObject(),this.visibleOctant.length=0,this.occlusionVisibleOctant.length=0}update(e){var t=this._updateMeshNodes(e);return this._applyOcclusionTranslucent(e),t}cullNodes(e,t){this._clearNodePriorityData(!0),this._adjustLowNodePriorityLength(e);var i=0;i=r.GlobalData.EnableOctant?this._cullNodesWithOctant(e,t):this._cullNodesWithFull(e),e.prioritizedNodeCount=this._calcPrioritizedNodeCount(e,i)}getPriorityNodes(){return[this.nodePriority.high,this.nodePriority.medium,this.nodePriority.low]}_cullNodesWithInnerAndOuterOctree(e,t){var i=0,r=0,a=e.getModelDescriptor().getOctreeRootNode(),n=a.inner,s=a.outer;if(this.manager.getContainsCamera(e)||!s)return this.visibleOctant.length=0,n&&this._frustumCull(e,t,n),s&&this._frustumCull(e,t,s),(r=this.visibleOctant.length)>0&&(this._sortVisibleOctant(t),i=this._logicCull(e,!0,!0,i,r)),i;s&&(this.visibleOctant.length=0,this._frustumCull(e,t,s),(r=this.visibleOctant.length)>0&&(this._sortVisibleOctant(t),i=this._logicCull(e,!0,!1,i,r)));var o=this.manager.getFilter(e);return(Object.keys(this.nodePriority.low).length+this.nodePriority.high.length+this.nodePriority.medium.length<this.manager.getRenderableCount(e)||o._hasRenderPromotionFilter())&&n&&(this.visibleOctant.length=0,this._frustumCull(e,t,n),(r=this.visibleOctant.length)>0&&(this._sortVisibleOctant(e,t),i=this._logicCull(e,!0,!1,i,r))),i}_cullNodesWithLayerOctree(e,t){var i=0;this.visibleOctant.length=0;var r=e.getModelDescriptor().getOctreeRootNode().layer;this._frustumCull(e,t,r);var a=this.visibleOctant.length;return a>0&&(this._sortVisibleOctant(t),i=this._logicCull(e,!0,!0,i,a)),i}_cullNodesWithOctant(e,t){return e.getModelDescriptor().isUseInnerAndOuterOctree()?this._cullNodesWithInnerAndOuterOctree(e,t):this._cullNodesWithLayerOctree(e,t)}_cullNodesWithFull(e){var t=e.getModelDescriptor().getCellCount();return 0===t?0:this._logicCullWithFull(e,t)}_calcPrioritizedNodeCount(e,t){var i=t+this.nodePriority.high.length+this.nodePriority.medium.length;return i>this.manager.getRenderableCount(e)&&(i=this.manager.getRenderableCount(e)),i}_updateMeshNodes(e){if(this._clearActiveMeshMap(),this._clearLineSegmentsNodeGroup(e),e.isOnlyWireframe())return 0;var t=e.prioritizedNodeCount;if(0===t)return 0;var i=[this.nodePriority.high,this.nodePriority.medium,this.nodePriority.low],a=null;i[0].length>0&&(a=e.selectedMaterial);var n=e.getFilter()._hasOverrideMaterialFilter(),s={octantStartIndex:-1,curOctantId:-1};this.blinkMaterials.length=0;for(var o=0,l=0,d=0,h=i.length;d<h;++d)for(var c=i[d],u=0,p=Object.keys(c).length;u<p&&!(o>t);++u){l++;var m,f=c[u];m=0===d?this._getUsableMaterial(e,f,a,n):this._getUsableMaterial(e,f,null,n);var g=!f.instanceOrNot;if(r.ModelView.BaseDescriptor.isLineNode(f))this._dealLineSegments(e,f,g,m);else{var v=e.pool.counter;this._dealMeshes(e,f,g,m,s);var y=e.pool.counter-v;o+=y,t+=y-1}m=null}return a=null,i=null,l}_getUsableMaterial(e,t,i,a){var n=t.materialId,s=t.userId,o=e.materialManager.materials,l=e.manager.sceneState,d=e.getFilter(),h=null,c=l.isSelected(s);1!=c||d._isPickable(t)||(c=!1),i?r.GlobalData.PickingEffect?h=d._getOverrideMaterial(t):(h=d._getOverrideMaterial(t))&&!c||(h=i):a&&(h=d._getOverrideMaterial(t));var u=e.manager.getOverrideMaterialByNodeInfo(t,e.materialManager.getMaterialById(t.materialId));return h=h||u||o[n]||r.MaterialUtil.getDefaultStandardMaterial(),r.GlobalData.Hover&&l.hoverId===s&&!1===c&&(h=l.getHoverMaterial(h)),h}getMeshesByUserIds(e,t,i){const r=e.pool._pool,a=t.toString(),n=i.toString(),s=e.getLengthUnitsMatrix();for(let t=0;t<r.length;t++){const i=r[t];if(i.name==a||i.name==n){let t=i.geometry.boundingBox;t||(i.geometry.computeBoundingBox(),t=i.geometry.boundingBox),e.minDistanceObjects[i.name].push({mesh:i,matrix:i.matrix,unitsMatrix:s,boundingBox:t})}}}explode(e){for(var t=e.pool._pool,i=0;i<t.length;i++){var r=t[i],a=e.modelExplosion.getExplosionTranslation(r.name);r.translateZ(a.z),r.updateMatrix(),r.updateMatrixWorld()}}getGeometryByNodeInfo(e,t){var i=!!e.getModelDescriptor()._isParameterizedNodeType(t.geometryId),a=i?t.geometryId+"|"+t.nodeId:t.nodeId;if(this._hasGeometry(a))return this.getGeometryById(a);if(r.ModelView.BaseDescriptor.isLineNode(t))return this._createGeometryForLineNodeByNodeInfo(e,t);var n=i?this._createGeometryForParameterizedNodeByNodeInfo(e,t):this._createGeometryByNodeInfo(e,t);return n?(this._cacheGeometry(a,n),n):null}_createGeometryForParameterizedNodeByNodeInfo(e,t){if(t.instanceOrNot)return null;var i=e.getModelDescriptor().getBufferDataObjectByGeometryId(t.geometryId);if(!i)return null;if(!t.uvArrayBuffer)return i.geometry;var r=[],a=i.geometry;a instanceof Array||(a=[a]);for(var n=new THREE.Matrix3,s=new THREE.Vector3,o=t.uvArrayBuffer,l=0,d=a.length;l<d;l++){var h=new THREE.BufferGeometry;h.setIndex(a[l].index),h.setAttribute("position",a[l].attributes.position),h.setAttribute("normal",a[l].attributes.normal),n.set(o[6*l],o[6*l+2],o[6*l+4],o[6*l+1],o[6*l+3],o[6*l+5],0,0,1);for(var c=[],u=a[l].attributes.uv.array,p=0,m=u.length;p<m;p+=2)s.set(u[p],u[p+1],1),s.applyMatrix3(n),c.push(s.x),c.push(s.y);h.setAttribute("uv",new THREE.Float32BufferAttribute(c,2)),r.push(h)}return r}_createGeometryByNodeInfo(e,t){var i=t.geometryId,r=e.getModelDescriptor().getBufferDataObjectByGeometryId(i);if(!r)return null;var a=new THREE.BufferGeometry;a.setIndex(r.geometry.getIndex()),a.setAttribute("position",r.geometry.getAttribute("position"));var n=r.geometry.getAttribute("normal");n&&a.setAttribute("normal",n);var s=r.geometry.getAttribute("uv");s&&a.setAttribute("uv",s);var o=r.getPositionAndIndexOffset(i);return a.setDrawRange(o.indexStart,o.indexCount),a._withDrawRange=!0,a._positionOffset=o,a}_createGeometryForLineNodeByNodeInfo(e,t){return this._createGeometryByNodeInfo(e,t)}_dealMeshes(e,t,i,a,n){let s=this.getGeometryByNodeInfo(e,t);if(!s)return;s instanceof Array||(s=[s]);const o=e.pool,l=this._getNodeGroupRenderOrder(t,a);for(var d=0,h=s.length;d<h;d++){const n=o.get({databagId:e.databagId,nodeId:t.nodeId,userId:t.userId,userData:t.userData,geometry:s[d],matrix:t.matrix,material:a,groupOrder:l.groupRenderOrder,renderOrder:l.renderOrder,visible:i});n&&(n.geometryId=t.geometryId,this._cacheActiveMesh(t.userId,t.nodeId,n),e.manager.addMeshToOctantMap(e.getEncodedDatabagId(),t.nodeId,new r.SingleCapsuleObjectWithDrawRange(t.nodeId,n)))}}_dealLineSegments(e,t,i,a){var n=this.getGeometryByNodeInfo(e,t);if(n){var s=this._getLineSegmentsNodeGroup(e),o=this.lineNodes[t.nodeId];o||((o=new r.LineSegmentsEx(n,a)).databagId=e.databagId,o.name=t.userId,o.nodeId=t.nodeId,o.geometryId=t.geometryId,t.matrix&&(o.matrix.copy(t.matrix),o.matrixAutoUpdate=!1),this.lineNodes[t.nodeId]=o),o.material=a,o.visible=i,s.add(o),o.updateMatrixWorld(!0),this._cacheActiveMesh(t.userId,t.nodeId,new r.SingleCapsuleObject(o))}}_frustumCull(i,a,n){var s=i.manager,o=a.getFrustum(),l=r.GlobalData.OctantDepth,d=a.projScreenMatrix,h=new THREE.Box3;function c(i,r,a,n,s){var o;if(r&&i.depth<a&&(h.set(i.min,i.max),o=r.intersectsBox(h)),o){if(n){var l=h.applyMatrix4(d),u=l.getSize(e).length();l.getCenter(t);var p=t.z;p=p>1e-6?p:1e-6,i.priority=u/p,s.push(i)}else s.push(i);for(var m=0,f=i.childOctants.length;m<f;++m)c(i.childOctants[m],r,a,n,s)}}(r.GlobalData.DEBUG&&s.showOctreeBox(n),c(n,o,l,!0,this.visibleOctant),r.GlobalData.OcclusionTranslucentEnabled)&&c(n,this.manager.getFrustumFromOcclusionCamera(),l,!1,this.occlusionVisibleOctant);return!0}_logicCull(e,t,i,a,n){var s=e.manager,o=e.getFilter(),l=o._hasHiddenFileIdFilter(),d=o._hasOverrideMaterialFilter(),h=s.sceneState.selectionSet,c=o._hasRenderPromotionFilter(),u=this.nodePriority.high,p=this.nodePriority.medium,m=this.nodePriority.low,f=this.nodePriority.low.length,g=e.getModelDescriptor().getNodeInfosWithCellId();function v(t,i){if(!e.isReplacedUserId(t.userId)&&!e.isHiddenSourceObjectUserId(t.userId)&&!(l&&o._isHiddenFileId(t)||!1===o._isVisible(t)))if(h.hasOwnProperty(t.userId)||d&&o._hasHighPriorityOverrideMaterial(t))u.push(t);else{var r=!1;if(c&&o._isRenderPromotion(t)&&(r=!0),i){var n=t.userData,s=n?n.categoryId:void 0;s&&i[s]&&(r=!0)}r?p.push(t):a<f&&(m[a]=t,a++)}}var y=s.getCategoriesFromHighPriority("outer");!0===i&&(y=s.getCategoriesFromHighPriority("inner"));for(var M,E=0,b=0;b<n;++b){var I,x=0;t?(I=this.visibleOctant[b].octantId,x=this.visibleOctant[b].depth):I=b;var T=g[I];if(T){var _=this._getUsedNodeInfosByCellId(I);if(!_){for(M=0,E=T.length;M<E;++M){(C=T[M]).octantId=I,C.cellDepth=x,this._isSatisfied(e,C)&&this._cacheUsedNodeInfosByCellId(I,C)}_=this._getUsedNodeInfosByCellId(I)}if(_){var S=_.default;for(M=0,E=S.length;M<E;M++){var C;v(C=S[M],y)}}}}return r.Logger.timeEnd("collectNodeInfo"),a}_clearUsedNodeInfosObject(){for(var e in this.usedNodeInfosObject)delete this.usedNodeInfosObject[e].default,delete this.usedNodeInfosObject[e].instance,delete this.usedNodeInfosObject[e];this.usedNodeInfosObject={}}_getUsedNodeInfosByCellId(e){return this.usedNodeInfosObject[e]}_cacheUsedNodeInfosByCellId(e,t){this.usedNodeInfosObject[e]||(this.usedNodeInfosObject[e]={},this.usedNodeInfosObject[e].default=[],this.usedNodeInfosObject[e].instance=[]),t.instanceOrNot||this.usedNodeInfosObject[e].default.push(t)}_isSatisfied(e,t){var i=e.getLoadedUserIdsObject();return!i||!!i[t.userId]}_logicCullWithFull(e,t){return this._logicCull(e,!1,!0,0,t)}_sortVisibleOctant(e,t){var i=null;if(this.manager.getContainsCamera(e)&&null!=this.manager.getLoader(e).octreeRootNodeI){var a=new r.OctantNeighborUtil(t,this.manager.getLoader(e).octreeRootNodeI);i=a.getAncestorAndNeighbors()}this.visibleOctant.sort((function(e,t){if(null!=i){if(null!=i[e.octantId])return-1;if(null!=i[t.octantId])return 1}return e.priority>t.priority?-1:e.priority<t.priority?1:0}))}_applyOcclusionTranslucent(e){if(r.GlobalData.OcclusionTranslucentEnabled){var t=e.pool.getObjects(),i=e.manager.octantToObjectMap,a=this.occlusionVisibleOctant.length;if(a>0)for(var n=e.manager.getFrustumFromOcclusionCamera(),s=0;s<a;++s){var o=i[this.occlusionVisibleOctant[s].octantId];if(o&&o.length>0)for(var l=0,d=o.length;l<d;l+=2)for(var h=o[l];h<=o[l+1];h++){var c=t[h];r.CameraUtil.intersectObjectWithFrustum(c,n)&&this._overrideOcclusionMaterial(c)}}}}_overrideOcclusionMaterial(e,t){var i=t.material;if(i&&!1===i.transparent){var a=e.manager.acquireMaterial(),n=a.material;i.color?n.color.copy(i.color):a.resetColor(),n.opacity=r.GlobalData.OcclusionOpacity,t.material=n,t.material.needsUpdate=!0}}_clearNodePriorityData(e){var t=this.nodePriority;t.high.length=0,t.medium.length=0,e&&(t.low.length=0)}_adjustLowNodePriorityLength(e){0===this.nodePriority.low.length&&(this.nodePriority.low.length=this.manager.getRenderableCount(e))}_clearLineSegmentsNodeGroup(e){this._getLineSegmentsNodeGroup(e).clear()}_getLineSegmentsNodeGroup(e){return e._getNodeGroup(r.ObjectGroupType.LINESEGMENTS,{globalSpace:!0})}getBlinkMaterials(){return this.blinkMaterials}getGeometryBuffersByUserId(e,t){var i=e.getModelDescriptor().getStandardNodeInfosById(t);if(!i)return[];for(var a=[],n=e.getDatabagId(),s=0,o=i.length;s<o;s++){var l=i[s],d=this.getGeometryByNodeInfo(e,l);if(d){var h=r.ModelView.BaseDescriptor.isLineNode(l);if(d instanceof Array)for(var c=0,u=d.length;c<u;c++)a.push({isLines:h,databagId:n,nodeId:l.nodeId,position:d[c].getAttribute("position").array,index:d[c].getIndex().array,matrix:l.matrix});else a.push({isLines:h,databagId:n,nodeId:l.nodeId,position:d.getAttribute("position").array,index:d.getIndex().array,matrix:l.matrix})}}return a}disposeBufferAfterVbo(){}traverseActiveMeshMap(e,t){for(var i=0,r=(e=e||Object.keys(this.activeMeshMap)).length;i<r;i++){var a=e[i];if(this.activeMeshMap[a])for(var n=Object.keys(this.activeMeshMap[a]),s=0,o=n.length;s<o;s++){var l=n[s];t(a,l,this.activeMeshMap[a][l])}}}getActiveMeshMapById(e){return this.activeMeshMap[e]}_cacheActiveMesh(e,t,i){this.activeMeshMap[e]||(this.activeMeshMap[e]={}),this.activeMeshMap[e][t]||(this.activeMeshMap[e][t]=[]),this.activeMeshMap[e][t].push(i)}_clearActiveMeshMap(){this.activeMeshMap={}}getPickingNodeGenerator(e){return e=null==e?"pick":e,this.pickingNodeGenerators||(this.pickingNodeGenerators={}),this.pickingNodeGenerators[e]||(this.pickingNodeGenerators[e]=new r.PickingMeshGenerator(this),this.pickingNodeGenerators[e].reserveMaterial=!!e.startsWith("glow")),this.pickingNodeGenerators[e]}_getNodeGroupRenderOrder(e,t){return{groupRenderOrder:t&&t.transparent?0:e.cellDepth,renderOrder:e.octantId}}}r.ModelView.IncrementBatchedMeshManager=i}(),r.ModelView.IncrementBatchedWireFrameManager=class{constructor(e){this.manager=e,this.wireframeGeometryMap={},this.wireframeLineMeshes={}}destroy(){if(this.pickingNodeGenerators){for(var e in this.pickingNodeGenerators)this.pickingNodeGenerators.hasOwnProperty(e)&&this.pickingNodeGenerators[e].destroy();this.pickingNodeGenerators=null}this._clearWireframeLineMeshes(),this.wireframeLineMeshes=null,this._disposeGeometries(),this.wireframeGeometryMap=null,this.manager=null}clearData(){if(this.pickingNodeGenerators)for(var e in this.pickingNodeGenerators)this.pickingNodeGenerators.hasOwnProperty(e)&&this.pickingNodeGenerators[e].clearData();this._clearWireframeLineMeshes(),this._disposeGeometries()}update(e,t){0!==t?this.isActivateWireframe(e)?(this._clearWireframeGroupNode(e),this._generateWireframeNodes(e,t),this._getWireWireframeGroupNode(e).updateMatrixWorld(!0)):this._removeWireframeGroupNode(e):this._clearWireframeGroupNode(e)}_disposeGeometries(){for(var e in this.wireframeGeometryMap)this._disposeGeometry(e)}_disposeGeometry(e){var t=this.wireframeGeometryMap[e];if(t){if(t instanceof Array)for(var i=0,r=t.length;i<r;i++)t[i].dispose();else t.dispose();delete this.wireframeGeometryMap[e]}}_clearWireframeLineMeshes(){for(var e in this.wireframeLineMeshes)delete this.wireframeLineMeshes[e];this.wireframeLineMeshes={}}_clearWireframeGroupNode(e){this._getWireWireframeGroupNode(e).clear()}_removeWireframeGroupNode(e){e.manager.scene.removeObjectGroupByName(this._getWireframeGroupName(e))}isActivateWireframe(e){return e.isActivateWireframe()}_getWireWireframeGroupNode(e){return e.manager.scene.getOrCreateObjectGroup(this._getWireframeGroupName(e),{globalSpace:!0})}_getWireframeGeometryByNodeInfo(e,t){return this._getWireframeGeometryById(t.geometryId,this.manager.getGeometryByNodeInfo(e,t))}_buildGeometryEdge(e){var t,i=e.attributes.position.array,a=e.index.array;if(e._withDrawRange){var n=e._positionOffset,s=a.slice(n.indexStart,n.indexStart+n.indexCount),o=i.slice(n.positionStart,n.positionStart+n.positionCount),l=n.positionStart/3;s.forEach((function(e,t,i){i[t]-=l})),(t=r.BuildEdge(o,s)).forEach((function(e,t,i){i[t]+=l}))}else t=r.BuildEdge(i,a);return t}_getWireframeGeometryById(e,t){if(this.wireframeGeometryMap[e])return this.wireframeGeometryMap[e];Array.isArray(t)||(t=[t]);for(var i,r=[],a=0,n=t.length;a<n;a++){var s=t[a],o=this._buildGeometryEdge(s);(i=new THREE.BufferGeometry).setIndex(new THREE.Uint32BufferAttribute(o,1)),i.setAttribute("position",s.getAttribute("position")),r.push(i)}return this.wireframeGeometryMap[e]=r,this.wireframeGeometryMap[e]}_makeWireframeLineMeshes(e,t,i){if(!r.ModelView.BaseDescriptor.isLineNode(t)){var a=this.wireframeLineMeshes[t.nodeId];if(!a){a=this.wireframeLineMeshes[t.nodeId]=[];for(var n=this._getWireframeGeometryByNodeInfo(e,t),s=0,o=n.length;s<o;s++){var l=new THREE.LineSegments(n[s],this._getWireframeMaterial(e));l.name=t.nodeId+"_"+s,l.applyMatrix4(t.matrix),a.push(l)}}var d=!e.isReplacedUserId(t.userId)&&!e.isHiddenSourceObjectUserId(t.userId)&&function(e,t){return!(r.GlobalData.Instance&&(e.geometryId===r.ModelView.BaseDescriptor.parameterizedNodeType.BOX||e.geometryId===r.ModelView.BaseDescriptor.parameterizedNodeType.BOX_M)||(t.getWireFrameVisibilityCondition()?!t._isRenderWithWireFrame(e):t._hasRenderWithBoardlineFilter()&&!t._isRenderWithBoardline(e)))}(t,this._getFilter(e));if(d)for(var h=0,c=a.length;h<c;h++)i.add(a[h])}}_generateWireframeNodes(e,t){for(var i=this._getWireWireframeGroupNode(e),r=this.manager.getPriorityNodes(),a=0,n=0,s=r.length;n<s;++n)for(var o=r[n],l=0,d=Object.keys(o).length;l<d&&!(++a>t);++l){var h=o[l];this._makeWireframeLineMeshes(e,h,i)}}_getWireframeGroupName(e){return e._getWireframeGroupName()}_getWireframeMaterial(e){return e.getWireframeMaterial()}_getFilter(e){return e.getFilter()}explode(e){for(var t=new THREE.Matrix4,i=e.getModelDescriptor().getAllNodeInfos(),r=Object.keys(i),a=0,n=r.length;a<n;a++){var s=r[a],o=i[s],l=e.modelExplosion.getExplosionTranslation(s);t.makeTranslation(l.x,l.y,l.z);for(var d=0,h=o.length;d<h;d++){var c=this.wireframeLineMeshes[o[d].nodeId];if(c)for(var u=0;u<c.length;u++)c[u].applyMatrix4(t)}}}disposeBufferAfterVbo(){}getPickingNodeGenerator(e){return e=null==e?"pick":e,this.pickingNodeGenerators||(this.pickingNodeGenerators={}),this.pickingNodeGenerators[e]||(this.pickingNodeGenerators[e]=new r.PickingWireFrameGenerator(this)),this.pickingNodeGenerators[e]}},r.ModelView.IncrementBatchedManager=class{constructor(){this.meshManager=new r.ModelView.IncrementBatchedMeshManager(this),this.wireframeManager=new r.ModelView.IncrementBatchedWireFrameManager(this)}destroy(){this.meshManager.destroy(),this.meshManager=null,this.wireframeManager.destroy(),this.wireframeManager=null}clearData(){this.meshManager.clearData(),this.wireframeManager.clearData()}disposeGeometry(e){this.meshManager.disposeGeometry(e)}cullNodes(e,t){this.hasNodeInfo(e)&&this.meshManager.cullNodes(e,t)}hasNodeInfo(e){return!!e.getModelDescriptor().getStandardNodeInfos()}updateNodes(e){if(this.hasNodeInfo(e)){var t=this.meshManager.update(e);this.wireframeManager.update(e,t)}}applyFilter(e,t){}applySelection(e){}clearSelection(e){}applyHover(e){}clearHover(e){}applyBlink(e){}clearBlink(e){}applyReplacement(e){}getPriorityNodes(){return this.meshManager.getPriorityNodes()}getGeometryByNodeInfo(e,t){return this.meshManager.getGeometryByNodeInfo(e,t)}getRenderableCount(e){return e.getRenderableCount()}getLoader(e){return e.getLoader()}getContainsCamera(e){return e.containsCamera}getFilter(e){return e.getFilter()}getMeshesByUserIds(e,t,i){this.meshManager.getMeshesByUserIds(e,t,i)}disposeBufferAfterVbo(){this.meshManager.disposeBufferAfterVbo(),this.wireframeManager.disposeBufferAfterVbo()}getGeometryBuffersByUserId(e,t){return this.meshManager.getGeometryBuffersByUserId(e,t)}explode(e){this.hasNodeInfo(e)&&(this.meshManager.explode(e),this.wireframeManager.explode(e))}getMeshManager(){return this.meshManager}getWireFrameManager(){return this.wireframeManager}isHiddenNode(e){return!1}isParameterizedNode(e){}},function(){class e extends r.ModelView.InstancedMeshManager{constructor(e){super(e)}}r.ModelView.IncrementInstanceBatchedMeshManager=e}(),function(){class e extends r.ModelView.InstancedWireframeManager{constructor(e){super(e)}}r.ModelView.IncrementInstanceBatchedWireFrameManager=e}(),function(){class e extends r.ModelView.InstancedBaseManager{constructor(){super(),this.meshManager=new r.ModelView.IncrementInstanceBatchedMeshManager(this),this.wireframeManager=new r.ModelView.IncrementInstanceBatchedWireFrameManager(this)}}r.ModelView.IncrementInstanceBatchedManager=e}(),function(){class e extends r.ModelView.ModelBaseHandler{constructor(e){super(e),this.tag="default",this.defaultManager=new r.ModelView.IncrementBatchedManager,this.instancedManager=new r.ModelView.IncrementInstanceBatchedManager,this.loader=new r.ModelView.IncrementBatchedLoader(this)}prepareData(e){if(!this.dataReady){var t=this;this.loader.getDescriptor().asyncParseItemData((function(){t.dataReady=!0,t.settleData(e)}))}}prepare(e){this.isLoaded()&&!this.isHidden()&&(this.model.getMaterialManager()._updateTextureMapping(),this.model.clearMeshFromOctantMap(),this.instancedManager.addAllInstanceNodeToScene(this.model),this.defaultManager.cullNodes(this.model,e),this.prepareWireframe(this.model),this.updateNodes())}prepareWireframe(e,t){e.isActivateWireframe()&&this.instancedManager.generateWireframe(e)}settleData(e){this.model.getModelDescriptor().classifyAllNodeInfo(),this.addNodeInfoToOctantMap(),this.model.getModelDescriptor().destroyReader(),this.createMeshNodes(e)}addNodeInfoToOctantMap(){var e=this.model.manager,t=this.model.getEncodedDatabagId();this.model.getModelDescriptor().traverseNodeInfosByCell((function(i,r){e.addNodeInfoToOctantMap(t,i,r)}))}createMeshNodes(e){var t=this,i=this.model.getModelDescriptor().getInstancedUserIds();if(0===i.length)return t.loaded=!0,void(e&&e());r.Utils.asyncProcess(i,i.length,500,(function(e,i){t.instancedManager.meshManager._createInstanceGeometries(t.model,[e[i]])}),(function(){t.instancedManager.meshManager._makeInstanceNodes(t.model),t.loaded=!0,e&&e()}))}disposeBufferAfterVbo(){}}r.ModelView.IncrementBatchedHandler=e}(),(()=>{let e=new THREE.Vector3;r.OctantNeighborUtil=function(e,t){this.camera=e,this.root=t,this.searchNeighborOfNeighbor=!1,this.containChildOfNeighbor=!1,this.containedOctants=[],this.father=function(e){return++e<this.containedOctants.length?this.containedOctants[e]:null},this.adjFace=function(e,t){return i[8*e+t]},this.adjEdge=function(e,t){return r[8*e+t]},this.adjVertex=function(e,t){return e==t},this.refelectFace=function(e,t){return a[8*e+t]},this.refelectEdge=function(e,t){return n[8*e+t]},this.refelectVertex=function(e,t){return this.OctType.MAXTYPEID-t},this.common_face_edge=function(e,t){return s[8*e+t]},this.common_face_vertex=function(e,t){return o[8*e+t]},this.common_edge=function(e,t){return l[8*e+t]},this.son=function(e,t){var i,r=e.childOctants.length;for(i=0;i<r;i++)if(e.childOctants[i].octType==t)return e.childOctants[i];return null},this.FaceType={L:0,R:1,D:2,U:3,B:4,F:5,UNKNOWN:6},this.EdgeType={LD:0,LU:1,LB:2,LF:3,RD:4,RU:5,RB:6,RF:7,DB:8,DF:9,UB:10,UF:11,UNKNOWN:12},this.OctType={RUF:0,LUF:1,RDF:2,LDF:3,RUB:4,LUB:5,RDB:6,LDB:7,MAXTYPEID:7};var i=[!1,!0,!1,!0,!1,!0,!1,!0,!0,!1,!0,!1,!0,!1,!0,!1,!1,!1,!0,!0,!1,!1,!0,!0,!0,!0,!1,!1,!0,!0,!1,!1,!1,!1,!1,!1,!0,!0,!0,!0,!0,!0,!0,!0,!1,!1,!1,!1],r=[!1,!1,!1,!0,!1,!1,!1,!0,!1,!0,!1,!1,!1,!0,!1,!1,!1,!1,!1,!1,!1,!0,!1,!0,!1,!0,!1,!0,!1,!1,!1,!1,!1,!1,!0,!1,!1,!1,!0,!1,!0,!1,!1,!1,!0,!1,!1,!1,!1,!1,!1,!1,!0,!1,!0,!1,!0,!1,!0,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!0,!0,!1,!1,!0,!0,!1,!1,!1,!1,!1,!1,!1,!1,!0,!0,!1,!1,!0,!0,!1,!1,!1,!1,!1,!1],a=[1,0,3,2,5,4,7,6,1,0,3,2,5,4,7,6,2,3,0,1,6,7,4,5,2,3,0,1,6,7,4,5,4,5,6,7,0,1,2,3,4,5,6,7,0,1,2,3],n=[3,2,1,0,7,6,5,4,3,2,1,0,7,6,5,4,5,4,7,6,1,0,3,2,5,4,7,6,1,0,3,2,3,2,1,0,7,6,5,4,3,2,1,0,7,6,5,4,5,4,7,6,1,0,3,2,5,4,7,6,1,0,3,2,6,7,4,5,2,3,0,1,6,7,4,5,2,3,0,1,6,7,4,5,2,3,0,1,6,7,4,5,2,3,0,1],s=[6,0,2,6,6,0,2,6,3,6,6,0,3,6,6,0,6,0,6,0,4,6,4,6,5,6,5,6,6,0,6,0,1,6,6,2,1,6,6,2,6,3,1,6,6,3,1,6,1,6,1,6,6,4,6,4,6,5,6,5,1,6,1,6,6,6,2,2,4,4,6,6,5,5,6,6,6,6,2,2,3,3,6,6,6,6,4,4,6,6,5,5,3,3,6,6],o=[6,6,6,5,6,3,1,6,6,6,5,6,3,6,6,0,6,5,6,6,1,6,6,2,5,6,6,6,6,0,2,6,6,3,1,6,6,6,6,4,3,6,6,0,6,6,4,6,1,6,6,2,6,4,6,6,6,0,2,6,1,6,6,6],l=[12,11,7,12,5,12,12,12,11,12,12,3,12,1,12,12,7,12,12,9,12,12,4,12,12,3,9,12,12,12,12,0,5,12,12,12,12,10,6,12,12,1,12,12,10,12,12,2,12,12,4,12,6,12,12,8,12,12,12,0,12,2,8,12]},r.OctantNeighborUtil.prototype.findFaceNeighborImpl=function(e,t){var i={node:null,cont:!1},r=this.containedOctants,a=r[e];if(e>=r.length)return i;if(this.father(e)&&this.adjFace(t,a.octType)?i=this.findFaceNeighborImpl(e+1,t):(i.node=this.father(e),i.cont=!0),i.cont&&null!==i.node&&i.node.childOctants.length>0){var n=this.son(i.node,this.refelectFace(t,a.octType));return n?{node:n,cont:!0}:{node:i.node,cont:!1}}return i},r.OctantNeighborUtil.prototype.findFaceNeighbor=function(e,t){var i=this.findFaceNeighborImpl(e,t);return i.node&&!i.node.isRoot()?i.node:null},r.OctantNeighborUtil.prototype.findEdgeNeighborImpl=function(e,t){var i={node:null,cont:!1},r=this.containedOctants,a=r[e];if(e>=r.length)return i;if(this.father(e)&&(this.adjEdge(t,a.octType)?i=this.findEdgeNeighborImpl(e+1,t):this.common_face_edge(t,a.octType)!==this.FaceType.UNKNOWN?i=this.findFaceNeighborImpl(e+1,this.common_face_edge(t,a.octType)):(i.node=this.father(e),i.cont=!0)),i.cont&&null!==i.node&&i.node.childOctants.length>0){var n=this.son(i.node,this.refelectEdge(t,a.octType));return n?{node:n,cont:!0}:{node:i.node,cont:!1}}return i},r.OctantNeighborUtil.prototype.findEdgeNeighbor=function(e,t){var i=this.findEdgeNeighborImpl(e,t);return i.node&&!i.node.isRoot()?i.node:null},r.OctantNeighborUtil.prototype.findVertexNeighborImpl=function(e,t){var i={node:null,cont:!1},r=this.containedOctants,a=r[e];if(e>=r.length)return i;if(this.father(e)&&(this.adjVertex(t,a.octType)?i=this.findVertexNeighborImpl(e+1,t):this.common_edge(t,a.octType)!==this.EdgeType.UNKNOWN?i=this.findVertexNeighborImpl(e+1,this.common_edge(t,a.octType)):this.common_face_vertex(t,a.octType)!=this.FaceType.UNKNOWN?i=this.findVertexNeighborImpl(e+1,this.common_face_vertex(t,a.octType)):(i.node=this.father(e),i.cont=!0)),i.cont&&null!==i.node&&i.node.childOctants.length>0){var n=this.son(i.node,this.refelectVertex(t,a.octType));return n?{node:n,cont:!0}:{node:i.node,cont:!1}}return i},r.OctantNeighborUtil.prototype.findVertexNeighbor=function(e,t){var i=this.findVertexNeighborImpl(e,t);return i.node&&!i.node.isRoot()?i.node:null},r.OctantNeighborUtil.prototype.findContainNode=function(e){var t,i=this.camera.position;if(!(i.x<e.min.x||i.x>e.max.x||i.y<e.min.y||i.y>e.max.y||i.z<e.min.z||i.z>e.max.z)){var r,a;if(0!=e.childOctants.length)for(r=0,a=e.childOctants.length;r<a&&(t=e.childOctants[r],!this.findContainNode(t));++r);return this.containedOctants.push(e),!0}return!1},r.OctantNeighborUtil.prototype.findNeighborNode=function(){var t,i=this.searchNeighborOfNeighbor,r=this.containChildOfNeighbor,a=this.camera,n=this.containedOctants,s=this.OctType,o=this.EdgeType,l=[];if(0==n.length)return l;var d,h,c,u,p,m,f,g,v=a.frustum,y=n[0];f=y.min,g=y.max;var M=a.target,E=a.position,b=new THREE.Vector3(M.x-E.x,M.y-E.y,M.z-E.z),I=new THREE.Ray(E,b),x=[],T=new THREE.Box3(f,g),_=I.intersectBox(T,e);if(_&&(_.y==f.y||_.y==g.y?_.x<=g.x&&_.x>=f.x&&_.z<=g.z&&_.z>=f.z&&(_.y==f.y?x.push(2):x.push(3)):_.z==f.z||_.z==g.z?_.x<=g.x&&_.x>=f.x&&_.y<=g.y&&_.y>=f.y&&(_.z==f.z?x.push(4):x.push(5)):_.x!=f.x&&_.x!=g.x||_.z<=g.z&&_.z>=f.z&&_.y<=g.y&&_.y>=f.y&&(_.x==f.x?x.push(0):x.push(1))),0==x.length)return l;u=g.x-f.x,(p=g.y-f.y)>u&&(u=p),(m=g.z-f.z)>u&&(u=m);var S=u,C=new THREE.Vector3;for(d=0;d<6;d++)if(d!=x[0]){switch(C.copy(y.center),d){case 0:C.x-=S;break;case 1:C.x+=S;break;case 2:C.y-=S;break;case 3:C.y+=S;break;case 4:C.z-=S;break;case 5:C.z+=S}var w=S/2,R=new THREE.Box3(new THREE.Vector3(C.x-w,C.y-w,C.z-w),new THREE.Vector3(C.x+w,C.y+w,C.z+w));v.intersectsBox(R)&&x.push(d)}if(x.length>1&&x.sort(),x.length>2){var B=0;for(d=0;d<x.length;d++)for(h=d+1;h<x.length;h++)for(c=h+1;c<x.length;c++){if(1==x[d]&&3==x[h]&&5==x[c])B=s.RUF;else if(0==x[d]&&3==x[h]&&5==x[c])B=s.LUF;else if(1==x[d]&&2==x[h]&&5==x[c])B=s.RDF;else if(0==x[d]&&2==x[h]&&5==x[c])B=s.LDF;else if(1==x[d]&&3==x[h]&&4==x[c])B=s.RUB;else if(0==x[d]&&3==x[h]&&4==x[c])B=s.LUB;else if(1==x[d]&&2==x[h]&&4==x[c])B=s.RDB;else{if(0!=x[d]||2!=x[h]||4!=x[c])continue;B=s.LDB}(t=this.findVertexNeighbor(0,B))&&(l.push(t),r&&this.getChildOfOctant(t,2,B,l),i&&(t=this.getNeighborOfSecondLevel(t,2,B))&&l.push(t))}}if(x.length>1){var L=0;for(d=0;d<x.length;d++)for(h=d+1;h<x.length;h++){if(0==x[d]&&2==x[h])L=o.LD;else if(0==x[d]&&3==x[h])L=o.LU;else if(0==x[d]&&4==x[h])L=o.LB;else if(0==x[d]&&5==x[h])L=o.LF;else if(1==x[d]&&2==x[h])L=o.RD;else if(1==x[d]&&3==x[h])L=o.RU;else if(1==x[d]&&4==x[h])L=o.RB;else if(1==x[d]&&5==x[h])L=o.RF;else if(2==x[d]&&4==x[h])L=o.DB;else if(2==x[d]&&5==x[h])L=o.DF;else if(3==x[d]&&4==x[h])L=o.UB;else{if(3!=x[d]||5!=x[h])continue;L=o.UF}(t=this.findEdgeNeighbor(0,L))&&(l.push(t),r&&this.getChildOfOctant(t,1,L,l),i&&(t=this.getNeighborOfSecondLevel(t,1,L))&&l.push(t))}}for(d=0;d<x.length;d++)(t=this.findFaceNeighbor(0,x[d]))&&(l.push(t),r&&this.getChildOfOctant(t,0,x[d],l),i&&(t=this.getNeighborOfSecondLevel(t,0,x[d]))&&l.push(t));return l.sort((function(e,t){return e.octantId<t.octantId?-1:1})),l},r.OctantNeighborUtil.prototype.getChildOfOctant=function(e,t,i,r){if(!(0==e.childOctants.length||e.depth<4)){var a=this.FaceType,n=[];switch(t){case 0:n.push(i%2==0?i+1:i-1);break;case 1:var s=this.EdgeType;switch(i){case s.LD:n.push(a.R),n.push(a.U);break;case s.LU:n.push(a.R),n.push(a.D);break;case s.LB:n.push(a.R),n.push(a.F);break;case s.LF:n.push(a.R),n.push(a.B);break;case s.RD:n.push(a.L),n.push(a.U);break;case s.RU:n.push(a.L),n.push(a.D);break;case s.RB:n.push(a.L),n.push(a.F);break;case s.RF:n.push(a.L),n.push(a.B);break;case s.DB:n.push(a.U),n.push(a.F);break;case s.DF:n.push(a.U),n.push(a.B);break;case s.UB:n.push(a.D),n.push(a.F);break;case s.UF:n.push(a.D),n.push(a.B)}break;case 2:var o=this.OctType;switch(i){case o.RUF:n.push(a.L),n.push(a.D),n.push(a.B);break;case o.LUF:n.push(a.R),n.push(a.D),n.push(a.B);break;case o.RDF:n.push(a.L),n.push(a.U),n.push(a.B);break;case o.LDF:n.push(a.R),n.push(a.U),n.push(a.B);break;case o.RUB:n.push(a.L),n.push(a.D),n.push(a.F);break;case o.LUB:n.push(a.R),n.push(a.D),n.push(a.F);break;case o.RDB:n.push(a.L),n.push(a.U),n.push(a.F);break;case o.LDB:n.push(a.R),n.push(a.U),n.push(a.F)}}for(var l=0;l<n.length;l++)this.getFaceChildOfOctant(e,n[l],r)}},r.OctantNeighborUtil.prototype.getFaceChildOfOctant=function(e,t,i){for(var r,a,n=0,s=e.childOctants.length;n<s;n++)if(r=e.childOctants[n],this.adjFace(t,r.octType))i.push(r),this.getFaceChildOfOctant(r,t,i);else{a=this.refelectFace(t,r.octType);for(var o=0;o<s&&e.childOctants[o].octType!=a;o++);o==s&&(i.push(r),this.getFaceChildOfOctant(r,t,i))}},r.OctantNeighborUtil.prototype.getNeighborOfSecondLevel=function(e,t,i){var a=[],n=[];n[0]=e,this.getAncestorNodes(this.root,n,0,[],a);var s=new r.OctantNeighborUtil(this.camera,this.root);s.containedOctants=a;var o=null;switch(t){case 0:o=s.findFaceNeighbor(0,i);break;case 1:o=s.findEdgeNeighbor(0,i);break;case 2:o=s.findVertexNeighbor(0,i)}return o},r.OctantNeighborUtil.prototype.getAncestorAndNeighbors=function(){this.searchNeighborOfNeighbor=!0,this.containChildOfNeighbor=!0;var e=this.containedOctants;this.findContainNode(this.root);var t=this.findNeighborNode(this.camera,e),i=[];this.getAncestorNodes(this.root,t,0,[],i);var r,a,n={};for(r=0,a=e.length;r<a;r++)n[e[r].octantId]=1;for(r=0,a=t.length;r<a;r++)n[t[r].octantId]=1;for(r=0,a=i.length;r<a;r++)n[i[r].octantId]=1;return n},r.OctantNeighborUtil.prototype.getAncestorNodes=function(e,t,i,r,a){var n,s,o;for(n=0,s=e.childOctants.length;n<s&&i<t.length;n++){if(o=e.childOctants[n],r.push(o),o.octantId==t[i].octantId){for(var l=r.length-1;l>=0;l--)a.push(r[l]);i++}else(n==s-1||e.childOctants[n+1].octantId>t[i].octantId)&&(i=this.getAncestorNodes(o,t,i,r,a));r.pop()}return i},r.OctantNeighborUtil.prototype.outputOctants=function(e,t){console.group(),console.log("Node that contains camera: %d",t.octantId);var i="",r=0;for(var a in e)i+=a,i+="  ",r%9==0&&(i+="\n"),r++;console.log("nodes: %s",i),console.groupEnd()},r.OctantNeighborUtil.prototype.outputOctree=function(e,t){var i;console.group();var r="";for(i=0;i<e.depth;i++)r+="  ";console.log("%sNode id: %i, depth: %i, octType: %i, parent: %i",r,e.octantId,e.depth,e.octType,t),console.log("%s  size: %f, center: %f, %f, %f",r,e.size,e.center.x,e.center.y,e.center.z),console.log("%s  child number: %i",r,e.childOctants.length);var a="";for(i=0;i<e.childOctants.length;i++)a+=e.childOctants[i].octantId,a+="  ";for(console.log("%s  children: %i",r,a),i=0;i<e.childOctants.length;i++)this.outputOctree(e.childOctants[i],e.octantId);console.groupEnd()}})(),r.Loader.OctreeNode=function(e,t){void 0===e&&alert("Invalid Octant Id"),this.octantId=e,this.childOctants=new Array,this.min=null,this.max=null,this.depth=t||0,this.center=null,this.size=-1,this.priority=-1,this.octType=-1},r.Loader.OctreeNode.prototype.isRoot=function(){return 0==this.depth},r.Loader.OctreeNode.prototype.add=function(e){e.depth=this.depth+1,this.childOctants.push(e)},r.Loader.OctreeNode.prototype.updateMaxDepth=function(){this.depth>r.GlobalData.MaximumDepth&&(r.GlobalData.MaximumDepth=this.depth)},function(){let e=new THREE.Vector3;r.OctantManager=class{constructor(){this.visibleOctantList=[]}destroy(){this.visibleOctantList=null}_getVisibleOctantsWithInnerAndOuterOctree(e,t,i){this.visibleOctantList.length=0;var a=e.getModelDescriptor().getOctreeRootNode(),n=a.inner,s=a.outer;if(!n&&!s)return[];var o=null;if(e.containsCamera)n&&(o=new r.OctantNeighborUtil(t,n).getAncestorAndNeighbors(),this._frustumCull(t,n,i,this.visibleOctantList)),s&&this._frustumCull(t,s,i,this.visibleOctantList),this._sortOctantList(this.visibleOctantList,o);else{var l=[],d=[];s&&(this._frustumCull(t,s,!0,l),this._sortOctantList(l,o)),n&&(o=new r.OctantNeighborUtil(t,n).getAncestorAndNeighbors(),this._frustumCull(t,n,i,d),this._sortOctantList(d,o));var h,c=l.length,u=d.length;for(h=0;h<c;h++)this.visibleOctantList[h]=l[h];for(h=0;h<u;h++)this.visibleOctantList[c+h]=d[h]}return this.visibleOctantList}_getVisibleOctantsWithLayerOctree(e,t,i){this.visibleOctantList.length=0;var r=e.getModelDescriptor().getOctreeRootNode().layer;return this._frustumCull(t,r,i,this.visibleOctantList),this._sortOctantList(this.visibleOctantList),this.visibleOctantList}getVisibleOctants(e,t,i){return e.getModelDescriptor().isUseInnerAndOuterOctree()?this._getVisibleOctantsWithInnerAndOuterOctree(e,t,i):this._getVisibleOctantsWithLayerOctree(e,t,i)}_sortOctantList(e,t){e.sort((function(e,i){if(null!=t){if(null!=t[e.octantId])return-1;if(null!=t[i.octantId])return 1}return e.priority>i.priority?-1:e.priority<i.priority?1:0}))}showOctreeBox(e){if(r.GlobalData.DEBUG){var t=e.getModelDescriptor().getOctreeRootNode();e.getModelDescriptor().isUseInnerAndOuterOctree()?(t.inner&&e.manager.showOctreeBox(t.inner),t.outer&&e.manager.showOctreeBox(t.outer)):t.layer&&e.manager.showOctreeBox(t.layer)}}_frustumCull(t,i,a,n){var s=t.getFrustum(),o=r.GlobalData.OctantDepth,l=t.projScreenMatrix,d=new THREE.Box3,h=1e-6;!function t(i,r,a,n,s){var o;if(r&&i.depth<a&&(d.set(i.min,i.max),o=r.intersectsBox(d)),o){if(n){var c=d.applyMatrix4(l),u=c.getCenter(e).z;u=u>h?u:h;var p=c.getSize(e).length();i.priority=p/u,s.push(i)}else s.push(i);for(var m=0,f=i.childOctants.length;m<f;++m){t(i.childOctants[m],r,a,n,s)}}}(i,s,o,a,n)}_traverseOctants(e,t){!function e(t,i){i.push(t);for(var r=0,a=t.childOctants.length;r<a;++r){e(t.childOctants[r],i)}}(e,t)}getAllOctants(e){var t=[],i=e.getModelDescriptor().getOctreeRootNode();return e.getModelDescriptor().isUseInnerAndOuterOctree()?(i.inner&&this._traverseOctants(i.inner,t),i.outer&&this._traverseOctants(i.outer,t)):i.layer&&this._traverseOctants(i.layer,t),t}}}(),r.MaterialSelector=class{constructor(){const e=[{name:"scene",param:{name:"scene",color:8947848,opacity:.4,transparent:!0,side:THREE.DoubleSide}},{name:"darkRed",param:{name:"darkRed",color:10496040,opacity:1,transparent:!1,side:THREE.DoubleSide}},{name:"lightBlue",param:{name:"lightBlue",color:1275840,opacity:1,transparent:!1,side:THREE.DoubleSide}},{name:"black",param:{name:"black",color:0,opacity:.3,transparent:!0,side:THREE.DoubleSide}},{name:"add",param:{name:"add",color:65280,opacity:1,transparent:!0,side:THREE.DoubleSide}},{name:"delete",param:{name:"delete",color:16711680,opacity:.5,transparent:!0,side:THREE.DoubleSide}},{name:"beforeEdit",param:{name:"beforeEdit",color:16432389,opacity:.5,transparent:!0,side:THREE.DoubleSide}},{name:"afterEdit",param:{name:"afterEdit",color:16432389,opacity:1,transparent:!0,side:THREE.DoubleSide}}];this._materials={},this._materials.selection=r.MaterialUtil.createHighlightMaterial(),this._materials.selection.name="selection";for(let t=0,i=e.length;t<i;++t){const i=e[t],a=i.name,n=i.param;this._materials[a]=r.MaterialUtil.createStandardMaterial(n)}this._materials.red=this._materials.delete,this._materials.green=this._materials.add,this._materials.yellow=this._materials.beforeEdit,this._materials.blue=this._materials.selection,this._isolateMaterialDefaultParams={color:8947848,opacity:.2,transparent:!0,side:THREE.DoubleSide},this._isolateMaterial=r.MaterialUtil.createStandardMaterial(this._isolateMaterialDefaultParams),this._isolateMaterial.name="isolate",this._frozenMaterialDefaultParams={color:8947848,opacity:.2,transparent:!0,side:THREE.DoubleSide},this._frozenMaterial=r.MaterialUtil.createStandardMaterial(this._frozenMaterialDefaultParams),this._frozenMaterial.name="frozen",this._selectedMaterialDefaultParams={color:15293,side:THREE.DoubleSide},this._selectedMaterial=r.MaterialUtil.createStandardMaterial(this._selectedMaterialDefaultParams),this._selectedMaterial.name="selected",this._instanceMaterialsForClip={},this._materialsForClip={},this._materialsForModifyOpacity={}}getDefaultMaterialName(){return"lightBlue"}get(e){return this._materials[e]}getAll(){return this._materials}add(e){let t,i,a={};return e&&e.hasOwnProperty("uuid")?(t="override_"+e.uuid,delete e.uuid,i=this._materials[t],i||(e.name=t,i=r.MaterialUtil.createStandardMaterial(e),i.overrideColor=!0,this._materials[t]=i),t):(e&&e.hasOwnProperty("color")&&(a.color=e.color,e.hasOwnProperty("opacity")&&(a.opacity=e.opacity,a.transparent=1!=e.opacity),e.hasOwnProperty("map")&&(a.map=e.map,e.hasOwnProperty("bumpMap")&&(a.bumpMap=e.bumpMap))),t=this._getMaterialName(e),i=this._materials[t],i||(a.name=t,i=r.MaterialUtil.createStandardMaterial(a),i.overrideColor=!0,this._materials[t]=i),e.useVertexColor&&(i.vertexColors=!0),t)}remove(e){let t,i;t=this._getMaterialName(e),i=this._materials[t],i&&delete this._materials[t]}has(e){return!!this._materials[e]}getMaterialNameByColor(e){let t,i;return t=this._getMaterialName(e),i=this._materials[t],i?t:this.add(e)}addOverrideMaterial(e){if(!e)return;const t=e.name;e.overrideColor=!0,this._materials[t]||(this._materials[t]=e)}getMaterialParamsFromName(e){let t={};const i=e.split("_");return"mat"==i[0]?(t.color=parseInt(i[1]),t.opacity=1):(t.color=parseInt(i[0]),t.opacity=parseFloat(i[1])),t}_getMaterialName(e){let t;return e&&e.hasOwnProperty("color")?(t=e.hasOwnProperty("opacity")?e.color+"_"+e.opacity:"mat_"+e.color,e.hasOwnProperty("map")&&(t+="_"+e.map.uuid),e.hasOwnProperty("setByOpacity")&&(t+="_opacity"),e.hasOwnProperty("useVertexColor")&&(t+="_"+e.useVertexColor)):t="mat_"+e,t}setFrozonMaterial(e){void 0!==e.color?this._frozenMaterial.color.setHex(e.color):this._frozenMaterial.color.setHex(this._frozenMaterialDefaultParams.color),void 0!==e.opacity?this._frozenMaterial.opacity=e.opacity:this._frozenMaterial.opacity=this._frozenMaterialDefaultParams.opacity,void 0!==e.transparent?this._frozenMaterial.transparent=e.transparent:this._frozenMaterial.transparent=this._frozenMaterialDefaultParams.transparent,void 0!==e.side?this._frozenMaterial.side=e.side:this._frozenMaterial.side=this._frozenMaterialDefaultParams.side,this._frozenMaterial.needsUpdate=!0}getFrozonMaterial(){return this._frozenMaterial}setSelectedMaterial(e){void 0!==e.color?this._selectedMaterial.color.setHex(e.color):this._selectedMaterial.color.setHex(this._selectedMaterialDefaultParams.color),void 0!==e.opacity?this._selectedMaterial.opacity=e.opacity:this._selectedMaterial.opacity=this._selectedMaterialDefaultParams.opacity,void 0!==e.transparent?this._selectedMaterial.transparent=e.transparent:this._selectedMaterial.transparent=this._selectedMaterialDefaultParams.transparent,void 0!==e.side?this._selectedMaterial.side=e.side:this._selectedMaterial.side=this._selectedMaterialDefaultParams.side,this._selectedMaterial.needsUpdate=!0}getSelectedMaterial(){return this._selectedMaterial}setIsolateMaterial(e){void 0!==e.color?this._isolateMaterial.color.setHex(e.color):this._isolateMaterial.color.setHex(this._isolateMaterialDefaultParams.color),void 0!==e.opacity?this._isolateMaterial.opacity=e.opacity:this._isolateMaterial.opacity=this._isolateMaterialDefaultParams.opacity,void 0!==e.transparent?this._isolateMaterial.transparent=e.transparent:this._isolateMaterial.transparent=this._isolateMaterialDefaultParams.transparent,void 0!==e.side?this._isolateMaterial.side=e.side:this._isolateMaterial.side=this._isolateMaterialDefaultParams.side,this._isolateMaterial.needsUpdate=!0}getIsolateMaterial(){return this._isolateMaterial}resetIsolateMaterial(){this._isolateMaterial.color.setHex(this._isolateMaterialDefaultParams.color),this._isolateMaterial.opacity=this._isolateMaterialDefaultParams.opacity,this._isolateMaterial.transparent=this._isolateMaterialDefaultParams.transparent,this._isolateMaterial.side=this._isolateMaterialDefaultParams.side,this._isolateMaterial.needsUpdate=!0}addInstanceMaterialForClip(e,t){void 0===this._instanceMaterialsForClip[e]&&(this._instanceMaterialsForClip[e]={}),this._instanceMaterialsForClip[e].instanceMaterial=t}getAllInstanceMaterialsForClip(){return this._instanceMaterialsForClip}clearInstanceMaterialsForClip(){this._instanceMaterialsForClip={}}addMaterialForClip(e){const t=this.getMaterialNameBy(e);let i=this._materialsForClip[t];if(!i){let a={};e.hasOwnProperty("color")&&(a.color=e.color),e.hasOwnProperty("opacity")&&(a.opacity=e.opacity,a.transparent=1!=e.opacity),e.hasOwnProperty("map")&&(a.map=e.map),a.side=r.Utils.isDefined(e.side)?e.side:THREE.DoubleSide,a.name=t,i=r.MaterialUtil.createStandardMaterial(a),this._materialsForClip[t]=i}return i}getMaterialForClipBy(e,t){let i=this._materialsForClip[e];return i||t&&(i=t.clone(),i.name=e,this._materialsForClip[e]=i),i}getAllMaterialsForClip(){return this._materialsForClip}clearMaterialsForClip(){for(const e in this._materialsForClip)this._materialsForClip[e].dispose();this._materialsForClip={}}getMaterialForModifyOpacityBy(e,t){let i=this._materialsForModifyOpacity[e];return i||t&&(i=t.clone(),i.name=e,this._materialsForModifyOpacity[e]=i),i}clearMaterialsForModifyOpacity(){for(const e in this._materialsForModifyOpacity)this._materialsForModifyOpacity[e].dispose();this._materialsForModifyOpacity={}}getMaterialNameBy(e){let t="";return e.hasOwnProperty("color")&&(t+=e.color),e.hasOwnProperty("opacity")&&(t+="_"+e.opacity),e.hasOwnProperty("map")&&(t+="_"+e.map.uuid),t}getAllTypeMaterial(){let e=Object.values(this._materials);return e.push(this._isolateMaterial,this._frozenMaterial,this._selectedMaterial),e}getCustomizedMaterials(e){let t=Object.values(this._materials);const i=e.override;return t=t.filter((function(e){return i&&!0===e.overrideColor})),e.isolate&&t.push(this._isolateMaterial),e.frozen&&t.push(this._frozenMaterial),e.selected&&t.push(this._selectedMaterial),t}},function(){r.EnumConditionType={HIDDEN_OTHERS:0,TRANSLUCENT_OTHERS:1,OVERRIDE:2,BORDERLINE:3},r.EnumIdBasedType={FILE_VISIBLE:0,FILE_HIDDEN:1,VISIBLE:2,HIDDEN:3,TRANSLUCENT:4,TRANSLUCENT_OTHERS:5,RENDER_PROMOTION:6},r.EnumUserType={HIDDEN_DATA:0,OVERRIDE_DATA:1},r.EnumIsolateState={HIDDEN:0,HIDDEN_OTHERS:1,TRANSLUCENT:2,TRANSLUCENT_OTHERS:3},r.EnumSceneState={DISABLED:0,TRANSLUCENT:1,HIDDEN:2},r.EnumChangedState={NONE:-1,START:1,END:1e4};r.FilterManager=class{constructor(){this.sceneStateHelper=null,this._filterImpl=new r.FilterManager2,this.filterActionList=[],this.isolateFilterAction=null,this.materialSelector=this._filterImpl.getMaterialSelector(),this.objectInfoManager=new r.ObjectInfoManager,this.filterManagerIO=new r.FilterManagerIO(this.materialSelector),this.observerForSceneState=null,this._stateChanged=!1,this._visibleStateChanged=!1,this._visibleStateActionMap={TransparentIdsFA:!0,TransparentConditionFA:!0,VisibleIdsFA:!0,VisibleConditionFA:!0}}destroy(){}setObserverForSceneState(e){this.observerForSceneState=e}setSceneStateHelper(e){this.sceneStateHelper=e}getFilterActionList(){return this.filterActionList}clearFilterActionList(){this.filterActionList=[]}initFilterManager(e){this.objectInfoManager.init(e)}reinitFilterManager(e){this.objectInfoManager.reinit(e)}clearFilterManager(){this.objectInfoManager.clearData()}isStateChanged(){return this._stateChanged}enableStateChanged(){this._stateChanged=!0}disableStateChanged(){this._stateChanged=!1}isVisibleStateChanged(){return this._visibleStateChanged}disableVisibleStateChanged(){this._visibleStateChanged=!1}enableVisibleStateChanged(){this._visibleStateChanged=!0}getIsolateFilterAction(){return this.isolateFilterAction}setIsolateAction(e){this.isolateFilterAction=e,this.isolateFilterAction.apply()}getVisibleComponentsBbox(){return this.objectInfoManager.getVisibleComponentsBbox()}pushBack(e){var t=e.getClassName();"IsolateIdsFA"==t||"IsolateConditionFA"==t?this.isolateFilterAction=e:this.filterActionList.push(e),this._visibleStateActionMap[t]&&this.enableVisibleStateChanged(!0),this._stateChanged=!0,e.applyFilter(this.objectInfoManager)}pushBackWithIds(e,t){var i=e.getClassName();"IsolateIdsFA"==i||"IsolateConditionFA"==i?this.isolateFilterAction=e:this.filterActionList.push(e),this._visibleStateActionMap[i]&&this.enableVisibleStateChanged(!0),this._stateChanged=!0,e.applyFilterWithIds(this.objectInfoManager,t)}removeFilterActionByName(e){for(var t=0;t<this.filterActionList.length;){e==this.filterActionList[t].getClassName()?this.filterActionList.splice(t,1):t++}}showAll(){this.removeFilterActionByName("VisibleIdsFA"),this.removeFilterActionByName("VisibleConditionFA"),this.objectInfoManager.clearVisible(),this.objectInfoManager.calculateVisibleComponentsBbox(),this.enableStateChanged()}hideAll(){var e=new r.VisibleIdsFA(!1,!1);e.ids=[],this.pushBack(e)}getObjectInfoManager(){return this.objectInfoManager}getMatchIds(e){return this.objectInfoManager.getMatchIds(e)}_isVisible(e){var t=e.name;return!this.objectInfoManager.isHidden(t)}isHidden(e){return this.objectInfoManager.isHidden(e)}isFrozen(e){return this.objectInfoManager.isFrozen(e)}_isTransparent(e){var t=e.name;return this.objectInfoManager.isTransparent(t)}_isPickable(e){var t=e.name;return this.isComponentActive(t)&&!this.objectInfoManager.isFrozen(t)}_getOverrideMaterial(e){var t=e.name;return this._getOverrideMaterialById(t)}_getOverrideMaterialById(e){return this.objectInfoManager.isFrozen(e)?this._filterImpl.getFrozonMaterial():this.objectInfoManager.getMaterial(e)}_getMaterialName(e){return this._filterImpl._getMaterialName(e)}_getMaterialByName(e){return this._filterImpl._getMaterialByName(e)}_hasOverrideMaterial(e){var t=e.name;return this.objectInfoManager.hasOverrideMaterial(t)}_hasHighPriorityOverrideMaterial(e){return this._filterImpl._hasHighPriorityOverrideMaterial(e)}_isHiddenFileId(e){return this._filterImpl._isHiddenFileId(e)}_isRenderPromotion(e){return this._filterImpl._isRenderPromotion(e)}_isRenderWithBoardline(e){return this._filterImpl._isRenderWithBoardline(e)}_hasHiddenFileIdFilter(){return this._filterImpl._hasHiddenFileIdFilter()}_hasVisibleFilter(){return this.objectInfoManager.hasObjectHidden()}_hasPickableFilter(){return this.objectInfoManager.hasObjectCantSelected()}_hasTransparentFilter(){return this.objectInfoManager.hasObjectTransparent()}_hasOverrideMaterialFilter(){return this.objectInfoManager.hasOverrideMaterial()}_hasLowPriorityOverride(){return this._filterImpl._hasLowPriorityOverride()}_hasRenderPromotionFilter(){return this._filterImpl._hasRenderPromotionFilter()}_hasRenderWithBoardlineFilter(){return this._filterImpl._hasRenderWithBoardlineFilter()}saveState(){return this.filterManagerIO.saveState(this)}loadState(e){this.filterManagerIO.loadState(e,this)}clear(){this.objectInfoManager.resetAll(),this._stateChanged=!0}clearAll(){return this.enableStateChanged(),this._filterImpl.clearAll()}clearIsolate(){this.objectInfoManager.clearIsolates()}clearFrozenList(){return this.enableStateChanged(),this._filterImpl.clearFrozenList()}addToFrozenList(e){return this.enableStateChanged(),this._filterImpl.addToFrozenList(e)}removeFromFrozenList(e){return this.enableStateChanged(),this._filterImpl.removeFromFrozenList(e)}setFrozenList(e){return this.enableStateChanged(),this._filterImpl.setFrozenList(e)}setFrozenConditions(e){this.enableStateChanged(),this._filterImpl.setFrozenConditions(e)}getFrozenConditions(){return this._filterImpl.getFrozenConditions()}clearFrozenConditions(){this.enableStateChanged(),this._filterImpl.clearFrozenConditions()}clearFrozen(){this.enableStateChanged(),this.clearFrozenList(),this.clearFrozenConditions()}clearAllIdList(){return this.enableStateChanged(),this._filterImpl.clearAllIdList()}clearIdList(e){return this.enableStateChanged(),this._filterImpl.clearIdList(e)}addToIdList(e,t){return this.enableStateChanged(),this._filterImpl.addToIdList(e,t)}removeFromIdList(e,t){return this.enableStateChanged(),this._filterImpl.removeFromIdList(e,t)}setIdList(e,t){return this.enableStateChanged(),this._filterImpl.setIdList(e,t)}clearAllOverrideList(){this.removeFilterActionByName("OverrideIdsFA"),this.removeFilterActionByName("OverrideConditionFA"),this.objectInfoManager.clearMaterial(),this.clearModifyOpacityList(),this.enableStateChanged()}clearOverrideList(e){return this.enableStateChanged(),this._filterImpl.clearOverrideList(e)}addToOverrideList(e,t,i){return this.enableStateChanged(),this._filterImpl.addToOverrideList(e,t,i)}removeFromOverrideList(e,t){return this.enableStateChanged(),this._filterImpl.removeFromOverrideList(e,t)}setOverrideList(e,t,i){return this.enableStateChanged(),this._filterImpl.setOverrideList(e,t,i)}addToOverrideListByColor(e,t){var i=null;if(t){var a=this._filterImpl.getMaterialNameByColor(t);i=this._filterImpl.getMaterialByName(a)}var n=new r.OverrideIdsFA(!0,i);n.ids=e,this.pushBack(n)}addToOverrideListWithAllIdsByColor(e,t){var i=null;if(t){var a=this._filterImpl.getMaterialNameByColor(t);i=this._filterImpl.getMaterialByName(a)}var n=new r.OverrideIdsFA(!0,i);n.ids=[],this.pushBackWithIds(n,e)}addToOverrideListByConditions(e,t){var i=null;if(t){var a=this._filterImpl.getMaterialNameByColor(t);i=this._filterImpl.getMaterialByName(a)}var n=new r.OverrideConditionFA(!0,i);n.conditions=e,this.pushBack(n)}pushBackByMaterials(e,t){var i=e.getClassName();this.filterActionList.push(e),this._visibleStateActionMap[i]&&this.enableVisibleStateChanged(!0),this._stateChanged=!0,e.applyFilterByMaterials(this.objectInfoManager,t)}findMaterialByIds(e,t,i,a,n){var s=e.getModel(t);let o=[];for(let t=0;t<n.length;t++){let i=!0;const r=n[t];let l=null,d=null;const h=s.getFilter().getObjectInfoManager().getMaterial(r);if(h)l=h,l.originOpacity=h.opacity,l.name.indexOf("_opacity")<0&&(i=!1),l.map&&(d=l.map);else{const t=s._handler.getGeometryBuffersByUserId(r);if(t&&t.length>0){d=null;for(let i=0;i<t.length;i++){const a=t[i],n=e.getMaterialByNodeId(a.databagId,r,a.nodeId);if(n&&n.map){d=n.map,l=n;break}n&&n.dispose()}const i=t[0];l||(l=e.getMaterialByNodeId(i.databagId,r,i.nodeId))}}if(l){const e=l.color.getHex();l.dispose();let t=e+"";d&&(t+="_"+d.uuid),i&&(t+="_opacity");let r={color:e,opacity:a};i&&(r.setByOpacity=i),d&&(r.map=d),o.push(r),d&&d.dispose(),d=null}}let l=[];for(let e=0;e<o.length;e++){let t=this._filterImpl.getMaterialNameByColor(o[e]),i=this._filterImpl.getMaterialByName(t);l.push(i)}var d=new r.OverrideConditionFA(!0,null);d.setOpacity(a),d.conditions=i,this.pushBackByMaterials(d,l)}addToOverrideListWithOpacityByConditions(e,t,i,r){var a=this;i instanceof Array&&this.objectInfoManager.matchConditions(i,(function(e,t,n,s){s&&a.findMaterialByIds(e,t,i,r,n)}),e,t)}addToOverrideListByMaterial(e,t){this._filterImpl.addOverrideMaterial(t);var i=new r.OverrideConditionFA(!0,t);i.conditions=e,this.pushBack(i)}addToOverrideListByMaterialAndId(e,t){t&&(t.vertexColors=!1),this._filterImpl.addOverrideMaterial(t);var i=new r.OverrideIdsFA(!0,t);i.ids=e,this.pushBack(i)}setOverrideListByColor(e,t,i){for(var r=0;r<t.length;r++){var a=this._filterImpl.getMaterialNameByColor(i),n=this._filterImpl.getMaterialByName(a);this.objectInfoManager.setMaterial(t[r],n)}}getVisibleComponentSet(e){for(var t={},i=Object.keys(e),r=0;r<i.length;r++)this._isVisible({name:i[r]})&&(t[i[r]]=!0);return t}clearAllUserList(){return this.enableStateChanged(),this._filterImpl.clearAllUserList()}clearUserListByType(e){return this.enableStateChanged(),this._filterImpl.clearUserListByType(e)}clearUserList(e,t){return this.enableStateChanged(),this._filterImpl.clearUserList(e,t)}addToUserList(e,t,i,r){return this.enableStateChanged(),this._filterImpl.addToUserList(e,t,i,r)}removeFromUserList(e,t,i){this.enableStateChanged(),this._filterImpl.removeFromUserList(e,t,i)}setUserList(e,t,i,r){this.enableStateChanged(),this._filterImpl.setUserList(e,t,i,r)}isIsolate(){var e=this.objectInfoManager.getObjectsMap();for(var t in e){if(e.hasOwnProperty(t))var i=e[t];for(var r in i){var a=this.objectInfoManager.isIsolateHide(r);if(a|=this.objectInfoManager.isIsolateTransparent(r))return!0}}return!1}isFiltering(){var e=this.filterActionList.length>0;return this.isIsolate()||e}getFrozonMaterial(){return this._filterImpl.getFrozonMaterial()}setIsolateMaterial(e){this.enableStateChanged(),this._filterImpl.setIsolateMaterial(e)}getIsolateMaterial(){return this._filterImpl.getIsolateMaterial()}resetIsolateMaterial(){this.enableStateChanged(),this._filterImpl.resetIsolateMaterial()}clearAllIsolateList(){this.objectInfoManager.clearIsolates(),this.enableStateChanged()}clearIsolation(){this.objectInfoManager.clearIsolates(),this.isolateFilterAction=null,this.enableStateChanged()}setIsolationByIds(e,t){var i="HideOthers"==t;this.setIsolateList(e,i)}addToIsolateList(e,t){var i="HideOthers"==t,a=new r.IsolateIdsFA(i);a.ids=e,this.pushBack(a),this.clearFilterActionList(),i&&this.enableVisibleStateChanged(!0)}removeFromIsolateList(e,t){this.enableStateChanged(),this._filterImpl.removeFromIsolateList(e,t)}setIsolateList(e,t){var i=new r.IsolateIdsFA(t);i.ids=e,this.pushBack(i),t&&this.enableVisibleStateChanged(!0)}removeFromIsolateList(e,t){this.enableStateChanged(),this._filterImpl.removeFromIsolateList(e,t)}setIsolateConditions(e,t){var i=t==r.EnumIsolateState.HIDDEN_OTHERS,a=new r.IsolateConditionFA(i);a.conditions=e,this.pushBack(a),this.clearFilterActionList(),i&&this.enableVisibleStateChanged(!0)}getIsolateConditions(e){return this._filterImpl.getIsolateConditions(e)}clearIsolateConditions(e){this.enableStateChanged(),this._filterImpl.clearIsolateConditions(e)}clearAllIsolateConditions(){this.enableStateChanged(),this._filterImpl.clearAllIsolateConditions()}setConditions(e,t){if(0==e){this.objectInfoManager.hideAll();var i=new r.VisibleConditionFA(!0,!0);i.conditions=t,this.pushBack(i)}3==e&&this._filterImpl.setConditions(e,t)}getConditions(e){return this._filterImpl.getConditions(e)}clearConditions(e){this.enableStateChanged(),this._filterImpl.clearConditions(e)}clearAllConditions(){this.enableStateChanged(),this._filterImpl.clearAllConditions()}makeSceneTranslucent(){this.enableStateChanged(),this._filterImpl.makeSceneTranslucent()}cancelSceneTranslucent(){this.enableStateChanged(),this._filterImpl.cancelSceneTranslucent()}hideScene(){this.enableStateChanged(),this._filterImpl.hideScene()}showScene(){this.enableStateChanged(),this._filterImpl.showScene()}setSceneState(e){this.enableStateChanged(),this._filterImpl.setSceneState(e)}getSceneState(){return this._filterImpl.getSceneState()}cancelHidden(){this.enableStateChanged(),this._filterImpl.cancelHidden()}cancelTranslucent(){this.enableStateChanged(),this._filterImpl.cancelTranslucent()}hideByIds(e){var t=new r.VisibleIdsFA(!0,!1);t.ids=e,this.pushBack(t)}hideByConditions(e){var t=new r.VisibleConditionFA(!0,!1);t.conditions=e,this.pushBack(t)}hideOthersByConditions(e){var t=new r.VisibleConditionFA(!1,!1);t.conditions=e,this.pushBack(t)}showByIds(e){var t=new r.VisibleIdsFA(!0,!0);t.ids=e,this.pushBack(t)}showByConditions(e){var t=new r.VisibleConditionFA(!0,!0);t.conditions=e,this.pushBack(t)}makeTranslucentByIds(e){var t=new r.TransparentIdsFA(!0,!1);t.ids=e,this.pushBack(t)}makeTranslucentByConditions(e){var t=new r.TransparentConditionFA(!0,!1);t.conditions=e,this.pushBack(t)}opaqueByIds(e){var t=new r.TransparentIdsFA(!0,!0);t.ids=e,this.pushBack(t)}opaqueByConditions(e){var t=new r.TransparentConditionFA(!0,!0);t.conditions=e,this.pushBack(t)}setFrozonMaterial(e){this._filterImpl.setFrozonMaterial(e),this.enableStateChanged()}makeTranslucentOthersByIds(e){var t=new r.TransparentIdsFA(!1,!1);t.ids=e,this.pushBack(t)}opaqueAll(){this.removeFilterActionByName("TransparentIdsFA"),this.removeFilterActionByName("TransparentConditionFA"),this.objectInfoManager.clearTransparent(),this.enableStateChanged()}deactivateByIds(e){this.objectInfoManager.deactivateByIds(e),this.observerForSceneState&&this.observerForSceneState(e)}clearInactivatedIdMap(){this.objectInfoManager.clearInactivatedIdMap()}getInactivatedIdMap(){return this.objectInfoManager.getInactivatedIdMap()}deactivateAll(){this.objectInfoManager.deactivateAll()}activateAll(){this.objectInfoManager.activateAll()}isComponentActive(e){return this.objectInfoManager.isActive(e)}getFilterType(){return this._filterImpl.getFilterType()}_hasOverrideMaterialForWireFrame(e){var t=e.name;return this.objectInfoManager.hasOverrideMaterialForWireFrame(t)}_hasOverrideMaterialFilterForWireFrame(){return this.objectInfoManager.hasOverrideMaterialForWireFrame()}_getOverrideMaterialForWireFrame(e){return this.objectInfoManager.getWireFrameMaterial(e.name)}_getOverrideWireFrameMaterial(e){return this.objectInfoManager.getWireFrameMaterial(e.name)}addToOverrideListForWireFrameByColor(e,t){var i=null;if(t){var a=this._filterImpl.getMaterialNameByColor(t);i=this._filterImpl.getMaterialByName(a)}var n=new r.OverrideIdsForWireFrameFA(!0,i);n.ids=e,this.pushBack(n)}addToOverrideListForAllWireFrameByColor(e,t){var i=null;if(t){var a=this._filterImpl.getMaterialNameByColor(t);i=this._filterImpl.getMaterialByName(a)}var n=new r.OverrideIdsForWireFrameFA(!0,i);n.ids=[],this.pushBackWithIds(n,e)}addToOverrideListForWireFrameByConditions(e,t){var i=null;if(t){var a=this._filterImpl.getMaterialNameByColor(t);i=this._filterImpl.getMaterialByName(a)}var n=new r.OverrideConditionForWireFrameFA(!0,i);n.conditions=e,this.pushBack(n)}needUpdateBoxAfterExplode(){this.getObjectInfoManager().needUpdateBoxAfterExplode()}addToOpacityListByConditions(e,t){this.getObjectInfoManager().matchConditions(e,t)}addToModifyOpacityList(e,t){this.isComponentActive(e)&&this.getObjectInfoManager().addToModifyOpacityList(e,t)}removeModifyOpacityList(e){this.getObjectInfoManager().removeModifyOpacityList(e)}getModifyOpacityList(){return this.objectInfoManager.modifyOpacityList}clearModifyOpacityList(){this.objectInfoManager.clearModifyOpacityList(),this._filterImpl.clearMaterialsForModifyOpacity()}_hasModifyOpacityList(){return this.objectInfoManager.hasModifyOpacityList}getMaterialForModifyOpacityFrom(e,t){if(e){var i={};i.color=e.color.getHex(),i.opacity=t,i.side=e.side,e.map&&(i.map=e.map);var r=this._filterImpl.getMaterialNameBy(i),a=this._filterImpl.getMaterialForModifyOpacityBy(r,e);return a.opacity=t,a.transparent=t<1,a}}addToLocalClippingListByConditions(e,t){this.getObjectInfoManager().matchConditions(e,t)}addToLocalClippingList(e,t,i,r){if(t&&i){this.addMaterialForClip(t),this.addMaterialForClip(i);var a=this._filterImpl.getMaterialNameBy(t),n=this._filterImpl.getMaterialNameBy(i);this.objectInfoManager.addToLocalClippingList(e,a,n,r)}else this.objectInfoManager.addToLocalClippingList(e);this.enableStateChanged()}getLocalClippingList(){return this.objectInfoManager.localClippingList}clearLocalClippingList(){this.objectInfoManager.clearLocalClippingList(),this._filterImpl.clearInstanceMaterialsForClip(),this._filterImpl.clearMaterialsForClip(),this.enableStateChanged()}_hasLocalClipping(){return this.objectInfoManager.hasLocalClipping}addInstanceMaterialForClip(e,t){this._filterImpl.addInstanceMaterialForClip(e,t),this.enableStateChanged()}getAllInstanceMaterialsForClip(){return this._filterImpl.getAllInstanceMaterialsForClip()}addMaterialForClip(e){this._filterImpl.addMaterialForClip(e),this.enableStateChanged()}getMaterialForClipBy(e,t){return this._filterImpl.getMaterialForClipBy(e,t)}getMaterialForClipFrom(e){if(e){var t={};t.color=e.color.getHex(),t.opacity=e.opacity,t.side=e.side,e.map&&(t.map=e.map);var i=this._filterImpl.getMaterialNameBy(t);return this._filterImpl.getMaterialForClipBy(i,e)}}getAllMaterialsForClip(){return this._filterImpl.getAllMaterialsForClip()}setWireFrameVisibilityCondition(e){this._filterImpl.setWireFrameVisibilityCondition(e)}getWireFrameVisibilityCondition(){return this._filterImpl.getWireFrameVisibilityCondition()}_isRenderWithWireFrame(e){return this._filterImpl._isRenderWithWireFrame(e)}}}(),r.FilterManager2=function(){var e,t,i=r.EnumIdBasedType,a=r.EnumSceneState,n=r.FilterResultMode,s={IDFILTER_OFFSET:0,FILE_VISIBLE:0,FILE_HIDDEN:1,VISIBLE:2,HIDDEN:3,TRANSLUCENT:4,TRANSLUCENT_OTHERS:5,RENDER_PROMOTION:6,IDFILTER_ENDOFFSET:6,ISOLATEFILTER_OFFSET:7,ISOLATE_HIDDEN:7,ISOLATE_HIDDEN_OTHERS:8,ISOLATE_TRANSLUCENT:9,ISOLATE_TRANSLUCENT_OTHERS:10,ISOLATEFILTER_ENDOFFSET:10,USERFILTER_OFFSET:11,USER_HIDDEN:11,USER_OVERRIDE:12,USERFILTER_ENDOFFSET:12,CONDITIONFILTER_OFFSET:13,CONDITION_HIDDEN_OTHERS:13,CONDITION_TRANSLUCENT_OTHERS:14,CONDITION_OVERRIDE:15,CONDITION_BORDERLINE:16,CONDITIONFILTER_ENDOFFSET:16,ISOLATECONDITIONFILTER_OFFSET:17,ISOLATE_CONDITION_HIDDEN:17,ISOLATE_CONDITION_HIDDEN_OTHERS:18,ISOLATE_CONDITION_TRANSLUCENT:19,ISOLATE_CONDITION_TRANSLUCENT_OTHERS:20,ISOLATECONDITIONFILTER_ENDOFFSET:20,FROZENFILTER:21,FROZENCONDITIONFILTER:22,OVERRIDEFILTER:23,BASICFILTER_COUNT:23},o=new r.CompoundFilter(!0),l=new r.CompoundFilter(!0),d=new r.CompoundFilter(!1),h=new r.CompoundFilter(!0),c=new r.CompoundFilter(!1),u=new r.CompoundFilter(!1),p=new r.CompoundFilter(!1),m=[],f=a.DISABLED,g=new r.MaterialSelector,v=null;!function(){var i;m[s.FILE_VISIBLE]=new r.FileIdFilter(s.FILE_VISIBLE,"FILE_VISIBLE"),m[s.FILE_HIDDEN]=new r.FileIdFilter(s.FILE_HIDDEN,"FILE_HIDDEN"),m[s.VISIBLE]=new r.GeneralIdFilter(s.VISIBLE,"VISIBLE"),m[s.HIDDEN]=new r.GeneralIdFilter(s.HIDDEN,"HIDDEN"),m[s.TRANSLUCENT]=new r.GeneralIdFilter(s.TRANSLUCENT,"TRANSLUCENT"),m[s.TRANSLUCENT_OTHERS]=new r.GeneralIdFilter(s.TRANSLUCENT_OTHERS,"TRANSLUCENT_OTHERS"),m[s.RENDER_PROMOTION]=new r.GeneralIdFilter(s.RENDER_PROMOTION,"RENDER_PROMOTION"),m[s.ISOLATE_HIDDEN]=new r.GeneralIdFilter(s.ISOLATE_HIDDEN,"ISOLATE_HIDDEN"),m[s.ISOLATE_HIDDEN_OTHERS]=new r.GeneralIdFilter(s.ISOLATE_HIDDEN_OTHERS,"ISOLATE_HIDDEN_OTHERS"),m[s.ISOLATE_TRANSLUCENT]=new r.GeneralIdFilter(s.ISOLATE_TRANSLUCENT,"ISOLATE_TRANSLUCENT"),m[s.ISOLATE_TRANSLUCENT_OTHERS]=new r.GeneralIdFilter(s.ISOLATE_TRANSLUCENT_OTHERS,"ISOLATE_TRANSLUCENT_OTHERS"),m[s.USER_HIDDEN]=new r.UserListFilter(s.USER_HIDDEN,"USER_HIDDEN"),m[s.USER_OVERRIDE]=new r.UserListFilter(s.USER_OVERRIDE,"USER_OVERRIDE"),m[s.CONDITION_HIDDEN_OTHERS]=new r.ConditionFilter(s.CONDITION_HIDDEN_OTHERS,"CONDITION_HIDDEN_OTHERS"),m[s.CONDITION_TRANSLUCENT_OTHERS]=new r.ConditionFilter(s.CONDITION_TRANSLUCENT_OTHERS,"CONDITION_TRANSLUCENT_OTHERS"),m[s.CONDITION_OVERRIDE]=new r.MultiConditionFilter(s.CONDITION_OVERRIDE,"CONDITION_OVERRIDE"),m[s.CONDITION_BORDERLINE]=new r.ConditionFilter(s.CONDITION_BORDERLINE,"CONDITION_BORDERLINE"),m[s.ISOLATE_CONDITION_HIDDEN]=new r.ConditionFilter(s.ISOLATE_CONDITION_HIDDEN,"ISOLATE_CONDITION_HIDDEN"),m[s.ISOLATE_CONDITION_HIDDEN_OTHERS]=new r.ConditionFilter(s.ISOLATE_CONDITION_HIDDEN_OTHERS,"ISOLATE_CONDITION_HIDDEN_OTHERS"),m[s.ISOLATE_CONDITION_TRANSLUCENT]=new r.ConditionFilter(s.ISOLATE_CONDITION_TRANSLUCENT,"ISOLATE_CONDITION_TRANSLUCENT"),m[s.ISOLATE_CONDITION_TRANSLUCENT_OTHERS]=new r.ConditionFilter(s.ISOLATE_CONDITION_TRANSLUCENT_OTHERS,"ISOLATE_CONDITION_TRANSLUCENT_OTHERS"),t=new r.GeneralIdFilter(s.FROZENFILTER,"FROZENFILTER"),m[s.FROZENCONDITIONFILTER]=new r.ConditionFilter(s.FROZENCONDITIONFILTER,"FROZENCONDITIONFILTER"),m[s.FROZENFILTER]=t,e=new r.OverrideListFilter(s.OVERRIDEFILTER,"OVERRIDEFILTER"),m[s.OVERRIDEFILTER]=e;var a={};for(i in a[s.HIDDEN]=n.MATCH_RETURN_FALSE,a[s.VISIBLE]=n.NOMATCH_RETURN_FALSE,a[s.USER_HIDDEN]=n.MATCH_RETURN_FALSE,a[s.CONDITION_HIDDEN_OTHERS]=n.NOMATCH_RETURN_FALSE,a[s.ISOLATE_HIDDEN]=n.MATCH_RETURN_FALSE,a[s.ISOLATE_HIDDEN_OTHERS]=n.NOMATCH_RETURN_FALSE,a[s.ISOLATE_CONDITION_HIDDEN_OTHERS]=n.NOMATCH_RETURN_FALSE,o.setFilterMode(a),a)m[i].registerToCompoundFilter(o);var f={};for(i in f[s.FROZENFILTER]=n.MATCH_RETURN_FALSE,f[s.FROZENCONDITIONFILTER]=n.MATCH_RETURN_FALSE,f[s.TRANSLUCENT]=n.MATCH_RETURN_FALSE,f[s.TRANSLUCENT_OTHERS]=n.NOMATCH_RETURN_FALSE,f[s.CONDITION_TRANSLUCENT_OTHERS]=n.NOMATCH_RETURN_FALSE,f[s.ISOLATE_TRANSLUCENT]=n.MATCH_RETURN_FALSE,f[s.ISOLATE_TRANSLUCENT_OTHERS]=n.NOMATCH_RETURN_FALSE,f[s.ISOLATE_CONDITION_TRANSLUCENT_OTHERS]=n.NOMATCH_RETURN_FALSE,h.setFilterMode(f),f)m[i].registerToCompoundFilter(h);var g={};g[s.ISOLATE_TRANSLUCENT]=n.MATCH_RETURN_TRUE,g[s.ISOLATE_TRANSLUCENT_OTHERS]=n.NOMATCH_RETURN_TRUE,g[s.ISOLATE_CONDITION_TRANSLUCENT_OTHERS]=n.NOMATCH_RETURN_TRUE,g[s.CONDITION_TRANSLUCENT_OTHERS]=n.NOMATCH_RETURN_TRUE,g[s.TRANSLUCENT]=n.MATCH_RETURN_TRUE,g[s.TRANSLUCENT_OTHERS]=n.NOMATCH_RETURN_TRUE,g[s.OVERRIDEFILTER]=n.MATCH_RETURN_TRUE,g[s.USER_OVERRIDE]=n.MATCH_RETURN_TRUE,g[s.CONDITION_OVERRIDE]=n.MATCH_RETURN_TRUE,g[s.FROZENFILTER]=n.MATCH_RETURN_TRUE,g[s.FROZENCONDITIONFILTER]=n.MATCH_RETURN_TRUE;var v={};for(i in v[s.ISOLATE_TRANSLUCENT]=5,v[s.ISOLATE_TRANSLUCENT_OTHERS]=5,v[s.ISOLATE_CONDITION_TRANSLUCENT_OTHERS]=5,v[s.CONDITION_TRANSLUCENT_OTHERS]=5,v[s.TRANSLUCENT]=5,v[s.TRANSLUCENT_OTHERS]=5,v[s.OVERRIDEFILTER]=0,v[s.USER_OVERRIDE]=0,v[s.CONDITION_OVERRIDE]=0,v[s.FROZENFILTER]=3,v[s.FROZENCONDITIONFILTER]=3,l.setFilterMode(g),l.setFilterPriority(v),g)m[i].registerToCompoundFilter(l);var y={};for(i in y[s.OVERRIDEFILTER]=n.MATCH_RETURN_TRUE,y[s.USER_OVERRIDE]=n.MATCH_RETURN_TRUE,y[s.CONDITION_OVERRIDE]=n.MATCH_RETURN_TRUE,y[s.CONDITION_TRANSLUCENT_OTHERS]=n.MATCH_RETURN_TRUE,d.setFilterMode(y),y)m[i].registerToCompoundFilter(d);var M={};for(i in M[s.FILE_VISIBLE]=n.NOMATCH_RETURN_TRUE,M[s.FILE_HIDDEN]=n.MATCH_RETURN_TRUE,c.setFilterMode(M),M)m[i].registerToCompoundFilter(c);var E={};for(i in E[s.RENDER_PROMOTION]=n.MATCH_RETURN_TRUE,E[s.ISOLATE_CONDITION_TRANSLUCENT_OTHERS]=n.MATCH_RETURN_TRUE,u.setFilterMode(E),E)m[i].registerToCompoundFilter(u);var b={};for(i in b[s.CONDITION_BORDERLINE]=n.MATCH_RETURN_TRUE,p.setFilterMode(b),b)m[i].registerToCompoundFilter(p)}(),this.getMaterialSelector=function(){return g},this.getBasicFilterList=function(){return m},this.getFilterType=function(){return s},this.saveState=function(){for(var e,t={},i=0,r=m.length;i<r;i++)t[(e=m[i]).getName()]=e.getAll();return t.sceneState=this.getSceneState(),t.version="0.4",t},this.loadState=function(e){if(this.clearAll(),e.hasOwnProperty("version")){if("0.4"==e.version){for(var t={},i=0,a=m.length;i<a;i++)t[m[i].getName()]=i;for(var n in e)"sceneState"!==n&&"version"!==n&&(t.hasOwnProperty(n)?m[t[n]].setByData(e[n]):r.Logger.warn("Warning: Not supported filter '"+n+"'"))}}else for(var o in e)"sceneState"!==o&&(o<2?m[o].setByData(e[o]):o>2?o<s.BASICFILTER_COUNT+2&&m[o-1].setByData(e[o]):2==o&&r.Logger.warn("Warning: Old version filter data! The selection state is out of the filter, can not restore it."));this.setSceneState(e.sceneState)},this.clear=function(){for(var e=0,t=m.length;e<t;e++){var i=m[e].getType();i!==s.FROZENFILTER&&i!==s.CONDITION_BORDERLINE&&m[e].clearAll()}this.setSceneState(a.DISABLED)},this.clearAll=function(){for(var e=0,t=m.length;e<t;e++)m[e].clearAll();this.setSceneState(a.DISABLED)},this.clearIsolate=function(){this.clearAllIsolateList(),this.clearAllIsolateConditions()},this.clearFrozenList=function(){t.clearAll()},this.addToFrozenList=function(e){t.add(e)},this.removeFromFrozenList=function(e){t.remove(e)},this.setFrozenList=function(e){this.clearFrozenList(),this.addToFrozenList(e)},this.setFrozenConditions=function(e){m[s.FROZENCONDITIONFILTER].setByData(e)},this.getFrozenConditions=function(){return m[s.FROZENCONDITIONFILTER].getAll()},this.clearFrozenConditions=function(){m[s.FROZENCONDITIONFILTER].clear()},this.clearFrozen=function(){this.clearFrozenList(),this.clearFrozenConditions()},this.clearAllIdList=function(){var e;for(e=s.IDFILTER_OFFSET;e<=s.IDFILTER_ENDOFFSET;e++)m[e].clearAll()},this.clearIdList=function(e){var t=s.IDFILTER_OFFSET+e;t>=s.IDFILTER_OFFSET&&t<=s.IDFILTER_ENDOFFSET&&m[t].clear()},this.addToIdList=function(e,t){var i=s.IDFILTER_OFFSET+e;i>=s.IDFILTER_OFFSET&&i<=s.IDFILTER_ENDOFFSET&&m[i].add(t)},this.removeFromIdList=function(e,t){var i=s.IDFILTER_OFFSET+e;i>=s.IDFILTER_OFFSET&&i<=s.IDFILTER_ENDOFFSET&&m[i].remove(t)},this.setIdList=function(e,t){this.clearIdList(e),this.addToIdList(e,t)},this.clearAllOverrideList=function(){e.clearAll()},this.clearOverrideList=function(t){e.clear(t)},this.addToOverrideList=function(t,i,r){i&&i.length>0&&(g.has(r)||(r=g.getDefaultMaterialName()),e.add(t,i,r))},this.removeFromOverrideList=function(t,i){e.remove(t,i)},this.setOverrideList=function(e,t,i){this.clearOverrideList(e),this.addToOverrideList(e,t,i)},this.addToOverrideListByColor=function(t,i,r){var a=g.add(r);e.add(t,i,a)},this.setOverrideListByColor=function(e,t,i){this.clearOverrideList(e),this.addToOverrideListByColor(e,t,i)},this.clearAllUserList=function(){var e;for(e=s.USERFILTER_OFFSET;e<=s.USERFILTER_ENDOFFSET;e++)m[e].clearAll()},this.clearUserListByType=function(e){var t=s.USERFILTER_OFFSET+e;t>=s.USERFILTER_OFFSET&&t<=s.USERFILTER_ENDOFFSET&&m[t].clearAll()},this.clearUserList=function(e,t){var i=s.USERFILTER_OFFSET+e;i>=s.USERFILTER_OFFSET&&i<=s.USERFILTER_ENDOFFSET&&m[i].clear(t)},this.addToUserList=function(e,t,i,r){var a=s.USERFILTER_OFFSET+e;a>=s.USERFILTER_OFFSET&&a<=s.USERFILTER_ENDOFFSET&&m[a].add(t,i,r)},this.removeFromUserList=function(e,t,i){var r=s.USERFILTER_OFFSET+e;r>=s.USERFILTER_OFFSET&&r<=s.USERFILTER_ENDOFFSET&&m[r].remove(t,i)},this.setUserList=function(e,t,i,r){this.clearUserList(e,t),this.addToUserList(e,t,i,r)},this.isIsolate=function(){var e;for(e=s.ISOLATEFILTER_OFFSET;e<=s.ISOLATEFILTER_ENDOFFSET;e++)if(!m[e].isEmpty())return!0;return!1},this.isFiltering=function(){return!!this.isIsolate()||!(m[s.HIDDEN].isEmpty()&&m[s.VISIBLE].isEmpty()&&m[s.TRANSLUCENT].isEmpty()&&m[s.TRANSLUCENT_OTHERS].isEmpty()&&this.getSceneState()===a.DISABLED)},this.setFrozonMaterial=function(e){g.setFrozonMaterial(e)},this.getFrozonMaterial=function(){return g.getFrozonMaterial()},this.setSelectedMaterial=function(e){g.setSelectedMaterial(e)},this.getSelectedMaterial=function(){return g.getSelectedMaterial()},this.setIsolateMaterial=function(e){g.setIsolateMaterial(e)},this.getIsolateMaterial=function(){return g.getIsolateMaterial()},this.resetIsolateMaterial=function(){g.resetIsolateMaterial()},this.clearAllIsolateList=function(){var e;for(e=s.ISOLATEFILTER_OFFSET;e<=s.ISOLATEFILTER_ENDOFFSET;e++)m[e].clear()},this.clearIsolateList=function(e){var t=s.ISOLATEFILTER_OFFSET+e;t>=s.ISOLATEFILTER_OFFSET&&t<=s.ISOLATEFILTER_ENDOFFSET&&m[t].clear()},this.addToIsolateList=function(e,t){var i=s.ISOLATEFILTER_OFFSET+e;i>=s.ISOLATEFILTER_OFFSET&&i<=s.ISOLATEFILTER_ENDOFFSET&&m[i].add(t)},this.removeFromIsolateList=function(e,t){var i=s.ISOLATEFILTER_OFFSET+e;i>=s.ISOLATEFILTER_OFFSET&&i<=s.ISOLATEFILTER_ENDOFFSET&&m[i].remove(t)},this.setIsolateList=function(e,t){this.clearIsolateList(e),this.addToIsolateList(e,t)},this.setIsolateConditions=function(e,t){var i=s.ISOLATECONDITIONFILTER_OFFSET+t;i>=s.ISOLATECONDITIONFILTER_OFFSET&&i<=s.ISOLATECONDITIONFILTER_ENDOFFSET&&m[i].setByData(e)},this.getIsolateConditions=function(e){var t=null,i=s.ISOLATECONDITIONFILTER_OFFSET+e;return i>=s.ISOLATECONDITIONFILTER_OFFSET&&i<=s.ISOLATECONDITIONFILTER_ENDOFFSET&&(t=m[i].getAll()),t},this.clearIsolateConditions=function(e){var t=s.ISOLATECONDITIONFILTER_OFFSET+e;t>=s.ISOLATECONDITIONFILTER_OFFSET&&t<=s.ISOLATECONDITIONFILTER_ENDOFFSET&&m[t].clear()},this.clearAllIsolateConditions=function(){var e;for(e=s.ISOLATECONDITIONFILTER_OFFSET;e<=s.ISOLATECONDITIONFILTER_ENDOFFSET;e++)m[e].clearAll()},this.setConditions=function(e,t){var i=s.CONDITIONFILTER_OFFSET+e;i>=s.CONDITIONFILTER_OFFSET&&i<=s.CONDITIONFILTER_ENDOFFSET&&m[i].setByData(t)},this.getConditions=function(e){var t=null,i=s.CONDITIONFILTER_OFFSET+e;return i>=s.CONDITIONFILTER_OFFSET&&i<=s.CONDITIONFILTER_ENDOFFSET&&(t=m[i].get()),t},this.clearConditions=function(e){var t=s.CONDITIONFILTER_OFFSET+e;t>=s.CONDITIONFILTER_OFFSET&&t<=s.CONDITIONFILTER_ENDOFFSET&&m[t].clearAll()},this.clearAllConditions=function(){var e;for(e=s.CONDITIONFILTER_OFFSET;e<=s.CONDITIONFILTER_ENDOFFSET;e++)m[e].clear()},this.makeSceneTranslucent=function(){this.setSceneState(a.TRANSLUCENT)},this.cancelSceneTranslucent=function(){this.setSceneState(a.DISABLED)},this.hideScene=function(){this.setSceneState(a.HIDDEN)},this.showScene=function(){this.setSceneState(a.DISABLED)},this.setSceneState=function(e){f=e},this.getSceneState=function(){return f},this.cancelTranslucent=function(){this.clearIdList(i.TRANSLUCENT),this.clearIdList(i.TRANSLUCENT_OTHERS)},this._addIdsToFilter=function(e,t){var i=s.IDFILTER_OFFSET+e;i>=s.IDFILTER_OFFSET&&i<=s.IDFILTER_ENDOFFSET&&m[i].add(t)},this.hideByIds=function(e){this._addIdsToFilter(i.HIDDEN,e)},this.showByIds=function(e){this._addIdsToFilter(i.VISIBLE,e)},this.makeTranslucentByIds=function(e){this._addIdsToFilter(i.TRANSLUCENT,e)},this.makeTranslucentOthersByIds=function(e){this._addIdsToFilter(i.TRANSLUCENT_OTHERS,e)},this._isVisible=function(e){return this.getSceneState()!==a.HIDDEN&&o.apply(e)},this._isSelectable=function(e){return this.getSceneState()!==a.TRANSLUCENT&&h.apply(e,this.getSceneState())},this.getMaterialNameByColor=function(e){return g.getMaterialNameByColor(e)},this.addOverrideMaterial=function(e){g.addOverrideMaterial(e)},this.getMaterialByName=function(e){return g.get(e)},this._getOverrideMaterial=function(e){if(this.getSceneState()===a.TRANSLUCENT)return g.get("scene");var t=l.getApplyFilterId(e),i=null,r="";switch(t){case s.ISOLATE_TRANSLUCENT:case s.ISOLATE_TRANSLUCENT_OTHERS:case s.ISOLATE_CONDITION_TRANSLUCENT_OTHERS:i=this.getIsolateMaterial();break;case s.CONDITION_TRANSLUCENT_OTHERS:case s.TRANSLUCENT:case s.TRANSLUCENT_OTHERS:i=g.get("scene");break;case s.FROZENFILTER:case s.FROZENCONDITIONFILTER:break;case s.OVERRIDEFILTER:case s.USER_OVERRIDE:case s.CONDITION_OVERRIDE:var n=m[t].getMatchItem(e);r=n.hasOwnProperty("color")?g.getMaterialNameByColor(n.color):n.material?n.material:n}return i||""===r||(g.has(r)||(r=g.getDefaultMaterialName()),i=g.get(r)),i},this._getMaterialName=function(e){if(this.getSceneState()===a.TRANSLUCENT)return"scene";var t=l.getApplyFilterId(e),i="";switch(t){case s.ISOLATE_TRANSLUCENT:case s.ISOLATE_TRANSLUCENT_OTHERS:case s.ISOLATE_CONDITION_TRANSLUCENT_OTHERS:i=this.getIsolateMaterial().name;break;case s.CONDITION_TRANSLUCENT_OTHERS:case s.TRANSLUCENT:case s.TRANSLUCENT_OTHERS:i="scene";break;case s.FROZENFILTER:case s.FROZENCONDITIONFILTER:break;case s.OVERRIDEFILTER:case s.USER_OVERRIDE:case s.CONDITION_OVERRIDE:var r=m[t].getMatchItem(e);i=r.hasOwnProperty("color")?g.getMaterialNameByColor(r.color):r.material?r.material:r}return i},this._getMaterialByName=function(e){return"isolate"==e?g.getIsolateMaterial():"frozen"==e||"scene"==e?g.getFrozonMaterial():"selected"==e?g.getSelectedMaterial():g.get(e)},this._hasHighPriorityOverrideMaterial=function(e){return this.getSceneState()===a.TRANSLUCENT||d.apply(e)},this._hasOverrideMaterial=function(e){return this.getSceneState()===a.TRANSLUCENT||d.apply(e)||l.apply(e)},this._isHiddenFileId=function(e){return c.apply(e)},this._hasHiddenFileIdFilter=function(){return!c.isEmpty()},this._hasVisibleFilter=function(){return this.getSceneState()===a.HIDDEN||!o.isEmpty()},this._hasSelectableFilter=function(){return this.getSceneState()===a.TRANSLUCENT||!h.isEmpty()},this._hasOverrideMaterialFilter=function(){return this.getSceneState()===a.TRANSLUCENT||!l.isEmpty()},this._hasLowPriorityOverride=function(){return l.hasFilterNotIn(d)},this._isRenderPromotion=function(e){return u.apply(e)},this._hasRenderPromotionFilter=function(){return!u.isEmpty()},this._isRenderWithBoardline=function(e){return p.apply(e)},this._hasRenderWithBoardlineFilter=function(){return!p.isEmpty()},this.addInstanceMaterialForClip=function(e,t){g.addInstanceMaterialForClip(e,t)},this.clearInstanceMaterialsForClip=function(){g.clearInstanceMaterialsForClip()},this.getAllInstanceMaterialsForClip=function(){return g.getAllInstanceMaterialsForClip()},this.addMaterialForClip=function(e){g.addMaterialForClip(e)},this.getMaterialForClipBy=function(e,t){return g.getMaterialForClipBy(e,t)},this.getAllMaterialsForClip=function(){return g.getAllMaterialsForClip()},this.clearMaterialsForClip=function(){g.clearMaterialsForClip()},this.getMaterialForModifyOpacityBy=function(e,t){return g.getMaterialForModifyOpacityBy(e,t)},this.clearMaterialsForModifyOpacity=function(){g.clearMaterialsForModifyOpacity()},this.getMaterialNameBy=function(e){return g.getMaterialNameBy(e)},this.setWireFrameVisibilityCondition=function(e){e.condition&&e.condition.ids&&(e.userIdMap={},e.condition.ids.map((t=>{e.userIdMap[t]=!0})),delete e.condition.ids),e.condition&&e.condition.objectData&&(e.objectData=e.condition.objectData,delete e.condition.objectData),e.condition&&void 0!==e.condition.all&&(e.all=e.condition.all,delete e.condition.all),delete e.condition,v=e},this.getWireFrameVisibilityCondition=function(){return v},this._isRenderWithWireFrame=function(e){const t=v.isVisible;if(!0===v.all)return t;if(!1===v.all)return!t;if(!v.userIdMap&&!v.objectData)return t;if(v.userIdMap&&!0===v.userIdMap[e.userId])return t;const i=e.userData,r=v.objectData;return i&&r?((e,t,i)=>{let r;const a=e.length;for(let s=0;s<a;++s){r=!0;var n=e[s];for(const e in n){if(!(n[e]instanceof Array)&&t[e]!==n[e]){r=!1;break}if(n[e]instanceof Array&&-1==n[e].indexOf(t[e])){r=!1;break}}if(r)return i}return!i})(r,i,t):!t}},r.BasicFilter=function(e,t){this._type=e,this._name=t,this._enabled=!1,this._items={},this._relatedCompoundFilterList=[]},r.BasicFilter.prototype.getType=function(){return this._type},r.BasicFilter.prototype.getName=function(){return this._name},r.BasicFilter.prototype.get=function(){return this._items},r.BasicFilter.prototype.getAll=function(){return this._items},r.BasicFilter.prototype.clearAll=function(){var e=this;e._items={},e._enabled&&(e._enabled=!1,e.enableStateChanged())},r.BasicFilter.prototype.clear=function(){this.clearAll()},r.BasicFilter.prototype.isEmpty=function(){return!this._enabled},r.BasicFilter.prototype.forceEnable=function(){this._enabled||(this._enabled=!0,this.enableStateChanged())},r.BasicFilter.prototype.setByData=function(e){var t=this;!function(e){if(null==e)return!0;if("object"!=typeof e)return!0;for(var t in e)if(e.hasOwnProperty(t))return!1;return!0}(e)?(t._items=e,t._enabled||(t._enabled=!0,t.enableStateChanged())):(t._items={},t._enabled&&(t._enabled=!1,t.enableStateChanged()))},r.BasicFilter.prototype.match=function(e){return!1},r.BasicFilter.prototype.registerToCompoundFilter=function(e){this._relatedCompoundFilterList.push(e)},r.BasicFilter.prototype.enableStateChanged=function(){for(var e=this,t=0,i=e._relatedCompoundFilterList.length;t<i;t++)e._enabled?e._relatedCompoundFilterList[t].addBaseFilter(e):e._relatedCompoundFilterList[t].removeBaseFilter(e)},r.BasicIdFilter=function(e,t){r.BasicFilter.call(this,e,t)},r.BasicIdFilter.prototype=Object.create(r.BasicFilter.prototype),r.BasicIdFilter.prototype.constructor=r.BasicIdFilter,r.BasicIdFilter.prototype.add=function(e){var t=this,i=t._items;if(e&&e.length>0){for(var r=0,a=e.length;r<a;++r)i[e[r]]=!0;t._enabled||(t._enabled=!0,t.enableStateChanged())}},r.BasicIdFilter.prototype.remove=function(e){var t=this,i=t._items;if(e&&e.length>0){for(var r=0,a=e.length;r<a;++r){var n=e[r];i.hasOwnProperty(n)&&delete i[n]}0===i.length&&t._enabled&&(t._enabled=!1,t.enableStateChanged())}},r.ListFilter=function(e,t){r.BasicFilter.call(this,e,t)},r.ListFilter.prototype=Object.create(r.BasicFilter.prototype),r.ListFilter.prototype.constructor=r.ListFilter,r.ListFilter.prototype.remove=function(e,t){var i=this,a=i._items[e];if(a&&t&&t.length>0){for(var n=0,s=t.length;n<s;++n){var o=t[n];a.hasOwnProperty(o)&&delete a[o]}r.Utils.isEmptyObject(i._items)&&i._enabled&&(i._enabled=!1,i.enableStateChanged())}},r.ListFilter.prototype.add=function(e,t,i){var r=this,a=r._items,n=a[e];if(t&&t.length>0){void 0===i&&(i=!0),n||(n=a[e]={});for(var s=0,o=t.length;s<o;++s)n[t[s]]=i;r._enabled||(r._enabled=!0,r.enableStateChanged())}},r.ListFilter.prototype.clear=function(e){var t=this,i=t._items;i.hasOwnProperty(e)&&(delete i[e],r.Utils.isEmptyObject(i)&&t._enabled&&(t._enabled=!1,t.enableStateChanged()))},r.UserListFilter=function(e,t){r.BasicFilter.call(this,e,t)},r.UserListFilter.prototype=Object.create(r.ListFilter.prototype),r.UserListFilter.prototype.constructor=r.UserListFilter,r.UserListFilter.prototype.match=function(e){return null!==this.getMatchItem(e)},r.UserListFilter.prototype.getMatchItem=function(e){var t=this._items,i=e.userData;if(i)for(var r in t){var a=t[r],n=i[r];if(n&&void 0!==a[n])return a[n]}return null},r.OverrideListFilter=function(e,t){r.BasicFilter.call(this,e,t)},r.OverrideListFilter.prototype=Object.create(r.ListFilter.prototype),r.OverrideListFilter.prototype.constructor=r.OverrideListFilter,r.OverrideListFilter.prototype.match=function(e){return null!==this.getMatchItem(e)},r.OverrideListFilter.prototype.getMatchItem=function(e){var t=this._items,i=e.name;for(var r in t){var a=t[r];if(a[i])return a[i]}return null},r.ConditionFilter=function(e,t){r.BasicFilter.call(this,e,t)},r.ConditionFilter.prototype=Object.create(r.BasicFilter.prototype),r.ConditionFilter.prototype.constructor=r.ConditionFilter,r.ConditionFilter.prototype.match=function(e){var t=e.userData;return!!t&&function(e,t){for(var i,r=0,a=e.length;r<a;++r){i=!0;var n=e[r];for(var s in n){if(!(n[s]instanceof Array)&&t[s]!=n[s]){i=!1;break}if(n[s]instanceof Array&&-1==n[s].indexOf(t[s])){i=!1;break}}if(i)return!0}return!1}(this._items,t)},r.MultiConditionFilter=function(e,t){r.BasicFilter.call(this,e,t)},r.MultiConditionFilter.prototype=Object.create(r.BasicFilter.prototype),r.MultiConditionFilter.prototype.constructor=r.MultiConditionFilter,r.MultiConditionFilter.prototype.match=function(e){return null!==this.getMatchItem(e)},r.MultiConditionFilter.prototype.getMatchItem=function(e){var t,i=this._items,r=e.userData;if(r)for(var a=i.length,n=0;n<a;++n){var s=i[n],o=s.condition;for(var l in t=!0,o)if(o[l]!=r[l]){t=!1;break}if(t)return s}return null},r.FileIdFilter=function(e,t){r.BasicIdFilter.call(this,e,t)},r.FileIdFilter.prototype=Object.create(r.BasicIdFilter.prototype),r.FileIdFilter.prototype.constructor=r.FileIdFilter,r.FileIdFilter.prototype.match=function(e){var t=e.name;if(t){var i=t.indexOf(".");if(-1!==i){var r=t.substring(0,i);return!!this._items[r]}}var a=e.userData;if(a&&(r=a.sceneId))return!!this._items[r];return!1},r.GeneralIdFilter=function(e,t){r.BasicIdFilter.call(this,e,t)},r.GeneralIdFilter.prototype=Object.create(r.BasicIdFilter.prototype),r.GeneralIdFilter.prototype.constructor=r.GeneralIdFilter,r.GeneralIdFilter.prototype.match=function(e){return!!this._items[e.name]},r.FilterResultMode={MATCH_RETURN_TRUE:0,MATCH_RETURN_FALSE:1,NOMATCH_RETURN_TRUE:2,NOMATCH_RETURN_FALSE:3},r.CompoundFilter=function(e){this._activeFilterList=[],this._filterResultModes={},this._defaultRetValue=e,this._filterPriority=null},r.CompoundFilter.prototype.setFilterMode=function(e){this._filterResultModes=e},r.CompoundFilter.prototype.setFilterPriority=function(e){this._filterPriority=e},r.CompoundFilter.prototype.addBaseFilter=function(e){var t=this._activeFilterList,i=t.indexOf(e);if(null===this._filterPriority)-1===i?t.push(e):i!==t.length-1&&(t.splice(i,1),t.push(e));else if(0===t.length)t.push(e);else{-1!==i&&i!==t.length-1&&t.splice(i,1);for(var r=this._filterPriority[e.getType()],a=0,n=t.length;a<n;a++)if(this._filterPriority[t[a].getType()]>r){t.splice(a,0,e);break}a===n&&t.push(e)}},r.CompoundFilter.prototype.removeBaseFilter=function(e){var t=this._activeFilterList.indexOf(e);-1!==t&&this._activeFilterList.splice(t,1)},r.CompoundFilter.prototype.isEmpty=function(){return 0===this._activeFilterList.length},r.CompoundFilter.prototype.hasFilterNotIn=function(e){for(var t=this._activeFilterList,i=t.length-1;i>=0;i--){var r=t[i];if(void 0===e._filterResultModes[r.getType()])return!0}return!1},r.CompoundFilter.prototype.apply=function(e){for(var t,i=this,a=r.FilterResultMode,n=i._activeFilterList.length-1;n>=0;n--)switch(t=i._activeFilterList[n],i._filterResultModes[t.getType()]){case a.MATCH_RETURN_TRUE:if(t.match(e))return!0;break;case a.MATCH_RETURN_FALSE:if(t.match(e))return!1;break;case a.NOMATCH_RETURN_TRUE:if(!t.match(e))return!0;break;case a.NOMATCH_RETURN_FALSE:if(!t.match(e))return!1}return i._defaultRetValue},r.CompoundFilter.prototype.getApplyFilterId=function(e){for(var t,i=this,a=r.FilterResultMode,n=i._activeFilterList.length-1;n>=0;n--)switch(t=i._activeFilterList[n],i._filterResultModes[t.getType()]){case a.MATCH_RETURN_TRUE:case a.MATCH_RETURN_FALSE:if(t.match(e))return t.getType();break;case a.NOMATCH_RETURN_TRUE:case a.NOMATCH_RETURN_FALSE:if(!t.match(e))return t.getType()}return-1},r.FilterAction=function(){this.className="FilterAction"},r.FilterAction.prototype.getClassName=function(){return this.className},r.FilterAction.prototype.applyFilter=function(e){},r.IdsFilterAction=function(){r.FilterAction.call(this),this.className="IdsFilterAction",this.ids=[]},r.IdsFilterAction.prototype=Object.create(r.FilterAction.prototype),r.IdsFilterAction.prototype.arrayToMap=function(e){for(var t={},i=0;i<e.length;i++){var r=e[i];t[r]=r}return t},r.IdsFilterAction.prototype.constructor=r.IdsFilterAction,r.VisibleIdsFA=function(e,t){r.IdsFilterAction.call(this),this.className="VisibleIdsFA",this.flag=e,this.isVisible=t},r.IdsFilterAction.prototype.setIds=function(e){this.ids=e},r.VisibleIdsFA.prototype=Object.create(r.IdsFilterAction.prototype),r.VisibleIdsFA.prototype.constructor=r.VisibleIdsFA,r.VisibleIdsFA.prototype.applyFilter=function(e){this.ids instanceof Array?(e.setVisible(this.ids,this.isVisible,this.flag),e.calculateVisibleComponentsBbox()):console.warn("Ids should be type of array.")},r.OverrideIdsFA=function(e,t){r.IdsFilterAction.call(this),this.className="OverrideIdsFA",this.flag=e,this.material=t},r.OverrideIdsFA.prototype=Object.create(r.IdsFilterAction.prototype),r.OverrideIdsFA.prototype.constructor=r.OverrideIdsFA,r.OverrideIdsFA.prototype.applyFilter=function(e){this.ids instanceof Array?e.setMaterial(this.ids,this.material,this.flag):console.warn("Ids should be type of array.")},r.OverrideIdsFA.prototype.applyFilterWithIds=function(e,t){t instanceof Array?e.setMaterial(t,this.material,this.flag):console.warn("Ids should be type of array.")},r.OverrideIdsForWireFrameFA=function(e,t){r.IdsFilterAction.call(this),this.className="OverrideIdsForWireFrameFA",this.flag=e,this.material=t},r.OverrideIdsForWireFrameFA.prototype=Object.create(r.IdsFilterAction.prototype),r.OverrideIdsForWireFrameFA.prototype.constructor=r.OverrideIdsForWireFrameFA,r.OverrideIdsForWireFrameFA.prototype.applyFilter=function(e){this.ids instanceof Array?e.setWireFrameMaterial(this.ids,this.material,this.flag):console.warn("Ids should be type of array.")},r.OverrideIdsForWireFrameFA.prototype.applyFilterWithIds=function(e,t){t instanceof Array?e.setWireFrameMaterial(t,this.material,this.flag):console.warn("Ids should be type of array.")},r.IsolateIdsFA=function(e){r.IdsFilterAction.call(this),this.className="IsolateIdsFA",this.isolateHide=e},r.IsolateIdsFA.prototype=Object.create(r.IdsFilterAction.prototype),r.IsolateIdsFA.prototype.constructor=r.IsolateIdsFA,r.IsolateIdsFA.prototype.applyFilter=function(e){this.ids instanceof Array?(e.clearIsolates(),this.isolateHide?(e.setIsolateHide(this.ids,!0,!1),e.calculateVisibleComponentsBbox()):e.setIsolateTransparent(this.ids,!0,!1)):console.warn("Ids should be type of array.")},r.TransparentIdsFA=function(e,t){r.IdsFilterAction.call(this),this.className="TransparentIdsFA",this.flag=e,this.isOpaque=t},r.TransparentIdsFA.prototype=Object.create(r.IdsFilterAction.prototype),r.TransparentIdsFA.prototype.constructor=r.TransparentIdsFA,r.TransparentIdsFA.prototype.applyFilter=function(e){this.ids instanceof Array?e.setTransparent(this.ids,!this.isOpaque,this.flag):console.warn("Ids should be type of array.")},r.ConditionFilterAction=function(){r.FilterAction.call(this),this.className="ConditionFilterAction",this.conditions=null},r.ConditionFilterAction.prototype=Object.create(r.FilterAction.prototype),r.ConditionFilterAction.prototype.constructor=r.ConditionFilterAction,r.VisibleConditionFA=function(e,t){r.ConditionFilterAction.call(this),this.className="VisibleConditionFA",this.flag=e,this.isVisible=t},r.VisibleConditionFA.prototype=Object.create(r.ConditionFilterAction.prototype),r.VisibleConditionFA.prototype.constructor=r.VisibleConditionFA,r.VisibleConditionFA.prototype.applyFilter=function(e){var t=this;this.conditions instanceof Array?(e.matchConditions(this.conditions,(function(i,r){t.flag==r&&(e.setVisible(i,t.isVisible),i=null)})),e.calculateVisibleComponentsBbox()):console.warn("Conditions should be type of array.")},r.OverrideConditionFA=function(e,t){r.ConditionFilterAction.call(this),this.className="OverrideConditionFA",this.flag=e,this.material=t},r.OverrideConditionFA.prototype=Object.create(r.ConditionFilterAction.prototype),r.OverrideConditionFA.prototype.constructor=r.OverrideConditionFA,r.OverrideConditionFA.prototype.applyFilter=function(e,t){var i=this;this.conditions instanceof Array?e.matchConditions(this.conditions,(function(t,r){i.flag==r&&(e.setMaterial(t,i.material),t=null)})):console.warn("Conditions should be type of array.")},r.OverrideConditionFA.prototype.setOpacity=function(e){this.opacity=e},r.OverrideConditionFA.prototype.applyFilterByMaterials=function(e,t){var i=this;this.conditions instanceof Array?e.matchConditions(this.conditions,(function(r,a){i.flag==a&&(e.setOpacity(r,t),r=null)})):console.warn("Conditions should be type of array.")},r.OverrideConditionForWireFrameFA=function(e,t){r.ConditionFilterAction.call(this),this.className="OverrideConditionForWireFrameFA",this.flag=e,this.material=t},r.OverrideConditionForWireFrameFA.prototype=Object.create(r.ConditionFilterAction.prototype),r.OverrideConditionForWireFrameFA.prototype.constructor=r.OverrideConditionForWireFrameFA,r.OverrideConditionForWireFrameFA.prototype.applyFilter=function(e,t){var i=this;this.conditions instanceof Array?e.matchConditions(this.conditions,(function(t,r){i.flag==r&&(e.setWireFrameMaterial(t,i.material),t=null)})):console.warn("Conditions should be type of array.")},r.TransparentConditionFA=function(e,t){r.ConditionFilterAction.call(this),this.className="TransparentConditionFA",this.flag=e,this.isOpaque=t},r.TransparentConditionFA.prototype=Object.create(r.ConditionFilterAction.prototype),r.TransparentConditionFA.prototype.constructor=r.TransparentConditionFA,r.TransparentConditionFA.prototype.applyFilter=function(e){var t=this;this.conditions instanceof Array?e.matchConditions(this.conditions,(function(i,r){t.flag==r&&(e.setTransparent(i,!t.isOpaque),i=null)})):console.warn("Conditions should be type of array.")},r.IsolateConditionFA=function(e){r.ConditionFilterAction.call(this),this.className="IsolateConditionFA",this.isolateHide=e},r.IsolateConditionFA.prototype=Object.create(r.ConditionFilterAction.prototype),r.IsolateConditionFA.prototype.constructor=r.IsolateConditionFA,r.IsolateConditionFA.prototype.applyFilter=function(e){e.clearIsolates();var t=this.isolateHide;this.conditions instanceof Array?e.matchConditions(this.conditions,(function(i,r){1!=r?(t?(e.setIsolateHide(i,!r),e.calculateVisibleComponentsBbox()):e.setIsolateTransparent(i,!r),i=null):i=null})):console.warn("Conditions should be type of array.")},r.EnumObjectState={Visible:1,HideByIsolate:2,Transparent:4,TransparentByIsolate:8},r.ObjectInfo={userData:null,state:r.EnumObjectState.Visible,material:null},r.ObjectInfoDict=function(){var e={},t={};this.init=function(i){for(var r in e=i)t.hasOwnProperty(r)||void 0===e[r]||(t[r]=Object.keys(e[r]))},this.reinit=function(i){for(var r in e=i)t[r]=Object.keys(i[r])},this.clear=function(){e={},t={}},this.getObjectsMap=function(){return e},this.getObjectIds=function(e){return t.hasOwnProperty(e)?t[e]:[]}},r.ObjectInfoManager=function(){var e=new r.ObjectInfoDict,t=!1,i=!1,a=!1,n=!1,s=!1,o=!1,l=new THREE.Box3,d=!1;this.inactivatedIdMap={},this.inactivatedIds=[],this.bIsInactivateAll=!1,this.localClippingList={},this.hasLocalClipping=!1,this.modifyOpacityList={},this.hasModifyOpacityList=!1,this.init=function(t){e.init(t)},this.reinit=function(t){e.reinit(t)},this.clearData=function(){e.clear()},this.getObjectsMap=function(){return e.getObjectsMap()},this.calculateVisibleComponentsBbox=function(){l.makeEmpty();var t=e.getObjectsMap();for(var i in t)for(var r=t[i],a=e.getObjectIds(i),n=0,s=a.length;n<s;n++){var o=a[n];this.isHidden(o)||r[o].map((e=>{const t=e.boundingBox;t&&!t.isEmpty()?(l.expandByPoint(t.min),l.expandByPoint(t.max)):console.warn("Object has no boundingBox, id is "+o)}))}d=!1},this.getVisibleComponentsBbox=function(){return(d||l.isEmpty())&&this.calculateVisibleComponentsBbox(),l.clone()},this.needUpdateBoxAfterExplode=function(){d=!0},this.arrayToMap=function(e){for(var t={},i=0;i<e.length;i++){var r=e[i];t[r]=r}return t},this.isMatchConditions=function(e,t){for(var i=!0,r=0,a=t.length;r<a;r++){var n=t[r];for(var s in n){if(!(n[s]instanceof Array)&&e[s]!=n[s]){i=!1;break}if(n[s]instanceof Array&&-1==n[s].indexOf(e[s])){i=!1;break}}if(1==i)break;r<t.length-1&&(i=!0)}return i},this.matchConditions=function(t,i,r,a){var n=e.getObjectsMap();for(var s in n){for(var o=[],l=[],d=n[s],h=e.getObjectIds(s),c=0,u=h.length;c<u;c++){var p=h[c],m=d[p][0].userData||{};m.elementId=d[p][0].userId,this.isMatchConditions(m,t)?o.push(p):l.push(p)}r&&a?(i&&i(r,a,o,!0),i&&i(r,a,l,!1)):(i&&i(o,!0),i&&i(l,!1))}},this.getMatchIds=function(t){var i=e.getObjectsMap(),r=[];for(var a in i)for(var n=i[a],s=e.getObjectIds(a),o=0,l=s.length;o<l;o++){var d=s[o],h=n[d][0].userData||{};h.elementId=n[d][0].userId,1==this.isMatchConditions(h,t)&&r.push(d)}return r},this.setVisible=function(t,i,n){var s=function(e){i?e.state=e.state|r.EnumObjectState.Visible:(a=!0,e.state=e.state&~r.EnumObjectState.Visible)},o=e.getObjectsMap();for(var l in o){var d=o[l];if(null==n||!0===n)for(var h=0,c=t.length;h<c;h++){var u=t[h];if(d.hasOwnProperty(u)){var p=d[u][0];s(p)}}else{for(var m=this.arrayToMap(t),f=e.getObjectIds(l),g=0,v=f.length;g<v;g++){u=f[g];m.hasOwnProperty(u)||s(p=d[u][0])}m=null}}},this.isVisible=function(t){var i=e.getObjectsMap();for(var a in i){var n=i[a];if(n.hasOwnProperty(t))return n[t][0].state&r.EnumObjectState.Visible>0}},this.clearVisible=function(){var t=e.getObjectsMap();for(var i in a=!1,t)for(var n=t[i],s=e.getObjectIds(i),o=0,l=s.length;o<l;o++){var d=n[s[o]][0];d.state=d.state|r.EnumObjectState.Visible}},this.hideAll=function(){var t=e.getObjectsMap();for(var i in a=!0,t)for(var n=t[i],s=e.getObjectIds(i),o=0,l=s.length;o<l;o++){var d=n[s[o]][0];d.state=d.state&~r.EnumObjectState.Visible}},this.setTransparent=function(i,a,n){var o=function(e){a?(e.state=e.state|r.EnumObjectState.Transparent,t=!0,s=!0):e.state=e.state&~r.EnumObjectState.Transparent},l=e.getObjectsMap();for(var d in l){var h=l[d];if(null==n||!0===n)for(var c=0,u=i.length;c<u;c++){var p=i[c];if(this.isActive(p)&&h.hasOwnProperty(p)){var m=h[p][0];o(m)}}else{for(var f=this.arrayToMap(i),g=e.getObjectIds(d),v=0,y=g.length;v<y;v++){p=g[v];this.isActive(p)&&!f.hasOwnProperty(p)&&o(m=h[p][0])}f=null}}},this.isTransparent=function(t){var i=e.getObjectsMap();for(var a in i){var n=i[a];if(n.hasOwnProperty(t)){var s=n[t][0],o=(s.state&r.EnumObjectState.Transparent)>0;return o=o||(s.state&r.EnumObjectState.TransparentByIsolate)>0}}},this.clearTransparent=function(){var t=e.getObjectsMap();for(var i in s=!1,t)for(var a=t[i],n=e.getObjectIds(i),o=0,l=n.length;o<l;o++){var d=n[o];if(this.isActive(d)){var h=a[d][0];h.state=h.state&~r.EnumObjectState.Transparent}}},this.setOpacity=function(i,r,a){var n=e.getObjectsMap();for(var s in n){var o=n[s];if(null==a||!0===a)for(var l=0,d=i.length;l<d;l++){var h=i[l],c=r[l];if(this.isActive(h)&&o.hasOwnProperty(h))o[h][0].material=c,t=!0}}},this.setMaterial=function(i,r,a){var n=e.getObjectsMap();for(var s in n){var o=n[s];if(null==a||!0===a)for(var l=0,d=i.length;l<d;l++){var h=i[l];if(this.isActive(h)&&o.hasOwnProperty(h)){var c=o[h][0];c.material=r,t=!0}}else{for(var u=this.arrayToMap(i),p=e.getObjectIds(s),m=0,f=p.length;m<f;m++){h=p[m];this.isActive(h)&&!u.hasOwnProperty(h)&&((c=o[h][0]).material=r,t=!0)}u=null}}},this.getMaterial=function(t){var i=e.getObjectsMap();for(var r in i){var a=i[r];if(a.hasOwnProperty(t))return a[t][0].material}},this.clearMaterial=function(){var t=e.getObjectsMap();for(var i in t){var r=t[i];for(var a in r)this.isActive(a)&&(r[a][0].material=null)}},this.setWireFrameMaterial=function(t,r,a){var n=e.getObjectsMap();for(var s in n){var o=n[s];if(null==a||!0===a)for(var l=0,d=t.length;l<d;l++){var h=t[l];if(o.hasOwnProperty(h)){var c=o[h][0];c.wireFrameMaterial=r,i=!0}}else{for(var u=this.arrayToMap(t),p=e.getObjectIds(s),m=0,f=p.length;m<f;m++){h=p[m];u.hasOwnProperty(h)||((c=o[h][0]).wireFrameMaterial=r,i=!0)}u=null}}},this.getWireFrameMaterial=function(t){var i=e.getObjectsMap();for(var r in i){var a=i[r];if(a.hasOwnProperty(t))return a[t][0].wireFrameMaterial}},this.clearWireFrameMaterial=function(){var t=e.getObjectsMap();for(var i in t){var r=t[i];for(var a in r)r[a][0].wireFrameMaterial=null}},this.setIsolateHide=function(t,i,a){var s=function(e){i?(n=!0,e.state=e.state|r.EnumObjectState.HideByIsolate):e.state=e.state&~r.EnumObjectState.HideByIsolate},o=e.getObjectsMap();for(var l in o){var d=o[l];if(null==a||!0===a)for(var h=0,c=t.length;h<c;h++){var u=t[h];if(d.hasOwnProperty(u)){var p=d[u][0];s(p)}}else{for(var m=this.arrayToMap(t),f=e.getObjectIds(l),g=0,v=f.length;g<v;g++){u=f[g];m.hasOwnProperty(u)||s(p=d[u][0])}m=null}}},this.isIsolateHide=function(t){var i=e.getObjectsMap();for(var a in i){return(i[a][t][0].state&r.EnumObjectState.HideByIsolate)>0}},this.setIsolateTransparent=function(i,a,n){var s=function(e){a?(e.state=e.state|r.EnumObjectState.TransparentByIsolate,t=!0,o=!0):e.state=e.state&~r.EnumObjectState.TransparentByIsolate},l=e.getObjectsMap();for(var d in l){var h=l[d];if(null==n||!0===n)for(var c=0,u=i.length;c<u;c++){var p=i[c];if(this.isActive(p)&&h.hasOwnProperty(p)){var m=h[p][0];s(m)}}else{for(var f=this.arrayToMap(i),g=e.getObjectIds(d),v=0,y=g.length;v<y;v++){p=g[v];this.isActive(p)&&!f.hasOwnProperty(p)&&s(m=h[p][0])}f=null}}},this.isIsolateTransparent=function(t){var i=e.getObjectsMap();for(var a in i){var n=i[a];if(n.hasOwnProperty(t))return(n[t][0].state&r.EnumObjectState.TransparentByIsolate)>0}},this.clearIsolateHide=function(){var t=e.getObjectsMap();for(var i in n=!1,t){var r=e.getObjectIds(i);r.length>0&&this.setIsolateHide(r,!1)}},this.clearIsolates=function(){var t=e.getObjectsMap();for(var i in o=!1,n=!1,t){var r=e.getObjectIds(i);r.length>0&&(this.setIsolateHide(r,!1),this.setIsolateTransparent(r,!1))}},this.clearTransparentByIsolate=function(){var t=e.getObjectsMap();for(var i in o=!1,t)for(var a=t[i],n=e.getObjectIds(i),s=0,l=n.length;s<l;s++){var d=n[s];if(this.isActive(d)){var h=a[d][0];h.state=h.state&~r.EnumObjectState.TransparentByIsolate}}},this.isHidden=function(t){var i=e.getObjectsMap();for(var a in i){var n=i[a];if(n&&n.hasOwnProperty(t)){var s=n[t][0],o=0==(s.state&r.EnumObjectState.Visible);return o=o||(s.state&r.EnumObjectState.HideByIsolate)>0}}},this.isFrozen=function(t){var i=e.getObjectsMap();for(var a in i){var n=i[a];if(n.hasOwnProperty(t)){var s=n[t][0],o=(s.state&r.EnumObjectState.Transparent)>0;return o=o||(s.state&r.EnumObjectState.TransparentByIsolate)>0}}},this.resetAll=function(){var i=e.getObjectsMap();for(var l in i)for(var d=i[l],h=e.getObjectIds(l),c=0,u=h.length;c<u;c++){var p=h[c];d[p][0].state|=r.EnumObjectState.Visible,this.isActive(p)&&(d[p][0].material=null)}t=!1,a=n=!1,s=o=!1},this.hasOverrideMaterial=function(i){var r=e.getObjectsMap();if(null==i)return t;for(var a in r){var n=r[a];if(n.hasOwnProperty(i))return null!=n[i][0].material||this.isTransparent(i)}},this.hasOverrideMaterialForWireFrame=function(t){var r=e.getObjectsMap();if(null==t)return i;for(var a in r){var n=r[a];if(n.hasOwnProperty(t))return null!=n[t][0].wireFrameMaterial}},this.hasObjectInactivated=function(){return this.inactivatedIds.length>0},this.hasObjectHidden=function(){return a||n},this.hasObjectCantSelected=function(){return this.hasObjectHidden()||this.hasObjectTransparent()||this.hasObjectInactivated()},this.hasObjectTransparent=function(){if(this.hasObjectInactivated()){var e=!1;for(const t of this.inactivatedIds)if(this.isTransparent(t)){e=!0;break}return e}return s||o},this.deactivateByIds=function(e){for(const t of e)this.inactivatedIdMap[t]=!0;this.inactivatedIds=Object.keys(this.inactivatedIdMap)},this.clearInactivatedIdMap=function(){this.inactivatedIdMap={},this.inactivatedIds=[]},this.isActive=function(e){return 0==this.bIsInactivateAll&&!(1==this.inactivatedIdMap[e])},this.deactivateAll=function(){this.bIsInactivateAll=!0},this.activateAll=function(){this.bIsInactivateAll=!1},this.getInactivatedIdMap=function(){return this.inactivatedIdMap},this.addToModifyOpacityList=function(e,t){var i=this.modifyOpacityList;void 0===i[e]&&(i[e]={}),i[e].opacity=t,this.hasModifyOpacityList=!0},this.removeModifyOpacityList=function(e){let t=this.modifyOpacityList;e.map((e=>{delete t[e]})),0===Object.keys(t)&&(this.hasModifyOpacityList=!1)},this.clearModifyOpacityList=function(){this.modifyOpacityList={},this.hasModifyOpacityList=!1},this.addToLocalClippingList=function(e,t,i,a){var n=this.localClippingList;void 0===n[e]&&(n[e]={}),r.Utils.isDefined(a)&&(null==n[e].nodeMap&&(n[e].nodeMap=new Map),n[e].nodeMap.set(a.toString(),t)),i&&(n[e].wireframeMaterialName=i),this.hasLocalClipping=!0},this.clearLocalClippingList=function(){this.localClippingList={},this.hasLocalClipping=!1},this.activeLocalClipping=function(){this.hasLocalClipping=!0}},r.FilterManagerIO=function(e){this.materialSelector=e;var t=function(e){var t=[];for(var i in e)1==e[i]&&t.push(i);return t};this.saveState=function(e){const t=e.getIsolateFilterAction(),i=e.getFilterActionList(),r=JSON.parse(JSON.stringify(t)),a=JSON.parse(JSON.stringify(i));((t,i)=>{if(!e._parseIndexIds)return;t&&t.ids&&t.ids.length>0&&(r.ids=e._parseIndexIds(t.ids));const n=i.length;for(let t=0;t<n;++t){if(!(i[t].ids&&i[t].ids.length>0))return;a[t].ids=e._parseIndexIds(i[t].ids)}})(t,i),(e=>{const t=e.length;for(let i=0;i<t;++i){if(!(e[i].ids&&e[i].ids.length>0))return;a[i].material=e[i].material}})(i);return{isolateAction:r,actions:a,sceneState:e.getSceneState(),version:"1.0"}},this.createAction=function(e){var t=e.className,i=null;switch(t){case"IsolateIdsFA":(i=new r.IsolateIdsFA(e.isolateHide)).ids=e.ids;break;case"VisibleIdsFA":(i=new r.VisibleIdsFA(e.flag,e.isVisible)).ids=e.ids;break;case"OverrideIdsFA":case"OverrideIdsForWireFrameFA":if(s=e.material){var a={color:s.color};s.hasOwnProperty("opacity")&&(a.opacity=s.opacity);var n=this.materialSelector.getMaterialNameByColor(a);s=this.materialSelector.get(n)}(i="OverrideIdsFA"===t?new r.OverrideIdsFA(e.flag,s):new r.OverrideIdsForWireFrameFA(e.flag,s)).ids=e.ids;break;case"TransparentIdsFA":(i=new r.TransparentIdsFA(e.flag,e.isOpaque)).ids=e.ids;break;case"VisibleConditionFA":(i=new r.VisibleConditionFA(e.flag,e.isVisible)).conditions=e.conditions;break;case"OverrideConditionFA":case"OverrideConditionForWireFrameFA":var s;if(s=e.material){a={opacity:s.opacity,color:s.color},n=this.materialSelector.getMaterialNameByColor(a);s=this.materialSelector.get(n)}(i="OverrideConditionFA"===t?new r.OverrideConditionFA(e.flag,s):new r.OverrideConditionForWireFrameFA(e.flag,s)).conditions=e.conditions;break;case"TransparentConditionFA":(i=new r.TransparentConditionFA(e.flag,e.isOpaque)).conditions=e.conditions;break;case"IsolateConditionFA":(i=new r.IsolateConditionFA(e.isolateHide)).conditions=e.conditions;break;default:r.Logger.warn("Warning: Not supported filterAction '"+t+"'")}return i},this.createActionByOldFilter=function(e,i){var a=[];switch(e){case"CONDITION_OVERRIDE":for(var n=[],s=0;s<i.length;s++){var o=i[s];n.push(o.condition)}var l=o.color,d=this.materialSelector.add(l),h=this.materialSelector.get(d);(f=new r.OverrideConditionFA(!0,h)).conditions=n,a.push(f);break;case"CONDITION_TRANSLUCENT_OTHERS":(f=new r.TransparentConditionFA(!1,!1)).conditions=i,a.push(f);break;case"ISOLATE_CONDITION_HIDEEN_OTHERS":(f=new r.IsolateConditionFA(!0)).conditions=i,a.push(f);break;case"ISOLATE_CONDITION_TRANSLUCENT_OTHERS":(f=new r.IsolateConditionFA(!1)).conditions=i,a.push(f);break;case"ISOLATE_HIDDEN_OTHERS":(f=new r.IsolateIdsFA(!0)).ids=t(i),a.push(f);break;case"ISOLATE_TRANSLUCENT_OTHERS":(f=new r.IsolateIdsFA(!1)).ids=t(i),a.push(f);break;case"OVERRIDEFILTER":for(var c in i)if(i.hasOwnProperty(c)){var u=[],p=i[c];for(var m in p)u.push(m);l=this.materialSelector.getMaterialParamsFromName(p[m]),d=this.materialSelector.add(l),h=this.materialSelector.get(d);(f=new r.OverrideIdsFA(!0,h)).ids=u,a.push(f)}break;case"TRANSLUCENT":(f=new r.TransparentIdsFA(!0,!1)).ids=t(i),a.push(f);break;case"TRANSLUCTANT_OTHERS":(f=new r.TransparentIdsFA(!1,!1)).ids=t(i),a.push(f);break;case"VISIBLE":var f;(f=new r.VisibleIdsFA(!0,!0)).ids=t(i),a.push(f);break;default:r.Logger.warn("Warning: Not supported filter '"+e+"'")}return a},this.loadState=function(e,t){t.clearFilterActionList(),t.getObjectInfoManager().resetAll();var i=e;if(i.hasOwnProperty("version"))if("1.0"==i.version){var r=i.isolateAction;if(r){var a=this.createAction(r);t.pushBack(a)}for(var n=i.actions,s=0;s<n.length;s++){a=this.createAction(n[s]);t.pushBack(a)}}else if("0.4"==i.version){for(var o={},l=t._filterImpl.getBasicFilterList(),d=(s=0,l.length);s<d;s++)o[l[s].getName()]=s;for(var h in i)if("sceneState"!==h&&"version"!==h&&o.hasOwnProperty(h)){if("{}"==JSON.stringify(i[h])||"[]"==JSON.stringify(i[h]))continue;var c=this.createActionByOldFilter(h,i[h]);for(s=0;s<c.length;s++)t.pushBack(c[s])}}t.setSceneState(i.sceneState)}},function(){class e extends r.BaseModel{constructor(e,t,i,a,n,s){super(t,i),this.viewer=e,this.unitScale=1,this.pntLoader=new r.PntLoader(5,this.unitScale),this.index=a,this.parseCfgFinish=n,this.debut=s,this.url=i.serverUrl+""+i.databagId+"/tileset.json"}destroy(){super.destroy(),this.pntLoader=null,this.parseCfgFinish=null,this.debut=null,this.viewer=null}load(e){var t=this;this.manager.chooseRendering(this.statistics.memoeryInfo),this.parseCfgFinish&&this.parseCfgFinish(),this.manager.dispatchEvent({type:r.EVENTS.ON_LOAD_START}),this.pntLoader.loadPntTotalJson(this.url,(function(e){var i=new THREE.Vector3(e[0],e[1],e[2]),r=new THREE.Vector3(e[3],e[4],e[5]),a=new THREE.Vector3(e[6],e[7],e[8]),n=new THREE.Vector3(e[9],e[10],e[11]),s=r.clone().add(a).add(n);t.getTransforms().boundingBox=new THREE.Box3(i.clone().sub(s),i.clone().add(s)),t.manager.updateScene(t)})).then((e=>{let i=t.viewer.getScene().getMatrixGlobal().clone(),a=new THREE.Matrix4;a.copy(i).invert();let n=t.viewer.getScene(),s=(new THREE.Matrix4).makeScale(t.unitScale,t.unitScale,t.unitScale);for(const t of e)t.matrix.copy(i).multiply(s),t.matrixAutoUpdate=!1,t.updateMatrixWorld(!0),n.children[0].add(t);t.viewer.addRenderCallback((function(){let e=t.viewer.domElement.offsetHeight;t.pntLoader.updatePreSse(t.viewer.camera,e),t.pntLoader.ProcessTileIndexs(t.viewer.camera,a)})),t.manager.dispatchEvent({type:r.EVENTS.ON_LOAD_COMPLETE,modelId:t.id}),t.debut(t)}))}}r.PointCloudModel=e}(),function(){class e extends r.BaseModel{constructor(e,t,i,a,n){super(t,i),this._viewer=e,this._configLoadCb=a,this._modelLoadCb=n,this._loader=new r.GeoJsonModelLoader,this._crs=null,this.features=[],this._parser=new r.GeoJsonParser(e);const s=`${i.serverUrl}${i.databagId}`;this.url=`${s}/../../../metadata/Points.json.gz`}load(e){this.manager.chooseRendering(this.statistics.memoeryInfo,!0),this._configLoadCb&&this._configLoadCb();const t=this;this._loader.loadModel(t.url).then((e=>{t._getBoundingBox(e),t._parser.parse(e,t),t.manager.dispatchEvent({type:r.EVENTS.ON_LOAD_COMPLETE,modelId:t.id}),t.debut&&t.debut(t)})).catch((()=>{console.log(`load model ${t.url} failed`)}))}getFeatureByID(e){if(r.Utils.isDefined(this.features[e]))return this.features[e]}getAllFeature(){return this.features}select(e){if(!r.Utils.isDefined(e.key))return this.getAllFeature();const t=e.key+"",i=e.value+"";let a=[];for(let e=0;e<this.features.length;++e){let r=this.features[e];r.properties[t]===i&&a.push(r)}return a}_getBoundingBox(e){const t=this._viewer;let i=new THREE.Vector3;if(r.Utils.isDefined(t.basePointPositionOnLonLat)&&r.Utils.isDefined(e.center)){const a=new THREE.Vector3;r.Projection.lonLatToGauss(new THREE.Vector2(t.basePointPositionOnLonLat[0],t.basePointPositionOnLonLat[1]),r.geoCoordinateSystem.WGS84,a,{span:3,withLineCode:!1});const n=new THREE.Vector3;r.Projection.lonLatToGauss(new THREE.Vector2(e.center[0],e.center[1]),r.geoCoordinateSystem.WGS84,n,{span:3,withLineCode:!1});const s=new THREE.Vector2;s.subVectors(n,a),i.setX(s.x),i.setY(s.y)}let a=r.Utils.box3FromSize(i,new THREE.Vector3(e.size[0],e.size[1],e.size[2]));this.getTransforms().boundingBox=a,this.manager.updateScene(this)}}r.PointModel=e}(),function(){class e extends r.PointModel{constructor(e,t,i){super(t,t,i),this.id=i.modelId,this.databagId=this.id,this._viewer=e,this.features={};const a=`${i.serverUrl}/${i.databagId}`;i.rootPath?this.url=`${a}/${i.rootPath}`:this.url=`${a}/../../../metadata/Points.json.gz`;const n=`${this.id}_${r.ObjectGroupType.GEOJSONGROUP}`;this.objectGroup=e.getScene().getOrCreateObjectGroup(n,{pickableType:r.PICKABLETYPE.Geometry,globalSpace:!0}),this.objectGroup.renderOrder=r.EnumRenderOrder.WireFrame}destroy(){this._loader=null,this._parser=null,this.features=null,this.manager.scene.removeObjectGroupByName(r.ObjectGroupType.GEOJSONGROUP),super.destroy()}setVisible(e){this.visible=e,this.objectGroup&&(this.objectGroup.visible=e)}load(e){this.manager.chooseRendering(this.statistics.memoeryInfo,!0),this._configLoadCb&&this._configLoadCb();const t=this;this._loader.loadModel(t.url).then((e=>{t._getBoundingBox(e),t._parser.parse(e,t),t.manager.dispatchEvent({type:r.EVENTS.ON_LOAD_COMPLETE,modelId:t.id}),t.debut&&t.debut(t)})).catch((()=>{console.log(`load model ${t.url} failed`)}))}addFeature(e,t){this.features[e]=t}createLineMesh(e,t){let i=null;i=!0===t.useLineWidth?new r.MeshLineMaterial({color:t.color,opacity:t.opacity,resolution:new THREE.Vector2(window.innerWidth,window.innerHeight),linewidth:t.lineWidth,sizeAttenuation:!0,depthWrite:!1,transparent:!0}):new r.LineBasicMaterial({color:t.color});for(const a in e){let n,s,o=e[a];!0===t.useLineWidth?(n=new r.MeshLineGeometry,n.setPositions(o),s=new r.MeshLine(n,i)):(n=new THREE.BufferGeometry,n.setAttribute("position",new THREE.Float32BufferAttribute(o,3)),s=new THREE.Line(n,i)),this.getFeatureByID(a).addMesh(s),this.objectGroup.add(s),s.updateMatrixWorld(!0),o.length=0}e=null}getFeatureByID(e){if(r.Utils.isDefined(this.features[e]))return this.features[e]}getAllFeature(){return this.features}select(e){if(!r.Utils.isDefined(e.key))return this.getAllFeature();const t=e.key+"",i=e.value+"";let a=[];return this.features.map((e=>{e.properties[t]===i&&a.push(e)})),a}updateMaterialByFeatureIds(e,t){const i=new r.MeshLineMaterial({color:t.color,opacity:t.opacity,resolution:new THREE.Vector2(window.innerWidth,window.innerHeight),linewidth:t.lineWidth,sizeAttenuation:!0,depthWrite:!1,transparent:!0});e.map((e=>{const t=this.getFeatureByID(e);if(!t)return;t.meshList.map((e=>{e.material=i}))}))}}r.LineModel=e}(),r.GeoJsonModelLoader=class{constructor(){this.jsonLoader=new THREE.FileLoader,this.jsonLoader.setResponseType("json")}loadModel(e){return new Promise(((t,i)=>{this.jsonLoader.load(e,(function(e){t(e)}),void 0,(function(){i()}))}))}},function(){class e{constructor(){this._geometryLngLat=null,this._geometryWorld=null,this._properties=null,this._id=null,this.type="point"}get properties(){return this._properties}set properties(e){this._properties=e}get geometry(){return this._geometryLngLat}get geometryWorld(){return this._geometryWorld}get id(){return this._id}set id(e){this._id=e}}function t(e,t,i,a){if(r.Utils.isDefined(e.geometry)){var n=e.geometry.type,o=s[n];r.Utils.isDefined(o)?o(e,t,i,a):console.log("Unknown geometry type")}}function i(e,t,i,a){!function(e,t,i,a,n){const s=new r.LineFeature;s.id=e.id,s._geometryLngLat=[];for(let e=0;e<t.length;e++){const i=t[e];let r=[];for(let e=0;e<i.length;e++){const t=i[e],a=new THREE.Vector2(t[0],t[1]);r.push(a)}s._geometryLngLat.push(r)}const o=e.properties;r.Utils.isDefined(o)&&(s.properties=o);a.addFeature(e.id,s)}(e,e.geometry.coordinates,0,i)}function a(e,t,i,a,n){const s=new r.PointFeature;s.id=e.id;new THREE.Vector2;let o=new THREE.Vector2(t[0],t[1]);s._geometryLngLat=o,s.geometry.crsFunction=i;var l=e.properties;r.Utils.isDefined(l)&&(s.properties=l),a.features.push(s)}var n={FeatureCollection:function(e,i,r,a){for(var n=e.features,s=0,o=n.length;s<o;s++)t(n[s],i,r,a)}},s={Point:function(e,t,i,r){a(e,e.geometry.coordinates,t,i,r)},MultiPoint:function(e,t,i,r){for(var n=e.geometry.coordinates,s=0;s<n.length;s++)a(e,n[s],t,i,r)},Polygon:i,MultiPolygon:function(e,t,i,a){!function(e,t,i,a,n){const s=new r.LineFeature;s.id=e.id,s._geometryLngLat=[],t.map((e=>{e.map((e=>{let t=[];e.map((e=>{const i=new THREE.Vector2(e[0],e[1]);t.push(i)})),s._geometryLngLat.push(t)}))}));const o=e.properties;r.Utils.isDefined(o)&&(s.properties=o);a.addFeature(e.id,s)}(e,e.geometry.coordinates,0,i)},LineString:i},o={"EPSG:4549":"CGCS_GAUSS_3_ZONE_40","EPSG:4326":"EPSG:4326"};r.PointFeature=e,r.LineFeature=class extends e{constructor(){super(),this.type="Line",this._meshList=[]}get meshList(){return this._meshList}addMesh(e){this._meshList.push(e)}clearMesh(){this._meshList.length=0}},r.GeoJsonParser=class{constructor(e){this._viewer=e}parse(e,t){let i=n[e.type];if(!r.Utils.isDefined(i))return void console.log("Unsupported GeoJSON object type: "+e.type);let a=e.crs,s=null;if(r.Utils.isDefined(a)){if(!r.Utils.isDefined(a.properties))return void console.log("crs.properties is undefined.");if(s=function(e){const t=e.properties;let i=null;"name"===e.type?(i=o[t.name],r.Utils.isDefined(i)||console.log(`Unknown crs name: ${t.name}`)):"EPSG"===e.type?(i=o["EPSG:"+t.code],r.Utils.isDefined(i)||console.log(`Unknown crs EPSG code: ${t.code}`)):console.log(`Unknown crs type: ${e.type}`);return i}(a),!r.Utils.isDefined(s))return void console.log("Unknown crs type")}return i(e,s,t,this._viewer),this.features}}}();r.BatchTable=class{constructor(e,t,i){void 0!==t&&console.warn("Binary batch table content not supported yet."),this.content=e,null!=i?this.batchLength=i:0===Object.keys(this.content).length?(console.warn("Batch table is empty."),this.batchLength=0):this.batchLength=this.content[Object.keys(this.content)[0]].length,this.extensions={}}getPickingInfo(e){const t={};if(0===this.batchLength)return;if(e<0)throw new Error(`Batch Id (${e}) must be positive to access\n            feature properties from the batch table.`);if(!(e<this.batchLength))throw new Error(`Batch Id (${e}) must be inferior to batch length\n                (${this.batchLength}) to access feature properties in batch\n                table.`);Object.keys(this.content).forEach((i=>{t[i]=this.content[i][e]}));const i={BatchTable:t};return this.extensions&&Object.keys(this.extensions).forEach((t=>{const r={[t]:this.extensions[t].getPickingInfo(e)};Object.assign(i,r)})),i}removeExtensionFromContent(e){this.content.extensions[e]&&delete this.content.extensions[e],0===Object.keys(this.content.extensions).length&&delete this.content.extensions}};class z{constructor(){}}z.parse=function(e,t,i){let a,n=e;t>0&&(a=e.slice(e.byteLength-t),n=e.slice(0,e.byteLength-t));const s=new TextDecoder("utf-8").decode(new Uint8Array(n)),o=JSON.parse(s),l=new r.BatchTable(o,a,i);return Promise.all([]).then((()=>l))},r.BatchTableParser=z,r.B3dmParser=class{constructor(){this.utf8Decoder=new TextDecoder("utf-8"),this.glTFLoader=new THREE.GLTFLoader,this.glTF2Loader=new THREE.GLTF2Loader,this.matrixChangeUpVectorZtoY=(new THREE.Matrix4).makeRotationX(Math.PI/2),this.matrixChangeUpVectorZtoX=(new THREE.Matrix4).makeRotationZ(-Math.PI/2)}b3dmToMesh(e,t){var i={gltfUpAxis:void 0,urlBase:THREE.LoaderUtils.extractUrlBase(t),overrideMaterials:!1,doNotPatchMaterial:void 0,opacity:1};return this.parse(e,i).then((function(e){return{batchTable:e.batchTable,object3d:e.gltf.scene}}))}filterUnsupportedSemantics(e){const t=["MODELVIEW","MODELVIEWINVERSETRANSPOSE","PROJECTION","JOINTMATRIX"];if(e.gltfShader){const i=[];for(const t in e.gltfShader.boundUniforms)i.push(t);for(const r of i){const i=e.gltfShader.boundUniforms[r].semantic;t.includes(i)||delete e.gltfShader.boundUniforms[r]}}}parse(e,t){var i=this;const a=t.gltfUpAxis,n=t.urlBase;if(!e)throw new Error("No array buffer provided.");const s=new DataView(e,4);let o=0;const l={};if(l.magic=i.utf8Decoder.decode(new Uint8Array(e,0,4)),l.magic){l.version=s.getUint32(o,!0),o+=Uint32Array.BYTES_PER_ELEMENT,l.byteLength=s.getUint32(o,!0),o+=Uint32Array.BYTES_PER_ELEMENT,l.FTJSONLength=s.getUint32(o,!0),o+=Uint32Array.BYTES_PER_ELEMENT,l.FTBinaryLength=s.getUint32(o,!0),o+=Uint32Array.BYTES_PER_ELEMENT,l.BTJSONLength=s.getUint32(o,!0),o+=Uint32Array.BYTES_PER_ELEMENT,l.BTBinaryLength=s.getUint32(o,!0),o+=Uint32Array.BYTES_PER_ELEMENT;const d=o+4,h=[];let c={};const u=new THREE.Vector3;if(l.FTJSONLength>0){const t=d,r=e.slice(t,l.FTJSONLength+t),a=i.utf8Decoder.decode(new Uint8Array(r));c=JSON.parse(a),c.RTC_CENTER?u.fromArray(c.RTC_CENTER):u.set(0,0,0)}if(l.FTBinaryLength>0&&console.warn("3D Tiles feature table binary not supported yet."),l.BTJSONLength>0){const t=d+l.FTJSONLength+l.FTBinaryLength;h.push(r.BatchTableParser.parse(e.slice(t,l.BTJSONLength+t),l.BTBinaryLength,c.BATCH_LENGTH))}else h.push(Promise.resolve({}));const p=d+l.FTJSONLength+l.FTBinaryLength+l.BTJSONLength+l.BTBinaryLength,m=e.slice(p),f=new DataView(m,0,20);return h.push(new Promise((e=>{const r=r=>{for(const e of r.scenes)e.traverse(i.filterUnsupportedSemantics);void 0===a||"Y"===a?r.scene.applyMatrix4(i.matrixChangeUpVectorZtoY):"X"===a&&r.scene.applyMatrix4(i.matrixChangeUpVectorZtoX),r.scene.position.copy(u);const n=new Uint8Array(m,20,f.getUint32(12,!0)),s=i.utf8Decoder.decode(new Uint8Array(n)),o=JSON.parse(s);o.extensions&&o.extensions.CESIUM_RTC&&(r.scene.position.fromArray(o.extensions.CESIUM_RTC.center),r.scene.updateMatrixWorld(!0)),r.scene.traverse((function(e){if(e.frustumCulled=!1,e.material){if(t.overrideMaterials){if(Array.isArray(e.material))for(const t of e.material)t.dispose();else e.material.dispose();"object"==typeof t.overrideMaterials&&t.overrideMaterials.isMaterial?e.material=t.overrideMaterials:e.material=new THREE.MeshLambertMaterial({color:16777215})}e.material.transparent=t.opacity<1,e.material.opacity=t.opacity}})),e(r)};1===f.getUint32(4,!0)?i.glTFLoader.parse(m,r,n):i.glTF2Loader.parse(m,r,n)}))),Promise.all(h).then((e=>({gltf:e[1],batchTable:e[0]})))}throw new Error("Invalid b3dm file.")}parseFeatureBinary(e,t,i){const r=new THREE.BufferGeometry,a=this.utf8Decoder.decode(new Uint8Array(e,t,i)),n=JSON.parse(a);let s;if(n.POINTS_LENGTH&&(s=n.POINTS_LENGTH),n.POSITION){const i=n.POSITION.byteOffset+a.length+t,o=new Float32Array(e,i,3*s);r.setAttribute("position",new THREE.BufferAttribute(o,3))}if(n.RGB){const i=n.RGB.byteOffset+a.length+t,o=new Uint8Array(e,i,3*s);r.setAttribute("color",new THREE.BufferAttribute(o,3,!0))}if(n.POSITION_QUANTIZED)throw new Error("For pnts loader, POSITION_QUANTIZED: not yet managed");if(n.RGBA)throw new Error("For pnts loader, RGBA: not yet managed");if(n.RGB565)throw new Error("For pnts loader, RGB565: not yet managed");if(n.NORMAL){const i=n.RGB.byteOffset+a.length+t,o=new Float32Array(e,i,3*s);r.setAttribute("normal",new THREE.BufferAttribute(o,3))}if(n.NORMAL_OCT16P)throw new Error("For pnts loader, NORMAL_OCT16P: not yet managed");if(n.BATCH_ID)throw new Error("For pnts loader, BATCH_ID: not yet managed");return{geometry:r,offset:n.RTC_CENTER?(new THREE.Vector3).fromArray(n.RTC_CENTER):void 0}}},function(){class e extends r.AbstractTileContent{constructor(e,t){super(e,t),this._loader=e._loader}destroy(){super.destroy(),this._loader=void 0}parseTileContent(e){this._loader.parseTileContent(this._tile,this._contentBuffer,(function(t){e(t)}))}attachToTilesGroup(e){e.object3d?this._addB3dmMesh(e.object3d):this._addPointMesh(e.point)}_addB3dmMesh(e){const t=this._tile._tileset._objectGroup,i=this.meshes;for(let t=0,r=e.children.length;t<r;++t)i.add(e.children[0]);t.add(i),t.updateMatrixWorld(!0)}_addPointMesh(e){const t=this._tile._tileset._objectGroup,i=this.meshes,r=new THREE.PointsMaterial({size:.05,vertexColors:THREE.VertexColors}),a=new THREE.Points(e.geometry,r);e.offset&&a.position.copy(e.offset),i.add(a),t.add(i),t.updateMatrixWorld(!0)}}r.$3dTileContent=e}(),function(){class e extends r.AbstractTile{constructor(e,t,i,r){super(e,t),this._loader=e._loader,this._header=i,this._contentFolder=r,this.matrix=null,this.initialize()}destroy(){super.destroy(),this.matrix=void 0,this._loader=void 0,this._header=void 0,this._contentFolder=void 0}initialize(){this._parseTile(this._tileset,this,this._header,this._contentFolder)}_parseTile(e,t,i,a){if(t.boundingBox=r.TilesUtil.getBox(i.boundingVolume),i.refine?("replace"!==i.refine&&"add"!==i.refine||console.warn("lowercase-refine",'This tile uses a lowercase refine "'+i.refine+'". Instead use "'+i.refine.toUpperCase()+'".'),t.refineReplace="REPLACE"===i.refine.toUpperCase()):t.parent?t.refineReplace=t.parent.refineReplace:t.refineReplace=!0,t.geometricError=i.geometricError,i.content?(t.contentUrl=i.content.uri||i.content.url,t.contentUrl.endsWith(".b3dm")?t.contentType=r.TileContentType.DATA_B3DM:t.contentUrl.endsWith(".json")?t.contentType=r.TileContentType.DATA_TILE:t.contentUrl.endsWith(".pnts")?t.contentType=r.TileContentType.DATA_POINT:t.contentType=r.TileContentType.DATA_NULL,t.contentIndex=a+t.contentUrl):t.contentType=r.TileContentType.DATA_NULL,t.contentTypeEmpty&&(t._contentState=r.TileContentState.READY),i.transform&&(t.matrix=(new THREE.Matrix4).fromArray(i.transform)),i.children)for(const n of i.children)new r.$3dTileNode(e,t,n,a)}fetchContentBlock(e,t,i){this._loader.loadArrayBufferImmediately(e,(function(e){t(e)}),(function(e){i(e)}))}createContent(e){return new r.$3dTileContent(this,e)}}r.$3dTileNode=e}(),r.$3dTileLoader=class{constructor(){this.jsonLoader=new THREE.FileLoader,this.jsonLoader.setResponseType("json"),this.arrayBufferLoader=new THREE.FileLoader,this.arrayBufferLoader.setResponseType("arraybuffer"),this.taskRunner=new r.LoadTaskRunner(6),this.utf8Decoder=new TextDecoder("utf-8"),this.b3dmParser=new r.B3dmParser,this.pntParser=new r.PntsParser}destroy(){this.jsonLoader=null,this.arrayBufferLoader=null,this.taskRunner=null,this.utf8Decoder=null,this.b3dmParser=null,this.pntParser=null}loadJson(e,t,i){this.taskRunner.push(this.jsonLoader,e,t,(function(e){i&&i(e)}))}loadArrayBuffer(e,t,i){this.taskRunner.push(this.arrayBufferLoader,e,t,(function(e){i&&i(e)}))}loadArrayBufferImmediately(e,t,i){this.arrayBufferLoader.load(e,(function(e){t(e)}),void 0,(function(){i&&i(event)}))}parseTileContent(e,t,i){if(!t)return;const r=this,a=r.utf8Decoder.decode(new Uint8Array(t,0,4));if("{"!==a[0])if("b3dm"==a){console.log("b3dm is load");const a=e.getAbsoluteContentUrl();r.b3dmParser.b3dmToMesh(t,a).then((e=>{i(e)}))}else"pnts"==a?(console.log("pnts is load"),r.pntParser.parse(t).then((e=>{i(e)}))):console.log("Unsupported magic code:"+a)}},function(){class e extends r.AbstractTileset{constructor(e){super(e),this._loader=e.loader,this.maximumScreenSpaceError=void 0}destroy(){super.destroy(),this._loader=void 0}loadTileset(e,t){const i=this;this._loader.loadJson(e,void 0,(function(a){const n=e.slice(0,e.lastIndexOf("/")+1),s=i.createTile(n,a.context);void 0===s&&r.Error.throwError(r.ERRORS.DEVELOPE_EXCEPTION,"Tile data error!"),i.root=s,i._boundingBox=s.boundingBox.clone(),i.maximumScreenSpaceError=s.geometricError*r.TilesUtil.OP_GEOMETRIC_ERROR_COEFFICIENT,t&&t(i)}))}createTile(e,t,i){if(t.root&&t.root.boundingVolume)return new r.$3dTileNode(this,i,t.root,e)}loadChildrenOfTile(e,t,i){const r=this,a=e.getAbsoluteContentUrl(),n=a.slice(0,a.lastIndexOf("/")+1);this._loader.loadJson(a,t,(function(t){if(r.isDestroyed())return;const a=r.createTile(n,t.context,e);i&&i(a)}))}updateFrameState(e){e.transformMatrixUpdated=!1,void 0!==e.transformMatrix&&e.transformMatrix.equals(this._transformMatrix)||(e.transformMatrixUpdated=!0,void 0===e.transformMatrix?e.transformMatrix=this._transformMatrix.clone():e.transformMatrix.copy(this._transformMatrix)),e.maximumScreenSpaceError=this.maximumScreenSpaceError}updateGlobalMatrix(e){this._objectGroup.matrix.copy(e),this._objectGroup.matrix.multiplyMatrices(e,this._transformMatrix),this._objectGroup.matrixAutoUpdate=!1,this._objectGroup.updateMatrixWorld(!0)}statisticsMeshInformation(){for(var e={meshCount:0,visibleCount:0},t=this._objectGroup.children,i=0,a=t.length;i<a;i++){var n=t[i];r.Utils.isGroupObject(n)&&(e.meshCount++,n.visible&&e.visibleCount++)}return e}hideAllMesh(){for(var e in this._objectGroup.children)this._objectGroup.children[e].visible=!1}}r.$3dTileset=e}(),function(){class e extends r.BaseModel{constructor(e,t,i,a,n,s){super(t,i),this.viewer=e,this.index=a,this.parseCfgFinish=n,this.debut=s,this.url=i.serverUrl+""+i.databagId+"/tileset.json",this.tilesLoader=new r.$3dTileLoader,this.objectGroup=t.getScene().getOrCreateObjectGroup(r.GlobalData.TdTileGroupName,{pickableType:r.PICKABLETYPE.Geometry,globalSpace:!0}),i.loadConfig&&i.loadConfig.transformMatrix?(this.setTransformMatrix(i.loadConfig.transformMatrix),this.objectGroup.transformMatrix=this.transformMatrix):(this.setTransformMatrix(new THREE.Matrix4),this.objectGroup.transformMatrix=this.transformMatrix),this._tileset=new r.$3dTileset({loader:this.tilesLoader,objectGroup:this.objectGroup,transformMatrix:this.transformMatrix,tilesCacheScheduler:this.manager.tilesCacheScheduler,debugShowBoundingBox:e._options.debugShowBoundingBox,debugShowStatistics:e._options.debugShowStatistics,databagId:this.databagId}),this._modelMatrix=new THREE.Matrix4}destroy(){super.destroy(),this._tileset=this._tileset&&this._tileset.destroy(),this.manager.scene.removeObjectGroupByName(r.GlobalData.TdTileGroupName),this.objectGroup=null,this.tilesLoader.destroy(),this.tilesLoader=null,this._modelMatrix=null,this.parseCfgFinish=null,this.debut=null,this.viewer=null}load(e){var t=this;this.manager.chooseRendering(this.statistics.memoeryInfo,!0),this.parseCfgFinish&&this.parseCfgFinish(),this.manager.dispatchEvent({type:r.EVENTS.ON_LOAD_START});const i=new Promise(((e,i)=>{this._tileset.loadTileset(this.url,(function(i){t.getTransforms().boundingBox=i._boundingBox.clone(),t.manager.updateScene(t);var a=t.viewer.getScene().getRawMatrixGlobal();i.updateGlobalMatrix(a),t.manager.dispatchEvent({type:r.EVENTS.ON_LOAD_COMPLETE,modelId:t.id}),t.debut(t),e()}))}));return i}updateMatrix(){const e=this.viewer.getScene().getRawMatrixGlobal();this._tileset.updateGlobalMatrix(e)}hasTransforms(){return!0}preUpdate(e){this._tileset.preUpdate(e)}update(e){this._tileset.update(e)}postUpdate(e){this._tileset.postUpdate(e)}setVisible(e){this.visible=e,this.objectGroup.visible!==e&&(this.objectGroup.visible=e,this.objectGroup.pickableType=e?r.PICKABLETYPE.Geometry:r.PICKABLETYPE.UnPickable,this.manager.setRenderStateChanged(!0))}get sequence(){return this._tileset.sequence}set sequence(e){this._tileset.sequence=e}}r.$3dTilesModel=e}(),r.Tile=r.Tile||{};r.Tile.DemUrl=class{constructor(e){if(this.terrainPath=e,-1===e.indexOf("terrain.")){this.terrainPath=`${e}{z}/{x}/{y}.${r.GlobalData.TerrainZipResourceFileName}`;!0===e.indexOf("srtm/v1")>-1&&(this.terrainPath=`${e}{z}/{x}/{y}/${r.GlobalData.TerrainResourceFileName}`)}}terrainUrl(e,t,i){return r.Layer.ImageryProvider.getRequestMapUrl(this.terrainPath,t,i,e)}},function(){class e extends r.BaseModel{constructor(e,t){super(e.modelManager,{modelId:"earthModel"}),t=r.Utils.defaultValue(t,{}),this.radius=r.Utils.defaultValue(t.radius,5e3),this.autoRotation=r.Utils.defaultValue(t.autoRotation,!0),this.rotationSpeed=r.Utils.defaultValue(t.rotationSpeed,2*Math.PI/360),this.earthResource=r.Utils.defaultValue(t.earthResource,"earth_0_satellite_ch.basis"),this.isBasisResource=null==t.earthResource,this.spherePrecision=r.Utils.defaultValue(t.spherePrecision,100),this.animationTime=r.Utils.defaultValue(t.animationTime,5),this._baseGeoCoordinates=t._baseGeoCoordinates,this.focusLonLat=r.Utils.defaultValue(t.focusLonLat,{lon:null,lat:20,height:null}),this.viewer=e,this._rotationAngle=0,this._globeHomeCameraInfo=null,this.earth=null,this.earthMaterial=null,this.animator=null,this._maxRotationLon=Math.PI/THREE.Math.DEG2RAD,this._initEarthRatio=1.5}destroy(){this.earth=null,this.earthMaterial=null}get homeCameraInfo(){return this._globeHomeCameraInfo}setupEarth(){const e=this.viewer,t=this.earthGroup=e.getScene().getOrCreateObjectGroup(r.ObjectGroupType.GLOBALEARTH,{pickableType:r.PICKABLETYPE.UnPickable,globalSpace:!1});var i=new THREE.TextureLoader;const n=this;i.crossOrigin=!0,this.isBasisResource&&(i=r.MaterialUtil.getBasisTextureLoader()).detectSupport(new THREE.WebGLRenderer({antialias:!0}));const s=`${e._staticResourcesHost}/Earth/${this.earthResource}`;return new Promise(((r,o)=>{i.load(s,(i=>{i.encoding=THREE.GammaEncoding;var s=new THREE.SphereBufferGeometry(n.radius,n.spherePrecision,n.spherePrecision),o=n.earthMaterial=new THREE.MeshLambertMaterial({map:i,color:16777215}),l=n.earth=new THREE.Mesh(s,o);s.computeBoundingBox();const d=s.boundingBox;t.add(l),t.updateMatrixWorld(!0),n.getTransforms().boundingBox=d.clone(),n.modelLoaded=!0,this._setCamera(),n._globeHomeCameraInfo={position:e.camera.position.clone(),target:e.camera.target.clone(),up:e.camera.realUp.clone()||e.camera.up.clone(),zoom:e.camera.zoom},n.autoRotation?a(this,(()=>{r()})):r()}),void 0,(e=>{o()}))}))}_setCamera(){let e=this._baseGeoCoordinates.lon+Math.PI/THREE.Math.DEG2RAD;e>Math.PI/THREE.Math.DEG2RAD&&(e-=2*Math.PI/THREE.Math.DEG2RAD);const t=this.viewer.camera;this.focusLonLat.lon=r.Utils.defaultValue(this.focusLonLat.lon,e);const i=this.radius*this._initEarthRatio/Math.sin(.5*THREE.Math.DEG2RAD*t.fov),a=i-this.radius,n=r.Tile.TileMath.fromDegreesYUp(this.focusLonLat.lon,this.focusLonLat.lat,a,this.radius),s=new THREE.Vector3(-n.x,-n.y,-n.z);t.LookAt(new THREE.Vector3,s,THREE.Object3D.DefaultUp),this.focusLonLat.height=r.Utils.defaultValue(this.focusLonLat.height,i),this._maxRotationLat=this._baseGeoCoordinates.lat-this.focusLonLat.lat,this._maxRotationLat=this._maxRotationLat>180?180:this._maxRotationLat}_autoRotationAnimation(e){const t=this;let i=t._globeHomeCameraInfo.position.clone();const r=new THREE.Vector3(0,1,0),a=new THREE.Vector3(0,0,0);window.requestAnimationFrame((function n(){let s=i.clone();s.applyAxisAngle(r,t.rotationSpeed),s.multiplyScalar(.998),i=s;const o=new THREE.Vector3(-s.x,-s.y,-s.z);t.viewer.camera.LookAt(a,o,THREE.Object3D.DefaultUp),t._rotationAngle<=1.5*Math.PI?(t._rotationAngle+=t.rotationSpeed,window.requestAnimationFrame(n)):e&&e()}))}_animation(e){const t=this.viewer,i=t.camera,a=this._globeHomeCameraInfo.position.clone(),n=Math.tan(.5*THREE.Math.DEG2RAD*i.fov),s=r.Tile.TileMath.fromDegreesYUp(this._baseGeoCoordinates.lon,this._baseGeoCoordinates.lat,n,this.radius);let o=new THREE.Vector3(0,0,0);const l={position:s,target:o,up:THREE.Object3D.DefaultUp,zoom:i.zoom};var d={position:a,target:o,up:THREE.Object3D.DefaultUp,zoom:i.zoom};this.animator.active(d,l,t,(function(e){t.cameraControl.update(!0,!0)}),(function(){e&&e()}))}}let t=1,i=new THREE.Vector3(0,0,0);function a(e,n){const s=e.viewer,o=s.cameraControl,l=o.camera,d=l.position.clone(),h=1-t/e.animationTime,c=h*(e.focusLonLat.height-e.focusLonLat.height/e._initEarthRatio)+e.focusLonLat.height/e._initEarthRatio-e.radius;let u=e.focusLonLat.lon+(1-h)*e._maxRotationLon;u>Math.PI/THREE.Math.DEG2RAD&&(u-=2*Math.PI/THREE.Math.DEG2RAD);let p=e.focusLonLat.lat+(1-h)*e._maxRotationLat;const m={position:r.Tile.TileMath.fromDegreesYUp(u,p,c,e.radius),target:i,up:THREE.Object3D.DefaultUp,zoom:l.zoom};var f={position:d,target:i,up:THREE.Object3D.DefaultUp,zoom:l.zoom};t++;const g=new r.CameraAnimator;g.setDuration(1e3),g.active(f,m,s,(function(e){o.update(!0,!0)}),(function(){t<=e.animationTime?a(e,n):n&&n()}))}r.VirtualEarth=e}();r.Tile.TextureLayer=class{constructor(e,t){this._url=t.url,this.imageryProviderType=r.Utils.defaultValue(t.imageryProviderType,"UrlTemplate"),this.imageryProvider=new r.Layer.ImageryProviderFactory[this.imageryProviderType]({mapUrl:this._url}),this.id=t.layerId||r.Utils.getEncodedString(this._url),this.hasTileMapResource=t.hasTileMapResource||!1,this.layerName=void 0===t.layerName?r.ObjectGroupType.ROADNETWORK:t.layerName,this.tileGroup=e.getScene().getOrCreateObjectGroup(this.layerName,{pickableType:r.PICKABLETYPE.Map,globalSpace:!0}),this._priority=0,this.materialMap={},this.meshNodeMap={},this.loadStateMap={},this._opacity=1,this.mapStyle={},this._fetchMetadata()}destroy(){this.url=void 0,this.priority=void 0,this.opacity=void 0,this.disposeMaterial(),this.disposeMeshNode(),this.loadStateMap=null,this.tileGroup.clear(),this.tileGroup=null,this.imageryProviderType=void 0,this.imageryProvider=null,this.mapStyle=null}_fetchMetadata(){if(!this.hasTileMapResource)return;const e=this._url.substring(0,this._url.indexOf("{")),t=r.DomUtil.loadXMLDoc(e+"tilemapresource.xml",!1);if(!t)return;const i=r.DomUtil.getXMLAttributeValues(t,"BoundingBox");this.boundingBox=i?new THREE.Box2(new THREE.Vector2(parseFloat(i.minx),parseFloat(i.miny)),new THREE.Vector2(parseFloat(i.maxx),parseFloat(i.maxy))):void 0;const a=r.DomUtil.getXMLAttributeValues(t,"TileFormat");this.tileFormat=a?{mimeType:a["mime-type"],extension:a.extension}:void 0;const n=r.DomUtil.getXMLAttributeValuesByAttrName(t,"TileSet","order");this.minLevel=1/0,this.maxLevel=-1/0,n.forEach((e=>{const t=parseInt(e);t>this.maxLevel&&(this.maxLevel=t),t<this.minLevel&&(this.minLevel=t)}))}getRequestUrl(e,t,i){return this.imageryProvider.getImageryUrl(e,t,i)}isAvailableTile(e,t,i){if(this.maxLevel&&(i<this.minLevel||i>this.maxLevel))return!1;if(this.boundingBox){const a=r.Tile.TileMath.long2tile(this.boundingBox.min.x,i),n=r.Tile.TileMath.long2tile(this.boundingBox.max.x,i),s=r.Tile.TileMath.lat2tile(this.boundingBox.min.y,i),o=r.Tile.TileMath.lat2tile(this.boundingBox.max.y,i),l=Math.min(s,o),d=Math.max(s,o);if(e<a||e>n||t<l||t>d)return!1}return!0}contentLoaded(e,t,i){return this.loadStateMap[e]&&this.loadStateMap[e][t]&&this.loadStateMap[e][t][i]===r.Tile.DemTilesUtil.LOAD_STATE.LOADED}contentUnLoad(e,t,i){return void 0===this.loadStateMap[e]?(this.loadStateMap[e]={},this.loadStateMap[e][t]={},this.loadStateMap[e][t][i]=r.Tile.DemTilesUtil.LOAD_STATE.UNLOADED,!0):void 0===this.loadStateMap[e][t]?(this.loadStateMap[e][t]={},this.loadStateMap[e][t][i]=r.Tile.DemTilesUtil.LOAD_STATE.UNLOADED,!0):void 0===this.loadStateMap[e][t][i]?(this.loadStateMap[e][t][i]=r.Tile.DemTilesUtil.LOAD_STATE.UNLOADED,!0):this.loadStateMap[e][t][i]===r.Tile.DemTilesUtil.LOAD_STATE.UNLOADED}contentUnLoading(e,t,i){return this.loadStateMap[e][t][i]===r.Tile.DemTilesUtil.LOAD_STATE.MAT_PARSING}setContentUnLoad(e,t,i){this.loadStateMap[e][t][i]=r.Tile.DemTilesUtil.LOAD_STATE.UNLOADED}setContentLoaded(e,t,i){this.loadStateMap[e][t][i]=r.Tile.DemTilesUtil.LOAD_STATE.LOADED}setContentLoading(e,t,i){this.loadStateMap[e][t][i]=r.Tile.DemTilesUtil.LOAD_STATE.MAT_PARSING}disposeMeshNode(){for(var e in this.meshNodeMap)for(var t in this.meshNodeMap[e])for(var i in this.meshNodeMap[e][t])this.meshNodeMap[e][t][i]&&this.meshNodeMap[e][t][i].parent.remove(this.meshNodeMap[e][t][i]);this.meshNodeMap=null}disposeMaterial(){for(var e in this.materialMap)for(var t in this.materialMap[e])for(var i in this.materialMap[e][t])this.materialMap[e][t][i]&&this.materialMap[e][t][i].dispose();this.materialMap=null}get opacity(){return this._opacity}set opacity(e){this._opacity=e}get url(){return this._url}set url(e){this._url=e}get priority(){return this._priority}set priority(e){this._priority=e}show(){this.tileGroup?this.tileGroup.visible=!0:console.warn("The tile doesn't exist.")}hide(){this.tileGroup?this.tileGroup.visible=!1:console.warn("The tile doesn't exist.")}setStyle(e){for(var t in this.mapStyle=e,this.materialMap){var i=this.materialMap[t];i.updateStyle&&i.updateStyle(e)}}updateMeshRenderOrder(e){for(let t in this.meshNodeMap)for(let i in this.meshNodeMap[t])for(let r in this.meshNodeMap[t][i])this.meshNodeMap[t][i][r]&&(this.meshNodeMap[t][i][r].renderOrder=e)}},function(){class e{constructor(){}}e.LOAD_STATE={UNLOADED:0,GEO_LOADING:1,GEO_LOADED:2,MAT_PARSING:3,LOADED:4,FAILED:5},e.TWO_ACCURACY=.01,e.InvalidTerrainValue=-32768,e.isTransparent=function(t){return 1-t>e.TWO_ACCURACY},r.Tile.DemTilesUtil=e}();r.Tile.DemTile=class{constructor(e,t,i){this.zoom=e,this.x=t,this.y=i,this.longLatBox=r.Tile.TileMath.tile2boundingBox(t,i,e),this.box=null,this.meshNode=null,this.meshLoadState=r.Tile.DemTilesUtil.LOAD_STATE.UNLOADED,this.skirt=null,this.geometry=null,this.skirtGeometry=null,this.texture=null,this.material=null,this.needUpdateTexture=!1}destroy(){this.zoom=null,this.x=null,this.y=null,this.longLatBox=null,this.box=null,this.geometryLoadState=null,this.skirt&&this.skirt.parent.remove(this.skirt),this.meshNode&&(this.meshNode.parent.remove(this.meshNode),this.material.dispose(),this.texture.dispose()),this.geometry&&this.geometry.dispose(),this.skirtGeometry&&this.skirtGeometry.dispose(),this.meshNode=null,this.skirt=null,this.geometry=null,this.skirtGeometry=null,this.texture=null,this.material=null,this.needUpdateTexture=void 0}},function(){r.Tile=r.Tile||{};class e{constructor(){}}e.earthRadius=6371e3,e.mercatorPerimeter=20037508.3427892,e.unitScale=1e3,e.earthHighestAltitude=8865.43*e.unitScale*2,e.isLongitude=function(e){return e>=-180&&e<=180},e.isLatitude=function(e){return e>=-85.0511&&e<=85.0511},e.long2tile=function(e,t){return Math.floor((e+180)/360*Math.pow(2,t))},e.lat2tile=function(e,t){return Math.floor((1-Math.log(Math.tan(e*Math.PI/180)+1/Math.cos(e*Math.PI/180))/Math.PI)/2*Math.pow(2,t))},e.tile2long=function(e,t){return e/Math.pow(2,t)*360-180},e.tile2lat=function(e,t){var i=Math.PI-2*Math.PI*e/Math.pow(2,t);return 180/Math.PI*Math.atan(.5*(Math.exp(i)-Math.exp(-i)))},e.tile2boundingBox=function(e,t,i){return{north:this.tile2lat(t,i),south:this.tile2lat(t+1,i),west:this.tile2long(e,i),east:this.tile2long(e+1,i)}},e.boundingBox2Tiles=function(t,i,r,a,n){var s,o,l,d,h=[],c=e.long2tile(t,n),u=e.long2tile(i,n),p=e.lat2tile(r,n),m=e.lat2tile(a,n);s=Math.min(c,u),l=Math.max(c,u),o=Math.min(p,m),d=Math.max(p,m);for(var f=s;f<=l;f++)for(var g=o;g<=d;g++)h.push({tileX:f,tileY:g});return h},e.getMercatorPerimeterByLat=function(e,t){return(t=r.Utils.defaultValue(t,r.GIS.Ellipsoid.WGS84)).getPerimeterByLat(e)/2},e.wgs84ToGCJ02=function(t,i){var r=.006693421622965943,a=(i=+i,t=+t,e._transformLat(t-105,i-35)),n=e._transformLng(t-105,i-35),s=i/180*Math.PI,o=Math.sin(s);o=1-r*o*o;var l=Math.sqrt(o);return a=180*a/(e.earthRadius*(1-r)/(o*l)*Math.PI),[t+(n=180*n/(e.earthRadius/l*Math.cos(s)*Math.PI)),i+a]},e._transformLat=function(e,t){var i=2*(e=+e)-100+3*(t=+t)+.2*t*t+.1*e*t+.2*Math.sqrt(Math.abs(e));return i+=2*(20*Math.sin(6*e*Math.PI)+20*Math.sin(2*e*Math.PI))/3,i+=2*(20*Math.sin(t*Math.PI)+40*Math.sin(t/3*Math.PI))/3,i+=2*(160*Math.sin(t/12*Math.PI)+320*Math.sin(t*Math.PI/30))/3},e._transformLng=function(e,t){var i=300+(e=+e)+2*(t=+t)+.1*e*e+.1*e*t+.1*Math.sqrt(Math.abs(e));return i+=2*(20*Math.sin(6*e*Math.PI)+20*Math.sin(2*e*Math.PI))/3,i+=2*(20*Math.sin(e*Math.PI)+40*Math.sin(e/3*Math.PI))/3,i+=2*(150*Math.sin(e/12*Math.PI)+300*Math.sin(e/30*Math.PI))/3},e.lonLat2Mercator=function(t,i,r,a){r=r||e.mercatorPerimeter,a=a||e.unitScale;var n=new THREE.Vector2,s=t*r/180,o=Math.log(Math.tan((90+i)*Math.PI/360))/(Math.PI/180);return o=o*r/180,n.x=s*a,n.y=o*a,n},e.mercator2lonLat=function(t,i,r){i=i||e.mercatorPerimeter,r=r||e.unitScale;var a=new THREE.Vector2,n=t.x/(r*i)*180,s=t.y/(r*i)*180;return s=180/Math.PI*(2*Math.atan(Math.exp(s*Math.PI/180))-Math.PI/2),a.x=n,a.y=s,a},e.toRadians=function(e){return e*Math.PI/180},e.fromDegreesYUp=function(t,i,a,n){n=r.Utils.defaultValue(n,e.earthRadius);const s=(t+90)*(Math.PI/180),o=(90-i)*(Math.PI/180),l=Math.pow(n,2),d=new THREE.Vector3(l,l,l),h=Math.sin(o);var c=new THREE.Vector3;c.x=h*Math.sin(s),c.y=Math.cos(o),c.z=h*Math.cos(s),c.normalize();var u=new THREE.Vector3;u.multiplyVectors(d,c);var p=Math.sqrt(c.dot(u));return u.divideScalar(p),c.multiplyScalar(a),u.add(c)},e.fromDegrees=function(e,t,i,a){i=null==i?0:i,e=this.toRadians(e),t=this.toRadians(t);var n=new THREE.Vector3,s=new THREE.Vector3,o=r.Utils.isDefined(a)?a.radiiSquared:r.GIS.Ellipsoid.WGS84.radiiSquared,l=Math.cos(t);n.x=l*Math.cos(e),n.y=l*Math.sin(e),n.z=Math.sin(t),n.normalize(),s.multiplyVectors(o,n);var d=Math.sqrt(n.dot(s));return s.divideScalar(d),n.multiplyScalar(i),s.add(n)},e.createHeightArray=function(e,t){for(var i=new Array(t+1),r=0;r<i.length;r++)i[r]=new Array(t+1);var a=e.length,n=t/(a-1);for(r=0;r<a-1;++r)for(var s=0;s<a-1;++s)for(var o=[e[r][s],e[r][s+1],e[r+1][s],e[r+1][s+1]],l=this.sampleSquare(o,n),d=r*n;d<=(r+1)*n;++d)for(var h=s*n;h<=(s+1)*n;++h)i[d][h]=l[d-r*n][h-s*n];return i},e.sampleSquare=function(e,t){for(var i=new Array(t+1),r=0;r<i.length;r++)i[r]=new Array(t+1);for(r=0;r<=t;++r)i[0][r]=(t-r)/t*e[0]+(1-(t-r)/t)*e[1],i[t][r]=(t-r)/t*e[2]+(1-(t-r)/t)*e[3],i[r][0]=(t-r)/t*e[0]+(1-(t-r)/t)*e[2],i[r][t]=(t-r)/t*e[1]+(1-(t-r)/t)*e[3];for(r=1;r<t;++r)for(var a=1;a<t;++a)i[r][a]=i[r][0]+(i[r][t]-i[r][0])/t*a;return i},e.generateHeight=function(e,t){for(var i=e*t,r=new Uint8Array(i),a=this.improvedNoise(),n=1,s=100*Math.random(),o=0;o<4;o++){for(var l=0;l<i;l++){var d=l%e,h=~~(l/e);r[l]+=Math.abs(a.noise(d/n,h/n,s)*n*1.75)}n*=5}return r},e.improvedNoise=function(){for(var e=[151,160,137,91,90,15,131,13,201,95,96,53,194,233,7,225,140,36,103,30,69,142,8,99,37,240,21,10,23,190,6,148,247,120,234,75,0,26,197,62,94,252,219,203,117,35,11,32,57,177,33,88,237,149,56,87,174,20,125,136,171,168,68,175,74,165,71,134,139,48,27,166,77,146,158,231,83,111,229,122,60,211,133,230,220,105,92,41,55,46,245,40,244,102,143,54,65,25,63,161,1,216,80,73,209,76,132,187,208,89,18,169,200,196,135,130,116,188,159,86,164,100,109,198,173,186,3,64,52,217,226,250,124,123,5,202,38,147,118,126,255,82,85,212,207,206,59,227,47,16,58,17,182,189,28,42,223,183,170,213,119,248,152,2,44,154,163,70,221,153,101,155,167,43,172,9,129,22,39,253,19,98,108,110,79,113,224,232,178,185,112,104,218,246,97,228,251,34,242,193,238,210,144,12,191,179,162,241,81,51,145,235,249,14,239,107,49,192,214,31,181,199,106,157,184,84,204,176,115,121,50,45,127,4,150,254,138,236,205,93,222,114,67,29,24,72,243,141,128,195,78,66,215,61,156,180],t=0;t<256;t++)e[256+t]=e[t];function i(e){return e*e*e*(e*(6*e-15)+10)}function r(e,t,i){return t+e*(i-t)}function a(e,t,i,r){var a=15&e,n=a<8?t:i,s=a<4?i:12==a||14==a?t:r;return(0==(1&a)?n:-n)+(0==(2&a)?s:-s)}return{noise:function(t,n,s){var o=Math.floor(t),l=Math.floor(n),d=Math.floor(s),h=255&o,c=255&l,u=255&d,p=(t-=o)-1,m=(n-=l)-1,f=(s-=d)-1,g=i(t),v=i(n),y=i(s),M=e[h]+c,E=e[M]+u,b=e[M+1]+u,I=e[h+1]+c,x=e[I]+u,T=e[I+1]+u;return r(y,r(v,r(g,a(e[E],t,n,s),a(e[x],p,n,s)),r(g,a(e[b],t,m,s),a(e[T],p,m,s))),r(v,r(g,a(e[E+1],t,n,f),a(e[x+1],p,n,s-1)),r(g,a(e[b+1],t,m,f),a(e[T+1],p,m,f))))}}},r.Tile.TileMath=e}(),function(){r.Tile=r.Tile||{};class e extends r.Tile.TileMath{constructor(){super()}}e.isLatitude=function(e){return e>=-90&&e<=90},e.long2tile=function(t,i){return Math.floor(Math.pow(2,i-26)*t*Math.PI*e.earthRadius/180)},e.lat2tile=function(t,i){return Math.floor(Math.pow(2,i-26)*e.earthRadius*Math.log(Math.tan(t*Math.PI/180)+Math.cos(t*Math.PI/180)))},r.Tile.TileMathBd=e}();r.Tile.TerrainScheduler=class{constructor(e,t){this.limit=e,this.bufferSize=t,this.store=[],this.active=0,this.taskInfo={},this.terrainLoader=new THREE.FileLoader,this.terrainLoader.setResponseType("arraybuffer"),this.terrainLoader.crossOrigin=!0}destroy(){this.limit=null,this.store=null,this.active=null,this.taskInfo=null,this.bufferSize=null,this.terrainLoader=null}clear(){this.taskInfo={}}next(){if(this.store.length){var e=this.store.shift(),t=e[0],i=e[1],r=e[2];this.taskInfo[t].added?this.taskInfo[t].data?"failure"==scope.taskInfo[t].data?r():i(this.taskInfo[t].data):(this.taskInfo[t].successCallbackList.push(i),this.taskInfo[t].failureCallbackList.push(r)):this.runTask(t)}}runTask(e){var t=this;t.active++,t.taskInfo[e].added=!0,t.terrainLoader.load(e,(function(i){t.active--,t.taskInfo[e].data=i;for(var r=0,a=t.taskInfo[e].successCallbackList.length;r<a;++r)t.taskInfo[e].successCallbackList[r](i);t.next()}),void 0,(function(i){t.active--,t.taskInfo[e].data="failure";for(var r=0,a=t.taskInfo[e].failureCallbackList.length;r<a;++r)t.taskInfo[e].failureCallbackList[r]();t.next()}))}push(e,t,i){this.taskInfo[e]?this.taskInfo[e].data?t(this.taskInfo[e].data):(this.taskInfo[e].successCallbackList.push(t),this.taskInfo[e].failureCallbackList.push(i)):(this.taskInfo[e]={},this.taskInfo[e].successCallbackList=[t],this.taskInfo[e].failureCallbackList=[i],this.active<this.limit?this.runTask(e):this.store.push([e,t,i]))}};r.Tile.TileBuilder=class{constructor(){this.indexMap={},this.uvMap={}}destroy(){this.indexMap=null,this.uvMap=null}getIndexBySeg(e){if(this.indexMap[e])return this.indexMap[e];for(var t=[],i=[],r=0,a=0;a<=e;a++){for(var n=[],s=0;s<=e;s++)n.push(r),r++;i.push(n)}for(a=0;a<e;a++)for(s=0;s<e;s++){const e=i[a][s+1],r=i[a][s],n=i[a+1][s],o=i[a+1][s+1];this.bufferize(o,r,e,t),this.bufferize(o,n,r,t)}return this.indexMap[e]=t,t}bufferize(e,t,i,r){r.push(e),r.push(t),r.push(i)}computeBuffer(){}createSkirt(e,t,i,r,a,n){e=e.concat(t.reverse());var s=[];const o=(new THREE.Vector3).fromArray(a.position).distanceTo((new THREE.Vector3).fromArray(a.position,3));for(var l=0;l<e.length;l++){const t=e[l],n=3*i,d=3*t;a.position[n+0]=a.position[d+0]-a.normal[d+0]*o,a.position[n+1]=a.position[d+1]-a.normal[d+1]*o,a.position[n+2]=a.position[d+2]-a.normal[d+2]*o,a.normal[n+0]=a.normal[d+0],a.normal[n+1]=a.normal[d+1],a.normal[n+2]=a.normal[d+2],a.uvs[2*i+0]=a.uvs[2*t+0],a.uvs[2*i+1]=a.uvs[2*t+1];const h=(l+1)%e.length,c=t,u=i,p=0===h?r:i+1,m=e[h];this.bufferize(c,u,p,s),this.bufferize(c,p,m,s),i++}return n=n.concat(s)}createSkirt2(e,t,i,r,a,n){e=e.concat(t.reverse());var s=[];const o=(new THREE.Vector3).fromArray(a.position).distanceTo((new THREE.Vector3).fromArray(a.position,3));var l={index:null,position:null,normal:null,uvs:[],center:null};const d=4*(e.length/4)*2;l.position=new Float32Array(3*d),l.normal=new Float32Array(3*d),l.uvs=new Float32Array(3*d);for(var h=0;h<e.length;h++){const t=e[h],i=6*h,r=4*h,n=3*t;l.position[i+0]=a.position[n+0],l.position[i+1]=a.position[n+1],l.position[i+2]=a.position[n+2],l.position[i+3]=a.position[n+0]-a.normal[n+0]*o,l.position[i+4]=a.position[n+1]-a.normal[n+1]*o,l.position[i+5]=a.position[n+2]-a.normal[n+2]*o,l.normal[i+0]=a.normal[n+0],l.normal[i+1]=a.normal[n+1],l.normal[i+2]=a.normal[n+2],l.normal[i+3]=a.normal[n+0],l.normal[i+4]=a.normal[n+1],l.normal[i+5]=a.normal[n+2],l.uvs[r+0]=a.uvs[2*t+0],l.uvs[r+1]=a.uvs[2*t+1],l.uvs[r+2]=a.uvs[2*t+0],l.uvs[r+3]=a.uvs[2*t+1];const d=(h+1)%e.length,c=2*h,u=2*h+1,p=0===d?1:2*h+3,m=0===d?0:2*h+2;this.bufferize(c,u,p,s),this.bufferize(c,p,m,s)}l.index=s;var c=new THREE.BufferGeometry;return c.setIndex(l.index),c.setAttribute("position",new THREE.BufferAttribute(l.position,3)),c.setAttribute("uv",new THREE.BufferAttribute(l.uvs,2)),c.setAttribute("normal",new THREE.Float32BufferAttribute(l.normal,3)),c.computeVertexNormals(),c}},(()=>{let e=new THREE.Vector3,t=new THREE.Matrix4,i=new THREE.Vector2,a=new THREE.Vector2;class n extends r.Tile.TileBuilder{constructor(){super()}destroy(){}computePlaneGeometry(e,t,i,a,n,s){s=s||r.Tile.TileMath.unitScale;const o={index:null,position:null,normal:null,uvs:[],center:null},l=((i=null==i?16:i)+1)*(i+1);o.position=new Float32Array(3*l),o.normal=new Float32Array(3*l),o.uvs=new Float32Array(2*l);let d=[];const h=[];let c=0;for(var u=e/2,p=t/2,m=e/i,f=t/i,g=0;g<=i;++g){const e=[];for(var v=g*f-p,y=0;y<=i;++y){var M=y*m-u;o.position[3*c]=M,o.position[3*c+1]=v,o.position[3*c+2]=a[i-g][y]*s*r.GlobalData.TerrainScale,o.normal[3*c]=0,o.normal[3*c+1]=0,o.normal[3*c+2]=1,o.uvs[2*c]=y/i,o.uvs[2*c+1]=g/i,n||0!==g&&g!==i&&(y===i?d.push(c):0===y&&h.push(c)),e.push(c),c++}0===g?d=d.concat(e):g===i&&(d=d.concat(e.slice().reverse()))}var E=this.getIndexBySeg(i);const b=c;var I=null;n||(I=this.createSkirt2(d,h,c,b,o,E)),o.index=E;var x=new THREE.BufferGeometry;return x.setIndex(o.index),x.setAttribute("position",new THREE.BufferAttribute(o.position,3)),x.setAttribute("uv",new THREE.BufferAttribute(o.uvs,2)),x.setAttribute("normal",new THREE.Float32BufferAttribute(o.normal,3)),x.computeVertexNormals(),[x,I]}getTileGeometryTriangular(t,i,r){if(r){var a,n;null!=r.prePositionArray?(a=[...r.prePositionArray],n=[...r.preIndexArray]):(a=[...r.attributes.position.array],n=[...r.index.array]);for(var s=[],o=[],l=[],d=0;d<n.length;d+=3){var h=a[3*n[d]],c=a[3*n[d]+1],u=a[3*n[d]+2],p=a[3*n[d+1]],m=a[3*n[d+1]+1],f=a[3*n[d+1]+2],g=a[3*n[d+2]],v=a[3*n[d+2]+1],y=a[3*n[d+2]+2],M=0;e.set(h,c,u),e.applyMatrix4(i);var E=t.isInRegionDrawing(e);E&&M++,e.set(p,m,f),e.applyMatrix4(i);var b=t.isInRegionDrawing(e);if(b&&M++,e.set(g,v,y),e.applyMatrix4(i),t.isInRegionDrawing(e)&&M++,1==M){var I=[];if(E?(_={x:h,y:c,z:u},I.push({x:p,y:m,z:f}),I.push({x:g,y:v,z:y})):b?(_={x:p,y:m,z:f},I.push({x:h,y:c,z:u}),I.push({x:g,y:v,z:y})):(_={x:g,y:v,z:y},I.push({x:h,y:c,z:u}),I.push({x:p,y:m,z:f})),2==(T=t.getIntersectPos(_,I)).length&&T[0].index!=T[1].index&&null!=T[0].point){var x=T[0].point;t.checkHighLowTerrain([_.x,_.y,_.z],[T[0].x,T[0].y,T[0].z],[x.x,x.y,x.z],s,o,l),t.checkHighLowTerrain([_.x,_.y,_.z],[T[1].x,T[1].y,T[1].z],[x.x,x.y,x.z],s,o,l)}else 2==T.length&&t.checkHighLowTerrain([_.x,_.y,_.z],[T[0].x,T[0].y,T[0].z],[T[1].x,T[1].y,T[1].z],s,o,l)}else if(2==M){var T,_=[];if(E?b?(I={x:g,y:v,z:y},_.push({x:h,y:c,z:u}),_.push({x:p,y:m,z:f})):(I={x:p,y:m,z:f},_.push({x:h,y:c,z:u}),_.push({x:g,y:v,z:y})):(I={x:h,y:c,z:u},_.push({x:p,y:m,z:f}),_.push({x:g,y:v,z:y})),2==(T=t.getIntersectPos(I,_)).length&&T[0].index!=T[1].index&&null!=T[0].point){x=T[0].point;t.checkHighLowTerrain([_[0].x,_[0].y,_[0].z],[_[1].x,_[1].y,_[1].z],[x.x,x.y,x.z],s,o,l),t.checkHighLowTerrain([_[0].x,_[0].y,_[0].z],[T[0].x,T[0].y,T[0].z],[x.x,x.y,x.z],s,o,l),t.checkHighLowTerrain([_[1].x,_[1].y,_[1].z],[T[1].x,T[1].y,T[1].z],[x.x,x.y,x.z],s,o,l)}else 2==T.length&&(t.checkHighLowTerrain([_[0].x,_[0].y,_[0].z],[_[1].x,_[1].y,_[1].z],[T[0].x,T[0].y,T[0].z],s,o,l),t.checkHighLowTerrain([T[0].x,T[0].y,T[0].z],[T[1].x,T[1].y,T[1].z],[_[1].x,_[1].y,_[1].z],s,o,l))}else 3==M&&t.checkHighLowTerrain([h,c,u],[p,m,f],[g,v,y],s,o,l)}}return[s,o,l]}updateGeometryForFlatten(n,s,o,l,d,h,c,u,p,m,f){o=null==o?16:o;let g=0;if(t.copy(u).invert(),p){p.prePositionArray||(p.prePositionArray=[...p.attributes.position.array],p.preNormalArray=[...p.attributes.normal.array],p.preUVArray=[...p.attributes.uv.array],p.preIndexArray=[...p.index.array]);var v=[...p.prePositionArray],y=[...p.preNormalArray],M=[...p.preUVArray],E=[...p.preIndexArray],b={};if(!f)for(var I=[...E],x=0;x<I.length;x+=3){var T=v[3*I[x]],_=v[3*I[x]+1],S=p.prePositionArray[3*I[x]+2],C=v[3*I[x+1]],w=v[3*I[x+1]+1],R=p.prePositionArray[3*I[x+1]+2],B=v[3*I[x+2]],L=v[3*I[x+2]+1],O=p.prePositionArray[3*I[x+2]+2];e.set(T,_,S),e.applyMatrix4(u),e.y=e.z;var P=0;(de=c.isInFlattenRegionDrawing(e,r.ObjectGroupType.TILEGROUP))&&P++,e.set(C,w,R),e.applyMatrix4(u),e.y=e.z,(he=c.isInFlattenRegionDrawing(e,r.ObjectGroupType.TILEGROUP))&&P++,e.set(B,L,O),e.applyMatrix4(u),e.y=e.z,(ce=c.isInFlattenRegionDrawing(e,r.ObjectGroupType.TILEGROUP))&&P++;var D=M[2*I[x]],A=M[2*I[x]+1],N=M[2*I[x+1]],H=M[2*I[x+1]+1],U=M[2*I[x+2]],F=M[2*I[x+2]+1];if(1==P)if(de){v[3*I[x]+2]=de.elevation*h*r.GlobalData.TerrainScale,(ue=b[de.id])||(ue=de.transformPolygon(t),b[de.id]=ue),i.set(T,_),a.set(C,w);var k=r.Utils.linePolygonIntersection(i,a,ue);i.set(B,L),a.set(T,_);var G=r.Utils.linePolygonIntersection(i,a,ue);v.push(k.x),v.push(k.y),v.push(R),v.push(G.x),v.push(G.y),v.push(O),v.push(k.x),v.push(k.y),v.push(de.elevation*h*r.GlobalData.TerrainScale),v.push(G.x),v.push(G.y),v.push(de.elevation*h*r.GlobalData.TerrainScale);var V=(k.x-T)/(C-T+r.Math.EPSILON6),j=(k.y-_)/(w-_+r.Math.EPSILON6),z=(G.x-B)/(T-B+r.Math.EPSILON6),W=(G.y-L)/(_-L+r.Math.EPSILON6);M.push(D+(N-D)*V),M.push(A+(H-A)*j),M.push(U+(D-U)*z),M.push(F+(A-F)*W),M.push(D+(N-D)*V),M.push(A+(H-A)*j),M.push(U+(D-U)*z),M.push(F+(A-F)*W),y.push(0),y.push(0),y.push(1),y.push(0),y.push(0),y.push(1),y.push(0),y.push(0),y.push(1),y.push(0),y.push(0),y.push(1);var q=v.length/3;E.push(q-4),E.push(q-3),E.push(q-1),E.push(q-4),E.push(q-1),E.push(q-2),E.push(E[x+1]),E.push(E[x+2]),E.push(q-3),E.push(E[x+1]),E.push(q-3),E.push(q-4),E[x+1]=q-2,E[x+2]=q-1}else if(he){v[3*I[x+1]+2]=he.elevation*h*r.GlobalData.TerrainScale,(ue=b[he.id])||(ue=he.transformPolygon(t),b[he.id]=ue),i.set(T,_),a.set(C,w);k=r.Utils.linePolygonIntersection(i,a,ue);i.set(C,w),a.set(B,L);var X=r.Utils.linePolygonIntersection(i,a,ue);v.push(k.x),v.push(k.y),v.push(S),v.push(X.x),v.push(X.y),v.push(O),v.push(k.x),v.push(k.y),v.push(he.elevation*h*r.GlobalData.TerrainScale),v.push(X.x),v.push(X.y),v.push(he.elevation*h*r.GlobalData.TerrainScale);V=(k.x-T)/(C-T+r.Math.EPSILON6),j=(k.y-_)/(w-_+r.Math.EPSILON6);var Y=(X.x-C)/(B-C+r.Math.EPSILON6),K=(X.y-w)/(L-w+r.Math.EPSILON6);M.push(D+(N-D)*V),M.push(A+(H-A)*j),M.push(N+(U-N)*Y),M.push(H+(F-H)*K),M.push(D+(N-D)*V),M.push(A+(H-A)*j),M.push(N+(U-N)*Y),M.push(H+(F-H)*K),y.push(0),y.push(0),y.push(1),y.push(0),y.push(0),y.push(1),y.push(0),y.push(0),y.push(1),y.push(0),y.push(0),y.push(1);q=v.length/3;E.push(q-2),E.push(q-1),E.push(q-3),E.push(q-2),E.push(q-3),E.push(q-4),E.push(E[x]),E.push(q-4),E.push(q-3),E.push(E[x]),E.push(q-3),E.push(E[x+2]),E[x]=E[x+1],E[x+1]=q-1,E[x+2]=q-2}else{v[3*I[x+2]+2]=ce.elevation*h*r.GlobalData.TerrainScale,(ue=b[ce.id])||(ue=ce.transformPolygon(t),b[ce.id]=ue),i.set(T,_),a.set(B,L);var Z=r.Utils.linePolygonIntersection(i,a,ue);i.set(B,L),a.set(C,w);var $=r.Utils.linePolygonIntersection(i,a,ue);v.push(Z.x),v.push(Z.y),v.push(S),v.push($.x),v.push($.y),v.push(R),v.push(Z.x),v.push(Z.y),v.push(ce.elevation*h*r.GlobalData.TerrainScale),v.push($.x),v.push($.y),v.push(ce.elevation*h*r.GlobalData.TerrainScale);var Q=(Z.x-T)/(B-T+r.Math.EPSILON6),J=(Z.y-_)/(L-_+r.Math.EPSILON6),ee=($.x-B)/(C-B+r.Math.EPSILON6),te=($.y-L)/(w-L+r.Math.EPSILON6);M.push(D+(U-D)*Q),M.push(A+(F-A)*J),M.push(U+(N-U)*ee),M.push(F+(H-F)*te),M.push(D+(U-D)*Q),M.push(A+(F-A)*J),M.push(U+(N-U)*ee),M.push(F+(H-F)*te),y.push(0),y.push(0),y.push(1),y.push(0),y.push(0),y.push(1),y.push(0),y.push(0),y.push(1),y.push(0),y.push(0),y.push(1);q=v.length/3;E.push(q-4),E.push(q-1),E.push(q-2),E.push(q-4),E.push(q-3),E.push(q-1),E.push(E[x]),E.push(E[x+1]),E.push(q-3),E.push(E[x]),E.push(q-3),E.push(q-4),E[x]=E[x+2],E[x+1]=q-2,E[x+2]=q-1}else if(2==P)if(de)if(he){v[3*I[x]+2]=de.elevation*h*r.GlobalData.TerrainScale,v[3*I[x+1]+2]=he.elevation*h*r.GlobalData.TerrainScale,(fe=b[de.id])||(fe=de.transformPolygon(t),b[de.id]=fe),(me=b[he.id])||(me=he.transformPolygon(t),b[he.id]=me),i.set(T,_),a.set(B,L),(Z=r.Utils.linePolygonIntersection(i,a,fe))||(Z=r.Utils.linePolygonIntersection(i,a,me)),i.set(B,L),a.set(C,w),($=r.Utils.linePolygonIntersection(i,a,fe))||($=r.Utils.linePolygonIntersection(i,a,me)),v.push(Z.x),v.push(Z.y),v.push(de.elevation*h*r.GlobalData.TerrainScale),v.push($.x),v.push($.y),v.push(de.elevation*h*r.GlobalData.TerrainScale),v.push(Z.x),v.push(Z.y),v.push(O),v.push($.x),v.push($.y),v.push(O);Q=(Z.x-T)/(B-T+r.Math.EPSILON6),J=(Z.y-_)/(L-_+r.Math.EPSILON6),ee=($.x-B)/(C-B+r.Math.EPSILON6),te=($.y-L)/(w-L+r.Math.EPSILON6);M.push(D+(U-D)*Q),M.push(A+(F-A)*J),M.push(U+(N-U)*ee),M.push(F+(H-F)*te),M.push(D+(U-D)*Q),M.push(A+(F-A)*J),M.push(U+(N-U)*ee),M.push(F+(H-F)*te),y.push(0),y.push(0),y.push(1),y.push(0),y.push(0),y.push(1),y.push(0),y.push(0),y.push(1),y.push(0),y.push(0),y.push(1);q=v.length/3;E.push(E[x]),E.push(q-3),E.push(q-4),E.push(q-4),E.push(q-3),E.push(q-1),E.push(q-4),E.push(q-1),E.push(q-2),E.push(E[x+2]),E.push(q-2),E.push(q-1),E[x+2]=q-3}else{v[3*I[x]+2]=de.elevation*h*r.GlobalData.TerrainScale,v[3*I[x+2]+2]=ce.elevation*h*r.GlobalData.TerrainScale,(fe=b[de.id])||(fe=de.transformPolygon(t),b[de.id]=fe),(ge=b[ce.id])||(ge=ce.transformPolygon(t),b[ce.id]=ge),i.set(T,_),a.set(C,w),(k=r.Utils.linePolygonIntersection(i,a,fe))||(k=r.Utils.linePolygonIntersection(i,a,ge)),i.set(C,w),a.set(B,L),(X=r.Utils.linePolygonIntersection(i,a,fe))||(X=r.Utils.linePolygonIntersection(i,a,ge)),v.push(k.x),v.push(k.y),v.push(de.elevation*h*r.GlobalData.TerrainScale),v.push(X.x),v.push(X.y),v.push(de.elevation*h*r.GlobalData.TerrainScale),v.push(k.x),v.push(k.y),v.push(R),v.push(X.x),v.push(X.y),v.push(R);V=(k.x-T)/(C-T+r.Math.EPSILON6),j=(k.y-_)/(w-_+r.Math.EPSILON6),Y=(X.x-C)/(B-C+r.Math.EPSILON6),K=(X.y-w)/(L-w+r.Math.EPSILON6);M.push(D+(N-D)*V),M.push(A+(H-A)*j),M.push(N+(U-N)*Y),M.push(H+(F-H)*K),M.push(D+(N-D)*V),M.push(A+(H-A)*j),M.push(N+(U-N)*Y),M.push(H+(F-H)*K),y.push(0),y.push(0),y.push(1),y.push(0),y.push(0),y.push(1),y.push(0),y.push(0),y.push(1),y.push(0),y.push(0),y.push(1);q=v.length/3;E.push(E[x+2]),E.push(q-4),E.push(q-3),E.push(q-2),E.push(q-3),E.push(q-4),E.push(q-2),E.push(q-1),E.push(q-3),E.push(E[x+1]),E.push(q-1),E.push(q-2),E[x+1]=q-4}else{v[3*I[x+1]+2]=he.elevation*h*r.GlobalData.TerrainScale,v[3*I[x+2]+2]=ce.elevation*h*r.GlobalData.TerrainScale,(me=b[he.id])||(me=he.transformPolygon(t),b[he.id]=me),(ge=b[ce.id])||(ge=ce.transformPolygon(t),b[ce.id]=ge),i.set(T,_),a.set(C,w),(k=r.Utils.linePolygonIntersection(i,a,me))||(k=r.Utils.linePolygonIntersection(i,a,ge)),i.set(B,L),a.set(T,_),(G=r.Utils.linePolygonIntersection(i,a,me))||(G=r.Utils.linePolygonIntersection(i,a,ge)),v.push(k.x),v.push(k.y),v.push(he.elevation*h*r.GlobalData.TerrainScale),v.push(G.x),v.push(G.y),v.push(he.elevation*h*r.GlobalData.TerrainScale),v.push(k.x),v.push(k.y),v.push(S),v.push(G.x),v.push(G.y),v.push(S);var V=(k.x-T)/(C-T+r.Math.EPSILON6),j=(k.y-_)/(w-_+r.Math.EPSILON6);z=(G.x-B)/(T-B+r.Math.EPSILON6),W=(G.y-L)/(_-L+r.Math.EPSILON6);M.push(D+(N-D)*V),M.push(A+(H-A)*j),M.push(U+(D-U)*z),M.push(F+(A-F)*W),M.push(D+(N-D)*V),M.push(A+(H-A)*j),M.push(U+(D-U)*z),M.push(F+(A-F)*W),y.push(0),y.push(0),y.push(1),y.push(0),y.push(0),y.push(1),y.push(0),y.push(0),y.push(1),y.push(0),y.push(0),y.push(1);var q=v.length/3;E.push(E[x+1]),E.push(E[x+2]),E.push(q-3),E.push(q-4),E.push(q-1),E.push(q-2),E.push(q-4),E.push(q-3),E.push(q-1),E.push(E[x]),E.push(q-2),E.push(q-1),E[x]=E[x+1],E[x+1]=q-3,E[x+2]=q-4}else 3==P&&(v[3*I[x]+2]=de.elevation*h*r.GlobalData.TerrainScale,v[3*I[x+1]+2]=he.elevation*h*r.GlobalData.TerrainScale,v[3*I[x+2]+2]=ce.elevation*h*r.GlobalData.TerrainScale)}p.setIndex(E),p.deleteAttribute("position"),p.deleteAttribute("uv"),p.deleteAttribute("normal"),p.setAttribute("position",new THREE.Float32BufferAttribute(v,3)),p.setAttribute("uv",new THREE.Float32BufferAttribute(M,2)),p.setAttribute("normal",new THREE.Float32BufferAttribute(y,3)),p.computeBoundingBox(),p.computeBoundingSphere()}if(m){m.prePositionArray||(m.prePositionArray=[...m.attributes.position.array]);var ie=[...m.prePositionArray];if(!f){let n=[];const s=[];for(var re=0;re<=o;++re){const e=[];for(var ae=0;ae<=o;++ae)d||0!==re&&re!==o&&(ae===o?n.push(g):0===ae&&s.push(g)),e.push(g),g++;0===re?n=n.concat(e):re===o&&(n=n.concat(e.slice().reverse()))}var ne=y.slice(0,p.preNormalArray.length),se=v.slice(0,p.prePositionArray.length);n=n.concat(s.reverse());const l=(new THREE.Vector3).fromArray(se).distanceTo((new THREE.Vector3).fromArray(se,3));for(x=0;x<n.length;x++){const e=6*x,t=3*n[x];ie[e+2]=se[t+2],ie[e+5]=se[t+2]-ne[t+2]*l}var oe=m.index.array,le=[...ie];for(x=0;x<oe.length;x+=3){T=ie[3*oe[x]],_=ie[3*oe[x]+1],S=m.prePositionArray[3*oe[x]+2],C=ie[3*oe[x+1]],w=ie[3*oe[x+1]+1],R=m.prePositionArray[3*oe[x+1]+2],B=ie[3*oe[x+2]],L=ie[3*oe[x+2]+1],O=m.prePositionArray[3*oe[x+2]+2];e.set(T,_,S),e.applyMatrix4(u),e.y=e.z;var de,he,ce;P=0;if((de=c.isInFlattenRegionDrawing(e,r.ObjectGroupType.TILEGROUP))&&P++,e.set(C,w,R),e.applyMatrix4(u),e.y=e.z,(he=c.isInFlattenRegionDrawing(e,r.ObjectGroupType.TILEGROUP))&&P++,e.set(B,L,O),e.applyMatrix4(u),e.y=e.z,(ce=c.isInFlattenRegionDrawing(e,r.ObjectGroupType.TILEGROUP))&&P++,1==P){if(de)(ue=b[de.id])||(ue=de.transformPolygon(t),b[de.id]=ue),i.set(T,_),a.set(C,w),pe=r.Utils.linePolygonIntersection(i,a,ue);else if(he){(ue=b[he.id])||(ue=he.transformPolygon(t),b[he.id]=ue),i.set(T,_),a.set(C,w),pe=r.Utils.linePolygonIntersection(i,a,ue)}else{var ue;(ue=b[ce.id])||(ue=ce.transformPolygon(t),b[ce.id]=ue),i.set(T,_),a.set(B,L),pe=r.Utils.linePolygonIntersection(i,a,ue)}pe&&(le[3*oe[x]]=pe.x,le[3*oe[x]+1]=pe.y,le[3*oe[x+1]]=pe.x,le[3*oe[x+1]+1]=pe.y,le[3*oe[x+2]]=pe.x,le[3*oe[x+2]+1]=pe.y)}else if(2==P){var pe;if(de)if(he){var me;(fe=b[de.id])||(fe=de.transformPolygon(t),b[de.id]=fe),(me=b[he.id])||(me=he.transformPolygon(t),b[he.id]=me),i.set(T,_),a.set(B,L),(pe=r.Utils.linePolygonIntersection(i,a,fe))||(pe=r.Utils.linePolygonIntersection(i,a,me))}else{var fe,ge;(fe=b[de.id])||(fe=de.transformPolygon(t),b[de.id]=fe),(ge=b[ce.id])||(ge=ce.transformPolygon(t),b[ce.id]=ge),i.set(T,_),a.set(C,w),(pe=r.Utils.linePolygonIntersection(i,a,fe))||(pe=r.Utils.linePolygonIntersection(i,a,ge))}else(me=b[he.id])||(me=he.transformPolygon(t),b[he.id]=me),(ge=b[ce.id])||(ge=ce.transformPolygon(t),b[ce.id]=ge),i.set(T,_),a.set(C,w),(pe=r.Utils.linePolygonIntersection(i,a,me))||(pe=r.Utils.linePolygonIntersection(i,a,ge));pe&&(le[3*oe[x]]=pe.x,le[3*oe[x]+1]=pe.y,le[3*oe[x+1]]=pe.x,le[3*oe[x+1]+1]=pe.y,le[3*oe[x+2]]=pe.x,le[3*oe[x+2]+1]=pe.y)}}ie=le}m.deleteAttribute("position"),m.setAttribute("position",new THREE.Float32BufferAttribute(ie,3))}}computeSideNormal(e,t,i,r){for(var a=t.length,n=0;n<a;++n){var s=t[n],o=r[n],l=(e.attributes.normal.array[3*s]+i.attributes.normal.array[3*o])/2;e.attributes.normal.array[3*s]=l,i.attributes.normal.array[3*o]=l;var d=(e.attributes.normal.array[3*s+1]+i.attributes.normal.array[3*o+1])/2;e.attributes.normal.array[3*s+1]=d,i.attributes.normal.array[3*o+1]=d;var h=(e.attributes.normal.array[3*s+2]+i.attributes.normal.array[3*o+2])/2;e.attributes.normal.array[3*s+2]=h,i.attributes.normal.array[3*o+2]=h}}computeNearNormal(e,t,i,r){for(var a=0,n=1,s=new Array(i+1),o=0;o<=i;++o)s[o]=a+n*o;a=0,n=i+1;var l=new Array(i+1);for(o=0;o<=i;++o)l[o]=a+n*o;a=i,n=i+1;var d=new Array(i+1);for(o=0;o<=i;++o)d[o]=a+n*o;a=i*(i+1),n=1;var h=new Array(i+1);for(o=0;o<=i;++o)h[o]=a+n*o;"left"===r&&this.computeSideNormal(e,l,t,d),"right"===r&&this.computeSideNormal(e,d,t,l),"top"===r&&this.computeSideNormal(e,s,t,h),"bottom"===r&&this.computeSideNormal(e,h,t,s)}}r.Tile.PlaneTileBuilder=n})();class W extends r.Tile.TileBuilder{constructor(){super()}destroy(){}computeBuffer(e,t,i,a,n,s,o){o=o||r.Tile.TileMath.unitScale;const l={index:null,position:null,normal:null,uvs:[],center:null};a=null==a?16:a;var d=r.Tile.TileMath.tile2boundingBox(e,t,i),h=(d.east+d.west)/2,c=(d.north+d.south)/2,u=r.Tile.TileMath.fromDegrees(h,c),p=(d.east-d.west)/a,m=(d.north-d.south)/a;l.center=u;const f=(a+1)*(a+1)+(n?0:4*a);l.position=new Float32Array(3*f),l.normal=new Float32Array(3*f),l.uvs=new Float32Array(3*f);let g=[];const v=[];let y=0;for(var M,E,b,I=1/a,x=0;x<=a;++x){const e=[];E=d.south+m*x;for(var T=0;T<=a;++T){M=d.west+p*T,b=r.Tile.TileMath.fromDegrees(M,E),l.position[3*y]=(b.x-u.x)*o,l.position[3*y+1]=(b.y-u.y)*o,l.position[3*y+2]=(b.z-u.z)*o;var _=b.clone().normalize();l.normal[3*y]=_.x,l.normal[3*y+1]=_.y,l.normal[3*y+2]=_.z,s&&(l.position[3*y]+=_.x*s[a-x][T]*o*r.GlobalData.TerrainScale,l.position[3*y+1]+=_.y*s[a-x][T]*o*r.GlobalData.TerrainScale,l.position[3*y+2]+=_.z*s[a-x][T]*o*r.GlobalData.TerrainScale);var S=x*I,C=T*I;l.uvs[2*y]=C,l.uvs[2*y+1]=S,n||0!==x&&x!==a&&(T===a?g.push(y):0===T&&v.push(y)),e.push(y),y++}0===x?g=g.concat(e):x===a&&(g=g.concat(e.slice().reverse()))}var w=this.getIndexBySeg(a);const R=y;return n||(w=this.createSkirt(g,v,y,R,l,w)),l.index=w,l}}r.Tile.GlobeTileBuilder=W,(()=>{let e=new THREE.Vector3;r.Tile.TileTextureManager=class{constructor(e,t){this.viewer=e,!this.viewer||!this.viewer instanceof r.Viewer?console.log("ERROR::viewer must not be empty or viewer2d."):!t.startPosition||t.startPosition<2?console.log("ERROR::startPosition must not be empty or less than 2 in length."):!t.endPosition||t.endPosition<2?console.log("ERROR::endPosition must not be empty or less than 2 in length."):r.Tile.TileMath.isLongitude(t.startPosition[0])&&r.Tile.TileMath.isLongitude(t.endPosition[0])&&r.Tile.TileMath.isLatitude(t.startPosition[1])&&r.Tile.TileMath.isLatitude(t.startPosition[1])?t.startPosition[0]>t.endPosition[0]||t.startPosition[1]>t.endPosition[1]?console.log("ERROR::range definition error."):Math.abs(t.startPosition[0]-t.endPosition[0])>.2||Math.abs(t.startPosition[1]-t.endPosition[1])>.2?console.log(" Longitude or latitude range is too big."):(r.GlobalData.EnableGisMap=!0,r.GlobalData.ConstraintZoom=!1,this.westEdge=t.startPosition[0],this.eastEdge=t.endPosition[0],this.northEdge=t.endPosition[1],this.southEdge=t.startPosition[1],this.mapCount=0,this.externalObjectId="tilePlane",this.geometry=null,this.tileMaterials=new Array,!t.modelPosition||t.modelPosition<2?console.log("ERROR::model position must not be empty or less than 2 in length."):r.Tile.TileMath.isLongitude(t.modelPosition[0])&&r.Tile.TileMath.isLatitude(t.modelPosition[1])?(this.modelLongitude=t.modelPosition[0],this.modelLatitude=t.modelPosition[1],this.modelLongitude<this.westEdge||this.modelLongitude>this.eastEdge||this.modelLatitude<this.southEdge||this.modelLatitude>this.northEdge?console.log("ERROR::the input position must in range"):(this.zoom=t.zoom,this.zoom<0||this.zoom>18?console.log("ERROR::the input zoom is invalid"):(this.height=0,this.externalComponentManager=new r.ExternalComponentManager(e)))):console.log("ERROR::number exceeds normal latitude and longitude range.")):console.log("ERROR::number exceeds normal latitude and longitude range.")}destroy(){this.viewer=null,this.westEdge=null,this.eastEdge=null,this.northEdge=null,this.southEdge=null,this.mapCount=null,this.externalObjectId=null,this.geometry=null,this.tileMaterials=null,this.modelLongitude=null,this.modelLatitude=null,this.zoom=null,this.height=null,this.externalComponentManager=null,this.tileLength=null,this.topTile=null,this.leftTile=null,this.bottomTile=null,this.rightTile=null,this.planeWidth=null,this.planeHeight=null,this.mapCount=null,this.geometry=null,this.tilesMesh=null,this.tileArray[xIndex]=null}loadMapsByZoom(e,t){this.zoom=e,this.tileLength=r.Tile.TileMath.mercatorPerimeter/Math.pow(2,this.zoom)*r.Tile.TileMath.unitScale*2,this.tileArray=new Array,this.topTile=r.Tile.TileMath.lat2tile(this.northEdge,this.zoom),this.leftTile=r.Tile.TileMath.long2tile(this.westEdge,this.zoom),this.bottomTile=r.Tile.TileMath.lat2tile(this.southEdge,this.zoom),this.rightTile=r.Tile.TileMath.long2tile(this.eastEdge,this.zoom),this.planeWidth=this.rightTile-this.leftTile+1,this.planeHeight=this.bottomTile-this.topTile+1,this.mapCount=this.planeWidth*this.planeHeight,this.geometry=new THREE.PlaneGeometry(this.tileLength*this.planeWidth,this.tileLength*this.planeHeight,this.planeWidth,this.planeHeight),this.tilesMesh=null;var i=this,a=0;for(let e=i.leftTile;e<=i.rightTile;++e){let o=e-i.leftTile;i.tileArray[o]=new Array;for(let l=i.topTile;l<=i.bottomTile;++l){let d=l-i.topTile;if(i.tileArray[o][d]={},i.tileArray[o][d].x=o*i.tileLength,i.tileArray[o][d].y=-d*i.tileLength,i.tileArray[o][d].center=new THREE.Vector3((o+.5)*i.tileLength,-(d+.5)*i.tileLength,i.height),i.tileArray[o][d].bound=r.Tile.TileMath.tile2boundingBox(e,l,i.zoom),!(e>i.rightTile||l>i.bottomTile)){var n=`https://mt3.google.cn/vt/lyrs=y&hl=zh-CN&gl=cn&x=${e}&y=${l}&z=${i.zoom}`,s=new THREE.TextureLoader;s.crossOrigin=!0,s.load(n,(function(e){var r=new THREE.MeshBasicMaterial({map:e,transparent:!0,side:THREE.DoubleSide}),n=o+d*(i.rightTile-i.leftTile+1);i.geometry.faces[2*n].materialIndex=n,i.geometry.faces[2*n+1].materialIndex=n,i.geometry.faceVertexUvs[0][2*n]=[new THREE.Vector2(0,1),new THREE.Vector2(0,0),new THREE.Vector2(1,1)],i.geometry.faceVertexUvs[0][2*n+1]=[new THREE.Vector2(0,0),new THREE.Vector2(1,0),new THREE.Vector2(1,1)],i.tileMaterials[n]=r,++a>=i.mapCount&&i.onTextureLoaded(t)}))}}}}onTextureLoaded(t){this.tilesMesh=new THREE.Mesh(this.geometry,this.tileMaterials);var i=this.externalComponentManager.objectIds;null!=i&&-1!=i.indexOf(this.externalObjectId)&&this.viewer.removeNodeById(this.externalObjectId),this.externalComponentManager.addNode(this.externalObjectId,this.tilesMesh),this.positionX=0,this.positionY=0;for(var r=0,a=this.tileArray.length;r<a;r++)for(var n=0,s=this.tileArray[r].length;n<s;n++)if(this.tileArray[r][n].bound.west<=this.modelLongitude&&this.modelLongitude<this.tileArray[r][n].bound.east&&this.tileArray[r][n].bound.south<=this.modelLatitude&&this.modelLatitude<this.tileArray[r][n].bound.north){var o=(this.modelLongitude-this.tileArray[r][n].bound.west)/(this.tileArray[r][n].bound.east-this.tileArray[r][n].bound.west),l=(this.modelLatitude-this.tileArray[r][n].bound.south)/(this.tileArray[r][n].bound.north-this.tileArray[r][n].bound.south);this.positionX=-(r+o)*this.tileLength+this.planeWidth/2*this.tileLength,this.positionY=-(s-n-1+l)*this.tileLength+this.planeHeight/2*this.tileLength;break}var d=new THREE.Quaternion,h=this.viewer.getScene().getBoundingBoxWorld(),c=h.getCenter(e);this.externalComponentManager.setTransform(this.externalObjectId,new THREE.Vector3(this.positionX+c.x,this.positionY+c.y,h.min.z),new THREE.Vector3(1,1,1),d),this.viewer.render(),t&&t()}}})(),function(){let e=new THREE.Vector3;r.Tile.TileDemandManager=class{constructor(e,t){if(this.viewer=e,!this.viewer||!this.viewer instanceof r.Viewer)console.log("ERROR::viewer must not be empty or viewer2d.");else if(!t.modelPosition||t.modelPosition<2)console.log("ERROR::model position must not be empty or less than 2 in length.");else if(r.Tile.TileMath.isLongitude(t.modelPosition[0])&&r.Tile.TileMath.isLatitude(t.modelPosition[1]))if(this.zoom=t.zoom?t.zoom:17,this.zoom<1||this.zoom>18)console.log("ERROR::the input zoom is invalid");else{this.zoom<11&&console.warn("Tile resolution may be too low"),r.GlobalData.EnableGisMap=!0,r.GlobalData.ConstraintZoom=!1,this.modelLongitude=t.modelPosition[0],this.modelLatitude=t.modelPosition[1],this.tileArray={},this.tileArray[this.zoom]={},this.externalObjectId="tileDemandPlane",this.tileLimit=t.tileLimit?t.tileLimit:40,this.modelOffset=t.modelOffset,this.allGroup=new THREE.Group,this.groupArray={},this.groupArray[this.zoom]=new THREE.Group,this.allGroup.add(this.groupArray[this.zoom]),this.externalComponentManager=new r.ExternalComponentManager(e);var i=this.externalComponentManager.objectIds;null!=i&&-1!=i.indexOf(this.externalObjectId)&&this.viewer.removeNodeById(this.externalObjectId),this.externalComponentManager.addNode(this.externalObjectId,this.allGroup),this.globalMatrix=this.viewer.modelManager.getMatrixWorldGlobal(),this.globalMatrixInverse=new THREE.Matrix4,this.globalMatrixInverse.copy(this.globalMatrix).invert(),this.loader=new THREE.TextureLoader,this.loader.crossOrigin=!0,this.modelBox=this.viewer.getScene().getBoundingBoxWorld();var a=this;this.loader.load("https://mt3.google.cn/vt/lyrs=y&hl=zh-CN&gl=cn&x=0&y=0&z=0",(function(e){a.groupArray[0]=new THREE.Group;var t=new THREE.SphereGeometry(r.Tile.TileMath.earthRadius,200,200);t.translate(5517447847.510659,3185499999.9999995,0);var i=new THREE.MeshLambertMaterial({map:e,overdraw:.5}),n=new THREE.Mesh(t,i);a.groupArray[0].add(n)}));a=this;this.viewer.registerEventListener(r.EVENTS.ON_CAMERA_CHANGED_AND_RENDERED,(function(e){var t=a.viewer.rendererManager.renderer.domElement.height,i=a.viewer.camera.position.clone().applyMatrix4(a.globalMatrixInverse),r=a.calculateZoom(i,t);if(r!=a.zoom){if(a.allGroup.remove(a.groupArray[a.zoom]),0==r)return a.allGroup.add(a.groupArray[0]),a.allGroup.updateMatrixWorld(!0),void(a.zoom=r);null==a.groupArray[r]&&(a.groupArray[r]=new THREE.Group),a.allGroup.add(a.groupArray[r])}0!=r&&(a.zoom=r,a.updateZoom(r))}))}else console.log("ERROR::number exceeds normal latitude and longitude range.")}destroy(){this.viewer=null,this.zoom=null,this.modelLongitude=null,this.modelLatitude=null,this.tileArray=null,this.externalObjectId=null,this.modelOffset=null,this.tileLimit=null,this.allGroup=null,this.groupArray=null,this.tileMaterials=null,this.globalMatrix=null,this.globalMatrixInverse=null,this.loader=null,this.modelBox=null,this.tileLength=null,this.modelTileX=null,this.modelTileY=null,this.offset=null,this.inGeometry=null,this.tileBox=null,this.externalComponentManager=null}calculateZoom(e,t){return this.zoom}updateZoom(t){null==this.tileArray[t]&&(this.tileArray[t]={}),this.tileLength=r.Tile.TileMath.mercatorPerimeter/Math.pow(2,t)*r.Tile.TileMath.unitScale*2,this.modelTileX=r.Tile.TileMath.long2tile(this.modelLongitude,t),this.modelTileY=r.Tile.TileMath.lat2tile(this.modelLatitude,t);var i=r.Tile.TileMath.tile2boundingBox(this.modelTileX,this.modelTileY,t),a=(this.modelLongitude-i.west)/(i.east-i.west),n=(this.modelLatitude-i.north)/(i.north-i.south);this.modelBox.getCenter(e);var s=-a*this.tileLength+.5*this.tileLength+e.x,o=-n*this.tileLength-.5*this.tileLength+e.y;this.offset=new THREE.Vector3(s,o,this.modelBox.min.z-this.modelOffset*r.Tile.TileMath.unitScale);var l=new THREE.Quaternion;this.externalComponentManager.setTransform(this.externalObjectId,this.offset,new THREE.Vector3(1,1,1),l),this.inGeometry=new THREE.PlaneBufferGeometry(this.tileLength,this.tileLength),this.inGeometry.computeBoundingBox(),this.tileBox=this.inGeometry.boundingBox,this.addTile(this.modelTileX,this.modelTileY,new THREE.Vector3(0),t),this.updateGroup(t)}addTile(e,t,i,r,a){var n=this;return n.tileArray[r][e]&&n.tileArray[r][e][t]?(n.tileArray[r][e][t].visible=!0,void n.allGroup.updateMatrixWorld(!0)):new Promise((function(s,o){var l=`https://mt3.google.cn/vt/lyrs=y&hl=zh-CN&gl=cn&x=${e}&y=${t}&z=${r}`;n.loader.load(l,(function(o){o.wrapS=THREE.ClampToEdgeWrapping,o.wrapT=THREE.ClampToEdgeWrapping;var l=new THREE.MeshBasicMaterial({map:o,transparent:!0,side:THREE.DoubleSide}),d=n.inGeometry.clone();d.translate(i.x,i.y,i.z);var h=new THREE.Mesh(d,l);null==n.tileArray[r][e]&&(n.tileArray[r][e]={}),n.tileArray[r][e][t]||(n.tileArray[r][e][t]=h,h.name=`${r}-${e}-${t}`,n.groupArray[r].add(h),n.allGroup.updateMatrixWorld(!0)),s(a)}))}))}updateGroup(e){var t=this,i=t.viewer.camera;i.updateMatrix(),i.updateMatrixWorld(),this.frustum=new THREE.Frustum,this.frustum.setFromProjectionMatrix((new THREE.Matrix4).multiplyMatrices(i.projectionMatrix,i.matrixWorldInverse));for(var r=t.modelTileX,a=t.modelTileY,n=2;n<t.tileLimit;){for(var s=1;s<n;s++)r+=1,t.addNode(r,a,e);for(s=1;s<n;s++)a+=1,t.addNode(r,a,e);n++;for(s=1;s<n;s++)r-=1,t.addNode(r,a,e);for(s=1;s<n;s++)a-=1,t.addNode(r,a,e);n++}}addNode(e,t,i){if(!(e>=Math.pow(2,i)||e<0||t>=Math.pow(2,i)||t<0)){var r=this,a=(e-r.modelTileX)*r.tileLength,n=-(t-r.modelTileY)*r.tileLength,s=new THREE.Vector3(a+r.offset.x,n+r.offset.y,r.offset.z);this.tileBox=this.inGeometry.boundingBox;var o=this.tileBox.clone();if(o.translate(s),o.applyMatrix4(r.globalMatrix),r.frustum.intersectsBox(o)){var l=new THREE.Vector3(a,n,0);r.addTile(e,t,l,i,void 0)}else null!=r.tileArray[i][e]&&null!=r.tileArray[i][e][t]&&(r.tileArray[i][e][t].visible=!1)}}}}();r.Tile.TileManager=class{constructor(e,t,i){this.modelLayer=e,this.viewer=e.viewer,!this.viewer||!this.viewer instanceof r.Viewer?console.log("ERROR::viewer must not be empty or viewer2d."):!t.modelPosition||t.modelPosition<2?console.log("ERROR::model position must not be empty or less than 2 in length."):r.Tile.TileMath.isLongitude(t.modelPosition[0])&&r.Tile.TileMath.isLatitude(t.modelPosition[1])?(r.GlobalData.EnableGisMap=!0,this.modelLongitude=t.modelPosition[0],this.modelLatitude=t.modelPosition[1],this.tileAroundNum=8,this.maxZoom=t.maxZoom,this.modelTileX=r.Tile.TileMath.long2tile(this.modelLongitude,this.maxZoom),this.modelTileY=r.Tile.TileMath.lat2tile(this.modelLatitude,this.maxZoom),this.basePoint=t.basePoint,this.modelRotationZ=t.modelRotationZ,this.modelAltitude=t.modelAltitude,this.globalLayer={},this.tileGroup=i,this.tileGroup.altitudeOffset=this.modelAltitude,this.loader=new THREE.TextureLoader,this.loader.crossOrigin=!0,this.globalMatrix=this.viewer.modelManager.getMatrixWorldGlobal(),this.globalMatrixInverse=new THREE.Matrix4,this.globalMatrixInverse.copy(this.globalMatrix).invert(),this.frustum=new THREE.Frustum,this.earthMatrix=this.tileGroup.matrixWorld,t.terrainOnlineConfig&&this.dealOnlineTerrainConfig(t.terrainOnlineConfig),this.useTerrain=t.useTerrain,this.renderFunction=null,this.tileOpacity=t.opacity,this.mapStyle=t.mapStyle||{},this.mapExcavation=t.mapExcavation||{},this.materialMap={},this.disableSkirt=!1,this.mapUrl=t.mapUrl,this.layerList=[],this.baseRenderOrder=10,this.seg=16,this.terrainScheduler=new r.Tile.TerrainScheduler(6,(this.seg+1)*(this.seg+1)*2),t.maxTerrainLevel&&t.useTerrain&&(this.maxTerrainLevel=t.maxTerrainLevel,this.minTerrainLevel=t.minTerrainLevel,this.maxTerrainLevel+4<this.maxZoom&&(this.maxZoom=this.maxTerrainLevel+4)),this.modelTileAttitude=0,t.terrainPath?this.dataUrl=new r.Tile.DemUrl(t.terrainPath):this.dataUrl=t.dataUrl,this.isCreated=!1,this.terrainTileCount=0,this.tileCount=0,this.useClipping=t.useClipping,this.imageryProviderType=r.Utils.defaultValue(t.imageryProviderType,"UrlTemplate"),this.imageryProvider=new r.Layer.ImageryProviderFactory[this.imageryProviderType]({mapUrl:t.mapUrl}),this._contentReadyDeferred=void 0,this._requestCount=-1):console.log("ERROR::number exceeds normal latitude and longitude range.")}destroy(){this.clearTiles(),this.terrainScheduler.destroy(),this.terrainScheduler=null,this.modelLongitude=null,this.modelLatitude=null,this.tileAroundNum=null,this.maxZoom=null,this.modelTileX=null,this.modelTileY=null,this.globalLayer=null,this.tileGroup.clear(),this.tileGroup=null,this.loader=null,this.globalMatrix=null,this.globalMatrixInverse=null,this.frustum=null,this.earthMatrix=null,this.useTerrain=null,this.modelRotationZ=null,this.basePoint=null,this.modelAltitude=null,this.tileOpacity=null,this.mapStyle=null,this.mapExcavation=null,this.materialMap=null,this.disableSkirt=null,this.mapUrl=null,this.layerList=null,this.baseRenderOrder=void 0,this.seg=void 0,this.maxTerrainLevel=void 0,this.modelTileAttitude=void 0,this.dataUrl=null,this.isCreated=void 0,this.terrainTileCount=void 0,this.tileCount=void 0,this.modelLayer=void 0,this.removeRenderCallback(),this._contentReadyDeferred&&(this._contentReadyDeferred.destroy(),this._contentReadyDeferred=void 0),this.viewer=void 0,this.imageryProviderType=void 0,this.imageryProvider=null,this._requestCount=-1}getLayer(){return this.modelLayer}dealOnlineTerrainConfig(e){(this.modelLongitude<e.longitude[0]||this.modelLongitude>e.longitude[1]||this.modelLatitude<e.latitude[0]||this.modelLatitude>e.latitude[1])&&console.warn("the model LongLat not in online terrain Scale"),this.terrainZoomScale=e.zoom;const t=e.boundary,i=t.leftX,r=t.rightX,a=t.upY,n=t.bottomY;this.textureXYZScale={};const s=this.terrainZoomScale[0];this.textureXYZScale[s]={},this.textureXYZScale[s].leftX=i+1,this.textureXYZScale[s].rightX=r-1,this.textureXYZScale[s].upY=a+1,this.textureXYZScale[s].bottomY=n-1;for(let e=this.terrainZoomScale[0]+1;e<=this.terrainZoomScale[1]+4;++e)this.textureXYZScale[e]={},this.textureXYZScale[e].leftX=2*this.textureXYZScale[e-1].leftX,this.textureXYZScale[e].rightX=2*this.textureXYZScale[e-1].rightX,this.textureXYZScale[e].upY=2*this.textureXYZScale[e-1].upY,this.textureXYZScale[e].bottomY=2*this.textureXYZScale[e-1].bottomY}addExternalObject(){var e=this.externalComponentManager.objectIds;null!=e&&-1!=e.indexOf(this.externalObjectId)&&this.viewer.removeNodeById(this.externalObjectId),this.externalComponentManager.addNode(this.externalObjectId,this.tileGroup)}onLoadTerrain(){!1===this.isCreated&&(!1===this.useTerrain||this.terrainTileCount<=0)&&(this.isCreated=!0,this.viewer.modelManager.dispatchEvent({type:r.EVENTS.ON_MAP_CREATED}))}addRenderCallback(){var e=this;this.renderFunction=function(){e.updateEarth(),e.tileGroup.updateMatrixWorld(!0);for(var t=e.layerList.length,i=0;i<t;++i){e.layerList[i].tileGroup.updateMatrixWorld(!0)}},e.viewer.addCallbacks(r.EnumRenderCallbackType.PRE_RENDER,e.renderFunction),e.viewer.render()}removeRenderCallback(){this.renderFunction&&(this.viewer.removeCallbacks(r.EnumRenderCallbackType.PRE_RENDER,this.renderFunction),this.renderFunction=null)}updateModelLngLatByBasePoint(){}updateEarthMatrix(){}show(){this.tileGroup?this.tileGroup.visible=!0:console.warn("The tile doesn't exist.")}hide(){this.tileGroup?this.tileGroup.visible=!1:console.warn("The tile doesn't exist.")}hideAllLayers(){this.hide();for(const e of this.layerList)e.hide()}showAllLayers(){this.show();for(const e of this.layerList)e.show()}getModelRotationZ(){return this.modelRotationZ}setModelRotationZ(e){this.modelRotationZ=e,this.updateEarthMatrix()}getBasePoint(){return this.basePoint}getModelPosition(){return[this.modelLongitude,this.modelLatitude]}setModelPosition(e){this.clearTiles(),this.modelLongitude=e[0],this.modelLatitude=e[1],this.modelTileX=r.Tile.TileMath.long2tile(this.modelLongitude,this.maxZoom),this.modelTileY=r.Tile.TileMath.lat2tile(this.modelLatitude,this.maxZoom),this.updateEarthMatrix()}getModelAltitude(){return this.modelAltitude}setModelAltitude(e){this.modelAltitude=e,this.tileGroup.altitudeOffset=this.modelAltitude,this.updateEarthMatrix()}setModelRotationZ(e){this.modelRotationZ=e,this.updateEarthMatrix()}getLayerById(e){for(const t of this.layerList)if(t.id===e)return t}getOpacity(e){if(void 0===e)return this.tileOpacity;return this.getLayerById(e).opacity}setOpacity(e,t){if(void 0===t)this.tileOpacity=e;else{this.getLayerById(t).opacity=e}for(var i in this.materialMap)this.materialMap[i].opacity=this.tileOpacity,1-this.tileOpacity>r.Tile.DemTilesUtil.TWO_ACCURACY?this.materialMap[i].transparent=!0:this.materialMap[i].transparent=!1;1-this.tileOpacity>r.Tile.DemTilesUtil.TWO_ACCURACY?this.hideSkirt():this.showSkirt()}setStyle(e,t){if(e)if(t){const i=this.getLayerById(t);if(void 0===i)return;i.setStyle(e)}else for(var i in this.mapStyle=e,this.materialMap){var r=this.materialMap[i];r.updateStyle&&r.updateStyle(e)}}setExcavation(e){if(e)for(var t in this.mapExcavation=e,this.materialMap){var i=this.materialMap[t];i.updateExcavation&&i.updateExcavation(e),i.updateSide&&i.updateSide({isExcavation:e&&e.isExcavation})}}updateMaterialsSide(){for(var e in this.materialMap){var t=this.materialMap[e];t.updateSide&&t.updateSide({isExcavation:this.mapExcavation&&this.mapExcavation.isExcavation})}}clearTiles(){for(var e in this.globalLayer)for(var t in this.globalLayer[e])for(var i in this.globalLayer[e][t])this.globalLayer[e][t][i]&&this.globalLayer[e][t][i].destroy();this.globalLayer={},this.tileGroup.clear()}hideSkirt(){for(var e in this.disableSkirt=!0,this.globalLayer)for(var t in this.globalLayer[e])for(var i in this.globalLayer[e][t])this.globalLayer[e][t][i]&&this.globalLayer[e][t][i].skirt&&(this.globalLayer[e][t][i].skirt.visible=!1)}showSkirt(){for(var e in this.disableSkirt=!1,this.globalLayer)for(var t in this.globalLayer[e])for(var i in this.globalLayer[e][t])this.globalLayer[e][t][i]&&this.globalLayer[e][t][i].skirt&&(this.globalLayer[e][t][i].skirt.visible=!0)}hideAllNodes(){for(var e in this.globalLayer)for(var t in this.globalLayer[e])for(var i in this.globalLayer[e][t])this.globalLayer[e][t][i]&&this.globalLayer[e][t][i].meshNode&&(this.globalLayer[e][t][i].meshNode.visible=!1)}_increaseRequestCount(){this._deferContentUpdate(),++this._requestCount}_decreaseRequestContent(){--this._requestCount,this._resolveContentUpdate()}_deferContentUpdate(){this._contentReadyDeferred||(this._requestCount=0,this._contentReadyDeferred=new r.Deferred,this._contentReadyDeferred.promise.then((()=>{this._contentReadyDeferred.destroy(),this._contentReadyDeferred=void 0,this.viewer.render()})).catch((()=>{this._contentReadyDeferred.destroy(),this._contentReadyDeferred=void 0,this.viewer.render()})))}_resolveContentUpdate(){0===this._requestCount&&this._contentReadyDeferred&&this._contentReadyDeferred.resolve()}updateEarth(){if(this.mapUrl){var e=this.viewer.camera;e.updateMatrix(),e.updateMatrixWorld(),this.frustum.setFromProjectionMatrix((new THREE.Matrix4).multiplyMatrices(e.projectionMatrix,e.matrixWorldInverse)),this.modelTileX=r.Tile.TileMath.long2tile(this.modelLongitude,this.maxZoom),this.modelTileY=r.Tile.TileMath.lat2tile(this.modelLatitude,this.maxZoom),this.updateModelLngLatByBasePoint();for(var t=(this.modelTileX,this.modelTileX),i=(this.modelTileY,this.modelTileY),a=this.tileAroundNum,n=this.maxZoom,s=(t=this.modelTileX-this.modelTileX%a,i=this.modelTileY-this.modelTileY%a,t);s<t+a;++s)for(var o=i;o<i+a;++o)this.addNode(s,o,n);this.updateTile(t,i,n,a)}}updateTile(e,t,i,r){var a=e/2,n=t/2;if((a=Math.floor(a-r/4))%2==1&&a--,(n=Math.floor(n-r/4))%2==1&&n--,!((i=i-1)<0)){for(var s=a;s<a+r;++s)for(var o=n;o<n+r;++o)s>=e/2&&s<e/2+r/2&&o>=t/2&&o<t/2+r/2||s>=Math.pow(2,i)||s<0||o>=Math.pow(2,i)||o<0||this.addNode(s,o,i);this.updateTile(a,n,i,r)}}getTerrainData(e,t,i,a,n){var s=this,o=this.seg,l=Math.pow(2,i-s.maxTerrainLevel),d=parseInt(e/l),h=parseInt(t/l),c=e%l,u=t%l,p=s.dataUrl.terrainUrl(i,e,t);i>s.maxTerrainLevel&&(p=s.dataUrl.terrainUrl(s.maxTerrainLevel,d,h)),s.terrainScheduler.push(p,(function(n){for(var d=Array.prototype.slice.call(new Int16Array(n)),h=new Array(o+1),p=0;p<h.length;p++){h[p]=new Array(o+1);for(var m=0;m<o+1;m++)d[p*(o+1)+m]!==r.Tile.DemTilesUtil.InvalidTerrainValue?h[p][m]=d[p*(o+1)+m]:h[p][m]=0}if(s.modelTileX==e&&s.modelTileY==t){var f=d[0],g=d.length;for(p=0;p<g;p++)d[p]<f&&(f=d[p]);s.modelTileAttitude=f}var v=h;if(i>s.maxTerrainLevel){var y=c*(o/l),M=u*(o/l),E=o/l,b=new Array(E+1);for(p=0;p<b.length;p++){b[p]=new Array(E+1);for(m=0;m<=E;++m)b[p][m]=h[M+p][y+m]}v=r.Tile.TileMath.createHeightArray(b,o)}a&&a(v)}),(function(){n&&n()}))}addNode(e,t,i){if(!(e>=Math.pow(2,i)||e<0||t>=Math.pow(2,i)||t<0)){var a=this;if(null==a.globalLayer[i]&&(a.globalLayer[i]={}),null==a.globalLayer[i][e]&&(a.globalLayer[i][e]={}),null==a.globalLayer[i][e][t]&&(a.globalLayer[i][e][t]=new r.Tile.DemTile(i,e,t)),a.globalLayer[i][e][t].meshLoadState==r.Tile.DemTilesUtil.LOAD_STATE.UNLOADED)this.tileCount++,a.globalLayer[i][e][t].meshLoadState=r.Tile.DemTilesUtil.LOAD_STATE.GEO_LOADING,a.createTileGeometry(e,t,i,!0,(function(){a.createTileGeometryFinished(e,t,i)}));else if(a.globalLayer[i][e][t].meshLoadState==r.Tile.DemTilesUtil.LOAD_STATE.LOADED||a.globalLayer[i][e][t].meshLoadState==r.Tile.DemTilesUtil.LOAD_STATE.GEO_LOADED){a.globalLayer[i][e][t].geometry.computeBoundingBox();var n=a.globalLayer[i][e][t].geometry.boundingBox.clone();n.applyMatrix4(a.earthMatrix),a.globalLayer[i][e][t].box=n,a.createTileGeometryFinished(e,t,i)}}}createTileGeometryFinished(e,t,i){if(this.frustum.intersectsBox(this.globalLayer[i][e][t].box)){this.globalLayer[i][e][t].meshLoadState===r.Tile.DemTilesUtil.LOAD_STATE.LOADED&&(this.globalLayer[i][e][t].meshNode.visible=!0),this.globalLayer[i][e][t].meshLoadState===r.Tile.DemTilesUtil.LOAD_STATE.GEO_LOADED&&this.createMaterial(e,t,i,this.mapUrl),this.globalLayer[i][e][t].needUpdateTexture&&this.globalLayer[i][e][t].meshLoadState===r.Tile.DemTilesUtil.LOAD_STATE.LOADED&&this.updateMaterialTexture(e,t,i);for(var a=this.layerList.length,n=0;n<a;++n){(s=this.layerList[n]).contentUnLoad(i,e,t)&&this.globalLayer[i][e][t].meshLoadState>=r.Tile.DemTilesUtil.LOAD_STATE.GEO_LOADED&&this.createLayerMaterial(s,e,t,i),s.contentLoaded(i,e,t)&&(s.meshNodeMap[i][e][t].visible=!0)}}else{this.globalLayer[i][e][t].meshLoadState==r.Tile.DemTilesUtil.LOAD_STATE.LOADED&&(this.globalLayer[i][e][t].meshNode.visible=!1);for(a=this.layerList.length,n=0;n<a;++n){var s;(s=this.layerList[n]).contentLoaded(i,e,t)&&(s.meshNodeMap[i][e][t].visible=!1)}}}createTileGeometry(e,t,i){}createLayerMaterial(e,t,i,a){if(!e.isAvailableTile(t,i,a))return;var n=this;e.setContentLoading(a,t,i),this._increaseRequestCount();const s=e.getRequestUrl(t,i,a);n.loader.load(s,(function(s){var o=new r.MapTileMaterial({map:s,transparent:!0,side:THREE.FrontSide});n.useClipping&&(o.defines.USE_CLIPPING=""),o.updateStyle(e.mapStyle),o.updateExcavation(n.mapExcavation),o.updateSide({isExcavation:n.mapExcavation&&n.mapExcavation.isExcavation});var l=`${a}-${t}-${i}`;o.opacity=e.opacity,null==e.materialMap[a]&&(e.materialMap[a]={}),null==e.materialMap[a][t]&&(e.materialMap[a][t]={}),e.materialMap[a][t][i]=o;var d=new THREE.Mesh(n.globalLayer[a][t][i].geometry,o);if(null==e.meshNodeMap[a]&&(e.meshNodeMap[a]={}),null==e.meshNodeMap[a][t]&&(e.meshNodeMap[a][t]={}),e.meshNodeMap[a][t][i]=d,d.name=l,n.globalLayer[a][t][i].skirtGeometry){const r=`Skirt-${a}-${t}-${i}`,s=new THREE.Mesh(n.globalLayer[a][t][i].skirtGeometry,o);s.name=r,s.renderOrder=n.baseRenderOrder+1+e.priority,e.tileGroup.add(s)}(n.tileOpacity<1||n.disableSkirt)&&n.globalLayer[a][t][i].skirt&&(skirtMeshNode.visible=!1),d.renderOrder=n.baseRenderOrder+1+e.priority,e.tileGroup.add(d),e.tileGroup.updateMatrixWorld(!0),e.setContentLoaded(a,t,i),n._decreaseRequestContent()}))}updateMaterialTexture(e,t,i){const a=this;this._increaseRequestCount(),this.globalLayer[i][e][t].meshLoadState=r.Tile.DemTilesUtil.LOAD_STATE.MAT_PARSING;const n=a.imageryProvider.getImageryUrl(e,t,i);this.loader.load(n,(n=>{this.globalLayer[i][e][t].needUpdateTexture=!1,this.globalLayer[i][e][t].texture=n,this.globalLayer[i][e][t].material.map=n,this.globalLayer[i][e][t].meshLoadState=r.Tile.DemTilesUtil.LOAD_STATE.LOADED,a._decreaseRequestContent()}))}createMaterial(e,t,i,a){var n=this;if(!1!==n.imageryProvider.ready)return n.globalLayer[i][e][t].meshLoadState=r.Tile.DemTilesUtil.LOAD_STATE.MAT_PARSING,new Promise((function(s,o){n._increaseRequestCount();const l=n.imageryProvider.getImageryUrl(e,t,i);n.loader.load(l,(function(o){if(a===n.mapUrl){o.encoding=THREE.GammaEncoding;var l=new r.MapTileMaterial({map:o,transparent:!1,side:THREE.FrontSide});n.useClipping&&(l.defines.USE_CLIPPING=""),l.updateStyle(n.mapStyle),l.updateExcavation(n.mapExcavation),l.updateSide({isExcavation:n.mapExcavation&&n.mapExcavation.isExcavation});var d=`${i}-${e}-${t}`;if(l.opacity=n.tileOpacity,n.tileOpacity<1&&(l.transparent=!0),n.globalLayer[i][e][t].meshNode)return n.globalLayer[i][e][t].meshLoadState=r.Tile.DemTilesUtil.LOAD_STATE.LOADED,s(n.globalLayer[i][e][t]),void n._decreaseRequestContent();if(n.materialMap[d]=l,n.globalLayer[i][e][t].texture=o,n.globalLayer[i][e][t].material=l,n.globalLayer[i][e][t].meshNode=new THREE.Mesh(n.globalLayer[i][e][t].geometry,n.materialMap[d]),n.globalLayer[i][e][t].meshNode.name=d,n.globalLayer[i][e][t].meshNode.renderOrder=n.baseRenderOrder,n.tileGroup.add(n.globalLayer[i][e][t].meshNode),n.globalLayer[i][e][t].skirtGeometry){var h=`Skirt-${i}-${e}-${t}`;n.globalLayer[i][e][t].skirt=new THREE.Mesh(n.globalLayer[i][e][t].skirtGeometry,n.materialMap[d]),n.globalLayer[i][e][t].skirt.name=h,n.globalLayer[i][e][t].skirt.renderOrder=n.baseRenderOrder,n.tileGroup.add(n.globalLayer[i][e][t].skirt)}(n.tileOpacity<1||n.disableSkirt)&&n.globalLayer[i][e][t].skirt&&(n.globalLayer[i][e][t].skirt.visible=!1),n.globalLayer[i][e][t].meshLoadState=r.Tile.DemTilesUtil.LOAD_STATE.LOADED,n.onLoadTerrain(),s(n.globalLayer[i][e][t]),n._decreaseRequestContent(),n.tileCount--}else n._decreaseRequestContent()}),void 0,(e=>{console.log(e),n._decreaseRequestContent(),n.tileCount--}))}))}setMapLayer(e){this.mapUrl=`https://mt3.google.cn/vt/lyrs=${e}&hl=zh-CN&gl=cn&x={x}&y={y}&z={z}`,this.clearTiles()}setMapUrl(e,t){this.mapUrl=e,this.imageryProviderType=r.Utils.defaultValue(t,"UrlTemplate"),this.imageryProvider=new r.Layer.ImageryProviderFactory[t]({mapUrl:e}),this.imageryProvider.setReadyCallback((()=>{this.viewer.render()})),this.clearTiles()}isUseTerrain(){return this.useTerrain}applyTerrain(e){this.useTerrain=e,this.clearTiles()}addRoad(e,t){const i=new r.Tile.TextureLayer(this.viewer,{url:e});return i.priority=t,this.layerList[0]=i,this.updateEarthMatrix(),i}removeRoad(e){(e||this.layerList[0]).destroy(),this.layerList=[]}addImageryLayer(e,t){const i=e.mapUrl||e.url,a=e.imageryProviderType,n=e.hasTileMapResource,s=void 0===e.layerName?r.Utils.getEncodedId(i):e.layerName,o=this.layerList,l=t>=0&&t<o.length?t:o.length;let d,h=-1;for(let e=0,t=o.length;e<t;++e)if(o[e].url===i){h=e;break}return-1!==h?(d=o[h],o.splice(h,1)):d=new r.Tile.TextureLayer(this.viewer,{url:i,imageryProviderType:a,hasTileMapResource:n,layerName:s}),o.splice(l,0,d),this._updateLayerList(),this.updateEarthMatrix(),d.id}removeImageryLayer(e){const t=this.layerList,i=this.getLayerById(e);if(!i)return;const r=t.indexOf(i);-1!==r&&(t.splice(r,1),i.destroy(),this._updateLayerList(),this.updateEarthMatrix())}_updateLayerList(){const e=this.baseRenderOrder+1,t=this.layerList;for(let i=0,r=t.length;i<r;i++){const r=t[i];if(r.priority=i,r.meshNodeMap){const t=e+r.priority;r.updateMeshRenderOrder(t)}}}getMaxLevel(){return this.maxZoom}setMaxLevel(e){this.maxZoom=e,this.clearTiles()}},(()=>{let e=new THREE.Box3,t=new THREE.Matrix4,i=new THREE.Vector3;class a extends r.Tile.TileManager{constructor(e,t,i){super(e,t,i),this.mercatorPerimeter=r.Tile.TileMath.mercatorPerimeter,this.updateEarthMatrix(),this.tileGroup.name=r.GlobalData.TilePlaneGroupName,this.tileBuilder=new r.Tile.PlaneTileBuilder,this.terrainTileCount=this.tileAroundNum**2+(this.tileAroundNum**2-(this.tileAroundNum/2)**2)*(this.maxZoom-this.minTerrainLevel)}destroy(){this.viewer.modelManager.scene.removeObjectGroupByName(r.GlobalData.TilePlaneGroupName),this.offset=null,this.mercatorPerimeter=null,this.terrainLoader=null,this.tileBuilder=null,super.destroy()}updateModelLngLatByBasePoint(){let e=this.viewer.getBoundingBoxWorld().getCenter(i);const t=(new THREE.Matrix4).makeTranslation(-this.basePoint.x,-this.basePoint.y,0),a=(new THREE.Matrix4).makeRotationZ(this.modelRotationZ),n=(new THREE.Matrix4).makeTranslation(this.basePoint.x,this.basePoint.y,0);e.applyMatrix4(t),e.applyMatrix4(a),e.applyMatrix4(n);const s=this.mercator2lonLat(e);this.modelTileX=r.Tile.TileMath.long2tile(s.x,this.maxZoom),this.modelTileY=r.Tile.TileMath.lat2tile(s.y,this.maxZoom)}updateEarthMatrix(){this.mercatorPerimeter=r.Tile.TileMath.getMercatorPerimeterByLat(this.modelLatitude),this.modelTileX=r.Tile.TileMath.long2tile(this.modelLongitude,this.maxZoom),this.modelTileY=r.Tile.TileMath.lat2tile(this.modelLatitude,this.maxZoom),this.updateModelLngLatByBasePoint();var e=r.Tile.TileMath.tile2boundingBox(this.modelTileX,this.modelTileY,this.maxZoom),t=(this.modelLongitude-e.west)/(e.east-e.west),i=(this.modelLatitude-e.north)/(e.north-e.south),a=this.mercatorPerimeter/Math.pow(2,this.maxZoom)*r.Tile.TileMath.unitScale*2,n=-t*a+.5*a-.5*a,s=-i*a-.5*a+.5*a,o=(new THREE.Matrix4).makeTranslation(n+this.basePoint.x,s+this.basePoint.y,-this.modelAltitude*r.Tile.TileMath.unitScale),l=(new THREE.Matrix4).makeTranslation(n,s,0),d=(new THREE.Matrix4).makeRotationZ(-this.modelRotationZ),h=(new THREE.Matrix4).makeTranslation(-n,-s,0);this.tileGroup.matrix.identity(),this.tileGroup.applyMatrix4(l),this.tileGroup.applyMatrix4(d),this.tileGroup.applyMatrix4(h),this.tileGroup.applyMatrix4(o),this.tileGroup.applyMatrix4(this.globalMatrix),this.tileGroup.matrixAutoUpdate=!1,this.tileGroup.updateMatrixWorld(!0);for(var c=this.layerList.length,u=0;u<c;++u){var p=this.layerList[u];p.tileGroup.matrix.identity(),p.tileGroup.applyMatrix4(l),p.tileGroup.applyMatrix4(d),p.tileGroup.applyMatrix4(h),p.tileGroup.applyMatrix4(o),p.tileGroup.applyMatrix4(this.globalMatrix),p.tileGroup.matrixAutoUpdate=!1,p.tileGroup.updateMatrixWorld(!0)}this.viewer.render()}createTerrainGeometry(e,t,i,r,a,n,s){var o=this.tileBuilder.computePlaneGeometry(i,i,t,n,!1),l=o[0];return s&&(this.globalLayer[e][r-1]&&this.globalLayer[e][r-1][a]&&this.globalLayer[e][r-1][a].geometry&&this.tileBuilder.computeNearNormal(l,this.globalLayer[e][r-1][a].geometry,t,"left"),this.globalLayer[e][r+1]&&this.globalLayer[e][r+1][a]&&this.globalLayer[e][r+1][a].geometry&&this.tileBuilder.computeNearNormal(l,this.globalLayer[e][r+1][a].geometry,t,"right"),this.globalLayer[e][r]&&this.globalLayer[e][r][a-1]&&this.globalLayer[e][r][a-1].geometry&&this.tileBuilder.computeNearNormal(l,this.globalLayer[e][r][a-1].geometry,t,"bottom"),this.globalLayer[e][r]&&this.globalLayer[e][r][a+1]&&this.globalLayer[e][r][a+1].geometry&&this.tileBuilder.computeNearNormal(l,this.globalLayer[e][r][a+1].geometry,t,"top")),o}updateTileMeshForFlatten(){for(var e in this.globalLayer)for(var t in this.globalLayer[e])for(var i in this.globalLayer[e][t])this.globalLayer[e][t][i]&&this._updateTileMeshForFlatten(this.globalLayer[e][t][i])}_updateTileMeshForFlatten(i){if(i.box&&i.terrainData){var a=i.x,n=i.y,s=i.zoom,o=i.terrainData,l=this.mercatorPerimeter/Math.pow(2,this.maxZoom)*r.Tile.TileMath.unitScale*2,d=(a*Math.pow(2,this.maxZoom-s)-this.modelTileX)*l+Math.pow(2,this.maxZoom-s)/2*l,h=-(n*Math.pow(2,this.maxZoom-s)-this.modelTileY)*l-Math.pow(2,this.maxZoom-s)/2*l;t.makeTranslation(d,h,0),t.multiplyMatrices(this.earthMatrix,t);var c=this.mercatorPerimeter/Math.pow(2,s)*r.Tile.TileMath.unitScale*2,u=this.seg,p=i.geometry,m=i.skirtGeometry;e.copy(i.box),e.min.y=e.max.y=0;var f=this.viewer.terrainOperationManager.isIntersectFlattenBboxDrawing(e,r.ObjectGroupType.TILEGROUP);if(!f&&i.isFlattened)return p.translate(-d,-h,0),m.translate(-d,-h,0),this.tileBuilder.updateGeometryForFlatten(c,c,u,o,!1,r.Tile.TileMath.unitScale,this.viewer.terrainOperationManager,t,p,m,!0),p.translate(d,h,0),m.translate(d,h,0),void(i.isFlattened=!1);f&&(p.translate(-d,-h,0),m.translate(-d,-h,0),this.tileBuilder.updateGeometryForFlatten(c,c,u,o,!1,r.Tile.TileMath.unitScale,this.viewer.terrainOperationManager,t,p,m,!1),p.translate(d,h,0),m.translate(d,h,0),i.isFlattened=!0)}}translateGeometry(e,t,i,a,n,s){var o=this;null==n&&(n=0);var l=o.mercatorPerimeter/Math.pow(2,o.maxZoom)*r.Tile.TileMath.unitScale*2,d=(i*Math.pow(2,o.maxZoom-t)-o.modelTileX)*l+Math.pow(2,o.maxZoom-t)/2*l,h=-(a*Math.pow(2,o.maxZoom-t)-o.modelTileY)*l-Math.pow(2,o.maxZoom-t)/2*l;e.translate(d,h,n),o.globalLayer[t][i][a].geometry=e,e.computeBoundingBox();var c=e.boundingBox.clone();c.applyMatrix4(o.earthMatrix),o.globalLayer[t][i][a].box=c,o.globalLayer[t][i][a].meshLoadState=r.Tile.DemTilesUtil.LOAD_STATE.GEO_LOADED,s&&s()}translateGeometryWithSkirt(e,t,i,a,n,s,o){var l=e[0],d=e[1],h=this;null==n&&(n=0);var c=h.mercatorPerimeter/Math.pow(2,h.maxZoom)*r.Tile.TileMath.unitScale*2,u=(i*Math.pow(2,h.maxZoom-t)-h.modelTileX)*c+Math.pow(2,h.maxZoom-t)/2*c,p=-(a*Math.pow(2,h.maxZoom-t)-h.modelTileY)*c-Math.pow(2,h.maxZoom-t)/2*c;l.translate(u,p,n),d.translate(u,p,n),h.globalLayer[t][i][a].geometry=l,h.globalLayer[t][i][a].skirtGeometry=d,l.computeBoundingBox();var m=l.boundingBox.clone();m.applyMatrix4(h.earthMatrix),h.globalLayer[t][i][a].box=m,h.globalLayer[t][i][a].terrainData=s,h.globalLayer[t][i][a].meshLoadState=r.Tile.DemTilesUtil.LOAD_STATE.GEO_LOADED,o&&o(),h._updateTileMeshForFlatten(h.globalLayer[t][i][a])}getTerrainGeometry(e,t,i,r,a,n,s){this.getTerrainData(e,t,i,(o=>{let l=this.createTerrainGeometry(i,r,a,e,t,o,n);this.translateGeometryWithSkirt(l,i,e,t,null,o,s),this.terrainTileCount--,this.onLoadTerrain()}),(()=>{this.terrainTileCount--,this.onLoadTerrain();let n=new THREE.PlaneBufferGeometry(a,a,r);this.translateGeometry(n,i,e,t,null,s)}))}createTileGeometry(e,t,i,a,n){const s=this.mercatorPerimeter/Math.pow(2,i)*r.Tile.TileMath.unitScale*2,o=this.seg;if(this.useTerrain&&this.textureXYZScale&&this.textureXYZScale[i]&&this.textureXYZScale[i].leftX<=e&&this.textureXYZScale[i].rightX>=e&&this.textureXYZScale[i].upY<=t&&this.textureXYZScale[i].bottomY>=t)this.getTerrainGeometry(e,t,i,o,s,a,n);else if(this.useTerrain&&!this.textureXYZScale&&i>=this.minTerrainLevel)this.getTerrainGeometry(e,t,i,o,s,a,n);else{var l=new THREE.PlaneBufferGeometry(s,s,o);this.translateGeometry(l,i,e,t,null,n)}}worldPositionToLngLat(e){return this.mercator2lonLat(e)}lngLatToWorldPositionWithObj(e,t){const i=e.lon,r=e.lat,a=e.id,n=e.order;var s=this.lonLat2Mercator(i,r);return this.useTerrain&&t?this.getTileIntersectPoint([i,r],s,t):t&&t({worldPosition:s,id:a,order:n}),s}lngLatToWorldPosition(e,t){var i=this.lonLat2Mercator(e[0],e[1]);return this.useTerrain&&t?this.getTileIntersectPoint(e,i,t):t&&t(i),i}_lngLatToWorldPosition2(e){var t=this.lonLat2Mercator(e[0],e[1]);return this.useTerrain?this.getTerrainHeight(t):t}getTerrainHeight(e){var t,i=e.applyMatrix4(this.globalMatrix),a=new r.Raycaster(new THREE.Vector3(i.x,i.y,i.z),new THREE.Vector3(0,-1,0)),n=[];return this.raycast(this.tileGroup,a,n),n.length>0?((t=n[0].point.clone()).applyMatrix4(this.globalMatrixInverse),t):(a=new r.Raycaster(new THREE.Vector3(i.x,i.y,i.z),new THREE.Vector3(0,1,0)),n=[],this.raycast(this.tileGroup,a,n),n.length>0?((t=n[0].point.clone()).applyMatrix4(this.globalMatrixInverse),t):void 0)}raycast(e,t,i){for(var a=0,n=e.children.length;a<n;a++){var s=e.children[a];if(r.Utils.isGroupObject(s))this.raycast(s,t,i);else{if(-1!=s.name.indexOf("Skirt"))continue;s.raycast(t,i)}}}lonLat2Mercator(e,t){var i=new THREE.Vector3,a=r.Tile.TileMath.lonLat2Mercator(e,t,this.mercatorPerimeter),n=r.Tile.TileMath.lonLat2Mercator(this.modelLongitude,this.modelLatitude,this.mercatorPerimeter).sub(new THREE.Vector2(this.basePoint.x,this.basePoint.y));return i.x=a.x-n.x,i.y=a.y-n.y,i.z=-this.modelAltitude*r.Tile.TileMath.unitScale,i}mercator2lonLat(e){var t=r.Tile.TileMath.lonLat2Mercator(this.modelLongitude,this.modelLatitude,this.mercatorPerimeter).sub(new THREE.Vector2(this.basePoint.x,this.basePoint.y));return r.Tile.TileMath.mercator2lonLat(new THREE.Vector2(e.x+t.x,e.y+t.y),this.mercatorPerimeter)}getTileIntersectPoint(e,t,i){e[0],e[1];let a=!1;var n=this;t.z=r.Tile.TileMath.earthHighestAltitude;var s=t.clone().applyMatrix4(this.globalMatrix);for(let e=this.maxZoom;e>=3;e--){var o=this.globalLayer[e];for(let l in o)for(let d in o[l]){let h=o[l][d].box;null!==h&&(s.x<=h.max.x&&s.x>=h.min.x&&s.z<=h.max.z&&s.z>=h.min.z&&(a=!0,n.globalLayer[e][l][d].meshLoadState=r.Tile.DemTilesUtil.LOAD_STATE.GEO_LOADING,n.createTileGeometry(l,d,e,!0,(function(){n.createMaterial(l,d,e,n.mapUrl).then((function(e){var a=new r.Raycaster(new THREE.Vector3(s.x,s.y,s.z),new THREE.Vector3(0,-1,0)),o=[];e.meshNode.raycast(a,o);var l=void 0;if(o.length>0)return(l=o[0].point.clone()).applyMatrix4(n.globalMatrixInverse),l.x=t.x,l.y=t.y,void(i&&i(l))}))}))))}}0==a&&(t.z=-n.modelAltitude*r.Tile.TileMath.unitScale,i&&i(t))}_getOnlineTerrainHeight2(e,t){var i=r.Tile.TileMath.long2tile(e,this.maxZoom),a=r.Tile.TileMath.lat2tile(t,this.maxZoom),n=Math.pow(2,this.maxZoom-this.maxTerrainLevel),s=parseInt(i/n),o=parseInt(a/n),l=i%n,d=a%n,h=new THREE.FileLoader;h.setResponseType("arraybuffer");var c=this.dataUrl.terrainUrl(this.maxTerrainLevel,s,o),u=this;h.load(c,(function(n){for(var s=Array.prototype.slice.call(new Uint16Array(n)),o=new Array(17),h=0;h<o.length;h++){o[h]=new Array(17);for(var c=0;c<17;c++)o[h][c]=s[17*h+c]}var p=o[d][l],m=o[d][l+1],f=o[d+1][l],g=o[d+1][l+1],v=r.Tile.TileMath.tile2boundingBox(i,a,u.maxZoom),y=p+(f-p)*(v.north-t)/(v.north-v.south),M=y+(m+(g-m)*(v.north-t)/(v.north-v.south)-y)*(e-v.west)/(v.east-v.west);console.log(M)}))}}r.Tile.TilePlaneManager=a})();class q extends r.Tile.TileManager{constructor(e,t,i){super(e,t,i),this.tileGroup.name=r.GlobalData.TileGlobalGroupName,this.tileBuilder=new r.Tile.GlobeTileBuilder,this.updateEarthMatrix()}destroy(){this.offset=null,this.tileBuilder=null,super.destroy()}updateEarthMatrix(){this.earthPos=r.Tile.TileMath.fromDegrees(this.modelLongitude,this.modelLatitude),this.offset=new THREE.Vector3(this.basePoint.x*r.Tile.TileMath.unitScale/1e3,this.basePoint.y*r.Tile.TileMath.unitScale/1e3,-r.Tile.TileMath.earthRadius*r.Tile.TileMath.unitScale-this.modelAltitude*r.Tile.TileMath.unitScale);var e=this.earthPos.clone().normalize(),t=(new THREE.Quaternion).setFromUnitVectors(e,new THREE.Vector3(0,0,1)),i=(new THREE.Quaternion).setFromAxisAngle(new THREE.Vector3(0,0,1),THREE.Math.degToRad(270-this.modelLongitude)-this.modelRotationZ);t.premultiply(i);var a=(new THREE.Matrix4).makeRotationFromQuaternion(t),n=(new THREE.Matrix4).makeTranslation(this.offset.x,this.offset.y,this.offset.z);this.tileGroup.matrix.identity(),this.tileGroup.applyMatrix4(a),this.tileGroup.applyMatrix4(n),this.tileGroup.applyMatrix4(this.globalMatrix),this.tileGroup.matrixAutoUpdate=!1,this.tileGroup.updateMatrixWorld(!0);for(var s=this.layerList.length,o=0;o<s;++o){var l=this.layerList[o];l.tileGroup.matrix.identity(),l.tileGroup.applyMatrix4(a),l.tileGroup.applyMatrix4(n),l.tileGroup.applyMatrix4(this.globalMatrix),l.tileGroup.matrixAutoUpdate=!1,l.tileGroup.updateMatrixWorld(!0)}this.viewer.render()}translateGeometry(e,t,i,a){var n=new THREE.BufferGeometry;n.setIndex(a.index),n.setAttribute("position",new THREE.BufferAttribute(a.position,3)),n.setAttribute("uv",new THREE.BufferAttribute(a.uvs,2)),n.translate(a.center.x*r.Tile.TileMath.unitScale,a.center.y*r.Tile.TileMath.unitScale,a.center.z*r.Tile.TileMath.unitScale),this.globalLayer[i][e][t].geometry=n,n.computeBoundingBox();var s=n.boundingBox.clone();s.applyMatrix4(this.earthMatrix),this.globalLayer[i][e][t].box=s,this.globalLayer[i][e][t].meshLoadState=r.Tile.DemTilesUtil.LOAD_STATE.GEO_LOADED}createStandardGlobalGeometry(e,t,i){var r=this.tileBuilder.computeBuffer(e,t,i,void 0,!1);this.translateGeometry(e,t,i,r)}createTerrainGlobalGeometry(e,t,i,r){const a=this.tileBuilder.computeBuffer(e,t,i,void 0,!1,r);this.translateGeometry(e,t,i,a)}createTileGeometry(e,t,i,r,a){this.seg;var n=this;n.useTerrain&&i>=n.minTerrainLevel?n.getTerrainData(e,t,i,(function(r){n.createTerrainGlobalGeometry(e,t,i,r),a&&a()}),(function(){n.createStandardGlobalGeometry(e,t,i),a&&a()})):(n.createStandardGlobalGeometry(e,t,i),a&&a())}}r.Tile.TileGlobalManager=q,r.Tile.TileManagerFactory={TilePlaneManager:function(e,t,i){return new r.Tile.TilePlaneManager(e,t,i)},TileGlobalManager:function(e,t,i){return new r.Tile.TileGlobalManager(e,t,i)}},function(){class e extends r.BaseModel{constructor(e,t,i,a,n,s){super(t,i),this.isDemLayer=!0,this.id=r.ObjectGroupType.TILEGROUP,this.databagId=this.id,this.viewer=e,this.parseCfgFinish=n,this.debut=s,this.dataUrl=new r.Loader.Url(i),this.tileManager=null,this.loadTileConfig=i.loadConfig,this.ObjectGroup=e.getScene().getOrCreateObjectGroup(r.ObjectGroupType.TILEGROUP,{pickableType:r.PICKABLETYPE.Map,globalSpace:!0})}destroy(){this.manager.removeModel(this.id,!1),this.tileManager.destroy(),this.manager.scene.removeObjectGroupByName(r.ObjectGroupType.TILEGROUP),this.parseCfgFinish=null,this.debut=null,this.viewer=null,super.destroy()}load(e){var t=this;this.manager.chooseRendering(this.statistics.memoeryInfo),this.parseCfgFinish&&this.parseCfgFinish(),this.manager.dispatchEvent({type:r.EVENTS.ON_LOAD_START});var i=new THREE.FileLoader;i.setResponseType("json"),i.load(this.dataUrl.projectUrl(),(function(e){var i=e.metadata.longitude,a=e.metadata.latitude,n=e.metadata.zoom;r.GlobalData.ConstraintZoom=!0;t.viewer.cameraControl.setMaximalRangeofCamera(100),t.viewer.lockAxisZ("Z",[.1,Math.PI/2.01]),t.loadTile(t.viewer,t.loadTileConfig,i,a,n),t.manager.dispatchEvent({type:r.EVENTS.ON_LOAD_COMPLETE,modelId:t.id}),t.debut(t)}))}loadTile(e,t){e.getScene().geometryGroup.boundingBox||(this.getTransforms().boundingBox=new THREE.Box3(new THREE.Vector3(-r.GlobalData.SceneSize,-r.GlobalData.SceneSize,-r.GlobalData.SceneSize),new THREE.Vector3(r.GlobalData.SceneSize,r.GlobalData.SceneSize,r.GlobalData.SceneSize)),this.manager.updateScene(this));var i=e.getScene().getMatrixGlobal().clone();(new THREE.Matrix4).copy(i).invert();var a={};if(t&&"[object Number]"===Object.prototype.toString.call(t.modelAltitude)?a.modelAltitude=t.modelAltitude:(console.log("modelAltitude not in loadConfig, default 0"),a.modelAltitude=0),t&&"[object Number]"===Object.prototype.toString.call(t.modelRotationZ)?a.modelRotationZ=t.modelRotationZ:(console.log("modelRotationZ not in loadConfig, default 0"),a.modelRotationZ=0),t&&t.basePoint?a.basePoint=t.basePoint:(console.log("basePoint not in loadConfig, default (0,0)"),a.basePoint=new THREE.Vector3(0,0,0)),t&&t.modelPosition){a.modelPosition=t.modelPosition,a.useTerrain=t&&t.useTerrain,a.terrainPath=t.terrainPath,a.opacity=t.opacity,a.mapUrl=t.mapUrl,a.terrainOnlineConfig=t.terrainOnlineConfig,a.mapStyle=t.mapStyle,a.useClipping=t.sectionable,a.dataUrl=this.dataUrl,a.maxTerrainLevel=void 0===t.maxTerrainLevel?14:t.maxTerrainLevel,a.minTerrainLevel=void 0===t.minTerrainLevel?10:t.minTerrainLevel,a.maxZoom=void 0===t.maxLevel?18:t.maxLevel,a.imageryProviderType=void 0===t.imageryProviderType?"UrlTemplate":t.imageryProviderType;var n="TilePlaneManager";a.useUnitMeter=t&&t.useUnitMeter,!0===a.useUnitMeter?r.Tile.TileMath.unitScale=1:"global"===a.useUnitMeter&&(n="TileGlobalManager",r.Tile.TileMath.unitScale=1),a.mapLayer=t.mapLayer,this.tileManager=r.Tile.TileManagerFactory[n](this,a,this.ObjectGroup),this.tileManager.addRenderCallback()}else console.log("modelPosition not in loadConfig")}updateMatrix(){this.tileManager&&this.tileManager.updateEarthMatrix()}}r.DemModel=e}(),function(){class e extends r.Tile.TilePlaneManager{constructor(e,t,i){super(e,t,i),this.loadAll=!1}destroy(){this.loadAll=void 0}update(){this.updateEarthMatrix(),this.updateEarth(),this.viewer.render(),this.onLoadTile()}updateEarthMatrix(){this.globalMatrix=this.viewer.getScene().getMatrixGlobal(),this.mercatorPerimeter=r.Tile.TileMath.getMercatorPerimeterByLat(this.modelLatitude),this.modelTileX=r.Tile.TileMath.long2tile(this.modelLongitude,this.maxZoom),this.modelTileY=r.Tile.TileMath.lat2tile(this.modelLatitude,this.maxZoom);var e=r.Tile.TileMath.tile2boundingBox(this.modelTileX,this.modelTileY,this.maxZoom),t=(this.modelLongitude-e.west)/(e.east-e.west),i=(this.modelLatitude-e.north)/(e.north-e.south),a=this.mercatorPerimeter/Math.pow(2,this.maxZoom)*r.Tile.TileMath.unitScale*2,n=-t*a+.5*a-.5*a,s=-i*a-.5*a+.5*a,o=(new THREE.Matrix4).makeTranslation(n,s,0);this.tileGroup.matrix.identity(),this.tileGroup.applyMatrix4(o),this.tileGroup.applyMatrix4(this.globalMatrix),this.tileGroup.matrixAutoUpdate=!1,this.tileGroup.updateMatrixWorld(!0);for(var l=this.layerList.length,d=0;d<l;++d){var h=this.layerList[d];h.tileGroup.matrix.identity(),h.tileGroup.applyMatrix4(o),h.tileGroup.applyMatrix4(this.globalMatrix),h.tileGroup.matrixAutoUpdate=!1,h.tileGroup.updateMatrixWorld(!0)}this.viewer.render()}updateModelLngLatByBasePoint(){}onLoadTile(){!1===this.loadAll&&this.tileCount<=3&&(this.loadAll=!0,this.viewer.modelManager.setRenderStateChanged(!0),this.viewer.modelManager.dispatchEvent({type:r.EVENTS.ON_MAP_LOAD_ALL}))}createTileGeometryFinished(e,t,i){this.globalLayer[i][e][t].meshLoadState===r.Tile.DemTilesUtil.LOAD_STATE.GEO_LOADED&&this.createMaterial(e,t,i,this.mapUrl),this.globalLayer[i][e][t].needUpdateTexture&&this.globalLayer[i][e][t].meshLoadState===r.Tile.DemTilesUtil.LOAD_STATE.LOADED&&this.updateMaterialTexture(e,t,i);for(var a=this.layerList.length,n=0;n<a;++n){var s=this.layerList[n];s.contentUnLoad(i,e,t)&&this.globalLayer[i][e][t].meshLoadState>=r.Tile.DemTilesUtil.LOAD_STATE.GEO_LOADED&&this.createLayerMaterial(s,e,t,i),s.contentLoaded(i,e,t)&&(s.meshNodeMap[i][e][t].visible=!0)}}}r.Tile.FullPlaneTileManager=e}(),function(){class e extends r.Tile.TilePlaneManager{constructor(e,t,i){super(e,t,i),this.loadAll=!1;const a=this.mercatorPerimeter/Math.pow(2,this.maxZoom)*r.Tile.TileMath.unitScale*2;this.commonGeometry=new THREE.PlaneBufferGeometry(a,a,1),this.commonBox=(new THREE.Box3).setFromArray([-a/2,-a/2,0,a/2,a/2,0])}destroy(){this.loadAll=void 0}update(){this.updateEarthMatrix(),this.updateEarth(),this.onLoadTile()}updateEarthMatrix(){this.globalMatrix=this.viewer.getScene().getMatrixGlobal(),this.mercatorPerimeter=r.Tile.TileMath.getMercatorPerimeterByLat(this.modelLatitude),this.modelTileX=r.Tile.TileMath.long2tile(this.modelLongitude,this.maxZoom),this.modelTileY=r.Tile.TileMath.lat2tile(this.modelLatitude,this.maxZoom);var e=r.Tile.TileMath.tile2boundingBox(this.modelTileX,this.modelTileY,this.maxZoom),t=(this.modelLongitude-e.west)/(e.east-e.west),i=(this.modelLatitude-e.north)/(e.north-e.south),a=this.mercatorPerimeter/Math.pow(2,this.maxZoom)*r.Tile.TileMath.unitScale*2,n=-t*a+.5*a-.5*a,s=-i*a-.5*a+.5*a,o=(new THREE.Matrix4).makeTranslation(n,s,0);this.tileGroup.matrix.identity(),this.tileGroup.applyMatrix4(o),this.tileGroup.applyMatrix4(this.globalMatrix),this.tileGroup.matrixAutoUpdate=!1,this.tileGroup.updateMatrixWorld(!0);for(var l=this.layerList.length,d=0;d<l;++d){var h=this.layerList[d];h.tileGroup.matrix.identity(),h.tileGroup.applyMatrix4(o),h.tileGroup.applyMatrix4(this.globalMatrix),h.tileGroup.matrixAutoUpdate=!1,h.tileGroup.updateMatrixWorld(!0)}}updateModelLngLatByBasePoint(){}onLoadTile(){!1===this.loadAll&&this.tileCount<=3&&(this.loadAll=!0,this.viewer.modelManager.setRenderStateChanged(!0),this.viewer.modelManager.dispatchEvent({type:r.EVENTS.ON_MAP_LOAD_ALL}))}addNode(e,t,i){e>=Math.pow(2,i)||e<0||t>=Math.pow(2,i)||t<0||(null==this.globalLayer[i]&&(this.globalLayer[i]={}),null==this.globalLayer[i][e]&&(this.globalLayer[i][e]={}),null==this.globalLayer[i][e][t]&&(this.globalLayer[i][e][t]=new r.Tile.DemTile(i,e,t)),this.globalLayer[i][e][t].meshLoadState==r.Tile.DemTilesUtil.LOAD_STATE.UNLOADED?(this.tileCount++,this.globalLayer[i][e][t].meshLoadState=r.Tile.DemTilesUtil.LOAD_STATE.GEO_LOADING,this.createTileGeometry(e,t,i,!0,(()=>{this.createTileGeometryFinished(e,t,i)}))):this.globalLayer[i][e][t].meshLoadState!=r.Tile.DemTilesUtil.LOAD_STATE.LOADED&&this.globalLayer[i][e][t].meshLoadState!=r.Tile.DemTilesUtil.LOAD_STATE.GEO_LOADED||this.createTileGeometryFinished(e,t,i))}createTileGeometry(e,t,i,a,n){const s=this.mercatorPerimeter/Math.pow(2,i)*r.Tile.TileMath.unitScale*2,o=this.seg;this.useTerrain&&this.textureXYZScale&&this.textureXYZScale[i]&&this.textureXYZScale[i].leftX<=e&&this.textureXYZScale[i].rightX>=e&&this.textureXYZScale[i].upY<=t&&this.textureXYZScale[i].bottomY>=t||this.useTerrain&&!this.textureXYZScale&&i>=this.minTerrainLevel?this.getTerrainGeometry(e,t,i,o,s,a,n):this.translateGeometry(this.commonGeometry,i,e,t,null,n)}translateGeometry(e,t,i,a,n,s){null==n&&(n=0);const o=this.mercatorPerimeter/Math.pow(2,this.maxZoom)*r.Tile.TileMath.unitScale*2,l=Math.pow(2,this.maxZoom-t),d=(i*l-this.modelTileX)*o+l/2*o,h=-(a*l-this.modelTileY)*o-l/2*o;let c=new THREE.Matrix4;c.compose(new THREE.Vector3(d,h,1),new THREE.Quaternion,new THREE.Vector3(l,l,l)),this.globalLayer[t][i][a].tileMatrix=c;let u=this.commonBox.clone().applyMatrix4(c);u.applyMatrix4(this.earthMatrix),this.globalLayer[t][i][a].box=u,this.globalLayer[t][i][a].meshLoadState=r.Tile.DemTilesUtil.LOAD_STATE.GEO_LOADED,s&&s()}translateGeometryWithSkirt(e,t,i,a,n,s){null==n&&(n=0);let o=e[0],l=e[1];const d=this.mercatorPerimeter/Math.pow(2,this.maxZoom)*r.Tile.TileMath.unitScale*2,h=Math.pow(2,this.maxZoom-t),c=(i*h-this.modelTileX)*d+h/2*d,u=-(a*h-this.modelTileY)*d-h/2*d;let p=new THREE.Matrix4;p.compose(new THREE.Vector3(c,u,1),new THREE.Quaternion,new THREE.Vector3(1,1,1)),this.globalLayer[t][i][a].tileMatrix=p,this.globalLayer[t][i][a].geometry=o,this.globalLayer[t][i][a].skirtGeometry=l,o.computeBoundingBox();var m=o.boundingBox.clone().applyMatrix4(p);m.applyMatrix4(this.earthMatrix),this.globalLayer[t][i][a].box=m,this.globalLayer[t][i][a].meshLoadState=r.Tile.DemTilesUtil.LOAD_STATE.GEO_LOADED,s&&s()}createTileGeometryFinished(e,t,i){this.globalLayer[i][e][t].meshLoadState===r.Tile.DemTilesUtil.LOAD_STATE.GEO_LOADED&&this.createMaterial(e,t,i,this.mapUrl),this.globalLayer[i][e][t].needUpdateTexture&&this.globalLayer[i][e][t].meshLoadState===r.Tile.DemTilesUtil.LOAD_STATE.LOADED&&this.updateMaterialTexture(e,t,i);for(var a=this.layerList.length,n=0;n<a;++n){var s=this.layerList[n];s.contentUnLoad(i,e,t)&&this.globalLayer[i][e][t].meshLoadState>=r.Tile.DemTilesUtil.LOAD_STATE.GEO_LOADED&&this.createLayerMaterial(s,e,t,i),s.contentLoaded(i,e,t)&&(s.meshNodeMap[i][e][t].visible=!0)}}createMaterial(e,t,i){this.globalLayer[i][e][t].meshLoadState=r.Tile.DemTilesUtil.LOAD_STATE.MAT_PARSING;var a=this;return new Promise(((n,s)=>{const o=a.imageryProvider.getImageryUrl(e,t,i);this.loader.load(o,(s=>{let o=new r.MapTileMaterial({map:s,transparent:!1,side:THREE.FrontSide});this.useClipping&&(o.defines.USE_CLIPPING=""),o.updateStyle(a.mapStyle);let l=`${i}-${e}-${t}`;if(o.opacity=this.tileOpacity,this.tileOpacity<1&&(o.transparent=!0),this.globalLayer[i][e][t].meshNode)return this.globalLayer[i][e][t].meshLoadState=r.Tile.DemTilesUtil.LOAD_STATE.LOADED,void n(this.globalLayer[i][e][t]);this.materialMap[l]=o,this.globalLayer[i][e][t].texture=s,this.globalLayer[i][e][t].material=o;let d=null;if(d=this.useTerrain&&this.globalLayer[i][e][t].geometry?new THREE.Mesh(this.globalLayer[i][e][t].geometry,this.materialMap[l]):new THREE.Mesh(this.commonGeometry,this.materialMap[l]),this.globalLayer[i][e][t].meshNode=d,this.globalLayer[i][e][t].meshNode.name=l,this.globalLayer[i][e][t].meshNode.renderOrder=this.baseRenderOrder,this.globalLayer[i][e][t].meshNode.matrix=this.globalLayer[i][e][t].tileMatrix,this.globalLayer[i][e][t].meshNode.matrixAutoUpdate=!1,this.tileGroup.add(this.globalLayer[i][e][t].meshNode),this.globalLayer[i][e][t].skirtGeometry){var h=`Skirt-${i}-${e}-${t}`;this.globalLayer[i][e][t].skirt=new THREE.Mesh(this.globalLayer[i][e][t].skirtGeometry,this.materialMap[l]),this.globalLayer[i][e][t].skirt.name=h,this.globalLayer[i][e][t].skirt.renderOrder=this.baseRenderOrder,this.globalLayer[i][e][t].skirt.matrix=this.globalLayer[i][e][t].tileMatrix,this.globalLayer[i][e][t].skirt.matrixAutoUpdate=!1,this.tileGroup.add(this.globalLayer[i][e][t].skirt)}(this.tileOpacity<1||this.disableSkirt)&&this.globalLayer[i][e][t].skirt&&(this.globalLayer[i][e][t].skirt.visible=!1),this.globalLayer[i][e][t].meshLoadState=r.Tile.DemTilesUtil.LOAD_STATE.LOADED,this.viewer.render(),this.onLoadTerrain(),n(this.globalLayer[i][e][t]),this.tileCount--}),void 0,(()=>{this.tileCount--}))}))}}r.Tile.FullPlaneTileManager2=e}(),function(){class e extends r.BaseModel{constructor(e,t,i,a,n,s){super(t,i),this.id=r.ObjectGroupType.TILEGROUP,this.databagId=this.id,this.viewer=e,this.index=a,this.parseCfgFinish=n,this.debut=s,this.dataUrl=new r.Loader.Url(i),this.loadTileConfig=i.loadConfig,this.tileBuilder=new r.Tile.GlobeTileBuilder,this.objectGroup=t.getScene().getOrCreateObjectGroup(r.GlobalData.TileGlobalGroupName,{pickableType:r.PICKABLETYPE.Map,globalSpace:!0}),this.manager.addModel(this),this.tileManager=null,this._modelMatrix=new THREE.Matrix4}destroy(){this._modelMatrix=null,this.manager.scene.removeObjectGroupByName(r.ObjectGroupType.TILEGROUP),this.tileManager.destroy(),this.tileBuilder.destroy(),this.tileBuilder=null,this.parseCfgFinish=null,this.debut=null,this.viewer=null,this.dataUrl=null,this.loadTileConfig=null,super.destroy()}load(e){this.manager.setDrawableModel(!0),this.manager.chooseRendering(this.statistics.memoeryInfo,!0),this.viewer.rendererManager.setupRenderer(this.viewer.renderSettings),this.parseCfgFinish&&this.parseCfgFinish(),this.manager.dispatchEvent({type:r.EVENTS.ON_LOAD_START});const t=r.GlobalData.SceneSize;this.getTransforms().boundingBox=(new THREE.Box3).setFromArray([-t,-t,-t,t,t,t]),this.manager.updateScene(this);this.viewer.getScene().getMatrixGlobal().clone();this.loadModelConfig(this.viewer,this.loadTileConfig),this.manager.dispatchEvent({type:r.EVENTS.ON_LOAD_COMPLETE})}loadModelConfig(e,t){r.Tile.TileMath.unitScale=1,t.dataUrl=this.dataUrl,this.tileManager=new r.Tile.FullPlaneTileManager2(this,t,this.objectGroup)}hasTransforms(){return!0}preUpdate(e){}update(e){this.tileManager&&this.tileManager.update()}postUpdate(e){}isUserIdExist(e){return!1}}r.Tile.FullPlaneTileModel=e}(),r.Layer.Imagery=class{constructor(e){this.imageryLayer=e.layer,this.x=e.x,this.y=e.y,this.level=e.level,this.request=void 0,this.state=r.Layer.ImageryState.UNLOADED,this.imageUrl=void 0,this.image=void 0,this.texture=void 0,this._destroyed=!1,this.referenceCount=0}destroy(){this._destroyed=!0,this.image&&this.image.destroy&&this.image.destroy(),this.image=void 0,this.texture&&this.texture.destroy&&this.texture.destroy(),this.texture=void 0,this.request&&(this.request.destroy(),this.request=void 0),this.imageryLayer.removeImagery(this),this.imageryLayer=void 0}isDestroyed(){return this._destroyed}addReference(){++this.referenceCount}releaseReference(){return--this.referenceCount,0!==this.referenceCount?this.referenceCount:(this.destroy(),0)}get contentUnloaded(){return this.state===r.Layer.ImageryState.UNLOADED}get contentFailed(){return this.state===r.Layer.ImageryState.FAILED}get contentReady(){return this.state===r.Layer.ImageryState.READY}},function(){class e{constructor(e){this.imageryProvider=e.imageryProvider,this.show=r.Utils.defaultValue(e.show,!0),this.lastShow=!0,this.layerIndex=-1,this.baseLayer=!1,this._imageryCache={},this._destroyed=!1,this._skeleton=new r.Layer.Imagery({layer:this,x:0,y:0,level:0})}destroy(){this._destroyed=!0,this._skeleton.destroy(),this._skeleton=void 0,this.destroyAllImagery(),this._imageryCache=void 0,this.imageryProvider&&this.imageryProvider.destroy&&this.imageryProvider.destroy(),this.imageryProvider=void 0}isDestroyed(){return this._destroyed}static getImageryCacheKey(e,t,i){return`${e}-${t}-${i}`}_createTileImagerySkeletons(e,t,i){if(r.Utils.defined(this._minTerrainLevel)&&e.level<this._minTerrainLevel)return!1;if(r.Utils.defined(this._maxTerrainLevel)&&e.level>this._maxTerrainLevel)return!1;const a=this.imageryProvider;return r.Utils.defined(i)||(insertionPoint=e.imageries.length),a.ready?void 0:(this._skeleton.addReference(),e.imageries.splice(i,0,this._skeleton),!0)}getImagery(t,i,a){const n=e.getImageryCacheKey(t,i,a);let s=this._imageryCache[n];return r.Utils.defined(s)||(s=new r.Layer.Imagery({layer:this,x:t,y:i,level:a}),this._imageryCache[n]=s),s.addReference(),s}destroyAllImagery(){Object.keys(this._imageryCache).forEach((e=>{let t=this._imageryCache[e];t.isDestroyed()||t.destroy(),delete this._imageryCache[e]}))}removeImagery(t){if(!this._imageryCache)return;const i=e.getImageryCacheKey(t.x,t.y,t.level);delete this._imageryCache[i]}}r.Layer.ImageryLayer=e}(),r.Layer.ImageryLayerCollection=class{constructor(){this._layers=[],this.layerAdded=new r.Event,this.layerRemoved=new r.Event,this.layerMoved=new r.Event,this.layerShownOrHidden=new r.Event,this._destroyed=!1}destroy(){this._destroyed=!0,this.removeAll(!0),this._layers=void 0,this.layerAdded=void 0,this.layerRemoved=void 0,this.layerShownOrHidden=void 0}isDestroyed(){return this.destroyed}get length(){return this._layers.length}add(e,t){void 0===t?(t=this._layers.length,this._layers.push(e)):this._layers.splice(t,0,e),this.update(),this.layerAdded.fireEvent(e,t)}addImageryLayer(e,t){const i=new r.Layer.ImageryLayer({imageryProvider:e});return this.add(i,t),i}traverse(e,t){const i=t?Array.from(this._layers):this._layers;t&&i.sort(((e,t)=>e.sequence-t.sequence)),i.forEach((t=>e(t)))}remove(e,t){t=r.Utils.defaultValue(t,!0);const i=this._layers.indexOf(e);return-1!==i&&(this._layers.splice(i,1),this.update(),this.layerRemoved.fireEvent(e,i),t&&e.destroy(),!0)}removeAll(e){e=r.Utils.defaultValue(e,!0),this._layers.forEach(((t,i)=>{this.layerRemoved.fireEvent(t,i),e&&t.destroy()})),this._layers=[]}contains(e){return-1!==this._layers.indexOf(e)}get(e){return this._layers[e]}getByFilter(e){const t=[];return this._layers.forEach((i=>{e&&!e(i)||t.push(i)})),t}update(){const e=this._layers;let t,i=!0;e.forEach(((e,a)=>{e.layerIndex=a,e.show?(e.baseLayer=i,i=!1):e.baseLayer=!1,e.show!==e.lastShow&&(r.Utils.defined(e.lastShow)&&(r.Utils.defined(t)||(t=[]),t.push(e)),e.lastShow=e.show)})),r.Utils.defined(t)&&t.forEach((e=>{this.layerShownOrHidden.fireEvent(e,e.layerIndex,e.show)}))}getLayerIndex(e){return this._layers.indexOf(e)}moveToTop(e){const t=this._layers,i=this.getLayerIndex(e);i!==t.length-1&&(t.splice(i,1),t.push(e),this.update(),this.layerMoved.fireEvent(e,t.length-1,i))}moveToBottom(e){const t=this._layers,i=this.getLayerIndex(e);0!==i&&(t.splice(i,1),t.splice(0,0,e),this.update(),this.layerMoved.fireEvent(e,0,i))}moveToIdx(e,t){const i=this._layers,r=this.getLayerIndex(e);r!==t&&(t<0||t>i.length-1||(i.splice(r,1),i.splice(t,0,e),this.update(),this.layerMoved.fireEvent(e,t,r)))}},function(){class e{constructor(e){e=r.Utils.defaultValue(e,{}),this._option=e,this.mapUrl=e.mapUrl,this.id=e.layerId||r.Utils.getEncodedString(this.mapUrl),this.useClipping=e.useClipping,this._destroyed=!1,this._textureLoader=new THREE.TextureLoader,this._textureLoader.crossOrigin=!0,this.ready=!0,this._readyPromise=void 0,this.maxLimitedLevel=void 0}get readyPromise(){return this._readyPromise}destroy(){this._destroyed=!0,this._textureLoader=void 0,this._readyPromise=void 0}isDestroyed(){return this._destroyed}isAvailableTile(e,t,i){return void 0===this.maxLimitedLevel||i<=this.maxLimitedLevel}getImageryUrl(t,i,r){return e.getRequestMapUrl(this.mapUrl,t,i,r)}getTileMaterial(e){if(!e.texture)return;e.texture.encoding=THREE.GammaEncoding;const t=new r.MapTileMaterial({map:e.texture,transparent:!e.imageryLayer.baseLayer,side:THREE.FrontSide});t._originalTransparent=t.transparent;const i=r.MaterialUtil.getImageByteSize(e.texture.image);return t._imageByteSize+=i,this.useClipping&&(t.defines.USE_CLIPPING=""),t}loadArrayBufferImmediately(e,t,i){if(!this.isDestroyed())if(r.EnableStorage)r.storageManager.getTexture(e).then((e=>t(e))).catch((a=>{if(this.isDestroyed())return;this._textureLoader.load(e,(function(i){t(i),r.storageManager.addTexture(i,e).catch((e=>{}))}),void 0,(function(e){i(e)}))}));else{this._textureLoader.load(e,(function(e){t(e)}),void 0,(function(e){i(e)}))}}cloneParameters(){return Object.assign(this._option)}setReadyCallback(e){}getQuadX(e,t){return e}getQuadY(e,t){return e}static getRequestMapUrl(e,t,i,r){var a={"{x}":t.toString(),"{y}":i.toString(),"{z}":r.toString()},n=new RegExp(Object.keys(a).join("|"),"gi");return e=e.replace(n,(function(e){return a[e]}))}}r.Layer.ImageryProvider=e}(),function(){class e extends r.Layer.ImageryProvider{constructor(e){super(e)}getImageryUrl(e,t,i){return r.Layer.ImageryProvider.getRequestMapUrl(this.mapUrl,e,t,i)}}r.Layer.UrlTemplateImageryProvider=e}(),function(){class e extends r.Layer.ImageryProvider{constructor(e){super(e)}getImageryUrl(e,t,i){let r=this.mapUrl;const a=i%8;var n={"{x}":t.toString(),"{y}":e.toString(),"{z}":i.toString()},s=new RegExp(Object.keys(n).join("|"),"gi");if(r=r.replace(s,(function(e){return n[e]})),r.indexOf("tianditu.gov.cn")>=0){let e=/http[s]?(:\/\/t[1]?[0-9].)/.exec(r);if(e){let t=e[1];r=r.replace(t,`://t${a}.`)}}return r}}r.Layer.WebMapTileServiceTDUImageryProvider=e}(),function(){let e=new THREE.Vector2,t=new THREE.Vector2,i=new THREE.Box2;class a extends r.Layer.ImageryProvider{constructor(e){super(e),this._jsonLoader=new THREE.FileLoader,this._jsonLoader.setResponseType("json"),this._imagePostfix=void 0,this._urlTemplate=void 0,this.ready=!1,this._availableTilesChecked=!1,this._readyCallback=null,this.checkIfReady()}destroy(){this._jsonLoader=void 0,this._readyCallback=null,super.destroy()}setReadyCallback(e){this._readyCallback=e}checkIfReady(){this._readyPromise=this._fetchMetadata().then((()=>{this.ready=!0,this._readyCallback&&this._readyCallback()})).catch((()=>{this.ready=!1}))}_fetchMetadata(){const e=this._textureLoader,t=this._jsonLoader,i=this.mapUrl,r=[],a=new Promise(((e,r)=>{const a=`${i}/meta.json`;t.load(a,(t=>{this._parseMetaConfig(t),e()}),void 0,(()=>{r()}))})),n=new Promise(((e,r)=>{const a=`${i}/layer.json`;t.load(a,(t=>{this._parseLayerConfig(t),e()}),void 0,(()=>{r()}))}));return r.push(a),r.push(n),new Promise(((t,i)=>{Promise.all(r).then((()=>{const r=this.getImageryUrl(0,0,0);r?e.load(r,(function(){t()}),void 0,(function(){i()})):i()})).catch((e=>{console.log(e)}))}))}_parseMetaConfig(e){const t=e.contentType?e.contentType.split("/")[1]:void 0;this._imagePostfix=r.Utils.defaultValue(t,"png"),this._bounds=e.bounds,this._maxzoom=e.maxzoom,this._minzoom=e.minzoom}_parseLayerConfig(i){this._projection=i.projection,this._scheme=i.scheme;const a=i.tiles?i.tiles[0].split(".")[0]:void 0;if(this._urlTemplate=r.Utils.defaultValue(a,"{z}/{x}/{y}"),this._availableTiles=i.available,this._availableTiles&&this._availableTiles.length){this._availableTileBounds=new THREE.Box2;const i=this._availableTileBounds;this._availableTiles.forEach((r=>{r.forEach((r=>{i.expandByPoint(e.set(r.startX,r.startY)),i.expandByPoint(t.set(r.endX,r.endY))}))}))}}isAvailableTile(a,n,s){if(void 0!==this.maxLimitedLevel&&s>this.maxLimitedLevel)return!1;if(this._maxzoom&&(s<this._minzoom||s>this._maxzoom))return!1;const o=this._bounds;if(o){const e=r.Tile.TileMath.long2tile(o.west,s),t=r.Tile.TileMath.long2tile(o.east,s),i=r.Tile.TileMath.lat2tile(o.south,s),l=r.Tile.TileMath.lat2tile(o.north,s),d=Math.min(i,l),h=Math.max(i,l);if(a<e||a>t||n<d||n>h)return!1}if(this._availableTilesChecked){const r=this._availableTileBounds;if(r&&!r.containsPoint({x:a,y:n}))return!1;const s=this._availableTiles;if(s){return s.some((r=>r.some((r=>(i.makeEmpty(),i.expandByPoint(e.set(r.startX,r.startY)),i.expandByPoint(t.set(r.endX,r.endY)),i.containsPoint({x:a,y:n}))))))}}return!0}getImageryUrl(e,t,i){if(!this._imagePostfix||!this._urlTemplate)return;let a=`${this.mapUrl}/${this._urlTemplate}.${this._imagePostfix}`;return r.Layer.ImageryProvider.getRequestMapUrl(a,e,t,i)}}r.Layer.SpecificMapServiceImageryProvider=a}(),r.Layer.ImageryProviderFactory={UrlTemplate:function(e){return new r.Layer.UrlTemplateImageryProvider(e)},WebMapTileServiceTDU:function(e){return new r.Layer.WebMapTileServiceTDUImageryProvider(e)},SpecificMapService:function(e){return new r.Layer.SpecificMapServiceImageryProvider(e)},TileMapBingMapService:function(e){return new r.Layer.TileMapBingMapServiceProvider(e)},TileMapTencentMapService:function(e){return new r.Layer.TileMapTencentMapServiceProvider(e)},TileMapService:function(e){return new r.Layer.TileMapServiceProvider(e)},WebMapService:function(e){return new r.Layer.WebMapServiceProvider(e)},WebMapTileService:function(e){return new r.Layer.WebMapTileServiceTDUImageryProvider(e)},BdMapService:function(e){return new r.Layer.BdImageryProvider(e)}},function(){class e extends r.Layer.ImageryProvider{constructor(e){super(e)}getImageryUrl(e,t,i){let r=this.mapUrl;const a=i%8;let n="";for(let r=i;r>0;r--){let i=0,a=1<<r-1;0!=(e&a)&&i++,0!=(t&a)&&(i++,i++),n+=i.toString()}""===n&&(n="0");var s={"{x}":n},o=new RegExp(Object.keys(s).join("|"),"gi");r=r.replace(o,(function(e){return s[e]}));let l=/http[s]?(:\/\/ecn.t[1]?[0-9].)/.exec(r);if(l){let e=l[1];r=r.replace(e,`://t${a}.`)}return r}}r.Layer.TileMapBingMapServiceProvider=e}(),function(){class e extends r.Layer.ImageryProvider{constructor(e){super(e)}getImageryUrl(e,t,i){let r=this.mapUrl;const a=i%4,n=(1<<i)-t-1;var s={"{x}":e,"{y}":n,"{sx}":e>>4,"{sy}":n>>4,"{z}":i},o=new RegExp(Object.keys(s).join("|"),"gi");r=r.replace(o,(function(e){return s[e]}));let l=/http[s]?(:\/\/p[1]?[0-9].)/.exec(r);if(l){let e=l[1];r=r.replace(e,`://p${a}.`)}return r}}r.Layer.TileMapTencentMapServiceProvider=e}(),function(){class e extends r.Layer.ImageryProvider{constructor(e){super(e)}getImageryUrl(e,t,i){const a=(1<<i)-t-1;return r.Layer.ImageryProvider.getRequestMapUrl(this.mapUrl,e,a,i)}getQuadY(e,t){return(1<<t)-e-1}}r.Layer.TileMapServiceProvider=e}(),function(){class e extends r.Layer.ImageryProvider{constructor(e){super(e)}getImageryUrl(e,t,i){const a=r.Tile.TileMath.tile2boundingBox(e,t,i);return this.mapUrl+`&bbox=${a.west}%2C${a.south}%2C${a.east}%2C${a.north}`}}r.Layer.WebMapServiceProvider=e}(),function(){class e extends r.Layer.ImageryProvider{constructor(e){super(e)}getImageryUrl(e,t,i){let r=this.mapUrl;const a=1<<i,n=1<<i,s=i+1,o=(e+t)%4;if(r.indexOf("bdimg.com")>=0){let e=/http[s]?(:\/\/maponline[1]?[0-9].)/.exec(r);if(e){let t=e[1];r=r.replace(t,`://maponline${o}.`)}}return r=r.replace("{x}",e-a/2).replace("{y}",n/2-t-1).replace("{z}",s),r}}r.Layer.BdImageryProvider=e}(),r.Layer.Terrain=class{constructor(e){this.state=r.Layer.TerrainState.UNLOADED,this.terrainData=void 0,this.request=void 0}destroy(){this.terrainData=void 0,this.request&&(this.request.destroy(),this.request=void 0)}unload(){this.state=r.Layer.TerrainState.UNLOADED,this.terrainData=void 0,this.request&&(this.request.destroy(),this.request=void 0)}get contentUnloaded(){return this.state===r.Layer.TerrainState.UNLOADED}get contentFailed(){return this.state===r.Layer.TerrainState.FAILED}get contentReady(){return this.state===r.Layer.TerrainState.READY}},r.Layer.TerrainProvider=class{constructor(e){this._levelZeroXTilesNumber=r.Utils.defaultValue(e.levelZeroXTilesNumber,1),this._levelZeroYTilesNumber=r.Utils.defaultValue(e.levelZeroYTilesNumber,1);const t=e.terrainMetadata;this.updateTerrainMetadata(t),this.terrainDataUrl=e.terrainPath?new r.Tile.DemUrl(e.terrainPath):void 0,this.useTerrain=!!this.terrainDataUrl&&r.Utils.defaultValue(e.useTerrain,!1),this.tileGeometrySegments=r.Utils.defaultValue(e.tileGeometrySegments,16),this.maxLimitedLevel=r.Utils.defaultValue(e.maxLevel,18),this._heightmapQuality=.25,this._maximumRadius=6378137,this._unitScale=r.Utils.defaultValue(e.unitScale,1),this._levelZeroMaxGeometricError=this._unitScale*this.getLevelZeroGeometricError(64,this.getXTilesNumber(0)),this.mercatorPerimeter=this._unitScale*r.Utils.defaultValue(e.mercatorPerimeter,2*r.Tile.TileMath.mercatorPerimeter),this.tileBuilder=new r.Tile.PlaneTileBuilder,this.defaultTileGeometry=new THREE.PlaneBufferGeometry(1,1,this.tileGeometrySegments),this.defaultTileGeometry._onlyShared=!0,this.ready=!1,this.getTerrainMetadata(),this.terrainLoader=new THREE.FileLoader,this.terrainLoader.setResponseType("arraybuffer"),this.terrainLoader.crossOrigin=!0,this.terrainSeamThreshold=.5*this._unitScale,this.planeSeamThreshold=1*this._unitScale}destroy(){this.tileBuilder.destroy(),this.tileBuilder=void 0,this.defaultTileGeometry.dispose(),this.defaultTileGeometry=void 0,this.terrainLoader=void 0}setSource(e,t){return this.terrainDataUrl.terrainPath=e.url,this.getTerrainMetadata(t)}getSource(){return this.terrainDataUrl.terrainPath}getXTilesNumber(e){return this._levelZeroXTilesNumber<<e}getYTilesNumber(e){return this._levelZeroYTilesNumber<<e}getLevelZeroGeometricError(e,t){return 2*this._maximumRadius*Math.PI*this._heightmapQuality/(e*t)}getLevelMaxGeometricError(e){return this._levelZeroMaxGeometricError/(1<<e)}createTerrain(e,t,i,a){return new r.Layer.Terrain({})}updateTerrainMetadata(e){this.terrainBoundary=e.boundary,this._minTerrainLevel=e.minLevel,this._maxTerrainLevel=e.maxLevel}getTerrainMetadata(e){if(!1===this.useTerrain)return void(this.ready=!0);const t=this.terrainDataUrl.terrainPath,i=t.indexOf("{z}"),r=`${t.slice(0,i)}layer.json.gz`;let a=new THREE.FileLoader;return a.setResponseType("json"),new Promise(((t,i)=>{a.load(r,(i=>{this.terrainMetadata=i,this.updateTerrainMetadata(this.terrainMetadata),this.ready=!0,e&&e(),t()}),void 0,(()=>{this.ready=!0,e&&e(),i()}))}))}isAvailableTile(e,t,i){if(!this.useTerrain)return!0;if(i<this._minTerrainLevel)return!1;let r=this.terrainBoundary[i];if(!r){const e=this.terrainBoundary[this._maxTerrainLevel],t=1<<i-this._maxTerrainLevel,a=e.leftX*t+0,n=e.upY*t+0,s=e.rightX*t+1,o=e.bottomY*t+1;this.terrainBoundary[i]={},this.terrainBoundary[i].leftX=a,this.terrainBoundary[i].upY=n,this.terrainBoundary[i].rightX=s,this.terrainBoundary[i].bottomY=o,r=this.terrainBoundary[i]}return e>=r.leftX&&e<=r.rightX&&t>=r.upY&&t<=r.bottomY}getAvailableTile(e,t,i,r){if(0===i)return;const a=(i/r|0)*r,n=1<<i-a;return{level:a,x:e/n|0,y:t/n|0}}getTileAvailable(e,t,i){}getTileBoundingBox(e,t,i){const r=this.mercatorPerimeter/Math.pow(2,i),a=-.5*this.mercatorPerimeter+e*r,n=a+r,s=.5*this.mercatorPerimeter-t*r,o=s-r;return new THREE.Box3(new THREE.Vector3(a,o,-1),new THREE.Vector3(n,s,1))}isOverMaxLevel(e){return!!this.useTerrain&&e>this._maxTerrainLevel}getLevelXYOfDataSource(e,t,i){const r=this._maxTerrainLevel;if(i>r)return this.getParentLevelXY(e,t,i,r)}getParentLevelXY(e,t,i,r){const a=1<<i-r;return{x:e/a|0,y:t/a|0,level:r,divisor:a,xIndex:e%a,yIndex:t%a}}getTerrainUrlWithoutOpenTerrain(e,t,i){return this.terrainDataUrl.terrainUrl(i,e,t)}getTerrainUrl(e,t,i){if(this.useTerrain)return this.terrainDataUrl.terrainUrl(i,e,t)}getTileGeometry(e){if(!this.useTerrain)return e.updateTerrainHeight(1,-1),{geometry:this.defaultTileGeometry,matrix:this._getTileTransformMatrix(e,!0)};const{x:t,y:i,level:r}=e,a=e.tileTerrain.terrainData,n=this.getTileGeometryByData(a,t,i,r,!1),s=n.geometry;return s.computeBoundingBox(),e.updateTerrainHeight(s.boundingBox.max.z,s.boundingBox.min.z),n}getTileGeometryByData(e,t,i,r,a){const n=this.tileGeometrySegments,s=this.mercatorPerimeter/Math.pow(2,r)+this.terrainSeamThreshold,o=this.tileBuilder.computePlaneGeometry(s,s,n,e,a,this._unitScale);return{geometry:o[0],skirtGeometry:o[1],matrix:this._getTileTransformMatrix({x:t,y:i,level:r},!1)}}updateTileGeometryForFlatten(e,t,i,r,a,n){if(!this.useTerrain)return;const s=this.tileGeometrySegments,o=e.tileTerrain.terrainData,l=this.mercatorPerimeter/Math.pow(2,e.level)+this.terrainSeamThreshold;this.tileBuilder.updateGeometryForFlatten(l,l,s,o,!1,this._unitScale,t,i,r,a,n)}getTerrainDataArray(e){const t=this.tileGeometrySegments,i=Array.prototype.slice.call(new Int16Array(e));let a=new Array(t+1);for(let e=0,n=a.length;e<n;e++){a[e]=new Array(t+1);for(let n=0,s=t+1;n<s;n++)i[e*(t+1)+n]!==r.Tile.DemTilesUtil.InvalidTerrainValue?a[e][n]=i[e*(t+1)+n]:a[e][n]=0}return a}getTerrainDataArrayOutOfLevel(e){if(e.parent&&e.parent.tileTerrain.terrainData)return this.getTerrainDataArrayFromParent(e)}getTerrainDataArrayWithTerrainLevel(e,t,i,a,n){const s=this.tileGeometrySegments,{divisor:o,xIndex:l,yIndex:d}=this.getParentLevelXY(e,t,i,a),h=s/o,c=l*h,u=d*h;let p=new Array(h+1);for(let e=0,t=p.length;e<t;e++){p[e]=new Array(h+1);for(let t=0;t<=h;++t)p[e][t]=n[u+e][c+t]}return r.Tile.TileMath.createHeightArray(p,s)}getTerrainDataArrayFromParent(e){const t=e._parent.tileTerrain.terrainData,i=this.tileGeometrySegments,{divisor:a,xIndex:n,yIndex:s}=this.getParentLevelXY(e.x,e.y,e.level,e._parent.level),o=i/a,l=n*o,d=s*o;let h=new Array(o+1);for(let e=0,i=h.length;e<i;e++){h[e]=new Array(o+1);for(let i=0;i<=o;++i)h[e][i]=t[d+e][l+i]}return r.Tile.TileMath.createHeightArray(h,i)}_getTileTransformMatrix(e,t){const{x:i,y:r,level:a}=e,n=a>0?Math.pow(2,a)/2:0,s=this.mercatorPerimeter/Math.pow(2,a),o=s+this.planeSeamThreshold,l=t?(new THREE.Matrix4).makeScale(o,o,1):new THREE.Matrix4,d=i*s+.5*s-n*s,h=-(r*s+.5*s-n*s),c=(new THREE.Matrix4).makeTranslation(d,h,0),u=new THREE.Matrix4;return u.premultiply(l).premultiply(c),u}loadArrayBufferImmediately(e,t,i){this.terrainLoader.load(e,(function(e){t(e)}),void 0,(function(e){i(e)}))}getMaxMinTerrainLevel(){return{maxLevel:this._maxTerrainLevel,minLevel:this._minTerrainLevel}}setMercatorPerimeter(e){this.mercatorPerimeter=this._unitScale*e}},function(){let e=new THREE.Box3,t=new THREE.Matrix4;r.Layer.GlobeTileProvider=class{constructor(e){if(this.imageryLayers=new r.Layer.ImageryLayerCollection,this.terrainProvider=new r.Layer.TerrainProvider(e.loadConfig),this.terrainOperationManager=e.terrainOperationManager,this.globeLayer=e.globeLayer,this.mapExcavation=e.loadConfig.mapExcavation||{},this.mapStyle={},this.presetOpacity=1,this.tileOpacity={},this.tileVisible={},this.show=!0,this.skirtShow=!0,this._layerOrderChanged=!1,this._materialCache={},this._skirtMeshCache={},!1!==e.loadConfig.useDefaultImagery&&e.loadConfig.mapUrl){this.baseLayerId=this.addImageryLayer({imageryProviderType:e.loadConfig.imageryProviderType,useClipping:e.loadConfig.sectionable,mapLayer:e.loadConfig.mapLayer,mapUrl:e.loadConfig.mapUrl});const t=e.loadConfig.opacity||1;this.tileOpacity[this.baseLayerId]=t,this.tileVisible[this.baseLayerId]=!0,this.mapStyle[this.baseLayerId]=e.loadConfig.mapStyle||{}}}destroy(){this.terrainProvider.destroy(),this.terrainProvider=void 0,this.imageryLayers.destroy(),this.ImageryLayers=void 0,this._materialCache=void 0,this._skirtMeshCache=void 0,this.terrainOperationManager=void 0,this.baseLayerId=void 0,this.presetOpacity=void 0}static getTileCacheKey(e,t,i){return`${e}-${t}-${i}`}setPresetOpacity(e){this.presetOpacity=e}getPresetOpacity(){return this.presetOpacity}get ready(){return this.terrainProvider.ready&&this.imageryLayers.length&&this.imageryLayers.get(0).imageryProvider.ready}canRefine(e){return!!e.terrainData||void 0!==this.terrainProvider.getTileDataAvailable(2*e.x,2*e.y,e.level+1)}_onLayerAdded(e,t){this._layerOrderChanged=!0}_onLayerRemoved(e,t){this._layerOrderChanged=!0}_onLayerMoved(e,t,i){this._layerOrderChanged=!0}parseTileContent(e,t){e.isDestroyed()||(this._createTileMesh(e),t(e))}_createTileMesh(e){const t=e.content.meshes,i=this.terrainProvider.getTileGeometry(e),a=r.EnumLayerBaseRenderOrder.MAP;e.imageries.forEach(((n,s)=>{const o=n.imageryLayer.imageryProvider,l=o.id,d=o.getTileMaterial(n);if(!d)return;this.updateTileMaterial(d,l);const h=a+s;let c=new r.MeshEx(i.geometry,d);if(c.name=e.name,c.renderOrder=h,c.layerId=l,i.matrix&&c.matrix.copy(i.matrix),r.GlobalData.EnableShadowMap&&(c.castShadow=this.globeLayer.castShadow,c.receiveShadow=this.globeLayer.receiveShadow),t.add(c),this.updateTileMesh(c,l),i.skirtGeometry){let a=new r.MeshEx(i.skirtGeometry,d);a.name=`Skirt-${e.name}`,a.renderOrder=h,a.layerId=l,i.matrix&&a.matrix.copy(i.matrix),r.GlobalData.EnableShadowMap&&(a.castShadow=this.globeLayer.castShadow,a.receiveShadow=this.globeLayer.receiveShadow),t.add(a),this.updateSkirtVisible(a,l),this._cacheSkirtMesh(l,a)}this._cacheMaterial(l,d)})),this.updateTileMeshForFlatten(e)}setBaseLayerId(e){this.baseLayerId=e}getBaseLayerId(){return this.baseLayerId}getAllLayerIds(){const e=this.imageryLayers.getByFilter();let t=[];for(const i of e)t.push(i.imageryProvider.id);return t}updateTileMeshForFlatten(i){if(i.content){var a=i.content.meshes;if(a&&2==a.children.length){var n=a.children[0],s=a.children[1],o=this.terrainOperationManager,l=i._tileset._objectGroup.matrix,d=!1;if(i.boundingBox&&(e.copy(i.boundingBox),e.applyMatrix4(l),e.min.y=0,e.max.y=0,d=o.isIntersectFlattenBboxDrawing(e,r.ObjectGroupType.TILEGROUP)),!d&&i.isFlattened)return this.terrainProvider.updateTileGeometryForFlatten(i,o,t,n.geometry,s.geometry,!0),void(i.isFlattened=!1);if(d){var h=n.matrix;t.multiplyMatrices(l,h),this.terrainProvider.updateTileGeometryForFlatten(i,o,t,n.geometry,s.geometry,!1),i.isFlattened=!0}}}}clearMaterialAndSkirtCache(){for(let e in this._materialCache)delete this._materialCache[e];for(let e in this._skirtMeshCache)delete this._skirtMeshCache[e]}removeFromMaterialAndSkirtCache(e){this._materialCache[e]&&delete this._materialCache[e],this._skirtMeshCache[e]&&delete this._skirtMeshCache[e]}_cacheMaterial(e,t){this._materialCache[e]||(this._materialCache[e]=[]),this._materialCache[e].push(t)}_cacheSkirtMesh(e,t){this._skirtMeshCache[e]||(this._skirtMeshCache[e]=[]),this._skirtMeshCache[e].push(t)}setOpacity(e,t){this.tileOpacity[t]=e;const i=r.Tile.DemTilesUtil.isTransparent(e),a=this._materialCache[t];a&&(a.forEach((e=>{this.updateTileMaterialOpacity(e,t)})),i||!0!==this.tileVisible[t]?this.hideSkirt():this.showSkirt())}getOpacity(e){return this.tileOpacity[e]}setImageryLayerVisible(e,t){this.tileVisible[e]=t,this.globeLayer.setImageryLayerVisible(e,t)}hasImageryLayerVisible(){return Object.keys(this.tileVisible).some((e=>!0===this.tileVisible[e]))}setStyle(e,t){this.mapStyle[t]=e;const i=this._materialCache[t];i&&i.forEach((e=>{this.updateTileMaterialStyle(e,t)}))}setExcavation(e){this.mapExcavation=e;for(const t in this._materialCache){if(e.cullImageLayerIds&&!e.cullImageLayerIds.includes(t))continue;this._materialCache[t].forEach((e=>{this.updateTileMaterialExcavation(e),this.updateTileMaterialSide(e)}))}}updateMaterialsSide(){const e=this.getBaseLayerId();this._materialCache[e].forEach((e=>{this.updateTileMaterialSide(e)}))}updateTileMaterialStyle(e,t){e.updateStyle&&this.mapStyle[t]&&e.updateStyle(this.mapStyle[t])}updateTileMaterialExcavation(e){e.updateExcavation&&e.updateExcavation(this.mapExcavation)}updateTileMaterialSide(e){e.updateSide&&e.updateSide({isExcavation:this.mapExcavation&&this.mapExcavation.isExcavation})}updateTileMaterial(e,t){this.updateTileMaterialStyle(e,t),this.updateTileMaterialOpacity(e,t)}updateTileMesh(e,t){const i=this.tileVisible[t];e.visible=i}updateTileMaterialOpacity(e,t){const i=this.tileOpacity[t];e.opacity=i,e._originalTransparent||(e.transparent=r.Tile.DemTilesUtil.isTransparent(i))}updateMaterialsValue(e,t,i,r){for(const e in this._materialCache){this._materialCache[e].forEach((e=>{if(e&&e.hasOwnProperty(t)){if(r&&0==e.receiveIBL)return;e[t]=i,void 0!==e.refreshUniforms&&e.refreshUniforms(),e.needsUpdate=!0}}))}}hideSkirt(){this.skirtShow=!1;for(const e in this._skirtMeshCache){this._skirtMeshCache[e].forEach((e=>{e.visible=!1}))}}showSkirt(){this.skirtShow=!0;for(const e in this._skirtMeshCache){this._skirtMeshCache[e].forEach((e=>{e.visible=!0}))}}updateSkirtVisible(e,t){if(this.tileVisible[t]){r.Tile.DemTilesUtil.isTransparent(this.tileOpacity[t])&&this.skirtShow&&(this.skirtShow=!1),e.visible=this.skirtShow}else e.visible=!1}getMaxLimitedLevel(){return this.terrainProvider.maxLimitedLevel}setMaxLimitedLevel(e){this.terrainProvider.maxLimitedLevel=e}isUseTerrain(){return this.terrainProvider.useTerrain}setTerrainEnabled(e){return this.terrainProvider.terrainDataUrl?this.terrainProvider.useTerrain!==e&&(this.terrainProvider.useTerrain=e,!0):(console.log("No terrain data is set, cannot switch terrain!"),!1)}setTerrainProvider(e,t){return this.terrainProvider.setSource(e,t)}getTerrainUrl(){return this.terrainProvider.getSource()}getMaxImageryLevel(e){const t=this.getImageryLayerById(e);return t?t.imageryProvider.maxLimitedLevel:this.terrainProvider.maxLimitedLevel}setMaxImageryLevel(e,t){const i=this.getImageryLayerById(e);i&&(i.imageryProvider.maxLimitedLevel=t)}createDefaultImageryProvider(e){return void 0===e.imageryProviderType&&(e.imageryProviderType="UrlTemplate"),new r.Layer.ImageryProviderFactory[e.imageryProviderType](e)}getBaseImageryLayer(){const e=this.imageryLayers.getByFilter();return e.length>0?e[0]:void 0}getImageryLayerById(e){const t=this.imageryLayers.getByFilter((t=>t.imageryProvider.id===e));return t.length>0?t[0]:void 0}getImageryLayerByMapUrl(e){const t=this.imageryLayers.getByFilter((t=>t.imageryProvider.mapUrl===e));return t.length>0?t[0]:void 0}addImageryLayer(e,t){const i=this.imageryLayers.addImageryLayer(this.createDefaultImageryProvider(e),t).imageryProvider.id;return this.tileOpacity[i]=e.opacity||this.presetOpacity,this.tileVisible[i]=r.Utils.defaultValue(e.visible,!0),i}removeImageryLayer(e){delete this.tileOpacity[e],delete this.tileVisible[e],this.removeFromMaterialAndSkirtCache(e);const t=this.getImageryLayerById(e);t&&this.imageryLayers.remove(t)}adjustImageryLayer(e,t){const i=this.getImageryLayerById(e);i&&this.imageryLayers.moveToIdx(i,t)}getImageryLayerIndex(e){const t=this.getImageryLayerById(e);return t?this.imageryLayers.getLayerIndex(t):-1}}}(),function(){class e{static makeRequest(e,t){e.requestCallback=function(){const i=new r.Deferred;return t(e.url,(function(e){i.resolve(e)}),(function(e){i.reject(e)})),e.cancelCallback=function(){},i.promise};const i=r.RequestScheduler.request(e);if(i)return i.then((function(t){return e.cancelCallback=void 0,t})).catch((function(t){return e.cancelCallback=void 0,Promise.reject(t)}))}static processTerrain(e,t){}static requestTerrain(t){const i=t.tileTerrain;if(!i.contentUnloaded)return;const a=r.Layer.TerrainState,n=t._tileset.tileProvider.terrainProvider,s=n.getTerrainUrl(t.x,t.y,t.level);function o(e){i.terrainData=e,i.state=a.READY,i.request=void 0}function l(){i.state=a.FAILED,i.request=void 0}if(n.isAvailableTile(t.x,t.y,t.level))if(s)if(n.isOverMaxLevel(t.level)){const e=n.getTerrainDataArrayOutOfLevel(t);e&&o(e)}else!function(){const n=new r.Request({url:s,type:r.RequestType.TERRAIN,priorityCallback:t._createPriorityCallback(t)});i.request=n,i.state=a.RECEIVING;const h=e.makeRequest(n,d);if(!h)return i.state=a.UNLOADED,void(i.request=void 0);h.then((function(e){t.isDestroyed()?l():o(e)})).catch((function(e){!function(){if(i.request&&i.request.state===r.RequestState.CANCELLED)return i.terrainData=void 0,i.state=a.UNLOADED,i.request=void 0,--t._tileset.statistics.numberOfPendingRequests,void++t._tileset.statistics.numberOfAttemptedRequests;i.state=a.FAILED,i.request=void 0;const e=`Failed to obtain terrain tile X: ${t.x} Y: ${t.y} Level: ${t.level}.`;console.log(e)}()}))}();else o();else l();function d(e,i,r){n.loadArrayBufferImmediately(e,(function(e){i(n.getTerrainDataArray(e))}),(function(){const e=n.getTerrainDataArrayOutOfLevel(t);e?i(e):r()}))}}static requestImageries(t){const i=t._tileset.tileProvider.imageryLayers._layers;t.imageries.length=0,i.forEach((i=>{const r=i.getImagery(t.x,t.y,t.level);t.imageries.push(r),e.requestImagery(t,r)}))}static requestImagery(t,i){const a=i.imageryLayer.imageryProvider;if(!i.contentUnloaded||!a.ready||!a.mapUrl)return;const n=r.Layer.ImageryState;function s(){i.state=n.FAILED,i.request=void 0}if(!a.isAvailableTile(t.x,t.y,t.level))return void s();const o=a.getImageryUrl(t.x,t.y,t.level);function l(e,t,i){a.loadArrayBufferImmediately(e,t,i)}!function(){const a=new r.Request({url:o,type:r.RequestType.IMAGERY,priorityCallback:t._createPriorityCallback(t)});i.request=a,i.state=n.TRANSITIONING;const d=e.makeRequest(a,l);if(!d)return i.state=n.UNLOADED,void(i.request=void 0);d.then((function(e){var r;t.isDestroyed()?s():(r=e,i.texture=r,i.state=n.READY,i.request=void 0)})).catch((function(e){!function(){if(i.request&&i.request.state===r.RequestState.CANCELLED)return i.state=n.UNLOADED,void(i.request=void 0);i.state=n.FAILED,i.request=void 0;const e=`Failed to obtain image tile X: ${i.x} Y: ${i.y} Level: ${i.level}.`;console.log(e)}()}))}()}static processImageries(t,i){let r=!1,a=!0;return t.imageries.forEach((n=>{const s=e.processImagery(t,n,i);a=a&&s,r=r||s})),t.renderable=t.renderable&&(r||a),a}static processImagery(t,i,a){const n=r.Layer.ImageryState;return i.state===n.UNLOADED&&(i.state=n.TRANSITIONING,e.requestImagery(t,i)),i.state===n.RECEIVED&&(i.state=n.TRANSITIONING,i.imageryLayer._createTexture(i,a)),i.state===n.TEXTURE_LOADED&&(i.state=n.TRANSITIONING,i.imageryLayer._reprojectTexture(i,a)),i.state===n.READY||(i.state===n.FAILED||i.state===n.INVALID)}}r.Layer.GlobeTileScheduler=e}(),function(){class e extends r.AbstractTileContent{constructor(e,t){super(e,t),this._geometryByteLength=0}destroy(){super.destroy()}getTexturesByteLength(){const e=this._meshes.children;for(let t of e)if(t.children&&t.children.length>0)for(let e of t){const t=e.material;t&&t._imageByteSize&&!t._sizeCached&&(this._texturesByteLength+=t._imageByteSize,t._sizeCached=!0)}else if(t.material){const e=t.material;e._imageByteSize&&!e._sizeCached&&(this._texturesByteLength+=e._imageByteSize,e._sizeCached=!0)}}disposeGeometry(){this._meshes.parent&&this._meshes.parent.remove(this._meshes);const e=this._meshes.children;for(let t=0,i=e.length;t<i;++t){const i=e[t];if(i.children&&i.children.length)for(let e=0,t=i.children.length;e<t;++e){const t=i.children[e];t.geometry._onlyShared||t.geometry.dispose(),t.geometry=void 0,this._disposeMaterial(t.material),t.material=void 0}else i.geometry&&(i.geometry._onlyShared||i.geometry.dispose(),i.geometry=void 0,this._disposeMaterial(i.material),i.material=void 0)}this._meshes=void 0}parseTileContent(e){this._tile._tileset.tileProvider.parseTileContent(this._tile,(function(t){e(t)}))}disposeContentBuffer(){}_disposeMaterial(e){r.Utils.isDefined(e.map)&&(e.map.dispose(),e.map=null),e.dispose()}}r.Layer.GlobeTileContent=e}(),function(){new THREE.Box3;class e extends r.AbstractTile{constructor(e,t){super(e,t.parent),this.x=t.x,this.y=t.y,this.level=t.level,this.name=`${this.x}-${this.y}-${this.level}`,this.refineReplace=!0,this.isGlobeTile=!0,this._contentType=r.TileContentType.DATA_MESH,this._contentIndex=this.name,this._debugLodLevel=this._parent?this._parent._debugLodLevel+1:0;const i=e.tileProvider.terrainProvider;this._boundingBox=i.getTileBoundingBox(this.x,this.y,this.level),this.geometricError=i.getLevelMaxGeometricError(this.level),this.invalid=!1,this.tileTerrain=new r.Layer.Terrain,this.renderable=!1,this.terrainMaxHeight=this._boundingBox.max.z,this.terrainMinHeight=this._boundingBox.min.z,this.imageries=[]}destroy(){super.destroy(),this.tileTerrain.destroy(),this.tileTerrain=null,this.imageries=null}get needsLoading(){return!this.isTerrainFailed()&&(!this.isTerrainReady()||this._isAnyImageryNoReady())}get contentDataAvailable(){return!this.contentTypeEmpty&&this.contentReady&&this._isAnyImageryReady()}fetchContentBlock(e,t,i){t()}createContent(e){return new r.Layer.GlobeTileContent(this,e)}isTerrainReady(){return this.tileTerrain.contentReady}isTerrainFailed(){return this.tileTerrain.contentFailed}_isAnyImageryNoReady(){return 0===this.imageries.length||this.imageries.some((e=>!e.contentFailed&&!e.contentReady))}_isAnyImageryReady(){return this.imageries.some((e=>e.contentReady))}_isAllImageryReady(){if(0===this.imageries.length)return!1;let e=!0,t=!1;return this.imageries.forEach((i=>{e=e&&(i.contentReady||i.contentFailed),t=t||i.contentReady})),e&&t}_checkIfTerrainLoadingDone(){return this.renderable=!1,this.tileTerrain.contentFailed?(this._contentType=r.TileContentType.DATA_TILE,this._contentState=r.TileContentState.READY,!1):!!this.tileTerrain.contentReady&&(this.renderable=!0,!0)}_checkIfImageryLoadingDone(){return this._isAllImageryReady()}requestContent(){if(r.Layer.GlobeTileScheduler.requestTerrain(this),!this._checkIfTerrainLoadingDone())return!1;if(r.Layer.GlobeTileScheduler.requestImageries(this),!this._checkIfImageryLoadingDone()||!this.contentUnloaded)return!1;this._contentState=r.TileContentState.LOADING,this._contentProcessDeferred=new r.Deferred,this._contentReadyDeferred=new r.Deferred;const e=this._handleFailedContent(this,this._tileset),t=this;return Promise.resolve(this.tileTerrain.terrainData).then((function(i){t.isDestroyed()?e():t._initialContent(i)})).catch((function(i){t._contentState=r.TileContentState.UNLOADED,e(i)})),!0}updateTerrainHeight(e,t){this.terrainMaxHeight=e,this.terrainMinHeight=t,this._boundingBox.max.z=Math.max(1,this.terrainMaxHeight),this._boundingBox.min.z=Math.min(-1,this.terrainMinHeight)}_unloadContent(){super.unloadContent()}unloadContent(){this._contentType=r.TileContentType.DATA_MESH,this.tileTerrain.unload(),this._unloadImageryContent()}_unloadImageryContent(){this.imageries.forEach((e=>{e.isDestroyed()||e.destroy()})),this.imageries.length=0,this._unloadContent()}resetImageryContent(){this._unloadImageryContent()}resetTerrainContent(){this._contentType=r.TileContentType.DATA_MESH,this.tileTerrain.unload(),this._unloadContent()}resetBoundingBox(){const e=this._tileset.tileProvider.terrainProvider;this._boundingBox=e.getTileBoundingBox(this.x,this.y,this.level),this.terrainMaxHeight=this._boundingBox.max.z,this.terrainMinHeight=this._boundingBox.min.z}computeTransformedBoundingBox(e){return!(!e.transformMatrixUpdated&&void 0!==this._transformedBoundingBox&&!e.useTerrain)&&(void 0===this._transformedBoundingBox&&(this._transformedBoundingBox=new THREE.Box3),this._transformedBoundingBox.copy(this._boundingBox),e.transformMatrix&&this._transformedBoundingBox.applyMatrix4(e.transformMatrix),!0)}computeDistanceToCamera(e){const t=this._transformedBoundingBox;this._distance=t.distanceToPoint(e.cameraPositionWc)}culling(e,t){return(e.globalMatrixUpdated||t||e.useTerrain)&&(this._globaledBoundingBox.copy(this._transformedBoundingBox),e.useTerrain&&(this._globaledBoundingBox.max.z=Math.max(this._globaledBoundingBox.max.z,e.cameraPositionWc.z)),this._globaledBoundingBox.applyMatrix4(e.globalMatrix)),!!e.frustum.intersectsBox(this._globaledBoundingBox)}computePriority(){const e=this._tileset,t=e._priorityRange.max,i=e._priorityRange.min,a=r.Math.isolateDigits(r.Math.normalize(e.type,0,10),1,16),n=r.Math.isolateDigits(r.Math.normalize(e.sequence,0,100),1,14),s=e._skipLodEnabled?t.depth-this._depth:this._depth,o=r.Math.isolateDigits(r.Math.normalize(s,i.depth,t.depth),2,4),l=r.Math.isolateDigits(r.Math.normalize(this._distance,i.distance,t.distance),4,0);this._priority=a,this._priority+=n,this._priority+=o,this._priority+=l,this.parent&&(this.parent._minChildPriority=Math.min(this.parent._minChildPriority,this._priority))}getTerrainHeightRange(){return{max:this._transformedBoundingBox.max.z,min:this._transformedBoundingBox.min.z}}}r.Layer.GlobeTile=e}(),function(){function e(e,t){return e._priority-t._priority}class t extends r.AbstractTileset{constructor(e){super(e),this.maximumScreenSpaceError=e.maximumScreenSpaceError||2,this.tileProvider=new r.Layer.GlobeTileProvider(e),this._lastReady=void 0,this._ready=void 0,this._heightRangeOfVisibleTiles={max:-1/0,min:1/0},this._objectGroup.heightRange=this._heightRangeOfVisibleTiles}destroy(){this._lastReady=void 0,this._ready=void 0,this.tileProvider.destroy(),this.tileProvider=void 0,this._objectGroup.heightRange=void 0,this._heightRangeOfVisibleTiles=void 0,super.destroy()}get ready(){return this._ready}_isReady(){return!(!this._root||!this.tileProvider.ready)}checkReadyPreUpdate(e){void 0===this._lastReady&&(this._lastReady=this._isReady()),this._ready=this._lastReady}checkReadyPostUpdate(e){this._lastReady=this._isReady(),this._lastReady&&!this._ready&&e.afterRenderFns.push((function(){}))}createTile(e){return new r.Layer.GlobeTile(this,e)}loadTileset(e,t,i){this.root=this.createTile({x:0,y:0,level:0})}updateFrameState(e){e.transformMatrixUpdated=!1,void 0!==e.transformMatrix&&e.transformMatrix.equals(this._transformMatrix)||(e.transformMatrixUpdated=!0,void 0===e.transformMatrix?e.transformMatrix=this._transformMatrix.clone():e.transformMatrix.copy(this._transformMatrix)),e.maximumScreenSpaceError=this.maximumScreenSpaceError,e.geoErrScaleFactor=1*r.Tile.TileMath.unitScale,e.oldUseTerrain!=this.tileProvider.terrainProvider.useTerrain&&(e.transformMatrixUpdated=!0,e.useTerrain=this.tileProvider.terrainProvider.useTerrain,e.oldUseTerrain=e.useTerrain)}_fetchChildrenOfTile(e,t){this.needLoadChildrenOfTile(e)&&(e._childrenState=r.TileContentState.READY,this.loadChildrenOfTile(e))}needLoadChildrenOfTile(e){return e.childrenUnload&&e.level<this.tileProvider.getMaxLimitedLevel()}_isAvailableLevel(e){return e.level<this.tileProvider.getMaxLimitedLevel()}loadChildrenOfTile(e,t,i){e.isDestroyed()||(this.createTile({x:2*e.x,y:2*e.y,level:e.level+1,parent:e}),this.createTile({x:2*e.x+1,y:2*e.y,level:e.level+1,parent:e}),this.createTile({x:2*e.x,y:2*e.y+1,level:e.level+1,parent:e}),this.createTile({x:2*e.x+1,y:2*e.y+1,level:e.level+1,parent:e}),i&&i())}_canBeTraverse(e,t){return 0!==e.childrenTree.length&&e.sse>t.maximumScreenSpaceError}_addTileToRequestedQueue(e,t){e._requestedFrame!==t.frameNumber&&(e._requestedFrame=t.frameNumber,this._requestedTiles.push(e))}requestTiles(t){let i=!1,r=this._requestedTiles;r.sort(e);for(let e=0,t=r.length;e<t;++e)i=this.requestContent(r[e])||i;i&&t.afterRenderFns.push((function(){}))}updateTiles(e){const t=this.statistics,i=this._selectedTiles;this._clearHeightRange();for(let r=0,a=i.length;r<a;++r){let a=i[r];a.update(e),this._updateHeightRange(a),t.incrementSelectionCount(a.content),++t.selected}this.debugShowStatistics(e)}_clearHeightRange(){this._heightRangeOfVisibleTiles.max=-1/0,this._heightRangeOfVisibleTiles.min=1/0}_updateHeightRange(e){if(!this.tileProvider.isUseTerrain())return;const t=this._heightRangeOfVisibleTiles,i=e.getTerrainHeightRange();i.max>t.max&&(t.max=i.max),i.min<t.min&&(t.min=i.min)}requestContent(e){if(e.contentTypeEmpty)return!1;const t=this.statistics;return e.requestContent()?(++t.numberOfPendingRequests,this._requestedTilesInFlight.push(e),e.contentProcessPromise.then(this._addTileToProcessingQueue(this,e)).catch((function(e){})),e.contentReadyPromise.then(this._handleTileContentSuccess(this,e)).catch(this._handleTileContentFailure(this,e)),!1):(++t.numberOfAttemptedRequests,e.needsLoading)}clearLoadedTilesCache(){}invalidateImageryOfAllTiles(){this.clearLoadedTilesCache(),this._traverseAllTiles((e=>{e.resetImageryContent()}))}invalidateTerrainOfAllTiles(){this.clearLoadedTilesCache(),this._traverseAllTiles((e=>{e.resetTerrainContent()}))}resetAllTiles(){this.clearLoadedTilesCache(),this._traverseAllTiles((e=>{e.resetBoundingBox(),e.resetTerrainContent()}))}updateTileMeshForFlatten(){const e=this.tileProvider;this._traverseAllTiles((t=>{e.updateTileMeshForFlatten(t)}))}getTileMesh(){const e=[];return this._traverseAllTiles((t=>{e.push(t)})),e}_traverseAllTiles(e){if(!this._root)return;const t=[];for(t.push(this._root);t.length>0;){const i=t.pop(),r=i.childrenTree;for(let e=0,i=r.length;e<i;++e)t.push(r[e]);e(i)}}_createTraversalController(){this._traversalController=new r.GlobeTilesetTraversal}}r.Layer.GlobeTileset=t}(),function(){class e extends r.BaseModel{constructor(e,t){super(t.manager,t),this.viewer=e,this.isDemLayer=!0,this.objectGroupName=r.GlobalData.TilePlaneGroupName,this.objectGroup=this._createObjectGroup(),this.objectGroup.transformMatrix=this.transformMatrix,this.objectGroup.altitudeOffset=this.basePointAltitude;const i=Object.assign({},t,{id:this.id,type:r.RequestType.IMAGERY,objectGroup:this.objectGroup,transformMatrix:this.transformMatrix,debugShowBoundingBox:e._options.debugShowBoundingBox,terrainOperationManager:e.terrainOperationManager,tilesCacheScheduler:this.manager.tilesCacheScheduler,skipLodEnabled:t.loadConfig?t.loadConfig.skipLodEnabled:void 0,globeLayer:this});this._tileset=new r.Layer.GlobeTileset(i),this.tileManager=new r.Layer.GlobeTileManager(this),this.viewer.basePointPositionOnLonLat=this.basePointPositionOnLonLat,this.viewer._globeTileManager=this.tileManager}destroy(){this.manager.removeModel(this.id,!1),this.tileManager.destroy(),this.tileManager=void 0,this._tileset.destroy(),this._tileset=null,this._removeObjectGroup(),this.objectGroup=null,this.viewer=null,this.manager.setDemLoadedState(!1),super.destroy()}setValues(e){this._setupParameters(e),super.setValues(e)}_setupParameters(e){e.modelId=r.Utils.defaultValue(e.modelId,r.ObjectGroupType.TILEGROUP);const t=e.loadConfig;e.priority=r.Utils.defaultValue(t.priority,0),this.unitScale=r.Tile.TileMath.unitScale,t.unitScale=this.unitScale;const i=r.Utils.defaultValue(t.modelPosition,[0,0]);this.semiMercatorPerimeter=r.Tile.TileMath.getMercatorPerimeterByLat(i[1]),t.mercatorPerimeter=2*this.semiMercatorPerimeter,this.basePointPositionOnLonLat=i,this.basePointAltitude=r.Utils.defaultValue(t.modelAltitude,0),this.basePointRotationZ=r.Utils.defaultValue(t.modelRotationZ,0),this.basePoint=r.Utils.defaultValue(t.basePoint,{x:0,y:0})}setupTransformMatrix(){const e=this.basePointPositionOnLonLat,t=this.basePointAltitude,i=this.basePointRotationZ,a=this.basePoint,n=this.unitScale,s=this.semiMercatorPerimeter,o=r.Tile.TileMath.lonLat2Mercator(e[0],e[1],s,n),l=(new THREE.Matrix4).makeTranslation(-o.x,-o.y,-t*n),d=new THREE.Matrix4;i&&d.makeRotationFromEuler((new THREE.Euler).fromArray([0,0,-i]));const h=(new THREE.Matrix4).makeTranslation(a.x,a.y,0),c=(new THREE.Matrix4).premultiply(l).premultiply(d).premultiply(h);this.setTransformMatrix(c)}transformLayer(){const e=this.basePointPositionOnLonLat;this.semiMercatorPerimeter=r.Tile.TileMath.mercatorPerimeter*Math.cos(e[1]*Math.PI/180),this._tileset.tileProvider.terrainProvider.setMercatorPerimeter(2*this.semiMercatorPerimeter),this._tileset.resetAllTiles(),this.setupTransformMatrix(),this._updateObjectGroup(),this.manager.setRenderStateChanged(!0)}_createObjectGroup(){return this.viewer.getScene().getOrCreateObjectGroup(this.objectGroupName,{pickableType:r.PICKABLETYPE.Map,globalSpace:!0})}_removeObjectGroup(){this.viewer.getScene().removeObjectGroupByName(this.objectGroupName)}_updateObjectGroup(){const e=this.viewer.getScene().getRawMatrixGlobal(),t=this.objectGroup;t.matrix.multiplyMatrices(e,t.transformMatrix),t.matrixAutoUpdate=!1,t.updateMatrixWorld(!0)}load(e){const t=this.viewer,i=this.manager,a=!t.getScene().hasBoundingBox();if(a){i.dispatchEvent({type:r.EVENTS.ON_LOAD_START}),i.setDrawableModel(!0),i.chooseRendering(this.statistics.memoeryInfo,!0),t.rendererManager.setupRenderer(t.renderSettings);const e=.5*r.GlobalData.SceneSize;this.getTransforms().boundingBox=(new THREE.Box3).setFromArray([-e,-e,-e,e,e,e]),i.updateScene(this)}i.setDemLoadedState(!0);let n=t.getScene().getRawMatrixGlobal();this.updateMatrixOfObjectGroup(n),r.GlobalData.EnableGisMap=!0,this._tileset.loadTileset(),this.loaded=!0,a&&i.dispatchEvent({type:r.EVENTS.ON_LOAD_COMPLETE,modelId:this.id}),Promise.resolve().then((()=>{i.setRenderStateChanged(!0),i.dispatchEvent({type:r.EVENTS.ON_MAP_LOAD_ALL})}))}updateMatrixOfObjectGroup(e){const t=this.objectGroup;t.matrix.copy(t.transformMatrix),t.matrix.multiplyMatrices(e,t.matrix),t.matrixAutoUpdate=!1,t.updateMatrixWorld(!0)}preUpdate(e){this._tileset.checkReadyPreUpdate(e),this._tileset.preUpdate(e)}update(e){this._tileset.update(e)}postUpdate(e){this._tileset.postUpdate(e),this._tileset.checkReadyPostUpdate(e)}addImageryLayer(e){return this._tileset.addImageryLayer(e)}traverseMeshByLayerId(e,t){this.objectGroup.traverse((i=>{"MeshEx"===i.type&&i.layerId===e&&t&&t(i)}))}setImageryLayerVisible(e,t){this.traverseMeshByLayerId(e,(e=>{e.visible=t}))}setAllLayerVisible(e){this.visible=e,this.objectGroup.visible!==e&&(this.objectGroup.visible=e,this.manager.setRenderStateChanged(!0))}setRenderStateChanged(e){this.manager.setRenderStateChanged(e)}getRawTransformMatrix(){return this.transformMatrix}getTransformMatrixInverse(){return this.transformMatrixInverse}updateMaterialsValue(e,t,i){this.tileManager&&this.tileManager.tileProvider&&this.tileManager.tileProvider.updateMaterialsValue(this,e,t,i)}setCastShadow(e){super.setCastShadow(e),this.viewer.traverseGroupEnableShadow(this.objectGroup,this.castShadow,this.receiveShadow),this.viewer.updateShadowMap()}setReceiveShadow(e){super.setReceiveShadow(e),this.viewer.traverseGroupEnableShadow(this.objectGroup,this.castShadow,this.receiveShadow),this.viewer.updateShadowMap()}rayCastVertical(e){const t=this.objectGroup,i=this.viewer.getScene().getInverseMatrixGlobal(),a=(new THREE.Box3).setFromObject(t);a.applyMatrix4(i);const n=this.viewer.getScene().getRawMatrixGlobal(),s=new THREE.Vector3(e.x,e.y,a.max.z+10);s.applyMatrix4(n);const o=new r.Raycaster(s,new THREE.Vector3(0,-1,0)),l=[];if(this._tileset._traverseAllTiles((e=>{if(!e||!e._content||!e._content._meshes||!1===e._content._meshes.visible)return;e._content._meshes.traverse((e=>{if("MeshEx"!==e.type||e.name.indexOf("Skirt")>-1)return;const t=[];e.raycast(o,t),t.length>0&&l.push(t[0])}))})),0===l.length)return;const d=l[0].point;return d.applyMatrix4(i),d}}r.Layer.GlobeLayer=e}(),r.Layer.GlobeTileManager=class{constructor(e){this.globeLayer=e,this.tileProvider=e._tileset.tileProvider,this.layerList=[]}destroy(){this.layerList=void 0,this.tileProvider=void 0,this.globeLayer=void 0}getLayer(){return this.globeLayer}lonLat2Mercator(e,t){const i=.5*this.tileProvider.terrainProvider.mercatorPerimeter,a=r.Tile.TileMath.lonLat2Mercator(e,t,i,1),n=this.globeLayer.getRawTransformMatrix();return new THREE.Vector3(a.x,a.y,0).applyMatrix4(n)}mercator2lonLat(e){const t=.5*this.tileProvider.terrainProvider.mercatorPerimeter,i=this.globeLayer.getTransformMatrixInverse(),a=new THREE.Vector3(e.x,e.y,0).applyMatrix4(i);return r.Tile.TileMath.mercator2lonLat(a,t,1)}worldPositionToLngLat(e){return this.mercator2lonLat(e)}lngLatToWorldPositionWithoutOpenTerrain(e,t){const i=e[0],a=e[1];function n(e,t,i){const r=e.lonLat2Mercator(t,i);return r.z=0,r}let s=n(this,i,a);if(!t){const e=this.globeLayer.rayCastVertical(s);return void 0===e?(delete s.z,s):e}const o=this.tileProvider.terrainProvider,l=o.getMaxMinTerrainLevel().maxLevel,d=r.Tile.TileMath.long2tile(i,l),h=r.Tile.TileMath.lat2tile(a,l),c=o.getTerrainUrlWithoutOpenTerrain(d,h,l);if(null==c||null==c)return s;const u=.5*o.mercatorPerimeter,p=r.Tile.TileMath.lonLat2Mercator(i,a,u,1),m=new THREE.Vector3(p.x,p.y,r.Tile.TileMath.earthHighestAltitude),f=new r.Raycaster(m,new THREE.Vector3(0,0,-1)),g=this.globeLayer.getRawTransformMatrix();o.loadArrayBufferImmediately(c,(e=>{const c=o.getTerrainDataArray(e);let u=l,p=c,m=d,v=h;for(let e=0;e<o.maxLimitedLevel-l;e++){let e=u+1,t=u;m=r.Tile.TileMath.long2tile(i,e),v=r.Tile.TileMath.lat2tile(a,e),p=o.getTerrainDataArrayWithTerrainLevel(m,v,e,t,p),u+=1}const y=o.getTileGeometryByData(p,m,v,u,!0),M=new r.MeshEx(y.geometry);M.name=`${d}-${h}-${u}`,y.matrix&&M.matrix.copy(y.matrix),M.updateMatrixWorld(!0);const E=[];M.raycast(f,E),s=E.length>0?E[0].point.applyMatrix4(g):n(this,i,a),t(s)}),(()=>{s=n(this,i,a),t(s)}))}lngLatToWorldPositionWithObj(e,t){const i=e.lon,a=e.lat,n=e.id,s=e.order;function o(e,t,i){const r=e.lonLat2Mercator(t,i);return r.z=0,r}let l=o(this,i,a);const d=this.tileProvider.terrainProvider,h=d.getMaxMinTerrainLevel().maxLevel,c=r.Tile.TileMath.long2tile(i,h),u=r.Tile.TileMath.lat2tile(a,h),p=d.getTerrainUrlWithoutOpenTerrain(c,u,h);if(null==p||null==p)return l;const m=.5*d.mercatorPerimeter,f=r.Tile.TileMath.lonLat2Mercator(i,a,m,1),g=new THREE.Vector3(f.x,f.y,r.Tile.TileMath.earthHighestAltitude),v=new r.Raycaster(g,new THREE.Vector3(0,0,-1)),y=this.globeLayer.getRawTransformMatrix();d.loadArrayBufferImmediately(p,(e=>{const p=d.getTerrainDataArray(e),m=d.getTileGeometryByData(p,c,u,h,!0),f=new r.MeshEx(m.geometry);f.name=`${c}-${u}-${h}`,m.matrix&&f.matrix.copy(m.matrix),f.updateMatrixWorld(!0);const g=[];f.raycast(v,g),l=g.length>0?g[0].point.applyMatrix4(y):o(this,i,a),t(l,n,s)}),(()=>{l=o(this,i,a),t(l,n,s)}))}lngLatToWorldPosition(e,t){const i=e[0],a=e[1];function n(e,t,i){const r=e.lonLat2Mercator(t,i);return r.z=0,r}let s=n(this,i,a);if(!this.isUseTerrain())return s;if(!t){const e=this.globeLayer.rayCastVertical(s);return void 0===e?(delete s.z,s):e}const o=this.tileProvider.terrainProvider,l=o.getMaxMinTerrainLevel().maxLevel,d=r.Tile.TileMath.long2tile(i,l),h=r.Tile.TileMath.lat2tile(a,l),c=o.getTerrainUrl(d,h,l),u=.5*o.mercatorPerimeter,p=r.Tile.TileMath.lonLat2Mercator(i,a,u,1),m=new THREE.Vector3(p.x,p.y,r.Tile.TileMath.earthHighestAltitude),f=new r.Raycaster(m,new THREE.Vector3(0,0,-1)),g=this.globeLayer.getRawTransformMatrix();o.loadArrayBufferImmediately(c,(e=>{const c=o.getTerrainDataArray(e),u=o.getTileGeometryByData(c,d,h,l,!0),p=new r.MeshEx(u.geometry);p.name=`${d}-${h}-${l}`,u.matrix&&p.matrix.copy(u.matrix),p.updateMatrixWorld(!0);const m=[];p.raycast(f,m),s=m.length>0?m[0].point.applyMatrix4(g):n(this,i,a),t(s)}),(()=>{s=n(this,i,a),t(s)}))}get modelRotationZ(){return this.globeLayer.basePointRotationZ}set modelRotationZ(e){this.globeLayer.basePointRotationZ=e,this.globeLayer.transformLayer()}getModelRotationZ(){return this.modelRotationZ}setModelRotationZ(e){this.modelRotationZ=e}get modelPosition(){return this.globeLayer.basePointPositionOnLonLat}set modelPosition(e){this.globeLayer.basePointPositionOnLonLat=e,this.globeLayer.transformLayer()}setModelPosition(e){this.modelPosition=e}getModelPosition(){return this.modelPosition}get modelAltitude(){return this.globeLayer.basePointAltitude}set modelAltitude(e){this.globeLayer.basePointAltitude=e,this.globeLayer.objectGroup.altitudeOffset=e,this.globeLayer.transformLayer()}setModelAltitude(e){this.modelAltitude=e}getModelAltitude(){return this.modelAltitude}get basePoint(){return this.globeLayer.basePoint}getBasePoint(){return this.globeLayer.basePoint}clearTiles(){}addRenderCallback(){}setOpacity(e,t){if(void 0!==t)return void this.tileProvider.setOpacity(e,t);const i=this.getAllLayerIds();0!==i.length?i.map((t=>{this.tileProvider.setOpacity(e,t)})):this.tileProvider.setPresetOpacity(e)}getOpacity(e){return this.tileProvider.getOpacity(e)}setMapLayer(e){let t;const i=this.tileProvider.getImageryLayerByMapLayer(e);if(i)t=i.imageryProvider.id,this.tileProvider.adjustImageryLayer(t,0);else{let i={};const r=this.tileProvider.getBaseImageryLayer();r&&(i=r.imageryProvider.cloneParameters(),this.globeLayer._tileset.invalidateImageryOfAllTiles(),this.tileProvider.removeImageryLayer(r)),i.mapLayer=e,t=this.tileProvider.addImageryLayer(i,0)}return this.tileProvider.setBaseLayerId(t),t}getBaseLayerId(){return this.tileProvider.getBaseLayerId()}getAllLayerIds(){return this.tileProvider.getAllLayerIds()}getMapUrl(e){const t=this.tileProvider.getImageryLayerById(e);if(t)return t.imageryProvider.mapUrl}setMapUrl(e,t){return this.setImageryLayer({mapUrl:e,imageryProviderType:t})}setImageryLayer(e){if(void 0===e.mapUrl)return void console.log("options.mapUrl is required.");let t;const i=this.tileProvider.getImageryLayerByMapUrl(e.mapUrl),r=this.tileProvider.getBaseImageryLayer();return i?(r&&r!==i&&(this.globeLayer._tileset.invalidateImageryOfAllTiles(),this.tileProvider.removeImageryLayer(r.imageryProvider.id)),t=i.imageryProvider.id,this.tileProvider.adjustImageryLayer(t,0)):(r&&(this.globeLayer._tileset.invalidateImageryOfAllTiles(),this.tileProvider.removeImageryLayer(r.imageryProvider.id)),t=this.tileProvider.addImageryLayer(e,0)),this.tileProvider.setBaseLayerId(t),t}addImageryLayer(e,t){if(void 0===e.mapUrl)return void console.log("options.mapUrl is required.");let i;const r=this.tileProvider.getImageryLayerByMapUrl(e.mapUrl);return r?(i=r.imageryProvider.id,this.tileProvider.adjustImageryLayer(i,t)):(this.globeLayer._tileset.invalidateImageryOfAllTiles(),i=this.tileProvider.addImageryLayer(e,t)),0===t&&this.tileProvider.setBaseLayerId(i),i}removeImageryLayer(e){this.tileProvider.removeImageryLayer(e),this.globeLayer._tileset.invalidateImageryOfAllTiles()}adjustImageryLayer(e,t){this.tileProvider.adjustImageryLayer(e,t)}updateImageryLayer(e,t){if(void 0===t.mapUrl)return void console.log("options.mapUrl is required.");const i=this.tileProvider.getImageryLayerIndex(e);if(-1===i)return;let r;this.removeImageryLayer(e);const a=this.tileProvider.getImageryLayerByMapUrl(t.mapUrl);return a?(r=a.imageryProvider.id,this.tileProvider.adjustImageryLayer(r,i)):r=this.tileProvider.addImageryLayer(t,i),0===i&&this.tileProvider.setBaseLayerId(r),r}getImageryLayerIndex(e){return this.tileProvider.getImageryLayerIndex(e)}setTerrain(e,t){return this.tileProvider.setTerrainProvider(e,(()=>{this.tileProvider.clearMaterialAndSkirtCache(),this.globeLayer._tileset.invalidateTerrainOfAllTiles(),t&&t()}))}getTerrain(){return this.tileProvider.getTerrainUrl()}applyTerrain(e){this.tileProvider.setTerrainEnabled(e)&&(this.tileProvider.clearMaterialAndSkirtCache(),this.globeLayer._tileset.invalidateTerrainOfAllTiles())}isUseTerrain(){return this.tileProvider.terrainProvider.useTerrain}setStyle(e,t){e&&this.tileProvider.setStyle(e,t)}setExcavation(e){e&&this.tileProvider.setExcavation(e)}updateMaterialsSide(){this.tileProvider.updateMaterialsSide()}updateTileMeshForFlatten(){this.globeLayer._tileset.updateTileMeshForFlatten()}show(e){this.tileProvider.setImageryLayerVisible(e,!0),this.tileProvider.hasImageryLayerVisible()&&this.globeLayer.setVisible(!0),this.globeLayer.setRenderStateChanged(!0)}hide(e){this.tileProvider.setImageryLayerVisible(e,!1),this.tileProvider.hasImageryLayerVisible()||this.globeLayer.setVisible(!1),this.globeLayer.setRenderStateChanged(!0)}hideAllLayers(){this.globeLayer.setAllLayerVisible(!1)}showAllLayers(){this.globeLayer.setAllLayerVisible(!0)}getMaxLevel(e){this.getMaxTerrainLevel(maxLevel)}setMaxLevel(e,t){this.setMaxTerrainLevel(e)}getMaxTerrainLevel(){return this.tileProvider.getMaxLimitedLevel()}setMaxTerrainLevel(e){this.tileProvider.setMaxLimitedLevel(e)}getMaxImageryLevel(e){return this.tileProvider.getMaxImageryLevel(e)}setMaxImageryLevel(e,t){this.tileProvider.setMaxImageryLevel(e,t),this.globeLayer._tileset.invalidateImageryOfAllTiles()}},function(){function e(e,t){return t._distance-e._distance}class t extends r.TilesetTraversal{constructor(){super()}traverseTiles(e,t,i){const r=this.traversalStack;for(r.push(t);r.length>0;){const t=r.pop(),a=t.refineReplace,n=!t.parent||t.parent._refines;let s=!1;if(e._isAvailableLevel(t)&&(e._fetchChildrenOfTile(t,i),e._canBeTraverse(t,i)&&(s=this.subdivideTile(e,t,i),s=s&&n)),a){const r=!s&&n;this._selectRefiningTile(e,t,i,r)}else e._addTileToRequestedQueue(t,i),e._addTileToSelectedQueue(t,i);e.visitTile(t,i),e.touchTile(t,i),t._refines=s}}subdivideTile(e,t,i){return e._skipLodEnabled?this._subdivideTileBySkippingLod(e,t,i):super.subdivideTile(e,t,i)}_selectRefiningTile(e,t,i,r){e._skipLodEnabled?r&&(e._addTileToRequestedQueue(t,i),e._addTileToSelectedQueue(t,i)):(e._addTileToRequestedQueue(t,i),r&&e._addTileToSelectedQueue(t,i))}_subdivideTileBySkippingLod(t,i,r){const a=this.traversalStack,n=i.childrenTree;let s=!1;if(n.forEach((e=>{t.updateTile(e,r),s=s||e.passSSE(r)})),n.sort(e),!s)return!1;const o=i.refineReplace&&!i.contentTypeEmpty;let l=!0,d=!1;return n.forEach((e=>{e.visible?(a.push(e),d=!0):o&&(t.visitTile(e,r),t.touchTile(e,r))})),d||(l=!1),l}}r.GlobeTilesetTraversal=t}(),r.BimtileDescriptor=class{constructor(){this.mapNodeInfoByBatched=new Map,this.mapNodeInfoByInstance=new Map}destroy(){this.mapNodeInfoByBatched.clear(),this.mapNodeInfoByInstance.clear(),this.mapNodeInfoByBatched=null,this.mapNodeInfoByInstance=null}_classifyNodeInfo(e){const t=e.userId,i=e.nodeId;if(!1===e.instanceOrNot)return!1===this.mapNodeInfoByBatched.has(t)&&this.mapNodeInfoByBatched.set(t,new Map),void this.mapNodeInfoByBatched.get(t).set(i,e);!1===this.mapNodeInfoByInstance.has(t)&&this.mapNodeInfoByInstance.set(t,new Map),!1===this.mapNodeInfoByInstance.get(t).has(i)&&this.mapNodeInfoByInstance.get(t).set(i,new Map),this.mapNodeInfoByInstance.get(t).get(i).set(e.index,e)}getAllNodeInfos(){return[this.mapNodeInfoByBatched,this.mapNodeInfoByInstance]}getAllNodeInfosCallback(e){for(const t of this.mapNodeInfoByBatched.values())for(const i of t.values())e&&e(i);for(const t of this.mapNodeInfoByInstance.values())for(const i of t.values())for(const t of i.values())e&&e(t)}getAllUserIds(){let e=new Map([...this.mapNodeInfoByBatched,...this.mapNodeInfoByInstance]);const t=[...e.keys()];return e=null,t}hasNodeInfo(){return this.mapNodeInfoByBatched.size>0||this.mapNodeInfoByInstance.size>0}getBatchedNodeInfos(){return this.mapNodeInfoByBatched}getInstanceNodeInfos(){return this.mapNodeInfoByInstance}patchBatchedMeshNodeInfo(e,t,i){const r=parseInt(e),a=this.mapNodeInfoByBatched.get(r);if(!a)return;const n=a.get(t);n&&(n.parent=i.parent,n.materialId=i.materialId,n.matrix=i.matrix,n.explodeMatrix&&(n.matrix=i.matrix.clone(),n.matrix.multiplyMatrices(n.explodeMatrix,n.matrix)),n.type=i.type,n.cellId=null)}patchInstanceNodeInfo(e,t,i){const r=parseInt(e),a=this.mapNodeInfoByInstance.get(r);if(!a)return;const n=a.get(i.bufferId);if(!n)return;const s=n.get(i.instanceIndex);s.geometryId=t,s.parent=t,s.matrix=i.entityMatrix.clone(),s.explodeMatrix&&(s.matrix=i.entityMatrix.clone(),s.matrix.multiplyMatrices(s.explodeMatrix,s.matrix)),s.type=i.type,s.cellId=null}getInstanceMatrixListByUserIdAndMeshId(e,t){let i=[];const r=this.mapNodeInfoByInstance.get(e);if(!r)return i;const a=r.get(t);if(!a)return i;for(const e of a.values())e.matrix&&i.push(e.matrix);return i}getNodeInfosByUserId(e){let t=[];return this.getNodeInfoByUserIdCallback(e,(e=>{t.push(e.nodeInfo)})),t}isUserIdExist(e){const t=parseInt(e);return this.mapNodeInfoByBatched.has(t)||this.mapNodeInfoByInstance.has(t)}getUserTileIdMap(e,t){const i=this.mapNodeInfoByBatched.get(e);if(i)for(const e of i.values())t[e.tileId]=null;const r=this.mapNodeInfoByInstance.get(e);if(r)for(const e of r.values())for(const i of e.values())t[i.tileId]=null}getBatchedNodeInfoByUserIdCallback(e,t){const i=parseInt(e),r=this.mapNodeInfoByBatched.get(i);if(r)for(const[e,i]of r){const r={instanceOrNot:!1,meshId:e,parent:i.parent,nodeInfo:i};t&&t(r)}}getInstanceNodeInfoByUserIdCallback(e,t){const i=parseInt(e),r=this.mapNodeInfoByInstance.get(i);if(r){const e={instanceOrNot:!0};for(const[i,a]of r){e.meshId=i;for(const[i,r]of a)e.parent=r.parent,e.index=i,e.nodeInfo=r,t&&t(e)}}}getNodeInfoByUserIdCallback(e,t){this.getBatchedNodeInfoByUserIdCallback(e,t),this.getInstanceNodeInfoByUserIdCallback(e,t)}getAnyUserData(){for(const e of this.mapNodeInfoByBatched.values())for(const t of e.values())return t.userData}getUserDataByUserId(e){const t=parseInt(e),i=this.mapNodeInfoByBatched.get(t);if(i)for(const[e,t]of i)return t.userData;const r=this.mapNodeInfoByInstance.get(t);if(r)for(const[e,t]of r)for(const[e,i]of t)return i.userData}verifyNodeInfos(){for(const e of this.mapNodeInfoByBatched.values())for(const t of e.values())void 0===t.parent&&console.log(t);for(const e of this.mapNodeInfoByInstance.values())for(const t of e.values())for(const e of t.values())void 0===e.parent&&console.log(e)}},function(){r.BimtilesObjectInfoDict=class{constructor(){this.nodeInfos=null}init(e){this.nodeInfos||(this.nodeInfos=e)}reInit(e){this.nodeInfos=e}getNodeInfoCallback(e){for(const t of this.nodeInfos[0].values())for(const i of t.values())e&&e(i.userId,i);for(const t of this.nodeInfos[1].values())for(const i of t.values())for(const t of i.values())e&&e(t.userId,t)}getUserDataCallback(e){let t=!0;for(const i of this.nodeInfos[0].values()){t=!0;for(const r of i.values())!0===t&&e&&e(r.userId,r),t=!1}for(const i of this.nodeInfos[1].values()){t=!0;for(const r of i.values())for(const i of r.values())!0===t&&e&&e(i.userId,i),t=!1}}setIdsState2(e,t,i,r){if(!0!==i&&void 0!==i){for(const t of this.nodeInfos[0].values()){const i=t.userId;e.has(i)||r&&r(t)}for(const t of this.nodeInfos[1].values()){const i=t.userId;e.has(i)||r&&r(t)}}else{let i=0;for(const a of e.keys()){let e=this.nodeInfos[0].get(a),n=t[i];if(e&&e instanceof Map){for(const[t,i]of e)r&&r(i,n);if(e=this.nodeInfos[1].get(a),e)for(const[t,i]of e)r&&r(i,n)}else e&&r&&r(e,n),e=this.nodeInfos[1].get(a),e&&r&&r(e,n);i++}}}setIdsState(e,t,i){if(!0!==t&&void 0!==t){for(const t of this.nodeInfos[0].values())for(const r of t.values()){const t=r.userId;e.has(t)||i&&i(r)}for(const t of this.nodeInfos[1].values())for(const r of t.values())for(const t of r.values()){const r=t.userId;e.has(r)||i&&i(t)}}else for(const t of e.keys()){let e=this.nodeInfos[0].get(t);if(e)for(const t of e.values())i&&i(t);if(e=this.nodeInfos[1].get(t),e)for(const t of e.values())for(const e of t.values())i&&i(e)}}getNodeInfoById(e){const t=parseInt(e);if(this.nodeInfos[0].has(t)){const e=this.nodeInfos[0].get(t);for(const t of e.values())return t}if(this.nodeInfos[1].has(t)){const e=this.nodeInfos[1].get(t);for(const t of e.values())for(const e of t.values())return e}}clear(){this.nodeInfos=null}getNodeInfos(){return this.nodeInfos}};r.BimtileObjectInfoManager=class{constructor(){this.objectInfoDict=new r.BimtilesObjectInfoDict,this.hasMaterial=!1,this.hasWireFrameMaterial=!1,this.isHasObjectHidden=!1,this.hasObjectHiddenByIsolate=!1,this.hasTransparent=!1,this.hasTransparentByIsolate=!1,this._boundingBox=new THREE.Box3,this.explodeBoxNeedUpdate=!1,this.inactivatedIdMap={},this.inactivatedIds=[],this.bIsInactivateAll=!1,this.localClippingList={},this.hasLocalClipping=!1,this.modifyOpacityList={},this.hasModifyOpacityList=!1}setOpacity(e,t,i){let r=this.arrayToMap(e);this.objectInfoDict.setIdsState2(r,t,true,((e,t)=>{this.isActive(e.userId)&&(e.material=t,this.hasMaterial=!0)})),r=null}setTileReader(e){this.tileReader=e}init(e){this.objectInfoDict.init(e)}reinit(e){this.objectInfoDict.reInit(e)}clearData(){this.objectInfoDict.clear()}getNodeInfos(){return this.objectInfoDict.getNodeInfos()}calculateVisibleComponentsBbox(){this._boundingBox.makeEmpty();this.objectInfoDict.getNodeInfoCallback(((e,t)=>{if(this.isHidden(e))return;const i=t.boundingBox;i&&!i.isEmpty()?(this._boundingBox.expandByPoint(i.min),this._boundingBox.expandByPoint(i.max)):console.warn("Object has no this._boundingBox, id is "+e)})),this.explodeBoxNeedUpdate=!1}getVisibleComponentsBbox(){return(this.explodeBoxNeedUpdate||this._boundingBox.isEmpty())&&this.calculateVisibleComponentsBbox(),this._boundingBox.clone()}needUpdateBoxAfterExplode(){this.explodeBoxNeedUpdate=!0}arrayToMap(e){let t=new Map;for(let i=0;i<e.length;i++){const r=e[i];t.set(r,r)}return t}isMatchConditions(e,t){let i=!0;for(let r=0,a=t.length;r<a;r++){const a=t[r];for(const t in a){if(!(a[t]instanceof Array)&&e[t]!=a[t]){i=!1;break}if(a[t]instanceof Array&&-1==a[t].indexOf(e[t])){i=!1;break}}if(1==i)break;r<t.length-1&&(i=!0)}return i}matchConditions(e,t,i,r){let a=[],n=[];this.objectInfoDict.getUserDataCallback(((t,i)=>{const r=i.userData,s=this.tileReader.getUserDataByIndex(r)||{};s.elementId=i.userId;this.isMatchConditions(s,e)?a.push(t):n.push(t)})),i&&r?(t&&t(i,r,a,!0),t&&t(i,r,n,!1)):(t&&t(a,!0),t&&t(n,!1))}getMatchIds(e){let t=[];return this.objectInfoDict.getUserDataCallback(((i,r)=>{const a=r.userData,n=this.tileReader.getUserDataByIndex(a)||{};n.elementId=r.userId;this.isMatchConditions(n,e)&&t.push(i)})),t}setVisible(e,t,i){let a=this.arrayToMap(e);this.objectInfoDict.setIdsState(a,i,(e=>{t?e.state=e.state|r.EnumObjectState.Visible:(this.isHasObjectHidden=!0,e.state=e.state&~r.EnumObjectState.Visible)}))}isVisible(e){return this.objectInfoDict.getNodeInfoById(e).state&r.EnumObjectState.Visible>0}clearVisible(){this.isHasObjectHidden=!1,this.setVisible([],!0,!1)}hideAll(){this.isHasObjectHidden=!0,this.setVisible([],!1,!1)}setTransparent(e,t,i){let a=this.arrayToMap(e);this.objectInfoDict.setIdsState(a,i,(e=>{this.isActive(e.userId)&&(t?(e.state=e.state|r.EnumObjectState.Transparent,this.hasMaterial=!0,this.hasTransparent=!0):e.state=e.state&~r.EnumObjectState.Transparent)})),a=null}isTransparent(e){const t=this.objectInfoDict.getNodeInfoById(e);let i=(t.state&r.EnumObjectState.Transparent)>0;return i=i||(t.state&r.EnumObjectState.TransparentByIsolate)>0,i}clearTransparent(){this.hasTransparent=!1,this.setTransparent([],!1,!1)}setMaterial(e,t,i){let r=this.arrayToMap(e);this.objectInfoDict.setIdsState(r,i,(e=>{this.isActive(e.userId)&&(e.material=t,this.hasMaterial=!0)})),r=null}getMaterial(e){let t=this.objectInfoDict.nodeInfos[0].get(e);if(t&&t instanceof Map){for(const[e,i]of t)if(i)return i.material;if(t=this.objectInfoDict.nodeInfos[1].get(e),t&&t&&t instanceof Map)for(const[e,i]of t)return i.material;return null}return t?t.material:(t=this.objectInfoDict.nodeInfos[1].get(e),t?t.material:null)}clearMaterial(){this.setMaterial([],null,!1)}setWireFrameMaterial(e,t,i){let r=this.arrayToMap(e);this.objectInfoDict.setIdsState(r,i,(e=>{e.wireFrameMaterial=t,this.hasWireFrameMaterial=!0})),r=null}getWireFrameMaterial(e){return this.objectInfoDict.getNodeInfoById(e).wireFrameMaterial}clearWireFrameMaterial(){this.setWireFrameMaterial([],null,!1)}setIsolateHide(e,t,i){let a=this.arrayToMap(e);this.objectInfoDict.setIdsState(a,i,(e=>{t?(this.hasObjectHiddenByIsolate=!0,e.state=e.state|r.EnumObjectState.HideByIsolate):e.state=e.state&~r.EnumObjectState.HideByIsolate})),a=null}isIsolateHide(e){return(this.objectInfoDict.getNodeInfoById(e).state&r.EnumObjectState.HideByIsolate)>0}setIsolateTransparent(e,t,i){let a=this.arrayToMap(e);this.objectInfoDict.setIdsState(a,i,(e=>{this.isActive(e.userId)&&(t?(e.state=e.state|r.EnumObjectState.TransparentByIsolate,this.hasMaterial=!0,this.hasTransparentByIsolate=!0):e.state=e.state&~r.EnumObjectState.TransparentByIsolate)})),a=null}isIsolateTransparent(e){return(this.objectInfoDict.getNodeInfoById(e).state&r.EnumObjectState.TransparentByIsolate)>0}clearIsolateHide(){this.setIsolateTransparent([],!1,!1)}clearIsolates(){this.hasTransparentByIsolate=!1,this.hasObjectHiddenByIsolate=!1,this.setIsolateHide([],!1,!1),this.setIsolateTransparent([],!1,!1)}clearTransparentByIsolate(){this.hasTransparentByIsolate=!1,this.setIsolateTransparent([],!1,!1)}isHidden(e){const t=this.objectInfoDict.getNodeInfoById(e);let i=0==(t.state&r.EnumObjectState.Visible);return i=i||(t.state&r.EnumObjectState.HideByIsolate)>0,i}isFrozen(e){const t=this.objectInfoDict.getNodeInfoById(e);let i=(t.state&r.EnumObjectState.Transparent)>0;return i=i||(t.state&r.EnumObjectState.TransparentByIsolate)>0,i}resetAll(){this.objectInfoDict.setIdsState(new Map,!1,(e=>{e.state|=r.EnumObjectState.Visible,this.isActive(e.userId)&&(e.material=null)})),this.hasMaterial=!1,this.isHasObjectHidden=this.hasObjectHiddenByIsolate=!1,this.hasTransparent=this.hasTransparentByIsolate=!1}hasOverrideMaterial(e){if(null==e)return this.hasMaterial;return null!=this.objectInfoDict.getNodeInfoById(e).material||this.isTransparent(e)}hasOverrideMaterialForWireFrame(e){if(null==e)return this.hasWireFrameMaterial;return null!=this.objectInfoDict.getNodeInfoById(e).wireFrameMaterial}hasObjectInactivated(){return this.inactivatedIds.length>0}hasObjectHidden(){return this.isHasObjectHidden||this.hasObjectHiddenByIsolate}hasObjectCantSelected(){return this.hasObjectHidden()||this.hasObjectTransparent()||this.hasObjectInactivated()}hasObjectTransparent(){if(this.hasObjectInactivated()){var e=!1;for(const t of this.inactivatedIds)if(this.isTransparent(t)){e=!0;break}return e}return this.hasTransparent||this.hasTransparentByIsolate}deactivateByIds(e){for(const t of e)this.inactivatedIdMap[t]=!0;this.inactivatedIds=Object.keys(this.inactivatedIdMap)}clearInactivatedIdMap(){this.inactivatedIdMap={},this.inactivatedIds=[]}isActive(e){return 0==this.bIsInactivateAll&&!(1==this.inactivatedIdMap[e])}deactivateAll(){this.bIsInactivateAll=!0}activateAll(){this.bIsInactivateAll=!1}getInactivatedIdMap(){return this.inactivatedIdMap}addToModifyOpacityList(e,t){var i=this.modifyOpacityList;void 0===i[e]&&(i[e]={}),i[e].opacity=t,this.hasModifyOpacityList=!0}removeModifyOpacityList(e){let t=this.modifyOpacityList;e.map((e=>{delete t[e]})),0===Object.keys(t)&&(this.hasModifyOpacityList=!1)}clearModifyOpacityList(){this.modifyOpacityList={},this.hasModifyOpacityList=!1}addToLocalClippingList(e,t,i,a){var n=this.localClippingList;void 0===n[e]&&(n[e]={}),r.Utils.isDefined(a)&&(null==n[e].nodeMap&&(n[e].nodeMap=new Map),n[e].nodeMap.set(a.toString(),t)),i&&(n[e].wireframeMaterialName=i),this.hasLocalClipping=!0}clearLocalClippingList(){this.localClippingList={},this.hasLocalClipping=!1}activeLocalClipping(){this.hasLocalClipping=!0}}}(),function(){let e=new THREE.Matrix4,t=new THREE.Vector3;class i extends r.BaseModelExplosion{constructor(e){super(e),this.explosionBegin=!1,this.explosionOffset={}}explode(){this.model._tileset.explode(this)}preFloorExplode(e,t,i){this.explosionBegin=!0;let a={},n={};for(var s=0,o=t.length;s<o;s++){let e=t[s].explodedHeight-t[s].elevation,r=new THREE.Vector3(i.x*e,i.y*e,i.z*e);a[t[s].name]=r;let o=null;o=t[s].preExplodedTranslation?r.clone().sub(t[s].preExplodedTranslation):r.clone(),n[t[s].name]=o,t[s].preExplodedTranslation=r}let l=this.explosionTranslation;const d=this.model.getDescriptor();let h=new THREE.Matrix4,c=new THREE.Matrix4,u=3;const p=this.model.tilesLoader.tileReader;if(d.hasNodeInfo()){const e=d.getAnyUserData(),t=p.getUserDataByIndex(e);for(const e in t){"levelName"===p.getUserDataStringMapByIndex(e)[0]&&(u=e)}}let m={true:{},false:{}};d.getAllNodeInfosCallback((t=>{const i=t.userId,s=t.userData;let o=p.getUserDataByIndex(s)[u],f=p.getUserDataStringMapByIndex(u,o)[1],g=a[f]||new THREE.Vector3;l[i]=g,h.makeTranslation(g.x,g.y,g.z);let v=n[f]||new THREE.Vector3;if(c.makeTranslation(v.x,v.y,v.z),d instanceof r.BimtileNodeIdDescriptor&&1==m[t.instanceOrNot][i])return;const y=c.clone();if(d.patchBoxExplodeMatrix?(d.patchBoxExplodeMatrix(y,i,t.instanceOrNot),t.boundingBox.applyMatrix4(c)):t.loadedExplodeMatrix=y,t.matrix)t.matrix.multiplyMatrices(c,t.matrix),d.patchLoadedTileExplodeMatrix&&d.patchLoadedTileExplodeMatrix(t.matrix,i,t.nodeId,t.index,t.instanceOrNot),e.union(t.boundingBox),m[t.instanceOrNot][i]=!0;else{const e=h.clone();d.patchExplodeMatrix?d.patchExplodeMatrix(e,i,t.instanceOrNot):t.explodeMatrix=e}})),m=null,e.applyMatrix4(this.model.getTransformMatrix()),this.model.filter.enableVisibleStateChanged()}preElementExplode(i,a){this.explosionBegin=!0;const n=this.model.getBoundingBoxWorld();if(!n)return;const s=a-this.model.manager.explosionManager.getExplosionExtent(this.model.id);if(0==s)return;let o=new THREE.Matrix4,l=new THREE.Matrix4;e.copy(this.model.transformMatrix).invert(),n.getCenter(t),t.applyMatrix4(e);const d=this.model.getDescriptor(),h=d.getAllUserIds();let c=this.explosionTranslation,u={true:{},false:{}};for(let e=0,n=h.length;e<n;e++){let n=h[e],p=new THREE.Box3;d.getNodeInfoByUserIdCallback(n,(e=>{const t=e.nodeInfo;t.originBox||(t.originBox=t.boundingBox.clone()),p.union(t.originBox)}));let m=r.Utils.computeExplodeTranslation(t,p,a);c[n]=m,o.makeTranslation(m.x,m.y,m.z);let f=r.Utils.computeExplodeTranslation(t,p,s);l.makeTranslation(f.x,f.y,f.z),this.explosionOffset[n]=f,d.getNodeInfoByUserIdCallback(n,(e=>{const t=e.nodeInfo;if(d instanceof r.BimtileNodeIdDescriptor&&1==u[t.instanceOrNot][n])return;const a=l.clone();if(d.patchBoxExplodeMatrix?(d.patchBoxExplodeMatrix(a,n,t.instanceOrNot),t.boundingBox.applyMatrix4(l)):t.loadedExplodeMatrix=a,t.matrix)t.matrix.multiplyMatrices(l,t.matrix),d.patchLoadedTileExplodeMatrix&&d.patchLoadedTileExplodeMatrix(t.matrix,n,t.nodeId,t.index,t.instanceOrNot),i.union(t.boundingBox),u[t.instanceOrNot][n]=!0;else{const e=o.clone();d.patchExplodeMatrix?d.patchExplodeMatrix(e,n,t.instanceOrNot):t.explodeMatrix=e}}))}u=null,i.applyMatrix4(this.model.getTransformMatrix()),this.model.filter.enableVisibleStateChanged()}getExplosionTranslation(e){return this.explosionTranslation[e]||new THREE.Vector3}getExplosionTranslationByObjId(e){const t=this.model.tilesLoader.tileReader.getIndexByUserId(e);return this.explosionOffset[t]||new THREE.Vector3}getLevelNameByObjId(e){const t=this.model.getDescriptor().getUserDataByUserId(e);let i=this.model.tilesLoader.tileReader.getUserDataByIndex(t)[3];return this.model.tilesLoader.tileReader.getUserDataStringMapByIndex(3,i)[1]}standardExplode(e){function t(e,t,a,n,s){for(var o=e.getAttribute("position").array,l=t;l<a;l+=3)i.set(o[l],o[l+1],o[l+2]),i.applyMatrix4(s),i.add(n),r.copy(s).invert(),i.applyMatrix4(r),o[l]=i.x,o[l+1]=i.y,o[l+2]=i.z;e.getAttribute("position").needsUpdate=!0}if(e.explodeCount==this.model.manager.explosionManager.explodeCount)return;let i=new THREE.Vector3,r=new THREE.Matrix4;const a=e._content.meshes,n=e._content._outlineContent.outlineMeshes;new THREE.Matrix4,new THREE.Matrix4;let s=new THREE.Vector3,o=new THREE.Vector3(0),l=e=>{if("MeshEx"!==e.type&&"LineSegmentsEx"!==e.type)return;let i=e.geometry;const r=e.indexGroups;for(const[n,l]of r)for(const[r,d]of l){let r=this.getExplosionTranslation(n),l=d.preTranslation?d.preTranslation:o;if(s.set(r.x-l.x,r.y-l.y,r.z-l.z),0!=s.x||0!=s.y||0!=s.z){var a=d.positionStart;t(i,a,a+d.positionCount,s,e.matrix),d.preTranslation=r}}};a.traverse((e=>{l(e)})),n.traverse((e=>{l(e)})),e.explodeCount=this.model.manager.explosionManager.explodeCount}instanceExplode(e){function t(e,t,i,r){var a=e.getAttribute("mcol3").array;a[3*t]+=i.x,a[3*t+1]+=i.y,a[3*t+2]+=i.z,e.getAttribute("mcol3").needsUpdate=!0}if(e.explodeCount==this.model.manager.explosionManager.explodeCount)return;const i=e.instanceInfo.entityInfoArray;let r=new THREE.Vector3,a=new THREE.Vector3(0);const n=e._content.meshes.children[0],s=e._content._outlineContent.outlineMeshes.children[0];for(let e=0,o=i.length;e<o;e++){const o=i[e].userID;let l=this.getExplosionTranslation(o),d=a;i[e].preTranslation&&(d=i[e].preTranslation),r.set(l.x-d.x,l.y-d.y,l.z-d.z),0==r.x&&0==r.y&&0==r.z||(t(n.geometry,e,r),s&&s.geometry&&t(s.geometry,e,r),i[e].preTranslation=l)}e.explodeCount=this.model.manager.explosionManager.explodeCount}}r.BimTilesModelExplosion=i}(),r.BimTileNodeManager=class{constructor(){this._nodeMap={}}destroy(){this._nodeMap=null}addNode(e){this._nodeMap[e.nodeId]=e}getNode(e){return this._nodeMap[e]}},function(){class e{constructor(){this._owner=0,this._bufferGeometries=[],this._id=null,this._state=r.SharedGeometryState.UNLOADED,this._byteLength=0}get owner(){return this._owner}set owner(e){this._owner=e}get bufferGeometry(){return this._bufferGeometries}get id(){return this._id}set id(e){this._id=e}get byteLength(){return this._byteLength}set byteLength(e){this._byteLength=e}get state(){return this._state}set state(e){this._state=e}addBufferGeometry(e){this._bufferGeometries.push(e)}destroy(){this._bufferGeometries=[],this._state=r.SharedGeometryState.DESTROYED,this._id=null,this._byteLength=0}}class t{constructor(){this._geometryMap={}}destroy(){this._geometryMap=null}setByteLength(e,t){r.Utils.defined(this._geometryMap[e])&&(this._geometryMap[e].byteLength=t)}addGeometryById(t,i){let a=this._geometryMap[t];return r.Utils.defined(a)||(a=this._geometryMap[t]=new e),r.Utils.defined(i)&&a.addBufferGeometry(i),a}removeGeometryById(e){const t=this._geometryMap[e];r.Utils.defined(t)&&0===t.owner&&t.state!==r.SharedGeometryState.DESTROYED&&t.destroy()}setGeometryByteLength(e,t){const i=this._geometryMap[e];r.Utils.defined(i)&&(i.byteLength=t)}getGeometry(e){return this._geometryMap[e]}addGeometryOwner(e){const t=this._geometryMap[e];r.Utils.defined(t)&&(t.owner+=1)}removeGeometryOwner(e){const t=this._geometryMap[e];r.Utils.defined(t)&&(t.owner-=1)}resetGeometryOwner(){for(const[e,t]of Object.entries(this._geometryMap)){const e=t;r.Utils.defined(e)&&(e.owner=0)}}setShareGeometryState(e,t){const i=this.getGeometry(e);r.Utils.defined(i)&&(i.state=t)}disposeShareGeometry(e){const t=this.getGeometry(e);return!r.Utils.defined(t)||t.state!==r.SharedGeometryState.PROCESSING&&(t.owner-=1,0===t.owner&&(t.destroy(),!0))}createMesh(e,t,a){const n=e.bufferGeometry;e.owner+=1,n.forEach((e=>{e.instance?function(e,t,a){const n=e.pbfNodeInfo,s=i(e.bufferGeometry,!0,n);var o=new r.MeshEx(s,e.material);o.frustumCulled=!1,o.name=n.nodeIndexId,o.indexGroups=n.indexGroups,o.indexCount=n.indexCount,o.databagId=n.databagId,o.isInstanceMeshNode=!0,e.tileMatrix&&o.applyMatrix4(e.tileMatrix);t.content.meshes.add(o),a.addInstanceMeshIdMap(n.nodeIndexId,0,o),a.addInstanceInfo(n.nodeIndexId,n.instanceInfo),a.renderableCount++}(e,t,a):function(e,t,a){const n=e.pbfNodeInfo,s=i(e.bufferGeometry,!1,n);let o=new r.MeshEx(s,[e.material.clone()]);n.indexInfos||(n.indexInfos=new Map);o.applyMatrix4(n.matrix),o.name=n.nodeIndexId,o.indexGroups=n.indexInfos;for(const e of n.indexInfos.key())t.userIndexMap.set(e,!0);o.databagId=t._tileset._databagId,o.indexCount=e.bufferGeometry.index.couwdnt,a.addMeshIdMap(o.name,o),function(e,t){const i=e.nodeInfos,a=e.indexInfos;for(const[e,n]of Object.entries(a)){const a=i[e],s=t.getDescriptor().getAllNodeInfos()[e];for(let e=0;e<n.length;++e){const t=n[e];if(r.Utils.defined(a))for(let e=0;e<a.length;++e){const i=a[e];if(i.nodeId===t.meshId){const t=s[e];r.Utils.defined(t)&&(t.parent=i.parent,t.materialId=i.materialId,t.matrix=i.matrix.clone(),r.Utils.defined(t.explodeMatrix)&&(t.explodeMatrix=i.explodeMatrix.clone),t.type=i.type,t.cellId=i.cellId)}}}}}(n,a),t.content.meshes.add(o),n.userIdMapIndex&&a.addUserIdMapIndices(n.userIdMapIndex,o.name)}(e,t,a)})),t.needUpdateFilter=!0}}function i(e,t,i){let a;(t=r.Utils.defaultValue(t,!1))?(a=new THREE.InstancedBufferGeometry,a.groups.push({start:0,count:i.indexCount,materialIndex:0}),a.groups.push({start:0,count:i.indexCount,materialIndex:1})):(a=new THREE.BufferGeometry,a.groups.push({start:0,count:i.iAccInfoCount,materialIndex:0}));for(const[t,i]of Object.entries(e.attributes))a.setAttribute(t,i);const n=e.boundingBox;null!==n&&(a.boundingBox=n.clone());const s=e.boundingSphere;return null!==s&&(a.boundingSphere=s.clone()),a.drawRange.start=e.drawRange.start,a.drawRange.count=e.drawRange.count,a.index=e.index,a}t.SharedGeometry=e,r.BimTileGeometryManager=t}(),function(){let e=new THREE.Matrix4,t=new THREE.Box3;class i extends r.BaseModel{constructor(e,t,i,a,n,s){super(t,i),this.viewer=e,this.parseCfgFinish=n,this.debut=s,this.dataVersion=i.dataVersion,this.url=i.serverUrl+""+i.databagId,i.rootPath?this.url+="/"+i.rootPath:this.url+="/bimtiles.json",this.objectGroup=t.getScene().getOrCreateObjectGroup(`${r.ObjectGroupType.BIMTILESGROUP}|${this.databagId}`,{pickableType:r.PICKABLETYPE.Geometry,globalSpace:!0}),this.objectGroup.transformMatrix=this.transformMatrix,this._getNodeGroup(r.ObjectGroupType.GEOMETRY,{pickableType:r.PICKABLETYPE.Geometry,globalSpace:!0}),this._getNodeGroup(r.ObjectGroupType.INSTANCEGEOMETRY,{pickableType:r.PICKABLETYPE.Geometry,globalSpace:!0}),this._getNodeGroup(r.ObjectGroupType.WIREFRAME,{pickableType:r.PICKABLETYPE.UnPickable,globalSpace:!0}),this._getNodeGroup(r.ObjectGroupType.INSTANCEWIREFRAMEGEOMETRY,{pickableType:r.PICKABLETYPE.UnPickable,globalSpace:!0}),this._errorCoefficient=r.TilesUtil.BMD_GEOMETRIC_ERROR_COEFFICIENT;let o=r.TilesUtil.MODEL_SSE_Threshold_MAP[i.resourceType.toLowerCase()];i.resourceType&&o&&(this._errorCoefficient=o),this.disableUserData=i.disableUserData,this._enableBorderLine=i.enableBorderLine,this._maxDetailLevel=i.maxDetailLevel,this._detailLevelList=i.detailLevelList,this._visualRange=i.visualRange,this._onDemand=i.onDemand,this._hasLayerInfo=i.hasLayerInfo,!0===i.onDemand&&!1===i.hasLayerInfo&&console.warn("the model has no layer info, will show nothing on demand"),this.delayLoadTexture=r.GlobalData.DelayLoadTexture,this.sceneState=e.modelManager.sceneState,this.isOsgb=this._config.metadata&&"osgb"===this._config.metadata.content,this.isBim=this._config.metadata&&"bim"===this._config.metadata.content,this.is2D=this._config.metadata&&"dwg"===this._config.metadata.content,this.filter=this._crateFilterManger(),this.filter.setObserverForSceneState(this.manager.getFilter().getObserverForSceneState()),this.sceneState.transparentMaterial=this.getFilter()._getMaterialByName("scene"),this.sceneState.frozonMaterial=this.getFilter().getFrozonMaterial(),this.sceneState.frozonMaterial.side=THREE.FrontSide,this.materialManager=this._crateMaterialManger({viewer:e}),this.materialManager._updateIBL(this),this.modelExplosion=new r.BimTilesModelExplosion(this);const l=this._config.metadata&&"point"===this._config.metadata.FeatureType&&"shp"===this._config.metadata.content;this._createLoader({batchMergeEnabled:!0,sceneState:this.sceneState,delayLoadTexture:this.delayLoadTexture,materialManager:this.materialManager,enableBorderLine:this._enableBorderLine,filter:this.filter,disableUserData:this.disableUserData,modelExplosion:this.modelExplosion,wireFrameVisibilityOption:i.wireFrameVisibilityOption,renderFunction:()=>{this.manager.setRenderStateChanged(!0)},isShpPoint:l,dataVersion:this.dataVersion}),this.filter.setTileReader(),this.tilesLoader.tileReader.searchTreeManager.setIs2D(this.is2D),!0===l&&(this.objectGroup.pickableType=r.PICKABLETYPE.Marker3d,this.objectGroup.hoverEnabled=!0),this._onDemandConditions=void 0===i.demandConditions?[]:i.demandConditions,this.onDemandManager=new r.BimTileOnDemandManager(this),this.modelLoaded=!1,this._shellModel=null,this.minDistanceObjects={},this.blinkStartTimeMap={},this.blinkLastTimeMap={},this.positiveSequenceMap={},this.blinkColorMap={},this.blinkTimesMap={},this.exposureShift=0,this._tileSequence=0,this._parameters=i,this._cloneCursor=0,this.mapClippingIds=new Map,this.plugins=[],this._setStatistics(this._config),this.lastHoverId=void 0;const d=e.rendererManager.getPickingEffecter();d.enableUpdateScene(!1),this.pickingManager=new r.BimTilesPickingManager(this,d)}destroy(){this._tileset=this._tileset&&this._tileset.destroy(),this.clearGroups(),this.manager.scene.removeObjectGroupByName(`${r.ObjectGroupType.BIMTILESGROUP}|${this.databagId}`),this.objectGroup.transformMatrix=void 0,this.objectGroup=null,this.manager.scene.removeObjectGroupByName(`${r.ObjectGroupType.BIMTILESWIREFRAMEGROUP}|${this.databagId}`),this.tilesLoader.destroy(),this.tilesLoader=null,this.parseCfgFinish=null,this.debut=null,this.viewer=null,this.delayLoadTexture=void 0,this.sceneState=null,this.filter.destroy(),this.materialManager.destroy(),this.materialManager=null,this.blinkStartTimeMap=null,this.blinkLastTimeMap=null,this.positiveSequenceMap=null,this.blinkColorMap=null,this.blinkTimesMap=null,super.destroy(),this._shellModel=null,this.disableUserData=void 0,this._maxDetailLevel=void 0,this._detailLevelList=null,this._visualRange=null,this._parameters=null;for(var e=0,t=this.plugins.length;e<t;e++)this.plugins[e].destroy(),this.plugins[e]=null;this.plugins=null,this.lastHoverId=void 0,this.pickingManager.destroy(),this.pickingManager=null}_createLoader(e){r.BimTilesVersionControl.isVersion_3(this.dataVersion)?this.tilesLoader=new r.BimTilesLoaderV3(e):this.tilesLoader=new r.BimTilesLoader(e)}clearGroups(){let e=this._getNodeGroup(r.ObjectGroupType.GEOMETRY);e.clear(),e=this._getNodeGroup(r.ObjectGroupType.WIREFRAME),e.clear(),e=this._getNodeGroup(r.ObjectGroupType.INSTANCEGEOMETRY),e.clear(),e=this._getNodeGroup(r.ObjectGroupType.INSTANCEWIREFRAMEGEOMETRY),e.clear()}load(e){var t=this;this.manager.chooseRendering(this.statistics.memoeryInfo,!0),this.parseCfgFinish&&this.parseCfgFinish(),this.manager.dispatchEvent({type:r.EVENTS.ON_LOAD_START_NO_PROGRESS}),this._createTileSet();const i=new Promise(((e,i)=>{this._tileset.loadTileset(this.url,(function(i){t.getTransforms().boundingBox=i._boundingBox.clone(),t.modelLoaded=!0,t.manager.updateScene(t),t.filter._updateFilterManager();const a=t.viewer.getScene().getRawMatrixGlobal();i.updateGlobalMatrix(a),t.updateModelMaximumScreenSpaceError(),t.manager.dispatchEvent({type:r.EVENTS.ON_LOAD_COMPLETE,modelId:t.id}),t.debut&&t.debut(t),t._onDemand&&t._tileset.updateOnDemandConditions(t._onDemandConditions),!1===t.disableUserData&&t.tilesLoader.praseWireFrameVisibilityOption(t._parameters.wireFrameVisibilityOption),e()}),(function(){if(void 0===t._tileset.root)return t.manager.dispatchEvent({type:r.EVENTS.ON_LOAD_EMPTY_SCENE,modelId:t.id}),console.warn("The scene is Empty!"),t.debut&&t.debut(t),void e();t.manager.dispatchEvent({type:r.EVENTS.ON_LOAD_INVALID_SCENE,modelId:t.id}),i()}))}));return i}_createTileSet(){if(!this._tileset)return this._tileset=this._createNewTileset({loader:this.tilesLoader,objectGroup:this.objectGroup,transformMatrix:this.transformMatrix,batchMergeEnabled:!0,tilesCacheScheduler:this.manager.tilesCacheScheduler,onDemandManager:this.onDemandManager,enableBorderLine:this._enableBorderLine,maxDetailLevel:this._maxDetailLevel,visualRange:this._visualRange,hasLayerInfo:this._hasLayerInfo,errorCoefficient:this._errorCoefficient,debugShowBoundingBox:this.viewer._options.debugShowBoundingBox,debugShowStatistics:this.viewer._options.debugShowStatistics,debugShowGeometricErrorHelper:new r.LabelCollection(this.viewer),databagId:this.databagId,fileId:this.fileId,disableUserData:this.disableUserData,sequence:0,materialManager:this.materialManager,skipLodEnabled:this._parameters.skipLodEnabled,foveatedConeLimit:this.viewer._foveatedConeLimit,userInputWorking:this.isBim}),this._tileset}_getNodeGroup(e,t){const i=this.objectGroup.children;for(let t=0,r=i.length;t<r;t++)if(i[t].name==e)return i[t];const a=new r.ObjectGroup(e,t);return this.objectGroup.add(a),a.globalSpace&&(a.matrixAutoUpdate=!1,a.updateMatrixWorld(!0)),a}_removeNodeGroup(e){this._rootNodeGroup.removeByName(e)}_createNewTileset(e){return new r.BimTileset(e)}clone(e,t){let i=(e=r.Utils.defaultValue(e,{})).transformMatrix;r.Utils.defined(i)||(i=new THREE.Matrix4),i=this.transformMatrix.clone().multiply(i),this._cloneCursor++;const a=r.Utils.defaultValue(e.modelId,`${this.id}_${this._cloneCursor}`);if(!r.Utils.defined(t)){const e={serverUrl:this._parameters.serverUrl,databagId:this._parameters.databagId,rootPath:this._parameters.rootPath,resourceType:this._parameters.resourceType,onDemand:this._parameters.onDemand,hasLayerInfo:this._parameters.hasLayerInfo,loadConfig:{transformMatrix:i},modelId:a};t=this._createNewModel(this.viewer,this.manager,e)}const n=t;return super.clone(n),n._copy(this),this._cloneTileSet(n),this.manager.addModel(n),this.manager.updateFilterManager(),this.manager.getFilter().calculateVisibleComponentsBbox(),this.manager.updateScene(this),this.viewer.render(),t}_createNewModel(e,t,r){return new i(e,t,r)}_copy(e){super._copy(e),this.modelLoaded=e.modelLoaded,this._shellModel=null}_cloneTileSet(e){this._tileset||console.log(`there is not tileset in model ${this.id}, please check it`);const t=e._createTileSet();this._tileset.clone(t,e.tilesLoader)}loadOnDemand(e){this._tileset.updateOnDemandConditions(e),this.manager.setRenderStateChanged(!0)}isEmptyScene(){return!this.modelLoaded}updateModelMaximumScreenSpaceError(){const e=this.viewer,t=e.domElement.offsetHeight;this._tileset.updateMaximumScreenSpaceError({camera:e.camera,globalMatrix:e.getScene().getRawMatrixGlobal(),globalInverseMatrix:e.getScene().getInverseMatrixGlobal(),transformMatrix:this.transformMatrix,cameraPreSSE:t/e.camera.frustumHeightFactor})}updateMaterialsValue(e,t,i){this.materialManager.updateMaterialsValue(this,e,t,i)}changeAllMaterials(e){this.materialManager.changeAllMaterials(this,e),this.tilesLoader.batchedMeshManager.changeAllMaterials(this.materialManager.materialMap),this.tilesLoader.instancedMeshManager.changeAllMaterials(this.materialManager.materialMap)}getBoundingBoxWorld(){return this.getTransforms().boundingBox.clone().applyMatrix4(this.getTransformMatrix())}setModelMaximumScreenSpaceError(e){this._tileset.setMaximumScreenSpaceError(e)}setDetailRatio(e){this._tileset.setGeoErrScaleFactor(e),this.manager.setRenderStateChanged(!0)}getDetailRatio(e){return this._tileset.getGeoErrScaleFactor()}getMeshesByUserIds(e,t){e&&t&&(this.minDistanceObjects[e]=[],this.minDistanceObjects[t]=[],this.getMeshesByUserId(e),this.getMeshesByUserId(t))}getMeshesByUserId(e){const t=this.getLengthUnitsMatrix(),i=this.tilesLoader.tileReader.getIndexByUserId(e);this.getDescriptor().getNodeInfoByUserIdCallback(i,(r=>{const a=r.nodeInfo,n=a.parent||a.nodeId;let s={};if(s.boundingBox=a.boundingBox,s.matrix=a.matrix,s.unitsMatrix=t,!1===a.instanceOrNot){const t=this.tilesLoader.getMeshNodeById(n);if(!t)return;s.mesh=t;const r=s.mesh.indexGroups.get(i);for(const t of r.values())s.indexInfo=t,this.minDistanceObjects[e].push(s)}else{const t=this.tilesLoader.getInstanceMeshNodeById(n);if(!t)return;for(const i in t){const r=t[i];s.matrix=r.matrix.clone().multiply(a.matrix),s.mesh=r.mesh,this.minDistanceObjects[e].push(s)}}}))}calculateClippingIds(e,i){const a=this.manager.scene,n=r.FillClipPlaneManager.getInstance(a),s=n&&n.isEnabled(),o=a.clipPlanes;let l=s?n:o,d=l.renderClipPlane.clone();(s?l.capsIntersectPosition:l.capsIntersectPosition[l.selectIndex]).length=0;s||l.selectIndex;o&&i&&this.mapClippingIds.clear();let h=this.getFilter().getLocalClippingList(),c=this.viewer.getRenderer().localClippingEnabled&&Object.keys(h).length>0;const u=a.getMatrixGlobal().clone(),p=this.manager.getModelLengthUnitsMatrix(this);p&&u.multiply(p),this.tilesLoader.getDescriptor().getAllNodeInfosCallback((e=>{if(!c||c&&h[e.userId]){const i=e.boundingBox;t.copy(i).applyMatrix4(u),d.intersectsBox(t)&&this.mapClippingIds.set(e.userId,!0)}})),this.filter.enableStateChanged()}calculateClippingContours(t){const i=this.manager.scene;let a=r.FillClipPlaneManager.getInstance(i),n=a.renderClipPlane;a.planeMesh;const s=r.FillClipPlaneManager.getFillClipPlaneBoundingBoxWorld(i);e.copy(this.transformMatrix).invert();const o=s.clone().applyMatrix4(e),l=this.id;a.capsIntersectContour[l]={};const d=this.manager.getScene().getInverseMatrixGlobal();let h=n.clone().applyMatrix4(d);const c=this.tilesLoader.getDescriptor();t.map((e=>{const t=this.tilesLoader.tileReader.getIndexByUserId(e);c.getNodeInfoByUserIdCallback(t,(i=>{const r=i.nodeInfo,d=r.boundingBox.clone().applyMatrix4(this.transformMatrix);(d.intersectsPlane(h)||d.intersectsBox(o))&&(r.instanceOrNot?this.tilesLoader.instancedMeshManager.calculateClippingContours(l,n,s,t,e,r,this.transformMatrix,a.capsIntersectContour):this.tilesLoader.batchedMeshManager.calculateClippingContours(l,n,s,t,e,r,this.transformMatrix,a.capsIntersectContour))}))}))}getUserIdMapByFrustum(e){let t={},i=new THREE.Box3;var r=this.viewer.getScene().getMatrixGlobal();const a=this.transformMatrix,n=this.tilesLoader.tileReader.getSearchTreeBuffer(),s=this.manager.explosionManager.isExploded(this.id);for(const o in n){const l=n[o].searchTreeBlob,d=n[o].box;i.copy(d),i.applyMatrix4(a).applyMatrix4(r),(e.intersectsBox(i)||s)&&this.tilesLoader.tileReader.searchTreeManager.getUserIdsInFrustum(l,e,t,a,r,s)}return t}getRealUserId(e){return this.tilesLoader.tileReader.getUserIdByIndex(e)}getGeometryBuffersByUserId(e){let t=[],i=new Set;return this.getDescriptor().getNodeInfoByUserIdCallback(e,(r=>{const a=r.nodeInfo,n=a.parent||a.nodeId;i.has(n)||(!1===a.instanceOrNot?this.tilesLoader.batchedMeshManager.getGeometryBuffersByNodeInfo(n,e,this.databagId,t):this.tilesLoader.instancedMeshManager.getGeometryBuffersByNodeInfo(n,a,this.databagId,t),i.add(n))})),t}getNodeInfosByUserIndex(e){let t=[],i=new THREE.Box3;return this.getDescriptor().getNodeInfoByUserIdCallback(e,(e=>{const r=e.nodeInfo,a=r.clone?r.clone():r;a.transformMatrix=this.getTransformMatrix();const n=r.userData,s=this.tilesLoader.tileReader.getUserDataByIndex(n);let o={};for(let e in s){const[t,i]=this.tilesLoader.tileReader.getUserDataStringMapByIndex(e,s[e]);o[t]=i}a.userData=o;const l=r.boundingBox;i.union(l),t.push(a)})),t}getNodeInfosByUserId(e){const t=this.tilesLoader.tileReader.getIndexByUserId(e);let i=[],r=new THREE.Box3;return this.getDescriptor().getNodeInfoByUserIdCallback(t,(e=>{const t=e.nodeInfo,a=t.clone?t.clone():t;a.transformMatrix=this.getTransformMatrix();const n=t.userData,s=this.tilesLoader.tileReader.getUserDataByIndex(n);let o={};for(let e in s){const[t,i]=this.tilesLoader.tileReader.getUserDataStringMapByIndex(e,s[e]);o[t]=i}a.userData=o;const l=t.boundingBox;r.union(l),i.push(a)})),i}getMaterialByMaterialId(e,t){if(e)return this.materialManager.materialMap[e];const i=t.nodeId,r=this.tilesLoader.getInstanceMeshNodeById(i);return r?r[0].mesh.material[0]:void 0}getPickingMeshes(e,t,i,a,n){let s=this.getId();t[s]=new r.ObjectGroup,t[s].matrix.copy(this.getTransformMatrix()),t[s].matrixAutoUpdate=!1;var o=!(!n||"string"!=typeof n||!n.startsWith("glow"));this._dealNonInstancedNodesForPicking(e,t[s],i,a,o),this._dealInstancedNodesForPicking(e,t[s],i,a,o)}_dealNonInstancedNodesForPicking(e,t,i,a,n){let s=new r.ObjectGroup;const o=e.selectedMaterial,l=i.length,d=this.getDescriptor();if(d.hasNodeInfo()&&!1!==this.visible){for(let e=0;e<l;++e){const t=this.tilesLoader.tileReader.getIndexByUserId(i[e]);this.filter.isPickable(t)&&d.getBatchedNodeInfoByUserIdCallback(t,(e=>{const i=e.nodeInfo;this.filter._isPickable(i)&&(this.tilesLoader.batchedMeshManager.updatePickingMeshes(i,t,o,s,n),this.tilesLoader.batchedWireframeManager.updatePickingMeshes(i.lineId,t,o,s))}))}t.add(s)}}_dealInstancedNodesForPicking(e,t,i,a,n){let s=new r.ObjectGroup;const o=e.selectedMaterial,l=i.length,d=this.getDescriptor();if(d.hasNodeInfo()&&!1!==this.visible){if(n){const e={bimtileDescriptor:d,instanceMeshGroup:s,selectedIds:i};return this.tilesLoader.instancedMeshManager.updatePickingMeshesByIds(e),void t.add(s)}for(let e=0;e<l;++e){const t=this.tilesLoader.tileReader.getIndexByUserId(i[e]);this.filter.isPickable(t)&&d.getInstanceNodeInfoByUserIdCallback(t,(e=>{const i=e.nodeInfo,r=i.parent;this.tilesLoader.instancedMeshManager.updatePickingMeshes(r,o,i.matrix,s,n,i.index),this.tilesLoader.instancedWireframeManager.updatePickingMeshes(i.lineId,t,o,i.matrix,s)}))}t.add(s)}}isHiddenSourceObjectUserId(e){return this.manager.isHiddenSourceObjectUserId(e,this.id)}hasHiddenSourceObjectUserId(){return this.manager.hasHiddenSourceObjectUserId()}getModelMaximumScreenSpaceError(){return this._tileset.getMaximumScreenSpaceError()}updateMatrix(){const e=this.viewer.getScene().getRawMatrixGlobal();this._tileset.updateGlobalMatrix(e)}hasTransforms(){return!0}preUpdate(e){this._tileset.preUpdate(e)}update(e){this._tileset.update(e)}postUpdate(e){this._tileset.postUpdate(e)}updateUnitScale(e){e.unitScale=this.unitScale}isCulled(){return!!this.isUseable()&&this._tileset.root.visible}_hasNode(){return 0!==this.objectGroup.children.length}getDescriptor(){return this.tilesLoader.getDescriptor()}getAllNodeInfos(){return this.getDescriptor().getAllNodeInfos()}applyFilter(){}applySelection(){this.pickingManager.setSelectedIdMap(this.sceneState.selectionSet[this.getId()]),this.pickingManager.enableSelectionStateChanged()}clearSelection(){this.pickingManager.setSelectedIdMap({}),this.pickingManager.enableSelectionStateChanged()}clearHover(){this.sceneState.hoverId=void 0,this.lastHoverId=this.sceneState.hoverId,this.filter.enableStateChanged()}applyHover(){this.sceneState.hoverId!==this.lastHoverId&&(this.lastHoverId=this.sceneState.hoverId,this.filter.enableStateChanged())}setVisible(e){this.visible=e,this.objectGroup.visible!==e&&(this.objectGroup.visible=e,this.objectGroup.pickableType=e?r.PICKABLETYPE.Geometry:r.PICKABLETYPE.UnPickable,this.manager.setRenderStateChanged(!0),0==e&&this.pickingManager.clearDrawable())}isUserIdExist(e){const t=this.tilesLoader.tileReader.getIndexByUserId(e);return this.getDescriptor().isUserIdExist(t)}getBlinkMaterials(){return this.filter.getBlinkMaterials()}updateBlinkMaterial(e){var t=this.sceneState.getBlinkComponentsIdMap(this.id),i=(this.filter.blinkMaterials,this.manager.blinkManager);for(var a in t){var n=t[a],s=this.tilesLoader.tileReader.getIndexByUserId(a);const p=this.filter.getBlinkMaterialsByUserId(s);if(p){n.color&&(this.blinkColorMap[a]=this.blinkColorMap[a]||new THREE.Vector4,this.blinkColorMap[a].set(n.color.red/255,n.color.green/255,n.color.blue/255,n.color.alpha));var o=this.blinkColorMap[a]||i.getBlinkColor(this.id),l=0,d=r.EnumShaderColorState.BLINK,h=n.interval||e||600,c=Date.now();if(this.blinkTimesMap[a]=null==this.blinkTimesMap[a]?0:this.blinkTimesMap[a],void 0===this.blinkStartTimeMap[a]&&(this.positiveSequenceMap[a]=!0,this.blinkStartTimeMap[a]=c,this.blinkLastTimeMap[a]=c),c-this.blinkLastTimeMap[a]<=100)return;if(c-this.blinkStartTimeMap[a]>h&&(this.positiveSequenceMap[a]=!this.positiveSequenceMap[a],this.blinkStartTimeMap[a]=c,this.blinkLastTimeMap[a]=c,n.times&&(this.blinkTimesMap[a]++,this.blinkTimesMap[a]==2*n.times)))return this.blinkTimesMap[a]=0,void this.sceneState.clearBlinkComponentsById([a],this.id);var u=(c-this.blinkStartTimeMap[a])/h;l=this.positiveSequenceMap[a]?u:1-u,this.blinkLastTimeMap[a]=c;for(const e of p)e.updateBlinkUniformValue(d,o,l)}}}setExposureShift(e){this.exposureShift=e,r.GlobalData.ToneMapping=1;const t=e>0?-.4*e+.5:-4*e+.5;this.materialManager.updateMaterialsValue(this,"shift",t),this.manager.setRenderStateChanged(!0)}getExposureShift(){return this.exposureShift}setBorderLineVisible(e){this._enableBorderLine=e,this._getNodeGroup(r.ObjectGroupType.WIREFRAME).visible=e,this._getNodeGroup(r.ObjectGroupType.INSTANCEWIREFRAMEGEOMETRY).visible=e,this.tilesLoader&&this.tilesLoader.setBorderLineVisible(e)}isBorderLineVisible(){return this._enableBorderLine}_setStatistics(e){e&&e.count&&(this.statistics.numOfElements=e.count.element,this.statistics.numOfTriangles=e.count.mesh_face,this.statistics.numOfVertices=e.count.mesh_vertex)}loadBusinessResources(e){!1!==this.disableUserData&&this._tileset.loadUserIdResources((()=>{this.tilesLoader.recoverIndexInfo((()=>{this.tilesLoader.recoverNodeInfo(),this.tilesLoader.recoverLineNode(),this.filter._updateFilterManager(),this.tilesLoader.praseWireFrameVisibilityOption(this._parameters.wireFrameVisibilityOption),this.disableUserData=!1,this._tileset.disableUserData=!1,this.tilesLoader.disableUserData=!1,e&&e()}))}))}debugShowGeometricError(e){this._tileset&&this._tileset.debugShowGeometricError(e)}get sequence(){return this._tileSequence}set sequence(e){this._tileSequence=e}set shellModel(e){this._shellModel=e}get shellModel(){return this._shellModel}set config(e){this._config=e}get config(){return this._config}setCastShadow(e){super.setCastShadow(e),this.viewer.traverseGroupEnableShadow(this.objectGroup,this.castShadow,this.receiveShadow),this.viewer.updateShadowMap()}setReceiveShadow(e){super.setReceiveShadow(e),this.viewer.traverseGroupEnableShadow(this.objectGroup,this.castShadow,this.receiveShadow),this.viewer.updateShadowMap()}enableLocalClippingMode(e){this.localClippingMode=e,this.tilesLoader.instancedMeshManager.updateInstanceClipping(e);if(this.tilesLoader.instancedWireframeManager.updateInstanceClipping(e),!e)for(var t in this.localClippingPlanes=null,this.materialManager.materialMap){this.materialManager.materialMap[t].clippingPlanes=null}}getPolygonOutLine(e,t){t&&this.tilesLoader.loadPolygonOutLine(e,t)}isVisibleMesh(e){const t=this.tilesLoader.batchedMeshManager.getMeshNodeById(e);if(t&&!0===t.visible&&t.parent&&!0===t.parent.visible)return!0;const i=this.tilesLoader.instancedMeshManager.getInstanceMeshNodeById(e);for(const e in i){const t=i[e].mesh;if(!r.TilesUtil.isInstanceNodeInVisible(t))return!0}return!1}setMaxDetailLevel(e){if(this._detailLevelList.length>0){const t=this._detailLevelList[0];if(e<t)return console.log(`${this.id} minDetailLevel  is ${t}, ${e} set`),void(this._tileset.maxDetailLevel=t)}this._tileset.maxDetailLevel=e}getMaxDetailLevel(){return this._tileset.maxDetailLevel}setVisualRange(e){this._tileset.visualRange=e}getVisualRange(){return this._tileset.visualRange}getRootGeoErrDistance(){const e=this.viewer.domElement.offsetHeight/this.viewer.camera.frustumHeightFactor;return this._tileset.getRootGeoErrDistance(e)}rayCastVertical(e){const t=new THREE.Vector3(e.x,e.y,this.getBoundingBoxWorld().max.z+10),i=this.viewer.getScene().getRawMatrixGlobal();t.applyMatrix4(i);const a=new r.Raycaster(t,new THREE.Vector3(0,-1,0)),n=[];if(this._tileset.traverseContentAvailableNode((e=>{e._content._meshes.traverse((e=>{if("MeshEx"!==e.type)return;const t=[];e.raycast(a,t),t.length>0&&n.push(t[0])}))})),0===n.length)return;n.sort(((e,t)=>e.distance-t.distance));const s=n[0].point,o=this.viewer.getScene().getInverseMatrixGlobal();return s.applyMatrix4(o),s}setReplacedUserIdMap(e){r.Utils.isOwnEmptyObject(e)?this.replacedUserIdMap=null:this.replacedUserIdMap=e}hasReplacedUserId(){return!r.Utils.isEmptyObject(this.replacedUserIdMap)}isReplacedUserId(e){return this.replacedUserIdMap&&this.replacedUserIdMap[e]}registerPlugin(e){this.plugins.push(e)}getModelDescriptor(){return this.getDescriptor()}_getNodeGroup(e,t){const i=this.objectGroup.children;for(let t=0,r=i.length;t<r;t++)if(i[t].name==e)return i[t];const a=new r.ObjectGroup(e,t);return this.objectGroup.add(a),a.globalSpace&&(a.matrixAutoUpdate=!1,a.updateMatrixWorld(!0)),a}getWireframeMaterial(){return this.tilesLoader.bimTileOutlineBlobParser.getLineParser().wireframeMaterial}getInstanceWireframeMaterial(){return this.tilesLoader.bimTileOutlineBlobParser.getLineParser().instanceWireframeMaterial}setWireframeColor(e,t){this.tilesLoader.bimTileOutlineBlobParser.getLineParser().setWireframeColor(e,t)}getWireframeColor(){return this.tilesLoader.bimTileOutlineBlobParser.getLineParser().getWireframeColor()}restoreWireframeColor(){return this.tilesLoader.bimTileOutlineBlobParser.getLineParser().restoreWireframeColor()}getAllWireframeGroupNames(){return[r.ObjectGroupType.WIREFRAME,r.ObjectGroupType.INSTANCEWIREFRAMEGEOMETRY]}adjustVisibility(e){this._getNodeGroup(r.ObjectGroupType.GEOMETRY).visible=e,this._getNodeGroup(r.ObjectGroupType.WIREFRAME).visible=e}adjustInstanceVisibility(e){this._getNodeGroup(r.ObjectGroupType.INSTANCEGEOMETRY).visible=e,this._getNodeGroup(r.ObjectGroupType.INSTANCEWIREFRAMEGEOMETRY).visible=e}applyBlink(){this.filter.enableStateChanged()}clearBlink(){this.filter.enableStateChanged()}setExcavation(e){}_crateFilterManger(){return r.BimTilesVersionControl.isVersion_3(this.dataVersion)?new r.BimTileFilterManagerV3(this):new r.BimTileFilterManager(this)}_crateMaterialManger(e){return new r.BimTileMaterialManager(e)}getAllUserIds(){return this.getDescriptor().getAllUserIds().map((e=>this.getRealUserId(e)))}isUserIdDataReady(){return this._tileset._userIdReady}getUserIdTileMap(e){let t={};const i=e.length;for(let r=0;r<i;++r){const i=this.tilesLoader.tileReader.getIndexByUserId(e[r]);t[e[r]]={},this.getDescriptor().getUserTileIdMap(i,t[e[r]])}return t}getUserIdTileMapVisibility(e){for(const t in e)for(const i in e[t])this.objectGroup.traverse((r=>{r.tileId===parseInt(i)&&(e[t][i]=r.visible)}))}updateTransformMatrix(){super.updateTransformMatrix(),this.pickingManager.enableSelectionStateChanged()}isUserIdVisible(e){let t=this.getNodeInfosByUserId(e),i=t[0].nodeId;return null==this.tilesLoader.getMeshNodeById(i)&&null==this.tilesLoader.getInstanceMeshNodeById(i)&&(i=t[0].parent),this.isVisibleMesh(i)}}r.BimTilesModel=i}(),function(){class e extends r.AbstractTileContent{constructor(e,t){super(e,t),this._outlineContent=new r.BimTileOutlineContent(e),this._loader=e._loader,this.contentBufferNum=0,this._copyMeshes=null}destroy(){this._outlineContent.destroy(),this._outlineContent=void 0,super.destroy(),this._loader=null,this.clearCopyMeshes()}update(e){const t=this._tile;this._state===r.TileContentProcessState.PENDING&&(this._state=r.TileContentProcessState.PROCESSING,t.parseContentBlock(this._contentBuffer,(()=>{this.parseTileContent((i=>{this._state=r.TileContentProcessState.PROCESSED,this.attachToTilesGroup(i),this.disposeContentBuffer(),t._clearMeshBuffer(),t._clearLineBuffer(),this._readyDeferred&&this._readyDeferred.resolve(this),this._ready=!0,e.afterRenderFns.push((function(){}))}))}))),this._state,r.TileContentProcessState.PROCESSED,this._ready&&t.isOutlineActivated()&&this._outlineContent.update()}parseTileContent(e){const t=this;if(this._tile.contentTypeInstance)this._loader.parseTileContent(this._tile,(i=>{r.Utils.defined(t._tile)&&(t._tile.setByteLength(t.geometryByteLength),e(i),t.setShareGeometryProcessed())}));else{this.contentBufferNum=Object.keys(this._contentBuffer).length;for(const i in this._contentBuffer)i===this._tile.getAbsoluteContentUrl()?this._loader.parseTileContent(this._tile,(i=>{this.contentBufferNum--,0===this.contentBufferNum&&r.Utils.defined(t._tile)&&(t._tile.setByteLength(t.geometryByteLength),e(i),t.setShareGeometryProcessed())})):this._loader.parseTileLineContent(this._tile,(i=>{this.contentBufferNum--,0===this.contentBufferNum&&r.Utils.defined(t._tile)&&e(i)}))}}clone(t){t=r.Utils.defaultValue(t,new e),super.clone(t)}attachToTilesGroup(e){const t=e.contentType===r.TileContentType.DATA_INSTANCE?this._tile._tileset._objectGroup.getObjectByName(r.ObjectGroupType.INSTANCEGEOMETRY):this._tile._tileset._objectGroup.getObjectByName(r.ObjectGroupType.GEOMETRY);t.add(this.meshes),t.updateMatrixWorld(!0)}getCopyMeshes(){if(r.Utils.defined(this._copyMeshes))return this._copyMeshes;this._copyMeshes=new THREE.Group,this._copyMeshes.name=this._meshes.name;return(this._tile.contentTypeInstance?this._tile._tileset._objectGroup.getObjectByName(r.ObjectGroupType.INSTANCEGEOMETRY):this._tile._tileset._objectGroup.getObjectByName(r.ObjectGroupType.GEOMETRY)).add(this._copyMeshes),this._copyMeshes.matrix.copy(this._meshes.matrix),this._copyMeshes.matrixAutoUpdate=!1,this._copyMeshes.updateMatrixWorld(!0),this._copyMeshes}clearCopyMeshes(){this._copyMeshes&&this._copyMeshes.clear()&&this._copyMeshes.parent.remove(this._copyMeshes),this._copyMeshes=null}disposeShareGeometry(){const e=this._tile._tileset.geometryManager;return!r.Utils.defined(e)||e.disposeShareGeometry(this._tile.nodeId)}setShareGeometryProcessed(){const e=this._tile._tileset.geometryManager;r.Utils.defined(e)&&(e.setShareGeometryState(this._tile.nodeId,r.SharedGeometryState.PROCESSED),e.addGeometryOwner(this._tile.nodeId))}isOutlineContentReady(){return this._outlineContent.contentReady}}r.BimTileContent=e}(),r.BimTileOutlineContent=class{constructor(e){this._tile=e,this._url=void 0,this._state=r.TileContentProcessState.PENDING,this._request=void 0,this._destroyed=!1,this._buffer=void 0,this._outlineMeshes=new THREE.Group,this._outlineMeshes.name=r.Utils.getEncodedString(this._tile.getAbsoluteContentUrl())||e.name,this._outlineMeshes.databagId=e._databagId,this._outlineMeshes.fileId=e._fileId,this._outlineMeshes.matrixAutoUpdate=!1}destroy(){this._destroyed=!0,this._request&&(this._request.destroy(),this._request=void 0),this.disposeLineGeometry(),this._buffer=void 0,this._outlineMeshes=void 0,this._tile=void 0}isDestroyed(){return this._destroyed}get contentReady(){return this._state===r.TileContentProcessState.READY}get outlineMeshes(){return this._outlineMeshes}set visible(e){this._outlineMeshes.visible=e}disposeLineGeometry(){this._outlineMeshes.parent&&this._outlineMeshes.parent.remove(this._outlineMeshes);const e=this._outlineMeshes.children;for(let t=0,i=e.length;t<i;++t){const i=e[t],r=i.geometry;r.dispose(),r.groups=void 0,r.index=void 0,r.attributes=void 0,i.geometry=void 0,i.material=void 0}}requestContent(){const e=this._tile,t=new r.Request({throttle:!0,type:e._tileset.type,url:e.getOutlineContentUrl(),priorityCallback:e._createPriorityCallback(e)});this._request=t;const i=this._fetchContent(t);if(!i)return!1;const a=this._state;this._state=r.TileContentProcessState.LOADING;const n=this._handleFailedContent(this,e._tileset);return++e._tileset.statistics.numberOfPendingRequests,i.then((t=>{if(this.isDestroyed())return void n();--e._tileset.statistics.numberOfPendingRequests,this._state=r.TileContentProcessState.LOADED;const i=Object.keys(t);this._buffer=t[i[0]]})).catch((i=>{if(t.state===r.RequestState.CANCELLED)return this._state=a,this.handleAfterRequestCancelled(),--e._tileset.statistics.numberOfPendingRequests,void++e._tileset.statistics.numberOfAttemptedRequests;n(i)})),!0}handleAfterRequestCancelled(){}_fetchContent(e){const t=this;e.requestCallback=function(){const i=new r.Deferred;return t._loadArrayBuffer(e.url,i),i.promise},e.cancelCallback=function(){};const i=r.RequestScheduler.request(e);if(i)return i.then((function(t){return e.cancelCallback=void 0,t})).catch((function(t){return e.cancelCallback=void 0,Promise.reject(t)}))}_handleFailedContent(e,t){return function(i){e._state===r.TileContentProcessState.PROCESSING?--t.statistics.numberOfTilesProcessing:--t.statistics.numberOfPendingRequests,e._state=r.TileContentProcessState.FAILED}}_loadArrayBuffer(e,t){this._tile.fetchContentBlock([e],(function(e){t.resolve(e)}),(function(e){t.reject(e)}))}parseContentBlock(){this._state=r.TileContentProcessState.PROCESSING,this._tile.parseOutlineContentBlock(this._buffer,(()=>{this._state=r.TileContentProcessState.PROCESSED}))}createMesh(){const e=this._tile,t=e._loader;this._state=r.TileContentProcessState.CONSTRUCTING,t.parseTileOutlineContent(e,(()=>{if(this.isDestroyed())return this._state=r.TileContentProcessState.FAILED,void this.disposeContentBuffer();this._state=r.TileContentProcessState.READY,this.updateContentLength(),this.attachToTilesGroup(e),this.disposeContentBuffer()}))}disposeContentBuffer(){this._buffer=void 0}attachToTilesGroup(e){const t=e.contentType===r.TileContentType.DATA_INSTANCE?this._tile._tileset._objectGroup.getObjectByName(r.ObjectGroupType.INSTANCEWIREFRAMEGEOMETRY):this._tile._tileset._objectGroup.getObjectByName(r.ObjectGroupType.WIREFRAME);t.add(this.outlineMeshes),t.updateMatrixWorld(!0)}updateContentLength(){this._tile._content._geometryByteLength+=this._buffer.byteLength}processState(){this._state===r.TileContentProcessState.PENDING&&this.requestContent(),this._state===r.TileContentProcessState.LOADED&&this.parseContentBlock(),this._state===r.TileContentProcessState.PROCESSED&&this.createMesh(),this._state,r.TileContentProcessState.READY}update(){this.processState()}},function(){class e extends r.AbstractTile{constructor(e,t,i,r){super(e,t),this._loader=e._loader,this._header=i,this._contentFolder=r,this.matrix=new THREE.Matrix4,this.localIndexList=[],this.userIndexMap=new Map,this.isInstanceTile=!1,this.explodeCount=0,this.needUpdateFilter=!1,this._resource=void 0,this.loadedCount=0,this.loadedLineCount=0,this.loadedOutlineCount=0,this._fetchContentBlockBind=this.fetchContentBlock.bind(this),this._getTilesetContentCallbackBind=this._getTilesetContentCallback.bind(this),this.subBimTilesType=null}destroy(){super.destroy(),this.matrix=void 0,this._loader=void 0,this._header=void 0,this._contentFolder=void 0,this.localIndexList=void 0,this._resource&&(this._resource.destroy(),this._resource=void 0),this._fetchContentBlockBind=void 0,this._getTilesetContentCallbackBind=void 0}build(){this._parseTile(this._tileset,this,this._header,this._contentFolder)}_parseTile(e,t,i,a){if(t.boundingBox=r.TilesUtil.getBox(i.boundingVolume),i.refine?("replace"!==i.refine&&"add"!==i.refine||console.warn("lowercase-refine",'This tile uses a lowercase refine "'+i.refine+'". Instead use "'+i.refine.toUpperCase()+'".'),t.refineReplace="REPLACE"===i.refine.toUpperCase()):t.parent?t.refineReplace=t.parent.refineReplace:t.refineReplace=!0,t.geometricError=i.geometricError<r.TilesUtil.SIX_ACCURACY?t._parent?t._parent.geometricError:1/r.TilesUtil.Minimum_Setting_SSEHold:i.geometricError,i.geScale&&(t.geScale_instanceLeafTile=i.geScale),t.contentIndex=null,i.content?(t.contentId=i.content.id,t.contentUrl=i.content.uri||i.content.url,t.contentType=i.content.type,t.contentIndex=a+t.contentUrl,t.contentInsModel=r.Utils.isDefined(i.content.model)?i.content.model:null,t._contentInsModelIndex=r.Utils.isDefined(t.contentInsModel)?a+t.contentInsModel:null,t.contentType===r.TileContentType.DATA_INSTANCE&&(t.isInstanceTile=!0),void 0!==i.content.index&&(t.contentCMPTIndex=i.content.index),void 0!==i.content.offset&&(t.contentCMPTOffset=i.content.offset),void 0!==i.content.size&&(t.contentCMPTSize=i.content.size)):t.contentType=r.TileContentType.DATA_NULL,i.outline&&(t.contentOutlineId=i.outline,t.contentOutlineUrl=a+i.outline),r.Utils.isDefined(i.visibilityPriority)?t._visibilityPriority=i.visibilityPriority:r.Utils.isDefined(t.parent)&&(t._visibilityPriority=t.parent._visibilityPriority),t.detailLevel=r.Utils.isDefined(i.detailLevel)?i.detailLevel:4,t.contentTypeNull&&(t._content=t.createEmptyContent(),t._contentState=r.TileContentState.READY),t.contentTypeTile&&(t.isTilesetContent=!0),i.transform&&16===i.transform.length&&t.matrix.fromArray(i.transform),t._parent?t.matrix=t._parent.matrix.clone().multiply(t.matrix):t.matrix.identity(),t.boundingBox=r.TilesUtil.getBox(i.boundingVolume,t.matrix),t._parent&&t._parent.refineReplace?t._parent.contentTypeEmpty?t._debugLodLevel=t._parent._debugLodLevel:t._debugLodLevel=t._parent._debugLodLevel+1:t.refineReplace&&(t._debugLodLevel=0),i.properties&&i.properties.LocalIndex){i.properties.LocalIndex.map((e=>{const t={box:r.TilesUtil.getBox(e.boundingVolume),url:a+e.content.url};this.localIndexList.push(t),this._loader.addSearchTree(t.url,t.box)}))}if(i.properties&&i.properties.layerKey&&(this.layerInfo[i.properties.layerKey]&&console.warn("repeated Key"),this.layerInfo[i.properties.layerKey]=i.properties.layerValue),i.children)for(const r of i.children){const i=this._createNewTile(e,t,r,a);i.build(),i._generateNodeId()}}clone(e,t,i){return r.Utils.defined(i)||(i=this._createNewTile(e,t)),super.clone(i),i._loader=e._loader,i._header=this._header,i._contentFolder=this._contentFolder,i.matrix=this.matrix.clone(),i.localIndexList=this.localIndexInfo,i.userIndexMap=this.userIndexMap,i.isInstanceTile=this.isInstanceTile,i.isTilesetContent=this.isTilesetContent,i._id=this._id,i._tileset=e,i}fetchContentBlock(e,t,i){let a=e.length,n={};for(let s=0;s<a;++s){const o=r.RequestSpliter.splitByUrlMd5(e[s]);this.contentTypeCMPT?this._loader.loadCMPTArrayBufferImmediately(o,(function(i){a--,n[e[s]]=i,0===a&&t(n)}),(function(e){i(e)})):this._loader.loadArrayBufferImmediately(o,(function(i){a--,n[e[s]]=i,0===a&&t(n)}),(function(e){i(e)}))}}parseCMPTContentBlock(e,t){const i=this._loader.tileReader;this.arrayBufferNum=1;for(const a in e){const n={node:this,type:proto.bimtile_pbf.BlockHeader.BlockType.BT_MESH,url:this.getAbsoluteContentUrl()},s=r.RequestSpliter.splitByUrlMd5(a);let o=this._loader.CMPTUrlMap[s].buffer.slice(this.contentCMPTOffset,this.contentCMPTOffset+this.contentCMPTSize);i.parseBlock(o,n,(()=>{this.arrayBufferNum--,o=null,0===this.arrayBufferNum&&t(e)}))}}parseContentBlock(e,t){if("CMPT"===this.contentType)return this.parseCMPTContentBlock(e,t);const i=this._loader.tileReader;this.arrayBufferNum=Object.keys(e).length;for(const r in e){let a=i.getBlockType(this.contentType),n=this.getAbsoluteContentUrl();r!==n&&(a=proto.bimtile_pbf.BlockHeader.BlockType.BT_LINE,n=this.getOutlineContentUrl());const s={node:this,type:a,url:n};i.parseBlock(e[r],s,(()=>{this.arrayBufferNum--,0===this.arrayBufferNum&&t(e)}))}}parseLineContentBlock(e,t){const i=this._loader.tileReader,r={node:this,type:proto.bimtile_pbf.BlockHeader.BlockType.BT_LINE,url:this.getAbsoluteContentUrl()};i.parseBlock(e,r,(function(){t(e)}))}parseOutlineContentBlock(e,t){const i=this._loader.tileReader,r={node:this,outline:!0,type:proto.bimtile_pbf.BlockHeader.BlockType.BT_LINE,url:this.getOutlineContentUrl()};i.parseBlock(e,r,(function(){t(e)}))}createContent(e){return this.isTilesetContent?new r.TileTilesetContent(this,e):new r.BimTileContent(this,e)}getAbsoluteContentFolder(){return this._contentFolder}computeMeshNodeCount(e){this.loadedCount=0,this.loadedLineCount=0;for(let c in this.buffer){var t=this.getBuffer(c);if(t.type==proto.BlockHeader.BlockType.BT_MESH){var i=t.content;if(i)for(var r=i.getScenesList(),a=r.length,n=0;n<a;++n)for(var s=r[n].getNodesList(),o=s.length,l=0;l<o;++l){var d=s[l],h=i.getNodesList()[d];this.getNodeCount(h,i,e)}}}}getNodeCount(e,t,i){const r=e.getPrimitivesList();e.getPrimitivesList().length;var a=e.getNodeType();(!0===i&&a!=proto.bimtile_pbf.Node.NodeType.NT_BATCHED_SUB_NODE||!1===i&&a!=proto.bimtile_pbf.Node.NodeType.NT_BATCHED_MAIN_NODE)&&r.map((e=>{switch(t.getPrimitivesList()[e].getMode()){case proto.bimtile_pbf.Primitive.PrimitiveMode.PM_TRIANGLES:case proto.bimtile_pbf.Primitive.PrimitiveMode.PM_POINTS:this.loadedCount++;break;case proto.bimtile_pbf.Primitive.PrimitiveMode.PM_LINES:this.loadedLineCount++}}));var n=e.getChildrenList();if(0!==n.length)for(const e of n){var s=t.getNodesList()[e];this.getNodeCount(s,t,i)}}computePointNodeCount(){this.loadedCount=0;for(let r in this.buffer){var e=this.getBuffer(r);if(e.type==proto.BlockHeader.BlockType.BT_POINT){var t=e.content;if(t){var i=t.getPointsList();this.loadedCount=i.length}}}}computeLineNodeCount(){this.loadedLineCount=0;for(let e in this.lineBuffer){const t=this.getLineBuffer(e);if(t.type!=proto.BlockHeader.BlockType.BT_LINE)continue;const i=t.content;if(!i)continue;const r=i.getScenesList();for(let e=0,t=r.length;e<t;++e){const t=r[e].getNodesList();this.loadedLineCount+=t.length}}}computeOutlineNodeCount(){this.loadedOutlineCount=0;for(let e in this.outlineBuffer){const t=this.getOutlineBuffer(e);if(t.type!=proto.BlockHeader.BlockType.BT_LINE)continue;const i=t.content;if(!i)continue;const r=i.getScenesList();for(let e=0,t=r.length;e<t;++e){const t=r[e].getNodesList();this.loadedOutlineCount+=t.length}}}_clearAllBuffer(){this._clearMeshBuffer(),this._clearLineBuffer(),this._clearOutlineBuffer()}_clearBufferData(e){for(let t in e)e[t].content&&(e[t].content=null),e[t]=null}_clearMeshBuffer(){this.buffer&&(this._clearBufferData(this.buffer),this.buffer=null)}_clearLineBuffer(){this.lineBuffer&&(this._clearBufferData(this.lineBuffer),this.lineBuffer=null)}_clearOutlineBuffer(){this.outlineBuffer&&(this._clearBufferData(this.outlineBuffer),this.outlineBuffer=null)}getBuffer(e){return this.buffer[e]}getLineBuffer(e){return this.lineBuffer[e]}getOutlineBuffer(e){return this.outlineBuffer[e]}disposeMeshNodeById(e){this._loader.disposeMeshNodeById(e)}disposeInstanceMeshNodeById(e){this._loader.disposeInstanceMeshNodeById(e)}disposeLineNodeById(e){this._loader.disposeLineNodeById(e)}disposeInstanceLineNodeById(e){this._loader.disposeInstanceLineNodeById(e)}onSelectionChanged(){const e=this._loader.tileReader,t=this._loader.filter.model.id,i=this._loader.sceneState.selectionSet[t];if(this.selection={},void 0===i||0===Object.keys(i).length)return!1;for(const t of this.userIndexMap.keys()){const r=e.getUserIdByIndex(t);i[r]&&(this.selection[r]=!0)}if(Object.keys(this.selection).length===Object.keys(this.preSelection).length){for(const e in this.selection)if(!this.preSelection[e])return this.preSelection=Object.assign(this.selection),!0;return!1}return this.preSelection=Object.assign(this.selection),!0}applyGlowEffect(){if(this.stateChangedRenderer!==r.EnumChangedState.NONE)return;const e=this._loader.filter.model,t=e.viewer.rendererManager.renderer.composer;t&&t.applyGlowEffectByModel(e,this)}applyFilter(){if(this._loader.disableUserData)return;const e=this._loader.filter;this.stateChangedRenderer===r.EnumChangedState.NONE&&(this.stateChangedRenderer=r.EnumChangedState.START,e.enableTileLoadedStateChanged()),this.isInstanceTile?(e.instanceApply(this),e.wireFrameInstanceApply(this)):(e.standardApply(this),e.wireFrameStandardApply(this)),e.applyTileMeshForFlatten(this)}applySelection(){if(this._loader.disableUserData)return;const e=this._loader.filter.model.pickingManager;e.selectionChangedRenderer!==r.EnumChangedState.NONE&&(e.selectionChangedRenderer!==this.selectionChangedRenderer&&e.updatePickingMeshes(this),e.selectionChangedRenderer!==this.selectionWireFrameChangedRenderer&&e.updatePickingWireFrame(this))}applyOnDemand(){if(!this.isInstanceTile)return;const e=this._tileset.onDemandManager;!1!==e.onDemand&&e.instanceApply(this)}explode(){if(this.isOutlineLoading())return;const e=this._loader.modelExplosion;this.isInstanceTile?e.instanceExplode(this):e.standardExplode(this)}_generateNodeId(e){let t=e;if(!r.Utils.defined(t)){const e=this._header.content;if(r.Utils.defined(e)){const i=e.uri||e.url;t=`${this._contentFolder}_${i}`,this.contentCMPTIndex&&(t+=`_${this.contentCMPTIndex}`)}else t=`${this._contentFolder}_root`}return this._id=r.Utils.getEncodedString(t),this._id}setByteLength(e){r.Utils.defined(this._tileset)&&this._tileset.geometryManager.setByteLength(this.nodeId,e)}sharedGeometryDestroy(){const e=this._tileset.geometryManager;if(!r.Utils.defined(e))return!1;const t=e.getGeometry(this._id);return!!r.Utils.defined(t)&&t.state===r.SharedGeometryState.DESTROYED}_setSharedGeometryProcressingState(){if(this.contentTypeTile)return;const e=this._tileset.geometryManager;if(r.Utils.defined(e)){e.addGeometryById(this.nodeId).state=r.SharedGeometryState.PROCESSING}}requestContent(){if(this._requestContentIfCloned())return!0;if(this._requestContentIfShared())return!0;const e=this._requestContent();return e&&this._setSharedGeometryProcressingState(),e}_requestContentIfCloned(){return!!(this.contentTypeTile&&this.childrenUnload&&this._tileset.cloneChildrenOfTile(this))}_requestContentIfShared(){if(this.contentTypeTile)return!1;const e=this._tileset.geometryManager;if(r.Utils.defined(e)){const t=e.getGeometry(this._id);if(r.Utils.defined(t)){if(t.state===r.SharedGeometryState.PROCESSING)return!1;if(t.state===r.SharedGeometryState.PROCESSED)return this._content=this.createContent(),this._content.geometryByteLength=t.byteLength,this._contentProcessDeferred=new r.Deferred,this._contentReadyDeferred=new r.Deferred,e.createMesh(t,this,this._tileset._loader),this._contentState=r.TileContentState.READY,this._contentReadyDeferred.resolve(this._content),this._content._state=r.TileContentProcessState.PROCESSED,this._content.attachToTilesGroup(this),!0}}return!1}_requestContent(){const e=new r.Request({throttle:!0,type:this._tileset.type,priorityCallback:this._createPriorityCallback(this)});this._request=e;const t=this._getResource();t._request=e;const i=t.fetch({fetchCallback:this._getContentBlockCallback()});if(!i)return!1;const a=this._contentState;this._contentState=r.TileContentState.LOADING,this._contentProcessDeferred=new r.Deferred,this._contentReadyDeferred=new r.Deferred;const n=this._handleFailedContent(this,this._tileset),s=this;return i.then((function(e){if(!s.isDestroyed())return s._content=s.createContent(e),s._contentState=r.TileContentState.PROCESSING,s._contentProcessDeferred.resolve(s._content),s._content.readyPromise.then((function(e){s._contentState=r.TileContentState.READY,s._contentReadyDeferred.resolve(e)}));n()})).catch((function(t){if(e.state===r.RequestState.CANCELLED)return s._contentState=a,--s._tileset.statistics.numberOfPendingRequests,++s._tileset.statistics.numberOfAttemptedRequests,void s._cancelSharedGeometryRequest();n(t)})),!0}_getResource(){const e=this._resource;if(e)return e;const t=this.getAbsoluteContentUrl();return r.Resource.create({url:this.isTilesetContent?t:[t]})}_getContentBlockCallback(){return this.isTilesetContent?this._getTilesetContentCallbackBind:this._fetchContentBlockBind}_getTilesetContentCallback(e,t,i){this._loader.loadJson(e,void 0,t)}_cancelSharedGeometryRequest(){const e=this._tileset.geometryManager;r.Utils.defined(e)&&e.setShareGeometryState(this.nodeId,r.SharedGeometryState.CANCELED)}checkIfProcessingTileAvailable(){return!this.isDestroyed()&&(!!this.content&&(!!this.contentProcessing||(this.unloadContent(),!1)))}checkIfTileAvailable(){return!this.isDestroyed()&&!(!this.content||!this.contentAvailable)}_createNewTile(e,t,i,a){return new r.BimTileNode(e,t,i,a)}isOutlineActivated(){return!!this.getOutlineContentUrl()&&this._tileset.isOutlineEnabled()}get needsLoading(){return!this.contentReady||this.isOutlineLoading()}isOutlineLoading(){return!!this.isOutlineActivated()&&!this._content.isOutlineContentReady()}createEmptyContent(){return new r.TileEmptyContent(this)}}r.BimTileNode=e}(),r.BimTileMeshParser=class{constructor(e){this.materialManager=e.materialManager,this.batchMergeEnabled=e.batchMergeEnabled,this.delayLoadTexture=e.delayLoadTexture,this.renderFunction=e.renderFunction}destroy(){this.materialManager=null,this.renderFunction=null}loadMesh(e,t){}_getAccInfo(e,t){if(t<0)return{offset:0,length:0,count:0};const i=e.getBufferaccsList()[t];return{offset:i.getByteOffset(),length:i.getByteLength(),count:i.getCount(),valueType:i.getValueType()}}_getAccColorArray(e,t,i,r){const a=e._getAccInfo(t,r.getAccColor()),n=i.slice(a.offset,a.offset+a.length).buffer;return new Uint8Array(n)}_getAccVertexArray(e,t,i,r){const a=e._getAccInfo(t,r.getAccVertices()),n=i.slice(a.offset,a.offset+a.length).buffer;return new Float32Array(n)}_getAccIndicesArray(e,t,i,r){const a=e._getAccInfo(t,r.getAccIndices()),n=i.slice(a.offset,a.offset+a.length).buffer;let s=null;return s=a.valueType===proto.bimtile_pbf.BufferAcc.ComponentType.CT_USHORT?new Uint16Array(n):new Uint32Array(n),s}_getMeshBuffer(e,t,i){var r=i.meshBlob.getBlobHeader(),a=r.getBufferBlockId(),n=r.getMaterialBlockId(),s=(r.getUserdataBlockId(),e.tileReader.getBuffer(t,a,proto.BlockHeader.BlockType.BT_BUFFER)),o=e.tileReader.getBuffer(t,n,proto.BlockHeader.BlockType.BT_MATERIAL);i.buffer=s,i.materialBlockId=n,i.material=o,s&&(i.bufferData=s.getBuffer())}createMeshNode(e,t,i,a,n,s,o){if(!this.checkIfTileAvailable(a))return void this._deleteNodeBuffer(t,a);let l=null;l=i.mode===proto.bimtile_pbf.Primitive.PrimitiveMode.PM_LINES?new r.LineSegmentsEx(n,[s]):new r.MeshEx(n,[s]),i.indexInfos||(i.indexInfos=new Map),l.applyMatrix4(i.matrix),l.name=i.nodeIndexId;var d=e.filter.model;r.GlobalData.EnableShadowMap&&(l.castShadow=d.castShadow,l.receiveShadow=d.receiveShadow),l.indexGroups=i.indexInfos,l.indexCount=n.index.count;for(const e of l.indexGroups.keys())a.userIndexMap.set(e,!0);e.addMeshIdMap(l.name,l),a.content.meshes.add(l),l.databagId=a.content.meshes.databagId,l.fileId=a.content.meshes.fileId,i.userIdMapIndex&&e.addUserIdMapIndices(i.userIdMapIndex,l.name),e.renderableCount++;const h={id:a.nodeId,bufferGeometry:n,material:s,pbfNodeInfo:i,node:a};return a._tileset.geometryManager.addGeometryById(a.nodeId,h),this.decreaseLoadedCount(a),this.checkIfTileParseFinish(a)&&(o&&o(a),this.delayLoadTexture||this._deleteNodeBuffer(t,a)),l}createMeshMaterial(e){this.delayLoadTexture?this.createMeshTextureDelay(e):this.createMeshTextureImmediately(e)}createMeshTextureDelay(e){let{that:t,loader:i,meshBufferObject:r,pbfNodeInfo:a,treeNode:n,primitive:s,bufferGeometry:o,onTileContentReadyCallback:l,callback:d}=e,h=t.createMeshNode(i,r,a,n,o,this.materialManager.globalMaterial,l);d&&d(),h&&new Promise((e=>{t.materialManager.getMaterial(i,r,s,(t=>{e(t)}))})).then((e=>{void 0!==h.material&&(h.material[0]=e,n._tileset.updateTextureMemoryUsage(n),t.renderFunction())}))}createMeshTextureImmediately(e){let{that:t,loader:i,meshBufferObject:r,pbfNodeInfo:a,treeNode:n,primitive:s,bufferGeometry:o,onTileContentReadyCallback:l,callback:d}=e;new Promise((e=>{t.materialManager.getMaterial(i,r,s,(t=>{e(t)}))})).then((e=>{t.createMeshNode(i,r,a,n,o,e,l),d&&d()}))}_deleteNodeBuffer(e,t){e.materialBlockId=void 0,e.contentIndex=void 0,e.bufferId=void 0,e.material=null,e.bufferData=null,e.buffer=null,e.meshBlob=null,e.matrix=null;var i=this.getFullBuffer(t);for(const e in i)i[e].content=null}getFullBuffer(e){return e.buffer}checkIfTileAvailable(e){return e.checkIfProcessingTileAvailable()}decreaseLoadedCount(e){e.loadedCount--}checkIfTileParseFinish(e){return e.loadedCount<=0&&e.loadedLineCount<=0&&e.loadedOutlineCount<=0}getLoadedCount(e){return e.loadedCount}},function(){class e extends r.BimTileMeshParser{constructor(e){super(e)}_getSubNodeInfo(e,t,i,r,a,n){const s=a.nodeIndex,o=`${r.bufferId}_${s}`;if(a.nodeIndexId=o,i.clearGroups(),i.groups.push({start:0,count:a.iAccInfoCount,materialIndex:0}),t.pbfNodeInfoMap[o]){let e=t.pbfNodeInfoMap[o];return e.userIdMapIndex=[],e}const l=r.meshBlob.getNodesList()[s],d=l.getChildrenList(),h=r.meshBlob;let c=new Map;if(a.userIdMapIndex=[],r.primitiveMaterialId=n.getMaterialId(),d.map(((i,n)=>{const s=h.getNodesList()[i],o=s.getPrimitivesList(),l=o.length;for(let d=0;d<l;d++){const l=o[d],u=h.getPrimitivesList()[l],p=e._addNodeInfo(e,t,h,r,s,u,a,i,n);!1===c.has(p.userId)&&c.set(p.userId,new Map),c.get(p.userId).set(p.meshId,p.subIndexInfo)}})),0===c.size){const i=e._addNodeInfo(e,t,h,r,l,n,a,s,0);c.set(i.userId,new Map),c.get(i.userId).set(i.meshId,i.subIndexInfo)}return a.indexInfos=c,t.pbfNodeInfoMap[o]=a,a}_createIndexGroup(e){return{start:e.indexStart,count:e.indexCount,materialIndex:0,userId:e.userId}}_addNodeInfo(e,t,i,a,n,s,o,l,d){const h=o.nodeIndexId,c=this._getAccInfo(i,s.getAccVertices()),u=this._getAccInfo(i,s.getAccIndices()),p=this._getAccInfo(i,s.getAccTexcoords()),m=`${a.bufferId}_${l}`,f=n.getUserId(),g=(c.offset-o.vAccInfoStart)/4,v=3*c.count;let y=0;if(u.valueType===proto.bimtile_pbf.BufferAcc.ComponentType.CT_USHORT)y=(u.offset-o.iAccInfoStart)/2;else y=(u.offset-o.iAccInfoStart)/4;const M=u.count,E=(p.offset-o.tAccInfoStart)/4,b=2*p.count,I=s.getAccColor(),x=this._getAccInfo(i,I),T=(x.offset-o.cAccInfoStart)/4,_=x.count;let S,C;const w=this._getAccInfo(i,s.getAccNormals());w.valueType===proto.bimtile_pbf.BufferAcc.ComponentType.CT_UBYTE&&(S=(w.offset-o.nAccInfoStart)/2,C=w.count);let R={userId:f,meshId:m,subIndexInfo:{positionStart:g,positionCount:v,indexStart:y,indexCount:M,uvStart:E,uvCount:b,colorStart:T,colorCount:_,cNormalStart:S,cNormalCount:C,preTranslation:void 0}};o.userIdMapIndex.push({userId:f,index:d});const B=r.BimTileMaterialManager.generateMaterialName(a,a.primitiveMaterialId,!1),L={parent:h,matrix:o.matrix,materialId:B,type:proto.bimtile_pbf.Node.NodeType.NT_BATCHED_SUB_NODE,cellId:null};return t.disableUserData?(t.addNoUserDataMeshNodeInfo(f,m,L),R):(t.patchMeshNodeInfo(f,m,L),R)}loadMesh(e,i){let{that:r,loader:a,meshBufferObject:n,pbfNodeInfo:s,primitive:o,treeNode:l,onTileContentReadyCallback:d}=e;if((o.getAccVertices()<0||o.getAccIndices()<0)&&o.getAccArchive()<0)return void console.warn("invalid acc info");if(r._getMeshBuffer(a,l,n),!n.buffer)return;let h=new THREE.BufferGeometry;const c=n.meshBlob,u=n.bufferData;this._createNormalBuffer(s,h,u,c,o);const p=r._getAccInfo(c,o.getAccVertices()),m=r._getAccVertexArray(r,c,u,o);h.setAttribute("position",new THREE.BufferAttribute(m,3)),s.vAccInfoStart=p.offset;const f=r._getAccInfo(c,o.getAccIndices()),g=r._getAccIndicesArray(r,c,u,o);h.setIndex(new THREE.BufferAttribute(g,1)),s.iAccInfoStart=f.offset,s.iAccInfoCount=f.count,s.tAccInfoStart=0,o.useCompressedUv=!1;t(r._getAccInfo(c,o.getAccTexcoords()),u,o,n,h,s,1);t(r._getAccInfo(c,o.getAccTexcoords2()),u,o,n,h,s,2),this._createColorBuffer(s,h,u,c,o),s=Object.assign(r._getSubNodeInfo(r,a,h,n,s,o)),h.getAttribute("uv2")?o.hasLightMap=!0:o.hasLightMap=!1;const v={that:r,loader:a,meshBufferObject:n,pbfNodeInfo:s,treeNode:l,primitive:o,bufferGeometry:h,onTileContentReadyCallback:d,callback:i};r.createMeshMaterial(v)}_createNormalBuffer(e,t,i,r,a){a.useCompressedNormal=!1;const n=this._getAccInfo(r,a.getAccNormals());if(n.count>0){let r;const s=i.slice(n.offset,n.offset+n.length).buffer;switch(n.valueType){case proto.bimtile_pbf.BufferAcc.ComponentType.CT_UBYTE:r=new Uint8Array(s),t.setAttribute("cNormal",new THREE.BufferAttribute(r,2)),e.nAccInfoStart=n.offset,e.nAccInfoCount=n.count,a.useCompressedNormal=!0;break;case proto.bimtile_pbf.BufferAcc.ComponentType.CT_FLOAT:r=new Float32Array(s),t.setAttribute("normal",new THREE.BufferAttribute(r,3)),e.nAccInfoStart=n.offset,e.nAccInfoCount=n.count,a.useCompressedNormal=!1}}}_createColorBuffer(e,t,i,r,a){const n=a.getAccColor(),s=this._getAccInfo(r,n);if(s.count<=0||n<=0)return a.vertexColors=!1,!1;const o=this._getAccColorArray(this,r,i,a);let l=s.length/s.count,d=new THREE.Uint8BufferAttribute(o,l);return d.normalized=!0,t.setAttribute("color",d),e.cAccInfoStart=s.offset,e.cAccInfoCount=s.count,a.vertexColors=!0,!0}}function t(e,t,i,r,a,n,s){if(e.count<=0)return;const o=t.slice(e.offset,e.offset+e.length).buffer;let l=null;e.valueType==proto.bimtile_pbf.BufferAcc.ComponentType.CT_SHORT?(i.useCompressedUv=!0,l=new Int16Array(o)):(i.useCompressedUv=!1,l=new Float32Array(o));const d=1===s?"uv":`uv${s}`;a.setAttribute(d,new THREE.BufferAttribute(l,2)),n.tAccInfoStart=e.offset}r.BimTileMeshNodeParser=e}(),function(){class e extends r.BimTileMeshParser{constructor(e){super(e)}destroy(){super.destroy()}loadMesh(e,t){let{that:i,loader:a,meshBufferObject:n,pbfNodeInfo:s,primitive:o,treeNode:l,onTileContentReadyCallback:d}=e;if((o.getAccVertices()<0||o.getAccIndices()<0)&&o.getAccArchive()<0)return void console.warn("invalid acc info");if(i._getMeshBuffer(a,l,n),!n.buffer)return;const h=n.meshBlob,c=n.bufferData,u=n.material,p=h.getBufferaccsList()[o.getAccArchive()];if(!r.Utils.isDefined(p))return;const m=p.getByteOffset(),f=p.getByteLength(),g=(p.getCount(),c.slice(m,m+f).buffer);r.TilesUtil.getDracoLoader().decodeDracoFile(g,(function(e){if(!(u&&o.getMaterialId()>=-1))return;e.clearGroups(),e.groups.push({start:0,count:e.index.count,materialIndex:0});const r={that:i,loader:a,meshBufferObject:n,pbfNodeInfo:s,treeNode:l,primitive:o,bufferGeometry:e,onTileContentReadyCallback:d,callback:t};i.createMeshMaterial(r)}))}}r.BimTileDracoParser=e}(),function(){let e=new THREE.Matrix4;class t extends r.BimTileMeshNodeParser{constructor(e){super(e)}loadMesh(e,t){let{that:i,loader:r,meshBufferObject:a,pbfNodeInfo:n,primitive:s,treeNode:o,onTileContentReadyCallback:l}=e;if((s.getAccVertices()<0||s.getAccIndices()<0)&&s.getAccArchive()<0)return void console.warn("invalid acc info");if(i._getMeshBuffer(r,o,a),!a.buffer)return;if(!i.checkIfTileAvailable(o))return void i._deleteNodeBuffer(a,o);let d=i._createBatchGeometry(i,r,a,n,s);if(!(a.material&&s.getMaterialId()>=-1))return;const h=i.materialManager.getLineMaterial(r,a,s);i.createMeshNode(r,a,n,o,d,h,l),t&&t()}loadLineInstanceMesh(e,t){let{that:i,loader:a,meshBufferObject:n,pbfNodeInfo:s,primitive:o,treeNode:l,onTileContentReadyCallback:d}=e;if(!i.checkIfTileAvailable(l))return void i._deleteNodeBuffer(n,l);let h=new THREE.InstancedBufferGeometry;const c=n.meshBlob,u=n.bufferData,p=i._getAccVertexArray(i,c,u,o),m=i._getAccIndicesArray(i,c,u,o);h.setAttribute("position",new THREE.BufferAttribute(p,3)),h.setIndex(new THREE.BufferAttribute(m,1));let f=new r.LineSegmentsEx(h,i.instanceWireframeMaterial);f.name=s.nodeIndexId,f.tileId=s.tileId,f.frustumCulled=!1,h.addGroup(0,h.index.count,0),l.wireFrameVisibilityOption=a.wireFrameVisibilityOption,f.isInstanceMeshNode=!0;const g=this.getContentMeshGroup(l);f.visible=a.isBorderLineVisible(),f.renderOrder=r.EnumRenderOrder.WireFrame,a.disableUserData&&(f.visible=!1),g.add(f),f.databagId=g.databagId,f.fileId=g.fileId,i.setInstanceLineAttributeBuffer(a,l,f),i.decreaseLoadedCount(l),this.checkIfTileParseFinish(l)&&(g.updateMatrixWorld(!0),d&&d(l),i._deleteNodeBuffer(n,l))}setInstanceLineAttributeBuffer(t,i,a){const n=t.getInstanceMeshNodeById(i.nodeIndexId),s=Object.keys(n);if(s.length<1)return void console.log("no instance mesh!");const o=i.instanceInfo.entityInfoArray;let l=a.geometry;const d=n[s[0]],h=d.mesh.matrixRoot,c=d.matrix,u=function(e){const t=r.MaterialUtil.DefaultWireframeColor,i=[];for(let r=0;r<e;++r)i.push(t.color.r,t.color.g,t.color.b,t.opacity);return new THREE.InstancedBufferAttribute(new Float32Array(i),4,!1,1)}(o.length);l.setAttribute("aColor",u);const p=function(t,i){const r={column0:[],column1:[],column2:[],column3:[]};for(let a=0;a<t.length;++a){let n=e.copy(t[a].entityMatrix);i&&(n=n.multiply(i));const s=n.elements;r.column0.push(s[0],s[1],s[2]),r.column1.push(s[4],s[5],s[6]),r.column2.push(s[8],s[9],s[10]),r.column3.push(s[12],s[13],s[14])}const a=[];for(let e=0;e<4;++e){const t=r["column"+e.toString()],i=new THREE.InstancedBufferAttribute(new Float32Array(t),3,!1,1);a.push(i)}return a}(o,h);for(let e=0;e<p.length;++e)l.setAttribute("mcol"+e.toString(),p[e]);const m=function(e,t){const i=e.length,a=new Array(i),n=(e[0].userData,e[0].userID);return r.TilesUtil.matchWireFrameVisibilityOption(n,t.wireFrameVisibilityOption)?a.fill(r.EnumInstanceState.NONE):a.fill(r.EnumInstanceState.HIDDEN),new THREE.InstancedBufferAttribute(new Float32Array(a),1,!1,1)}(o,i);l.setAttribute("vState",m);const f=t.filter.model.localClippingMode?r.EnumInstanceState.CLIPPING:r.EnumInstanceState.NONE,g=function(e,t){const i=new Array(e);return i.fill(t),new THREE.InstancedBufferAttribute(new Float32Array(i),1,!1,1)}(o.length,f);l.setAttribute("vClipping",g),a.applyMatrix4(c),t.addInstanceLineNodeById(a.tileId,a)}loadLineMesh(e,t){let{that:i,loader:a,meshBufferObject:n,pbfNodeInfo:s,primitive:o,treeNode:l,onTileContentReadyCallback:d}=e;if(!i.checkIfTileAvailable(l))return void i._deleteNodeBuffer(n,l);let h=i._createBatchGeometry(i,a,n,s,o),c=new r.LineSegmentsEx(h,[i.wireframeMaterial]);c.applyMatrix4(s.matrix),c.name=s.nodeIndexId,c.tileId=s.tileId,c.indexGroups=s.indexInfos,a.addLineNodeById(c.tileId,s.nodeIndexId,c),s.userIdMapIndex&&a.addUserIdMapIndices(s.userIdMapIndex,c.name);const u=this.getContentMeshGroup(l);a.dealLineMeshVisible(c),u.add(c),c.databagId=u.databagId,c.fileId=u.fileId,c.renderOrder=r.EnumRenderOrder.WireFrame,i.decreaseLoadedCount(l),this.checkIfTileParseFinish(l)&&(u.updateMatrixWorld(!0),d&&d(l),i._deleteNodeBuffer(n,l))}_deleteNodeBuffer(e,t){e.bufferData=null,e.bufferBlob=null,e.blobHeader=null,e.meshBlob=null,e.buffer=null;var i=this.getFullBuffer(t);for(var r in i)i[r].content=null}_createBatchGeometry(e,t,i,r,a){let n=new THREE.BufferGeometry;const s=i.meshBlob,o=i.bufferData,l=e._getAccVertexArray(e,s,o,a),d=e._getAccIndicesArray(e,s,o,a),h=e._getAccInfo(s,a.getAccIndices()),c=e._getAccInfo(s,a.getAccVertices());return r.vAccInfoStart=c.offset,r.iAccInfoStart=h.offset,r.iAccInfoCount=h.count,r=Object.assign(r,e._getSubNodeInfo(e,t,n,i,r,a)),n.setAttribute("position",new THREE.BufferAttribute(l,3)),n.setIndex(new THREE.BufferAttribute(d,1)),e._createColorBuffer(r,n,o,s,a),n}loadLineGeometryBuffer(e,t,i,r,a,n,s,o){if(!e.checkIfTileAvailable(n))return void e._deleteNodeBuffer(i,n);const l=e._createBatchGeometry(e,t,i,r,a);n.geometry=l,n.indexGroups=r.indexInfos,n.matrix.copy(r.matrix),e._deleteNodeBuffer(i,n),s&&s()}getContentMeshGroup(e){return e.content.meshes}getFullBuffer(e){return e.lineBuffer}checkIfTileAvailable(e){return e.checkIfProcessingTileAvailable()}decreaseLoadedCount(e){e.loadedLineCount--}getLoadedCount(e){return e.loadedLineCount}}r.BimTileLineParser=t}(),function(){class e extends r.BimTileLineParser{constructor(e){super(e),this.defaultWireframeColor=r.MaterialUtil.DefaultWireframeColor,this.wireframeMaterial=new r.MeshBasicClipMaterial(this.defaultWireframeColor),this.wireframeMaterial.transparent=!0,this.instanceWireframeMaterial=r.MaterialUtil.createInstanceMaterial(r.MaterialUtil.getMaterialParameters(this.wireframeMaterial)),this.instanceWireframeMaterial.transparent=!0}destroy(){this.defaultWireframeColor=void 0,this.wireframeMaterial=void 0,this.instanceWireframeMaterial=void 0,super.destroy()}getContentMeshGroup(e){return e._content._outlineContent.outlineMeshes}getFullBuffer(e){return e.outlineBuffer}checkIfTileAvailable(e){return e.checkIfTileAvailable()}decreaseLoadedCount(e){e.loadedOutlineCount--}getLoadedCount(e){return e.loadedOutlineCount}setWireframeColor(e,t){this.wireframeMaterial.color=e,this.wireframeMaterial.opacity=t,this.wireframeMaterial.transparent=1!=t,this.instanceWireframeMaterial.color=e,this.instanceWireframeMaterial.opacity=t,this.instanceWireframeMaterial.transparent=1!=t}getWireframeColor(){let e=this.wireframeMaterial.color.clone();return e.opacity=this.wireframeMaterial.opacity,e}restoreWireframeColor(){const e=this.defaultWireframeColor;this.setWireframeColor(e.color,e.opacity)}}r.BimTileOutlineParser=e}(),r.BimTileBatchBlobParser=class{constructor(e){this.options=Object.assign({},e),this.taskRunner=new r.TaskRunner,this.blockType=null}destroy(){this.taskRunner=null,this.blockType=null,this.options=null}parseBlobs(e,t,i){this.computeNodeCount(t,e.batchMergeEnabled);const r=this.blockType,a=this.getFullBuffer(t);for(let o in a){if(null===this.getFullBuffer(t))return;var n=this.getBufferByIdx(t,o);if(n.type==r){var s=n.content;s&&this.parseBlob(e,s,t,o,i)}}}parseBlob(e,t,i,a,n){if(!t)return;let s={};s.contentIndex=this.getContentIndex(i),s.meshBlob=t;const o=t.getScenesList(),l=o.length;if(0===l)return;const d=t.getBlobHeader(),h=d.getBufferBlockId(),c=this.getBufferBlock(e,i,h);if(!c)return;const u=c.getBuffer();s.buffer=c,s.bufferData=u;const p=this.getTileId(i,d),m=t.getNodesList();s.bufferId=`${p}_${a}`;for(let t=0;t<l;++t){const l=o[t].getNodesList(),d=l.length;for(let t=0;t<d;++t){const o=m[l[t]];let d={};d.tileId=p,d.nodeIndex=l[t],d.nodeIndexId=`${i.contentId}_${a}`,d.lineTileId=`${p}_${d.nodeIndex}`;let h=new THREE.Matrix4;if(16==o.getMatrixList().length){h.fromArray(o.getMatrixList());let e=o.getTranslationList();r.Utils.isDefined(e)&&3===e.length&&h.setPosition(e[0],e[1],e[2])}d.matrix=h.multiply(i.matrix),this.parseNode(e,s,o,d,i,n)}}}parseNode(e,t,i,r,a,n){const s=t.meshBlob,o=i.getPrimitivesList(),l=o.length,d=i.getNodeType(),h=i.getBboxList();let c=new THREE.Vector2(0,0),u=new THREE.Vector2(0,0);if(h.length>=10&&(c.x=(h[6]+h[7])/2,c.y=(h[8]+h[9])/2,u.x=(h[7]-h[6])/2,u.y=(h[9]-h[8])/2),d!=proto.bimtile_pbf.Node.NodeType.NT_BATCHED_SUB_NODE)for(let i=0;i<l;i++){const l=o[i],d=s.getPrimitivesList()[l];d.uvCenter=c,d.uvHalfExtent=u;let h=this.chooseParser(d,d.getMode());const p=this.getLoadCallback(a,h);r.mode=d.getMode();const m={that:h,loader:e,meshBufferObject:t,pbfNodeInfo:r,primitive:d,treeNode:a,onTileContentReadyCallback:n};this.taskRunner.runTask(p,m,(function(){}))}}getLoadCallback(e,t){}chooseParser(e,t){}getBufferBlock(e,t,i){}getTileId(e){}getContentIndex(e){return e.contentIndex}isBufferDeleted(e){}computeNodeCount(e){}getFullBuffer(e){}getBufferByIdx(e,t){}},function(){class e extends r.BimTileBatchBlobParser{constructor(e){super(e),this.blockType=proto.BlockHeader.BlockType.BT_MESH}destroy(){super.destroy(),this.bimtileMeshNodeParser&&this.bimtileMeshNodeParser.destroy(),this.bimtileMeshNodeParser=void 0,this.bimtileDracoParser&&this.bimtileDracoParser.destroy(),this.bimtileDracoParser=void 0,this.bimtileLineParser&&this.bimtileLineParser.destroy(),this.bimtileLineParser=void 0,this.bimtilePointParser&&this.bimtilePointParser.destroy(),this.bimtilePointParser=void 0}getLoadCallback(e,t){return t.loadMesh}chooseParser(e,t){switch(t){case proto.bimtile_pbf.Primitive.PrimitiveMode.PM_TRIANGLES:return e.getAccArchive()>=0?this.getDracoParser():this.getMeshParser();case proto.bimtile_pbf.Primitive.PrimitiveMode.PM_LINES:return this.getLineParser();case proto.bimtile_pbf.Primitive.PrimitiveMode.PM_POINTS:return this.getPointParser()}}getBufferBlock(e,t,i){return e.tileReader.getBuffer(t,i,proto.BlockHeader.BlockType.BT_BUFFER)}getContentIndex(e){return e.contentIndex}getTileId(e,t){return t.getTileId()}getDracoParser(){return this.bimtileDracoParser||(this.bimtileDracoParser=new r.BimTileDracoParser(this.options)),this.bimtileDracoParser}getMeshParser(){return this.bimtileMeshNodeParser||(this.bimtileMeshNodeParser=new r.BimTileMeshNodeParser(this.options)),this.bimtileMeshNodeParser}getLineParser(){return this.bimtileLineParser||(this.bimtileLineParser=new r.BimTileLineParser(this.options)),this.bimtileLineParser}getPointParser(){return this.bimtilePointParser||(this.bimtilePointParser=new r.BimTilePointParser(this.options)),this.bimtilePointParser}computeNodeCount(e,t){e.computeMeshNodeCount(t)}getFullBuffer(e){return e.buffer}getBufferByIdx(e,t){return e.getBuffer(t)}}r.BimTileMeshBlobParser=e}(),function(){class e extends r.BimTileBatchBlobParser{constructor(e){super(e),this.blockType=proto.BlockHeader.BlockType.BT_LINE}destroy(){this.bimtileLineParser&&this.bimtileLineParser.destroy(),super.destroy()}getLoadCallback(e,t){return e.contentTypeBufferOnly?t.loadLineGeometryBuffer:!0===e.contentTypeInstance?t.loadLineInstanceMesh:t.loadLineMesh}chooseParser(){return this.getLineParser()}getTileId(e){return`line_${e.contentId}`}getBufferBlock(e,t,i){return e.tileReader.getLineBuffer(t,i,proto.BlockHeader.BlockType.BT_BUFFER)}getContentIndex(e){return e.contentIndex}computeNodeCount(e){e.computeLineNodeCount()}getFullBuffer(e){return e.lineBuffer}getBufferByIdx(e,t){return e.getLineBuffer(t)}}r.BimTileLineBlobParser=e}(),function(){class e extends r.BimTileBatchBlobParser{constructor(e){super(e),this.blockType=proto.BlockHeader.BlockType.BT_POINT}destroy(){this.bimTilePointParser&&this.bimTilePointParser.destroy(),super.destroy()}parseBlob(e,t,i,r,a){if(!t)return;var n={};if(n.pointBlob=t,0===t.getPointsList().length)return;var s=t.getBlobHeader();(s.getTranslationList().length>0||s.getMatrixList().length>0)&&console.log("Translation"),n.blobHeader=s;var o=s.getBufferBlockId(),l=this.getBufferBlock(e,i,o);if(n.bufferBlob=l,!l)return;var d=l.getBuffer();n.bufferData=d;var h=l.getBlobHeader(),c=h.getBufferTypeList(),u=h.getBufferSizeList(),p=h.getBufferOffsetList(),m=p.length;this.setLoadedCount(i,m);for(var f=0;f<m;++f){var g=p[f],v=u[f],y=d.slice(g,g+v).buffer;switch(c[f]){case proto.BufferBlobHeader.BufferType.BT_UNKNOW:const t={that:M,loader:e,pointBufferObject:n,subPointBuffer:y,treeNode:i,onTileContentReadyCallback:a};this.taskRunner.runTask(this.loadDracoPoint,t,(function(){}));break;case proto.BufferBlobHeader.BufferType.BT_VERTEX:n.vertexArray=new Float32Array(y);break;case proto.BufferBlobHeader.BufferType.BT_COLOR:const r=new Uint8Array(y),s=n.blobHeader.getAttributeDataList()[f];let o=[];if(s==proto.PointBlobHeader.AttributeData.AD_COLOR_RGBA_I)r.forEach((e=>o.push(e/255)));else if(s==proto.PointBlobHeader.AttributeData.AD_COLOR_565_S)for(let e=0;e<r.length;e+=2){const t=r[e+0],i=r[e+1],a=(t>>3)/255,n=((3&t)<<3&i>>5)/255,s=(31&i)/255,l=1;o.push(a,n,s,l)}n.colorArray=new Float32Array(o);break;case proto.BufferBlobHeader.BufferType.BT_NORMAL:n.normalArray=new Float32Array(y)}}if(!n.vertexArray)return;const M=this.chooseParser(),E=this.getLoadCallback(i,M),b={that:M,loader:e,pointBufferObject:n,treeNode:i,onTileContentReadyCallback:a};this.taskRunner.runTask(E,b,(function(){}))}getPointParser(){return this.bimtilePointParser||(this.bimtilePointParser=new r.BimTilePointParser(this.options)),this.bimtilePointParser}getLoadCallback(e,t){return t.loadBufferPointMesh}chooseParser(){return this.getPointParser()}computeNodeCount(e){e.computePointNodeCount()}getBufferBlock(e,t,i){return e.tileReader.getBuffer(t,i,proto.BlockHeader.BlockType.BT_BUFFER)}getFullBuffer(e){return e.buffer}getBufferByIdx(e,t){return e.getBuffer(t)}setLoadedCount(e,t){e.loadedCount=t}}r.BimTilePointBlobParser=e}(),function(){class e extends r.BimTileLineBlobParser{constructor(e){super(e),this.blockType=proto.BlockHeader.BlockType.BT_LINE,this.lineParser=new r.BimTileOutlineParser(e)}destroy(){this.lineParser.destroy(),this.lineParser=void 0,super.destroy()}getLineParser(){return this.lineParser}getTileId(e){return`outline_${e.contentId}`}getBufferBlock(e,t,i){return e.tileReader.getOutlineBuffer(t,i,proto.BlockHeader.BlockType.BT_BUFFER)}getContentIndex(e){return e.getOutlineContentUrl()}computeNodeCount(e){e.computeOutlineNodeCount()}getFullBuffer(e){return e.outlineBuffer}getBufferByIdx(e,t){return e.getOutlineBuffer(t)}}r.BimTileOutlineBlobParser=e}(),function(){class e{constructor(e){this.loader=e,this.reader=e.reader}destroy(){}travelLineMesh(e,t,i){}updatePickingMeshes(){}}e.selectedMaterial=new r.MeshBasicClipMaterial({color:1170103,opacity:1,transparent:!1}),r.BimTileWireframeManager=e}(),r.BimTileBatchedMeshManager=class{constructor(e){this.loader=e,this.reader=e.reader,this.batchMeshIdNodeMap={},this.noUserDataMeshNodeInfoMap={}}destroy(){this.batchMeshIdNodeMap=null,this.noUserDataMeshNodeInfoMap=null}addMeshIdMap(e,t){this.batchMeshIdNodeMap[e]||(this.batchMeshIdNodeMap[e]=t)}getMeshNodeById(e){return this.batchMeshIdNodeMap[e]}disposeMeshNodeById(e){this.batchMeshIdNodeMap[e]=null}addNoUserDataMeshNodeInfo(e,t,i){void 0===this.noUserDataMeshNodeInfoMap[e]&&(this.noUserDataMeshNodeInfoMap[e]={}),this.noUserDataMeshNodeInfoMap[e][t]=i}patchMeshNodeInfo(e,t,i){this.loader.getDescriptor().patchBatchedMeshNodeInfo(e,t,i)}recoverNodeInfo(){for(const e in this.noUserDataMeshNodeInfoMap){const t=this.noUserDataMeshNodeInfoMap[e];for(const i in t)this.patchMeshNodeInfo(e,i,t[i])}this.noUserDataMeshNodeInfoMap=null}getGeometryBuffersByNodeInfo(e,t,i,r){const a=this.getMeshNodeById(e);if(!a||!1===a.visible)return;const n=a.geometry,s=n.getIndex().array,o=n.getAttribute("position").array,l=n.getAttribute("uv"),d=l?l.array:null,h=n.getAttribute("color"),c=h?h.array:null,u=n.getAttribute("cNormal"),p=u?u.array:null,m=a.indexGroups.get(t);for(const t of m.values()){let n=t.indexStart,l=t.indexStart+t.indexCount;const h=s.slice(n,l);let u,m,f=null;d&&(n=t.positionStart/3*2,l=n+t.positionCount/3*2,f=d.slice(n,l)),c&&(n=t.positionStart/3*4,l=n+t.positionCount/3*4,u=c.slice(n,l)),p&&(n=t.cNormalStart,l=n+t.cNormalCount,m=p.slice(n,l)),n=t.positionStart,l=t.positionStart+t.positionCount;const g=o.slice(n,l);n/=3,h.forEach((function(e,t,i){i[t]-=n})),r.push({isLines:!1,databagId:i,nodeId:e,position:g,index:h,uv:f,matrix:a.matrix,color:u,cNormal:m,isInstance:!1})}}updatePickingMeshes(e,t,i,a,n){const s=e.parent,o=this.getMeshNodeById(s);if(!o||!o.indexGroups||!1===o.visible||!1===o.parent.visible||null!=o.parent.parent&&0==o.parent.parent.visible)return;const l=o.geometry,d=o.indexGroups;let h=new THREE.BufferGeometry;h.setAttribute("position",l.getAttribute("position"));let c=l.getAttribute("uv");n&&c&&h.setAttribute("uv",c),h.setIndex(l.getIndex());let u="LineSegmentsEx"===o.type?new THREE.LineSegments(h,r.MaterialUtil.DefaultMaterial):new THREE.Mesh(h,r.MaterialUtil.DefaultMaterial);u.name=o.name,u.frustumCulled=!1,u.renderOrder=r.EnumRenderOrder.Component,u._indicesGroup=d,u.material=i?[i]:o.material,u.matrix.copy(o.matrix),u.matrixAutoUpdate=!1;const p=d.get(parseInt(t));let m={};i||l.groups.map((e=>{m[e.start]=e.materialIndex}));for(const e of p.values()){let t=0;i||(t=m[e.indexStart]),u.geometry.addGroup(e.indexStart,e.indexCount,t),a.add(u)}}calculateClippingContours(e,t,i,r,a,n,s,o){const l=n.parent,d=this.getMeshNodeById(l);if(!d||!d.indexGroups||"MeshEx"!==d.type||!1===d.visible||!1===d.parent.visible)return;const h=d.indexGroups,c=d.matrix,u=h.get(parseInt(r)).get(n.nodeId);let p=[];if(d.getIntersectionContours(t,u,p),0===p.length)return;let m=[];if(p.map((e=>{let t=[];e.map((e=>{e.applyMatrix4(c).applyMatrix4(s),i.containsPoint(e)&&t.push(e)})),t.length>0&&m.push(t)})),0===m.length)return;const f=d.material[0].color,g={red:parseInt(255*f.r),green:parseInt(255*f.g),blue:parseInt(255*f.b)};void 0===o[e][a]?o[e][a]={clippingContours:[m],colors:[g]}:(o[e][a].clippingContours.push(m),o[e][a].colors.push(g))}changeAllMaterials(e){for(let t in this.batchMeshIdNodeMap){let i=this.batchMeshIdNodeMap[t].material;if(!i)return;for(let t=0;t<i.length;t++){if(!i[t])continue;let r=i[t].name;e[r]&&(i[t]=e[r])}}}},r.BimTileInstancedMeshManager=class{constructor(e){this.loader=e,this.reader=e.tileReader,this.instanceMeshIdNodeMap={},this.instanceInfoMap={},this.noUserDataInstanceNodeInfoMap={},this.overrideMaterialMap={}}destroy(){this.instanceMeshNodeMap=null,this.InstanceInfoMap=null,this.noUserDataInstanceNodeInfoMap=null,this.overrideMaterialMap=null}addInstanceInfo(e,t){this.instanceInfoMap[e]||(this.instanceInfoMap[e]=t)}getInstanceInfoById(e){return this.instanceInfoMap[e]}addInstanceMeshIdMap(e,t,i,r){this.instanceMeshIdNodeMap[e]&&this.instanceMeshIdNodeMap[e][t]||(void 0===this.instanceMeshIdNodeMap[e]&&(this.instanceMeshIdNodeMap[e]={},this.instanceMeshIdNodeMap[e][t]={}),void 0===this.instanceMeshIdNodeMap[e][t]&&(this.instanceMeshIdNodeMap[e][t]={}),this.instanceMeshIdNodeMap[e][t].mesh=i,this.instanceMeshIdNodeMap[e][t].matrix=r)}getInstanceMeshNodeById(e){return this.instanceMeshIdNodeMap[e]}disposeInstanceMeshNodeById(e){this.instanceMeshIdNodeMap[e]=null,delete this.instanceMeshIdNodeMap[e]}addNoUserDataInstanceNodeInfo(e,t,i){if(void 0===this.noUserDataInstanceNodeInfoMap[e])return this.noUserDataInstanceNodeInfoMap[e]={},void(this.noUserDataInstanceNodeInfoMap[e][t]=[i]);void 0!==this.noUserDataInstanceNodeInfoMap[e][t]?this.noUserDataInstanceNodeInfoMap[e][t].push(i):this.noUserDataInstanceNodeInfoMap[e][t]=[i]}recoverNodeInfo(){for(const e in this.noUserDataInstanceNodeInfoMap){const t=this.noUserDataInstanceNodeInfoMap[e];for(const i in t)t[i].map((t=>{this.patchInstanceNodeInfo(e,i,t)}))}this.noUserDataInstanceNodeInfoMap=null}patchInstanceNodeInfo(e,t,i){this.loader.getDescriptor().patchInstanceNodeInfo(e,t,i)}getGeometryBuffersByNodeInfo(e,t,i,a){const n=this.getInstanceMeshNodeById(e);if(n)for(const s in n){const o=n[s].matrix,l=n[s].mesh;if(r.TilesUtil.isInstanceNodeInVisible(l))continue;let d=t.matrix.clone();d=o.clone().multiply(d);const h=l.geometry,c=h.getAttribute("uv"),u=r.ModelView.BaseDescriptor.isLineNode(t);a.push({isLines:u,databagId:i,nodeId:e,position:h.getAttribute("position").array,index:h.getIndex().array,matrix:d,uv:c?c.array:null,isInstance:!0})}}_createInstanceMaterial(e,t,i){const a=e.getAttribute("aColor").array,n=e.getAttribute("vState").array,s=e.getAttribute("vState2").array,o=a[4*t],l=a[4*t+1],d=a[4*t+2];let h=Math.floor(100*a[4*t+3])/100;const c=new THREE.Color(o,l,d);0!==n[t]&&0!==s[t]||(h=i);let u=!1;h<1&&(u=!0);const p={color:c.getHex(),opacity:h,transparent:u},m=`${p.color}_${h}`;let f=this.overrideMaterialMap[m];return f||(f=r.MaterialUtil.createStandardMaterial(p),this.overrideMaterialMap[m]=f,f)}updatePickingMeshes(e,t,i,a,n,s){const o=this.getInstanceMeshNodeById(e);if(o)for(const e in o){const n=o[e].matrix,l=o[e].mesh;if(r.TilesUtil.isInstanceNodeInVisible(l))continue;const d=l.geometry;let h=new THREE.BufferGeometry;h.setAttribute("position",d.getAttribute("position")),h.setIndex(d.getIndex());let c=null;c="LineSegmentsEx"===l.type?new THREE.LineSegments(h,r.BimTileWireframeManager.selectedMaterial):new THREE.Mesh(h,t||this._createInstanceMaterial(d,s,l.material[0].opacity)),c.name=l.name,c.frustumCulled=!1,c.matrix.copy(n).multiply(i),c.matrixAutoUpdate=!1,a.add(c)}}calculateClippingContours(e,t,i,a,n,s,o,l){const d=this.getInstanceMeshNodeById(s.nodeId);if(d)for(const a in d){const h=d[a].matrix,c=d[a].mesh;if(r.TilesUtil.isNodeInVisible(c))continue;let u=s.matrix.clone();u=h.clone().multiply(u);let p=[],m={matrix:u};c.getIntersectionContours(t,m,p,!0);let f=[];p.map((e=>{let t=[];e.map((e=>{e.applyMatrix4(o),i.containsPoint(e)&&t.push(e)})),t.length>0&&f.push(t)}));const g=c.material[0].color,v={red:parseInt(255*g.r),green:parseInt(255*g.g),blue:parseInt(255*g.b)};if(0===f.length)return;void 0===l[e][n]?l[e][n]={clippingContours:[f],colors:[v]}:(l[e][n].clippingContours.push(f),l[e][n].colors.push(v))}}updateInstanceClipping(e){var t=e?r.EnumInstanceState.CLIPPING:r.EnumInstanceState.NONE;for(var i in this.instanceMeshIdNodeMap){var a=this.instanceMeshIdNodeMap[i];for(var n in a){var s=a[n].mesh.geometry;const e=s.getAttribute("vClipping").array;e&&(e.fill(t),s.getAttribute("vClipping").needsUpdate=!0)}}}updatePickingMeshesByIds(e){let t={};const{bimtileDescriptor:i,instanceMeshGroup:a,selectedIds:n}=e,s=n.length,o=this.loader.filter;for(let e=0;e<s;++e){const r=this.reader.getIndexByUserId(n[e]);o.isPickable(r)&&i.getInstanceNodeInfoByUserIdCallback(r,(e=>{const i=e.nodeInfo,r=i.parent;t[r]||(t[r]={}),t[r][i.index]=!0}))}for(const e in t){const i=this.getInstanceMeshNodeById(e);if(!i)continue;let n=(e,t)=>{const i=e.length;for(let r=0;r<i;++r)!0!==t[r]&&(e[r]=-1)};for(const s in i){const o=i[s].matrix,l=i[s].mesh;if(r.TilesUtil.isInstanceNodeInVisible(l))continue;let d=l.geometry.clone();const h=d.getAttribute("vState").array,c=d.getAttribute("vState2").array;n(h,t[e]),n(c,t[e]);let u=new THREE.Mesh(d,l.material);u.name=l.name,u.frustumCulled=!1,u.matrix.copy(o),u.matrixAutoUpdate=!1,a.add(u)}}}changeAllMaterials(e){for(let t in this.instanceMeshIdNodeMap){let i=this.instanceMeshIdNodeMap[t];for(let t in i){let r=i[t].mesh.material;if(!r)return;for(let t=0;t<r.length;t++){if(!r[t])continue;let i=r[t].name;e[i]&&(r[t]=e[i])}}}}},function(){class e extends r.BimTileWireframeManager{constructor(e){super(e),this.batchedMeshIdNodeMap={}}destroy(){super.destroy(),this.batchedMeshIdNodeMap=null}addLineNodeById(e,t,i){this.batchedMeshIdNodeMap[e]||(this.batchedMeshIdNodeMap[e]={}),this.batchedMeshIdNodeMap[e][t]=i}getLineNodeById(e,t){return this.batchedMeshIdNodeMap[e][t]}disposeLineNodeById(e){this.batchedMeshIdNodeMap[e]=null,delete this.batchedMeshIdNodeMap[e]}travelLineMesh(e,t,i){const a=this.batchedMeshIdNodeMap[e];if(a)for(const e in a){const n=a[e];n.indexGroups.get(parseInt(t))&&(r.TilesUtil.isNodeInVisible(n)||i&&i(n))}}updatePickingMeshes(e,t,i,a){this.travelLineMesh(e,t,(e=>{const n=e.geometry,s=e.indexGroups;let o=new THREE.BufferGeometry;o.setAttribute("position",n.getAttribute("position")),o.setIndex(n.getIndex());let l=new THREE.LineSegments(o,r.BimTileWireframeManager.selectedMaterial);l.name=e.name,l.frustumCulled=!1,l.renderOrder=r.EnumRenderOrder.WireFrame,l._indicesGroup=s,l.material=[i],l.matrix.copy(e.matrix),l.matrixAutoUpdate=!1;const d=s.get(parseInt(t));for(const e of d.values())l.geometry.addGroup(e.indexStart,e.indexCount,0),a.add(l)}))}enableWireFrame(e){for(const t in this.batchedMeshIdNodeMap){const i=this.batchedMeshIdNodeMap[t];for(const t in i)i[t].visible=e}}dealLineMeshVisible(e){if(e.visible=this.loader.isBorderLineVisible(),!0===this.loader.wireFrameVisibilityOption)return;const t=e.indexGroups;let i=new Map;for(const[e,a]of t)r.TilesUtil.matchWireFrameVisibilityOption(e,this.loader.wireFrameVisibilityOption)&&i.set(e,a);e.geometry.clearGroups();const a=r.TilesUtil.nodeIndexGroupsSort(i),n=a.length;if(n<1)return;let s=a[0].indexGroup.indexStart,o=a[0].indexGroup.indexCount;for(let t=1;t<n;++t){const i=a[t].indexGroup;i.indexStart===a[t-1].indexGroup.indexStart+a[t-1].indexGroup.indexCount?o+=i.indexCount:(e.geometry.addGroup(s,o,0),s=i.indexStart,o=i.indexCount)}e.geometry.addGroup(s,o,0)}recoverLineNode(){for(const e in this.batchedMeshIdNodeMap){const t=this.batchedMeshIdNodeMap[e];for(const e in t){const i=t[e];this.dealLineMeshVisible(i)}}}}r.BimTileBatchedWireframeManager=e}(),function(){class e extends r.BimTileWireframeManager{constructor(e){super(e),this.instanceMeshIdNodeMap={}}destroy(){super.destroy(),this.instanceMeshIdNodeMap=null}addInstanceLineNodeById(e,t){this.instanceMeshIdNodeMap[e]=t}getInstanceLineNodeById(e){return this.instanceMeshIdNodeMap[e]}disposeInstanceLineNodeById(e){this.instanceMeshIdNodeMap[e]=null,delete this.instanceMeshIdNodeMap[e]}travelLineMesh(e,t,i){const a=this.instanceMeshIdNodeMap[e];a&&(r.TilesUtil.isInstanceNodeInVisible(a)||i&&i(a))}updateInstanceClipping(e){const t=e?r.EnumInstanceState.CLIPPING:r.EnumInstanceState.NONE;for(const e in this.instanceMeshIdNodeMap){const i=this.instanceMeshIdNodeMap[e].geometry,r=i.getAttribute("vClipping").array;r&&(r.fill(t),i.getAttribute("vClipping").needsUpdate=!0)}}updatePickingMeshes(e,t,i,a,n){this.travelLineMesh(e,t,(e=>{const t=e.geometry;let i=new THREE.BufferGeometry;i.setAttribute("position",t.getAttribute("position")),i.setIndex(t.getIndex());let s=new THREE.LineSegments(i,r.BimTileWireframeManager.selectedMaterial);s.name=e.name,s.frustumCulled=!1,s.renderOrder=r.EnumRenderOrder.WireFrame,s.matrix.copy(e.matrix).multiply(a),s.matrixAutoUpdate=!1,n.add(s)}))}enableWireFrame(e){for(const t in this.instanceMeshIdNodeMap)this.instanceMeshIdNodeMap[t].visible=e}recoverLineNode(){for(const e in this.instanceMeshIdNodeMap){const t=this.instanceMeshIdNodeMap[e],i=t.name,a=this.loader.getInstanceInfoById(i);if(t.visible=this.loader.isBorderLineVisible(),void 0===t.geometry)continue;const n=a.length,s=new Array(n),o=a[0].userDataID,l=a[0].userID;this.loader.tileReader.getUserDataByIndex(o);r.TilesUtil.matchWireFrameVisibilityOption(l,this.loader.wireFrameVisibilityOption)?s.fill(r.EnumInstanceState.NONE):s.fill(r.EnumInstanceState.HIDDEN);const d=new THREE.InstancedBufferAttribute(new Float32Array(s),1,!1,1);t.geometry.setAttribute("vState",d)}}}r.BimTileInstancedWireframeManager=e}(),function(){class e{constructor(e){this.materialMap={},this.globalMaterial=new THREE.MeshBasicMaterial({color:9143938}),this.settingMaterialPara={},this.materialsOpacity=null,this.viewer=e.viewer,this.isUseColorWithoutLight=e.isUseColorWithoutLight,this.IBLParams={A:!0,B:!0,C:!0,D:!0,E:!0,F:!0,IBLMaps:!0,metalness:!0,roughness:!0,scale:!0,iblFactor:!0}}destroy(){this.materialMap=null,this.settingMaterialPara={}}getMaterial(t,i,a,n){const s=t.filter.model,o=a.getMaterialId(),l=null!=i.renderInstance&&!0===i.renderInstance,d=e.generateMaterialName(i,o,l),h=this.getMaterialByName(d);if(r.Utils.isDefined(h))return void n(h);if(-1===o&&!l){const e=r.MaterialUtil.getDefaultStandardMaterial();return r.MaterialUtil.setCompressParm(e,a),this.dealMaterialDefines(e),e.name=d,this.materialMap[d]=e,void n(e)}if(-1===o&&l){const e=r.MaterialUtil.getDefaultInstanceMaterial();r.MaterialUtil.setCompressParm(e,a),this.dealMaterialDefines(e),e.name=d,this.materialMap[d]=e;let t=e.clone();t.transparent=!0,t.defines.INSTANCE_STATE_SECONDARY="";const i=d+"_second";return this.materialMap[i]=t,void n(e)}const c=i.bufferData,u=i.material,p=u.getMaterialsList()[o],m=this._createMaterial(t,d,p,l,a);if(m.srcOpacity=m.opacity,null!=this.materialsOpacity&&(m.opacity=m.srcOpacity*this.materialsOpacity,m.transparent=!(m.opacity>1-r.TilesUtil.TWO_ACCURACY)),s.localClippingMode&&(m.clippingPlanes=s.localClippingPlanes,m.innerClipping=s.innerClippingMode,m.orthoViewProjMatrix.copy(s.innerClippingMatrix)),this.materialMap[d]=m,l){const e=r.MaterialUtil.getMaterialParameters(m);let t=this.createInstanceSecondMaterial(e);!0===m.transparent?t.transparent=!1:t.transparent=!0,t.defines.INSTANCE_STATE_SECONDARY="",this.dealMaterialDefines(t),r.MaterialUtil.setCompressParm(t,a);const i=d+"_second";this.materialMap[i]=t}r.Utils.isDefined(a.uvCenter)&&(m.uvCenter=a.uvCenter,m.uvHalfExtent=a.uvHalfExtent),r.MaterialUtil.setCompressParm(m,a);const f={currentTextureParm:p.getTexturesList(),totalTextureParm:u.getTexturesList(),totalImageParm:u.getImagesList(),meshBufferData:c};this._createTextureForMaterial(t.rootUrl,m,f).then((e=>{n(e)}))}createInstanceSecondMaterial(e){return r.MaterialUtil.createInstanceMaterial(e,!0)}getLineMaterial(e,t,i,r){const a=i.getMaterialId();const n=`${-1===t.materialBlockId?t.materialBlockId:`${t.bufferId}+${t.materialBlockId}`}_line_${a}`,s=this.materialMap[n];if(s)return s._referenceCount++,s;t.bufferData;const o=t.material.getMaterialsList()[a];return this._createLineMaterial(e,n,o,r,i)}dealMaterialDefines(e,t){}dealMaterialParm(e){e.transparent=!(e.opacity>1-r.TilesUtil.TWO_ACCURACY),e.side=0===e.doubleSide?THREE.FrontSide:THREE.DoubleSide,e.originMetalness=e.metalness,e.originRoughness=e.roughness,e.receiveIBL=0!=e.receiveIbl,e.light=!0!==e.hasLightMap,delete e.hasLightMap}_createLineMaterial(e,t,i,a,n){const s=i.toObject(),o=!0===a?r.MaterialUtil.createInstanceMaterial(s):new r.LineBasicMaterial({linewidth:1});o._imageByteSize=0,o.srcOpacity=o.opacity,o.vertexColors=!!r.Utils.isDefined(n.vertexColors)&&n.vertexColors,null!=this.materialsOpacity&&(o.opacity=o.srcOpacity*this.materialsOpacity,o.transparent=!(o.opacity>1-r.TilesUtil.TWO_ACCURACY));const l=e.filter.model;return l.localClippingMode&&(o.clippingPlanes=l.localClippingPlanes,o.innerClipping=l.innerClippingMode,o.orthoViewProjMatrix.copy(l.innerClippingMatrix)),o.color.setHex(s.color),o.defines&&(o.defines.USE_COLORWITHOUTLIGHT=""),o.needsUpdate=!0,this.materialMap[t]=o,o._referenceCount=1,o}_createMaterial(e,t,i,a,n){const s=i.toObject();s.hasLightMap=n.hasLightMap,s.vertexColors=!!r.Utils.isDefined(n.vertexColors)&&n.vertexColors,this.dealMaterialParm(s);let o=a?r.MaterialUtil.createInstanceMaterial(s,!0,s.receiveIBL&&r.GlobalData.IBL):r.MaterialUtil.createStandardMaterial(s,s.receiveIBL&&r.GlobalData.IBL);o.name=t,this.dealMaterialDefines(o);for(let e in this.settingMaterialPara)this._isIBLParams(e)&&!s.receiveIBL||o.hasOwnProperty(e)&&(o[e]=this.settingMaterialPara[e],void 0!==o.refreshUniforms&&o.refreshUniforms());return o}_isIBLParams(e){return this.IBLParams[e]}_createTextureForMaterial(e,t,i){i=r.Utils.defaultValue(i,{});return new Promise(((a,n)=>{const s=i.currentTextureParm;r.Utils.isDefined(s)||a();const o=i.totalTextureParm,l=i.totalImageParm,d=[];for(let a=0;a<s.length;++a){const n=new Promise(((n,d)=>{const h=s[a],c=o[h];(!r.Utils.isDefined(c)||c.getImage()<0)&&n();const u=l[c.getImage()],p=c.getAlpha()>0?proto.bimtile_pbf.Texture.TextureType.TT_ALPHA:c.getType(),m=u.getUrl(),f=u.getType();let g=c.getName();const v=JSON.stringify(c.toObject());if(m){const i=`${e}${m}`;g=g||r.Utils.getEncodedString(i+v),this.viewer.TextureManager.getTextureFromURL(i,g,{textureParm:c,imageType:f}).then((e=>{this._setTexture(p,t,e),n()}))}else if(u.getBufferId()>=0){const s=this._getImageBuffer(i.meshBufferData,u);g=g||r.Utils.getEncodedString(`${e}${t.name}_${a}_texture_${v}`),this.viewer.TextureManager.getTextureFromBuffer(s,g,{textureParm:c,imageType:f}).then((e=>{this._setTexture(p,t,e),n()})).catch((()=>{d()}))}else n()}));d.push(n)}Promise.all(d).then((()=>{a(t)}))}))}_setTexture(e,t,i){const a=r.MaterialUtil.getImageByteSize(i.image);switch(t._imageByteSize+=a,e){case proto.bimtile_pbf.Texture.TextureType.TT_DIFFUSE:t.map=i;break;case proto.bimtile_pbf.Texture.TextureType.TT_SPECULAR:t.specularMap=i;break;case proto.bimtile_pbf.Texture.TextureType.TT_EMISSIVE:t.emissiveMap=i;break;case proto.bimtile_pbf.Texture.TextureType.TT_ENVIRONMENT:t.envMap=i;break;case proto.bimtile_pbf.Texture.TextureType.TT_ALPHA:t.useAlphaMap=!0,t.map=i,t.transparent=!0,t.alphaTest=.01;break;case proto.bimtile_pbf.Texture.TextureType.TT_RELIEF:case proto.bimtile_pbf.Texture.TextureType.TT_BUMP:t.bumpMap=i,t.bumpScale=i.bumpScale;break;case proto.bimtile_pbf.Texture.TextureType.TT_LIGHT:t.lightMap=i,t.defines.USE_COMPONENT_LIGHTMAP="",t.lightMapIntensity=r.GlobalData.LightmapIntensity}if(t.refreshUniforms(),t.needsUpdate=!0,""===t.defines.USE_INSTANCE){const r=t.name+"_second";let a=this.materialMap[r];if(!a)return;i._referenceCount++,this._setTexture(e,a,i)}}_updateIBL(e){if(r.GlobalData.IBL){this.settingMaterialPara.IBLMaps=e.manager.scene.IBLMaps,this.settingMaterialPara.iblFactor=10;var t=e.manager.viewer.getIBLManager().IBLParams;for(var i in t)this.settingMaterialPara[i]=t[i]}}_getImageBuffer(e,t){const i=t.getByteOffset(),r=t.getByteLength();return e.slice(i,i+r).buffer}delayUpdateTexturePkgMapping(){}updateMaterialsValue(e,t,i,r){this.settingMaterialPara[t]=i;const a=this.materialMap;for(const e in a){let n=a[e];if(n&&n.hasOwnProperty(t)){if(r&&0==n.receiveIBL)continue;n[t]=i,void 0!==n.refreshUniforms&&n.refreshUniforms(),n.needsUpdate=!0}}}changeAllMaterials(e,t){const i=this.materialMap;for(var a in i)if(i.hasOwnProperty(a)){var n=i[a];if(!n.receiveIBL)continue;var s,o=r.MaterialUtil.getMaterialParameters(n);""!=n.defines.USE_INSTANCE&&""!=n.defines.USE_INSTANCE_NORMAL||(o.defines=n.defines),t?(delete o.textureColor,delete o.pureColor,delete o.imageFade,delete o.tintColor,o.lights=!0,(s=new V.IBLMaterial(o)).type="IBL",s.refreshUniforms()):(delete o.iblProbe,o.lights=!e.lightmap,(s=r.MaterialUtil.createStandardMaterial(o)).roughness=o.originRoughness,s.metalness=o.originMetalness,s.refreshUniforms()),s.name=a,i[a]=s,o=null}if(!t)for(let e in this.IBLParams)delete this.settingMaterialPara[e]}setMaterialsOpacity(e){for(var t in this.materialsOpacity=e,this.materialMap){var i=this.materialMap[t];i.opacity=i.srcOpacity*this.materialsOpacity,i.transparent=!(i.opacity>1-r.TilesUtil.TWO_ACCURACY)}}disposeMaterial(e){return e._referenceCount--,!e._referenceCount&&(e.dispose(),this._disposeTextures(e),delete this.materialMap[e.name],e=null,!0)}_disposeTextures(e){r.Utils.isDefined(e.map)&&(this.viewer.TextureManager.disposeTexture(e.map),e.map=null),r.Utils.isDefined(e.alphaMap)&&(this.viewer.TextureManager.disposeTexture(e.alphaMap),e.alphaMap=null),r.Utils.isDefined(e.bumpMap)&&(this.viewer.TextureManager.disposeTexture(e.bumpMap),e.bumpMap=null),r.Utils.isDefined(e.lightMap)&&(this.viewer.TextureManager.disposeTexture(e.lightMap),e.lightMap=null)}getMaterialByName(e){let t=this.materialMap[e];return r.Utils.isDefined(t)?(t._referenceCount++,t):null}getMaterialById(e){return this.getMaterialByName(e)}setExcavation(e){}}e.generateMaterialName=function(e,t,i){if(-1===t)return i?"-1_instance":"-1_standard";let r=-1===e.materialBlockId?e.materialBlockId:`${e.bufferId}+${e.materialBlockId}`;r=i?`${r}_instance`:`${r}_standard`;return`${r}_${t}`},r.BimTileMaterialManager=e}(),function(){class e extends r.BimTileMeshParser{constructor(e){if(super(r.Utils.defaultValue(e,{})),this.taskRunner=new r.TaskRunner(5),this.pointAttributeTypes={position:"Float32Array",normal:"Float32Array",color:"Uint8Array",uv:"Float32Array"},this.pointSize=.5,this.shpPointMaterial=null,e&&e.isShpPoint){this.shpPointMaterial=new r.PointsMaterial({size:20,sizeAttenuation:!1,positionOffset:!1,sizeAttribute:!0,depthTest:!0,alphaTest:.001,transparent:!0});const e="https://static.bimface.com/attach/9cc8aabfabd0467bad0206bad79c349e_shp-point.png";(new THREE.TextureLoader).load(e,(e=>{this.shpPointMaterial.map=e,this.shpPointMaterial.needsUpdate=!0}))}}destroy(){this.taskRunner=null,this.pointAttributeTypes=null,this.shpPointMaterial&&this.shpPointMaterial.dispose(),this.shpPointMaterial=null}loadDracoPoint(e,t){const{that:i,loader:a,pointBufferObject:n,subPointBuffer:s,treeNode:o,onTileContentReadyCallback:l}=e;r.TilesUtil.getDracoLoader().decodeDracoFile(s,(function(e){e.attributes.color.normalized=!0,i.createMeshNode(a,n,o,e,l),t&&t()}),void 0,i.pointAttributeTypes)}loadMesh(e,t){let{that:i,loader:r,meshBufferObject:a,pbfNodeInfo:n,primitive:s,treeNode:o,onTileContentReadyCallback:l}=e;if((s.getAccVertices()<0||s.getAccIndices()<0)&&s.getAccArchive()<0)return void console.warn("invalid acc info");if(!this.checkIfTileAvailable(o))return this._deleteNodeBuffer(a,o),void(t&&t());let d=new THREE.BufferGeometry;const h=a.meshBlob,c=a.bufferData,u=i._getAccVertexArray(i,h,c,s),p=i._getAccIndicesArray(i,h,c,s);d.setAttribute("position",new THREE.BufferAttribute(u,3)),d.setIndex(new THREE.BufferAttribute(p,1)),i.createMeshNode(r,a,o,d,l),t&&t()}loadBufferPointMesh(e,t){const{that:i,loader:a,pointBufferObject:n,treeNode:s,onTileContentReadyCallback:o}=e,l=new THREE.BufferGeometry;l.setAttribute("position",new THREE.BufferAttribute(n.vertexArray,3)),n.colorArray&&l.setAttribute("color",new THREE.BufferAttribute(n.colorArray,4)),n.normalArray&&l.setAttribute("normal",new THREE.BufferAttribute(n.normalArray,3));const d=new THREE.PointsMaterial({size:i.pointSize});l.getAttribute("color")&&(d.vertexColors=!0);const h=new THREE.Points(l,d);h.name=s._contentIndex,s.content.meshes.add(h),o&&o(s),s.contentState=r.TileContentState.READY,s.content.meshes.matrix=s.matrix,s.content.meshes.updateMatrixWorld(!0),i._deleteNodeBuffer(n,s),t&&t()}createMeshNode(e,t,i,a,n){if(!this.checkIfTileAvailable(i))return void this._deleteNodeBuffer(t,i);let s=new r.PointsMaterial({size:this.pointSize,vertexColors:THREE.VertexColors});if(this.shpPointMaterial){const e=a.getAttribute("position").count,t=new Uint8Array,i=new Float32Array(e);for(let r=0;r<e;++r)t[r]=1,i[r]=20;a.setAttribute("attrSize",new THREE.BufferAttribute(i,1)),a.setAttribute("attrHoverAnimation",new THREE.BufferAttribute(t,1)),s=this.shpPointMaterial}const o=new r.PointsEx(a,s);o.name=i._contentIndex,i.content.meshes.add(o),this.decreaseLoadedCount(i),this.getLoadedCount(i)<=0&&(n&&n(i),i.contentState=r.TileContentState.READY,i.content.meshes.matrix=i.matrix,i.content.meshes.updateMatrixWorld(!0),this._deleteNodeBuffer(t,i))}_deleteNodeBuffer(e,t){e.bufferData=null,e.bufferBlob=null,e.blobHeader=null,e.pointBlob=null,e.vertexArray=null,e.colorArray=null,e.normalArray=null;var i=this.getFullBuffer(t);for(var r in i)i[r].content=null}getLoadedCount(e){return e.loadedCount}decreaseLoadedCount(e){e.loadedCount--}checkIfTileAvailable(e){return e.checkIfProcessingTileAvailable()}}r.BimTilePointParser=e}(),function(){let e=new THREE.Matrix4;function t(e,t,i,r,a,n,s,o,l){s.frustumCulled=!1;let d=new THREE.Matrix4;d.copy(a.matrix),r.rootMatrix&&(d=d.multiply(r.rootMatrix)),s.applyMatrix4(d);const{meshInfo:h}=t[i];s.name=a.nodeIndexId,s.indexGroups=h.indexGroups,s.indexCount=h.iAccInfoCount,s.databagId=a.content.meshes.databagId,s.fileId=a.content.meshes.fileId,s.isInstanceMeshNode=!0,s.matrixRoot=h.matrixRoot,a.content.meshes.add(s),n.addInstanceMeshIdMap(a.nodeIndexId,i,s,d),n.addInstanceInfo(a.nodeIndexId,r.entityInfoArray),n.renderableCount++,function(){const t={id:a.nodeId,bufferGeometry:e,material:[o,l],tileMatrix:d,node:a,instance:!0,pbfNodeInfo:{nodeIndexId:a.nodeIndexId,databagId:a.content.meshes.databagId,fileId:a.content.meshes.databagId,indexGroups:h.indexGroups,indexCount:h.iAccInfoCount,instanceInfo:a.instanceInfo}};a._tileset.geometryManager.addGeometryById(a.nodeId,t)}()}function i(e,i,a,d,h,c){!function(e,t,i,a,d){var h=d.filter.model.localClippingMode?r.EnumInstanceState.CLIPPING:r.EnumInstanceState.NONE;const c=n(i,t.meshInfo.matrixRoot);for(let t=0;t<c.length;++t)e.setAttribute("mcol"+t.toString(),c[t]);const u=function(e){const t={column0:[],column1:[],column2:[]},i=new THREE.Matrix3;for(let r=0;r<e;++r){const e=i.elements;t.column0.push(e[0],e[1],e[2]),t.column1.push(e[3],e[4],e[5]),t.column2.push(e[6],e[7],e[8])}const r=[];for(let e=0;e<3;++e){e.toString();const i=t["column"+e.toString()],a=new THREE.InstancedBufferAttribute(new Float32Array(i),3,!1,1);r.push(a)}return r}(i.length);for(let t=0;t<u.length;++t)e.setAttribute("muvCol"+t.toString(),u[t]);const p=function(e){const t=e.length,i=new Uint32Array(t);for(let r=0;r<t;++r)i[r]=e[r].userID;return new THREE.InstancedBufferAttribute(i,1,!1,1)}(i);e.setAttribute("id",p);const m=s(t.meshMaterial.color,i);e.setAttribute("aColor",m);const f=function(e){const t=e.length,i=[];for(let r=0;r<t;++r){const t=e[r].uv3;null!=t&&2===t.length?i.push(t[0],t[1]):i.push(0,0)}return new THREE.InstancedBufferAttribute(new Float32Array(i),2,!1,1)}(i);e.setAttribute("uv3",f);const g=l(i.length,r.EnumInstanceState.NONE);e.setAttribute("vState",g);const v=l(i.length,r.EnumInstanceState.HIDDEN);e.setAttribute("vState2",v);const y=o(i.length,h);if(e.setAttribute("vClipping",y),r.BimTilesVersionControl.isVersion_3(d.dataVersion)){const t=function(e){const t=new Array(e);t.fill(1);return new THREE.InstancedBufferAttribute(new Uint32Array(t),1,!1,1)}(i.length);e.setAttribute("idState",t)}}(e,i[a],d.entityInfoArray,0,c);const u=i[a].meshMaterial,p=u.name+"_second",m=c.materialManager.getMaterialByName(p);let f=new r.MeshEx(e,[u,m]);m.visible=!1,t(e,i,a,d,h,c,f,u,m)}function a(e,i,a,d,h,c){!function(e,t,i,a,d){var h=d.filter.model.localClippingMode?r.EnumInstanceState.CLIPPING:r.EnumInstanceState.NONE;const c=n(i,t.meshInfo.matrixRoot);for(let t=0;t<c.length;++t)e.setAttribute("mcol"+t.toString(),c[t]);const u=s(t.lineMaterial.color,i);e.setAttribute("aColor",u);const p=l(i.length,r.EnumInstanceState.NONE);e.setAttribute("vState",p);const m=o(i.length,h);e.setAttribute("vClipping",m)}(e,i[a],d.entityInfoArray,0,c);const u=i[a].lineMaterial;t(e,i,a,d,h,c,new r.LineSegmentsEx(e,u),u,null)}function n(t,i){const r={column0:[],column1:[],column2:[],column3:[]};for(let a=0;a<t.length;++a){let n=e.copy(t[a].entityMatrix);i&&(n=n.multiply(i));const s=n.elements;r.column0.push(s[0],s[1],s[2]),r.column1.push(s[4],s[5],s[6]),r.column2.push(s[8],s[9],s[10]),r.column3.push(s[12],s[13],s[14])}const a=[];for(let e=0;e<4;++e){const t=r["column"+e.toString()],i=new THREE.InstancedBufferAttribute(new Float32Array(t),3,!1,1);a.push(i)}return a}function s(e,t){const i=t.length,r=[];for(let a=0;a<i;++a){const i=null!=e.opacity?e.opacity:1;if(-1!==t[a].color&&0!==t[a].color){const e=(new THREE.Color).setHex(t[a].color);r.push(e.r,e.g,e.b,i)}else r.push(e.r,e.g,e.b,i)}return new THREE.InstancedBufferAttribute(new Float32Array(r),4,!1,1)}function o(e,t){const i=new Array(e);i.fill(t);return new THREE.InstancedBufferAttribute(new Float32Array(i),1,!1,1)}function l(e,t){const i=new Array(e);i.fill(t);return new THREE.InstancedBufferAttribute(new Float32Array(i),1,!1,1)}function d(e,t){let i=null;i=t?new THREE.BufferGeometry:new THREE.InstancedBufferGeometry;const a=e.meshMaterial;return r.Utils.isDefined(a)&&a.useCompressedNormal?e.normal&&i.setAttribute("cNormal",e.normal):e.normal&&i.setAttribute("normal",e.normal),i.setAttribute("position",e.position),e.uv&&i.setAttribute("uv",e.uv),e.color&&i.setAttribute("color",e.color),i.setIndex(e.index),i.clearGroups(),i.groups.push({start:0,count:e.meshInfo.iAccInfoCount,materialIndex:0}),i.groups.push({start:0,count:e.meshInfo.iAccInfoCount,materialIndex:1}),i}function h(e){let t=new THREE.InstancedBufferGeometry;const i=e.lineMaterial;return r.Utils.isDefined(i)&&i.useCompressedNormal?e.normal&&t.setAttribute("cNormal",e.normal):e.normal&&t.setAttribute("normal",e.normal),t.setAttribute("position",e.position),t.setIndex(e.index),t.clearGroups(),t.groups.push({start:0,count:e.meshInfo.iAccInfoCount,materialIndex:0}),t}r.InstanceRenderManager=class{constructor(){}static attachToNode(e,t,r,n,s){null!=s.renderDirectly&&!0===s.renderDirectly?function(e,t,r,a){for(let n=0;n<a.length;++n)for(let n=0;n<e.length;++n){i(d(e[n],!0),e,n,a,t,r)}}(e,t,r,n):function(e,t,r,n){for(let s=0;s<e.length;++s)if(e[s].meshMaterial){i(d(e[s],!1),e,s,n,t,r)}else if(e[s].lineMaterial){a(h(e[s]),e,s,n,t,r)}}(e,t,r,n)}}}();r.SharedGeometryLoader=class{constructor(e){this._loader=e,this._entityMap={},this._waitingTaskMap={}}destroy(){this._entityMap=null,this._waitingTaskMap=null}loadArrayBuffer(e,t,i){return new Promise(((r,a)=>{const n=this._entityMap[e];if(void 0!==n)if("loaded"===n.status){const s=n.geoArrayBuffer;r(s)}else if("loading"===n.status){function o(e){r(e)}this._waitingTaskMap[e].push(o)}else"failed"===n.status&&a("load entity failed");else{function l(e){r(e)}this._entityMap[e]={status:"loading",geoArrayBuffer:null},this._waitingTaskMap[e]=[l];(function(e,t){const i=new Promise(((i,r)=>{t.loadArrayBufferImmediately(e,(e=>{i(e)}),(e=>{r(e)}))}));return i})(t+e,i).then((t=>{this._entityMap[e].geoArrayBuffer=t,this._entityMap[e].status="loaded";const i=this._waitingTaskMap[e];for(let e=0;e<i.length;++e)i[e](t);this._waitingTaskMap[e]=null})).catch((()=>{this._entityMap[e].status="failed",this._waitingTaskMap[e]=null}))}}))}},r.BimTileInstanceParser=class{constructor(e){this._contentFolder,this._delayLoadTexture=e.delayLoadTexture,this._renderDirectly=null!=e.renderDirectly&&!0===e.renderDirectly&&e.renderDirectly,this._sharedGeometryLoader=new r.SharedGeometryLoader,this.materialManager=e.materialManager}set contentFolder(e){this._contentFolder=e}get contentFolder(){return this._contentFolder}destroy(){this._sharedGeometryLoader.destroy(),this._sharedGeometryLoader=void 0,this.materialManager=null}parseBlobs(e,t,i){t.isInstanceTile=!0,t.userIndexMap=new Map;const r=proto.BlockHeader.BlockType.BT_INSTANCE;for(let s in t.buffer){var a=t.getBuffer(s);if(a.type==r){var n=a.content;n&&this.parseBlob(e,n,t,i)}}}parseBlob(e,t,i,a){if(!t)return;const n=t.getBlobHeader();let s=r.Utils.isDefined(i.contentInsModel)?i.contentInsModel:n.getEntityUrl();const o=`${r.Utils.isDefined(i.contentId)?i.contentId:n.getTileId()}_${n.getBlockId()}`,l=this._parseInstanceBlob(e,i,t,o),d={entityID:s,entityInfoArray:l.entityInfoArray};i.instanceInfo=d,this._sharedGeometryLoader.loadArrayBuffer(s,i._contentFolder,e).then((t=>{i.checkIfProcessingTileAvailable()&&this._loadInstanceEntityCallBack(t,e,i,this._renderDirectly).then((t=>{i.checkIfProcessingTileAvailable()&&(i.nodeIndexId=o,r.InstanceRenderManager.attachToNode(t,i,e,l,{renderDirectly:this._renderDirectly}),a&&a(i))}))})).catch((e=>{console.log(e)}))}_addInstanceNodeInfo(e,t,i,r,a,n,s){const o=i.userID,l=r,d={bufferId:r,instanceIndex:a,entityMatrix:i.entityMatrix,type:proto.bimtile_pbf.Node.NodeType.NT_BATCHED_SUB_NODE};e.disableUserData?e.addNoUserDataInstanceNodeInfo(o,l,d):e.patchInstanceNodeInfo(o,l,d,s)}_loadInstanceEntity(e,t,i,r){return new Promise(((a,n)=>{t.loadArrayBufferImmediately(e,(e=>{i.checkIfProcessingTileAvailable()||this._loadInstanceEntityCallBack(e,t,i,r).then((e=>{a(e)})).catch((e=>{n(e)}))}))}))}_loadInstanceEntityCallBack(e,t,i,a){return new Promise(((n,s)=>{const o=this._parseInstanceEntityBlob(e,t.tileReader);o.contentIndex=i.contentIndex;const l=new r.BimTileInstanceMeshBlobParser({_delayLoadTexture:null,renderDirectly:a,materialManager:t.materialManager});l.parse(t,o).then((()=>{const e=this._bufferGeometry(l);l.destroy(),n(e)})).catch((e=>{s(e)}))}))}_parseInstanceEntityBlob(e,t){const i={parent:!0},r={node:i,type:proto.bimtile_pbf.BlockHeader.BlockType.BT_MESH};return t.parseBlock(e,r),i}_parseInstanceBlob(e,t,i,a){const n=i.getBlobHeader(),s=new THREE.Matrix4,o=[],l=n.getMatrixList();let d=n.getPackingUvList();if(16===l.length){s.fromArray(l);let e=n.getTranslationList();r.Utils.isDefined(e)&&3===e.length&&s.setPosition(e[0],e[1],e[2])}const h=i.getInstancesList(),c=a;for(let i=0;i<h.length;++i){const r=h[i],a=new THREE.Matrix4,n=r.getMatrixList();16===n.length&&a.fromArray(n);const l=r.getUserId(),u=r.getColor();t.userIndexMap.set(l,!0);const p=r.getUserdataId(),m=e.tileReader.getUserDataByIndex(p);let f=new Array(2).fill(0),g=r.getPackingUvList();null!=g&&2===g.length&&(f=g),null!=d&&2===d.length&&(f=d);const v={userID:l,userDataID:p,userData:m,entityMatrix:a,color:u,uv3:f};o.push(v),e.pbfNodeInfoMap[c]||this._addInstanceNodeInfo(e,r,v,c,i,s,t.contentId)}return e.pbfNodeInfoMap[c]={},{entityInfoArray:o,rootMatrix:s}}_bufferGeometry(e){const t=[];for(const[i,r]of Object.entries(e._geoBuffers)){const e=r;for(let i=0;i<e.length;++i)if(e[i].meshInfo.useDraco){const r=this._getAttributeBufferFromDracoGeoBuffer(e[i].bufferGeometry);r.meshInfo=e[i].meshInfo,r.meshMaterial=e[i].meshMaterial,t.push(r)}else t.push(e[i])}return t}_getAttributeBufferFromDracoGeoBuffer(e){const t={};for(const[i,r]of Object.entries(e.attributes))t[i]=r;return t.index=e.index,t}},r.BimTileInstanceMeshBlobParser=class{constructor(e){this._geoBuffers={},this.materialManager=e.materialManager,this._renderDirectly=null!=e.renderDirectly&&!0===e.renderDirectly,this._parsePromiseArray=[]}get renderDirectly(){return this._renderDirectly}destroy(){this._parsePromiseArray=null,this._geoBuffers=null,this.materialManager=null}parse(e,t){if(!t||!t.buffer)return;const i=this._getBufferInfo(e,t);if(!i)return;const r=i.meshBlob.getScenesList();if(!r.length)return;this._traverseScenes(r,i);const a=this;return new Promise(((e,t)=>{Promise.all(a._parsePromiseArray).then((()=>{a._parsePromiseArray=null,e()})).catch((()=>{a._parsePromiseArray=null,t("some error when paser mesh block "+i.bufferId)}))}))}_getBufferInfo(e,t){const i=t.buffer[0].content,r=i.getBlobHeader(),a=r.getBufferBlockId(),n=t.buffer[a].content;if(!n)return null;const s=n.getBuffer();let o={};return o.contentIndex=t.contentIndex,o.meshBlob=i,o.buffer=n,o.bufferData=s,o.bufferId=`${r.getTileId()}_${a}`,o.loader=e,o.node=t,o.renderInstance=!this._renderDirectly,o}_traverseScenes(e,t){const i=e.length;for(let r=0;r<i;++r){const i=e[r],a=i.getNodesList(),n=i.getName();this._traverseNodesPerScene(a,t,n)}}_traverseNodesPerScene(e,t,i){const r=e.length;for(let a=0;a<r;++a){const r=e[a],n=t.meshBlob.getNodesList()[r];let s=new THREE.Matrix4;16==n.getMatrixList().length&&s.fromArray(n.getMatrixList());const o={};o.nodeIndex=r,o.matrix=s,o.sceneName=i,this._parseBufferNode(n,o,t)}}_parseBufferNode(e,t,i){const r=e.getPrimitivesList();return e.getNodeType()!=proto.bimtile_pbf.Node.NodeType.NT_BATCHED_SUB_NODE&&this._traversePrimitivesPerNode(r,t,i),!0}_traversePrimitivesPerNode(e,t,i){const r=e.length;if(!r)return;++this._meshCount;const a=new Promise((a=>{let n=0;for(let s=0;s<r;s++){const o=e[s],l=i.meshBlob.getPrimitivesList()[o];if(l.getMode()===proto.bimtile_pbf.Primitive.PrimitiveMode.PM_TRIANGLES||l.getMode()===proto.bimtile_pbf.Primitive.PrimitiveMode.PM_LINES){let e=null;if(e=l.getAccArchive()>=0?this._getBufferByPrimitive_Draco(l,t,i):this._getBufferByPrimitive(l,t,i),e){const t=this;e.then((e=>{++n,t._geoBuffers[e.meshInfo.sceneName]?t._geoBuffers[e.meshInfo.sceneName].push(e):t._geoBuffers[e.meshInfo.sceneName]=[e],n===r&&a()})).catch((e=>{console.log(e)}))}}}}));return this._parsePromiseArray.push(a),a}_getBufferByPrimitive(e,t,i){if((e.getAccVertices()<0||e.getAccIndices()<0)&&e.getAccArchive()<0)return;if(this._resetMeshBuffer(i),!i.buffer)return;const{meshBlob:r}=i,{bufferData:a}=i,n={nodeIndex:t.nodeIndex,matrixRoot:t.matrix,sceneName:t.sceneName,useDraco:!1},s=this._getNormal(r,a,n,e),o=this._getVertex(r,a,n,e),l=this._getIndex(r,a,n,e),d=this._getTextureCoord(r,a,n,e),h=this._getColor(r,a,n,e),c=this;return new Promise(((t,r)=>{if(e.getMode()===proto.bimtile_pbf.Primitive.PrimitiveMode.PM_TRIANGLES)c.materialManager.getMaterial(i.loader,i,e,(e=>{if(e){const i={normal:s||null,position:o.vertexBufferAttribute,index:l.indexBufferAttribute,uv:d?d.uvBufferAttribute:null,meshMaterial:e,meshInfo:n,color:h};t(i)}else r("get material faild")}));else if(e.getMode()===proto.bimtile_pbf.Primitive.PrimitiveMode.PM_LINES){const r=c.materialManager.getLineMaterial(i.loader,i,e,!0),a={normal:s||null,position:o.vertexBufferAttribute,index:l.indexBufferAttribute,lineMaterial:r,meshInfo:n};t(a)}}))}_getBufferByPrimitive_Draco(e,t,i){if((e.getAccVertices()<0||e.getAccIndices()<0)&&e.getAccArchive()<0)return;if(this._resetMeshBuffer(i),!i.buffer)return;const{meshBlob:a}=i,{bufferData:n}=i,{material:s}=i,o=a.getBufferaccsList()[e.getAccArchive()],l=o.getByteOffset(),d=o.getByteLength(),h=n.slice(l,l+d).buffer,c=this,u={nodeIndex:t.nodeIndex,matrixRoot:t.matrix,sceneName:t.sceneName,useDraco:!0};return new Promise((t=>{r.TilesUtil.getDracoLoader().decodeDracoFile(h,(function(r){s&&e.getMaterialId()>=-1&&(r.clearGroups(),r.groups.push({start:0,count:r.index.count,materialIndex:0}),u.iAccInfoCount=r.index.count,c.materialManager.getMaterial(i.loader,i,e,(e=>{t({bufferGeometry:r,meshMaterial:e,meshInfo:u})})))}))}))}_resetMeshBuffer(e){const t=e.meshBlob.getBlobHeader(),i=t.getBufferBlockId(),r=t.getMaterialBlockId(),a=t.getUserdataBlockId(),n=e.node.buffer[i].content,s=-1===r?e.loader.tileReader.globalMaterialBuffer:e.node.buffer[r].content;e.buffer=n,e.materialBlockId=r,e.material=s,e.userdataBlockId=a,n&&(e.bufferData=n.getBuffer())}_getAccInfo(e,t){if(t<0)return{offset:0,length:0,count:0};const i=e.getBufferaccsList()[t];return{offset:i.getByteOffset(),length:i.getByteLength(),count:i.getCount(),valueType:i.getValueType()}}_getNormal(e,t,i,r){const a=this._getAccInfo(e,r.getAccNormals());if(a.count>0){let e,n;const s=t.slice(a.offset,a.offset+a.length).buffer;switch(i.nAccInfoStart=a.offset,i.nAccInfoCount=a.count,a.valueType){case proto.bimtile_pbf.BufferAcc.ComponentType.CT_UBYTE:e=new Uint8Array(s),r.useCompressedNormal=!0,n=new THREE.BufferAttribute(e,2);break;case proto.bimtile_pbf.BufferAcc.ComponentType.CT_FLOAT:e=new Float32Array(s),r.useCompressedNormal=!1,n=new THREE.BufferAttribute(e,3)}return n}return null}_getVertex(e,t,i,r){const a=this._getAccInfo(e,r.getAccVertices()),n=t.slice(a.offset,a.offset+a.length).buffer;let s=new Float32Array(n);return i.vAccInfoStart=a.offset,{vertexBufferData:n,vertexBufferAttribute:new THREE.BufferAttribute(s,3)}}_getColor(e,t,i,r){const a=this._getAccInfo(e,r.getAccColor());if(0===a.length||0===r.getAccColor())return null;const n=t.slice(a.offset,a.offset+a.length).buffer;let s=new Uint8Array(n);i.cAccInfoStart=a.offset,r.vertexColors=!0;const o=new THREE.BufferAttribute(s,4);return o.normalized=!0,o}_getIndex(e,t,i,r){const a=this._getAccInfo(e,r.getAccIndices()),n=t.slice(a.offset,a.offset+a.length).buffer;let s=null;return s=a.valueType===proto.bimtile_pbf.BufferAcc.ComponentType.CT_USHORT?new Uint16Array(n):new Uint32Array(n),i.iAccInfoStart=a.offset,i.iAccInfoCount=a.count,{indexBufferData:n,indexBufferAttribute:new THREE.BufferAttribute(s,1)}}_getTextureCoord(e,t,i,r){i.tAccInfoStart=0;const a=this._getAccInfo(e,r.getAccTexcoords());if(a.count>0){const e=t.slice(a.offset,a.offset+a.length).buffer;i.tAccInfoStart=a.offset;let r=new Float32Array(e);return{uvBufferData:e,uvBufferAttribute:new THREE.BufferAttribute(r,2)}}return null}},r.BimTileSearchTreeManager=class{constructor(e){this.reader=e,this.is2D=!1,this.searchTreeBuffer={}}destroy(){this.reader=null,this.searchTreeBuffer=null}setIs2D(e){this.is2D=e}addSearchTreeBuffer(e,t,i){void 0===this.searchTreeBuffer[e]&&(this.searchTreeBuffer[e]={},this.searchTreeBuffer[e].searchTreeBlob=i,this.searchTreeBuffer[e].box=t)}getSearchTreeBuffer(){return this.searchTreeBuffer}intersect(e,t,i,a,n,s){let o,l=r.Utils.scratchBoundingBox;if(!t){let t=r.Utils.scratchMatrix4_1;t.copy(a).invert(),o=e.ray.clone().applyMatrix4(i).applyMatrix4(t)}let d=t?function(e){let i=l.copy(e);return i.applyMatrix4(a),t.intersectsBox(i)?1:-1}:function(e){return o.intersectBoxWithDistance(e)},h={};const c=this.searchTreeBuffer;for(const e in c){const t=c[e].searchTreeBlob,i=c[e].box,a=d(i);if(!s&&a<0)continue;const n=t.getNodeIdsList(),o=t.getOctreeList(),l=t.getOctreeList()[0];let u=function(e,t){const i=r.TilesUtil.getBox(t.getBboxList()),a=d(i);if(!s&&a<0)return;let o=t.getNodesList();const l=o.length;for(let e=0;e<l;++e){const t=o[e],i=n[t],a=r.TilesUtil.getBox(i.getBboxList()),l=d(a);if(!s&&l<0)continue;const c=`${i.getTileId()}_${i.getBlockId()}_${i.getNodeId()}`;void 0===h[i.getUserId()]?h[i.getUserId()]=[c]:h[i.getUserId()].push(c)}t.getChildrenList().map((t=>{const i=e[t];u(e,i)}))};u(o,l)}return h}getObjectsInBoxByBimtile(e,t,i,a,n){let s=r.Utils.scratchBoundingBox,o=(e,t,r)=>{let a=s.copy(e).applyMatrix4(t).applyMatrix4(r);return!!i.intersectsBox(a)&&(n(a)?1:2)};const l=this.searchTreeBuffer,d=t.getTransformMatrix();for(const i in l){const n=l[i].searchTreeBlob,s=l[i].box;if(!o(s,d,a))continue;const h=n.getNodeIdsList(),c=n.getOctreeList(),u=n.getOctreeList()[0];let p=function(i,n){const s=r.TilesUtil.getBox(n.getBboxList());if(!o(s,d,a))return;let l=n.getNodesList();for(let i=0,n=l.length;i<n;++i){const n=l[i],s=h[n],c=r.TilesUtil.getBox(s.getBboxList());if(2!==o(c,d,a))continue;const u=s.getUserId(),p=t.getRealUserId(u);e[p]=!0}n.getChildrenList().map((e=>{const t=i[e];p(i,t)}))};p(c,u)}}getUserIdsInFrustum(e,t,i,a,n,s){const o=e.getNodeIdsList(),l=e.getOctreeList(),d=e.getOctreeList()[0];let h=new THREE.Box3,c=(e,l)=>{const d=r.TilesUtil.getBox(l.getBboxList());if(h.copy(d),h.applyMatrix4(a).applyMatrix4(n),!t.intersectsBox(h)&&!s)return;let u=l.getNodesList();const p=u.length;for(let e=0;e<p;++e){const l=u[e],d=o[l],c=r.TilesUtil.getBox(d.getBboxList());if(h.copy(c),h.applyMatrix4(a).applyMatrix4(n),!t.intersectsBox(h)&&!s)continue;const p=`${d.getTileId()}_${d.getBlockId()}_${d.getNodeId()}`;void 0===i[d.getUserId()]?i[d.getUserId()]=[p]:i[d.getUserId()].push(p)}l.getChildrenList().map((t=>{const i=e[t];c(e,i)}))};c(l,d)}},r.BimTileNodeIdInfo=class{constructor(){this._index=void 0,this._userId=void 0,this._boundingBox=null,this._instanceOrNot=!1,this._tileId=void 0,this._lineId=void 0,this._parent=void 0,this._matrix=void 0,this._materialId=void 0,this._type=void 0,this._owner=void 0}clone(){return{index:this.index,userId:this.userId,boundingBox:this.boundingBox,instanceOrNot:this.instanceOrNot,tileId:this.tileId,lineId:this.lineId,nodeId:this.nodeId,parent:this.parent,geometryId:this.geometryId,matrix:this.matrix,materialId:this.materialId}}destroy(){this._userId=void 0,this._boundingBox=null,this._instanceOrNot=void 0,this._index=void 0,this._lineId=void 0,this._tileId=void 0,this._parent=void 0,this._matrix=void 0,this._materialId=void 0,this._explodeMatrix=void 0,this._type=void 0,this._owner=void 0}get index(){return this._index}set index(e){this._index=e}get name(){return this._userId}set name(e){this._userId=e}get userId(){return this._userId}set userId(e){this._userId=e}get tileId(){return parseInt(this._tileId)}set tileId(e){this._tileId=e.toString()}get boundingBox(){return this._boundingBox}set boundingBox(e){this._boundingBox=e}get nodeId(){return this.instanceOrNot?`${this._tileId}_0`:`${this._tileId}_0_${this._index}`}get instanceOrNot(){return this._instanceOrNot}set instanceOrNot(e){this._instanceOrNot=e}get lineId(){return`outline_${this._tileId}`}get parent(){return this._parent}set parent(e){this._parent=e}get matrix(){return this._matrix}set matrix(e){this._matrix=e}get type(){return this._type}set type(e){this._type=e}get materialId(){return this._materialId}set materialId(e){this._materialId=e}get geometryId(){return this.nodeId}get geometryId(){return this.nodeId}set geometryId(e){this._nodeId=e}set owner(e){this._owner=e}get owner(){return this._owner}get state(){return this._owner?this._owner._state:void 0}get material(){return this._owner?this._owner._material:void 0}get explodeMatrix(){return this._owner?this._owner._explodeMatrix:void 0}get loadedExplodeMatrix(){return this._owner?this._owner._loadedExplodeMatrix:void 0}get userData(){return this._owner?this._owner._userData:void 0}update(e,t){this.owner=e,this.originBox=t.getNodeBoxByIndex(this.boundingBox),this.boundingBox=this.originBox.clone(),e.loadedExplodeMatrix&&this.boundingBox.applyMatrix4(e.loadedExplodeMatrix)}},function(){class e extends r.BimTileNodeIdInfo{constructor(){super(),this._userId=void 0,this._userData=void 0,this._blockId=void 0,this._explodeMatrix=void 0,this._loadedExplodeMatrix=void 0,this._state=r.EnumObjectState.Visible,this._material=void 0}clone(){return{index:this.index,userId:this.userId,userData:this.userData,boundingBox:this.boundingBox,tileId:this.tileId,blockId:this.blockId,nodeId:this.nodeId,lineId:this.lineId,state:this.state,parent:this.parent,geometryId:this.geometryId,matrix:this.matrix,materialId:this.materialId,explodeMatrix:this.explodeMatrix}}destroy(){super.destroy(),this._userId=void 0,this._userData=void 0,this._state=void 0,this._blockId=void 0,this._explodeMatrix=void 0,this._loadedExplodeMatrix=void 0,this._material=void 0}get name(){return this._userId}set name(e){this._userId=e}get explodeMatrix(){return this._explodeMatrix}set loadedExplodeMatrix(e){void 0!==this._loadedExplodeMatrix?this._loadedExplodeMatrix.multiplyMatrices(e,this._loadedExplodeMatrix):this._loadedExplodeMatrix=e}get loadedExplodeMatrix(){return this._loadedExplodeMatrix}set explodeMatrix(e){this._explodeMatrix=e}get state(){return this._state}set state(e){this._state=e}get userId(){return this._userId}set userId(e){this._userId=e}get blockId(){return parseInt(this._blockId)}set blockId(e){this._blockId=e.toString()}get boundingBox(){const e=r.TilesUtil.getBox(this._boundingBox).clone();return this._loadedExplodeMatrix?e.applyMatrix4(this._loadedExplodeMatrix):e}applyBoxMatrix(e){const t=r.TilesUtil.getBox(this._boundingBox).clone().applyMatrix4(e);this._boundingBox=[t.min.x,t.min.y,t.min.z,t.max.x,t.max.y,t.max.z]}set boundingBox(e){this._boundingBox=e}get nodeId(){return this._instanceOrNot?`${this._tileId}_${this._blockId}`:`${this._tileId}_${this._blockId}_${this._index}`}get userData(){return this._userData}set userData(e){this._userData=e}get geometryId(){return this.nodeId}set geometryId(e){this._nodeId=e}get material(){return this._material}set material(e){this._material=e}}r.BimTileNodeInfo=e}(),r.BimTileUserIdTool=class{constructor(){this.globalUserIdUrls=[],this.globalUserIdBuffers=[],this.userIndexStringMap={},this.userStringIndexMap={},this.userDataIndexMap={}}destroy(){this.globalUserIdUrls=null,this.globalUserIdBuffers=null,this.userIndexStringMap=null,this.userStringIndexMap=null,this.userDataIndexMap=null}addGlobalUserIdUrl(e){this.globalUserIdUrls.push(e)}getGlobalUserIdUrls(){return this.globalUserIdUrls}getGlobalUserIdBuffers(){return this.globalUserIdBuffers}parseUserIdBuffer(e){const t=e.getBlobHeader().getUserIdMin(),i=e.getBlobHeader().getUserIdMax(),r=e.getUserIdsList();for(let e=t;e<=i;++e){const i=r[e-t];this.userIndexStringMap[e]=i,this.userStringIndexMap[i]=e}if(e.getUserdataIdsList){const r=e.getUserdataIdsList();for(let e=t;e<=i;++e)this.userDataIndexMap[e]=r[e-t]}this.globalUserIdBuffers.push(e)}disposeBuffer(){this.globalUserIdBuffers.length=0,this.userDataIndexMap=null}getIndexByUserId(e){return this.userStringIndexMap[e]}getUserIdByIndex(e){return this.userIndexStringMap[e]}},r.BimTileUserDataTool=class{constructor(){this.userDataIndexMap={},this.keysList=null,this.valuesList=null,this.keyStringMap={},this.valueStringMap={}}destroy(){this.userDataIndexMap=null,this.keysList=null,this.valuesList=null,this.keyStringMap=null,this.valueStringMap=null}parseUserDataBuffer(e){this.keysList=e.getBlobHeader().getKeysList(),this.valuesList=e.getBlobHeader().getValuesList(),this.keysList.forEach(((e,t)=>{this.keyStringMap[e]=t})),this.valuesList.forEach(((e,t)=>{this.valueStringMap[e]=t})),e.getUserdataArrayList().map(((e,t)=>{const i=e.getValuesStringMap().getEntryList();let r={};i.map((e=>{r[e[0]]=e[1]})),this.userDataIndexMap[t]=r})),e=null}getUserDataByIndex(e){return this.userDataIndexMap[e]}getUserDataStringMapByIndex(e,t){return[this.keysList[e],this.valuesList[t]]}getUserDataIndexMapByString(e,t){if(!this.hasUserData())return;const i=this.getUserDataIndexKeyByString(e),r=this.getUserDataIndexValueByString(t);return void 0!==e&&void 0!==t?{key:i,value:r}:void 0}getUserDataIndexKeyByString(e){return this.keyStringMap[e]}getUserDataIndexValueByString(e){const t=this.valueStringMap;let i;return e instanceof Array?(i=[],e.forEach((e=>{void 0!==t[e]&&i.push(t[e])}))):i=t[e],i}hasUserData(){return this.keysList&&this.valuesList}},r.BimTileReader=class{constructor(){this.descriptor=new r.BimtileDescriptor,this.searchTreeManager=new r.BimTileSearchTreeManager,this.globalMaterialId=-1,this.globalUserdataId=-1,this.globalMaterialUrl=void 0,this.globalUserDataUrl=void 0,this.globalTileIdUrl=void 0,this.globalInstance=void 0,this.globalLodUrl=void 0,this.globalVisibilityUrl=void 0,this.globalPrecuttingTreeUrl=void 0,this.userIdTool=new r.BimTileUserIdTool,this.userDataTool=new r.BimTileUserDataTool,this.globalMaterialBuffer=null,this.globalUserdataBuffer=null,this.globalTileIdBuffer=null,this.globalPrecuttingTreeBuffer=null,this.referencedMeshCache={},this.tileIdMap={}}destroy(){this.descriptor.destroy(),this.descriptor=null,this.searchTreeManager.destroy(),this.searchTreeManager=null,this.userIdTool.destroy(),this.userIdTool=null,this.userDataTool.destroy(),this.userDataTool=null,this.globalMaterialBuffer=null,this.globalUserdataBuffer=null,this.globalPrecuttingTreeBuffer=null,this.globalMaterialUrl=void 0,this.globalUserDataUrl=void 0,this.globalTileIdUrl=void 0,this.globalInstance=void 0,this.globalPrecuttingTreeUrl=void 0,this.referencedMeshCache=null,this.globalTileIdBuffer=null,this.tileIdMap=null}getDescriptor(){return this.descriptor}getBuffer(e,t,i){return-1===t&&i===proto.BlockHeader.BlockType.BT_MATERIAL?this.globalMaterialBuffer:-1===t&&i===proto.BlockHeader.BlockType.BT_USERDATA?this.globalUserdataBuffer:-1===t&&i===proto.BlockHeader.BlockType.BT_VIEWTREE?this.globalPrecuttingTreeBuffer:e.getBuffer(t).content}getLineBuffer(e,t,i){return e.getLineBuffer(t).content}getOutlineBuffer(e,t,i){return e.getOutlineBuffer(t).content}getUserIdByIndex(e){return this.userIdTool.getUserIdByIndex(e)}getIndexByUserId(e){return this.userIdTool.getIndexByUserId(e)}getUserDataByIndex(e){return this.userDataTool.getUserDataByIndex(e)}getUserDataStringMapByIndex(e,t){return this.userDataTool.getUserDataStringMapByIndex(e,t)}getUserDataIndexMapByString(e,t){return this.userDataTool.getUserDataIndexMapByString(e,t)}getUserDataIndexKeyByString(e){return this.userDataTool.getUserDataIndexKeyByString(e)}getUserDataIndexValueByString(e){return this.userDataTool.getUserDataIndexValueByString(e)}parseSchemaProperties(e,t){if(void 0===e)return;this.layerKey=e.layerKey,this.layerValue=e.layerValue,this.globalMaterialUrl=e.globalMaterial?t+e.globalMaterial.content.url:void 0,this.globalUserDataUrl=e.globalUserdata?t+e.globalUserdata.content.url:void 0,this.globalTileIdUrl=e.globalTileID?t+e.globalTileID.content.url:void 0,this.globalInstance=e.instanceTiles?t+e.instanceTiles.content.url:void 0,this.globalLodUrl=e.groupTiles?t+e.groupTiles.content.url:void 0,this.globalVisibilityUrl=e.visibilityTiles?t+e.visibilityTiles.content.url:void 0;const i=e.globalUserID;i&&i.map((e=>{const i=t+e.content.url;this.userIdTool.addGlobalUserIdUrl(i)}));const r=e.globalNodeID;r&&r.map((e=>{const i=t+e.content.url;this.nodeIdTool.addGlobalNodeIdUrl(i,e.startPos)}));const a=e.globalNodeBox;a&&a.map((e=>{const i=t+e.content.url;this.nodeBoxTool.addGlobalNodeBoxUrl(i,e.startPos)}));const n=e.globalUserIDBox;n&&n.map((e=>{const i=t+e.content.url;this.userIdBoxTool.addGlobalUserIdBoxUrl(i,e.startPos)})),this.globalPrecuttingTreeUrl=e.globalInsPrecuttingTree?t+e.globalInsPrecuttingTree.content.url:void 0}getGlobalUserIdUrls(){return this.userIdTool.getGlobalUserIdUrls()}getGlobalNodeIdUrls(){return this.nodeIdTool&&this.nodeIdTool.getGlobalNodeIdUrls()}getGlobalNodeBoxUrls(){return this.nodeBoxTool&&this.nodeBoxTool.getGlobalNodeBoxUrls()}parseBlock(e,t,i){const a=t.node,n=t.type,s=(t.url,t.outline);let o=!0,l=0,d=[];a.bufferType=n;let h=0;const c=e.byteLength;for(a.buffer=r.Utils.isDefined(a.buffer)?a.buffer:{},a.lineBuffer=r.Utils.isDefined(a.lineBuffer)?a.lineBuffer:{},a.outlineBuffer=r.Utils.defaultValue(a.outlineBuffer,{});h<c;){const t=e.slice(h,h+4);let i=new Uint32Array(t)[0];h+=4;const c=new Uint8Array(e,h,i);h+=i;const p=proto.bimtile_pbf.BlockHeader.deserializeBinary(c);o&&p.getDataType(),i=p.getDataSize(),r.TilesUtil.max_uncompressed_blob_size;var u=new Uint8Array(e,h,i);if(h+=i,p.getCompressType()!=proto.bimtile_pbf.BlockHeader.CompressType.CT_NULL)return void console.warn("uncompress data into buffer");const m=p.getDataType();let f={};switch(m){case proto.BlockHeader.BlockType.BT_INDEX:const e=proto.bimtile_pbf.SearchTreeBlob.deserializeBinary(u);f.type=m,f.content=e,a.buffer[l]=f;break;case proto.BlockHeader.BlockType.BT_USERID:const t=proto.bimtile_pbf.UserIDBlob.deserializeBinary(u);if(n===r.TileContentType.DATA_GLOBAL_USER_ID){this.userIdTool.parseUserIdBuffer(t);break}f.type=m,f.content=t,a.buffer[l]=f;break;case proto.BlockHeader.BlockType.BT_MATERIAL:const i=proto.bimtile_pbf.MaterialBlob.deserializeBinary(u);if(f.type=m,f.content=i,n===r.TileContentType.DATA_GLOBAL_MATERIAL){this.globalMaterialBuffer=i;break}a.buffer[l]=f;break;case proto.BlockHeader.BlockType.BT_USERDATA:const o=proto.bimtile_pbf.UserdataBlob.deserializeBinary(u);if(n===r.TileContentType.DATA_GLOBAL_USER_DATA){this.userDataTool.parseUserDataBuffer(o);break}f.type=m,f.content=o,a.buffer[l]=f;break;case proto.BlockHeader.BlockType.BT_BUFFER:const d=proto.bimtile_pbf.BufferBlob.deserializeBinary(u);f.type=m,f.content=d,n===proto.BlockHeader.BlockType.BT_LINE?s?a.outlineBuffer[l]=f:a.lineBuffer[l]=f:a.buffer[l]=f;break;case proto.BlockHeader.BlockType.BT_MESH:const h=proto.bimtile_pbf.MeshBlob.deserializeBinary(u);f.type=m,f.content=h,a.buffer[l]=f;break;case proto.BlockHeader.BlockType.BT_POINT:const c=proto.bimtile_pbf.PointBlob.deserializeBinary(u);f.type=m,f.content=c,a.buffer[l]=f;break;case proto.BlockHeader.BlockType.BT_TILEID:const p=proto.bimtile_pbf.TileIDBlob.deserializeBinary(u);if(f.type=m,f.content=p,n===r.TileContentType.DATA_GLOBAL_TILE_ID){this.globalTileIdBuffer=p;break}a.buffer[l]=f;break;case proto.BlockHeader.BlockType.BT_INSTANCE:const g=proto.bimtile_pbf.InstanceBlob.deserializeBinary(u);f.type=m,f.content=g,a.buffer[l]=f;break;case proto.BlockHeader.BlockType.BT_LINE:const v=proto.bimtile_pbf.MeshBlob.deserializeBinary(u);f.type=m,f.content=v,n===proto.BlockHeader.BlockType.BT_LINE&&s?a.outlineBuffer[l]=f:a.lineBuffer[l]=f;break;case proto.BlockHeader.BlockType.BT_VIEWTREE:const y=proto.bimtile_pbf.ViewTree.deserializeBinary(u);if(f.type=m,f.content=y,n==r.TileContentType.DATA_GLOBAL_PRECUTTING_TREE){this.globalPrecuttingTreeBuffer=y;break}a.buffer[l]=f;break;default:return void console.warn("Parse unknow block faild! ")}o&&(o=!1),d[l]=l,l++}i&&i()}getBlockType(e){switch(e){case"MESH":return proto.bimtile_pbf.BlockHeader.BlockType.BT_MESH;case"POINT":return proto.bimtile_pbf.BlockHeader.BlockType.BT_POINT;case"INSTANCE":return proto.bimtile_pbf.BlockHeader.BlockType.BT_INSTANCE;case"LINE":return proto.bimtile_pbf.BlockHeader.BlockType.BT_LINE}}addSearchTreeBuffer(e,t,i){this.searchTreeManager.addSearchTreeBuffer(e,t,i)}getSearchTreeBuffer(){return this.searchTreeManager.getSearchTreeBuffer()}createTileIdMap(){if(!this.globalTileIdBuffer)return;const e=this.globalTileIdBuffer.getTilePathList(),t=this.globalTileIdBuffer.getTileIdsList();e.map(((e,i)=>{this.tileIdMap[e]=t[i]}))}getTileIdByPath(e){return this.tileIdMap[e]}createNodeInfoMap(){const e=this.userIdTool.getGlobalUserIdBuffers();for(let t of e)t.getNodeIdsList().map((e=>{const t=new r.BimTileNodeInfo;t.index=e.getNodeId(),t.blockId=e.getBlockId(),t.userId=e.getUserId(),t.userData=e.getUserdataId(),t.boundingBox=e.getBboxList();const i=e.getTileId();if(t.tileId=i,this.globalTileIdBuffer){const e=this.globalTileIdBuffer.getTileIdsList()[i];-1!==this.globalTileIdBuffer.getTilePathList()[e].indexOf("instance")&&(t.instanceOrNot=!0)}this.getDescriptor()._classifyNodeInfo(t)})),t=null;this.userIdTool.disposeBuffer()}clone(e){e.globalMaterialId=this.globalMaterialId,e.globalUserdataId=this.globalUserdataId,e.globalMaterialUrl=this.globalMaterialUrl,e.globalUserDataUrl=this.globalUserDataUrl,e.globalTileIdUrl=this.globalTileIdUrl,e.globalInstance=this.globalInstance,e.globalMaterialBuffer=this.globalMaterialBuffer,e.globalUserdataBuffer=this.globalUserdataBuffer,e.globalTileIdBuffer=this.globalTileIdBuffer,e.searchTreeManager=this.searchTreeManager,e.globalPrecuttingTreeUrl=this.globalPrecuttingTreeUrl,e.globalPrecuttingTreeBuffer=this.globalPrecuttingTreeBuffer}getPolygonOutLinePathByUserId(e){if(!this.globalUserIDBuffer)return null;const t=this.getDescriptor().getNodeInfosByUserId(e);if(!t)return null;const i={MultiPolygoin:!0,PolygonWithHoles:!0,SimplePolygon:!0},r=this.getUserDataIndexKeyByString("polygonType");if(-1===r)return null;const a=this.globalUserdataBuffer.getBlobHeader().getValuesList(),n={};let s=!1;return t.forEach((e=>{const t=e.userData,o=tileReader.getUserDataByIndex(t);if(!o||void 0===o[r])return;const l=o[r],d=a[l];if(void 0===d||!i[d])return;const h=this.getTilePathByTileId(e.tileId);h&&(n[h]||(n[h]={}),n[h]={tileId:e.tileId,polygonType:d},s=!0)})),s?n:null}getTilePathByTileId(e){const t=this.globalTileIdBuffer;if(!t)return;const i=t.getTileIdsList()[e];return t.getTilePathList()[i]}},r.BimTilesLoader=class{constructor(e){this.jsonLoader=new THREE.FileLoader,this.jsonLoader.setResponseType("json"),this.arrayBufferLoader=new THREE.FileLoader,this.arrayBufferLoader.setResponseType("arraybuffer"),this.taskRunner=new r.LoadTaskRunner(4),this.dataVersion=e.dataVersion,this._createTileReader(),this.batchMergeEnabled=e.batchMergeEnabled,this.filter=e.filter,this.modelExplosion=e.modelExplosion,this.wireFrameVisibilityOption=e.wireFrameVisibilityOption,this.materialManager=e.materialManager;const t={batchMergeEnabled:e.batchMergeEnabled,delayLoadTexture:e.delayLoadTexture,materialManager:this.materialManager,renderFunction:e.renderFunction,isShpPoint:e.isShpPoint};this.bimTileParser={},this.bimTileParser[r.TileContentType.DATA_MESH]=new r.BimTileMeshBlobParser(t),this.bimTileParser[r.TileContentType.DATA_CMPT]=this.bimTileParser[r.TileContentType.DATA_MESH],this.bimTileParser[r.TileContentType.DATA_INSTANCE]=new r.BimTileInstanceParser(t),delete t.isShpPoint,this.bimTileParser[r.TileContentType.DATA_POINT]=new r.BimTilePointBlobParser(t),this.bimTileOutlineBlobParser=new r.BimTileOutlineBlobParser(t),this.bimTileLineBlobParser=new r.BimTileLineBlobParser(t),this.batchedWireframeManager=new r.BimTileBatchedWireframeManager(this),this.instancedWireframeManager=new r.BimTileInstancedWireframeManager(this),this.batchedMeshManager=new r.BimTileBatchedMeshManager(this),this.instancedMeshManager=new r.BimTileInstancedMeshManager(this),this._rootUrl=void 0,this.sceneState=e.sceneState,this.userIdMapIndices={},this.pbfNodeInfoMap={},this._enableBorderLine=e.enableBorderLine,this.disableUserData=e.disableUserData,this.indexInfoMap={},this.selectionMeshIdSet={},this.lastSelectionMeshIdSet={},this.CMPTUrlMap={},this.usePrecuttingData=!0,this.rootViewNode=void 0,this.insTileMap=void 0}destroy(){this.globalIndexId=null,this.globalMaterialId=null,this.globalUserdataId=null,this.jsonLoader=null,this.arrayBufferLoader=null,this.taskRunner=null,this.tileReader.destroy(),this.tileReader=void 0,this.bimTileParser[r.TileContentType.DATA_MESH].destroy(),this.bimTileParser[r.TileContentType.DATA_INSTANCE].destroy(),this.bimTileParser[r.TileContentType.DATA_POINT].destroy(),this.bimTileLineBlobParser.destroy(),this.bimTileLineBlobParser=void 0,this.bimTileOutlineBlobParser.destroy(),this.bimTileOutlineBlobParser=void 0,this.bimTileParser=void 0,this._rootUrl=void 0,this.sceneState=null,this.userIdMapIndices=null,this.materialManager=null,this.batchedWireframeManager.destroy(),this.instancedWireframeManager.destroy(),this.batchedMeshManager.destroy(),this.instancedMeshManager.destroy(),this.batchedWireframeManager=null,this.instancedWireframeManager=null,this.batchedMeshManager=null,this.instancedMeshManager=null,this.pbfNodeInfoMap=null,this._enableBorderLine=void 0,this.wireFrameVisibilityOption=null,this.indexInfoMap=null,this.noUserDataMeshNodeInfoMap=null,this.noUserDataInstanceNodeInfoMap=null,this.selectionMeshIdSet=null,this.lastSelectionMeshIdSet=null,this.CMPTUrlMap={},this.rootViewNode=void 0,this.insTileMap=void 0}set rootUrl(e){this._rootUrl=e}get rootUrl(){return this._rootUrl}_createTileReader(){r.BimTilesVersionControl.isVersion_2(this.dataVersion)?this.tileReader=new r.BimTilesNewReader:this.tileReader=new r.BimTileReader}getDescriptor(){return this.tileReader.getDescriptor()}loadJson(e,t,i){e=r.RequestSpliter.splitByUrlMd5(e);const a=()=>{this.taskRunner.push(this.jsonLoader,e,t,(function(t){r.EnableStorage&&r.storageManager.addBimtiles(JSON.stringify(t),e).catch((e=>{})),i&&i(t)}))};r.EnableStorage?r.storageManager.getBimtiles(e).then((e=>i&&i(JSON.parse(e)))).catch((e=>{a()})):a()}loadJsonImmediately(e,t,i){e=r.RequestSpliter.splitByUrlMd5(e);const a=()=>{this.jsonLoader.load(e,(function(i){r.EnableStorage&&r.storageManager.addBimtiles(JSON.stringify(i),e).catch((e=>{})),t(i)}),void 0,(function(){i&&i(event)}))};r.EnableStorage?r.storageManager.getBimtiles(e).then((e=>t(JSON.parse(e)))).catch((e=>{a()})):a()}loadArrayBuffer(e,t,i){this.taskRunner.push(this.arrayBufferLoader,e,t,(function(e){i&&i(e)}))}loadArrayBufferDirectly(e,t){const i=()=>{this.arrayBufferLoader.load(e,(function(i){t(i),r.EnableStorage&&r.storageManager.addBimtiles(i,e).catch((e=>{}))}))};r.EnableStorage?r.storageManager.getBimtiles(e).then((e=>t(e))).catch((e=>{i()})):i()}loadCMPTArrayBufferImmediately(e,t,i){void 0===this.CMPTUrlMap[e]?(this.CMPTUrlMap[e]={state:r.TileContentState.LOADING,buffer:null,callbacks:[]},this.loadArrayBufferImmediately(e,t,i)):this.CMPTUrlMap[e].state===r.TileContentState.READY?t(this.CMPTUrlMap[e].buffer):this.CMPTUrlMap[e].state===r.TileContentState.LOADING&&this.CMPTUrlMap[e].callbacks.push(t)}loadArrayBufferImmediately(e,t,i){const a=i=>{this.CMPTUrlMap[e]&&(this.CMPTUrlMap[e].state=r.TileContentState.READY,this.CMPTUrlMap[e].buffer=i,this.CMPTUrlMap[e].callbacks.map((e=>{e&&e(i)}))),t(i)},n=()=>{this.arrayBufferLoader.load(e,(t=>{a(t),r.EnableStorage&&r.storageManager.addBimtiles(t,e).catch((e=>{}))}),void 0,(()=>{i&&i(event)}))};r.EnableStorage?r.storageManager.getBimtiles(e).then((e=>a(e))).catch((e=>{n()})):n()}loadBlock(e,t,i,r){const a=this.tileReader,n={node:t,type:i,url:e};this.loadArrayBufferDirectly(e,(e=>{a.parseBlock(e,n,r)}))}loadUserIdResources(e,t){var i=this.tileReader;let a=1,n=()=>{a--,a<=0&&t()};i.globalUserDataUrl&&(a++,this.loadBlock(i.globalUserDataUrl,e,r.TileContentType.DATA_GLOBAL_USER_DATA,(()=>{n()})));const s=i.getGlobalUserIdUrls();if(s){const t=s.length;a+=t,s.map((t=>{this.loadBlock(t,e,r.TileContentType.DATA_GLOBAL_USER_ID,(()=>{n()}))}))}const o=i.getGlobalNodeIdUrls();if(o){const t=o.length;a+=t,o.map((t=>{this.loadBlock(t,e,r.TileContentType.DATA_GLOBAL_NODE_ID,(()=>{n()}))}))}const l=i.getGlobalNodeBoxUrls();if(l){const t=l.length;a+=t,l.map((t=>{this.loadBlock(t,e,r.TileContentType.DATA_GLOBAL_NODE_BOX,(()=>{n()}))}))}i.globalTileIdUrl&&(a++,this.loadBlock(i.globalTileIdUrl,e,r.TileContentType.DATA_GLOBAL_TILE_ID,(()=>{n()}))),n()}loadGlobalResources(e){const{tileReader:t}=this;return new Promise((i=>{r.Utils.isDefined(t.globalMaterialUrl)?this.loadBlock(t.globalMaterialUrl,e,r.TileContentType.DATA_GLOBAL_MATERIAL,(()=>{i()})):i()}))}loadInstanceResources(e){const{tileReader:t}=this;if(!t.globalInstance)return;const i=this;return new Promise(((a,n)=>{const s=t.globalInstance;i.loadJsonImmediately(s,(t=>{const n=s.slice(0,s.lastIndexOf("/")+1),o=e.createTile(n,t);if(o.localIndexList&&o.localIndexList.length>0){const e=o.localIndexList.length;for(let t=0;t<e;++t){const e=o.localIndexList[t];i.addSearchTree(e.url,e.box)}}i.GetInstanceMap(o),o.subBimTilesType=r.EnumSubBimTileType.SubBt_instance,o._childrenState=r.TileContentState.READY,a(o)}),(()=>{n("can not load intance root json")}))}))}GetInstanceMap(e){0!=this.usePrecuttingData&&(this.insTileMap={},this.GetInstanceTileMap(this.insTileMap,e),0==Object.keys(this.insTileMap).length&&console.log("instance map build faild."))}GetInstanceTileMap(e,t){const i=t.contentUrl;if(void 0!==i){const r=i.split("_");if(3==r.length){const i=Number.parseInt(r[1]);e[i]=t,t.insTileId=i}}const r=t.childrenTree;for(let t=0;t<r.length;t++){const i=r[t];this.GetInstanceTileMap(e,i)}}loadInstancePrecuttingTreeResources(e){if(!this.usePrecuttingData)return;const{tileReader:t}=this;return t.globalPrecuttingTreeUrl?new Promise((i=>{this.loadBlock(t.globalPrecuttingTreeUrl,e,r.TileContentType.DATA_GLOBAL_PRECUTTING_TREE,(()=>{this._parseInstancePrecuttingTree(t.globalPrecuttingTreeBuffer,i())}))})):void 0}loadLodResources(e){const{tileReader:t}=this;if(!t.globalLodUrl)return;const i=this;return new Promise(((a,n)=>{const s=t.globalLodUrl;i.loadJsonImmediately(s,(t=>{t.root.visibilityPriority=9;const n=s.slice(0,s.lastIndexOf("/")+1),o=e.createTile(n,t);if(o.localIndexList&&o.localIndexList.length>0){const e=o.localIndexList.length;for(let t=0;t<e;++t){const e=o.localIndexList[t];i.addSearchTree(e.url,e.box)}}o._childrenState=r.TileContentState.READY,a(o)}),(()=>{n("can not load group root json")}))}))}loadVisibilityResources(e){const{tileReader:t}=this;if(!t.globalVisibilityUrl)return;const i=this;return new Promise(((a,n)=>{const s=t.globalVisibilityUrl;i.loadJsonImmediately(s,(t=>{const n=s.slice(0,s.lastIndexOf("/")+1);t.root.visibilityPriority=1;const o=e.createTile(n,t);if(o.localIndexList&&o.localIndexList.length>0){const e=o.localIndexList.length;for(let t=0;t<e;++t){const e=o.localIndexList[t];i.addSearchTree(e.url,e.box)}}o.subBimTilesType=r.EnumSubBimTileType.SubBt_visibility,o._childrenState=r.TileContentState.READY,a(o)}),(()=>{n("can not load visibility root json")}))}))}parseTileContent(e,t){this.bimTileParser[e.contentType].parseBlobs(this,e,t)}parseTileLineContent(e,t){this.bimTileLineBlobParser.parseBlobs(this,e,t)}parseTileOutlineContent(e,t){this.bimTileOutlineBlobParser.parseBlobs(this,e,t)}setBorderLineVisible(e){this._enableBorderLine=e}isBorderLineVisible(){return this._enableBorderLine}praseWireFrameVisibilityOption(e){if(!0===e)return void(this.wireFrameVisibilityOption=!0);if(!0===e.condition.all)return void(this.wireFrameVisibilityOption=e.isVisible);this.wireFrameVisibilityOption={ids:Object.create(null)},this.wireFrameVisibilityOption.isVisible=e.isVisible;const t=e.condition.ids;let i=e=>{e.map((e=>{this.wireFrameVisibilityOption.ids[e]=!0}))};void 0!==t&&i(this.filter._parseIds(t));const r=e.condition.objectData;void 0!==r&&i(this.filter.getMatchIndexes(r))}updateWireFrameVisibilityOption(e){this.praseWireFrameVisibilityOption(e)}addMeshIdMap(e,t){this.batchedMeshManager.addMeshIdMap(e,t)}getMeshNodeById(e){return this.batchedMeshManager.getMeshNodeById(e)}disposeMeshNodeById(e){this.batchedMeshManager.disposeMeshNodeById(e)}addInstanceMeshIdMap(e,t,i,r){this.instancedMeshManager.addInstanceMeshIdMap(e,t,i,r)}getInstanceMeshNodeById(e){return this.instancedMeshManager.getInstanceMeshNodeById(e)}disposeInstanceMeshNodeById(e){this.instancedMeshManager.disposeInstanceMeshNodeById(e)}addInstanceInfo(e,t){this.instancedMeshManager.addInstanceInfo(e,t)}getInstanceInfoById(e){return this.instancedMeshManager.getInstanceInfoById(e)}addLineNodeById(e,t,i){this.batchedWireframeManager.addLineNodeById(e,t,i)}addInstanceLineNodeById(e,t){this.instancedWireframeManager.addInstanceLineNodeById(e,t)}getLineNodeById(e,t){return this.batchedWireframeManager.getLineNodeById(e,t)}getInstanceLineNodeById(e){return this.instancedWireframeManager.getInstanceLineNodeById(e)}disposeLineNodeById(e){this.batchedWireframeManager.disposeLineNodeById(e)}disposeInstanceLineNodeById(e){this.instancedWireframeManager.disposeInstanceLineNodeById(e)}addUserIdMapIndices(e,t){e.map((e=>{const i=e.userId;void 0===this.userIdMapIndices[i]?this.userIdMapIndices[i]=[{meshId:t,indexId:e.index}]:this.userIdMapIndices[i].push({meshId:t,indexId:e.index})}))}addSearchTree(e,t){this.disableUserData?this.indexInfoMap[e]=t:this.addSearchTreeUrl(e,t)}addSearchTreeUrl(e,t,i){let r={};this.loadBlock(e,r,proto.bimtile_pbf.BlockHeader.BlockType.BT_INDEX,(()=>{this.tileReader.addSearchTreeBuffer(e,t,r.buffer[0].content),i&&i()}))}recoverIndexInfo(e){let t=Object.keys(this.indexInfoMap).length;if(0!==t)for(const i in this.indexInfoMap)this.addSearchTreeUrl(i,this.indexInfoMap[i],(()=>{t--,0===t&&e&&e()}));else e&&e()}recoverNodeInfo(){this.batchedMeshManager.recoverNodeInfo(),this.instancedMeshManager.recoverNodeInfo()}addNoUserDataMeshNodeInfo(e,t,i){this.batchedMeshManager.addNoUserDataMeshNodeInfo(e,t,i)}addNoUserDataInstanceNodeInfo(e,t,i){this.instancedMeshManager.addNoUserDataInstanceNodeInfo(e,t,i)}patchMeshNodeInfo(e,t,i){this.batchedMeshManager.patchMeshNodeInfo(e,t,i)}patchInstanceNodeInfo(e,t,i){this.instancedMeshManager.patchInstanceNodeInfo(e,t,i)}dealLineMeshVisible(e){this.disableUserData?!0===this.wireFrameVisibilityOption?e.visible=this.isBorderLineVisible():e.visible=!1:this.batchedWireframeManager.dealLineMeshVisible(e)}recoverLineNode(){this.batchedWireframeManager.recoverLineNode(),this.instancedWireframeManager.recoverLineNode()}loadPolygonOutLine(e,t){const i=this,r=this.tileReader,a=r.getIndexByUserId(e);if(void 0===a)return void t(null);const n=r.getPolygonOutLinePathByUserId(a);if(!n)return void t(null);const s=Object.keys(n),o=this.rootUrl,l=[];s.forEach((e=>{const t=new Promise(((t,i)=>{this.loadArrayBufferImmediately(o+e,(function(i){t({buffer:i,polygonType:n[e].polygonType,tileId:n[e].tileId})}),(function(){i()}))}));l.push(t)})),Promise.all(l).then((e=>{i._parsePolygonOutLineBlobs(e,(function(e){const r=[];e.forEach((e=>{const t=i._getPolygonOutLineData(e,a);r.push(t)})),t(r),console.log(JSON.stringify(r))}))})).catch((e=>{console.log(e)}))}_parsePolygonOutLineBlobs(e,t){const i=this.tileReader,r=this.bimTileOutlineBlobParser,a=[],n=this;e.forEach((e=>{const t={buffer:{},contentType:"LINE",contentId:e.tileId,contentTypeBufferOnly:!0,matrix:new THREE.Matrix4,polygonType:e.polygonType,getLineBuffer:function(e){return this.lineBuffer[e]},computeLineNodeCount:function(){},getOutlineContentUrl:function(){}},s=i.getBlockType(t.contentType),o={node:t,type:s},l=new Promise(((a,s)=>{i.parseBlock(e.buffer,o,(()=>{r.parseBlobs(n,t,(function(){a(t)}))}))}));a.push(l)})),Promise.all(a).then((e=>{t(e)})).catch((e=>{console.log(e)}))}_getPolygonOutLineData(e,t){const i=e.geometry,r=e.indexGroups,a=e.matrix,n=i.getIndex().array,s=i.getAttribute("position").array,o=r[t],l=e.polygonType,d=[];return o.forEach((e=>{let t=e.indexStart,i=e.indexStart+e.indexCount;const r=n.slice(t,i);t=e.positionStart,i=e.positionStart+e.positionCount;const o=s.slice(t,i);t/=3,r.forEach((function(e,i,r){r[i]-=t}));const h=this._extractPolygonOutLinePositions(l,o,r,a);d.push(h)})),d}_extractPolygonOutLinePositions(e,t,i,r){const a=[];let n=new THREE.Vector3,s=new THREE.Vector3;for(let e=0,o=i.length-1;e<o;e+=2){const o=i[e],l=i[e+1];n.fromArray(t,3*o),s.fromArray(t,3*l),n.applyMatrix4(r),s.applyMatrix4(r),a.push({x:n.x,y:n.y,z:n.z}),a.push({x:s.x,y:s.y,z:s.z})}return a}getSelectionMeshId(){this.selectionMeshIdSet={};const e=this.sceneState.getSelectionSet(),t=this.tileReader.getDescriptor();for(const i in e){const e=this.tileReader.getIndexByUserId(i);t.getNodeInfoByUserIdCallback(e,(e=>{const t=e.nodeInfo;this.selectionMeshIdSet[t.parent]=!0}))}return this.selectionMeshIdSet}getLastSelectionMeshId(){return this.lastSelectionMeshIdSet=Object.assign(this.selectionMeshIdSet),this.lastSelectionMeshIdSet}clearSelectionMeshId(){this.selectionMeshIdSet={}}_parseInstancePrecuttingTree(e,t){let i={};e.getTreetype();const a=e.getViewNodesList(),n=e.getGeometriErrorList();for(let e=0;e<a.length;e++){const t=a[e],s=t.getNodeId(),o=t.getParentId(),l=new r.BimTileViewNode(s,i[o]);l.geometricError=n[l.depth],l.boundingBox=r.TilesUtil.getBox(t.getBboxList()),l.tileIds=t.getTileIdsList(),i[s]=l,0==e&&(this.rootViewNode=l)}i=void 0,t&&t()}},function(){let e=new THREE.Box3,t=new THREE.Vector3,i=new THREE.Vector3;class a extends r.AbstractTileset{constructor(e){super(e=r.Utils.defaultValue(e,{})),this._loader=e.loader,this._errorCoefficient=e.errorCoefficient,this.enableBorderLine=!0===e.enableBorderLine,this.disableUserData=e.disableUserData,this.materialManager=e.materialManager,this.geoErrScaleFactor=1,this.conditions=[],this._nodeManager=new r.BimTileNodeManager,this._geometryManager=new r.BimTileGeometryManager,this._boundingBox=new THREE.Box3,this._userIdReady=!1}destroy(){super.destroy(),this._loader=void 0,this.geoErrScaleFactor=void 0,this._geometryManager=null,this._nodeManager=null}get geometryManager(){return this._geometryManager}_clearDrawableOfTiles(){if(this._objectGroup){this._objectGroup.children.forEach((e=>{e.children.forEach((e=>{e.visible=!1}))}))}this._loader.filter.model.pickingManager.clearDrawable(),this.debugShowGeometricErrorHelper&&this.debugShowGeometricErrorHelper.hideAll()}loadChildrenOfTile(e,t,i){}_getEncodedTileNodeId(e){const t=`${e.getAbsoluteContentUrl()}_root`;return r.Utils.getEncodedString(t)}isCloneChildrenOnly(e){if(!e.contentTypeTile)return!1;const t=this._getEncodedTileNodeId(e);return!!this._nodeManager.getNode(t)}cloneChildrenOfTile(e){const t=this._getEncodedTileNodeId(e),i=this._nodeManager.getNode(t);return!!i&&(this._cloneChildTiles(this,i,e),!0)}createChildrenOfTile(e,t){const i=this._loader,a=e.getAbsoluteContentUrl(),n=a.slice(0,a.lastIndexOf("/")+1),s=this.createTile(n,t.context,e);if(s.nodeId=this._getEncodedTileNodeId(e),this._nodeManager.addNode(s),s._childrenState=r.TileContentState.READY,s.localIndexList.length>0){const e=s.localIndexList.length;for(let t=0;t<e;++t){const e=s.localIndexList[t];i.addSearchTree(e.url,e.box)}}}createTile(e,t,i){if(!t.root||!t.root.boundingVolume)return;t.properties&&(t.root.properties=t.properties);const r=this._createNewTile(this,i,t.root,e);return r.build(),r}_createNewTile(e,t,i,a){return new r.BimTileNode(e,t,i,a)}loadUserIdResources(e){var t=this._loader,i=t.tileReader;t.loadUserIdResources(this.root,(()=>{i.createNodeInfoMap(),t.loadGlobalUserIdBoxUrls&&t.loadGlobalUserIdBoxUrls((()=>{})),i.createTileIdMap(),this._userIdReady=!0,e&&e()}))}loadTileset(e,t,i){var a=this,n=this._loader,s=n.tileReader;n.loadJsonImmediately(e,(function(i){var o=e.slice(0,e.lastIndexOf("/")+1),l=a.createTile(o,i);l._childrenState=r.TileContentState.READY,s.parseSchemaProperties(i.properties,o),n.rootUrl=o;let d=1;n.loadGlobalResources(l).then((()=>{a.root=l,a._boundingBox.union(l.boundingBox),!0===a.disableUserData?m():a.loadUserIdResources((()=>{m()}))}));const h=n.loadInstanceResources(a);h&&(d++,h.then((e=>{l.childrenTree.push(e),l.geometricError<e.geometricError&&(l.geometricError=e.geometricError),a._boundingBox.union(e.boundingBox),m()})).catch((e=>{console.log(e)})));const c=n.loadInstancePrecuttingTreeResources(l);h&&c&&(d++,Promise.allSettled([h,c]).then((()=>{a._traversalController.subTraversalInsPrecut=new r.BimTilesetTraversalPrecut(n.rootViewNode,n.insTileMap),m()})).catch((e=>{console.log(e)})));const u=n.loadLodResources(a);u&&(d++,u.then((e=>{l.childrenTree.push(e),l.geometricError<e.geometricError&&(l.geometricError=e.geometricError),a._boundingBox.union(e.boundingBox),m()})).catch((e=>{console.log(e)})));const p=n.loadVisibilityResources(a);function m(){d--,0===d&&t(a)}p&&(d++,p.then((e=>{l.childrenTree.push(e),l.geometricError<e.geometricError&&(l.geometricError=e.geometricError),a._boundingBox.union(e.boundingBox),l._boundingBox.union(e.boundingBox),m()})).catch((e=>{console.log(e)})))}),(function(){i(a)}))}preUpdate(e){this.ready&&(this._userInputWorking&&e.viewer.inputStatusMonitor.needsStopUpdateScene()||this.processTiles(e))}isCheckChildrenPassSSE(){return!0}resetGeometryOwner(){this._geometryManager&&this._geometryManager.resetGeometryOwner()}getMaxGeoErrNode(e){var t=null,i=-1;for(var r of e)r.geometricError>i&&(i=r.geometricError,t=r);return t}updateFrameState(e){e.transformMatrixUpdated=!1,void 0!==e.transformMatrix&&e.transformMatrix.equals(this._transformMatrix)||(e.transformMatrixUpdated=!0,void 0===e.transformMatrix?e.transformMatrix=this._transformMatrix.clone():e.transformMatrix.copy(this._transformMatrix)),e.maximumScreenSpaceError=this.maximumScreenSpaceError,e.geoErrScaleFactor=this.geoErrScaleFactor*r.Tile.TileMath.unitScale}updateGlobalMatrix(e){this._objectGroup.matrix.copy(e),this._objectGroup.matrix.multiplyMatrices(e,this._transformMatrix),this._objectGroup.matrixAutoUpdate=!1,this._objectGroup.updateMatrixWorld(!0)}updateHomePositionWorld(r){const a=e.copy(this.root.boundingBox).applyMatrix4(r.transformMatrix).applyMatrix4(r.globalMatrix),n=a.getSize(i),s=Math.max(n.x,n.y,n.z);a.getCenter(t).sub(new THREE.Vector3(s,-s,-s)),r.cameraPositionWc=t.applyMatrix4(r.globalInverseMatrix)}updateMaximumScreenSpaceError(e){this.updateHomePositionWorld(e),e.geoErrScaleFactor=this.geoErrScaleFactor*r.Tile.TileMath.unitScale,this.maximumScreenSpaceError=this.maximumScreenSpaceError*this._errorCoefficient}setMaximumScreenSpaceError(e){this.maximumScreenSpaceError=e}getMaximumScreenSpaceError(){return this.maximumScreenSpaceError}getGeoErrScaleFactor(){return this.geoErrScaleFactor}setGeoErrScaleFactor(e){this.geoErrScaleFactor=e}statisticsMeshInformation(){var e={meshCount:0,visibleCount:0},t=this._objectGroup.children;e.meshCount=t.length;for(var i=0,a=t.length;i<a;i++){var n=t[i];r.Utils.isGroupObject(n)&&n.visible&&e.visibleCount++}return e}explode(){let e=this._selectedTiles;for(let t=0,i=e.length;t<i;t++)e[t].explode()}updateOnDemandConditions(e){this.onDemandManager.updateOnDemandConditions(e)}unloadTile(e){super.unloadTile(e),r.Utils.defined(this.geometryManager)&&this.geometryManager.removeGeometryById(e.nodeId)}_createNewTileset(){return new a}clone(e,t){r.Utils.defined(e)||(e=this._createNewTileset()),super.clone(e),e._errorCoefficient=this.errorCoefficient,e.sseThreshold=this.sseThreshold,e.geoErrScaleFactor=this.geoErrScaleFactor,e._loader=t,e._loader.rootUrl=this._loader.rootUrl,e._nodeManager=this._nodeManager,e._geometryManager=this._geometryManager;const i=this._root.clone(e,void 0);return e._root=i,this._cloneChildTiles(e,this._root,i),this._loader.tileReader.clone(e._loader.tileReader),e._loader.tileReader.createNodeInfoMap(),e._loader.pbfNodeInfoMap=this._loader.pbfNodeInfoMap,e}_cloneChildTiles(e,t,i){const a=t.childrenTree;a.length&&(i._childrenState=r.TileContentState.READY,a.forEach((t=>{const r=t.clone(e,i);this._cloneChildTiles(e,t,r)})))}debugShowGeometricError(e){this._debugShowGeometricError=e}needLoadChildrenOfTile(e){return void 0!==e.detailLevel&&e.detailLevel<=2?e.childrenUnload&&e.contentReady:e.childrenUnload}traverseContentAvailableNode(e){let t=i=>{i.childrenTree.forEach((i=>{!0===i.contentAvailable&&e&&e(i),t(i)}))};t(this._root)}traverseContentReadyNode(e){let t=i=>{i.childrenTree.forEach((i=>{!0===i.contentReady&&e&&e(i),t(i)}))};t(this._root)}getRootGeoErrDistance(e){return e*this.root.geometricError/this.maximumScreenSpaceError}_createTraversalController(){this._traversalController=new r.BimTilesetTraversal}updateTiles(e){let t=!1;const i=this.statistics,r=this._selectedTiles,a=this._loader.filter.model.pickingManager;a.beforeUpdate();for(let a=0,n=r.length;a<n;++a){let n=r[a];n.update(e),t=n.needsLoading||t,i.incrementSelectionCount(n.content),++i.selected}a.afterUpdate(),this.debugShowStatistics(e),t&&e.afterRenderFns.push((function(){}))}isOutlineEnabled(){return this._loader.isBorderLineVisible()}}r.BimTileset=a}(),r.BimTileOnDemandManager=class{constructor(e,t){this.model=e,this._filter=e.filter,this._onDemand=e._onDemand,this._hasLayerInfo=e._hasLayerInfo,this._idMap={},this.demandCount=0}destroy(){this._filter.destroy(),this._filter=null,this._onDemand=void 0,this._hasLayerInfo=void 0,this._conditions=null,this._idMap=null,this.demandCount=void 0}updateOnDemandConditions(e){this._conditions=void 0===e?[]:e,this._conditions=e,this.demandCount++}onDemandJudgment(e){if(!1===this._onDemand)return!1;if(!0===this._onDemand&&!1===this._hasLayerInfo)return!0;if(0===Object.keys(e.layerInfo).length)return!1;const t=this._conditions.length;let i=!0;for(let r=0;r<t;++r){const t=this._conditions[r];let a=!0;for(let i in t)if(e.layerInfo[i]&&t[i]!==e.layerInfo[i]){a=!1;break}a&&(i=!1)}return i}instanceApply(e){if(e.demandCount===this.demandCount)return;const t=e.userIndexMap,i=this.model.getDescriptor().getInstancedNodeInfos();this._filter._updateInstanceDemandMaterial(e,t,i),e.demandCount=this.demandCount}get onDemand(){return this._onDemand}set onDemand(e){this._onDemand=e}get hasLayerInfo(){return this._hasLayerInfo}set hasLayerInfo(e){this._hasLayerInfo=e}get conditions(){return this._conditions}set conditions(e){this._conditions=e}get idMap(){return this._idMap}},function(){class e extends r.FilterManager{constructor(e){super(),r.BimTilesVersionControl.isVersion_2(e.dataVersion)?this.objectInfoManager=new r.BimtileObjectInfoManager2:this.objectInfoManager=new r.BimtileObjectInfoManager,this.model=e,this.mergedMeshesStates={},this.blinkMaterials={},this.idCacheMap=new Map,this.stateChangedRenderer=r.EnumChangedState.START,this.stateWireFrameChangedRenderer=r.EnumChangedState.START,this._tileLoadedStateChanged=!1}destroy(){this.mergedMeshesStates=null,this.blinkMaterials=null,super.destroy(),this.model=null}setTileReader(){this.objectInfoManager.setTileReader(this.model.tilesLoader.tileReader)}pushBack(e,t){super.pushBack(e,t),this.enableStateChanged()}pushBackWithIds(e,t,i){super.pushBackWithIds(e,t,i),this.enableStateChanged()}addToOverrideListWithOpacityByConditions(e,t,i,r){var a=this;if(i instanceof Array){var n=this._parseConditions(i);this.objectInfoManager.matchConditions(n,(function(e,t,i,s){s&&a.findMaterialByIds(e,t,n,r,i)}),e,t)}}findMaterialByIds(e,t,i,a,n){var s=e.getModel(t);let o=[];for(let e=0;e<n.length;e++){let t=!0;const i=n[e];let r=null,l=null;const d=s.getFilter()._parseIds([i])[0],h=s.getFilter().getObjectInfoManager().getMaterial(d);if(h)r=h,r.originOpacity=h.opacity,r.name.indexOf("_opacity")<0&&(t=!1),r.map&&(l=r.map);else{const e=s.getNodeInfosByUserIndex(i);if(e&&e.length>0){l=null;for(let t=0;t<e.length;t++){const i=e[t],a=s.getMaterialByMaterialId(i.materialId,i);if(a&&a.map){l=a.map,r=a;break}a&&a.dispose()}const t=e[0];r||(r=s.getMaterialByMaterialId(t.materialId,t))}}if(r){const e=r.color.getHex();r.dispose();let i={color:e,opacity:a,useVertexColor:r.vertexColors};t&&(i.setByOpacity=t),l&&(i.map=l),o.push(i),l&&l.dispose(),l=null}}let l=[];for(let e=0;e<o.length;e++){let t=this._filterImpl.getMaterialNameByColor(o[e]),i=this._filterImpl.getMaterialByName(t);l.push(i)}var d=new r.OverrideConditionFA(!0,null);d.setOpacity(a),d.conditions=i,this.pushBackByMaterials(d,l),this.enableStateChanged()}addToOverrideListWithAllIdsByColor(e,t){const i=this._parseIds(e);super.addToOverrideListWithAllIdsByColor(i,t)}isTileLoadedStateChanged(){return this._tileLoadedStateChanged}disableTileLoadedStateChanged(){this._tileLoadedStateChanged=!1}enableTileLoadedStateChanged(){this._tileLoadedStateChanged=!0}_parseIds(e){let t=[];const i=e.length;for(let r=0;r<i;++r){const i=e[r],a=this._getIndexByUserId(i);void 0!==a&&t.push(a)}return t}_parseIndexIds(e){let t=[];const i=e.length;for(let r=0;r<i;++r){const i=e[r],a=this.model.getRealUserId(i);t.push(a)}return t}_parseConditions(e){let t=[];const i=e.length;for(let r=0;r<i;++r){const i=e[r],a={};for(const e in i){const t=this.model.tilesLoader.tileReader.getUserDataIndexMapByString(e,i[e]);t&&(a[t.key]=t.value)}t.push(a)}return t}loadState(e){let t=!1;if(e.actions)for(const i of e.actions){let e=i.ids;if(!(e&&e.length>0))continue;t=!0;const r=e.map((e=>this._getIndexByUserId(e)));i.ids=r}if(e.isolateAction){const i=e.isolateAction.ids;if(i&&i.length>0){const r=i.map((e=>this._getIndexByUserId(e)));e.isolateAction.ids=r,!0===e.isolateAction.isolateHide&&(t=!0)}}super.loadState(e,this),t&&this.enableWireFrameStateChanged()}hideAll(){super.hideAll(),this.enableWireFrameStateChanged()}showAll(){super.showAll(),this.enableWireFrameStateChanged()}hideByIds(e){const t=this._parseIds(e);super.hideByIds(t),this.enableWireFrameStateChanged()}hideByConditions(e){const t=this._parseConditions(e);super.hideByConditions(t),this.enableWireFrameStateChanged()}hideOthersByConditions(e){const t=this._parseConditions(e);super.hideOthersByConditions(t),this.enableWireFrameStateChanged()}getMatchIndexes(e){const t=this._parseConditions(e);return super.getMatchIds(t)}getMatchIds(e){return this._parseIndexIds(this.getMatchIndexes(e))}addToFrozenList(e){const t=this._parseIds(e);super.addToFrozenList(t)}removeFromFrozenList(e){const t=this._parseIds(e);super.removeFromFrozenList(t)}setFrozenList(e){const t=this._parseIds(e);super.setFrozenList(t)}setFrozenConditions(e){const t=this._parseConditions(e);super.setFrozenConditions(t)}getFrozenConditions(){return super.getFrozenConditions()}addToIdList(e,t){const i=this._parseIds(t);super.addToIdList(e,i)}setIdList(e,t){const i=this._parseIds(t);super.setIdList(e,i)}removeFromIdList(e,t){const i=this._parseIds(t);super.removeFromIdList(e,i)}addToOverrideList(e,t,i){const r=this._parseIds(t);super.addToOverrideList(e,r,i)}removeFromOverrideList(e,t){const i=this._parseIds(t);super.removeFromOverrideList(e,i)}setOverrideList(e,t,i){const r=this._parseIds(t);super.setOverrideList(e,r,i)}addToOverrideListByColor(e,t){const i=this._parseIds(e);super.addToOverrideListByColor(i,t)}addToOverrideListByConditions(e,t){const i=this._parseConditions(e);super.addToOverrideListByConditions(i,t)}addToOverrideListByMaterial(e,t){const i=this._parseConditions(e);super.addToOverrideListByMaterial(i,t)}addToOverrideListByMaterialAndId(e,t){const i=this._parseIds(e);super.addToOverrideListByMaterialAndId(i,t)}setOverrideListByColor(e,t,i){const r=this._parseIds(t);super.setOverrideListByColor(e,r,i)}addToOpacityListByConditions(e,t){const i=this._parseConditions(e),r=this;this.getObjectInfoManager().matchConditions(i,((e,i)=>{if(i){for(var a in this.enableStateChanged(),e){var n=e[a];e[a]=r.model.tilesLoader.tileReader.getUserIdByIndex(n)}t(e,i)}}))}removeOpacityListByConditions(e,t){const i=this._parseConditions(e);this.getObjectInfoManager().matchConditions(i,((e,i)=>{if(i){for(var r in this.enableStateChanged(),e){var a=e[r];e[r]=scope.model.tilesLoader.tileReader.getUserIdByIndex(a)}t(e,i)}}))}addToLocalClippingList(e,t,i,r){super.addToLocalClippingList(e,t,i,r),this.enableWireFrameStateChanged()}addToLocalClippingListByConditions(e,t){const i=this._parseConditions(e);this.getObjectInfoManager().matchConditions(i,((e,i)=>{if(i){for(var r in this.enableStateChanged(),this.enableWireFrameStateChanged(),e){var a=this.model.tilesLoader.tileReader.getUserIdByIndex(e[r]);e[r]=a}t(e,i)}}))}addToOverrideListForWireFrameByColor(e,t){const i=this._parseIds(e);super.addToOverrideListForWireFrameByColor(i,t),this.decreaseStateChanged(),this.enableWireFrameStateChanged()}addToOverrideListForAllWireFrameByColor(e,t){const i=this._parseIds(e);super.addToOverrideListForAllWireFrameByColor(i,t),this.decreaseStateChanged(),this.enableWireFrameStateChanged()}addToOverrideListForWireFrameByConditions(e,t){const i=this._parseConditions(e);super.addToOverrideListForWireFrameByConditions(i,t),this.decreaseStateChanged(),this.enableWireFrameStateChanged()}getVisibleComponentSet(e){let t={};const i=Object.keys(e),r=this._parseIds(i);for(var a=0;a<r.length;a++)this._isVisible({name:r[a]})&&(t[i[a]]=!0);return t}addToIsolateList(e,t){const i=this._parseIds(e);super.addToIsolateList(i,t),"HideOthers"==t&&this.enableWireFrameStateChanged()}removeFromIsolateList(e,t){const i=this._parseIds(e);super.removeFromIsolateList(i,t)}setIsolateList(e,t){const i=this._parseIds(e);super.setIsolateList(i,t)}removeFromIsolateList(e,t){const i=this._parseIds(t);super.removeFromIsolateList(e,i)}setIsolateConditions(e,t){const i=this._parseConditions(e);super.setIsolateConditions(i,t),t===r.EnumIsolateState.HIDDEN_OTHERS&&this.enableWireFrameStateChanged()}getIsolateConditions(){super.getIsolateConditions()}setConditions(e,t){const i=this._parseConditions(t);super.setConditions(e,i)}getConditions(){super.getConditions()}showByIds(e){const t=this._parseIds(e);super.showByIds(t),this.enableWireFrameStateChanged()}showByConditions(e){const t=this._parseConditions(e);super.showByConditions(t),this.enableWireFrameStateChanged()}makeTranslucentByIds(e){const t=this._parseIds(e);super.makeTranslucentByIds(t)}makeTranslucentByConditions(e){const t=this._parseConditions(e);super.makeTranslucentByConditions(t)}makeTranslucentOthersByIds(e){const t=this._parseIds(e);super.makeTranslucentOthersByIds(t)}opaqueAll(){super.opaqueAll()}opaqueByIds(e){const t=this._parseIds(e);super.opaqueByIds(t)}opaqueByConditions(e){const t=this._parseConditions(e);super.opaqueByConditions(t)}deactivateByIds(e){const t=this._parseIds(e);this.objectInfoManager.deactivateByIds(t),this.observerForSceneState&&this.observerForSceneState(e)}getInactivatedIdMap(){if(!0===this.objectInfoManager.bIsInactivateAll)return{all:!0};let e={};const t=this._parseIndexIds(this.objectInfoManager.inactivatedIds);return 0===t.length?{}:(t.map((t=>{e[t]=!0})),e)}isComponentUserIndexActive(e){return super.isComponentActive(e)}isComponentActive(e){const t=this._getIndexByUserId(e);return super.isComponentActive(t)}_isPickable(e){const t=e.userId;return this.isComponentUserIndexActive(t)&&!this.objectInfoManager.isFrozen(t)}getBlinkMaterials(){let e=[];for(const t in this.blinkMaterials){const i=this.blinkMaterials[t];for(const t in i)e.push(i[t])}return e}_updateFilterManager(){const e=this.model.getAllNodeInfos();if(0!==e[0].size||0!==e[1].size){var t={};t[this.model.id]=e,this.reinitFilterManager(t)}}initFilterManager(e){this.objectInfoManager.init(e[this.model.id])}reinitFilterManager(e){this.objectInfoManager.reinit(e[this.model.id])}clearFilterManager(){this.objectInfoManager.clearData()}resetWireFrameNodeStates(e){e.traverse((e=>{if("LineSegmentsEx"!==e.type)return;e.material=[e.material[0]];let t=e.geometry;t.clearGroups(),t._visible=!0,t.addGroup(0,t.index.count,r.Model.EnumFilterState.NONE)}))}resetStandardNodeStates(e){e.traverse((e=>{if("MeshEx"!==e.type&&"LineSegmentsEx"!==e.type)return;e.material=[e.material[0]];let t=e.geometry;t.clearGroups(),t._visible=!0,t.addGroup(0,t.index.count,r.Model.EnumFilterState.NONE)}))}_needsUpdate(e){return 0!==e.blinkUserIdSetObject.size||0!==e.hoverUserIdSetObject.size||0!==e.clippingUserIdSetObject.size||0!==e.localClipUserIdSetObject.size||0!==e.modifyOpacityUserIdSetObject.size||0!==e.hiddenUserIdSetObject.size||0!==e.overrideUserIdSetObject.size||0!==e.transparentUserIdSetObject.size}_needsWireFrameUpdate(e){return 0!==e.hiddenUserIdSetObject.size||0!==e.overrideWireFrameUserIdSetObject.size||0!==e.hiddenWireFrameUserIdSetObject.size||0!==e.localClipUserIdSetObject.size}releaseObject(e){e.blinkUserIdSetObject=null,e.hoverUserIdSetObject=null,e.modifyOpacityUserIdSetObject=null,e.overrideUserIdSetObject=null,e.transparentUserIdSetObject=null,e.stateChangedRenderer=this.stateChangedRenderer}releaseWireFrameObject(e){e.overrideWireFrameUserIdSetObject=null,e.hiddenUserIdSetObject=null,e.clippingUserIdSetObject=null,e.localClipUserIdSetObject=null,e.hiddenWireFrameUserIdSetObject=null,e.stateWireFrameChangedRenderer=this.stateWireFrameChangedRenderer,e.forceUpdateWireFrame=!1}standardApply(e){if(this.stateChangedRenderer===e.stateChangedRenderer)return;const t=e._content.meshes,i=e.userIndexMap,r=this.model.getDescriptor();if(this._collectBlinkUserIds(e,i),this._collectHoverUserIds(e,i),this._collectClippingUserIds(e,i),this._collectLocalClipUserIds(e,i),this._collectModifyOpacityUserIds(e,i),this._collectFilteredUserIds(e,i,r,!1),!this._needsUpdate(e))return this.resetStandardNodeStates(t),void this.releaseObject(e);this.resetStandardNodeStates(t),this.rebuildIndices(e,r),this.releaseObject(e)}wireFrameStandardApply(e){if(e.isOutlineLoading())return;if(!1===e.forceUpdateWireFrame&&this.stateWireFrameChangedRenderer===e.stateWireFrameChangedRenderer)return;const t=e._content._outlineContent.outlineMeshes,i=e.userIndexMap,r=this.model.getDescriptor();if(this._collectWireFrameFilteredUserIds(e,i,r),!this._needsWireFrameUpdate(e))return this.resetWireFrameNodeStates(t),void this.releaseWireFrameObject(e);this.resetWireFrameNodeStates(t),this.rebuildWireFrameIndices(e,r),this.releaseWireFrameObject(e)}instanceApply(e){if(this.stateChangedRenderer===e.stateChangedRenderer)return;const t=e._content.meshes,i=e.userIndexMap,r=this.model.getDescriptor();if(this._collectBlinkUserIds(e,i),this._collectHoverUserIds(e,i),this._collectClippingUserIds(e,i),this._collectLocalClipUserIds(e,i),this._collectModifyOpacityUserIds(e,i),this._collectFilteredUserIds(e,i,r,!0),!this._needsUpdate(e))return this.resetInstanceMaterial(t),void this.releaseObject(e);this.resetInstanceMaterial(t),this._updateInstanceMaterial(e,r),this.releaseObject(e)}wireFrameInstanceApply(e){if(e.isOutlineLoading())return;if(!1===e.forceUpdateWireFrame&&this.stateWireFrameChangedRenderer===e.stateWireFrameChangedRenderer)return;const t=e.userIndexMap,i=this.model.getDescriptor(),r=e._content._outlineContent.outlineMeshes;if(this._collectWireFrameFilteredUserIds(e,t,i),!this._needsWireFrameUpdate(e))return this.resetInstanceWireFrameMaterial(r),void this.releaseWireFrameObject(e);this.resetInstanceWireFrameMaterial(r),this._updateInstanceWireFrameMaterial(e,i),this.releaseWireFrameObject(e)}_isEqual(e,t){if(void 0===t)return!1;if(Object.getOwnPropertyNames(e).length!==Object.getOwnPropertyNames(t).length)return!1;for(const i in e)if(e[i]!==t[i])return!1;return!0}apply(){}traverseInstanceGeometryMap(e,t){e.traverse((e=>{"MeshEx"!==e.type&&"LineSegmentsEx"!==e.type||t(e.geometry,e.material)}))}traverseInstanceLineGeometryMap(e,t){e.traverse((e=>{"LineSegmentsEx"===e.type&&t(e.geometry)}))}resetInstanceMaterial(e){var t=this.model.localClippingMode?r.EnumInstanceState.CLIPPING:r.EnumInstanceState.NONE;this.traverseInstanceGeometryMap(e,((e,i)=>{e.getAttribute("vState").array.fill(r.EnumInstanceState.NONE),e.getAttribute("vState").needsUpdate=!0,e.getAttribute("vClipping").array.fill(t),e.getAttribute("vClipping").needsUpdate=!0,e.getAttribute("vState2")&&(e.getAttribute("vState2").array.fill(r.EnumInstanceState.HIDDEN),e.getAttribute("vState2").needsUpdate=!0),2===i.length&&(i[1].visible=!1)}))}resetInstanceWireFrameMaterial(e){this.traverseInstanceLineGeometryMap(e,(e=>{e.getAttribute("vState").array.fill(r.EnumInstanceState.NONE),e.getAttribute("vState").needsUpdate=!0}))}_updateInstanceMaterial(e,t){for(const i of e.hiddenUserIdSetObject.keys())this._dealHideUserIndex(i,t);for(const i of e.localClipUserIdSetObject.keys())t.getInstanceNodeInfoByUserIdCallback(i,(e=>{const t=e.nodeInfo,i=t.index,a=this.model.tilesLoader.getInstanceMeshNodeById(t.parent);for(const e in a){const t=a[e].mesh;if(r.TilesUtil.isInstanceNodeInVisible(t))return;if(!t||!1===t.visible)return;const n=r.MaterialUtil.getColorParamsByMaterial(t.material[0]),s=r.EnumInstanceState.CLIPPING;this.updateInstanceGeometry(t,n,s,i)}}));for(const i of e.transparentUserIdSetObject.keys()){const e=this._filterImpl.getFrozonMaterial(),a=r.MaterialUtil.getColorParamsByMaterial(e),n=r.EnumInstanceState.OVERRIDED;this.updateInstanceGeometryByNodeInfos(i,t,a,n)}for(const i of e.overrideUserIdSetObject.keys())t.getInstanceNodeInfoByUserIdCallback(i,(t=>{const a=t.nodeInfo,n=a.index,s=this.model.tilesLoader.getInstanceMeshNodeById(a.parent),o=e.overrideUserIdSetObject&&e.overrideUserIdSetObject.get(i);var l;for(const t in s){const a=s[t].mesh;if(r.TilesUtil.isInstanceNodeInVisible(a))return;let d=1;-1!==o.indexOf("material_modifyOpacity")?(d=e.modifyOpacityUserIdSetObject.get(i).opacity,l=this.getMaterialForModifyOpacityFrom(a.material[0],d)):(l=this._getMaterialByName(o),e.modifyOpacityUserIdSetObject&&e.modifyOpacityUserIdSetObject.get(i)&&(d=e.modifyOpacityUserIdSetObject.get(i).opacity,l=this.getMaterialForModifyOpacityFrom(l,d))),l.srcOpacity=d,this.model.materialManager.materialMap[o]=l;const h=r.MaterialUtil.getColorParamsByMaterial(l),c=r.EnumInstanceState.OVERRIDED;this.updateInstanceGeometry(a,h,c,n)}}));for(const i of e.hoverUserIdSetObject.keys())t.getInstanceNodeInfoByUserIdCallback(i,(e=>{const t=e.nodeInfo,i=t.index,a=this.model.tilesLoader.getInstanceMeshNodeById(t.parent);for(const e in a){const t=a[e].mesh;if(r.TilesUtil.isInstanceNodeInVisible(t))return;const n=this.model.sceneState.getHoverMaterial(t.material[0]),s=r.MaterialUtil.getColorParamsByMaterial(n),o=r.EnumInstanceState.HOVER;this.updateInstanceGeometry(t,s,o,i)}}));for(const i of e.blinkUserIdSetObject.keys())t.getInstanceNodeInfoByUserIdCallback(i,(t=>{const a=t.nodeInfo,n=a.index,s=this.model.tilesLoader.getInstanceMeshNodeById(a.parent);for(const t in s){const a=s[t].mesh;if(r.TilesUtil.isInstanceNodeInVisible(a))return;if(!a||!1===a.visible)return;const l=r.MaterialUtil.getColorParamsByMaterial(a.material[0]),d=r.EnumInstanceState.BLINK;var o=this.getBlinkMaterialName(i,a.name,e.blinkUserIdSetObject.get(i));null==this.blinkMaterials[o]&&(this.blinkMaterials[o]={}),null==this.blinkMaterials[o][a.material[0].uuid]&&(this.blinkMaterials[o][a.material[0].uuid]=a.material[0]),this.updateInstanceGeometry(a,l,d,n)}}))}updateInstanceGeometry(e,t,i,a){const n=e.material[0]||e.material,s=t.rgbaColor;let o,l;n.transparent===t.transparent?(o=i,l=r.EnumInstanceState.HIDDEN):(o=r.EnumInstanceState.HIDDEN,l=i),void 0===e.material[0]&&(o=i,s.a>.999&&(n.transparent=!0,s.a=.999));let d=e.geometry;if(d.getAttribute("vState").array[a]=o,d.getAttribute("vState").needsUpdate=!0,void 0!==d.getAttribute("vState2")&&(d.getAttribute("vState2").array[a]=l),void 0!==d.getAttribute("vState2")&&(d.getAttribute("vState2").needsUpdate=!0),d.getAttribute("aColor").array[4*a]=s[0],d.getAttribute("aColor").array[4*a+1]=s[1],d.getAttribute("aColor").array[4*a+2]=s[2],d.getAttribute("aColor").array[4*a+3]=s[3],d.getAttribute("aColor").needsUpdate=!0,i==r.EnumInstanceState.CLIPPING){if(void 0!==d.getAttribute("vClipping")&&(d.getAttribute("vClipping").array[a]=i),void 0!==d.getAttribute("vClipping")&&(d.getAttribute("vClipping").needsUpdate=!0),e.material instanceof Array)return this.addInstanceMaterialForClip(e.material[0].uuid,e.material[0]),void this.addInstanceMaterialForClip(e.material[1].uuid,e.material[1]);this.addInstanceMaterialForClip(e.material.uuid,e.material)}if(e.material instanceof Array)return e.material[0].needsUpdate=!0,e.material[1].needsUpdate=!0,void(e.material[1].visible=!0);e.material.needsUpdate=!0}updateInstanceGeometryByNodeInfos(e,t,i,a){t.getInstanceNodeInfoByUserIdCallback(e,(e=>{const t=e.nodeInfo,n=t.index,s=this.model.tilesLoader.getInstanceMeshNodeById(t.parent);for(const e in s){const t=s[e].mesh;if(r.TilesUtil.isInstanceNodeInVisible(t))return;this.updateInstanceGeometry(t,i,a,n)}}))}_updateInstanceWireFrameMaterial(e,t){for(const i of e.hiddenUserIdSetObject.keys())t.getInstanceNodeInfoByUserIdCallback(i,(e=>{const t=e.nodeInfo,i=t.lineId,a=t.index,n=this.model.tilesLoader.getInstanceLineNodeById(i);if(r.TilesUtil.isInstanceNodeInVisible(n))return;let s=n.geometry;s.getAttribute("vState").array[a]=r.EnumInstanceState.HIDDEN,s.getAttribute("vState").needsUpdate=!0}));for(const i of e.hiddenWireFrameUserIdSetObject.keys())t.getInstanceNodeInfoByUserIdCallback(i,(e=>{const t=e.nodeInfo,i=t.lineId,a=t.index,n=this.model.tilesLoader.getInstanceLineNodeById(i);if(r.TilesUtil.isInstanceNodeInVisible(n))return;let s=n.geometry;s.getAttribute("vState").array[a]=r.EnumInstanceState.HIDDEN,s.getAttribute("vState").needsUpdate=!0}));for(const i of e.overrideWireFrameUserIdSetObject.keys()){const a=e.overrideWireFrameUserIdSetObject.get(i),n=this._getMaterialByName(a);if(-1!==a.indexOf("material_modifyOpacity"))continue;const s=r.MaterialUtil.getColorParamsByMaterial(n),o=r.EnumInstanceState.OVERRIDED;this.updateInstanceWireFrameGeometryByNodeInfos(i,t,s,o)}}updateInstanceWireFrameGeometryByNodeInfos(e,t,i,a){t.getInstanceNodeInfoByUserIdCallback(e,(e=>{const t=e.nodeInfo,n=t.lineId,s=this.model.tilesLoader.getInstanceLineNodeById(n);r.TilesUtil.isInstanceNodeInVisible(s)||this.updateInstanceGeometry(s,i,a,t.index)}))}resetAllStates(){treeNode._content.meshes.traverse((e=>{if(e.isMesh){let e=mesh.geometry;e.clearGroups(),e._visible=!0,e.addGroup(0,mesh.indexCount,r.Model.EnumFilterState.NONE)}}))}isHidden(e){const t=this._getIndexByUserId(e);return this.objectInfoManager.isHidden(t)}isFrozen(e){const t=this._getIndexByUserId(e);return this.objectInfoManager.isFrozen(t)}isTransparent(e){const t=this._getIndexByUserId(e);return this.objectInfoManager.isTransparent(t)}isPickable(e){return super.isComponentActive(e)&&!this.objectInfoManager.isFrozen(e)&&!this.objectInfoManager.isHidden(e)}_insertIndexMeshes(e,t,i,r,a){void 0===e.mergedMeshesStates[t]?(e.mergedMeshesStates[t]={},e.mergedMeshesStates[t][i]={},e.mergedMeshesStates[t][i].state=r,e.mergedMeshesStates[t][i].userId=a):void 0===e.mergedMeshesStates[t][i]&&(e.mergedMeshesStates[t][i]={},e.mergedMeshesStates[t][i].state=r,e.mergedMeshesStates[t][i].userId=a)}_collectLineMeshState(e,t,i){for(const r of t.keys()){const t=this.model.tilesLoader.userIdMapIndices[r];t&&t.map((t=>{const a=t.indexId,n=t.meshId;-1!==n.indexOf("line")&&this._insertIndexMeshes(e,n,a,i,r)}))}}_collectLineCategoryMeshState(e,t,i,a){for(let i of e.userIndexMap.keys()){const n=this.model.tilesLoader.userIdMapIndices[i];if(!n)continue;const s=n.length;for(let o=0;o<s;++o){const s=n[o],l=s.indexId,d=s.meshId;-1!==d.indexOf("line")&&(r.TilesUtil.matchWireFrameVisibilityOption(i,t)||this._insertIndexMeshes(e,d,l,a,i))}}}_collectMeshState(e,t,i){for(const r of t.keys()){const t=this.model.tilesLoader.userIdMapIndices[r];t&&t.map((t=>{const a=t.indexId,n=t.meshId;this._insertIndexMeshes(e,n,a,i,r)}))}}_collectMeshState2(e,t,i){for(const r in t){const t=this.model.tilesLoader.userIdMapIndices[r];t&&t.map((t=>{const a=t.indexId,n=t.meshId;this._insertIndexMeshes(e,n,a,i,r)}))}}rebuildWireFrameIndices(e,t){e.mergedMeshesStates={},this._collectLineMeshState(e,e.hiddenUserIdSetObject,r.Model.EnumFilterState.HIDDEN),this._collectLineMeshState(e,e.hiddenWireFrameUserIdSetObject,r.Model.EnumFilterState.HIDDEN),this._collectLineMeshState(e,e.overrideWireFrameUserIdSetObject,r.Model.EnumFilterState.OVERRIDED),this._collectLineMeshState(e,e.localClipUserIdSetObject,r.Model.EnumFilterState.LOCALCLIPPING);const i=e._content._outlineContent.outlineMeshes;for(const t in e.mergedMeshesStates){let r=i.getObjectByName(t);r&&this.rebuildMesh(r,t,e,[])}}rebuildIndices(e,t){e.mergedMeshesStates={},this._collectMeshState(e,e.hiddenUserIdSetObject,r.Model.EnumFilterState.HIDDEN),this._collectLineCategoryMeshState(e,this.model.tilesLoader.wireFrameVisibilityOption,t,r.Model.EnumFilterState.HIDDEN),this._collectMeshState(e,e.overrideUserIdSetObject,r.Model.EnumFilterState.OVERRIDED),this._collectMeshState(e,e.transparentUserIdSetObject,r.Model.EnumFilterState.TRANSPARENT),this._collectMeshState(e,e.hoverUserIdSetObject,r.Model.EnumFilterState.HOVER),this._collectMeshState(e,e.blinkUserIdSetObject,r.Model.EnumFilterState.BLINK),this._collectMeshState(e,e.clippingUserIdSetObject,r.Model.EnumFilterState.CLIPPING),this._collectMeshState(e,e.localClipUserIdSetObject,r.Model.EnumFilterState.LOCALCLIPPING);const i=this.model.sceneState.getHoverMaterial(),a=this._filterImpl.getFrozonMaterial(),n=[];n[r.Model.EnumFilterState.HOVER]=i,n[r.Model.EnumFilterState.TRANSPARENT]=a;const s=e._content.meshes;for(const t in e.mergedMeshesStates){let i=s.getObjectByName(t);i&&this.rebuildMesh(i,t,e,n)}}rebuildMesh(e,t,i,a){if(!e)return;let n=(e,t,i,a,n)=>{let s,o=null,l=t,d=0,h=!1;switch(t>r.Model.EnumFilterState.OVERRIDED&&(t=r.Model.EnumFilterState.OVERRIDED,a.blinkUserIdSetObject&&a.blinkUserIdSetObject.get(i)&&(t=r.Model.EnumFilterState.BLINK)),t){case r.Model.EnumFilterState.NONE:case r.Model.EnumFilterState.CLIPPING:break;case r.Model.EnumFilterState.HOVER:o=this.model.sceneState.getHoverMaterial(e.material[0]),e.material[r.Model.EnumFilterState.HOVER]=o;break;case r.Model.EnumFilterState.BLINK:s=this.getBlinkMaterialName(i,e.name,a.blinkUserIdSetObject.get(i)),null==this.blinkMaterials[s]?(this.blinkMaterials[s]={},o=this.model.sceneState.getBlinkMaterial(e.material[0],`${this.model.id}_${s}`),this.blinkMaterials[s][s]=o,o.name=s):null==this.blinkMaterials[s][s]?(o=this.model.sceneState.getBlinkMaterial(e.material[0],`${this.model.id}_${s}`),this.blinkMaterials[s][s]=o,o.name=s):o=this.blinkMaterials[s][s],a.localClipUserIdSetObject&&a.localClipUserIdSetObject.get(i)&&(o=this.getMaterialForClipFrom(o),this.blinkMaterials[s]=o),d=Math.max(e.material.length,t),h=!1;for(let i=t;i<d;++i)e.material[i]&&s===e.material[i].name&&(h=!0,l=i);if(!1===h){let t=d;d===r.Model.EnumFilterState.BLINK+1&&(t=r.Model.EnumFilterState.OVERRIDED+1),e.material[t]=o,l=t}break;case r.Model.EnumFilterState.OVERRIDED:s=a.overrideUserIdSetObject&&a.overrideUserIdSetObject.get(i);let c=1;e.name.indexOf("line")>-1&&a.overrideWireFrameUserIdSetObject&&a.overrideWireFrameUserIdSetObject.get(i)&&(s=a.overrideWireFrameUserIdSetObject.get(i)),-1!==s.indexOf("material_modifyOpacity")?(c=a.modifyOpacityUserIdSetObject.get(i).opacity,o=this.getMaterialForModifyOpacityFrom(e.material[0],c),!e.material[0].useCompressedColor||"cloudStandard"!==o.type&&"IBLMaterial"!==o.type||(o.defines.CCOLOR="",o.useCompressedColor=!0)):(o=this._getMaterialByName(s),c=o.opacity,a.modifyOpacityUserIdSetObject&&a.modifyOpacityUserIdSetObject.get(i)&&(c=a.modifyOpacityUserIdSetObject.get(i).opacity,o=this.getMaterialForModifyOpacityFrom(o,c))),o.srcOpacity=c,this.model.materialManager.materialMap[s]=o,a.localClipUserIdSetObject&&a.localClipUserIdSetObject.get(i)&&(o=this.getMaterialForClipFrom(o)),o.side=e.material[0].side,!e.material[0].useCompressedNormal||"cloudStandard"!==o.type&&"IBLMaterial"!==o.type||(o.defines.CNORMAL="",o.useCompressedNormal=!0),r.Utils.isDefined(e.material[0].useCompressedUv)&&e.material[0].useCompressedUv&&"cloudStandard"===o.type&&(o.uvCenter=e.material[0].uvCenter,o.uvHalfExtent=e.material[0].uvHalfExtent,o.defines.USE_COMPRESS_UV="",o.useCompressedUv=!0),d=Math.max(e.material.length,t),h=!1;for(let i=t;i<d;++i)s===e.material[i].name&&(h=!0,l=i);!1===h&&(e.material[d]=o,l=d);break;case r.Model.EnumFilterState.LOCALCLIPPING:o=this.getMaterialForClipFrom(e.material[0]),e.material[r.Model.EnumFilterState.LOCALCLIPPING]=o;break;default:n[t]&&(e.material[t]=n[t])}return l};const s=i.mergedMeshesStates[t];let o=e.geometry;o.clearGroups(),o._visible=!0;const l=e.indexGroups;let d=0;const h=r.TilesUtil.nodeIndexGroupsSort(l),c=h.length;let u=h[0].indexGroup.indexCount,p=r.Model.EnumFilterState.NONE;if(s[0]&&s[0].state!==r.Model.EnumFilterState.NONE){p=s[0].state;p=n(e,p,s[0].userId,i,a)}for(let t=1;t<c;++t){const l=h[t].indexGroup;if(s[t]){const r=s[t].userId,h=n(e,s[t].state,r,i,a);h===p?u+=l.indexCount:(o.addGroup(d,u,p),p=h,d=l.indexStart,u=l.indexCount)}else if(p===r.Model.EnumFilterState.NONE)u+=l.indexCount;else{o.addGroup(d,u,p);n(e,p,s[t-1].userId,i,a),p=r.Model.EnumFilterState.NONE,d=l.indexStart,u=l.indexCount}}if(u>0&&p!==r.Model.EnumFilterState.HIDDEN){const t=n(e,p,s[c-1]&&s[c-1].userId,i,a);o.addGroup(d,u,t)}}_collectSelectUserIds(e,t){if(e.selectUserIdSetObject=new Map,this.model.sceneState.selectionSet&&this.model.sceneState.selectionSet[this.model.id]){const r=this.model.sceneState.selectionSet[this.model.id];for(var i in r){const r=this._getIndexByUserId(i);t.has(r)&&e.selectUserIdSetObject.set(r,!0)}}}_collectHoverUserIds(e,t){if(e.hoverUserIdSetObject=new Map,this.model.sceneState.hoverId){const i=this._getIndexByUserId(this.model.sceneState.hoverId);t.has(i)&&e.hoverUserIdSetObject.set(i,!0)}}_collectClippingUserIds(e,t){e.clippingUserIdSetObject=new Map;for(const i of this.model.mapClippingIds.keys())t.has(i)&&e.clippingUserIdSetObject.set(i,!0)}_collectBlinkUserIds(e,t){e.blinkUserIdSetObject=new Map;var i=this.model.sceneState.getBlinkComponentsIdMap(this.model.id);for(var r in i){var a;this.idCacheMap.get(r)?a=this.idCacheMap.get(r):(a=this._getIndexByUserId(r),this.idCacheMap.set(r,a)),t.has(a)&&e.blinkUserIdSetObject.set(a,i[r])}}_collectLocalClipUserIds(e,t){e.localClipUserIdSetObject=new Map;var i=this.getLocalClippingList();for(var r in i){var a;this.idCacheMap.get(r)?a=this.idCacheMap.get(r):(a=this._getIndexByUserId(r),this.idCacheMap.set(r,a)),t.has(a)&&e.localClipUserIdSetObject.set(a,!0)}}_collectModifyOpacityUserIds(e,t){e.modifyOpacityUserIdSetObject=new Map;var i=this.getModifyOpacityList();for(var r in i){var a;this.idCacheMap.get(r)?a=this.idCacheMap.get(r):(a=this._getIndexByUserId(r),this.idCacheMap.set(r,a)),t.has(a)&&e.modifyOpacityUserIdSetObject.set(a,i[r])}}getBlinkMaterialName(e,t,i){let r=e.toString()+"|"+t;return i&&(i.color&&(r+="|"+i.color.getHEX()),i.interval&&(r+="|"+i.interval.toString())),r}getBlinkMaterialsByUserId(e){let t=[];const i=e.toString();for(const e in this.blinkMaterials){if(i!==e.split("|")[0])continue;const r=this.blinkMaterials[e];for(const e in r)t.push(r[e])}return t}_collectWireFrameFilteredUserIds(e,t,i){const a=this._hasOverrideMaterialFilterForWireFrame(),n=this.model.tilesLoader.wireFrameVisibilityOption,s=!0!==n;if(e.hiddenUserIdSetObject||(e.hiddenUserIdSetObject=new Map),e.localClipUserIdSetObject||(e.localClipUserIdSetObject=new Map),e.hiddenWireFrameUserIdSetObject=new Map,e.overrideWireFrameUserIdSetObject=new Map,!a&&!s)return!1;for(const i of t.keys()){if(!this._hasOverrideMaterialForWireFrame({name:i}))continue;const t=this._getOverrideMaterialForWireFrame({name:i});e.overrideWireFrameUserIdSetObject.set(i,t.name)}for(const i of t.keys())r.TilesUtil.matchWireFrameVisibilityOption(i,n)||e.hiddenWireFrameUserIdSetObject.set(i,!0);return!0}_collectFilteredUserIds(e,t,i,a){const n=this._hasHiddenFileIdFilter(),s=this._hasVisibleFilter()||this.model.hasHiddenSourceObjectUserId(),o=this._hasOverrideMaterialFilter(),l=this._hasTransparentFilter(),d=e.blinkUserIdSetObject.size>0,h=e.clippingUserIdSetObject.size>0,c=this._hasLocalClipping(),u=this._hasModifyOpacityList();let p=this.mapMaterialIdToUserIdsForFilter={};if(e.hiddenUserIdSetObject=new Map,e.overrideUserIdSetObject=new Map,e.transparentUserIdSetObject=new Map,!(n||s||o||l||d||c||u||h))return;let m=!0===a?"getInstanceNodeInfoByUserIdCallback":"getBatchedNodeInfoByUserIdCallback";for(const a of t.keys())i[m](a,(t=>{const i=t.nodeInfo;if(n&&this._isHiddenFileId(i)||s&&!1===this._isVisible(i)||this.model.isHiddenSourceObjectUserId(a))return void 0===p[i.materialId]&&(p[i.materialId]={}),void 0===p[i.materialId][r.Model.EnumFilterState.HIDDEN]&&(p[i.materialId][r.Model.EnumFilterState.HIDDEN]={}),p[i.materialId][r.Model.EnumFilterState.HIDDEN][a]=!0,void e.hiddenUserIdSetObject.set(a,!0);if(c&&e.localClipUserIdSetObject.has(a)&&(void 0===p[i.materialId]&&(p[i.materialId]={}),void 0===p[i.materialId][r.Model.EnumFilterState.LOCALCLIPPING]&&(p[i.materialId][r.Model.EnumFilterState.LOCALCLIPPING]={}),p[i.materialId][r.Model.EnumFilterState.LOCALCLIPPING][a]=!0),l&&this._isTransparent(i))return void 0===p[i.materialId]&&(p[i.materialId]={}),void 0===p[i.materialId][r.Model.EnumFilterState.TRANSPARENT]&&(p[i.materialId][r.Model.EnumFilterState.TRANSPARENT]={}),p[i.materialId][r.Model.EnumFilterState.TRANSPARENT][a]=!0,void e.transparentUserIdSetObject.set(a,!0);if(d&&e.blinkUserIdSetObject.has(a))return void 0===p[i.materialId]&&(p[i.materialId]={}),void 0===p[i.materialId][r.Model.EnumFilterState.BLINK]&&(p[i.materialId][r.Model.EnumFilterState.BLINK]={}),void(p[i.materialId][r.Model.EnumFilterState.BLINK][a]=!0);if(o&&this._hasOverrideMaterial(i)){var h=this._getOverrideMaterial(i);""!==(m=null!=h?h.name:"")&&(void 0===p[i.materialId]&&(p[i.materialId]={}),void 0===p[i.materialId][r.Model.EnumFilterState.OVERRIDED]&&(p[i.materialId][r.Model.EnumFilterState.OVERRIDED]={}),p[i.materialId][r.Model.EnumFilterState.OVERRIDED][a]=m,e.overrideUserIdSetObject.set(a,m))}else if(u&&e.modifyOpacityUserIdSetObject.has(a)){var m=`material_modifyOpacity_${e.modifyOpacityUserIdSetObject.get(a).opacity}`;e.overrideUserIdSetObject.set(a,m)}else;}))}_dealHideUserIndex(e,t){t.getInstanceNodeInfoByUserIdCallback(e,(e=>{const t=e.nodeInfo,i=t.index,a=this.model.tilesLoader.getInstanceMeshNodeById(t.parent);for(const e in a){const t=a[e].mesh;if(r.TilesUtil.isInstanceNodeInVisible(t))return;let n=t.geometry;n.getAttribute("vState").array[i]=r.EnumInstanceState.HIDDEN,n.getAttribute("vState").needsUpdate=!0,n.getAttribute("vState2")&&(n.getAttribute("vState2").array[i]=r.EnumInstanceState.HIDDEN,n.getAttribute("vState2").needsUpdate=!0)}}))}_updateInstanceDemandMaterial(e,t,i){const r=this.model.onDemandManager.idMap;for(let e of t.keys())r[e]||this._dealHideUserIndex(e,i)}decreaseStateChanged(){this.stateChangedRenderer--}enableStateChanged(){this.stateChangedRenderer++,this.stateChangedRenderer>r.EnumChangedState.END&&(this.stateChangedRenderer=r.EnumChangedState.START)}enableWireFrameStateChanged(){this.stateWireFrameChangedRenderer++,this.stateWireFrameChangedRenderer>r.EnumChangedState.END&&(this.stateWireFrameChangedRenderer=r.EnumChangedState.START)}applyTileMeshForFlatten(){}_getIndexByUserId(e){return this.model.tilesLoader.tileReader.getIndexByUserId(e)}_getOverrideMaterial(e){var t=e.name;return this._getOverrideMaterialByIndexId(t)}_getOverrideMaterialById(e){const t=this._getIndexByUserId(e);this._getOverrideMaterialByIndexId(t)}_getOverrideMaterialByIndexId(e){return this.objectInfoManager.isFrozen(e)?this._filterImpl.getFrozonMaterial():this.objectInfoManager.getMaterial(e)}}r.BimTileFilterManager=e}(),function(){function e(e,t){return t._distance-e._distance}class t extends r.TilesetTraversal{constructor(){super(),this.subTraversalInsPrecut=void 0}traverseTiles(e,t,i){let a=void 0!==this.subTraversalInsPrecut;const n=this.traversalStack;for(n.push(t);n.length>0;){const t=n.pop();if(a&&t.subBimTilesType==r.EnumSubBimTileType.SubBt_instance&&(a=!1,this.subTraversalInsPrecut.traverseViewNode(e,i)),!this.filterByPrecuttingTree(t))continue;const s=t.refineReplace,o=!t._parent||t._parent._refines;let l=!1;if(this.updateTileContentLinksToAncestor(t,i),e._isAvailableDetailLevel(t)){if(e._fetchChildrenOfTile(t,i),e.onDemandJudgment(t))continue;e._canBeTraverse(t,i)&&(l=this.subdivideTile(e,t,i),l=l&&o)}if(s){const r=!l&&o;e._addTileToRequestedQueue(t,i),r&&t.passSSE(i)&&e._addTileToSelectedQueue(t,i)}else e._addTileToRequestedQueue(t,i),(t.passSSE(i)||t.passSSE_instanceLeafTile(i))&&e._addTileToSelectedQueue(t,i);e.visitTile(t,i),e.touchTile(t,i),t._refines=l}}subdivideTile(t,i,r){const a=this.traversalStack,n=i.childrenTree;if(n.forEach((e=>{t.updateTile(e,r)})),t.isCheckChildrenPassSSE()&&!t.anyChildrenPassSSE(i,r))return!1;n.sort(e);const s=i.refineReplace&&!i.contentTypeEmpty;let o=!0,l=!1;return n.forEach((e=>{if(e.visible?(a.push(e),l=!0):s&&(t._addTileToRequestedQueue(e,r),t.visitTile(e,r),t.touchTile(e,r)),!s)return;const i=e.contentTypeEmpty?this.traverseTileWithEmptyContent(t,e,r):e.contentAvailable;o=o&&i})),l||(o=!1),o}traverseTileWithEmptyContent(e,t,i){this.traversalDescendants.length=0;const r=this.emptyTraversalStack;r.push(t);let a=!0;for(;r.length>0;){const t=r.pop();if(t.contentTypeEmpty){if(!t.childrenReady){e._fetchChildrenOfTile(t,i),a=!1;break}if(t.contentTypeTile&&!t.hasChildren()){a=!1;break}let n=e._canBeTraverse(t,i);if(n){const a=t.childrenTree;a.forEach((t=>{e.updateTile(t,i),t.visible||(e._addTileToRequestedQueue(t,i),e.visitTile(t,i),e.touchTile(t,i))})),t.refineReplace&&(e.isCheckChildrenPassSSE()&&(e.anyChildrenPassSSE(t,i)||(n=!1)),n&&a.forEach((e=>{r.push(e)})))}}else if(!t.contentAvailable){a=!1;break}}return a}filterByPrecuttingTree(e){return void 0===this.subTraversalInsPrecut||!e.isInstanceTile||this.subTraversalInsPrecut.isTileSelected(e.insTileId)}}r.BimTilesetTraversal=t}(),r.BimTileViewNode=class{constructor(e,t){this.nodeid=e,this.parent=t,this.childrenTree=[],this.geometricError=void 0,this.boundingBox=void 0,this.tileIds=void 0,t?(t.childrenTree.push(this),this.depth=t.depth+1):this.depth=0,this.visible=!1,this._distance=0,this.sse=0,this._refines=!1,this._transformedBoundingBox=void 0,this._globaledBoundingBox=new THREE.Box3}hasChildren(){return this.childrenTree.length>0}updateViewNodeState(e){this.updateVisibility(e)}updateVisibility(e){const t=this.computeTransformedBoundingBox(e);this.visible=this.culling(e,t),this.visible?this.computeDistanceToCameraAndSSE(e):this.sse=0}computeTransformedBoundingBox(e){return!(!e.transformMatrixUpdated&&void 0!==this._transformedBoundingBox||(void 0===this._transformedBoundingBox&&(this._transformedBoundingBox=new THREE.Box3),this._transformedBoundingBox.copy(this.boundingBox),e.transformMatrix&&this._transformedBoundingBox.applyMatrix4(e.transformMatrix),0))}computeDistanceToCameraAndSSE(e){if(this._transformedBoundingBox.containsPoint(e.cameraPositionWc))return this._distance=0,void(this.sse=99999);this._distance=this._transformedBoundingBox.distanceToPoint(e.cameraPositionWc),this._distance=this._distance<r.Math.EPSILON2?r.Math.EPSILON2:this._distance,this.computeSSE(e)}culling(e,t){return(e.globalMatrixUpdated||t)&&(this._globaledBoundingBox.copy(this._transformedBoundingBox),this._globaledBoundingBox.applyMatrix4(e.globalMatrix)),!!e.frustum.intersectsBox(this._globaledBoundingBox)}computeSSE(e){const t=this.geometricError*e.geoErrScaleFactor;return this.sse=e.cameraPreSSE*(t/this._distance),this.sse}passSSE(e){return this.sse>=500}passVisible(){return this.visible}},r.BimTilesetTraversalPrecut=class{constructor(e,t){this.rootViewNode=e,this.insTileMap=t,this.arrSelectedTiles=new Set}traverseViewNode(e,t){const{arrSelectedTiles:i}=this;i.clear();const r=[];let a=this.rootViewNode;a.updateViewNodeState(t),a.passVisible()&&r.push(a);let n=0,s=0;for(;r.length>0;){a=r.pop();let e=!1;if(a.passSSE()&&(e=this.subdivideViewNode(a,t,r)),!e)for(n=0,s=a.tileIds.length;n<s;++n)i.add(a.tileIds[n])}}subdivideViewNode(e,t,i){if(!e.hasChildren())return!1;let r=!1;return e.childrenTree.forEach((e=>{e.updateViewNodeState(t),e.passVisible()&&(r=!0,i.push(e))})),r}isTileSelected(e){return this.arrSelectedTiles.has(e)}},r.BimTilesPickingManager=class{constructor(e,t){this.model=e,this.pickingEffecter=t,this.selectionChangedRenderer=r.EnumChangedState.NONE,this.lastSelectionChangedRenderer=r.EnumChangedState.NONE,this.selectedIdMap=new Map,this.selectedMeshes=new r.ObjectGroup,this.selectedMeshes.pickTile=!0,this.instanceMatrixListMap=new Map,this._dirty=!1}destroy(){this.selectedIdMap.clear(),this.selectedIdMap=null,this.instanceMatrixListMap.clear(),this.instanceMatrixListMap=null,this.selectedMeshes.clear(),this.selectedMeshes=null,this.pickingEffecter=null,this.model=null}setSelectedIdMap(e){this.selectedIdMap.clear();for(const t in e){const e=this.model.tilesLoader.tileReader.getIndexByUserId(t);this.model.filter.isPickable(e)&&this.selectedIdMap.set(e,!0)}}beforeUpdate(){this.lastSelectionChangedRenderer!==this.selectionChangedRenderer&&(this.lastSelectionChangedRenderer=this.selectionChangedRenderer,this.selectedMeshes.clear(),this.selectedMeshes.matrix.copy(this.model.getTransformMatrix()),this.selectedMeshes.matrixAutoUpdate=!1,this._dirty=!0)}afterUpdate(){!1!==this._dirty&&(this._dirty=!1,this.pickingEffecter._clearMeshesFromScene(),0!==this.selectedIdMap.size&&(this.pickingEffecter.selectionObjectGroup.add(this.selectedMeshes),this.pickingEffecter._updateMatrixWorldForScene()))}clearDrawable(){this.selectedMeshes.children.map((e=>{e.visible=!1}))}enableSelectionStateChanged(){this.selectionChangedRenderer++,this.selectionChangedRenderer>r.EnumChangedState.END&&(this.selectionChangedRenderer=r.EnumChangedState.START)}updatePickingMeshes(e){this.needsUpdate(e)?(e.selectionMeshes=[],!0===e.isInstanceTile?this.updateInstancePickingMeshes(e):this.updateBatchedPickingMeshes(e),e.selectionChangedRenderer=this.selectionChangedRenderer):e.selectionChangedRenderer=this.selectionChangedRenderer}updatePickingWireFrame(e){e.isOutlineLoading()||(this.needsUpdate(e)?(e.selectionWireFrames=[],!0===e.isInstanceTile?this.updateInstanceWireFramePickingMeshes(e):this.updateBatchedWireFramePickingMeshes(e),e.selectionWireFrameChangedRenderer=this.selectionChangedRenderer):e.selectionWireFrameChangedRenderer=this.selectionChangedRenderer)}needsUpdate(e){const t=e.userIndexMap;for(let e of this.selectedIdMap.keys())if(t.has(e))return!0;return!1}getMatchedIds(e){let t=[];for(let i of this.selectedIdMap.keys())e.has(i)&&t.push(i);return t}updateBatchedPickingMeshes(e){e.content.meshes.traverse((t=>{if("MeshEx"!==t.type&&"LineSegmentsEx"!==t.type)return;if(!t||!t.indexGroups||!1===t.visible||null!=t.parent.parent&&0==t.parent.parent.visible)return;const i=t.geometry,a=t.indexGroups,n=this.getMatchedIds(a);if(0===n.length)return;let s=new THREE.BufferGeometry;s.setAttribute("position",i.getAttribute("position")),i.getAttribute("uv"),s.setIndex(i.getIndex());let o="LineSegmentsEx"===t.type?new THREE.LineSegments(s,r.MaterialUtil.DefaultMaterial):new THREE.Mesh(s,r.MaterialUtil.DefaultMaterial);o.name=t.name,o.frustumCulled=!1,o.renderOrder=r.EnumRenderOrder.Component,o._indicesGroup=a,o.material=[r.MaterialUtil.getDefaultSelectedMaterial()],o.matrix.copy(t.matrix),o.matrixAutoUpdate=!1,n.map((e=>{const t=a.get(e);for(const e of t.values()){let t=0;o.geometry.addGroup(e.indexStart,e.indexCount,t)}})),this._dirty=!0,e.selectionMeshes.push(o),this.selectedMeshes.add(o)}))}updateBatchedWireFramePickingMeshes(e){e._content._outlineContent.outlineMeshes.traverse((t=>{if("LineSegmentsEx"===!t.type)return;if(!t||!t.indexGroups||!1===t.visible||null!=t.parent.parent&&0==t.parent.parent.visible)return;const i=t.geometry,a=t.indexGroups,n=this.getMatchedIds(a);if(0===n.length)return;let s=new THREE.BufferGeometry;s.setAttribute("position",i.getAttribute("position")),s.setIndex(i.getIndex());let o=new THREE.LineSegments(s,r.BimTileWireframeManager.selectedMaterial);o.name=t.name,o.frustumCulled=!1,o.renderOrder=r.EnumRenderOrder.WireFrame,o._indicesGroup=a,o.material=[r.MaterialUtil.getDefaultSelectedMaterial()],o.matrix.copy(t.matrix),o.matrixAutoUpdate=!1,n.map((e=>{const t=a.get(e);for(const e of t.values())o.geometry.addGroup(e.indexStart,e.indexCount,0)})),this._dirty=!0,e.selectionWireFrames.push(o),this.selectedMeshes.add(o)}))}updateInstancePickingMeshes(e){this.instanceMatrixListMap.clear();const t=e.content.meshes,i=e.userIndexMap,a=this.getMatchedIds(i);0!==a.length&&t.traverse((t=>{if("MeshEx"!==t.type&&"LineSegmentsEx"!==t.type)return;if(r.TilesUtil.isInstanceNodeInVisible(t))return;const i=t.geometry;let n=new THREE.BufferGeometry;n.setAttribute("position",i.getAttribute("position")),n.setIndex(i.getIndex());let s=[];a.map((i=>{const a=this.model.getDescriptor().getInstanceMatrixListByUserIdAndMeshId(i,t.name);s=s.concat(a),a.map((a=>{let s=null;s="LineSegmentsEx"===t.type?new THREE.LineSegments(n,r.BimTileWireframeManager.selectedMaterial):new THREE.Mesh(n,r.MaterialUtil.getDefaultSelectedMaterial()),s.name=`${t.name}_${i}`,s.frustumCulled=!1,s.matrix.copy(t.matrix).multiply(a),s.matrixAutoUpdate=!1,e.selectionMeshes.push(s),this.selectedMeshes.add(s)}))})),this._dirty=!0,this.instanceMatrixListMap.set(t.name,s)}))}updateInstanceWireFramePickingMeshes(e){e._content._outlineContent.outlineMeshes.traverse((t=>{if("LineSegmentsEx"!==t.type)return;const i=this.instanceMatrixListMap.get(t.name);if(!i)return;const a=t.geometry;let n=new THREE.BufferGeometry;n.setAttribute("position",a.getAttribute("position")),n.setIndex(a.getIndex()),i.map((i=>{let a=new THREE.LineSegments(n,r.MaterialUtil.getDefaultSelectedMaterial());a.name=t.name,a.frustumCulled=!1,a.renderOrder=r.EnumRenderOrder.WireFrame,a.matrix.copy(t.matrix).multiply(i),a.matrixAutoUpdate=!1,this._dirty=!0,e.selectionWireFrames.push(a),this.selectedMeshes.add(a)}))}))}},function(){class e extends r.BimtilesObjectInfoDict{constructor(){super()}setTileReader(e){this.tileReader=e}getNodeInfoCallback(e){for(const t of this.nodeInfos[0].values())r.BimtilesObjectInfoDict2.getBatchedNodeInfoByTileReader(t,this.tileReader,e);for(const t of this.nodeInfos[1].values())r.BimtilesObjectInfoDict2.getInstanceNodeInfoByTileReader(t,this.tileReader,e)}getUserDataCallback(e){for(const t of this.nodeInfos[0].values())e&&e(t.userId,t);for(const t of this.nodeInfos[1].values())e&&e(t.userId,t)}setIdsState2(e,t,i,r){if(!0!==i&&void 0!==i){for(const t of this.nodeInfos[0].values()){const i=t.userId;e.has(i)||r&&r(t)}for(const t of this.nodeInfos[1].values()){const i=t.userId;e.has(i)||r&&r(t)}}else{let i=0;for(const a of e.keys()){let e=this.nodeInfos[0].get(a),n=t[i];if(e&&e instanceof Map){for(const[t,i]of e)r&&r(i,n);if(e=this.nodeInfos[1].get(a),e)for(const[t,i]of e)r&&r(i,n)}else e&&r&&r(e,n),e=this.nodeInfos[1].get(a),e&&r&&r(e,n);i++}}}setIdsState(e,t,i){if(!0!==t&&void 0!==t){for(const t of this.nodeInfos[0].values()){const r=t.userId;e.has(r)||i&&i(t)}for(const t of this.nodeInfos[1].values()){const r=t.userId;e.has(r)||i&&i(t)}}else for(const t of e.keys()){let e=this.nodeInfos[0].get(t);e&&i&&i(e),e=this.nodeInfos[1].get(t),e&&i&&i(e)}}getNodeInfoById(e){const t=parseInt(e);return this.nodeInfos[0].has(t)?this.nodeInfos[0].get(t):this.nodeInfos[1].has(t)?this.nodeInfos[1].get(t):void 0}}e.getBatchedNodeInfoByTileReader=(e,t,i)=>{const r=e.nodeIdMap;for(const[a,n]of r){let r=t.getNodeIdByIndex(n);r&&(i&&i(e.userId,r))}},e.getBatchedNodeInfoByTileReaderWithTileId=(e,t,i,r)=>{const a=e.nodeIdMap;for(const[n,s]of a){let a=i.getNodeIdByIndex(s);a&&a.tilId===t&&(r&&r(e.userId,a))}},e.getInstanceNodeInfoByTileReader=(e,t,i)=>{const r=e.nodeIdMap;for(const[a,n]of r)for(const[r,a]of n){let r=t.getNodeIdByIndex(a);r&&(i&&i(e.userId,r))}},e.getInstanceMatrixListByUserIdAndMeshId=(e,t,i)=>{let r=[];const a=e.nodeIdMap.get(t);if(!a)return r;for(const[e,t]of a){let e=i.getNodeIdByIndex(t);e&&r.push(e.matrix)}return r},e.getInstanceNodeInfoByTileReaderWithTileId=(e,t,i,r)=>{const a=e.nodeIdMap;for(const[n,s]of a)for(const[a,n]of s){let a=i.getNodeIdByIndex(n);a&&a.tilId===t&&(r&&r(e.userId,a))}},r.BimtilesObjectInfoDict2=e;class t extends r.BimtileObjectInfoManager{constructor(){super(),this.objectInfoDict=new r.BimtilesObjectInfoDict2}setTileReader(e){this.tileReader=e,this.objectInfoDict.setTileReader(e)}}r.BimtileObjectInfoManager2=t}(),r.BimTileNewNodeInfo=class{constructor(){this._userId=void 0,this._userData=void 0,this._state=r.EnumObjectState.Visible,this.nodeIdMap=new Map,this._material=null,this._explodeMatrix=void 0,this._loadedExplodeMatrix=void 0}getHeader(){return{userId:this._userId,userData:this._userData,state:this._state,name:this._userId,material:this._material,explodeMatrix:this._explodeMatrix,loadedExplodeMatrix:this._loadedExplodeMatrix}}destroy(){this._userId=void 0,this._userData=void 0,this._state=void 0,this._material=null,this.nodeIdMap.clear(),this.nodeIdMap=null,this._explodeMatrix=void 0,this._loadedExplodeMatrix=void 0}get name(){return this._userId}set name(e){this._userId=e}get state(){return this._state}set state(e){this._state=e}get material(){return this._material}set material(e){this._material=e}get userId(){return this._userId}set userId(e){this._userId=e}get explodeMatrix(){return this._explodeMatrix}set explodeMatrix(e){this._explodeMatrix=e}get loadedExplodeMatrix(){return this._loadedExplodeMatrix}set loadedExplodeMatrix(e){void 0!==this._loadedExplodeMatrix?this._loadedExplodeMatrix.multiplyMatrices(e,this._loadedExplodeMatrix):this._loadedExplodeMatrix=e}addNodeIdInfo(e,t){this.nodeIdMap.has(e)&&console.log(e),this.nodeIdMap.set(e,t)}addInstanceNodeIdInfo(e,t,i){this.nodeIdMap.has(e)||(this.nodeIdMap.set(e,new Map),this.nodeIdMap.get(e).set(t,i)),this.nodeIdMap.get(e).set(t,i)}get userData(){return this._userData}set userData(e){this._userData=e}},r.BimTileNodeBoxTool=class{constructor(){this.globalNodeBoxUrls={},this.globalNodeBoxBuffers=[],this.NodeBoxMap={}}destroy(){this.globalNodeBoxUrls=null,this.globalNodeBoxBuffers=null,this.NodeBoxMap=null}addGlobalNodeBoxUrl(e,t){this.globalNodeBoxUrls[e]=t}getGlobalNodeBoxUrls(){return Object.keys(this.globalNodeBoxUrls)}parseNodeBoxBuffer(e,t){const i=this.globalNodeBoxUrls[t];e.getNodeboxsList().map(((e,t)=>{this.NodeBoxMap[i+t]=(new THREE.Box3).setFromArray(e.getBboxList())})),e=null}getNodeBoxByIndex(e){return this.NodeBoxMap[e]}},r.BimTileNodeIdTool=class{constructor(){this.globalNodeIdUrls=[],this.globalNodeIdBuffers={},this.nodeIdMap={}}destroy(){this.globalNodeIdUrls=null,this.globalNodeIdBuffers=null,this.nodeIdMap=null}addGlobalNodeIdUrl(e,t){this.globalNodeIdUrls[e]=t}getGlobalNodeIdUrls(){return Object.keys(this.globalNodeIdUrls)}parseNodeIdBuffer(e,t,i){const a=this.globalNodeIdUrls[t];e.getNodeIdsList().map(((e,t)=>{const i=new r.BimTileNodeIdInfo;i.index=e.getNodeId(),i.userId=e.getUserId(),i.boundingBox=e.getBboxId(),i.tileId=e.getTileId(),this.nodeIdMap[a+t]=i})),e=null}getNodeIdByIndex(e){return this.nodeIdMap[e]}},function(){class e extends r.BimtileDescriptor{constructor(e){super(),this.tileReader=e,this.nodeIdMap=e.nodeIdTool.nodeIdMap,this.userDataIndexMap=e.userDataTool.userDataIndexMap}destroy(){super.destroy()}setUserData(){}_classifyNodeInfo(e){const t=this.nodeIdMap[e],i=t.tileId,a=t.userId,n=t.index;let s=!1;if(this.tileReader.globalTileIdBuffer){const e=this.tileReader.globalTileIdBuffer.getTileIdsList()[i];-1!==this.tileReader.globalTileIdBuffer.getTilePathList()[e].indexOf("instance")&&(s=!0)}t.instanceOrNot=s;const o=s?this.mapNodeInfoByInstance:this.mapNodeInfoByBatched;let l=o.get(a);l||(l=new r.BimTileNewNodeInfo,l.userId=a,l.userData=this.tileReader.userIdTool.userDataIndexMap[a],o.set(a,l)),s?l.addInstanceNodeIdInfo(t.nodeId,n,e):l.addNodeIdInfo(t.nodeId,e),t.update(l,this.tileReader)}patchBatchedMeshNodeInfo(e,t,i){const r=parseInt(e),a=this.mapNodeInfoByBatched.get(r);if(!a)return;const n=a.nodeIdMap.get(t);if(void 0===n)return;let s=this.tileReader.getNodeIdByIndex(n);s.parent=i.parent,s.materialId=i.materialId,s.matrix=i.matrix,s.explodeMatrix&&(s.matrix=i.matrix.clone(),s.matrix.multiplyMatrices(a.explodeMatrix,a.matrix)),s.type=i.type}patchInstanceNodeInfo(e,t,i){const r=parseInt(e),a=this.mapNodeInfoByInstance.get(r);if(!a)return;const n=a.nodeIdMap.get(i.bufferId);if(!n)return;const s=n.get(i.instanceIndex);let o=this.tileReader.getNodeIdByIndex(s);o.geometryId=t,o.parent=t,o.matrix=i.entityMatrix.clone(),a.explodeMatrix&&(o.matrix=i.entityMatrix.clone(),o.matrix.multiplyMatrices(a.explodeMatrix,o.matrix)),o.type=i.type}getInstanceMatrixListByUserIdAndMeshId(e,t){const i=this.mapNodeInfoByInstance.get(e);return i?r.BimtilesObjectInfoDict2.getInstanceMatrixListByUserIdAndMeshId(i,t,this.tileReader):[]}getBatchedNodeInfoByUserIdCallback(e,t){const i=parseInt(e),a=this.mapNodeInfoByBatched.get(i);a&&r.BimtilesObjectInfoDict2.getBatchedNodeInfoByTileReader(a,this.tileReader,((e,i)=>{const r={instanceOrNot:!1,meshId:i.nodeId,parent:i.parent,nodeInfo:i};t&&t(r)}))}getBatchedNodeInfoByUserIdTileIdCallback(e,t,i){const a=parseInt(e);t=parseInt(t);const n=this.mapNodeInfoByBatched.get(a);n&&r.BimtilesObjectInfoDict2.getBatchedNodeInfoByTileReaderWithTileId(n,t,this.tileReader,((e,t)=>{const r={instanceOrNot:!1,meshId:t.nodeId,parent:t.parent,nodeInfo:t};i&&i(r)}))}getInstanceNodeInfoByUserIdCallback(e,t){const i=parseInt(e),a=this.mapNodeInfoByInstance.get(i);a&&r.BimtilesObjectInfoDict2.getInstanceNodeInfoByTileReader(a,this.tileReader,((e,i)=>{const r={instanceOrNot:!0,meshId:i.nodeId,parent:i.parent,nodeInfo:i};t&&t(r)}))}getInstanceNodeInfoByUserIdTileIdCallback(e,t,i){const a=parseInt(e);t=parseInt(t);const n=this.mapNodeInfoByInstance.get(a);n&&r.BimtilesObjectInfoDict2.getInstanceNodeInfoByTileReaderWithTileId(n,t,this.tileReader,((e,t)=>{const r={instanceOrNot:!0,meshId:t.nodeId,parent:t.parent,nodeInfo:t};i&&i(r)}))}getAnyUserData(){for(const e of this.mapNodeInfoByBatched.values())return e.userData}getUserDataByUserId(e){const t=parseInt(e);let i=this.mapNodeInfoByBatched.get(t);return i?i.userData:(i=this.mapNodeInfoByInstance.get(t),i?i.userData:void 0)}getAllNodeInfosCallback(e){for(const t of this.mapNodeInfoByBatched.values())r.BimtilesObjectInfoDict2.getBatchedNodeInfoByTileReader(t,this.tileReader,((t,i)=>{e(i)}));for(const t of this.mapNodeInfoByInstance.values())r.BimtilesObjectInfoDict2.getInstanceNodeInfoByTileReader(t,this.tileReader,((t,i)=>{e(i)}))}patchBoxExplodeMatrix(e,t,i){const r=parseInt(t);let a=null;a=i?this.mapNodeInfoByInstance.get(r):this.mapNodeInfoByBatched.get(r),a.loadedExplodeMatrix=e}patchExplodeMatrix(e,t,i){const r=parseInt(t);let a=null;a=i?this.mapNodeInfoByInstance.get(r):this.mapNodeInfoByBatched.get(r),a.explodeMatrix=e}patchLoadedTileExplodeMatrix(e,t,i,r,a){const n=parseInt(t);if(a){const t=this.mapNodeInfoByInstance.get(n).nodeIdMap.get(i).get(r);return void(this.tileReader.getNodeIdByIndex(t).matrix=e)}const s=this.mapNodeInfoByBatched.get(n).nodeIdMap.get(i);this.tileReader.getNodeIdByIndex(s).matrix=e}verifyNodeInfos(){for(const e of this.mapNodeInfoByBatched.values()){const t=e.nodeIdMap;for(const i in t){const r=t.get(i);void 0===this.tileReader.getNodeIdByIndex(r).parent&&console.log(e)}}for(const e of this.mapNodeInfoByInstance.values()){const t=e.nodeIdMap;for(const i in t){const r=t.get(i);for(const t in r){const i=r[t];void 0===this.tileReader.getNodeIdByIndex(i).parent&&console.log(e)}}}}getUserTileIdMap(e,t){this.getNodeInfoByUserIdCallback(e,(e=>{const i=e.nodeInfo;t[i.tileId]=null}))}}r.BimtileNodeIdDescriptor=e}(),function(){class e extends r.BimTileReader{constructor(){super(),this.searchTreeManager=new r.BimTileNewSearchTreeManager(this),this.nodeIdTool=new r.BimTileNodeIdTool,this.nodeBoxTool=new r.BimTileNodeBoxTool,this.descriptor=new r.BimtileNodeIdDescriptor(this)}getNodeIdByIndex(e){return this.nodeIdTool.getNodeIdByIndex(e)}getNodeBoxByIndex(e){return this.nodeBoxTool.getNodeBoxByIndex(e)}parseBlock(e,t,i){const a=t.node,n=t.type,s=t.url,o=t.outline;let l=!0,d=0,h=[];a.bufferType=n;let c=0;const u=e.byteLength;for(a.buffer=r.Utils.isDefined(a.buffer)?a.buffer:{},a.lineBuffer=r.Utils.isDefined(a.lineBuffer)?a.lineBuffer:{},a.outlineBuffer=r.Utils.defaultValue(a.outlineBuffer,{});c<u;){const t=e.slice(c,c+4);let i=new Uint32Array(t)[0];c+=4;const u=new Uint8Array(e,c,i);c+=i;const m=proto.bimtile_pbf.BlockHeader.deserializeBinary(u);l&&m.getDataType(),i=m.getDataSize(),r.TilesUtil.max_uncompressed_blob_size;var p=new Uint8Array(e,c,i);if(c+=i,m.getCompressType()!=proto.bimtile_pbf.BlockHeader.CompressType.CT_NULL)return void console.warn("uncompress data into buffer");const f=m.getDataType();let g={};switch(f){case proto.BlockHeader.BlockType.BT_INDEX:const e=proto.bimtile_pbf_v2.SearchTreeBlob.deserializeBinary(p);g.type=f,g.content=e,a.buffer[d]=g;break;case proto.BlockHeader.BlockType.BT_USERID:const t=proto.bimtile_pbf_v2.UserIDBlob.deserializeBinary(p);if(n===r.TileContentType.DATA_GLOBAL_USER_ID){this.userIdTool.parseUserIdBuffer(t);break}g.type=f,g.content=t,a.buffer[d]=g;break;case proto.BlockHeader.BlockType.BT_NODEID:const i=proto.bimtile_pbf_v2.NodeIDList.deserializeBinary(p);if(n===r.TileContentType.DATA_GLOBAL_NODE_ID){this.nodeIdTool.parseNodeIdBuffer(i,s);break}break;case proto.BlockHeader.BlockType.BT_NODEBOX:const l=proto.bimtile_pbf_v2.NodeBBoxBlob.deserializeBinary(p);if(n===r.TileContentType.DATA_GLOBAL_NODE_BOX){this.nodeBoxTool.parseNodeBoxBuffer(l,s);break}break;case proto.BlockHeader.BlockType.BT_MATERIAL:const h=proto.bimtile_pbf.MaterialBlob.deserializeBinary(p);if(g.type=f,g.content=h,n===r.TileContentType.DATA_GLOBAL_MATERIAL){this.globalMaterialBuffer=h;break}a.buffer[d]=g;break;case proto.BlockHeader.BlockType.BT_USERDATA:const c=proto.bimtile_pbf.UserdataBlob.deserializeBinary(p);if(n===r.TileContentType.DATA_GLOBAL_USER_DATA){this.userDataTool.parseUserDataBuffer(c);break}g.type=f,g.content=c,a.buffer[d]=g;break;case proto.BlockHeader.BlockType.BT_BUFFER:const u=proto.bimtile_pbf.BufferBlob.deserializeBinary(p);g.type=f,g.content=u,n===proto.BlockHeader.BlockType.BT_LINE?o?a.outlineBuffer[d]=g:a.lineBuffer[d]=g:a.buffer[d]=g;break;case proto.BlockHeader.BlockType.BT_MESH:const m=proto.bimtile_pbf.MeshBlob.deserializeBinary(p);g.type=f,g.content=m,a.buffer[d]=g;break;case proto.BlockHeader.BlockType.BT_POINT:const v=proto.bimtile_pbf.PointBlob.deserializeBinary(p);g.type=f,g.content=v,a.buffer[d]=g;break;case proto.BlockHeader.BlockType.BT_TILEID:const y=proto.bimtile_pbf.TileIDBlob.deserializeBinary(p);if(g.type=f,g.content=y,n===r.TileContentType.DATA_GLOBAL_TILE_ID){this.globalTileIdBuffer=y;break}a.buffer[d]=g;break;case proto.BlockHeader.BlockType.BT_INSTANCE:const M=proto.bimtile_pbf.InstanceBlob.deserializeBinary(p);g.type=f,g.content=M,a.buffer[d]=g;break;case proto.BlockHeader.BlockType.BT_LINE:const E=proto.bimtile_pbf.MeshBlob.deserializeBinary(p);g.type=f,g.content=E,n===proto.BlockHeader.BlockType.BT_LINE&&o?a.outlineBuffer[d]=g:a.lineBuffer[d]=g;break;case proto.BlockHeader.BlockType.BT_VIEWTREE:const b=proto.bimtile_pbf.ViewTree.deserializeBinary(p);if(g.type=f,g.content=b,n==r.TileContentType.DATA_GLOBAL_PRECUTTING_TREE){this.globalPrecuttingTreeBuffer=b;break}a.buffer[d]=g;break;default:return void console.warn("Parse unknow block faild! ")}l&&(l=!1),h[d]=d,d++}i&&i()}createNodeInfoMap(){const e=this.nodeIdTool.nodeIdMap;for(const t in e)this.getDescriptor()._classifyNodeInfo(t);this.userIdTool.disposeBuffer()}}r.BimTilesNewReader=e}(),function(){class e extends r.BimTileSearchTreeManager{constructor(e){super(e),this.scratchVector=new THREE.Vector3,this.lineBoxScale=r.GlobalData.LineSelectRange/2*.1}intersect(e,t,i,a,n,s){let o,l=r.Utils.scratchBoundingBox,d=this.scratchVector;const h=this.is2D,c=this.lineBoxScale;if(!t){let t=r.Utils.scratchMatrix4_1;t.copy(a).invert(),o=e.ray.clone().applyMatrix4(i).applyMatrix4(t)}let u=t?function(e){let i=l.copy(e);return i.applyMatrix4(a),t.intersectsBox(i)?1:-1}:function(e){return!0===h&&(e.getSize(d),d.x<.001||d.y<.001?e.expandByScalar(c):(e.min.z-=c,e.max.z+=c)),o.intersectBoxWithDistance(e)},p={};const m=this.searchTreeBuffer;for(const e in m){const t=m[e].searchTreeBlob,i=m[e].box,a=u(i);if(!s&&a<0)continue;const n=t.getOctreeList(),o=t.getOctreeList()[0];let l=(e,t)=>{const i=r.TilesUtil.getBox(t.getBboxList()),a=u(i);if(!s&&a<0)return;let n=t.getNodesList();const o=n.length;for(let e=0;e<o;++e){const t=n[e],i=this.reader.getNodeIdByIndex(t),r=i.boundingBox,a=u(r);if(!s&&a<0)continue;const o=i.nodeId;void 0===p[i.userId]?p[i.userId]=[o]:p[i.userId].push(o)}t.getChildrenList().map((t=>{const i=e[t];l(e,i)}))};l(n,o)}return p}getObjectsInBoxByBimtile(e,t,i,a,n){let s=r.Utils.scratchBoundingBox,o=(e,t,r)=>{let a=s.copy(e).applyMatrix4(t).applyMatrix4(r);return!!i.intersectsBox(a)&&(n(a)?1:2)};const l=this.searchTreeBuffer,d=t.getTransformMatrix();for(const t in l){const i=l[t].searchTreeBlob,n=l[t].box;if(!o(n,d,a))continue;i.getNodeIdsList();const s=i.getOctreeList(),h=i.getOctreeList()[0];let c=(t,i)=>{const n=r.TilesUtil.getBox(i.getBboxList());if(!o(n,d,a))return;let s=i.getNodesList();for(let t=0,i=s.length;t<i;++t){const i=s[t],r=this.reader.getNodeIdByIndex(i),n=r.boundingBox;if(2!==o(n,d,a))continue;const l=r.userId,h=this.reader.getUserIdByIndex(l);e[h]=!0}i.getChildrenList().map((e=>{const i=t[e];c(t,i)}))};c(s,h)}}getUserIdsInFrustum(e,t,i,a,n,s){const o=e.getOctreeList(),l=e.getOctreeList()[0];let d=new THREE.Box3,h=(e,o)=>{const l=r.TilesUtil.getBox(o.getBboxList());if(d.copy(l),d.applyMatrix4(a).applyMatrix4(n),!t.intersectsBox(d)&&!s)return;let c=o.getNodesList();const u=c.length;for(let e=0;e<u;++e){const r=c[e],o=this.reader.getNodeIdByIndex(r),l=o.boundingBox;if(d.copy(l),d.applyMatrix4(a).applyMatrix4(n),!t.intersectsBox(d)&&!s)continue;const h=o.nodeId;void 0===i[o.userId]?i[o.userId]=[h]:i[o.userId].push(h)}o.getChildrenList().map((t=>{const i=e[t];h(e,i)}))};h(o,l)}}r.BimTileNewSearchTreeManager=e}(),function(){class e{constructor(){}static isVersion_1(t){return t===e.VERSION_1}static isVersion_2(t){return t===e.VERSION_2}static isVersion_3(t){return t===e.VERSION_3}}e.VERSION_1="0.0.1",e.VERSION_2="0.0.2",e.VERSION_3="0.0.3",r.BimTilesVersionControl=e}(),function(){class e extends r.BimtilesObjectInfoDict{constructor(){super()}setTileReader(e){this.tileReader=e}getNodeInfoCallback(e){const t=this.tileReader.descriptor;for(const i in t.userIdInfoMap)e&&e(i,t.userIdInfoMap[i]);for(const i in t.userIdInstanceInfoMap)e&&e(i,t.userIdInstanceInfoMap[i])}getUserDataCallback(e){const t=this.tileReader.descriptor;for(const i in t.userIdInfoMap)e&&e(i,t.userIdInfoMap[i]);for(const i in t.userIdInstanceInfoMap)e&&e(i,t.userIdInstanceInfoMap[i])}setIdsState(e,t,i){const r=this.tileReader.descriptor;if(!0===t||void 0===t){for(const t of e.keys()){let e=r.userIdInfoMap[t];e||(e=r.patchUserIdState(t)),i&&i(e),e=r.userIdInstanceInfoMap[t],e||(e=r.patchUserIdState(t)),i&&i(e)}return}this.tileReader.userIdTool.getAllUserIndex().forEach((t=>{t=parseInt(t);let a=r.userIdInfoMap[t]||r.userIdInstanceInfoMap[t];a||(a=r.patchUserIdState(t)),e.has(t)||i&&i(a)}))}getNodeInfoById(e){const t=this.tileReader.descriptor;return t.userIdInfoMap[e]?t.userIdInfoMap[e]:t.userIdInstanceInfoMap[e]?t.userIdInstanceInfoMap[e]:void 0}}e.getBatchedNodeInfoByTileReader=(e,t,i)=>{const r=e.nodeIdMap;for(const[e,i]of r){t.getNodeIdByIndex(i)}},e.getBatchedNodeInfoByTileReaderWithTileId=(e,t,i,r)=>{const a=e.nodeIdMap;for(const[n,s]of a){let a=i.getNodeIdByIndex(s);a&&a.tilId===t&&(r&&r(e.userId,a))}},e.getInstanceNodeInfoByTileReader=(e,t,i)=>{const r=e.nodeIdMap;for(const[a,n]of r)for(const[r,a]of n){let r=t.getNodeIdByIndex(a);r&&(i&&i(e.userId,r))}},e.getInstanceMatrixListByUserIdAndMeshId=(e,t,i)=>{let r=[];const a=e.nodeIdMap.get(t);if(!a)return r;for(const[e,t]of a){let e=i.getNodeIdByIndex(t);e&&r.push(e.matrix)}return r},e.getInstanceNodeInfoByTileReaderWithTileId=(e,t,i,r)=>{const a=e.nodeIdMap;for(const[n,s]of a)for(const[a,n]of s){let a=i.getNodeIdByIndex(n);a&&a.tilId===t&&(r&&r(e.userId,a))}},r.BimtilesObjectInfoDictV3=e;class t extends r.BimtileObjectInfoManager{constructor(){super(),this.objectInfoDict=new r.BimtilesObjectInfoDictV3}setTileReader(e){this.tileReader=e,this.objectInfoDict.setTileReader(e)}calculateVisibleComponentsBbox(){this._boundingBox.makeEmpty();this.objectInfoDict.getNodeInfoCallback(((e,t)=>{if(this.isHidden(e))return;const i=this.tileReader.getUserIdBoxByIndex(t.userId);i&&!i.isEmpty()?(this._boundingBox.expandByPoint(i.min),this._boundingBox.expandByPoint(i.max)):console.warn("Object has no this._boundingBox, id is "+e)})),this.explodeBoxNeedUpdate=!1}matchConditions(e,t){let i=[],r=[];this.objectInfoDict.getUserDataCallback(((t,a)=>{const n=this.tileReader.getUserDataIndexByUserIndex(t),s=this.tileReader.getUserDataByIndex(n)||{};s.elementId=a.userId;this.isMatchConditions(s,e)?i.push(t):r.push(t)})),t&&t(i,!0),t&&t(r,!1)}getMatchIds(e){let t=[];return this.objectInfoDict.getUserDataCallback(((i,r)=>{const a=this.tileReader.getUserDataIndexByUserIndex(i),n=this.tileReader.getUserDataByIndex(a)||{};n.elementId=r.userId;this.isMatchConditions(n,e)&&t.push(i)})),t}}r.BimtileObjectInfoManagerV3=t}(),function(){class e extends r.BimTileFilterManager{constructor(e){super(e),this.objectInfoManager=new r.BimtileObjectInfoManagerV3}destroy(){super.destroy()}standardApply(e){if(this.stateChangedRenderer===e.stateChangedRenderer)return;const t=this.model.getDescriptor().tileUserIdMap,i=e._content.meshes,r=t.get(e.contentId),a=this.model.getDescriptor();if(this._collectBlinkUserIds(e,r),this._collectHoverUserIds(e,r),this._collectClippingUserIds(e,r),this._collectLocalClipUserIds(e,r),this._collectModifyOpacityUserIds(e,r),this._collectFilteredUserIds(e,r,a,!1),!this._needsUpdate(e))return e._content.clearCopyMeshes(),this.resetStandardNodeStates(i),void this.releaseObject(e);e._content.clearCopyMeshes(),this.resetStandardNodeStates(i),this.rebuildIndices(e,a,i),this.releaseObject(e)}resetStandardNodeStates(e){e.traverse((e=>{if("MeshEx"!==e.type&&"LineSegmentsEx"!==e.type)return;e.material=[e.material[0]];let t=e.geometry;t.clearGroups(),t._visible=!0,t.addGroup(0,t.index.count,r.Model.EnumFilterState.NONE),t.attributes.idState.array.fill(1),t.attributes.idState.needsUpdate=!0}))}wireFrameStandardApply(e){if(e.isOutlineLoading())return;if(!1===e.forceUpdateWireFrame&&this.stateWireFrameChangedRenderer===e.stateWireFrameChangedRenderer)return;const t=e._content._outlineContent.outlineMeshes,i=e.userIndexMap,r=this.model.getDescriptor();if(this._collectWireFrameFilteredUserIds(e,i,r),!this._needsWireFrameUpdate(e))return this.resetWireFrameNodeStates(t),void this.releaseWireFrameObject(e);this.resetWireFrameNodeStates(t),this.rebuildWireFrameIndices(e,r),this.releaseWireFrameObject(e)}instanceApply(e){if(this.stateChangedRenderer===e.stateChangedRenderer)return;const t=this.model.getDescriptor().tileUserIdMap,i=e._content.meshes,r=t.get(e.contentId),a=this.model.getDescriptor();if(this._collectBlinkUserIds(e,r),this._collectHoverUserIds(e,r),this._collectClippingUserIds(e,r),this._collectLocalClipUserIds(e,r),this._collectModifyOpacityUserIds(e,r),this._collectFilteredUserIds(e,r,a,!0),!this._needsUpdate(e))return this.resetInstanceMaterial(i),void this.releaseObject(e);this.resetInstanceMaterial(i),this._updateInstanceMaterial(e,a,i),this.releaseObject(e)}wireFrameInstanceApply(e){if(e.isOutlineLoading())return;if(!1===e.forceUpdateWireFrame&&this.stateWireFrameChangedRenderer===e.stateWireFrameChangedRenderer)return;const t=e.userIndexMap,i=this.model.getDescriptor(),r=e._content._outlineContent.outlineMeshes;if(this._collectWireFrameFilteredUserIds(e,t,i),!this._needsWireFrameUpdate(e))return this.resetInstanceWireFrameMaterial(r),void this.releaseWireFrameObject(e);this.resetInstanceWireFrameMaterial(r),this._updateInstanceWireFrameMaterial(e,i,r),this.releaseWireFrameObject(e)}traverseInstanceGeometryMap(e,t){e.traverse((e=>{"MeshEx"!==e.type&&"LineSegmentsEx"!==e.type||t(e)}))}traverseInstanceLineGeometryMap(e,t){e.traverse((e=>{"LineSegmentsEx"===e.type&&t(e.geometry)}))}resetInstanceMaterial(e){var t=this.model.localClippingMode?r.EnumInstanceState.CLIPPING:r.EnumInstanceState.NONE;this.traverseInstanceGeometryMap(e,(e=>{let i=e.geometry,a=e.material;i.getAttribute("vState").array.fill(r.EnumInstanceState.NONE),i.getAttribute("vState").needsUpdate=!0,i.getAttribute("vClipping").array.fill(t),i.getAttribute("vClipping").needsUpdate=!0,i.getAttribute("vState2")&&(i.getAttribute("vState2").array.fill(r.EnumInstanceState.HIDDEN),i.getAttribute("vState2").needsUpdate=!0),i.getAttribute("idState").array.fill(1),i.getAttribute("idState").needsUpdate=!0,2===a.length&&1==a[0]._referenceCount&&(a[1].visible=!1)}))}resetInstanceWireFrameMaterial(e){this.traverseInstanceLineGeometryMap(e,(e=>{e.getAttribute("vState").array.fill(r.EnumInstanceState.NONE),e.getAttribute("vState").needsUpdate=!0}))}_updateInstanceMaterial(e,t,i){for(const r of e.hiddenUserIdSetObject.keys())this._dealHideUserIndex(r,t,i,e.contentId);for(const a of e.localClipUserIdSetObject.keys())t.getUserIdInstanceInfoCallback(a,(t=>{const a=t.tileId[e.contentId];this.traverseInstanceGeometryMap(i,(e=>{const t=r.MaterialUtil.getColorParamsByMaterial(e.material[0]),i=r.EnumInstanceState.CLIPPING;for(const r in a)this.updateInstanceGeometry(e,t,i,r)}))}));for(const a of e.transparentUserIdSetObject.keys()){const n=this._filterImpl.getFrozonMaterial(),s=r.MaterialUtil.getColorParamsByMaterial(n),o=r.EnumInstanceState.OVERRIDED;this.updateInstanceGeometryByNodeInfos(a,t,s,o,i,e.contentId)}for(const a of e.overrideUserIdSetObject.keys())t.getUserIdInstanceInfoCallback(a,(t=>{const n=t.tileId[e.contentId],s=e.overrideUserIdSetObject&&e.overrideUserIdSetObject.get(a);var o;this.traverseInstanceGeometryMap(i,(t=>{let i=1;-1!==s.indexOf("material_modifyOpacity")?(i=e.modifyOpacityUserIdSetObject.get(a).opacity,o=this.getMaterialForModifyOpacityFrom(t.material[0],i)):(o=this._getMaterialByName(s),e.modifyOpacityUserIdSetObject&&e.modifyOpacityUserIdSetObject.get(a)&&(i=e.modifyOpacityUserIdSetObject.get(a).opacity,o=this.getMaterialForModifyOpacityFrom(o,i))),o.srcOpacity=i,this.model.materialManager.materialMap[s]=o;const l=r.MaterialUtil.getColorParamsByMaterial(o),d=r.EnumInstanceState.OVERRIDED;for(const e in n)this.updateInstanceGeometry(t,l,d,e)}))}));for(const a of e.hoverUserIdSetObject.keys())t.getUserIdInstanceInfoCallback(a,(t=>{const a=t.tileId[e.contentId];this.traverseInstanceGeometryMap(i,(e=>{const t=this.model.sceneState.getHoverMaterial(e.material[0]),i=r.MaterialUtil.getColorParamsByMaterial(t),n=r.EnumInstanceState.HOVER;for(const t in a)this.updateInstanceGeometry(e,i,n,t)}))}));for(const a of e.blinkUserIdSetObject.keys())t.getUserIdInstanceInfoCallback(a,(t=>{const n=t.tileId[e.contentId];this.traverseInstanceGeometryMap(i,(t=>{const i=r.MaterialUtil.getColorParamsByMaterial(t.material[0]),s=r.EnumInstanceState.BLINK;var o=this.getBlinkMaterialName(a,t.name,e.blinkUserIdSetObject.get(a));null==this.blinkMaterials[o]&&(this.blinkMaterials[o]={}),null==this.blinkMaterials[o][t.material[0].uuid]&&(this.blinkMaterials[o][t.material[0].uuid]=t.material[0]);for(const e in n)this.updateInstanceGeometry(t,i,s,e)}))}))}updateInstanceGeometry(e,t,i,a){const n=e.material[0]||e.material,s=t.rgbaColor;let o,l;n.transparent===t.transparent?(o=i,l=r.EnumInstanceState.HIDDEN):(o=r.EnumInstanceState.HIDDEN,l=i),void 0===e.material[0]&&(o=i,s.a>.999&&(n.transparent=!0,s.a=.999));let d=e.geometry;d.getAttribute("vState").array[a]=o,d.getAttribute("vState").needsUpdate=!0,void 0!==d.getAttribute("vState2")&&(d.getAttribute("vState2").array[a]=l),void 0!==d.getAttribute("vState2")&&(d.getAttribute("vState2").needsUpdate=!0);let h=this._getStateByColorList(s);if(i===r.EnumInstanceState.HOVER&&(h=this._getHoverStateValue({opacity:s[3]})),i!==r.EnumInstanceState.BLINK&&i!==r.EnumInstanceState.CLIPPING&&(d.getAttribute("idState").array[a]=h),i==r.EnumInstanceState.CLIPPING){if(void 0!==d.getAttribute("vClipping")&&(d.getAttribute("vClipping").array[a]=i),void 0!==d.getAttribute("vClipping")&&(d.getAttribute("vClipping").needsUpdate=!0),e.material instanceof Array)return this.addInstanceMaterialForClip(e.material[0].uuid,e.material[0]),void this.addInstanceMaterialForClip(e.material[1].uuid,e.material[1]);this.addInstanceMaterialForClip(e.material.uuid,e.material)}if(e.material instanceof Array)return e.material[0].needsUpdate=!0,e.material[1].needsUpdate=!0,void(e.material[1].visible=!0);e.material.needsUpdate=!0,d.getAttribute("idState").needsUpdate=!0}updateInstanceGeometryByNodeInfos(e,t,i,r,a,n){t.getUserIdInstanceInfoCallback(e,(e=>{const t=e.tileId[n];this.traverseInstanceGeometryMap(a,(e=>{for(const a in t)this.updateInstanceGeometry(e,i,r,a)}))}))}_updateInstanceWireFrameMaterial(e,t,i){for(const a of e.hiddenUserIdSetObject.keys())t.getUserIdInstanceInfoCallback(a,(t=>{const a=t.tileId[e.contentId];this.traverseInstanceGeometryMap(i,(e=>{let t=e.geometry;for(const e in a)t.getAttribute("vState").array[e]=r.EnumInstanceState.HIDDEN;t.getAttribute("vState").needsUpdate=!0}))}));for(const a of e.hiddenWireFrameUserIdSetObject.keys())t.getUserIdInstanceInfoCallback(a,(t=>{const a=t.tileId[e.contentId];this.traverseInstanceGeometryMap(i,(e=>{let t=e.geometry;for(const e in a)t.getAttribute("vState").array[e]=r.EnumInstanceState.HIDDEN;t.getAttribute("vState").needsUpdate=!0}))}));for(const a of e.overrideWireFrameUserIdSetObject.keys()){const n=e.overrideWireFrameUserIdSetObject.get(a),s=this._getMaterialByName(n);if(-1!==n.indexOf("material_modifyOpacity"))continue;const o=r.MaterialUtil.getColorParamsByMaterial(s),l=r.EnumInstanceState.OVERRIDED;this.updateInstanceWireFrameGeometryByNodeInfos(a,t,i,o,l,e.contentId)}}updateInstanceWireFrameGeometryByNodeInfos(e,t,i,r,a,n){t.getUserIdInstanceInfoCallback(e,(e=>{const t=e.tileId[n];this.traverseInstanceGeometryMap(i,(e=>{for(const i in t)this.updateInstanceGeometry(e,r,a,i)}))}))}_insertIndexMeshes(e,t,i,r,a){void 0===e.mergedMeshesStates[t]?(e.mergedMeshesStates[t]={},e.mergedMeshesStates[t][i]={},e.mergedMeshesStates[t][i].state=r,e.mergedMeshesStates[t][i].userId=a):void 0===e.mergedMeshesStates[t][i]&&(e.mergedMeshesStates[t][i]={},e.mergedMeshesStates[t][i].state=r,e.mergedMeshesStates[t][i].userId=a)}_collectLineMeshState(e,t,i){for(const r of t.keys()){const t=this.model.tilesLoader.userIdMapIndices[r];t&&t.map((t=>{const a=t.indexId,n=t.meshId;-1!==n.indexOf("line")&&this._insertIndexMeshes(e,n,a,i,r)}))}}_collectLineCategoryMeshState(e,t,i,a){for(let i of e.userIndexMap.keys())meshGroup.traverse((n=>{if("MeshEx"!==n.type&&"LineSegmentsEx"!==n.type)return;if(!n.indexGroups[i])return;const s=n.name;if(-1===s.indexOf("line"))return;if(r.TilesUtil.matchWireFrameVisibilityOption(i,t))return;const o=n.indexGroups[i].stateIndex;this._insertIndexMeshes(e,s,o,a,i)}))}_collectMeshState(e,t,i,r){for(const a of i.keys())t.traverse((t=>{if("MeshEx"!==t.type&&"LineSegmentsEx"!==t.type)return;if(!t.indexGroups.has(a))return;const i=t.name,n=t.indexGroups.get(a).stateIndex;this._insertIndexMeshes(e,i,n,r,a)}))}_collectMeshState2(e,t,i){for(const r in t)meshGroup.traverse((t=>{if("MeshEx"!==t.type&&"LineSegmentsEx"!==t.type)return;if(!t.indexGroups[r])return;const a=t.name,n=t.indexGroups[r].stateIndex;this._insertIndexMeshes(e,a,n,i,r)}))}rebuildWireFrameIndices(e,t){e.mergedMeshesStates={},this._collectLineMeshState(e,e.hiddenUserIdSetObject,r.Model.EnumFilterState.HIDDEN),this._collectLineMeshState(e,e.hiddenWireFrameUserIdSetObject,r.Model.EnumFilterState.HIDDEN),this._collectLineMeshState(e,e.overrideWireFrameUserIdSetObject,r.Model.EnumFilterState.OVERRIDED),this._collectLineMeshState(e,e.localClipUserIdSetObject,r.Model.EnumFilterState.LOCALCLIPPING);const i=e._content._outlineContent.outlineMeshes;for(const t in e.mergedMeshesStates){let r=i.getObjectByName(t);r&&this.rebuildMesh(r,t,e,[])}}rebuildIndices(e,t,i){e.mergedMeshesStates={},this._collectMeshState(e,i,e.hiddenUserIdSetObject,r.Model.EnumFilterState.HIDDEN),this._collectLineCategoryMeshState(e,this.model.tilesLoader.wireFrameVisibilityOption,t,r.Model.EnumFilterState.HIDDEN),this._collectMeshState(e,i,e.overrideUserIdSetObject,r.Model.EnumFilterState.OVERRIDED),this._collectMeshState(e,i,e.transparentUserIdSetObject,r.Model.EnumFilterState.TRANSPARENT),this._collectMeshState(e,i,e.hoverUserIdSetObject,r.Model.EnumFilterState.HOVER),this._collectMeshState(e,i,e.blinkUserIdSetObject,r.Model.EnumFilterState.BLINK),this._collectMeshState(e,i,e.clippingUserIdSetObject,r.Model.EnumFilterState.CLIPPING),this._collectMeshState(e,i,e.localClipUserIdSetObject,r.Model.EnumFilterState.LOCALCLIPPING);const a=this.model.sceneState.getHoverMaterial(),n=this._filterImpl.getFrozonMaterial(),s=[];s[r.Model.EnumFilterState.HOVER]=a,s[r.Model.EnumFilterState.TRANSPARENT]=n;for(const t in e.mergedMeshesStates){let r=i.getObjectByName(t);this.rebuildMesh(r,t,e,s)}}rebuildMesh(e,t,i,a){if(!e)return;let n=(e,t,i,a,n)=>{let s,o=null,l=t,d=0,h=!1;switch(t>r.Model.EnumFilterState.OVERRIDED&&(t=r.Model.EnumFilterState.OVERRIDED,a.blinkUserIdSetObject&&a.blinkUserIdSetObject.get(i)&&(t=r.Model.EnumFilterState.BLINK)),t){case r.Model.EnumFilterState.NONE:case r.Model.EnumFilterState.CLIPPING:break;case r.Model.EnumFilterState.HOVER:o=this.model.sceneState.getHoverMaterial(e.material[0]),e.material[r.Model.EnumFilterState.HOVER]=o;break;case r.Model.EnumFilterState.BLINK:s=this.getBlinkMaterialName(i,e.name,a.blinkUserIdSetObject.get(i)),null==this.blinkMaterials[s]?(this.blinkMaterials[s]={},o=this.model.sceneState.getBlinkMaterialV3(e.material[0],`${this.model.id}_${s}`),this.blinkMaterials[s][s]=o,o.name=s):null==this.blinkMaterials[s][s]?(o=this.model.sceneState.getBlinkMaterialV3(e.material[0],`${this.model.id}_${s}`),this.blinkMaterials[s][s]=o,o.name=s):o=this.blinkMaterials[s][s],a.localClipUserIdSetObject&&a.localClipUserIdSetObject.get(i)&&(o=this.getMaterialForClipFrom(o),this.blinkMaterials[s]=o),d=Math.max(e.material.length,t),h=!1;for(let i=t;i<d;++i)e.material[i]&&s===e.material[i].name&&(h=!0,l=i);if(!1===h){let t=d;d===r.Model.EnumFilterState.BLINK+1&&(t=r.Model.EnumFilterState.OVERRIDED+1),e.material[t]=o,l=t}break;case r.Model.EnumFilterState.OVERRIDED:s=a.overrideUserIdSetObject&&a.overrideUserIdSetObject.get(i);let c=1;e.name.indexOf("line")>-1&&a.overrideWireFrameUserIdSetObject&&a.overrideWireFrameUserIdSetObject.get(i)&&(s=a.overrideWireFrameUserIdSetObject.get(i)),-1!==s.indexOf("material_modifyOpacity")?(c=a.modifyOpacityUserIdSetObject.get(i).opacity,o=this.getMaterialForModifyOpacityFrom(e.material[0],c),!e.material[0].useCompressedColor||"cloudStandard"!==o.type&&"IBLMaterial"!==o.type||(o.defines.CCOLOR="",o.useCompressedColor=!0)):(o=this._getMaterialByName(s),a.modifyOpacityUserIdSetObject&&a.modifyOpacityUserIdSetObject.get(i)&&(c=a.modifyOpacityUserIdSetObject.get(i).opacity,o=this.getMaterialForModifyOpacityFrom(o,c))),o.srcOpacity=c,this.model.materialManager.materialMap[s]=o,a.localClipUserIdSetObject&&a.localClipUserIdSetObject.get(i)&&(o=this.getMaterialForClipFrom(o)),o.side=e.material[0].side,!e.material[0].useCompressedNormal||"cloudStandard"!==o.type&&"IBLMaterial"!==o.type||(o.defines.CNORMAL="",o.useCompressedNormal=!0),r.Utils.isDefined(e.material[0].useCompressedUv)&&e.material[0].useCompressedUv&&"cloudStandard"===o.type&&(o.uvCenter=e.material[0].uvCenter,o.uvHalfExtent=e.material[0].uvHalfExtent,o.defines.USE_COMPRESS_UV="",o.useCompressedUv=!0),d=Math.max(e.material.length,t),h=!1;for(let i=t;i<d;++i)s===e.material[i].name&&(h=!0,l=i);!1===h&&(e.material[d]=o,l=d);break;case r.Model.EnumFilterState.LOCALCLIPPING:o=this.getMaterialForClipFrom(e.material[0]),e.material[r.Model.EnumFilterState.LOCALCLIPPING]=o;break;default:n[t]&&(e.material[t]=n[t])}return l};const s=i.mergedMeshesStates[t];let o=e.geometry;let l=0;const d=(e=>{let t=[];for(const i of e.keys())t.push({userId:i,indexGroup:e.get(i)});return t.sort(((e,t)=>e.indexGroup.indexStart-t.indexGroup.indexStart)),t})(e.indexGroups),h=d.length;for(const t in s){const n=s[t],l=d[t].indexGroup,h=l.positionStart/3,c=l.positionEnd/3;d[t].userId;let u=0;switch(n.state){case r.EnumInstanceState.HIDDEN:o.attributes.idState.array.fill(0,h,c),delete s[t];break;case r.Model.EnumFilterState.HOVER:const l=this._getHoverMaterial(e.material[0]);u=this._getHoverStateValue(l),this._fillSecondState(e,l,u,h,c,i._content),delete s[t];break;case r.Model.EnumFilterState.TRANSPARENT:const p=a[r.Model.EnumFilterState.TRANSPARENT];u=this._getTransparentStateValue(p),this._fillSecondState(e,p,u,h,c,i._content),delete s[t];break;case r.Model.EnumFilterState.OVERRIDED:const m=this._getOverrideSecondMaterial(i,e,n.userId);u=this._getStateValue(m),this._fillSecondState(e,m,u,h,c,i._content),i.blinkUserIdSetObject.has(d[t].userId)?s[t].state=r.Model.EnumFilterState.BLINK:delete s[t]}}o.attributes.idState.needsUpdate=!0;let c=d[0].indexGroup.indexCount,u=r.Model.EnumFilterState.NONE;if(s[0]&&s[0].state!==r.Model.EnumFilterState.NONE){u=s[0].state;u=n(e,u,s[0].userId,i,a)}if(0!==Object.keys(s).length){o.clearGroups();for(let t=1;t<h;++t){const h=d[t].indexGroup;if(s[t]){const r=s[t].userId,d=n(e,s[t].state,r,i,a);d===u?c+=h.indexCount:(o.addGroup(l,c,u),u=d,l=h.indexStart,c=h.indexCount)}else if(u===r.Model.EnumFilterState.NONE)c+=h.indexCount;else{o.addGroup(l,c,u);n(e,u,s[t-1].userId,i,a),u=r.Model.EnumFilterState.NONE,l=h.indexStart,c=h.indexCount}}if(c>0&&u!==r.Model.EnumFilterState.HIDDEN){const t=n(e,u,s[h-1]&&s[h-1].userId,i,a);o.addGroup(l,c,t)}}}_getStateByColorList(e){return 256*parseInt(255*e[0])*256*256+256*parseInt(255*e[1])*256+256*parseInt(255*e[2])+parseInt(255*e[3])}_getStateValue(e){const t=e.color,i=e.opacity;return parseInt(256*t.getHex()+255*i)}_getHoverStateValue(e){const t=e.opacity;return 256*parseInt(255*t)+3}_getTransparentStateValue(e){const t=e.color;return parseInt(256*t.getHex()+r.Model.EnumFilterState.TRANSPARENT)}_getHoverMaterial(e){const t=e.clone();return t.opacity=r.MaterialUtil.getHoverOpacity(t.opacity),t.transparent=!0,t}_getOverrideSecondMaterial(e,t,i){let r=null;const a=e.overrideUserIdSetObject&&e.overrideUserIdSetObject.get(i);let n=1;return t.name.indexOf("line")>-1&&e.overrideWireFrameUserIdSetObject&&e.overrideWireFrameUserIdSetObject.get(i)&&(a=e.overrideWireFrameUserIdSetObject.get(i)),-1!==a.indexOf("material_modifyOpacity")?(n=e.modifyOpacityUserIdSetObject.get(i).opacity,r=this.getMaterialForModifyOpacityFrom(t.material[0],n)):(r=this._getMaterialByName(a),e.modifyOpacityUserIdSetObject&&e.modifyOpacityUserIdSetObject.get(i)&&(n=e.modifyOpacityUserIdSetObject.get(i).opacity,r=this.getMaterialForModifyOpacityFrom(r,n))),r.srcOpacity=n,this.model.materialManager.materialMap[a]=r,e.localClipUserIdSetObject&&e.localClipUserIdSetObject.get(i)&&(r=this.getMaterialForClipFrom(r)),r}_fillSecondState(e,t,i,a,n,s){if(e.material[0].transparent===t.transparent)return void e.geometry.attributes.idState.array.fill(i,a,n);e.geometry.attributes.idState.array.fill(0,a,n);const o=s.getCopyMeshes();let l=o.getObjectByName(e.name);r.Utils.defined(l)||(l=this.cloneMeshFrom(e,t),o.add(l),o.updateMatrixWorld(!0)),l.geometry.attributes.idState.array.fill(i,a,n)}cloneMeshFrom(e,t){const i=e.geometry,a=new THREE.BufferGeometry;a.setAttribute("position",i.getAttribute("position")),a.setAttribute("cNormal",i.getAttribute("cNormal")),a.setAttribute("id",i.getAttribute("id"));const n=new Uint32Array(e.geometry.attributes.idState.array.length).fill(0),s=new THREE.Uint32BufferAttribute(n,1);a.setAttribute("idState",s),i.getAttribute("color")&&a.setAttribute("color",i.getAttribute("color")),i.getAttribute("uv")&&a.setAttribute("uv",i.getAttribute("uv")),i.getAttribute("uv2")&&a.setAttribute("uv2",i.getAttribute("uv2")),i.getAttribute("uv3")&&a.setAttribute("uv3",i.getAttribute("uv3")),a.setIndex(i.getIndex());const o=e.material[0].clone();o.transparent=t.transparent;const l=new r.MeshEx(a,o);return l.databagId=e.databagId,l.fileId=e.fileId,l.name=e.name,l.frustumCulled=e.frustumCulled,e.matrix&&(l.matrix=e.matrix,l.matrixAutoUpdate=!1,l.updateMatrixWorld()),l}_collectWireFrameFilteredUserIds(e,t,i){const a=this._hasOverrideMaterialFilterForWireFrame(),n=this.model.tilesLoader.wireFrameVisibilityOption,s=!0!==n;if(e.hiddenUserIdSetObject||(e.hiddenUserIdSetObject=new Map),e.localClipUserIdSetObject||(e.localClipUserIdSetObject=new Map),e.hiddenWireFrameUserIdSetObject=new Map,e.overrideWireFrameUserIdSetObject=new Map,!a&&!s)return!1;for(const i in t){if(!this._hasOverrideMaterialForWireFrame({name:i}))continue;const t=this._getOverrideMaterialForWireFrame({name:i});e.overrideWireFrameUserIdSetObject.set(i,t.name)}for(const i in t)r.TilesUtil.matchWireFrameVisibilityOption(i,n)||e.hiddenWireFrameUserIdSetObject.set(i,!0);return!0}_collectFilteredUserIds(e,t,i,a){const n=this._hasHiddenFileIdFilter(),s=this._hasVisibleFilter()||this.model.hasHiddenSourceObjectUserId(),o=this._hasOverrideMaterialFilter(),l=this._hasTransparentFilter(),d=e.blinkUserIdSetObject.size>0,h=e.clippingUserIdSetObject.size>0,c=this._hasLocalClipping(),u=this._hasModifyOpacityList();let p=this.mapMaterialIdToUserIdsForFilter={};if(e.hiddenUserIdSetObject=new Map,e.overrideUserIdSetObject=new Map,e.transparentUserIdSetObject=new Map,n||s||o||l||d||c||u||h)for(const a of t.keys())i.getUserIdInfoCallback(a,(t=>{if(n&&this._isHiddenFileId(t)||s&&!1===this._isVisible(t)||this.model.isHiddenSourceObjectUserId(a))return void 0===p[t.materialId]&&(p[t.materialId]={}),void 0===p[t.materialId][r.Model.EnumFilterState.HIDDEN]&&(p[t.materialId][r.Model.EnumFilterState.HIDDEN]={}),p[t.materialId][r.Model.EnumFilterState.HIDDEN][a]=!0,void e.hiddenUserIdSetObject.set(a,!0);if(c&&e.localClipUserIdSetObject.has(a)&&(void 0===p[t.materialId]&&(p[t.materialId]={}),void 0===p[t.materialId][r.Model.EnumFilterState.LOCALCLIPPING]&&(p[t.materialId][r.Model.EnumFilterState.LOCALCLIPPING]={}),p[t.materialId][r.Model.EnumFilterState.LOCALCLIPPING][a]=!0),l&&this._isTransparent(t))return void 0===p[t.materialId]&&(p[t.materialId]={}),void 0===p[t.materialId][r.Model.EnumFilterState.TRANSPARENT]&&(p[t.materialId][r.Model.EnumFilterState.TRANSPARENT]={}),p[t.materialId][r.Model.EnumFilterState.TRANSPARENT][a]=!0,void e.transparentUserIdSetObject.set(a,!0);if(d&&e.blinkUserIdSetObject.has(a)&&(void 0===p[t.materialId]&&(p[t.materialId]={}),void 0===p[t.materialId][r.Model.EnumFilterState.BLINK]&&(p[t.materialId][r.Model.EnumFilterState.BLINK]={}),p[t.materialId][r.Model.EnumFilterState.BLINK][a]=!0),o&&this._hasOverrideMaterial(t)){var i=this._getOverrideMaterial(t);""!==(h=null!=i?i.name:"")&&(void 0===p[t.materialId]&&(p[t.materialId]={}),void 0===p[t.materialId][r.Model.EnumFilterState.OVERRIDED]&&(p[t.materialId][r.Model.EnumFilterState.OVERRIDED]={}),p[t.materialId][r.Model.EnumFilterState.OVERRIDED][a]=h,e.overrideUserIdSetObject.set(a,h))}else if(u&&e.modifyOpacityUserIdSetObject.has(a)){var h=`material_modifyOpacity_${e.modifyOpacityUserIdSetObject.get(a).opacity}`;e.overrideUserIdSetObject.set(a,h)}else;}))}_dealHideUserIndex(e,t,i,a){t.getUserIdInstanceInfoCallback(e,(e=>{const t=e.tileId[a];this.traverseInstanceGeometryMap(i,(e=>{let i=e.geometry;for(const e in t)i.getAttribute("vState").array[e]=r.EnumInstanceState.HIDDEN,i.getAttribute("vState").needsUpdate=!0,i.getAttribute("vState2")&&(i.getAttribute("vState2").array[e]=r.EnumInstanceState.HIDDEN,i.getAttribute("vState2").needsUpdate=!0)}))}))}_updateInstanceDemandMaterial(e,t,i){const r=this.model.onDemandManager.idMap;for(let a of t.keys())r[a]||this._dealHideUserIndex(a,i,meshGroup,e.contentId)}}r.BimTileFilterManagerV3=e}(),r.BimTileUserIdInfoV3=class{constructor(){this._userId=void 0,this._userData=void 0,this._boundingBox=null,this._instanceOrNot=!1,this._tileId={},this._lineId=void 0,this._parent=void 0,this._materialId=void 0,this._type=void 0,this._state=r.EnumObjectState.Visible,this._explodeMatrix=void 0,this._loadedExplodeMatrix=void 0,this._material=void 0}destroy(){this._userId=void 0,this._userData=void 0,this._boundingBox=null,this._instanceOrNot=void 0,this._lineId=void 0,this._tileId=void 0,this._parent=void 0,this._materialId=void 0,this._state=void 0,this._explodeMatrix=void 0,this._type=void 0,this._explodeMatrix=void 0,this._loadedExplodeMatrix=void 0,this._material=void 0}clone(){return{index:this.index,userId:this.userId,boundingBox:this.boundingBox,instanceOrNot:this.instanceOrNot,matrix:this.matrix}}get state(){return this._state}set state(e){this._state=e}get name(){return this._userId}set name(e){this._userId=e}get userId(){return this._userId}set userId(e){this._userId=e}get tileId(){return this._tileId}addTileNodeId(e,t){this._tileId[e]||(this._tileId[e]={}),this._tileId[e][t]=!0}addTileIndexMatrix(e,t,i){this._tileId[e]||(this._tileId[e]={}),this._tileId[e][t]=i}get boundingBox(){return this._boundingBox}set boundingBox(e){this._boundingBox=e}get instanceOrNot(){return this._instanceOrNot}set instanceOrNot(e){this._instanceOrNot=e}get userData(){return this._userData}set userData(e){this._userData=e}get lineId(){return`outline_${this._tileId}`}get parent(){return this._parent}set parent(e){this._parent=e}get type(){return this._type}set type(e){this._type=e}get materialId(){return this._materialId}set materialId(e){this._materialId=e}set loadedExplodeMatrix(e){void 0!==this._loadedExplodeMatrix?this._loadedExplodeMatrix.multiplyMatrices(e,this._loadedExplodeMatrix):this._loadedExplodeMatrix=e}get loadedExplodeMatrix(){return this._loadedExplodeMatrix}get explodeMatrix(){return this._explodeMatrix}set explodeMatrix(e){this._explodeMatrix=e}get material(){return this._material}set material(e){this._material=e}},r.BimTileUserIDBoxTool=class{constructor(){this.globalUserIdBoxUrls={},this.globalUserIdBoxBuffers=[],this.userIdBoxMap=new Map}destroy(){this.globalUserIdBoxUrls=null,this.globalUserIdBoxBuffers=null,this.userIdBoxMap.clear(),this.userIdBoxMap=null}addGlobalUserIdBoxUrl(e,t){this.globalUserIdBoxUrls[e]=t}getGlobalUserIdBoxUrls(){return Object.keys(this.globalUserIdBoxUrls)}parseUserIdBoxBuffer(e,t){const i=this.globalUserIdBoxUrls[t];e.getBoxList().map(((e,t)=>{this.userIdBoxMap.set(i+t,r.TilesUtil.getBox(e.getBboxList()))})),e=null}getUserIdBoxByIndex(e){return this.userIdBoxMap.get(parseInt(e))}},function(){class e extends r.BimTileInstanceMeshBlobParser{constructor(e){super(e)}parse(e,t){if(!t||!t.buffer)return;const i=this._getBufferInfo(e,t);if(!i)return;const r=i.meshBlob.getNodesList();if(!r.length)return;this._traverseScenes(r,i);const a=this;return new Promise(((e,t)=>{Promise.all(a._parsePromiseArray).then((()=>{a._parsePromiseArray=null,e()})).catch((()=>{a._parsePromiseArray=null,t("some error when paser mesh block "+i.bufferId)}))}))}_traverseScenes(e,t){let i=0;e.forEach((e=>{let r=new THREE.Matrix4;16==e.getMatrixList().length&&r.fromArray(e.getMatrixList());const a={};a.nodeIndex=i++,a.matrix=r,a.sceneName="sceneName",this._parseBufferNode(e,a,t)}))}_getBufferInfo(e,t){const i=t.meshBlob.content,r=i.getBlobHeader(),a=r.getBufferBlockId(),n=t.buffer.content;if(!n)return null;const s=n.getBuffer();let o={};return o.contentIndex=t.contentIndex,o.meshBlob=i,o.buffer=n,o.bufferData=s,o.bufferId=`${r.getTileId()}_${a}`,o.loader=e,o.node=t,o.renderInstance=!this._renderDirectly,o}_resetMeshBuffer(e){const t=e.meshBlob.getBlobHeader(),i=(t.getBufferBlockId(),t.getMaterialBlockId()),r=t.getUserdataBlockId(),a=e.node.buffer.content,n=-1===i?e.loader.tileReader.globalMaterialBuffer:e.node.materialBuffer.content;e.buffer=a,e.materialBlockId=i,e.material=n,e.userdataBlockId=r,a&&(e.bufferData=a.getBuffer())}}r.BimTileInstanceMeshBlobParserV3=e}(),r.BimtileDescriptorV3=class{constructor(){this.userIdInfoMap={},this.userIdInstanceInfoMap={},this.tileUserIdMap=new Map,this.cacheExplodeMatrixMap={},this.cacheUserIdStateMap={}}destroy(){this.userIdInfoMap=null,this.userIdInstanceInfoMap=null,this.tileUserIdMap.clear(),this.tileUserIdMap=null,this.cacheExplodeMatrixMap=null,this.cacheUserIdStateMap=null}hasNodeInfo(){return this.userIdInfoMap[0]||this.userIdInstanceInfoMap[0]}patchMeshNodeInfo(e,t,i){if(this.userIdInfoMap[i])this.userIdInfoMap[i].addTileNodeId(t,e);else{const a=new r.BimTileUserIdInfoV3;if(a.addTileNodeId(t,e),a.userId=i,this.userIdInfoMap[i]=a,this.cacheExplodeMatrixMap[i]&&(a.explodeMatrix=this.cacheExplodeMatrixMap[i],delete this.cacheExplodeMatrixMap[i]),r.Utils.isDefined(this.cacheUserIdStateMap[i])){for(const e in this.cacheUserIdStateMap[i])a[e]=this.cacheUserIdStateMap[i][e];delete this.cacheUserIdStateMap[i]}}this.tileUserIdMap.has(t)||this.tileUserIdMap.set(t,new Map),this.tileUserIdMap.get(t).set(i,!0)}patchInstanceNodeInfo(e,t,i,a){if(this.userIdInstanceInfoMap[e])this.userIdInstanceInfoMap[e].addTileIndexMatrix(a,i.instanceIndex,i.entityMatrix.clone());else{const t=new r.BimTileUserIdInfoV3;if(t.instanceOrNot=!0,t.addTileIndexMatrix(a,i.instanceIndex,i.entityMatrix.clone()),t.userId=e,this.userIdInstanceInfoMap[e]=t,this.cacheExplodeMatrixMap[e]&&(t.explodeMatrix=this.cacheExplodeMatrixMap[e],delete this.cacheExplodeMatrixMap[e]),r.Utils.isDefined(this.cacheUserIdStateMap[e])){for(const i in this.cacheUserIdStateMap[e])t[i]=this.cacheUserIdStateMap[e][i];delete this.cacheUserIdStateMap[e]}}this.tileUserIdMap.has(a)||this.tileUserIdMap.set(a,new Map),this.tileUserIdMap.get(a).set(e,!0)}isUserIdExist(e){return this.userIdInfoMap[e]||this.userIdInstanceInfoMap[e]}getAllNodeInfos(){return[this.userIdInfoMap,this.userIdInstanceInfoMap]}getUserIdInfoByUserId(e){return this.userIdInfoMap[e]?this.userIdInfoMap[e]:this.userIdInstanceInfoMap[e]}getUserIdBatchedInfoCallback(e,t){this.userIdInfoMap[e]&&t&&t(this.userIdInfoMap[e])}getAllUserIdBatchedInfoCallback(e){for(const t in this.userIdInfoMap)e&&e(this.userIdInfoMap[t])}getUserIdInstanceInfoCallback(e,t){this.userIdInstanceInfoMap[e]&&t&&t(this.userIdInstanceInfoMap[e])}getAllUserIdInstanceInfoCallback(e){for(const t in this.userIdInstanceInfoMap)e&&e(this.userIdInstanceInfoMap[t])}getUserIdInfoCallback(e,t){this.getUserIdBatchedInfoCallback(e,t),this.getUserIdInstanceInfoCallback(e,t)}getAllUserIdInfoCallback(e){this.getAllUserIdBatchedInfoCallback(e),this.getAllUserIdInstanceInfoCallback(e)}getInstanceMatrixListByUserIdAndTileId(e,t){let i=[];const r=this.userIdInstanceInfoMap[e];if(r&&r.tileId[t]){const e=r.tileId[t];for(const t in e){let a=e[t];r.explodeMatrix&&(a=(new THREE.Matrix4).copy(r.explodeMatrix).multiply(e[t])),i.push(a)}}return i}patchExplodeMatrix(e,t){this.cacheExplodeMatrixMap[e]=t}patchUserIdState(e){return this.cacheUserIdStateMap[e]||(this.cacheUserIdStateMap[e]={userId:e,material:null,wireFrameMaterial:null,state:r.EnumObjectState.Visible}),this.cacheUserIdStateMap[e]}getBatchedNodeInfoByUserIdCallback(e,t){const i=parseInt(e),r=this.userIdInfoMap[i];if(r){const e=r.tileId;for(const i in e){const a=e[i];for(const e in a){const a={instanceOrNot:!1,meshId:`${i}_${e}`,nodeInfo:r};t&&t(a)}}}}getInstanceNodeInfoByUserIdCallback(e,t){const i=parseInt(e),r=this.userIdInstanceInfoMap[i];if(r){const e=r.tileId[tileId];for(const i in e){const r={instanceOrNot:!0};let a=e[i];r.meshId=meshId,r.matrix=a,r.index=i,r.nodeInfo=nodeInfo,t&&t(r)}}}getUserTileIdMap(e,t){let i=this.userIdInfoMap[e];if(i)for(const e in i.tileId)t[e]=null;if(i=this.userIdInstanceInfoMap[e],i)for(const e in i.tileId)t[e]=null}},function(){class e extends r.BimTileInstanceParser{constructor(e){super(e)}parseBlobs(e,t,i){t.isInstanceTile=!0,t.userIndexMap=new Map;proto.BlockHeader.BlockType.BT_INSTANCE;const r=t.buffer.content;r&&this.parseBlob(e,r,t,i)}parseBlob(e,t,i,a){if(!t)return;const n=t.getBlobHeader();let s=r.Utils.isDefined(i.contentInsModel)?i.contentInsModel:n.getEntityUrl();const o=`${r.Utils.isDefined(i.contentId)?i.contentId:n.getTileId()}_${n.getBlockId()}`,l=this._parseInstanceBlob(e,i,t,o),d={entityID:s,entityInfoArray:l.entityInfoArray};i.instanceInfo=d,this._sharedGeometryLoader.loadArrayBuffer(s,i._contentFolder,e).then((t=>{i.checkIfProcessingTileAvailable()&&this._loadInstanceEntityCallBack(t,e,i,this._renderDirectly).then((t=>{i.checkIfProcessingTileAvailable()&&(i.nodeIndexId=o,r.InstanceRenderManager.attachToNode(t,i,e,l,{renderDirectly:this._renderDirectly}),a&&a(i))}))})).catch((e=>{console.log(e)}))}_loadInstanceEntityCallBack(e,t,i,a){return new Promise(((n,s)=>{const o=this._parseInstanceEntityBlob(e,t.tileReader);o.contentIndex=i.contentIndex;const l=new r.BimTileInstanceMeshBlobParserV3({_delayLoadTexture:null,renderDirectly:a,materialManager:t.materialManager});l.parse(t,o).then((()=>{const e=this._bufferGeometry(l);l.destroy(),n(e)})).catch((e=>{s(e)}))}))}}r.BimTileInstanceParserV3=e}(),function(){class e extends r.BimTileMeshParser{constructor(e){super(e),this.loader=e.loader}destroy(){}parseBlobs(e,t,i){const r=t.meshBlob&&t.meshBlob.content;if(!r)return;t._parsePromiseArray=[],this.parseNodes(r,t,i);new Promise(((e,i)=>{Promise.all(t._parsePromiseArray).then((()=>{t._parsePromiseArray=null,t.meshBlob=null,t.buffer=null,e()})).catch((()=>{t._parsePromiseArray=null,i("some error when paser tile "+t._contentIndex)}))})).then((()=>{t.content&&(this.getUserIdInfo(r,t.content.meshes),i&&i(t))}))}parseNodes(e,t,i){const r=e.getNodesList();for(let a=0;a<r.length;++a)this.parseNode(r[a],a,e,t,i)}parseNode(e,t,i,a,n){const s=this.getTileId(a,i.getBlobHeader());let o=new THREE.Matrix4;if(16==e.getMatrixList().length){o.fromArray(e.getMatrixList());let t=e.getTranslationList();r.Utils.isDefined(t)&&3===t.length&&o.setPosition(t[0],t[1],t[2])}const l=o.multiply(a.matrix),d=e.getPrimitivesList(),h=d.length,c=e.getNodeType(),u=e.getUvboxList();let p=null,m=null;if(u.length>=4&&(p=new THREE.Vector2(0,0),m=new THREE.Vector2(0,0),p.x=(u[0]+u[1])/2,p.y=(u[2]+u[3])/2,m.x=(u[1]-u[0])/2,m.y=(u[3]-u[2])/2),c!=proto.bimtile_pbf.Node.NodeType.NT_BATCHED_SUB_NODE)for(let t=0;t<h;t++){const r=d[t],n=i.getPrimitivesList()[r];n.matrix=l,n.tileId=s,n.nodeIndex=e.getNodeid(),n.nodeIndexId=`${s}_${n.nodeIndex}`,n.lineTileId=`${s}_${n.nodeIndex}`,n.uvCenter=p,n.uvHalfExtent=m,this.createMesh(n,i,a)}}createMesh(e,t,i){if((e.getAccVertices()<0||e.getAccIndices()<0)&&e.getAccArchive()<0)return void console.warn("invalid acc info");const r=this.createGeometryByPrimitive(e,t,i);let a=new Promise((t=>{this.materialManager.getMaterial(this.loader,{materialBlockId:-1,bufferData:i.buffer.content.getBuffer(),material:this.loader.tileReader.getBuffer(i,-1,proto.BlockHeader.BlockType.BT_MATERIAL)},e,(e=>{t(e)}))}));a.then((t=>{this.createMeshNode(e,i,r,t)})),i._parsePromiseArray.push(a)}createGeometryByPrimitive(e,t,i){t.getBlobHeader();const r=i.buffer.content.getBuffer();let a=new THREE.BufferGeometry;const n={},s=this._getUserIds(t,r,n,e),o=this._getNormal(t,r,n,e),l=this._getVertex(t,r,n,e),d=this._getIndex(t,r,n,e),h=this._getTextureCoord(t,r,n,e),c=this._getColor(t,r,n,e);a.setAttribute("position",l.vertexBufferAttribute),a.setIndex(d.indexBufferAttribute),a.setAttribute("id",s);const u=new Uint32Array(s.count).fill(1),p=new THREE.Uint32BufferAttribute(u,1);return a.setAttribute("idState",p),h.uvBufferAttribute&&a.setAttribute("uv",h.uvBufferAttribute),h.uv2BufferAttribute&&a.setAttribute("uv2",h.uv2BufferAttribute),h.uv3BufferAttribute&&a.setAttribute("uv3",h.uv3BufferAttribute),o&&e.useCompressedNormal&&a.setAttribute("cNormal",o),o&&!e.useCompressedNormal&&a.setAttribute("normal",o),c&&a.setAttribute("color",c),a.clearGroups(),a.groups.push({start:0,count:n.iAccInfoCount,materialIndex:0}),a}createMeshNode(e,t,i,a){if(!t.content)return;let n=null;if(e.getMode()===proto.bimtile_pbf.Primitive.PrimitiveMode.PM_LINES)n=new r.LineSegmentsEx(i,[a]);else n=new r.MeshEx(i,[a]);n.applyMatrix4(e.matrix),n.name=e.nodeIndexId,n.tileId=e.tileId,n.nodeId=e.nodeIndex,n.databagId=t.content.meshes.databagId,n.fileId=t.content.meshes.fileId;var s=this.loader.filter.model;r.GlobalData.EnableShadowMap&&(n.castShadow=s.castShadow,n.receiveShadow=s.receiveShadow),n.matrixAutoUpdate=!1,t.content.meshes.add(n),t.content.meshes.updateMatrixWorld(!0)}getUserIdInfo(e,t){const i=e.getBlobHeader().getTileId(),r=e.getUseridindexinfosList();let a={},n=0;r.forEach((e=>{const t=e.getNodeid(),r=e.getUseridindex(),s=e.getIndexstart(),o=3*e.getPositionstart(),l=3*(e.getPositionend()+1),d=l-o,h=e.getIndexend();0==s&&(n=0);const c={positionStart:o,positionEnd:l,positionCount:d,indexStart:s,indexEnd:h,stateIndex:n,indexCount:h-s,cNormalStart:o/3*2,cNormalCount:d/3*2};n++,this.loader.patchMeshNodeInfo(t,i,r),a[t]||(a[t]=new Map),a[t].set(r,c)})),t.children.forEach((e=>{a[e.nodeId]&&(e.indexGroups=a[e.nodeId])})),a=null}getTileId(e,t){return t.getTileId()}_getAccInfo(e,t){if(t<0)return{offset:0,length:0,count:0};const i=e.getBufferaccsList()[t];return{offset:i.getByteOffset(),length:i.getByteLength(),count:i.getCount(),valueType:i.getValueType()}}_getUserIds(e,t,i,r){const a=this._getAccInfo(e,r.getAccUserids());if(a.count>0){const e=t.slice(a.offset,a.offset+a.length).buffer;let r=new Uint32Array(e);return i.uAccInfoStart=a.offset,new THREE.BufferAttribute(r,1)}return null}_getNormal(e,t,i,r){const a=this._getAccInfo(e,r.getAccNormals());if(a.count>0){let e,n;const s=t.slice(a.offset,a.offset+a.length).buffer;switch(i.nAccInfoStart=a.offset,i.nAccInfoCount=a.count,a.valueType){case proto.bimtile_pbf.BufferAcc.ComponentType.CT_UBYTE:e=new Uint8Array(s),r.useCompressedNormal=!0,n=new THREE.BufferAttribute(e,2);break;case proto.bimtile_pbf.BufferAcc.ComponentType.CT_FLOAT:e=new Float32Array(s),r.useCompressedNormal=!1,n=new THREE.BufferAttribute(e,3)}return n}return null}_getVertex(e,t,i,r){const a=this._getAccInfo(e,r.getAccVertices()),n=t.slice(a.offset,a.offset+a.length).buffer;let s=new Float32Array(n);i.vAccInfoStart=a.offset;return{vertexBufferData:n,vertexBufferAttribute:new THREE.BufferAttribute(s,3)}}_getColor(e,t,i,r){const a=this._getAccInfo(e,r.getAccColor());if(0===a.length||0===r.getAccColor())return null;const n=t.slice(a.offset,a.offset+a.length).buffer;let s=new Uint8Array(n);i.cAccInfoStart=a.offset,r.vertexColors=!0;const o=new THREE.BufferAttribute(s,4);return o.normalized=!0,o}_getIndex(e,t,i,r){const a=this._getAccInfo(e,r.getAccIndices()),n=t.slice(a.offset,a.offset+a.length).buffer;let s=null;if(a.valueType===proto.bimtile_pbf.BufferAcc.ComponentType.CT_USHORT)s=new Uint16Array(n);else s=new Uint32Array(n);i.iAccInfoStart=a.offset,i.iAccInfoCount=a.count;return{indexBufferData:n,indexBufferAttribute:new THREE.BufferAttribute(s,1)}}_getTextureCoord(e,t,i,r){i.tAccInfoStart=0;let a={uvBufferData:null,uvBufferAttribute:null,uv2BufferData:null,uv2BufferAttribute:null,uv3BufferData:null,uv3BufferAttribute:null},n=null;const s=this._getAccInfo(e,r.getAccTexcoords());if(s.count>0){const e=t.slice(s.offset,s.offset+s.length).buffer;i.tAccInfoStart=s.offset,s.valueType==proto.bimtile_pbf.BufferAcc.ComponentType.CT_SHORT?(r.useCompressedUv=!0,n=new Int16Array(e)):(r.useCompressedUv=!1,n=new Float32Array(e));const o=new THREE.BufferAttribute(n,2);a.uvBufferData=e,a.uvBufferAttribute=o}const o=this._getAccInfo(e,r.getAccTexcoords2());if(o.count>0){const e=t.slice(o.offset,o.offset+o.length).buffer;i.tAccInfoStart2=o.offset,o.valueType==proto.bimtile_pbf.BufferAcc.ComponentType.CT_SHORT?(r.useCompressedUv=!0,n=new Int16Array(e)):(r.useCompressedUv=!1,n=new Float32Array(e));const s=new THREE.BufferAttribute(n,2);a.uv2BufferData=e,a.uv2BufferAttribute=s}const l=this._getAccInfo(e,r.getAccTexcoords3());if(l.count>0){const e=t.slice(l.offset,l.offset+l.length).buffer;i.tAccInfoStart3=l.offset,n=new Float32Array(e);const r=new THREE.BufferAttribute(n,2);a.uv3BufferData=e,a.uv3BufferAttribute=r}return a}}r.BimTileBatchBlobParserV3=e}(),function(){class e extends r.BimTileUserIdTool{constructor(){super(),this.userStringIndexMap={}}destroy(){super.destroy(),this.userStringIndexMap=null}addGlobalUserIdUrl(e){this.globalUserIdUrls.push(e)}getGlobalUserIdUrls(){return this.globalUserIdUrls}parseUserIdBuffer(e){const t=e.getBlobHeader().getUserIdMin(),i=e.getBlobHeader().getUserIdMax(),r=e.getUserIdsList();for(let e=t;e<=i;++e)this.userIndexStringMap[e]=r[e-t],this.userStringIndexMap[r[e-t]]=e;const a=e.getUserdataindexList();for(let e=t;e<=i;++e)this.userDataIndexMap[e]=a[e-t]}disposeBuffer(){}getIndexByUserId(e){return this.userStringIndexMap[e]}getUserIdByIndex(e){return this.userIndexStringMap[e]}getAllUserIndex(){return Object.keys(this.userIndexStringMap)}getUserDataIndexByUserIndex(e){return this.userDataIndexMap[e]}}r.BimTileUserIdToolV3=e}(),function(){class e extends r.BimTilesLoader{constructor(e){super(e),this.bimTileParser[r.TileContentType.DATA_MESH]=new r.BimTileBatchBlobParserV3({materialManager:this.materialManager,loader:this}),this.bimTileParser[r.TileContentType.DATA_INSTANCE]=new r.BimTileInstanceParserV3({materialManager:this.materialManager,loader:this}),this.batchedMeshManager=new r.BimTileBatchedMeshManagerV3(this),this.instancedMeshManager=new r.BimTileInstancedMeshManagerV3(this)}_createTileReader(){this.tileReader=new r.BimTileReaderV3({dataVersion:this.dataVersion})}addSearchTreeUrl(e,t,i){i&&i()}destroy(){super.destroy()}patchMeshNodeInfo(e,t,i){this.userIdManager.patchMeshNodeInfo(e,t,i)}patchInstanceNodeInfo(e,t,i,r){this.userIdManager.patchInstanceNodeInfo(e,t,i,r)}get userIdManager(){return this.tileReader.descriptor}loadGlobalUserIdBoxUrls(e){const t=this.tileReader.getGlobalUserIdBoxUrls();if(t){let i=t.length;t.map((t=>{this.loadBlock(t,{},r.TileContentType.DATA_GLOBAL_USER_ID_BOX,(()=>{i--,i<=0&&e&&e()}))}))}}addInstanceMeshIdMap(e,t,i,r){}addInstanceInfo(e,t){}disposeMeshNodeById(e){}disposeInstanceMeshNodeById(e){}getMeshNodeById(e){const t=this.filter.model.objectGroup.children[0];return this.batchedMeshManager.getMeshNodeById(e,t)}getInstanceMeshNodeById(e){const t=this.filter.model.objectGroup.children[1];return this.instancedMeshManager.getInstanceMeshNodeById(e,t)}}r.BimTilesLoaderV3=e}(),function(){class e extends r.BimTileReader{constructor(e){super(),this.descriptor=new r.BimtileDescriptorV3(this),this.userIdTool=new r.BimTileUserIdToolV3,this.userIdBoxTool=new r.BimTileUserIDBoxTool(this),this.dataVersion=e.dataVersion}getUserDataIndexKeyByString(e){return this.userDataTool.getUserDataIndexKeyByString(e)}getAllUserIds(){return this.userIdTool.getAllUserIndex()}getUserIdByIndex(e){return this.userIdTool.getUserIdByIndex(e)}getUserDataIndexByUserIndex(e){return this.userIdTool.getUserDataIndexByUserIndex(e)}getUserIdBoxByIndex(e){return this.userIdBoxTool.getUserIdBoxByIndex(e)}getGlobalUserIdBoxUrls(){return this.userIdBoxTool&&this.userIdBoxTool.getGlobalUserIdBoxUrls()}parseBlock(e,t,i){const a=t.node,n=t.type,s=t.url,o=t.outline;let l=!0;a.bufferType=n;let d=0;const h=e.byteLength;for(a.buffer=r.Utils.isDefined(a.buffer)?a.buffer:{},a.lineBuffer=r.Utils.isDefined(a.lineBuffer)?a.lineBuffer:{},a.outlineBuffer=r.Utils.defaultValue(a.outlineBuffer,{});d<h;){const t=e.slice(d,d+4);let i=new Uint32Array(t)[0];d+=4;const h=new Uint8Array(e,d,i);d+=i;const u=proto.bimtile_pbf.BlockHeader.deserializeBinary(h);l&&u.getDataType(),i=u.getDataSize(),r.TilesUtil.max_uncompressed_blob_size;var c=new Uint8Array(e,d,i);if(d+=i,u.getCompressType()!=proto.bimtile_pbf.BlockHeader.CompressType.CT_NULL)return void console.warn("uncompress data into buffer");const p=u.getDataType();let m={};switch(p){case proto.BlockHeader.BlockType.BT_INDEX:const e=proto.bimtile_pbf_v2.SearchTreeBlob.deserializeBinary(c);m.type=p,m.content=e,a.searchBuffer=m;break;case proto.BlockHeader.BlockType.BT_USERID:const t=proto.bimtile_pbf_v3.UserIDBlob.deserializeBinary(c);if(n===r.TileContentType.DATA_GLOBAL_USER_ID){this.userIdTool.parseUserIdBuffer(t);break}m.type=p,m.content=t,a.userIdBuffer=m;break;case proto.BlockHeader.BlockType.BT_USERIDBOX:const i=proto.bimtile_pbf_v3.UserIDBBoxBlob.deserializeBinary(c);if(n===r.TileContentType.DATA_GLOBAL_USER_ID_BOX){this.userIdBoxTool.parseUserIdBoxBuffer(i,s);break}break;case proto.BlockHeader.BlockType.BT_MATERIAL:const l=proto.bimtile_pbf.MaterialBlob.deserializeBinary(c);if(m.type=p,m.content=l,n===r.TileContentType.DATA_GLOBAL_MATERIAL){this.globalMaterialBuffer=l;break}a.materialBuffer=m;break;case proto.BlockHeader.BlockType.BT_USERDATA:const d=proto.bimtile_pbf.UserdataBlob.deserializeBinary(c);if(n===r.TileContentType.DATA_GLOBAL_USER_DATA){this.userDataTool.parseUserDataBuffer(d);break}m.type=p,m.content=d,a.userdataBuffer=m;break;case proto.BlockHeader.BlockType.BT_BUFFER:const h=proto.bimtile_pbf.BufferBlob.deserializeBinary(c);m.type=p,m.content=h,n===proto.BlockHeader.BlockType.BT_LINE?o?a.outlineBuffer=m:a.lineBuffer=m:a.buffer=m;break;case proto.BlockHeader.BlockType.BT_MESH:const u=proto.bimtile_pbf_v3.MeshBlob.deserializeBinary(c);m.type=p,m.content=u,a.meshBlob=m;break;case proto.BlockHeader.BlockType.BT_POINT:const f=proto.bimtile_pbf.PointBlob.deserializeBinary(c);m.type=p,m.content=f,a.buffer=m;break;case proto.BlockHeader.BlockType.BT_TILEID:const g=proto.bimtile_pbf.TileIDBlob.deserializeBinary(c);if(m.type=p,m.content=g,n===r.TileContentType.DATA_GLOBAL_TILE_ID){this.globalTileIdBuffer=g;break}a.buffer=m;break;case proto.BlockHeader.BlockType.BT_INSTANCE:const v=proto.bimtile_pbf.InstanceBlob.deserializeBinary(c);m.type=p,m.content=v,a.buffer=m;break;case proto.BlockHeader.BlockType.BT_LINE:const y=proto.bimtile_pbf.MeshBlob.deserializeBinary(c);m.type=p,m.content=y,n===proto.BlockHeader.BlockType.BT_LINE&&o?a.outlineBuffer=m:a.lineBuffer=m;break;case proto.BlockHeader.BlockType.BT_VIEWTREE:const M=proto.bimtile_pbf.ViewTree.deserializeBinary(c);if(m.type=p,m.content=M,n==r.TileContentType.DATA_GLOBAL_PRECUTTING_TREE){this.globalPrecuttingTreeBuffer=M;break}a.buffer=m;break;default:return void console.warn("Parse unknow block faild! ")}l&&(l=!1)}i&&i()}createNodeInfoMap(){}}r.BimTileReaderV3=e}(),r.BimTileBatchedMeshManagerV3=class{constructor(e){this.loader=e,this.reader=e.reader}destroy(){this.batchMeshIdNodeMap=null,this.noUserDataMeshNodeInfoMap=null}getGeometryBuffersByUserIdInfo(e,t,i,r){const a=e.tileId,n=e.userId;for(const e in a){const s=a[e];for(const a in s){const s=`${e}_${a}`,o=t.getObjectByName(s);if(!o)continue;const l=o.geometry,d=l.getIndex().array,h=l.getAttribute("position").array,c=l.getAttribute("uv"),u=c?c.array:null,p=l.getAttribute("color"),m=p?p.array:null,f=l.getAttribute("cNormal"),g=f?f.array:null,v=o.indexGroups.get(n);let y=v.indexStart,M=v.indexStart+v.indexCount;const E=d.slice(y,M);let b,I,x=null;u&&(y=v.positionStart/3*2,M=y+v.positionCount/3*2,x=u.slice(y,M)),m&&(y=v.positionStart/3*4,M=y+v.positionCount/3*4,b=m.slice(y,M)),g&&(y=v.cNormalStart,M=y+v.cNormalCount,I=g.slice(y,M)),y=v.positionStart,M=v.positionStart+v.positionCount;const T=h.slice(y,M);y/=3,E.forEach((function(e,t,i){i[t]-=y})),r.push({isLines:!1,databagId:i,nodeId:s,position:T,index:E,uv:x,matrix:o.matrix,color:b,cNormal:I,isInstance:!1})}}}calculateClippingContours(e,t,i,r,a,n,s,o){}changeAllMaterials(e){}updatePickingMeshes(e,t,i,a,n,s){const o=i.geometry,l=i.indexGroups;let d=new THREE.BufferGeometry;d.setAttribute("position",o.getAttribute("position"));let h=o.getAttribute("uv");s&&h&&d.setAttribute("uv",h),d.setIndex(o.getIndex());let c="LineSegmentsEx"===i.type?new THREE.LineSegments(d,r.MaterialUtil.DefaultMaterial):new THREE.Mesh(d,r.MaterialUtil.DefaultMaterial);c.name=i.name,c.frustumCulled=!1,c.renderOrder=r.EnumRenderOrder.Component,c._indicesGroup=l,c.material=a?[a]:i.material,c.matrix.copy(i.matrix),c.matrixAutoUpdate=!1;const u=l.get(parseInt(t));let p={};a||o.groups.map((e=>{p[e.start]=e.materialIndex}));let m=0;a||(m=p[u.indexStart]),c.geometry.addGroup(u.indexStart,u.indexCount,m),n.add(c)}getMeshNodeById(e,t){return t.getObjectByName(e)}},r.BimTileInstancedMeshManagerV3=class{constructor(e){this.loader=e,this.reader=e.tileReader}destroy(){}getGeometryBuffersByUserIdInfo(e,t,i,r){const a=e.tileId;for(const e in a){const n=a[e];for(const a in n){const s=t.getObjectByName(`${e}_0`);if(!s)continue;let o=n[a].clone();o=s.matrix.clone().multiply(o);const l=s.geometry,d=l.getAttribute("uv");r.push({isLines:!1,databagId:i,nodeId:s.name,position:l.getAttribute("position").array,index:l.getIndex().array,matrix:o,uv:d?d.array:null,isInstance:!0})}}}_createInstanceMaterial(e,t,i){const a=e.getAttribute("aColor").array,n=e.getAttribute("vState").array,s=e.getAttribute("vState2").array,o=a[4*t],l=a[4*t+1],d=a[4*t+2];let h=Math.floor(100*a[4*t+3])/100;const c=new THREE.Color(o,l,d);0!==n[t]&&0!==s[t]||(h=i);let u=!1;h<1&&(u=!0);const p={color:c.getHex(),opacity:h,transparent:u},m=`${p.color}_${h}`;let f=this.overrideMaterialMap[m];return f||(f=r.MaterialUtil.createStandardMaterial(p),this.overrideMaterialMap[m]=f,f)}updatePickingMeshes(e,t,i,a,n,s){const o=e.geometry;let l=new THREE.BufferGeometry;l.setAttribute("position",o.getAttribute("position")),l.setIndex(o.getIndex());let d=null;d="LineSegmentsEx"===e.type?new THREE.LineSegments(l,r.BimTileWireframeManager.selectedMaterial):new THREE.Mesh(l,t||this._createInstanceMaterial(o,s,e.material[0].opacity)),d.name=e.name,d.frustumCulled=!1,d.matrix.copy(e.matrix).multiply(i),d.matrixAutoUpdate=!1,a.add(d)}calculateClippingContours(e,t,i,r,a,n,s,o){}updateInstanceClipping(e){}updatePickingMeshesByIds(e){}changeAllMaterials(e){for(let t in this.instanceMeshIdNodeMap){let i=this.instanceMeshIdNodeMap[t];for(let t in i){let r=i[t].mesh.material;if(!r)return;for(let t=0;t<r.length;t++){if(!r[t])continue;let i=r[t].name;e[i]&&(r[t]=e[i])}}}}getInstanceMeshNodeById(e,t){return t.getObjectByName(e,t)}},function(){new THREE.Matrix4;let e=new THREE.Box3;class t extends r.BimTilesModel{constructor(e,t,i,a,n,s){super(e,t,i,a,n,s),this.pickHelper=new r.BimTileGpuPickingManagerV1(t,this);const o=e.rendererManager.getPickingEffecter();o.enableUpdateScene(!1),this.pickingManager=new r.BimTilesPickingManagerV3(this,o),this.modelExplosion=new r.BimTilesModelExplosionV3(this),this.tilesLoader.modelExplosion=this.modelExplosion}destroy(){super.destroy()}_createLoader(e){this.tilesLoader=new r.BimTilesLoaderV3(e)}getNodeInfosByUserId(e){const t=this.tilesLoader.tileReader,i=t.getIndexByUserId(e),r=this.getDescriptor().getUserIdInfoByUserId(i);if(!r)return;const a=r.clone();a.transformMatrix=this.getTransformMatrix();const n=t.getUserDataIndexByUserIndex(i),s=t.getUserDataByIndex(n);let o={};for(let e in s){const[i,r]=t.getUserDataStringMapByIndex(e,s[e]);o[i]=r}return a.boundingBox=t.getUserIdBoxByIndex(i).clone(),a.userData=o,[a]}_crateFilterManger(){return new r.BimTileFilterManagerV3(this)}_crateMaterialManger(e){return new r.BimTileMaterialManagerV3(e)}getAllUserIds(){return Object.keys(this.tilesLoader.tileReader.userIdTool.userStringIndexMap)}calculateClippingIds(t,i){const a=this.manager.scene,n=r.FillClipPlaneManager.getInstance(a),s=n&&n.isEnabled(),o=a.clipPlanes;let l=s?n:o,d=l.renderClipPlane.clone();(s?l.capsIntersectPosition:l.capsIntersectPosition[l.selectIndex]).length=0;s||l.selectIndex;o&&i&&this.mapClippingIds.clear();let h=this.getFilter().getLocalClippingList();this.viewer.getRenderer().localClippingEnabled&&Object.keys(h).length;const c=a.getMatrixGlobal().clone(),u=this.manager.getModelLengthUnitsMatrix(this);u&&c.multiply(u);const p=this.tilesLoader.tileReader;p.getAllUserIds().forEach((t=>{t=parseInt(t);const i=p.getUserIdBoxByIndex(t);e.copy(i).applyMatrix4(c),d.intersectsBox(e)&&this.mapClippingIds.set(t,!0)})),this.filter.enableStateChanged()}getMeshesByUserId(e){const t=this.tilesLoader.tileReader,i=this.getLengthUnitsMatrix(),r=t.getIndexByUserId(e),a=this.getDescriptor().getUserIdInfoByUserId(r),n=t.getUserIdBoxByIndex(r);if(!1===a.instanceOrNot){const t=a.tileId;for(const s in t){const o=t[s];for(const t in o){let o={};o.boundingBox=n,o.matrix=a.matrix,o.unitsMatrix=i;const l=`${s}_${t}`,d=this.objectGroup.children[0].getObjectByName(l);o.mesh=d;const h=o.mesh.indexGroups.get(r);o.indexInfo=h,this.minDistanceObjects[e].push(o)}}}else{const t=a.tileId;for(const r in t){const a=t[r];for(const t in a){let s={};s.boundingBox=n,s.matrix=a[t],s.unitsMatrix=i,s.mesh=this.objectGroup.children[1].getObjectByName(`${r}_0`),this.minDistanceObjects[e].push(s)}}}}getUserIdMapByFrustum(e){let t={},i=new THREE.Box3;var r=this.viewer.getScene().getMatrixGlobal();const a=this.transformMatrix,n=(this.tilesLoader.tileReader.getSearchTreeBuffer(),this.manager.explosionManager.isExploded(this.id));return this.getDescriptor().getAllUserIdInfoCallback((s=>{i.copy(s.boundingBox),i.applyMatrix4(a).applyMatrix4(r),(e.intersectsBox(i)||n)&&(t[s.userId]=!0)})),t}getGeometryBuffersByUserId(e){let t=[];return this.getDescriptor().getUserIdInfoCallback(e,(e=>{!1===e.instanceOrNot?this.tilesLoader.batchedMeshManager.getGeometryBuffersByUserIdInfo(e,this.objectGroup.children[0],this.databagId,t):this.tilesLoader.instancedMeshManager.getGeometryBuffersByUserIdInfo(e,this.objectGroup.children[1],this.databagId,t)})),t}getMaterialByMaterialId(e,t){if(e)return this.materialManager.materialMap[e];const i=t.tileId;for(const e in i){const t=objectGroup.getObjectByName(`${e}_0`);if(t)return t.material[0]}}_dealNonInstancedNodesForPicking(e,t,i,a,n){let s=new r.ObjectGroup;const o=e.selectedMaterial,l=i.length,d=this.getDescriptor();if(d.hasNodeInfo()&&!1!==this.visible){for(let e=0;e<l;++e){const t=this.tilesLoader.tileReader.getIndexByUserId(i[e]);this.filter.isPickable(t)&&d.getBatchedNodeInfoByUserIdCallback(t,(e=>{const i=e.nodeInfo;if(!this.filter._isPickable(i))return;const r=this.objectGroup.children[0].getObjectByName(e.meshId);this.tilesLoader.batchedMeshManager.updatePickingMeshes(i,t,r,o,s,n)}))}t.add(s)}}_dealInstancedNodesForPicking(e,t,i,a,n){let s=new r.ObjectGroup;const o=e.selectedMaterial,l=i.length,d=this.getDescriptor();if(d.hasNodeInfo()&&!1!==this.visible){if(n){const e={bimtileDescriptor:d,instanceMeshGroup:s,selectedIds:i};return this.tilesLoader.instancedMeshManager.updatePickingMeshesByIds(e),void t.add(s)}for(let e=0;e<l;++e){const t=this.tilesLoader.tileReader.getIndexByUserId(i[e]);this.filter.isPickable(t)&&d.getInstanceNodeInfoByUserIdCallback(t,(e=>{const t=e.nodeInfo,i=this.objectGroup.children[1].getObjectByName(e.meshId);this.tilesLoader.instancedMeshManager.updatePickingMeshes(i,o,t.matrix,s,n,t.index)}))}t.add(s)}}isUserIdVisible(e){let t=!1;const i=this.tilesLoader.tileReader.getIndexByUserId(e),r=this.getDescriptor().getUserIdInfoByUserId(i);for(const e in r.tileId)this.objectGroup.traverse((i=>{i.tileId===parseInt(e)&&(t=t||i.visible)}));return t}}r.BimTilesModelV3=t}(),function(){class e extends r.BimTilesPickingManager{constructor(e,t){super(e,t)}destroy(){super.destroy()}needsUpdate(e){const t=this.model.getDescriptor().tileUserIdMap.get(e.contentId);for(let e of this.selectedIdMap.keys())if(t.has(e))return!0;return!1}updateBatchedPickingMeshes(e){e.content.meshes.traverse((t=>{if("MeshEx"!==t.type&&"LineSegmentsEx"!==t.type)return;if(!t||!t.indexGroups||!1===t.visible||null!=t.parent.parent&&0==t.parent.parent.visible)return;const i=t.geometry,a=t.indexGroups,n=this.getMatchedIds(a);if(0===n.length)return;let s=new THREE.BufferGeometry;s.setAttribute("position",i.getAttribute("position"));i.getAttribute("uv");s.setIndex(i.getIndex());let o="LineSegmentsEx"===t.type?new THREE.LineSegments(s,r.MaterialUtil.DefaultMaterial):new THREE.Mesh(s,r.MaterialUtil.DefaultMaterial);o.name=t.name,o.frustumCulled=!1,o.renderOrder=r.EnumRenderOrder.Component,o._indicesGroup=a,o.material=[r.MaterialUtil.getDefaultSelectedMaterial()],o.matrix.copy(t.matrix),o.matrixAutoUpdate=!1,n.map((e=>{const t=a.get(e);o.geometry.addGroup(t.indexStart,t.indexCount,0)})),this._dirty=!0,e.selectionMeshes.push(o),this.selectedMeshes.add(o)}))}updateBatchedWireFramePickingMeshes(e){e._content._outlineContent.outlineMeshes.traverse((t=>{if("LineSegmentsEx"===!t.type)return;if(!t||!t.indexGroups||!1===t.visible||null!=t.parent.parent&&0==t.parent.parent.visible)return;const i=t.geometry,a=t.indexGroups,n=this.getMatchedIds(a);if(0===n.length)return;let s=new THREE.BufferGeometry;s.setAttribute("position",i.getAttribute("position")),s.setIndex(i.getIndex());let o=new THREE.LineSegments(s,r.BimTileWireframeManager.selectedMaterial);o.name=t.name,o.frustumCulled=!1,o.renderOrder=r.EnumRenderOrder.WireFrame,o._indicesGroup=a,o.material=[r.MaterialUtil.getDefaultSelectedMaterial()],o.matrix.copy(t.matrix),o.matrixAutoUpdate=!1,n.map((e=>{const t=a.get(e);for(const e of t.values())o.geometry.addGroup(e.indexStart,e.indexCount,0)})),this._dirty=!0,e.selectionWireFrames.push(o),this.selectedMeshes.add(o)}))}updateInstancePickingMeshes(e){this.instanceMatrixListMap.clear();const t=e.content.meshes,i=this.model.getDescriptor().tileUserIdMap.get(e.contentId),a=this.getMatchedIds(i);0!==a.length&&t.traverse((t=>{if("MeshEx"!==t.type&&"LineSegmentsEx"!==t.type)return;if(r.TilesUtil.isInstanceNodeInVisible(t))return;const i=t.geometry;let n=new THREE.BufferGeometry;n.setAttribute("position",i.getAttribute("position")),n.setIndex(i.getIndex());let s=[];a.map((i=>{const a=this.model.getDescriptor().getInstanceMatrixListByUserIdAndTileId(i,e.contentId);s=s.concat(a),a.map((a=>{let s=null;s="LineSegmentsEx"===t.type?new THREE.LineSegments(n,r.BimTileWireframeManager.selectedMaterial):new THREE.Mesh(n,r.MaterialUtil.getDefaultSelectedMaterial()),s.name=`${t.name}_${i}`,s.frustumCulled=!1,s.matrix.copy(t.matrix).multiply(a),s.matrixAutoUpdate=!1,e.selectionMeshes.push(s),this.selectedMeshes.add(s)}))})),this._dirty=!0,this.instanceMatrixListMap.set(t.name,s)}))}updateInstanceWireFramePickingMeshes(e){e._content._outlineContent.outlineMeshes.traverse((t=>{if("LineSegmentsEx"!==t.type)return;const i=this.instanceMatrixListMap.get(t.name);if(!i)return;const a=t.geometry;let n=new THREE.BufferGeometry;n.setAttribute("position",a.getAttribute("position")),n.setIndex(a.getIndex()),i.map((i=>{let a=new THREE.LineSegments(n,r.MaterialUtil.getDefaultSelectedMaterial());a.name=t.name,a.frustumCulled=!1,a.renderOrder=r.EnumRenderOrder.WireFrame,a.matrix.copy(t.matrix).multiply(i),a.matrixAutoUpdate=!1,this._dirty=!0,e.selectionWireFrames.push(a),this.selectedMeshes.add(a)}))}))}}r.BimTilesPickingManagerV3=e}(),function(){let e=new THREE.Matrix4,t=new THREE.Vector3;class i extends r.BimTilesModelExplosion{constructor(e){super(e)}explode(){this.model._tileset.explode(this)}preFloorExplode(e,t,i){this.explosionBegin=!0;let a={},n={};for(var s=0,o=t.length;s<o;s++){let e=t[s].explodedHeight-t[s].elevation,r=new THREE.Vector3(i.x*e,i.y*e,i.z*e);a[t[s].name]=r;let o=null;o=t[s].preExplodedTranslation?r.clone().sub(t[s].preExplodedTranslation):r.clone(),n[t[s].name]=o,t[s].preExplodedTranslation=r}let l=this.explosionTranslation;const d=this.model.getDescriptor();let h=new THREE.Matrix4,c=new THREE.Matrix4,u=3;const p=this.model.tilesLoader.tileReader,m=p.getUserDataIndexKeyByString("levelName");r.Utils.defined(m)||(u=m);p.getAllUserIds().forEach((t=>{t=parseInt(t);const i=p.getUserDataIndexByUserIndex(t);let s=p.getUserDataByIndex(i)[u],o=p.getUserDataStringMapByIndex(u,s)[1];const m=p.getUserIdBoxByIndex(t);let f=a[o]||new THREE.Vector3;l[t]=f,h.makeTranslation(f.x,f.y,f.z);let g=n[o]||new THREE.Vector3;c.makeTranslation(g.x,g.y,g.z);const v=d.getUserIdInfoByUserId(t);r.Utils.defined(v)?(v.matrix?v.explodeMatrix.multiplyMatrices(c,v.explodeMatrix):v.explodeMatrix=c,m.applyMatrix4(c),e.union(m)):d.patchExplodeMatrix(t,h)})),e.applyMatrix4(this.model.getTransformMatrix()),this.model.filter.enableVisibleStateChanged()}preElementExplode(i,a){this.explosionBegin=!0;const n=this.model.getBoundingBoxWorld();if(!n)return;const s=a-this.model.manager.explosionManager.getExplosionExtent(this.model.id);if(0==s)return;let o=new THREE.Matrix4,l=new THREE.Matrix4;e.copy(this.model.transformMatrix).invert(),n.getCenter(t),t.applyMatrix4(e);const d=this.model.getDescriptor(),h=this.model.tilesLoader.tileReader,c=h.getAllUserIds();let u=this.explosionTranslation;for(let e=0,n=c.length;e<n;e++){let n=parseInt(c[e]),p=new THREE.Box3;const m=h.getUserIdBoxByIndex(n);p.union(m);let f=r.Utils.computeExplodeTranslation(t,p,a);u[n]=f,o.makeTranslation(f.x,f.y,f.z);let g=r.Utils.computeExplodeTranslation(t,p,s);l.makeTranslation(g.x,g.y,g.z),this.explosionOffset[n]=g;const v=d.getUserIdInfoByUserId(n);r.Utils.defined(v)?(v.matrix?v.explodeMatrix.multiplyMatrices(l,v.explodeMatrix):v.explodeMatrix=l,m.applyMatrix4(l),i.union(m)):d.patchExplodeMatrix(n,o)}i.applyMatrix4(this.model.getTransformMatrix()),this.model.filter.enableVisibleStateChanged()}standardExplode(e){function t(e,t,a,n,s){const o=e.getAttribute("position").array;for(let e=t;e<a;e+=3)i.set(o[e],o[e+1],o[e+2]),i.applyMatrix4(s),i.add(n),r.copy(s).invert(),i.applyMatrix4(r),o[e]=i.x,o[e+1]=i.y,o[e+2]=i.z;e.getAttribute("position").needsUpdate=!0}if(e.explodeCount==this.model.manager.explosionManager.explodeCount)return;let i=new THREE.Vector3,r=new THREE.Matrix4;const a=e._content.meshes,n=e._content._outlineContent.outlineMeshes;new THREE.Matrix4,new THREE.Matrix4;let s=new THREE.Vector3,o=new THREE.Vector3(0),l=e=>{if("MeshEx"!==e.type&&"LineSegmentsEx"!==e.type)return;let i=e.geometry;const r=e.indexGroups;for(const[a,n]of r){let r=this.getExplosionTranslation(a),l=n.preTranslation?n.preTranslation:o;if(s.set(r.x-l.x,r.y-l.y,r.z-l.z),0==s.x&&0==s.y&&0==s.z)continue;const d=n.positionStart;t(i,d,d+n.positionCount,s,e.matrix),n.preTranslation=r}};a.traverse((e=>{l(e)})),n.traverse((e=>{l(e)})),e.explodeCount=this.model.manager.explosionManager.explodeCount}instanceExplode(e){function t(e,t,i,r){var a=e.getAttribute("mcol3").array;a[3*t]+=i.x,a[3*t+1]+=i.y,a[3*t+2]+=i.z,e.getAttribute("mcol3").needsUpdate=!0}if(e.explodeCount==this.model.manager.explosionManager.explodeCount)return;const i=e.instanceInfo.entityInfoArray;let r=new THREE.Vector3,a=new THREE.Vector3(0);const n=e._content.meshes.children[0],s=e._content._outlineContent.outlineMeshes.children[0];for(let e=0,o=i.length;e<o;e++){const o=i[e].userID;let l=this.getExplosionTranslation(o),d=a;i[e].preTranslation&&(d=i[e].preTranslation),r.set(l.x-d.x,l.y-d.y,l.z-d.z),0==r.x&&0==r.y&&0==r.z||(t(n.geometry,e,r),s&&s.geometry&&t(s.geometry,e,r),i[e].preTranslation=l)}e.explodeCount=this.model.manager.explosionManager.explodeCount}}r.BimTilesModelExplosionV3=i}(),function(){class e extends THREE.RawShaderMaterial{constructor(e){super(e),this.type="PickingMaterial",this.defines.CNORMAL="",e.instancing&&(this.defines.USE_INSTANCE=""),this.vertexShader="\n            precision highp float;\n            precision highp int;\n            #define attribute in\n\n          \tin vec3 position;\n\t\t\tin vec3 normal;\n\t\t\tin uint id;\n\n\t\t\tuniform mat4 modelMatrix;\n\t\t\tuniform mat4 modelViewMatrix;\n\t\t\tuniform mat4 projectionMatrix;\n            uniform vec3 cameraPos;\n            uniform mat3 normalMatrix;\n\n            out vec4 vId;\n\t\t\tout vec3 vNormal;\n            out vec4 vPosition;\n\n\n            #include <CompressNormal_vertex>\n\n            void main() {\n                vec3 transformed = vec3( position );\n                vec3 objectNormal = vec3( normal );\n                #ifdef CNORMAL\n                    objectNormal = octDecode();\n                #endif\n                vec3 transformedNormal = objectNormal;\n                vec4 mvPosition = vec4( transformed, 1.0 );\n                vNormal = normalize( transformedNormal );\n                vId = vec4( float(id/uint(256*256*256)) / 255.0, float(id/uint(256*256)%uint(256)) / 255.0, float(uint(id/uint(256))%uint(256)) / 255.0, float(id%uint(256)) / 255.0 );\n                mvPosition = modelViewMatrix * mvPosition;\n                // Using mvPosition and then converting on the CPU side reduces errors\n                vPosition =  modelMatrix * vec4( position, 1.0 );\n                gl_Position = projectionMatrix * mvPosition;\n            }\n\n            ",this.fragmentShader="\n            precision highp float;\n            precision highp int;\n\n            layout(location = 0) out vec4 gId;\n\t\t\tlayout(location = 1) out vec4 gNormal;\n            layout(location = 2) out vec4 gPosition;\n\n\t\t\tin vec4 vId;\n\t\t\tin vec3 vNormal;\n            in vec4 vPosition;\n\n            void main() {\n\n\t\t\t\tgId = vId;\n\t\t\t\t// write normals to G-Buffer\n                //gId = vec4( 1.0,1.0,1.0, 0.0 );\n\t\t\t\tgNormal = vec4( normalize( vNormal ), 0.0 );\n                gPosition = vPosition;\n\n\t\t\t}\n            ",this.uniforms={},this.glslVersion=THREE.GLSL3}}r.PickingMaterial=e;class t extends THREE.RawShaderMaterial{constructor(e){super(e),this.type="PickingMaterial",this.defines.CNORMAL="",this.defines.USE_INSTANCE="",this.vertexShader="\n            precision highp float;\n            precision highp int;\n            #define attribute in\n\n          \tin vec3 position;\n\t\t\tin vec3 normal;\n\t\t\tin uint id;\n\n\t\t\tuniform mat4 modelMatrix;\n\t\t\tuniform mat4 modelViewMatrix;\n\t\t\tuniform mat4 projectionMatrix;\n            uniform vec3 cameraPos;\n            uniform mat3 normalMatrix;\n\n            attribute vec3 mcol0;\n            attribute vec3 mcol1;\n            attribute vec3 mcol2;\n            attribute vec3 mcol3;\n\n            out vec4 vId;\n\t\t\tout vec3 vNormal;\n            out vec4 vPosition;\n\n\n\n            mat3 inverse_mat3(in mat3 m)\n            {    \n                float determinant =    \n                m[0][0] * (m[1][1] * m[2][2] - m[2][1] * m[1][2])    \n                - m[1][0] * (m[0][1] * m[2][2] - m[2][1] * m[0][2])    \n                + m[2][0] * (m[0][1] * m[1][2] - m[1][1] * m[0][2]);    \n                mat3 inverse;    \n                inverse[0][0] = + (m[1][1] * m[2][2] - m[2][1] * m[1][2]);    \n                inverse[1][0] = - (m[1][0] * m[2][2] - m[2][0] * m[1][2]);    \n                inverse[2][0] = + (m[1][0] * m[2][1] - m[2][0] * m[1][1]);    \n                inverse[0][1] = - (m[0][1] * m[2][2] - m[2][1] * m[0][2]);    \n                inverse[1][1] = + (m[0][0] * m[2][2] - m[2][0] * m[0][2]);    \n                inverse[2][1] = - (m[0][0] * m[2][1] - m[2][0] * m[0][1]);    \n                inverse[0][2] = + (m[0][1] * m[1][2] - m[1][1] * m[0][2]);    \n                inverse[1][2] = - (m[0][0] * m[1][2] - m[1][0] * m[0][2]);    \n                inverse[2][2] = + (m[0][0] * m[1][1] - m[1][0] * m[0][1]);    \n                inverse /= determinant;    \n                return inverse;    \n            }    \n\n            #include <common>\n            #include <CompressNormal_vertex>\n\n            void main() {\n                vec3 transformed = vec3( position );\n                vec3 objectNormal = vec3( normal );\n                #ifdef CNORMAL\n                    objectNormal = octDecode();\n                #endif\n\n                transformed = vec3(mat4(vec4(mcol0, 0.0),\n                               vec4(mcol1, 0.0),    \n                                vec4(mcol2, 0.0),    \n                                vec4(mcol3, 1.0)) * vec4(transformed, 1.0));\n                vec4 mvPosition = vec4( transformed, 1.0 );\n                vec3 transformedNormal = objectNormal;\n                mat3 normalMat = mat3(mcol0, mcol1, mcol2);\n                normalMat = inverse_mat3(normalMat);\n                normalMat = transposeMat3(normalMat);\n                transformedNormal = normalMat * objectNormal;\n                vNormal = normalize( transformedNormal );\n                vId = vec4( float(id/uint(256*256*256)) / 255.0, float(id/uint(256*256)%uint(256)) / 255.0, float(uint(id/uint(256))%uint(256)) / 255.0, float(id%uint(256)) / 255.0 );\n                mvPosition = modelViewMatrix * mvPosition;\n                // Using mvPosition and then converting on the CPU side reduces errors\n                vPosition =  modelMatrix * vec4( transformed, 1.0 );\n                gl_Position = projectionMatrix * mvPosition;\n            }\n\n            ",this.fragmentShader="\n            precision highp float;\n            precision highp int;\n\n            layout(location = 0) out vec4 gId;\n\t\t\tlayout(location = 1) out vec4 gNormal;\n            layout(location = 2) out vec4 gPosition;\n\n\t\t\tin vec4 vId;\n\t\t\tin vec3 vNormal;\n            in vec4 vPosition;\n\n            void main() {\n\n\t\t\t\tgId = vId;\n\t\t\t\t// write normals to G-Buffer\n                //gId = vec4( 1.0,1.0,1.0, 0.0 );\n\t\t\t\tgNormal = vec4( normalize( vNormal ), 0.0 );\n                gPosition = vPosition;\n\n\t\t\t}\n            ",this.uniforms={},this.glslVersion=THREE.GLSL3}}r.PickingInstanceMaterial=t}(),r.BimTileGpuPickingManagerV1=class{constructor(e,t){this.idRenderTarget=new THREE.WebGLRenderTarget(1,1,{minFilter:THREE.NearestFilter,magFilter:THREE.NearestFilter,format:THREE.RGBAFormat}),this.normalRenderTarget=new THREE.WebGLRenderTarget(1,1,{minFilter:THREE.NearestFilter,magFilter:THREE.NearestFilter,format:THREE.RGBAFormat,type:THREE.FloatType}),this.positionRenderTarget=new THREE.WebGLRenderTarget(1,1,{minFilter:THREE.NearestFilter,magFilter:THREE.NearestFilter,format:THREE.RGBAFormat,type:THREE.FloatType}),this.pixelBufferId=new Uint8Array(4),this.pixelBufferNormal=new Float32Array(4),this.pixelBufferPosition=new Float32Array(4),this.idPickingMaterial=new r.PickingMaterial({}),this.idPickingInstanceMaterial=new r.PickingInstanceMaterial({}),this.normalPickingMaterial=new r.PickingMaterial({}),this.normalPickingMaterial.fragmentShader=this.normalPickingMaterial.fragmentShader.replace("layout(location = 0) out vec4 gId;","layout(location = 1) out vec4 gId;"),this.normalPickingMaterial.fragmentShader=this.normalPickingMaterial.fragmentShader.replace("layout(location = 1) out vec4 gNormal;","layout(location = 0) out vec4 gNormal;"),this.normalPickingInstanceMaterial=new r.PickingInstanceMaterial({}),this.normalPickingInstanceMaterial.fragmentShader=this.normalPickingInstanceMaterial.fragmentShader.replace("layout(location = 0) out vec4 gId;","layout(location = 1) out vec4 gId;"),this.normalPickingInstanceMaterial.fragmentShader=this.normalPickingInstanceMaterial.fragmentShader.replace("layout(location = 1) out vec4 gNormal;","layout(location = 0) out vec4 gNormal;"),this.positionPickingMaterial=new r.PickingMaterial({}),this.positionPickingMaterial.fragmentShader=this.positionPickingMaterial.fragmentShader.replace("layout(location = 0) out vec4 gId;","layout(location = 1) out vec4 gId;"),this.positionPickingMaterial.fragmentShader=this.positionPickingMaterial.fragmentShader.replace("layout(location = 1) out vec4 gNormal;","layout(location = 2) out vec4 gNormal;"),this.positionPickingMaterial.fragmentShader=this.positionPickingMaterial.fragmentShader.replace("layout(location = 2) out vec4 gPosition;","layout(location = 0) out vec4 gPosition;"),this.positionPickingInstanceMaterial=new r.PickingInstanceMaterial({}),this.positionPickingInstanceMaterial.fragmentShader=this.positionPickingInstanceMaterial.fragmentShader.replace("layout(location = 0) out vec4 gId;","layout(location = 1) out vec4 gId;"),this.positionPickingInstanceMaterial.fragmentShader=this.positionPickingInstanceMaterial.fragmentShader.replace("layout(location = 1) out vec4 gNormal;","layout(location = 2) out vec4 gNormal;"),this.positionPickingInstanceMaterial.fragmentShader=this.positionPickingInstanceMaterial.fragmentShader.replace("layout(location = 2) out vec4 gPosition;","layout(location = 0) out vec4 gPosition;"),this.viewer=e.viewer,this.model=t}readMultipleRenderTargetPixels(e,t,i,r,a,n,s,o,l){let d=e.properties.get(t).__webglFramebuffer;const h=e.getContext();let c=e.getRenderTarget();if(d){e.state.bindFramebuffer(h.FRAMEBUFFER,d);var u=[h.COLOR_ATTACHMENT0,h.COLOR_ATTACHMENT1,h.COLOR_ATTACHMENT2,h.COLOR_ATTACHMENT3];h.readBuffer(u[l]);try{const l=i,d=(l.format,l.type);let u=h.FLOAT;d===THREE.UnsignedByteType&&(u=h.UNSIGNED_BYTE),r>=0&&r<=t.width-n&&a>=0&&a<=t.height-s&&h.readPixels(r,a,n,s,h.RGBA,u,o)}finally{const t=null!==c?e.properties.get(c).__webglFramebuffer:null;e.state.bindFramebuffer(h.FRAMEBUFFER,t)}}}render(e,t,i,a){const n=e.getRenderTarget(),s=t.overrideMaterial,o=e.autoClear;e.autoClear=!1;const l=r.DomUtil.getContainerOffsetToClient(e.domElement);i.perspectiveCamera.setViewOffset(e.domElement.width,e.domElement.height,(a.x-l.left)*window.devicePixelRatio|0,(a.y-l.top)*window.devicePixelRatio|0,1,1),this.model.objectGroup.children.forEach((e=>{e.visible=!1})),e.setRenderTarget(this.idRenderTarget),e.clear(),t.overrideMaterial=this.idPickingMaterial,this.model.objectGroup.children[0].visible=!0,e.render(t,i),t.overrideMaterial=this.idPickingInstanceMaterial,this.model.objectGroup.children[0].visible=!1,this.model.objectGroup.children[1].visible=!0,e.render(t,i),this.pixelBufferId.fill(-1),e.readRenderTargetPixels(this.idRenderTarget,0,0,1,1,this.pixelBufferId);const d=this.pixelBufferId[3]+256*this.pixelBufferId[2]+256*this.pixelBufferId[1]*256;this.model.objectGroup.children[1].visible=!1,e.setRenderTarget(this.normalRenderTarget),e.clear(),t.overrideMaterial=this.normalPickingMaterial,this.model.objectGroup.children[0].visible=!0,e.render(t,i),t.overrideMaterial=this.normalPickingInstanceMaterial,this.model.objectGroup.children[0].visible=!1,this.model.objectGroup.children[1].visible=!0,e.render(t,i),this.pixelBufferNormal.fill(-1),e.readRenderTargetPixels(this.normalRenderTarget,0,0,1,1,this.pixelBufferNormal);const h=new THREE.Vector3(this.pixelBufferNormal[0],this.pixelBufferNormal[1],this.pixelBufferNormal[2]);this.model.objectGroup.children[1].visible=!1,e.setRenderTarget(this.positionRenderTarget),e.clear(),t.overrideMaterial=this.positionPickingMaterial,this.model.objectGroup.children[0].visible=!0,e.render(t,i),t.overrideMaterial=this.positionPickingInstanceMaterial,this.model.objectGroup.children[0].visible=!1,this.model.objectGroup.children[1].visible=!0,e.render(t,i),this.pixelBufferPosition.fill(-1),e.readRenderTargetPixels(this.positionRenderTarget,0,0,1,1,this.pixelBufferPosition);const c=new THREE.Vector3(this.pixelBufferPosition[0],this.pixelBufferPosition[1],this.pixelBufferPosition[2]);i.perspectiveCamera.clearViewOffset(),t.overrideMaterial=s,e.setRenderTarget(n),e.autoClear=o,this.model.objectGroup.children.forEach((e=>{e.visible=!0}));const u={userId:d,face:{normal:h},point:c};return 0===d&&0===h.x&&0===h.y&&0===h.z?null:u}},(()=>{class e extends r.CloudStandardMaterial{constructor(e){super(e),this.type="cloudStandardV3",this.vertexShader=THREE.ShaderChunk.cloudStandardVertexV3,this.fragmentShader=THREE.ShaderChunk.cloudStandardFragmentV3}}r.CloudStandardMaterialV3=e})(),function(){class e extends r.BimTileMaterialManager{constructor(e){super(e),this.packingMatTexture=null}_createMaterial(e,t,i,a,n){const s=i.toObject();s.hasLightMap=n.hasLightMap,s.vertexColors=!!r.Utils.isDefined(n.vertexColors)&&n.vertexColors;let o=proto.bimtile_pbf.Material.MaterialType.MT_PM_PHONG==s.type;o&&this._loadPackingMatTexture(e),s.packingMatTexture=this.packingMatTexture,this.dealMaterialParm(s);let l=a?this.createInstanceMaterial(s,!0,s.receiveIBL&&r.GlobalData.IBL):this.createStandardMaterial(s,s.receiveIBL&&r.GlobalData.IBL);l.name=t,o&&(l.packingMatMap=this.packingMatTexture,l.defines.USE_PACKINGMAT=""),this.dealMaterialDefines(l);for(let e in this.settingMaterialPara)this._isIBLParams(e)&&!s.receiveIBL||l.hasOwnProperty(e)&&(l[e]=this.settingMaterialPara[e],void 0!==l.refreshUniforms&&l.refreshUniforms());return l}createStandardMaterial(e,t){let i;return t?(i=new V.IBLMaterial(e),i.type="IBL"):i=new r.CloudStandardMaterialV3(e),e.fillMap&&(i.defines.USE_FILLPATTERN=""),i}createInstanceSecondMaterial(e){return this.createInstanceMaterial(e,!0)}createInstanceMaterial(e,t,i){let a=this.createStandardMaterial(e,i);return a.forInstance=!0,a.defines.USE_INSTANCE="",t&&(a.defines.USE_INSTANCE_NORMAL=""),a.colorState=r.EnumShaderColorState.BLINK,a.refreshUniforms(),a}_loadPackingMatTexture(e){if(null==this.packingMatTexture){let t="texture/packingMaterialTexture.png";const i=`${e.rootUrl}${t}`;this.packingMatTexture=(new THREE.TextureLoader).load(i),this.packingMatTexture.generateMipmaps=!1,this.packingMatTexture.magFilter=THREE.NearestFilter,this.packingMatTexture.minFilter=THREE.NearestFilter}}}r.BimTileMaterialManagerV3=e}(),function(){class e extends r.BimTileContent{constructor(e,t){super(e,t)}}r.StandardTileContent=e}(),function(){class e extends r.BimTileNode{constructor(e,t,i,r){super(e,t,i,r)}createContent(e){return this.isTilesetContent?new r.TileTilesetContent(this,e):new r.StandardTileContent(this,e)}_createNewTile(e,t,i,a){return new r.StandardTile(e,t,i,a)}}r.StandardTile=e}(),function(){class e extends r.BimTileset{constructor(e){super(e)}_canBeTraverse(e,t){return!!e.hasChildren()&&(!!e.contentTypeEmpty||e.passSSE(t))}_createNewTileset(){return new e}_createNewTile(e,t,i,a){return new r.StandardTile(e,t,i,a)}_createTraversalController(){this._traversalController=new r.TilesetTraversal}isCheckChildrenPassSSE(){return!1}}r.StandardTileset=e}(),function(){class e extends r.BimTilesModel{constructor(e,t,i,r,a,n){super(e,t,i,r,a,n)}_createNewTileset(e){return new r.StandardTileset(e)}_createNewModel(t,i,r){return e(t,i,r)}}r.StandardTilesModel=e}(),function(){class e extends r.BimTileMaterialManager{constructor(e){super(e),this.mapExcavation=null}destroy(){super.destroy(),this.mapExcavation=null}dealMaterialDefines(e,t){super.dealMaterialDefines(e,t),!0===this.isUseColorWithoutLight&&(e.defines.USE_COLORWITHOUTLIGHT=""),this.mapExcavation&&e.updateExcavation&&(e.updateExcavation(this.mapExcavation),e.updateSide({isExcavation:this.mapExcavation&&this.mapExcavation.isExcavation}))}dealMaterialParm(e){super.dealMaterialParm(e),delete e.doubleSide,delete e.receiveIbl,delete e.receiveIBL,delete e.light,delete e.metalness,delete e.roughness,delete e.texturesList,delete e.customList,delete e.originMetalness,delete e.originRoughness}_createMaterial(e,t,i,a,n){const s=i.toObject();s.hasLightMap=n.hasLightMap,s.vertexColors=!!r.Utils.isDefined(n.vertexColors)&&n.vertexColors,this.dealMaterialParm(s);let o=new r.ObliquePhotographyMaterial(s);o.name=t,this.dealMaterialDefines(o);for(let e in this.settingMaterialPara)this._isIBLParams(e)&&!s.receiveIBL||o.hasOwnProperty(e)&&(o[e]=this.settingMaterialPara[e],void 0!==o.refreshUniforms&&o.refreshUniforms());return o}setExcavation(e){if(e){this.mapExcavation=e;for(const t in this.materialMap){const i=this.materialMap[t];i.updateExcavation&&(i.updateExcavation(e),i.updateSide({isExcavation:e&&e.isExcavation}),i.needsUpdate=!0)}}}}r.ObliquePhotographyMaterialManager=e}(),function(){class e extends r.BimTileFilterManager{constructor(e,t){super(e),this.terrainOperationManager=t,this.stateFlatChangedRenderer=0,this.elevationScratch=new THREE.Vector3,this.worldBoxScratch=new THREE.Box3,this.worldMatrixScratch=new THREE.Matrix4,this.inverseWorldMatrixScratch=new THREE.Matrix4,this.worldPositionScratch=new THREE.Vector3,this.lineStartScratch=new THREE.Vector2,this.lineEndScratch=new THREE.Vector2}standardApply(e){if(this.stateChangedRenderer===e.stateChangedRenderer)return;e._content.meshes.traverse((e=>{if("MeshEx"!==e.type)return;const t=e.geometry,i=t.groups[0].start,a=t.groups[0].count;if(t.clearGroups(),t._visible=!0,!0===this.objectInfoManager.hasLocalClipping){const n=this.getMaterialForClipFrom(e.material[0]);e.material[r.Model.EnumFilterState.BLINK]=n,t.addGroup(i,a,r.Model.EnumFilterState.BLINK)}else t.addGroup(i,a,r.Model.EnumFilterState.NONE)})),e.stateChangedRenderer=this.stateChangedRenderer;const t=this.model.viewer.getScene();let i=r.ClipPlaneManager.getInstance(t);i.isEnabled()&&i.update()}getVisibleComponentsBbox(){return this.model.getBoundingBoxWorld()}addToLocalClippingListByConditions(e){0===e.length&&this.addToLocalClippingList()}addToLocalClippingList(){this.objectInfoManager.activeLocalClipping(),this.enableStateChanged()}clearLocalClippingList(){super.clearLocalClippingList()}updateTileMeshForFlatten(){this.stateFlatChangedRenderer++}applyTileMeshForFlatten(e){if(0===this.stateFlatChangedRenderer||this.stateFlatChangedRenderer===e.stateFlatChangedRenderer)return;const t=e._content.meshes,i=this.model.objectGroup.matrix,r=this.terrainOperationManager;this.worldBoxScratch.copy(e._boundingBox),this.worldBoxScratch.applyMatrix4(i),this.worldBoxScratch.min.y=0,this.worldBoxScratch.max.y=0;const a=t.matrix;this.worldMatrixScratch.multiplyMatrices(i,a);let n=r.isIntersectFlattenBboxDrawing(this.worldBoxScratch,this.model.id);if(!n&&e.isFlattened)return t.children.map((e=>{this.updateGeometryForFlatten(r,e.geometry,this.worldMatrixScratch,!0),e.material[0].side=THREE.FrontSide})),void(e.isFlattened=!1);n&&(t.children.map((e=>{this.updateGeometryForFlatten(r,e.geometry,this.worldMatrixScratch,!1),e.material[0].side=THREE.DoubleSide})),e.isFlattened=!0),e.stateFlatChangedRenderer=this.stateFlatChangedRenderer}updateGeometryForFlatten(e,t,i,a){this.inverseWorldMatrixScratch.copy(i).invert(),t.attributes.normal||t.computeVertexNormals(),t.prePositionArray||(t.prePositionArray=[...t.attributes.position.array],t.preNormalArray=[...t.attributes.normal.array],t.preUVArray=[...t.attributes.uv.array],t.preIndexArray=[...t.index.array]);let n=[...t.prePositionArray],s=[...t.preNormalArray],o=[...t.preUVArray],l=[...t.preIndexArray],d={};if(!a){const a=[...l];for(let h=0;h<a.length;h+=3){const c=n[3*a[h]],u=n[3*a[h]+1],p=t.prePositionArray[3*a[h]+2],m=n[3*a[h+1]],f=n[3*a[h+1]+1],g=t.prePositionArray[3*a[h+1]+2],v=n[3*a[h+2]],y=n[3*a[h+2]+1],M=t.prePositionArray[3*a[h+2]+2];this.worldPositionScratch.set(c,u,p),this.worldPositionScratch.applyMatrix4(i),this.worldPositionScratch.y=this.worldPositionScratch.z;let E=0,b=e.isInFlattenRegionDrawing(this.worldPositionScratch,this.model.id);b&&(b.transformElevation(this.inverseWorldMatrixScratch),E++),this.worldPositionScratch.set(m,f,g),this.worldPositionScratch.applyMatrix4(i),this.worldPositionScratch.y=this.worldPositionScratch.z;let I=e.isInFlattenRegionDrawing(this.worldPositionScratch,this.model.id);I&&(I.transformElevation(this.inverseWorldMatrixScratch),E++),this.worldPositionScratch.set(v,y,M),this.worldPositionScratch.applyMatrix4(i),this.worldPositionScratch.y=this.worldPositionScratch.z;let x=e.isInFlattenRegionDrawing(this.worldPositionScratch,this.model.id);x&&(x.transformElevation(this.inverseWorldMatrixScratch),E++);const T=o[2*a[h]],_=o[2*a[h]+1],S=o[2*a[h+1]],C=o[2*a[h+1]+1],w=o[2*a[h+2]],R=o[2*a[h+2]+1];if(1==E)if(b){n[3*a[h]+2]=b.worldElevation;let e=d[b.id];e||(e=b.transformPolygon(this.inverseWorldMatrixScratch),d[b.id]=e),this.lineStartScratch.set(c,u),this.lineEndScratch.set(m,f);const t=r.Utils.linePolygonIntersection(this.lineStartScratch,this.lineEndScratch,e);this.lineStartScratch.set(v,y),this.lineEndScratch.set(c,u);const i=r.Utils.linePolygonIntersection(this.lineStartScratch,this.lineEndScratch,e);if(!t||!i)continue;n.push(t.x),n.push(t.y),n.push(g),n.push(i.x),n.push(i.y),n.push(M),n.push(t.x),n.push(t.y),n.push(b.worldElevation),n.push(i.x),n.push(i.y),n.push(b.worldElevation);const p=(t.x-c)/(m-c+r.Math.EPSILON6),E=(t.y-u)/(f-u+r.Math.EPSILON6),I=(i.x-v)/(c-v+r.Math.EPSILON6),x=(i.y-y)/(u-y+r.Math.EPSILON6);o.push(T+(S-T)*p),o.push(_+(C-_)*E),o.push(w+(T-w)*I),o.push(R+(_-R)*x),o.push(T+(S-T)*p),o.push(_+(C-_)*E),o.push(w+(T-w)*I),o.push(R+(_-R)*x),s.push(0),s.push(0),s.push(1),s.push(0),s.push(0),s.push(1),s.push(0),s.push(0),s.push(1),s.push(0),s.push(0),s.push(1);const B=n.length/3;l.push(B-4),l.push(B-3),l.push(B-1),l.push(B-4),l.push(B-1),l.push(B-2),l.push(l[h+1]),l.push(l[h+2]),l.push(B-3),l.push(l[h+1]),l.push(B-3),l.push(B-4),l[h+1]=B-2,l[h+2]=B-1}else if(I){n[3*a[h+1]+2]=I.worldElevation;let e=d[I.id];e||(e=I.transformPolygon(this.inverseWorldMatrixScratch),d[I.id]=e),this.lineStartScratch.set(c,u),this.lineEndScratch.set(m,f);const t=r.Utils.linePolygonIntersection(this.lineStartScratch,this.lineEndScratch,e);this.lineStartScratch.set(m,f),this.lineEndScratch.set(v,y);const i=r.Utils.linePolygonIntersection(this.lineStartScratch,this.lineEndScratch,e);if(!t||!i)continue;n.push(t.x),n.push(t.y),n.push(p),n.push(i.x),n.push(i.y),n.push(M),n.push(t.x),n.push(t.y),n.push(I.worldElevation),n.push(i.x),n.push(i.y),n.push(I.worldElevation);const g=(t.x-c)/(m-c+r.Math.EPSILON6),E=(t.y-u)/(f-u+r.Math.EPSILON6),b=(i.x-m)/(v-m+r.Math.EPSILON6),x=(i.y-f)/(y-f+r.Math.EPSILON6);o.push(T+(S-T)*g),o.push(_+(C-_)*E),o.push(S+(w-S)*b),o.push(C+(R-C)*x),o.push(T+(S-T)*g),o.push(_+(C-_)*E),o.push(S+(w-S)*b),o.push(C+(R-C)*x),s.push(0),s.push(0),s.push(1),s.push(0),s.push(0),s.push(1),s.push(0),s.push(0),s.push(1),s.push(0),s.push(0),s.push(1);const B=n.length/3;l.push(B-2),l.push(B-1),l.push(B-3),l.push(B-2),l.push(B-3),l.push(B-4),l.push(l[h]),l.push(B-4),l.push(B-3),l.push(l[h]),l.push(B-3),l.push(l[h+2]),l[h]=l[h+1],l[h+1]=B-1,l[h+2]=B-2}else{n[3*a[h+2]+2]=x.worldElevation;let e=d[x.id];e||(e=x.transformPolygon(this.inverseWorldMatrixScratch),d[x.id]=e),this.lineStartScratch.set(c,u),this.lineEndScratch.set(v,y);const t=r.Utils.linePolygonIntersection(this.lineStartScratch,this.lineEndScratch,e);this.lineStartScratch.set(v,y),this.lineEndScratch.set(m,f);const i=r.Utils.linePolygonIntersection(this.lineStartScratch,this.lineEndScratch,e);if(!t||!i)continue;n.push(t.x),n.push(t.y),n.push(p),n.push(i.x),n.push(i.y),n.push(g),n.push(t.x),n.push(t.y),n.push(x.worldElevation),n.push(i.x),n.push(i.y),n.push(x.worldElevation);const M=(t.x-c)/(v-c+r.Math.EPSILON6),E=(t.y-u)/(y-u+r.Math.EPSILON6),b=(i.x-v)/(m-v+r.Math.EPSILON6),I=(i.y-y)/(f-y+r.Math.EPSILON6);o.push(T+(w-T)*M),o.push(_+(R-_)*E),o.push(w+(S-w)*b),o.push(R+(C-R)*I),o.push(T+(w-T)*M),o.push(_+(R-_)*E),o.push(w+(S-w)*b),o.push(R+(C-R)*I),s.push(0),s.push(0),s.push(1),s.push(0),s.push(0),s.push(1),s.push(0),s.push(0),s.push(1),s.push(0),s.push(0),s.push(1);const B=n.length/3;l.push(B-4),l.push(B-1),l.push(B-2),l.push(B-4),l.push(B-3),l.push(B-1),l.push(l[h]),l.push(l[h+1]),l.push(B-3),l.push(l[h]),l.push(B-3),l.push(B-4),l[h]=l[h+2],l[h+1]=B-2,l[h+2]=B-1}else if(2==E)if(b)if(I){n[3*a[h]+2]=b.worldElevation,n[3*a[h+1]+2]=I.worldElevation;let e=d[b.id];e||(e=b.transformPolygon(this.inverseWorldMatrixScratch),d[b.id]=e);let t=d[I.id];t||(t=I.transformPolygon(this.inverseWorldMatrixScratch),d[I.id]=t),this.lineStartScratch.set(c,u),this.lineEndScratch.set(v,y);let i=r.Utils.linePolygonIntersection(this.lineStartScratch,this.lineEndScratch,e);i||(i=r.Utils.linePolygonIntersection(this.lineStartScratch,this.lineEndScratch,t)),this.lineStartScratch.set(v,y),this.lineEndScratch.set(m,f);let p=r.Utils.linePolygonIntersection(this.lineStartScratch,this.lineEndScratch,e);if(p||(p=r.Utils.linePolygonIntersection(this.lineStartScratch,this.lineEndScratch,t)),!i||!p)continue;n.push(i.x),n.push(i.y),n.push(b.worldElevation),n.push(p.x),n.push(p.y),n.push(b.worldElevation),n.push(i.x),n.push(i.y),n.push(M),n.push(p.x),n.push(p.y),n.push(M);const g=(i.x-c)/(v-c+r.Math.EPSILON6),E=(i.y-u)/(y-u+r.Math.EPSILON6),x=(p.x-v)/(m-v+r.Math.EPSILON6),B=(p.y-y)/(f-y+r.Math.EPSILON6);o.push(T+(w-T)*g),o.push(_+(R-_)*E),o.push(w+(S-w)*x),o.push(R+(C-R)*B),o.push(T+(w-T)*g),o.push(_+(R-_)*E),o.push(w+(S-w)*x),o.push(R+(C-R)*B),s.push(0),s.push(0),s.push(1),s.push(0),s.push(0),s.push(1),s.push(0),s.push(0),s.push(1),s.push(0),s.push(0),s.push(1);const L=n.length/3;l.push(l[h]),l.push(L-3),l.push(L-4),l.push(L-4),l.push(L-3),l.push(L-1),l.push(L-4),l.push(L-1),l.push(L-2),l.push(l[h+2]),l.push(L-2),l.push(L-1),l[h+2]=L-3}else{n[3*a[h]+2]=b.worldElevation,n[3*a[h+2]+2]=x.worldElevation;let e=d[b.id];e||(e=b.transformPolygon(this.inverseWorldMatrixScratch),d[b.id]=e);let t=d[x.id];t||(t=x.transformPolygon(this.inverseWorldMatrixScratch),d[x.id]=t),this.lineStartScratch.set(c,u),this.lineEndScratch.set(m,f);let i=r.Utils.linePolygonIntersection(this.lineStartScratch,this.lineEndScratch,e);i||(i=r.Utils.linePolygonIntersection(this.lineStartScratch,this.lineEndScratch,t)),this.lineStartScratch.set(m,f),this.lineEndScratch.set(v,y);let p=r.Utils.linePolygonIntersection(this.lineStartScratch,this.lineEndScratch,e);if(p||(p=r.Utils.linePolygonIntersection(this.lineStartScratch,this.lineEndScratch,t)),!i||!p)continue;n.push(i.x),n.push(i.y),n.push(b.worldElevation),n.push(p.x),n.push(p.y),n.push(b.worldElevation),n.push(i.x),n.push(i.y),n.push(g),n.push(p.x),n.push(p.y),n.push(g);const M=(i.x-c)/(m-c+r.Math.EPSILON6),E=(i.y-u)/(f-u+r.Math.EPSILON6),I=(p.x-m)/(v-m+r.Math.EPSILON6),B=(p.y-f)/(y-f+r.Math.EPSILON6);o.push(T+(S-T)*M),o.push(_+(C-_)*E),o.push(S+(w-S)*I),o.push(C+(R-C)*B),o.push(T+(S-T)*M),o.push(_+(C-_)*E),o.push(S+(w-S)*I),o.push(C+(R-C)*B),s.push(0),s.push(0),s.push(1),s.push(0),s.push(0),s.push(1),s.push(0),s.push(0),s.push(1),s.push(0),s.push(0),s.push(1);const L=n.length/3;l.push(l[h+2]),l.push(L-4),l.push(L-3),l.push(L-2),l.push(L-3),l.push(L-4),l.push(L-2),l.push(L-1),l.push(L-3),l.push(l[h+1]),l.push(L-1),l.push(L-2),l[h+1]=L-4}else{n[3*a[h+1]+2]=I.worldElevation,n[3*a[h+2]+2]=x.worldElevation;let e=d[I.id];e||(e=I.transformPolygon(this.inverseWorldMatrixScratch),d[I.id]=e);let t=d[x.id];t||(t=x.transformPolygon(this.inverseWorldMatrixScratch),d[x.id]=t),this.lineStartScratch.set(c,u),this.lineEndScratch.set(m,f);let i=r.Utils.linePolygonIntersection(this.lineStartScratch,this.lineEndScratch,e);i||(i=r.Utils.linePolygonIntersection(this.lineStartScratch,this.lineEndScratch,t)),this.lineStartScratch.set(v,y),this.lineEndScratch.set(c,u);let g=r.Utils.linePolygonIntersection(this.lineStartScratch,this.lineEndScratch,e);if(g||(g=r.Utils.linePolygonIntersection(this.lineStartScratch,this.lineEndScratch,t)),!i||!g)continue;n.push(i.x),n.push(i.y),n.push(I.worldElevation),n.push(g.x),n.push(g.y),n.push(I.worldElevation),n.push(i.x),n.push(i.y),n.push(p),n.push(g.x),n.push(g.y),n.push(p);const M=(i.x-c)/(m-c+r.Math.EPSILON6),E=(i.y-u)/(f-u+r.Math.EPSILON6),b=(g.x-v)/(c-v+r.Math.EPSILON6),B=(g.y-y)/(u-y+r.Math.EPSILON6);o.push(T+(S-T)*M),o.push(_+(C-_)*E),o.push(w+(T-w)*b),o.push(R+(_-R)*B),o.push(T+(S-T)*M),o.push(_+(C-_)*E),o.push(w+(T-w)*b),o.push(R+(_-R)*B),s.push(0),s.push(0),s.push(1),s.push(0),s.push(0),s.push(1),s.push(0),s.push(0),s.push(1),s.push(0),s.push(0),s.push(1);const L=n.length/3;l.push(l[h+1]),l.push(l[h+2]),l.push(L-3),l.push(L-4),l.push(L-1),l.push(L-2),l.push(L-4),l.push(L-3),l.push(L-1),l.push(l[h]),l.push(L-2),l.push(L-1),l[h]=l[h+1],l[h+1]=L-3,l[h+2]=L-4}else 3==E&&(n[3*a[h]+2]=b.worldElevation,n[3*a[h+1]+2]=I.worldElevation,n[3*a[h+2]+2]=x.worldElevation)}}t.setIndex(l),t.deleteAttribute("position"),t.deleteAttribute("uv"),t.deleteAttribute("normal"),t.setAttribute("position",new THREE.Float32BufferAttribute(n,3)),t.setAttribute("uv",new THREE.Float32BufferAttribute(o,2)),t.setAttribute("normal",new THREE.Float32BufferAttribute(s,3)),t.clearGroups(),t._visible=!0,t.addGroup(0,t.index.count,r.Model.EnumFilterState.NONE),t.computeBoundingBox(),t.computeBoundingSphere()}}r.ObliquePhotographyModelFilterManager=e}(),function(){class e extends r.StandardTilesModel{constructor(e,t,i,r,a,n){super(e,t,i,r,a,n)}_createNewModel(t,i,r){return e(t,i,r)}setExcavation(e){this.materialManager.setExcavation(e)}_crateFilterManger(){return new r.ObliquePhotographyModelFilterManager(this,this.viewer.terrainOperationManager)}_crateMaterialManger(e){return new r.ObliquePhotographyMaterialManager(e)}updateTileMeshForFlatten(){this.filter.updateTileMeshForFlatten()}}r.ObliquePhotographyModel=e}(),function(){class e extends r.BimTilesModel{constructor(e,t,i,r,a,n){super(e,t,i,r,a,n)}_createNewTileset(e){return new r.Workers.Tileset(e)}_createLoader(e){this.tilesLoader=new r.Workers.TilesLoader(e)}_crateFilterManger(){return new r.Workers.TilesFilterManager(this)}_crateMaterialManger(e){return new r.Workers.MaterialManager(e)}getUserIdMapByFrustum(e){const t=this.tilesLoader.tileReader.searchTreeManager,i=this.transformMatrix,r=this.viewer.getScene().getMatrixGlobal();return t.getUserIdMapByFrustum(e,i,r)}getRealUserId(e){return this.tilesLoader.tileReader.getUserIdByIndex(e)}getWireframeMaterial(){return this.materialManager.getWireframeMaterialManager().getWireframeMaterial()}getInstanceWireframeMaterial(){return this.materialManager.getWireframeMaterialManager().getInstanceWireframeMaterial()}setWireframeColor(e,t){return this.materialManager.getWireframeMaterialManager().setWireframeColor(e,t)}getWireframeColor(){return this.materialManager.getWireframeMaterialManager().getWireframeColor()}restoreWireframeColor(){return this.materialManager.getWireframeMaterialManager().restoreWireframeColor()}}r.Workers.TilesModel=e}(),function(){class e extends r.BimTileContent{constructor(e,t){super(e,t),this._outlineContent=void 0}disposeGeometry(){this._meshes.parent&&this._meshes.parent.remove(this._meshes),this._texturesByteLength=0;const e=this._meshes.children;for(let t=0,i=e.length;t<i;++t){const i=e[t];if(i.children&&i.children.length)for(let e=0,t=i.children.length;e<t;++e){const t=i.children[e];this.disposeGeometryAttributes(t),this._disposeMesh(t)}else i.geometry&&(this.disposeGeometryAttributes(i),this._disposeMesh(i))}this._meshes=void 0,this.disposeGeometryRelatedResource()}_disposeMesh(e){const t=e.geometry;t.dispose(),t.groups=void 0,t.index=void 0,t.attributes=void 0,this._disposeMaterials(e.material),e.geometry=void 0,e.material=void 0}getMeshBuilder(){r.Error.throwError(r.ERRORS.DEVELOPE_EXCEPTION,"Needs to be overridden by subclasses!")}disposeGeometryAttributes(e){}disposeGeometryRelatedResource(){}update(e){const t=this._tile;this._state===r.TileContentProcessState.PENDING&&(this._state=r.TileContentProcessState.PROCESSING,this._parseContentBlock((i=>{this._buildContent(t,i,e)}))),this._state,r.TileContentProcessState.PROCESSED,this._updateOutline()}updateContent(e){e.setByteLength(this.geometryByteLength),this.attachToTilesGroup(e),this.disposeContentBuffer()}_buildContent(e,t,i){0!==t.length&&this._isValidTileContent(e)&&this._createMeshes(t).then((()=>{this._isValidTileContent(e)&&(this._state=r.TileContentProcessState.PROCESSED,this.updateContent(e),this._readyDeferred&&this._readyDeferred.resolve(this),this._ready=!0,i.afterRenderFns.push((function(){})))}))}_createMeshes(e){const t=this._tile,i=this.getMeshBuilder().build(t,e);return i&&i.length?Promise.all(i):Promise.resolve()}_updateOutline(){this._ready&&this._tile.isOutlineActivated()&&this._outlineContent.update()}_parseContentBlock(e){if("CMPT"===this._tile.contentType)return;const t=r.TilesUtil.getProtobufDecoder(),i=this._contentBuffer,a=[];for(const e in i){const r=new Promise(((r,a)=>{t.decodeByBuffer(i[e],{url:e},(e=>{r(e)}),(e=>{a(e)}))}));a.push(r)}Promise.all(a).then((t=>{e(t)})).catch((e=>{console.log(e)}))}parseTileContent(e){}_isValidTileContent(e){return!e.isDestroyed()&&!this.isDestroyed()}clone(t){t=r.Utils.defaultValue(t,new e),super.clone(t)}}r.Workers.TileContent=e}(),function(){class e extends r.Workers.TileContent{constructor(e,t){super(e,t),this._outlineContent=new r.Workers.TileBatchedOutlineContent(e)}getMeshBuilder(){return this._tile._loader.getBatchedMeshBuilder()}clone(t){t=r.Utils.defaultValue(t,new e),super.clone(t)}}r.Workers.TileBatchedContent=e}(),function(){class e extends r.Workers.TileContent{constructor(e,t){super(e,t),this._outlineContent=new r.Workers.TileInstancedOutlineContent(e)}getMeshBuilder(){return this._tile._loader.getInstancedMeshBuilder()}disposeGeometryRelatedResource(){const e=this._tile,t=e.contentInsModel;e._tileset.getSharedGeometryManager().disposeGeometry(t)}disposeGeometryAttributes(e){const t=e.geometry,i=r.Utils.defaultValue(e.blockId,0),a=this._getSharedGeometry();if(a){if(1!==a.refCount){const e=a.getGeometryInfo(i);if(!e)return void console.log("getting shared geometry info exception!");e.index&&t.index&&(t.index=null),e.attributes.forEach((e=>{t.hasAttribute(e.name)&&t.deleteAttribute(e.name)}))}}else console.log("getting shared geometry exception!")}updateContent(e){e.setByteLength(this.geometryByteLength),e.setShareGeometryProcessed(),this.attachToTilesGroup(e),this.disposeContentBuffer()}_getSharedGeometry(){return this._tile._getSharedGeometry()}clone(t){t=r.Utils.defaultValue(t,new e),super.clone(t)}}r.Workers.TileInstancedContent=e}(),function(){class e extends r.BimTileOutlineContent{constructor(e){super(e),this.bufferByteLength=0}disposeLineGeometry(){this._outlineMeshes.parent&&this._outlineMeshes.parent.remove(this._outlineMeshes),this.bufferByteLength=0;const e=this._outlineMeshes.children;for(let t=0,i=e.length;t<i;++t){const i=e[t];this.disposeGeometryAttributes(i),this._disposeMesh(i)}this.disposeGeometryRelatedResource()}_disposeMesh(e){const t=e.geometry;t.dispose(),t.groups=void 0,t.index=void 0,t.attributes=void 0,e.geometry=void 0,e.material=void 0}disposeGeometryAttributes(e){}disposeGeometryRelatedResource(){}getMeshBuilder(){r.Error.throwError(r.ERRORS.DEVELOPE_EXCEPTION,"Needs to be overridden by subclasses!")}getMeshGroupName(){return r.ObjectGroupType.WIREFRAME}update(){this._state===r.TileContentProcessState.PENDING&&this.requestContent(),this._state===r.TileContentProcessState.LOADED&&this.parseContent(),this._state===r.TileContentProcessState.PROCESSED&&this.updateContent(),this._state,r.TileContentProcessState.READY}parseContent(){const e=this._tile,t=this._buffer;this.bufferByteLength=t.byteLength,this._state=r.TileContentProcessState.PROCESSING;const i=e.getOutlineContentUrl();r.TilesUtil.getProtobufDecoder().decodeByBuffer(t,{url:i},(t=>{this._parse(e,t)}),(e=>{}))}updateContent(){this._state=r.TileContentProcessState.READY,this._tile._content._geometryByteLength+=this.bufferByteLength,this.attachToTilesGroup(this._tile),this.disposeContentBuffer()}_parse(e,t){t&&(e.isDestroyed()||this.isDestroyed()||(this._state=r.TileContentProcessState.PROCESSED,this.createMeshes(t)))}createMeshes(e){this.getMeshBuilder().build(this,e)}attachToTilesGroup(e){const t=this._tile._tileset._objectGroup,i=this.getMeshGroupName(),r=t.getObjectByName(i);r.add(this.outlineMeshes),r.updateMatrixWorld(!0)}}r.Workers.TileOutlineContent=e}(),function(){class e extends r.Workers.TileOutlineContent{constructor(e){super(e)}getMeshBuilder(){return this._tile._loader.getBatchedOutlineBuilder()}}r.Workers.TileBatchedOutlineContent=e}(),function(){class e extends r.Workers.TileOutlineContent{constructor(e){super(e)}disposeGeometryAttributes(e){const t=e.geometry,i=r.Utils.defaultValue(e.blockId,0),a=this._getSharedGeometry();if(a){if(1!==a.refCount){const e=a.getGeometryInfo(i);if(!e)return void console.log("getting shared geometry info exception!");e.index&&t.index&&(t.index=null),e.attributes.forEach((e=>{t.hasAttribute(e.name)&&t.deleteAttribute(e.name)}))}}else console.log("getting shared geometry exception!")}disposeGeometryRelatedResource(){const e=this._tile,t=e.contentOutlineId;e._tileset.getSharedGeometryManager().disposeGeometry(t)}getMeshBuilder(){return this._tile._loader.getInstancedOutlineBuilder()}getMeshGroupName(){return r.ObjectGroupType.INSTANCEWIREFRAMEGEOMETRY}requestContent(){let e=this._getSharedGeometry();if(r.Utils.defined(e)||(e=this._createShareGeometry()),e.state===r.SharedGeometryState.UNLOADED){const t=super.requestContent();return t&&(e.state=r.SharedGeometryState.PROCESSING),t}return e.state!==r.SharedGeometryState.PROCESSING&&(e.state===r.SharedGeometryState.PROCESSED&&(this._state=r.TileContentProcessState.LOADED,this._buffer=null,!0))}parseContent(){this._buffer?super.parseContent():this._parseContentIfSharedGeometryLoaded()}_parseContentIfSharedGeometryLoaded(){this._state=r.TileContentProcessState.PROCESSED,this.bufferByteLength=0,this.createMeshes()}handleAfterRequestCancelled(){this._resetShareGeometryState()}updateContent(){this._setShareGeometryProcessed(),super.updateContent()}_getSharedGeometry(){const e=this._tile,t=e.contentOutlineId;return e._tileset.getSharedGeometryManager().getGeometryById(t)}_createShareGeometry(){const e=this._tile,t=e.contentOutlineId;return e._tileset.getSharedGeometryManager().createGeometryById(t)}_setShareGeometryProcessed(){const e=this._getSharedGeometry();r.Utils.defined(e)&&(e.ref(),e.state=r.SharedGeometryState.PROCESSED)}_resetShareGeometryState(){const e=this._getSharedGeometry();r.Utils.defined(e)&&(e.state=r.SharedGeometryState.UNLOADED)}}r.Workers.TileInstancedOutlineContent=e}(),function(){class e extends r.BimTileNode{constructor(e,t,i,r){super(e,t,i,r)}_createNewTile(t,i,r,a){return new e(t,i,r,a)}createContent(e){return this.isTilesetContent?new r.TileTilesetContent(this,e):this.isInstanceTile?new r.Workers.TileInstancedContent(this,e):new r.Workers.TileBatchedContent(this,e)}parseOutlineContentBlock(e,t){t(e)}parseCMPTContentBlock(e,t){const i=[];for(const t in e){const e=r.RequestSpliter.splitByUrlMd5(t),a=this._loader.CMPTUrlMap[e].buffer.slice(this.contentCMPTOffset,this.contentCMPTOffset+this.contentCMPTSize);i.push(a)}t(i)}parseContentBlock(e,t){}_requestInstanceContent(){let e=this._getSharedGeometry();if(r.Utils.defined(e)||(e=this._createShareGeometry()),e.state===r.SharedGeometryState.UNLOADED){const t=this.getAbsoluteContentUrl(),i=this.getAbsoluteInstanceMeshContentUrl();this._getResource()._url=[t,i];const a=this._requestContent();return a&&(e.state=r.SharedGeometryState.PROCESSING),a}if(e.state===r.SharedGeometryState.PROCESSING)return!1;if(e.state===r.SharedGeometryState.PROCESSED){const e=this.getAbsoluteContentUrl();return this._getResource()._url=[e],this._requestContent()}return!1}requestContent(){return this.isInstanceTile?this._requestInstanceContent():this._requestContent()}_getSharedGeometry(){const e=this.contentInsModel;return this._tileset.getSharedGeometryManager().getGeometryById(e)}_createShareGeometry(){const e=this.contentInsModel;return this._tileset.getSharedGeometryManager().createGeometryById(e)}setShareGeometryProcessed(){const e=this._getSharedGeometry();r.Utils.defined(e)&&(e.ref(),e.state=r.SharedGeometryState.PROCESSED)}_cancelSharedGeometryRequest(){if(!this.isInstanceTile)return;const e=this._getSharedGeometry();r.Utils.defined(e)&&(e.state=r.SharedGeometryState.UNLOADED)}_getResource(){const e=this._resource;if(e)return e;const t=this.getAbsoluteContentUrl();let i;if(this.isTilesetContent)i=t;else if(this.isInstanceTile){i=[t,this.getAbsoluteInstanceMeshContentUrl()]}else i=[t];return this._resource=r.Resource.create({url:i}),this._resource}getAbsoluteInstanceMeshContentUrl(){return this._contentInsModelIndex}}r.Workers.Tile=e}(),function(){class e extends r.BimTileset{constructor(e){super(e),this._sharedGeometryManager=new r.Workers.SharedGeometryManager}destroy(){super.destroy(),this._sharedGeometryManager.destroy(),this._sharedGeometryManager=void 0}getSharedGeometryManager(){return this._sharedGeometryManager}_createNewTile(e,t,i,a){return new r.Workers.Tile(e,t,i,a)}loadUserIdResources(e){const t=this._loader,i=this._loader.tileReader;t.loadUserIdResources().then((()=>{i.createNodeInfoMap(),i.createTileIdMap(),this._userIdReady=!0,e&&e()}))}}r.Workers.Tileset=e}(),function(){class e extends r.BimTilesLoader{constructor(e){super(e),this._initMeshBuilder()}destroy(){this._destroyMeshBuilder(),super.destroy()}_initMeshBuilder(){this._batchedMeshBuilder=new r.Workers.BatchedMeshBuilder,this._batchedOutlineBuilder=new r.Workers.BatchedOutlineBuilder(this._batchedMeshBuilder),this._instancedMeshBuilder=new r.Workers.InstancedMeshBuilder,this._instancedOutlineBuilder=new r.Workers.InstancedOutlineBuilder(this._instancedMeshBuilder)}_destroyMeshBuilder(){this._batchedOutlineBuilder.destroy(),this._batchedOutlineBuilder=void 0,this._batchedMeshBuilder.destroy(),this._batchedMeshBuilder=void 0,this._instancedOutlineBuilder.destroy(),this._instancedOutlineBuilder=void 0,this._instancedMeshBuilder.destroy(),this._instancedMeshBuilder=void 0}getBatchedMeshBuilder(){return this._batchedMeshBuilder}getBatchedOutlineBuilder(){return this._batchedOutlineBuilder}getInstancedMeshBuilder(){return this._instancedMeshBuilder}getInstancedOutlineBuilder(){return this._instancedOutlineBuilder}_createTileReader(){this.useDataV2=r.BimTilesVersionControl.isVersion_2(this.dataVersion),this.tileReader=new r.Workers.TilesReader({useDataV2:this.useDataV2})}addSearchTreeUrl(e,t,i){this.tileReader.searchTreeManager.addUrl({url:e,box:t,callback:i})}loadSearchTree(){const e=r.Workers.ParserType.SEARCHTREE,t=r.Workers.TileBlockType.BT_INDEX;return this._parseDataBlock(e,t)}loadGlobalResources(e){return this.loadMaterialBlock()}loadMaterialBlock(){const{tileReader:e}=this,t=e.globalMaterialUrl;if(!r.Utils.isDefined(t))return Promise.resolve();const i=r.Workers.TileBlockType,a=this.materialManager.getMaterialParser();return this.loadAndDecode(t).then((e=>{a.update(e.parsedData[i.BT_MATERIAL])}))}loadUserIdBlock(){const e=r.Workers.ParserType.USERID,t=r.Workers.TileBlockType.BT_USERID;return this._parseDataBlock(e,t)}registerResourcesLoadDelay(e){const t=this,i=function(){console.log("------ resources delay load ------"),e.unregisterEventListener(r.EVENTS.ON_TILES_LOAD_INITIAL,i),t.loadUserDataBlock(),t.loadUserIdBlock(),t.loadSearchTree()};e.registerEventListener(r.EVENTS.ON_TILES_LOAD_INITIAL,i)}loadUserDataBlock(){const e=r.Workers.ParserType.USERDATA,t=r.Workers.TileBlockType.BT_USERDATA;return this._parseDataBlock(e,t)}loadTileIdBlock(){const e=r.Workers.ParserType.TILEID,t=r.Workers.TileBlockType.BT_TILEID;return this._parseDataBlock(e,t)}loadViewTreeBlock(){const e=r.Workers.ParserType.VIEWTREE,t=r.Workers.TileBlockType.BT_VIEWTREE;return this._parseDataBlock(e,t)}loadNodeBoxBlock(){const e=r.Workers.ParserType.NODEBOX,t=r.Workers.TileBlockType.BT_NODEBOX;return this._parseDataBlock(e,t)}loadNodeIdBlock(){const e=r.Workers.ParserType.NODEID,t=r.Workers.TileBlockType.BT_NODEID;return this._parseDataBlock(e,t)}loadInstancePrecuttingTreeResources(e){const t=this.loadViewTreeBlock();if(t)return t.then((()=>{this.rootViewNode=this.tileReader.getRootViewNode()}))}_parseDataBlock(e,t){const i=this.tileReader.getParserByType(e);if(!i)return;const r=[];return i.traverseUrls((e=>{const a="object"==typeof e,n=a?e.url:e,s=a?e.callback:void 0,o=this.loadAndDecode(n).then((r=>{i.update({data:r.parsedData[t],params:{element:e,tickTime:r.tickTime,packToBuffer:r.packToBuffer}}),s&&s()}),(e=>{console.log(e)}));r.push(o)})),Promise.all(r).then((()=>{}))}loadUserIdResources(){const e=[],t=this.loadUserIdBlock();t&&e.push(t);const i=this.loadUserDataBlock();i&&e.push(i);const r=this.loadTileIdBlock();r&&e.push(r);const a=this.loadSearchTree();a&&e.push(a);const n=this.loadNodeIdBlock();n&&e.push(n);const s=this.loadNodeBoxBlock();return s&&e.push(s),Promise.all(e)}loadAndDecode(e,t){const i=r.TilesUtil.getProtobufDecoder(),a=this.useDataV2?1:0;return void 0===t&&(t=!1),new Promise(t?(t,r)=>{i.decodeByUrl(e,{packToBuffer:!0,version:a},(e=>{t(e)}),(e=>{r(e)}))}:(t,r)=>{this.loadArrayBufferDirectly(e,(n=>{i.decodeByBuffer(n,{url:e,version:a},(e=>{t(e)}),(e=>{r(e)}))}))})}}r.Workers.TilesLoader=e}(),function(){const e=Object.freeze({USERID:0,USERDATA:1,SEARCHTREE:2,TILEID:3,VIEWTREE:4,NODEID:5,NODEBOX:6});r.Workers.ParserType=e,r.Workers.TilesReader=class{constructor(e){this.descriptor=new r.BimtileDescriptor,this._useDataV2=r.Utils.defaultValue(e.useDataV2,!1),this._initParsers(),this.globalMaterialUrl=void 0,this.globalInstance=void 0,this.globalLodUrl=void 0,this.globalVisibilityUrl=void 0}destroy(){this.descriptor.destroy(),this.descriptor=void 0,this._destroyParsers()}getDescriptor(){return this.descriptor}get searchTreeManager(){return this.getParserByType(r.Workers.ParserType.SEARCHTREE)}get userDataParser(){return this.getParserByType(r.Workers.ParserType.USERDATA)}_initParsers(){this._parsers={},this._createParserByType(e.SEARCHTREE)}_destroyParsers(){let e=this._parsers;for(const t in e)if(Object.hasOwnProperty.call(e,t)){const i=e[t];i&&i.destroy()}e=void 0,this._parsers=void 0}_createParserByType(t){let i=this._parsers[t];if(i)return i;const a=this._useDataV2;switch(t){case e.USERID:i=a?new r.Workers.UserIdV2Parser:new r.Workers.UserIdParser;break;case e.USERDATA:i=new r.Workers.UserDataParser;break;case e.SEARCHTREE:i=a?new r.Workers.SearchTreeV2Parser(this):new r.Workers.SearchTreeV1Parser;break;case e.TILEID:i=new r.Workers.TileIdParser;break;case e.VIEWTREE:i=new r.Workers.ViewTreeParser;break;case e.NODEID:i=new r.Workers.NodeIdParser;break;case e.NODEBOX:i=new r.Workers.NodeBoxParser}return i&&(this._parsers[t]=i),i}getParserByType(e){return this._parsers[e]}getNodeByIndex(e){return this.getParserByType(r.Workers.ParserType.NODEID).getNode(e)}getNodeBBoxByIndex(e){return this.getParserByType(r.Workers.ParserType.NODEBOX).getNode(e)}getRootViewNode(){return this.getParserByType(r.Workers.ParserType.VIEWTREE).getRoot()}getUserdataIdByIndex(e){return this.getParserByType(r.Workers.ParserType.USERID).getUserdataIdByIndex(e)}getUserIdByIndex(e){return this.getParserByType(r.Workers.ParserType.USERID).getUserIdByIndex(e)}getIndexByUserId(e){return this.getParserByType(r.Workers.ParserType.USERID).getIndexByUserId(e)}getUserDataIndexMapByString(e,t){return this.getParserByType(r.Workers.ParserType.USERDATA).getUserDataIndexMapByString(e,t)}getUserDataStringMapByIndex(e,t){return this.getParserByType(r.Workers.ParserType.USERDATA).getUserDataStringMapByIndex(e,t)}getUserDataByIndex(e){return this.getParserByType(r.Workers.ParserType.USERDATA).getUserDataByIndex(e)}createNodeInfoMap(){this._useDataV2?this.createNodeInfoMapV2():this.createNodeInfoMapV1()}createNodeInfoMapV1(){const e=this.getDescriptor(),t=this.getParserByType(r.Workers.ParserType.TILEID),i=this.getParserByType(r.Workers.ParserType.USERID);i&&(i.traverse((i=>{const a=new r.BimTileNodeInfo;a.index=i.nodeId,a.blockId=i.blockId,a.userId=i.userId,a.userData=i.userdataId,a.boundingBox=Object.values(i.boundingBox),a.tileId=i.tileId,t&&t.isInstanceTile(i.tileId)&&(a.instanceOrNot=!0),e._classifyNodeInfo(a)})),this.clearCacheFromDataParser())}createNodeInfoMapV2(){const e=this.getDescriptor(),t=this.getParserByType(r.Workers.ParserType.TILEID),i=this.getParserByType(r.Workers.ParserType.NODEID);i&&(i.traverse((i=>{const a=new r.BimTileNodeInfo;a.blockId=0,a.userId=i.userId,a.userData=this.getUserdataIdByIndex(i.userId),a.boundingBox=this.getNodeBBoxByIndex(i.bboxId),a.tileId=i.tileId,a.index=i.nodeId,t&&t.isInstanceTile(i.tileId)&&(a.instanceOrNot=!0),e._classifyNodeInfo(a)})),this.clearCacheFromDataParser())}clearCacheFromDataParser(){let e=this._parsers;for(const t in e)if(Object.hasOwnProperty.call(e,t)){const i=e[t];i&&i.clear()}}createTileIdMap(){}parseSchemaProperties(t,i){if(void 0===t)return;if(this.layerKey=t.layerKey,this.layerValue=t.layerValue,this.globalMaterialUrl=t.globalMaterial?i+t.globalMaterial.content.url:void 0,this.globalInstance=t.instanceTiles?i+t.instanceTiles.content.url:void 0,this.globalLodUrl=t.groupTiles?i+t.groupTiles.content.url:void 0,this.globalVisibilityUrl=t.visibilityTiles?i+t.visibilityTiles.content.url:void 0,t.globalUserdata){const r=i+t.globalUserdata.content.url;this._createParserByType(e.USERDATA).addUrl(r)}const r=t.globalUserID;if(r){const t=this._createParserByType(e.USERID);r.map((e=>{const r=i+e.content.url;t.addUrl(r)}))}if(t.globalTileID){const r=i+t.globalTileID.content.url;this._createParserByType(e.TILEID).addUrl(r)}const a=t.globalNodeID;if(a){const t=this._createParserByType(e.NODEID);a.map((e=>{const r=i+e.content.url;t.addUrl({url:r,startPos:e.startPos})}))}const n=t.globalNodeBox;if(n){const t=this._createParserByType(e.NODEBOX);n.map((e=>{const r=i+e.content.url;t.addUrl({url:r,startPos:e.startPos})}))}if(t.globalInsPrecuttingTree){const r=i+t.globalInsPrecuttingTree.content.url;this._createParserByType(e.VIEWTREE).addUrl(r)}}}}(),r.Workers.DataParser=class{constructor(){this.nodeMap={},this.urls=[]}destroy(){this.nodeMap=void 0,this.urls=void 0}update(e){r.Error.throwError(r.ERRORS.DEVELOPE_EXCEPTION,"Needs to be overridden by subclasses!")}addUrl(e){this.urls.push(e)}clearUrls(){this.urls=[]}traverseUrls(e){this.urls.forEach((t=>{e(t)}))}traverse(e){const t=this.nodeMap;Object.keys(t).forEach((i=>{const r=t[i];e(r)}))}clearNodeMap(){this.nodeMap={}}clear(){this.clearUrls(),this.clearNodeMap()}},function(){const e={isInBox:(e,t)=>e.max.x>=t.max.x&&e.min.x<=t.min.x&&e.max.y>=t.max.y&&e.min.y<=t.min.y&&e.max.z>=t.max.z&&e.min.z<=t.min.z,isIntersectsBox:(t,i)=>i.intersectsBox(t)?e.isInBox(t,i)?1:2:0,getBoxDistanceByRay:(e,t)=>e.intersectBoxWithDistance(t),getBoxDistanceByBox:(e,t,i,r)=>(t.applyMatrix4(i),e.intersectsBox(t)?1:-1)};class t extends r.Workers.DataParser{constructor(){super()}clear(){this.clearUrls()}getBoundingBox(e){return this.nodeMap[e].box}getOctreeList(e){return r.Error.throwError(r.ERRORS.DEVELOPE_EXCEPTION,"Needs to be overridden by subclasses!"),[]}getNodeByIndex(e,t){r.Error.throwError(r.ERRORS.DEVELOPE_EXCEPTION,"Needs to be overridden by subclasses!")}holdNode(e,t){r.Error.throwError(r.ERRORS.DEVELOPE_EXCEPTION,"Needs to be overridden by subclasses!")}_traverse(e,t){const i=this,a=this.nodeMap;let n=r.Utils.scratchBoundingBox,s=function(r,a,o){if(n.setFromArray(o.boundingBox),e(n))return;let l=o.nodeIds;if(l)for(let a=0,s=l.length;a<s;++a){const s=l[a],{node:o,boudingBox:d}=i.getNodeByIndex(r,s);n.setFromArray(d),e(n)||t(o)}let d=o.children;d&&d.map((e=>{const t=a[e];s(r,a,t)}))};for(const t in a){if(n.copy(this.getBoundingBox(t)),e(n))continue;const i=this.getOctreeList(t),r=i[0];s(t,i,r)}}intersect(t,i,a,n,s,o){let l,d={};if(!i){let e=r.Utils.scratchMatrix4_1;e.copy(n).invert(),l=t.ray.clone().applyMatrix4(a).applyMatrix4(e)}return this._traverse((t=>{const r=i?e.getBoxDistanceByBox(i,t,n,s):e.getBoxDistanceByRay(l,t);return!o&&r<0}),(e=>{this.holdNode(e,d)})),d}getUserIdMapByFrustum(e,t,i){let r={};return this._traverse((r=>(r.applyMatrix4(t).applyMatrix4(i),!e.intersectsBox(r))),(e=>{this.holdNode(e,r)})),r}getObjectsInBox(t,i,r,a,n){this._traverse((t=>(t.applyMatrix4(a).applyMatrix4(n),!e.isIntersectsBox(t,r))),(e=>{const r=e.userId,a=i.getRealUserId(r);t[a]=!0}))}getObjectsInBoxByBimtile(e,t,i,r){this.getObjectsInBox(e,t,i,t.getTransformMatrix(),r)}}r.Workers.SearchTreeParser=t}(),function(){class e extends r.Workers.SearchTreeParser{constructor(){super()}update(e){const{url:t,box:i}=e.params.element,r=e.data;this.nodeMap[t]={nodes:{nodeIdItems:JSON.parse(r.nodeIdItems),nodeIdBoxes:r.nodeIdBoxes,treeNodeItems:r.treeNodeItems},box:i}}getOctreeList(e){return this.nodeMap[e].nodes.treeNodeItems}getNodeByIndex(e,t){const i=this.nodeMap[e].nodes;return{node:i.nodeIdItems[t],boudingBox:i.nodeIdBoxes[t]}}holdNode(e,t){const i=`${e.tileId}_${e.blockId}_${e.nodeId}`;void 0===t[e.userId]?t[e.userId]=[i]:t[e.userId].push(i)}}r.Workers.SearchTreeV1Parser=e}(),function(){class e extends r.Workers.SearchTreeParser{constructor(e){super(),this.reader=e}destroy(){this.reader=void 0,super.destroy()}update(e){const t=e.data,{url:i,box:r}=e.params.element;this.nodeMap[i]={nodes:t.nodes,box:r}}getOctreeList(e){return this.nodeMap[e].nodes}getNodeByIndex(e,t){const i=this.reader,r=i.getNodeByIndex(t);return{node:r,boudingBox:i.getNodeBBoxByIndex(r.bboxId)}}holdNode(e,t){const i=`${e.tileId}_${e.nodeId}`;void 0===t[e.userId]?t[e.userId]=[i]:t[e.userId].push(i)}}r.Workers.SearchTreeV2Parser=e}(),r.Workers.WireframeMaterialManager=class{constructor(){this.defaultWireframeColor=r.MaterialUtil.DefaultWireframeColor,this.wireframeMaterial=new r.MeshBasicClipMaterial(this.defaultWireframeColor),this.wireframeMaterial.transparent=!0,this.instanceWireframeMaterial=r.MaterialUtil.createInstanceMaterial(r.MaterialUtil.getMaterialParameters(this.wireframeMaterial)),this.instanceWireframeMaterial.transparent=!0}destroy(){this.defaultWireframeColor=void 0,this.wireframeMaterial=void 0,this.instanceWireframeMaterial=void 0}getWireframeMaterial(){return this.wireframeMaterial}getInstanceWireframeMaterial(){return this.instanceWireframeMaterial}setWireframeColor(e,t){this.wireframeMaterial.color=e,this.wireframeMaterial.opacity=t,this.wireframeMaterial.transparent=1!=t,this.instanceWireframeMaterial.color=e,this.instanceWireframeMaterial.opacity=t,this.instanceWireframeMaterial.transparent=1!=t}getWireframeColor(){let e=this.wireframeMaterial.color.clone();return e.opacity=this.wireframeMaterial.opacity,e}restoreWireframeColor(){const e=this.defaultWireframeColor;this.setWireframeColor(e.color,e.opacity)}},function(){const e=Object.freeze({TT_UNKNOW:0,TT_DIFFUSE:1,TT_BUMP:2,TT_SPECULAR:3,TT_ALPHA:4,TT_EMISSIVE:5,TT_RELIEF:6,TT_ENVIRONMENT:7,TT_LIGHT:8});class t extends r.BimTileMaterialManager{constructor(e){super(e),this.textureManager=this.viewer.TextureManager,this.wireframeMaterialManager=new r.Workers.WireframeMaterialManager,this.materialParser=new r.Workers.MaterialParser}destroy(){this.textureManager=void 0,this.wireframeMaterialManager.destroy(),this.wireframeMaterialManager=void 0,this.materialParser.destroy(),this.materialParser=void 0,super.destroy()}getMaterialParser(){return this.materialParser}dealMaterialParm(e){e.transparent=!(e.opacity>1-r.TilesUtil.TWO_ACCURACY),e.side=0===e.doubleSide?THREE.FrontSide:THREE.DoubleSide,e.originMetalness=e.metalness,e.originRoughness=e.roughness,e.receiveIBL=0!=e.receiveIbl,e.light=!0!==e.hasLightMap,delete e.hasLightMap,e.hasOwnProperty("textureIds")&&delete e.textureIds,e.hasOwnProperty("customData")&&delete e.customData}_createMaterial(e,t,i,a,n){const s=i.receiveIBL&&r.GlobalData.IBL,o=n?r.MaterialUtil.createInstanceMaterial(i,!0,s):r.MaterialUtil.createStandardMaterial(i,s);o.name=t,this.dealMaterialDefines(o);for(let e in this.settingMaterialPara)this._isIBLParams(e)&&!i.receiveIBL||o.hasOwnProperty(e)&&(o[e]=this.settingMaterialPara[e],void 0!==o.refreshUniforms&&o.refreshUniforms());if(this._updateMaterialPartlProps(e,o),this.materialMap[t]=o,n){const e=r.MaterialUtil.getMaterialParameters(o);let i=r.MaterialUtil.createInstanceMaterial(e,!0);i.transparent=!o.transparent,i.defines.INSTANCE_STATE_SECONDARY="",this.dealMaterialDefines(i),r.MaterialUtil.setCompressParm(i,a);const n=t+"_second";this.materialMap[n]=i}return r.Utils.isDefined(a.uvCenter)&&(o.uvCenter=a.uvCenter,o.uvHalfExtent=a.uvHalfExtent),r.MaterialUtil.setCompressParm(o,a),o}generateMaterialName(e,t,i){return`${-1===t?-1:`${e}_${t}`}_${i?"instance":"standard"}`}getDefaultMaterial(e,t,i){if(!i){const i=r.MaterialUtil.getDefaultStandardMaterial();return r.MaterialUtil.setCompressParm(i,t),this.dealMaterialDefines(i),i.name=e,this.materialMap[e]=i,i}const a=r.MaterialUtil.getDefaultInstanceMaterial();r.MaterialUtil.setCompressParm(a,t),this.dealMaterialDefines(a),a.name=e,this.materialMap[e]=a;const n=a.clone();n.transparent=!0,n.defines.INSTANCE_STATE_SECONDARY="",r.MaterialUtil.setCompressParm(n,t);const s=e+"_second";return this.materialMap[s]=n,a}_updateMaterialPartlProps(e,t){t.srcOpacity=t.opacity,null!=this.materialsOpacity&&(t.opacity=t.srcOpacity*this.materialsOpacity,t.transparent=!(t.opacity>1-r.TilesUtil.TWO_ACCURACY)),e.localClippingMode&&(t.clippingPlanes=e.localClippingPlanes,t.innerClipping=e.innerClippingMode,t.orthoViewProjMatrix.copy(e.innerClippingMatrix))}getLineMaterial(e,t){const{materialId:i,materialBlockId:a,vertexColors:n}=t,s=`${a}_${i}_line`;let o=this.materialMap[s];if(r.Utils.isDefined(o))return o._referenceCount++,Promise.resolve(o);const l=this.materialParser.getMaterialParm(a,i);return o=new r.LineBasicMaterial({linewidth:1}),this._updateMaterialPartlProps(e,o),o._imageByteSize=0,o._referenceCount=1,o.vertexColors=!!n,o.color.setHex(l.color),o.needsUpdate=!0,this.materialMap[s]=o,Promise.resolve(o)}getMaterial(e,t,i,a){const{materialId:n,materialBlockId:s,vertexColors:o,hasLightMap:l}=i,d=this.generateMaterialName(s,n,a);let h;if(-1===n)return h=this.getDefaultMaterial(d,i,a),Promise.resolve(h);if(h=this.getMaterialByName(d),r.Utils.isDefined(h))return Promise.resolve(h);let c=r.Utils.clone(this.materialParser.getMaterialParm(s,n),!0);return c.vertexColors=o,c.hasLightMap=l,this.dealMaterialParm(c),h=this._createMaterial(e,d,c,i,a),this._createTexture(t,h,s,n)}_createTexture(t,i,a,n){const s=this.textureManager,o=this.materialParser.getTextureIdsByMaterialId(a,n);if(!o)return Promise.resolve(i);const l=[];for(let i=0,d=o.length;i<d;++i){const d=o[i],h=this.materialParser.getTextureParm(a,d);if(!r.Utils.isDefined(h)||h.image<0)continue;const c=this.materialParser.getImageParm(a,h.image);if(!r.Utils.isDefined(c))continue;const u=h.alpha>0?e.TT_ALPHA:h.type,p=c.type;let m=h.name||`${a}_${n}`;if(c.url){const e=`${t}${c.url}`;m=r.Utils.getEncodedString(e+m);const i=new Promise(((t,i)=>{s.getTextureFromURL(e,m,{textureParm:h,imageType:p,fromWorker:true}).then((e=>{t({textureType:u,texture:e})})).catch((e=>{i(e)}))}));l.push(i)}else if(c.bufferId>=0){const e=this._getImageBuffer(c),t=new Promise(((t,i)=>{s.getTextureFromBuffer(e,m,{textureParm:h,imageType:p,fromWorker:true}).then((e=>{t({textureType:u,texture:e})})).catch((e=>{i(e)}))}));l.push(t)}}return 0===l.length?Promise.resolve().then((()=>i)):Promise.all(l).then((e=>(e.forEach((e=>{this._setTexture(i,e.textureType,e.texture)})),i)))}_setTexture(t,i,a){const n=r.MaterialUtil.getImageByteSize(a.image);switch(t._imageByteSize+=n,i){case e.TT_DIFFUSE:t.map=a;break;case e.TT_SPECULAR:t.specularMap=a;break;case e.TT_EMISSIVE:t.emissiveMap=a;break;case e.TT_ENVIRONMENT:t.envMap=a;break;case e.TT_ALPHA:t.useAlphaMap=!0,t.map=a,t.transparent=!0,t.alphaTest=.01;break;case e.TT_RELIEF:case e.TT_BUMP:t.bumpMap=a,t.bumpScale=a.bumpScale;break;case e.TT_LIGHT:t.lightMap=a,t.defines.USE_COMPONENT_LIGHTMAP="",t.lightMapIntensity=r.GlobalData.LightmapIntensity}if(t.refreshUniforms(),t.needsUpdate=!0,""===t.defines.USE_INSTANCE){const e=t.name+"_second";let r=this.materialMap[e];if(!r)return;a._referenceCount++,this._setTexture(r,i,a)}}_getImageBuffer(e){return e.imageBuffer}getWireframeMaterialManager(){return this.wireframeMaterialManager}}r.Workers.MaterialManager=t}(),r.Workers.MaterialParser=class{constructor(){this.materialDataMap={}}destroy(){this.materialDataMap=void 0}update(e,t){const i=e.materialDataMap;t?Object.keys(i).forEach((e=>{this.materialDataMap[e]=i[e]})):this.materialDataMap=i}_getMaterialBlock(e){return this.materialDataMap[e]}getTextureIdsByMaterialId(e,t){return this._getMaterialBlock(e).materials[t].textureIds}getMaterialParm(e,t){return this._getMaterialBlock(e).materials[t]}getTextureParm(e,t){return this._getMaterialBlock(e).textures[t]}getImageParm(e,t){return this._getMaterialBlock(e).images[t]}},function(){class e extends r.Workers.DataParser{constructor(){super(),this.userIdInfoMap={},this.userIdMap={},this.userIdIndexMap={}}destroy(){this.userIdInfoMap=void 0,this.userIdMap=void 0,this.userIdIndexMap=void 0,super.destroy()}clear(){this.userIdInfoMap={},super.clear()}update(e){const t=JSON.parse(e.data),i=t.userIdInfoMap;for(const e in i)this.userIdInfoMap[e]=i[e];const r=t.userIdMap;for(const e in r)this.userIdMap[e]=r[e];const a=t.userIdIndexMap;for(const e in a)this.userIdIndexMap[e]=a[e]}getUserIdByIndex(e){return this.userIdMap[e]}getIndexByUserId(e){return this.userIdIndexMap[e]}traverse(e){const t=this.userIdInfoMap;Object.keys(t).forEach((i=>{const r=t[i];e(r)}))}}r.Workers.UserIdParser=e}(),function(){class e extends r.Workers.DataParser{constructor(){super(),this.userDataKeyMap={},this.userDataKeys={},this.userDataValueMap={},this.userDataValues={},this.userDataItems={},this.blockIds=[]}destroy(){this.userDataKeyMap=void 0,this.userDataKeys=void 0,this.userDataValueMap=void 0,this.userDataValues=void 0,this.userDataItems=void 0,this.blockIds=void 0,super.destroy()}update(e){const t=JSON.parse(e.data);this.userDataKeyMap=t.userDataKeyMap,this.userDataKeys=t.userDataKeys,this.userDataValueMap=t.userDataValueMap,this.userDataValues=t.userDataValues,this.userDataItems=t.userDataItems,this.blockIds=Object.keys(t.userDataKeyMap)}getUserDataKeyMap(){const e=this.blockIds[0];return this.userDataKeyMap[e]}getUserDataValueMap(){const e=this.blockIds[0];return this.userDataValueMap[e]}getUserDataKeys(){const e=this.blockIds[0];return this.userDataKeys[e]}getUserDataValues(){const e=this.blockIds[0];return this.userDataValues[e]}getUserDataItems(){const e=this.blockIds[0];return this.userDataItems[e]}getUserDataIndexMapByString(e,t){const i=this.getUserDataKeyMap(),r=this.getUserDataValueMap();if(!i||!r)return;const a=i[e];let n;return t instanceof Array?(n=[],t.forEach((e=>{void 0!==r[e]&&n.push(r[e])}))):n=r[t],{key:a,value:n}}getUserDataStringMapByIndex(e,t){const i=this.getUserDataKeys(),r=this.getUserDataValues();return[i[e],r[t]]}getUserDataByIndex(e){return this.getUserDataById(e)}getUserDataById(e){const t=this.getUserDataItems();if(t)return t[e]}}r.Workers.UserDataParser=e}(),function(){class e extends r.Workers.DataParser{constructor(){super(),this.tileIdMap={},this.tileIds={},this.blockIds=[]}destroy(){this.tileIdMap=void 0,this.tileIds=void 0,this.blockIds=void 0,super.destroy()}clear(){this.tileIdMap={},this.tileIds={},this.blockIds=[],super.clear()}update(e){const t=JSON.parse(e.data);this.tileIdMap=t.tileIdMap,this.tileIds=t.tileIds,this.blockIds=Object.keys(t.tileIdMap)}getTilePath(e){const t=this.blockIds;for(let i=0,r=t.length;i<r;++i){const r=t[i],a=this.tileIds[r][e];if(a)return a}}isInstanceTile(e){return-1!==this.getTilePath(e).indexOf("instance")}}r.Workers.TileIdParser=e}(),function(){class e extends r.Workers.DataParser{constructor(){super()}clear(){this.clearUrls()}update(e){const t=e.data.nodes,i=e.params.element.startPos;t.forEach(((e,t)=>{const r=i+t;this.nodeMap[r]=e}))}getNode(e){return this.nodeMap[e]}traverse(e){const t=this.nodeMap;Object.keys(t).forEach((i=>{e(t[i])}))}}r.Workers.NodeIdParser=e}(),function(){class e extends r.Workers.DataParser{constructor(){super()}clear(){this.clearUrls()}update(e){const t=e.data.nodes,i=e.params.element.startPos;t.forEach(((e,t)=>{const r=i+t;this.nodeMap[r]=Array.from(e)}))}getNode(e){return this.nodeMap[e]}}r.Workers.NodeBoxParser=e}(),function(){class e extends r.Workers.DataParser{constructor(){super(),this.rootViewNode=void 0}destroy(){this.rootViewNode=void 0,super.destroy()}update(e){const t=e.data.nodes[0];let i={};const a=t.viewNodes,n=t.geometryErrors;for(let e=0;e<a.length;e++){const t=a[e],s=t.nodeId,o=t.parentId,l=new r.BimTileViewNode(s,i[o]);l.geometricError=n[l.depth],l.boundingBox=r.TilesUtil.getBox(Array.from(t.bbox)),l.tileIds=t.tileIds,i[s]=l,0==e&&(this.rootViewNode=l)}i=void 0}getRoot(){return this.rootViewNode}}r.Workers.ViewTreeParser=e}(),function(){class e extends r.Workers.DataParser{constructor(){super(),this.userdataIdMap={},this.userIdMap={},this.userIdIndexMap={}}destroy(){this.userdataIdMap=void 0,this.userIdMap=void 0,this.userIdIndexMap=void 0,super.destroy()}clear(){this.userdataIdMap={},super.clear()}update(e){const t=JSON.parse(e.data),i=t.userIdMap,r=t.userdataIdMap;for(const e in i)this.userIdMap[e]=i[e],this.userdataIdMap[e]=r[e];const a=t.userIdIndexMap;for(const e in a)this.userIdIndexMap[e]=a[e]}getUserIdByIndex(e){return this.userIdMap[e]}getIndexByUserId(e){return this.userIdIndexMap[e]}getUserdataIdByIndex(e){return this.userdataIdMap[e]}}r.Workers.UserIdV2Parser=e}(),function(){class e{constructor(){this._refCount=0,this._id=null,this._state=r.SharedGeometryState.UNLOADED,this._byteLength=0,this._geometries=[]}get refCount(){return this._refCount}set refCount(e){this._refCount=e}get id(){return this._id}set id(e){this._id=e}get byteLength(){return this._byteLength}set byteLength(e){this._byteLength=e}get state(){return this._state}set state(e){this._state=e}ref(){++this._refCount}unRef(){--this._refCount}addGeometry(e){this._geometries.push(e)}getGeometryCount(){return this._geometries.length}getGeometry(e){return this._geometries[e]}getNodeInfo(e){return this._geometries[e]?this._geometries[e].nodeInfo:void 0}getGeometryInfo(e){return this._geometries[e]?this._geometries[e].geometry:void 0}contentProcessing(){return this._state===r.SharedGeometryState.PROCESSING}contentUnloaded(){return this._state===r.SharedGeometryState.UNLOADED}destroy(){this._state=r.SharedGeometryState.DESTROYED,this._id=null,this._geometries=null}}r.Workers.SharedGeometry=e,r.Workers.SharedGeometryManager=class{constructor(){this._geometryMap={}}destroy(){for(const e in this._geometryMap)if(Object.hasOwnProperty.call(this._geometryMap,e)){this._geometryMap[e].destroy(),delete this._geometryMap[e]}this._geometryMap=null}setGeometryByteLength(e,t){let i=this._geometryMap[e];r.Utils.defined(i)&&(i.byteLength=t)}createGeometryById(t){let i=this._geometryMap[t];return r.Utils.defined(i)||(i=this._geometryMap[t]=new e,i.id=t),i}disposeGeometry(e){const t=this.getGeometryById(e);return!!r.Utils.defined(t)&&(!t.contentUnloaded&&!t.contentProcessing&&(t.unRef(),0===t.refCount&&(t.destroy(),delete this._geometryMap[e],!0)))}getGeometryById(e){return this._geometryMap[e]}}}(),r.Workers.BatchedOutlineBuilder=class{constructor(e){this._meshBuilder=e}destroy(){this._meshBuilder=void 0}build(e,t){this._setWireFrameVisibility(e);const i=t.parsedData[r.Workers.TileBlockType.BT_LINE].nodes;0!==i.length&&i.forEach((t=>{this._createMesh(e,t)}))}_setWireFrameVisibility(e){const t=e._tile,i=t._loader;t.wireFrameVisibilityOption=i.wireFrameVisibilityOption}_createMesh(e,t){const i=e.outlineMeshes,a=e._tile,n=a._loader,s=this._getNodeInfo(a,t.nodeInfo),o=this._createGeometry(t.geometry,s),l=this._getMaterial(n),d=new r.LineSegmentsEx(o,[l]);d.applyMatrix4(s.matrix),d.name=s.nodeId,d.tileId=s.tileId,d.indexGroups=s.indexInfos,d.databagId=i.databagId,d.fileId=i.fileId,d.renderOrder=r.EnumRenderOrder.WireFrame,i.add(d),n.addLineNodeById(d.tileId,s.nodeId,d),n.dealLineMeshVisible(d)}_getMaterial(e){return e.materialManager.getWireframeMaterialManager().getWireframeMaterial()}_getNodeInfo(e,t){if(r.Utils.isDefined(e.contentId)){t.tileId=e.contentId;const i=t.nodeId.split("_");i[0]=e.contentId,t.nodeId=i.join("_")}const i=`outline_${t.nodeId}`;t.nodeId=i;const a=`outline_${t.tileId}`;t.tileId=a;const n=e._loader;let s=n.pbfNodeInfoMap[i];return s||(this._updateParsedNodeInfo(e,t),this._addUserIdMapIndices(n,i,t.userIdMapIndex),n.pbfNodeInfoMap[i]=t,t)}_addUserIdMapIndices(e,t,i){this._meshBuilder._addUserIdMapIndices(e,t,i)}_updateParsedNodeInfo(e,t){this._meshBuilder._updateParsedNodeInfo(e,t)}_createGeometry(e,t){return this._meshBuilder._createGeometry(e,t)}},function(){function e(e,t){const i=new Float32Array(e);return i.fill(t),{array:i,itemSize:1,normalized:!1,meshPerAttribute:1}}function t(e,t){const i=new Float32Array(4*e);let r=0;for(let a=0;a<e;++a)i[r++]=t.r,i[r++]=t.g,i[r++]=t.b,i[r++]=void 0!==t.opacity?t.opacity:1;return{array:i,itemSize:4,normalized:!1,meshPerAttribute:1}}function i(e,t){const i=new Float32Array(e);return i.fill(t),{array:i,itemSize:1,normalized:!1,meshPerAttribute:1}}function a(e,t){const i=e.length,a=[],n=3*i;for(let e=0;e<4;++e){const t=new Float32Array(n);a.push({name:`mcol${e}`,array:t,itemSize:3,normalized:!1,meshPerAttribute:1})}let s=new Array(a.length);s.fill(0);let o=r.Utils.scratchMatrix4_1;for(let r=0;r<i;++r){o.copy(e[r].entityMatrix),t&&o.multiply(t);const i=o.elements;a.forEach(((e,t)=>{const r=e.array;r[s[t]++]=i[0+4*t],r[s[t]++]=i[1+4*t],r[s[t]++]=i[2+4*t]}))}return a}r.Workers.InstancedOutlineBuilder=class{constructor(e){this._meshBuilder=e}destroy(){this._meshBuilder=void 0}build(e,t){this._setWireFrameVisibility(e);const i=e._tile,a=this._getInstanceInfos(i);if(0===a.length)return;const n=t?t.parsedData[r.Workers.TileBlockType.BT_LINE].nodes:void 0,s=this._getGeometries(e,n);0!==s.length&&this._parseMeshes(e,a,s)}_setWireFrameVisibility(e){const t=e._tile,i=t._loader;t.wireFrameVisibilityOption=i.wireFrameVisibilityOption}_getInstanceInfos(e){return e.instanceInfos}_getGeometries(e,t){const i=e._getSharedGeometry(),r=[];if(t&&t.length){const a=e._tile;for(let e=0,n=t.length;e<n;++e){const n=t[e],s=this._getGeometryInfo(a,n,e);i.addGeometry(s),r.push(s)}}else for(let e=0,t=i.getGeometryCount();e<t;++e){const t=i.getGeometry(e);r.push(t)}return r}_parseMeshes(e,t,i){const r=[];for(let a=0,n=t.length;a<n;++a){const n=t[a],s=i[a],o=this._createMesh(e,n,s);r.push(o)}return r}_createMesh(e,t,i){const a=e.outlineMeshes,n=e._tile,s=n._loader,o=t.nodeId,l=i.blockId,d=i.nodeInfo,h=i.geometry,c=this._createInstanceAttributes(n,t,d.matrix),u=this._createGeometry(h,c),p=this._getMaterial(s);let m=new r.LineSegmentsEx(u,p);m.name=o,m.tileId=`outline_${n.contentId}`,m.frustumCulled=!1,m.isInstanceMeshNode=!0,m.blockId=l,m.visible=!s.disableUserData&&s.isBorderLineVisible(),m.renderOrder=r.EnumRenderOrder.WireFrame,m.databagId=a.databagId,m.fileId=a.fileId,m.applyMatrix4(t.modelMatrix),a.add(m),s.addInstanceLineNodeById(m.tileId,m)}_createGeometry(e,t){const i=new THREE.InstancedBufferGeometry;return e.index&&i.setIndex(e.index),e.attributes.forEach((e=>{i.setAttribute(e.name,e.attribute)})),this._createCustomAttributes(i,t),i}_createInstanceAttributes(n,s,o){const l=n._loader,d=s.entityInfoArray,h=d.length,c=[];c.push({name:"mcols",attribute:a(d,o)});const u=r.MaterialUtil.DefaultWireframeColor;c.push({name:"aColor",attribute:t(h,{r:u.color.r,g:u.color.g,b:u.color.b,opacity:u.opacity})});const p=r.TilesUtil.matchWireFrameVisibilityOption(d[0].userId,n.wireFrameVisibilityOption)?r.EnumInstanceState.NONE:r.EnumInstanceState.HIDDEN;c.push({name:"vState",attribute:e(h,p)});const m=l.filter.model.localClippingMode?r.EnumInstanceState.CLIPPING:r.EnumInstanceState.NONE;return c.push({name:"vClipping",attribute:i(h,m)}),c}_getMaterial(e){return e.materialManager.getWireframeMaterialManager().getInstanceWireframeMaterial()}_getGeometryInfo(e,t,i){return this._meshBuilder._getGeometryInfo(e,t,i)}_createCustomAttributes(e,t){this._meshBuilder._createCustomAttributes(e,t)}}}(),r.Workers.BatchedMeshBuilder=class{constructor(){}destroy(){}build(e,t){let i=[],a=[];const n=r.Workers.TileBlockType;return t.forEach((e=>{const t=e.parsedData;Object.keys(t).forEach((e=>{const r=t[e],s=Number(e);s===n.BT_LINE||s===n.BT_MESH?i.push(...r.nodes):s===n.BT_MATERIAL&&a.push(r)}))})),a.length&&this._parseMaterials(e,a),this._parseMeshes(e,i)}_parseMaterials(e,t){e._loader.materialManager.getMaterialParser().update(t,!0)}_parseMeshes(e,t){if(0===t.length)return null;const i=[];return t.forEach((t=>{const r=this._createMesh(e,t);i.push(r)})),i}_getNodeInfo(e,t){const i=e._loader,r=t.nodeId;let a=i.pbfNodeInfoMap[r];return a||(this._updateParsedNodeInfo(e,t),i.pbfNodeInfoMap[r]=t,this._addUserIdMapIndices(i,r,t.userIdMapIndex),this._updateMeshNodeInfo(e,i,t),t)}_updateParsedNodeInfo(e,t){let i=new THREE.Matrix4;t.matrix&&i.fromArray(t.matrix),i.multiply(e.matrix),t.matrix=i,t.uvCenter&&(t.uvCenter=(new THREE.Vector2).fromArray(t.uvCenter),t.uvHalfExtent=(new THREE.Vector2).fromArray(t.uvHalfExtent))}_createGeometry(e,t){const i=new THREE.BufferGeometry;return i.groups.push({start:t.indexStart,count:t.indexCount,materialIndex:0}),e.index&&i.setIndex(new THREE.BufferAttribute(e.index.array,1)),e.attributes.forEach((e=>{i.setAttribute(e.name,new THREE.BufferAttribute(e.array,e.itemSize,e.normalized))})),i}_updateMeshNodeInfo(e,t,i){const r=i.indexInfos,a=t.materialManager.generateMaterialName(i.materialBlockId,i.materialId);for(const n of r.keys()){e.userIndexMap.set(n,!0);const s=r.get(n);for(const e of s.keys()){const r={parent:i.nodeId,matrix:i.matrix,materialId:a};t.disableUserData?t.addNoUserDataMeshNodeInfo(n,e,r):t.patchMeshNodeInfo(n,e,r)}}}_addToMeshIdMap(e,t,i){e.addMeshIdMap(t,i)}_addUserIdMapIndices(e,t,i){i&&e.addUserIdMapIndices(i,t)}_addGeometryById(e,t){e._tileset.geometryManager.addGeometryById(e.nodeId,t)}_createMesh(e,t){return new Promise(((i,a)=>{const n=this._getNodeInfo(e,t.nodeInfo),s=this._createGeometry(t.geometry,n),o=e._loader,l=e.content.meshes,d=n.nodeId,h=n.primitiveMode===r.Workers.PrimitiveMode.PM_LINES,c=h?r.LineSegmentsEx:r.MeshEx;this._getMaterial(o,n,h).then((e=>{const t=new c(s,[e]);if(t.name=d,t.indexGroups=n.indexInfos,t.indexCount=s.index.count,t.databagId=l.databagId,t.fileId=l.fileId,t.applyMatrix4(n.matrix),r.GlobalData.EnableShadowMap){const e=o.filter.model;t.castShadow=e.castShadow,t.receiveShadow=e.receiveShadow}l.add(t),this._addToMeshIdMap(o,d,t),i()})).catch((e=>{a(e)}))}))}_getMaterial(e,t,i){const r=e.filter.model,a=e.materialManager,n={materialBlockId:t.materialBlockId,materialId:t.materialId,uvCenter:t.uvCenter,uvHalfExtent:t.uvHalfExtent,vertexColors:t.vertexColors,useCompressedNormal:t.useCompressedNormal,useCompressedColor:t.useCompressedColor,useCompressedUv:t.useCompressedUv,hasLightMap:t.hasLightMap};return i?a.getLineMaterial(r,n):a.getMaterial(r,e.rootUrl,n,!1)}},r.Workers.InstancedMeshBuilder=class{constructor(){}destroy(){}build(e,t){let i=[],a=[],n=[];const s=r.Workers.TileBlockType;t.forEach((e=>{const t=e.parsedData;Object.keys(t).forEach((e=>{const r=t[e],o=Number(e);o===s.BT_LINE||o===s.BT_MESH?a.push(...r.nodes):o===s.BT_INSTANCE?i.push(...r.nodes):o===s.BT_MATERIAL&&n.push(r)}))}));const o=this._parseInstances(e,i);if(0===o.length)return null;this._holdInstanceNodeInfos(e,o);const l=this._parseGeometries(e,a);return 0===l.length?null:(n.length&&this._parseMaterials(e,n),this._parseMeshes(e,o,l))}_holdInstanceNodeInfos(e,t){e.instanceInfos=[],t.forEach((t=>{e.instanceInfos.push(t.nodeInfo)})),e.instanceInfo=e.instanceInfos[0],e.nodeIndexId=e.instanceInfo.nodeId}_parseInstances(e,t){const i=[];for(let r=0,a=t.length;r<a;++r){const a=t[r],n=this._getInstanceInfo(e,a);i.push(n)}return i}_parseGeometries(e,t){const i=e._getSharedGeometry(),r=[];if(t.length)for(let a=0,n=t.length;a<n;++a){const n=t[a],s=this._getGeometryInfo(e,n,a);i.addGeometry(s),r.push(s)}else for(let e=0,t=i.getGeometryCount();e<t;++e){const t=i.getGeometry(e);r.push(t)}return r}_parseMaterials(e,t){const i=e._loader.materialManager.getMaterialParser();t.forEach((e=>{i.update(e,!0)}))}_parseMeshes(e,t,i){const r=[];for(let a=0,n=t.length;a<n;++a){const n=t[a],s=i[a],o=this._createMesh(e,n,s);r.push(o)}return r}_createMesh(e,t,i){return new Promise(((a,n)=>{const s=t.nodeInfo,o=t.geometry,l=i.blockId,d=i.nodeInfo,h=i.geometry,c=this._createGeometry(d,h,o);t.geometry=void 0;const u=e._loader,p=e.content.meshes,m=s.nodeId;let f=(new THREE.Matrix4).copy(e.matrix);s.rootMatrix&&f.multiply(s.rootMatrix),s.modelMatrix=f;const g=d.primitiveMode===r.Workers.PrimitiveMode.PM_LINES?r.LineSegmentsEx:r.MeshEx;this._getMaterial(u,d).then((t=>{const i=t[0];this._updateCustomAttributeBuffer(i,d.matrix,s.entityInfoArray,o,u);const n=new g(c,t);if(n.frustumCulled=!1,n.isInstanceMeshNode=!0,n.blockId=l,n.name=m,n.databagId=e.content.meshes.databagId,n.fileId=e.content.meshes.fileId,n.indexGroups=d.indexInfos,n.indexCount=d.indexCount,n.matrixRoot=d.matrix,n.applyMatrix4(f),r.GlobalData.EnableShadowMap){const t=e._loader.filter.model;n.customDepthMaterial=t.manager.getInstanceDepthMaterial(),n.castShadow=t.castShadow,n.receiveShadow=t.receiveShadow}p.add(n),this._addToMeshIdMap(u,m,l,n,f),a()})).catch((e=>{n(e)}))}))}_getGeometryInfo(e,t,i){let r=t.nodeInfo,a=new THREE.Matrix4;r.matrix&&a.fromArray(r.matrix),r.matrix=a,r.uvCenter&&(r.uvCenter=(new THREE.Vector2).fromArray(r.uvCenter),r.uvHalfExtent=(new THREE.Vector2).fromArray(r.uvHalfExtent));const n=t.geometry,s={attributes:[]};return n.index&&(s.index=new THREE.BufferAttribute(n.index.array,1)),n.attributes.forEach((e=>{s.attributes.push({name:e.name,attribute:new THREE.BufferAttribute(e.array,e.itemSize,e.normalized)})})),{blockId:i,nodeInfo:r,geometry:s}}_getInstanceInfo(e,t){const i=e._loader,r=t.geometry.attributes,a=t.nodeInfo,n=a.nodeId,s=i.pbfNodeInfoMap[n];if(s)return{nodeInfo:s,geometry:r};a.rootMatrix=(new THREE.Matrix4).fromArray(a.rootMatrix);const o=i.tileReader.userDataParser,l=a.entityInfoArray;return l.forEach(((t,r)=>{t.userData=o.getUserDataById(t.userDataID),t.entityMatrix=(new THREE.Matrix4).fromArray(t.entityMatrix),e.userIndexMap.set(t.userID,!0),this._updateInstanceNodeInfo(i,t,n,r)})),this._addToInstanceInfoMap(i,n,l),i.pbfNodeInfoMap[n]=a,{nodeInfo:a,geometry:r}}_createGeometry(e,t,i){const r=new THREE.InstancedBufferGeometry;return r.groups.push({start:e.indexStart,count:e.indexCount,materialIndex:0}),r.groups.push({start:e.indexStart,count:e.indexCount,materialIndex:1}),t.index&&r.setIndex(t.index),t.attributes.forEach((e=>{"color"!==e.name&&r.setAttribute(e.name,e.attribute)})),this._createCustomAttributes(r,i),r}_createCustomAttributes(e,t){t.forEach((t=>{if(Array.isArray(t.attribute))t.attribute.forEach((t=>{e.setAttribute(t.name,new THREE.InstancedBufferAttribute(t.array,t.itemSize,t.normalized,t.meshPerAttribute))}));else{const i=t.attribute;e.setAttribute(t.name,new THREE.InstancedBufferAttribute(i.array,i.itemSize,i.normalized,i.meshPerAttribute))}}))}_getMaterial(e,t){const i=e.filter.model,r=e.materialManager,a={materialBlockId:t.materialBlockId,materialId:t.materialId,uvCenter:t.uvCenter,uvHalfExtent:t.uvHalfExtent,vertexColors:t.vertexColors,useCompressedNormal:t.useCompressedNormal,useCompressedColor:t.useCompressedColor,useCompressedUv:t.useCompressedUv,hasLightMap:t.hasLightMap};return r.getMaterial(i,e.rootUrl,a,!0).then((e=>{const t=e.name+"_second";return[e,r.getMaterialByName(t)]}))}_addToMeshIdMap(e,t,i,r,a){e.addInstanceMeshIdMap(t,i,r,a)}_addToInstanceInfoMap(e,t,i){e.addInstanceInfo(t,i)}_updateInstanceNodeInfo(e,t,i,r){const a=t.userID,n={bufferId:i,instanceIndex:r,entityMatrix:t.entityMatrix};e.disableUserData?e.addNoUserDataInstanceNodeInfo(a,i,n):e.patchInstanceNodeInfo(a,i,n)}_updateCustomAttributeBuffer(e,t,i,a,n){const s=n.filter.model.localClippingMode?r.EnumInstanceState.CLIPPING:r.EnumInstanceState.NONE,o=i.length;a.forEach((a=>{if("mcols"===a.name){let e=new Array(a.attribute.length);e.fill(0);for(let n=0;n<o;++n){let s=r.Utils.scratchMatrix4_1.copy(i[n].entityMatrix);if(t){let e=r.Utils.scratchMatrix4_2.copy(t);s=s.multiply(e)}const o=s.elements;a.attribute.forEach(((t,i)=>{const r=t.array;r[e[i]++]=o[0+4*i],r[e[i]++]=o[1+4*i],r[e[i]++]=o[2+4*i]}))}}else if("muvCols"===a.name);else if("aColor"===a.name){const t=a.attribute.array,i=e.color;let r=0;for(let e=0;e<o;++e)t[r++]=i.r,t[r++]=i.g,t[r++]=i.b,t[r++]=void 0!==i.opacity?i.opacity:1}else"vClipping"===a.name&&0!==s&&a.attribute.array.fill(s)}))}},function(){class e extends r.BimTileFilterManager{constructor(e){super(e),this.objectInfoManager=new r.BimtileObjectInfoManager}}r.Workers.TilesFilterManager=e}(),function(){const e=Object.freeze({DT_INVALID:0,DT_INT8:1,DT_UINT8:2,DT_INT16:3,DT_UINT16:4,DT_INT32:5,DT_UINT32:6,DT_INT64:7,DT_UINT64:8,DT_FLOAT32:9,DT_FLOAT64:10,DT_BOOL:11,DT_TYPES_COUNT:12}),t=Object.freeze({NT_UNKNOW_NODE:0,NT_COMMON_NODE:1,NT_BATCHED_MAIN_NODE:2,NT_BATCHED_SUB_NODE:3}),i=Object.freeze({PM_POINTS:0,PM_LINES:1,PM_LINE_STRIP:2,PM_TRIANGLES:3,PM_TRIANGLE_STRIP:4,PM_TRIANGLE_FAN:5}),a=Object.freeze({BT_UNKNOWN:0,BT_MESH:1,BT_LINE:2,BT_POINT:3,BT_SYMBOL:4,BT_INSTANCE:5,BT_INDEX:6,BT_BUFFER:7,BT_MATERIAL:8,BT_USERDATA:9,BT_USERID:10,BT_TILEID:11,BT_VIEWTREE:12,BT_NODEID:13,BT_NODEBOX:14});r.Workers.DataType=e,r.Workers.NodeType=t,r.Workers.PrimitiveMode=i,r.Workers.TileBlockType=a}(),function(){r.Loader=r.Loader||{};class e extends THREE.Loader{constructor(e){super(e),this._decoderPath="",this._decoderConfig={},this._decoderBinary=null,this._decoderPending=null,this._workerLimit=4,this._workerPool=[],this._workerNextTaskID=1,this._workerSourceURL="",this._defaultAttributeIDs={position:"GAT_POSITION",normal:"GAT_NORMAL",color:"GAT_COLOR",uv:"GAT_TEX_COORD",uv2:"GAT_TEX_COORD2"},this._defaultAttributeTypes={position:"Float32Array",normal:"Float32Array",color:"Float32Array",uv:"Float32Array",uv2:"Float32Array"}}dispose(){for(let e=0,t=this._workerPool.length;e<t;++e)this._workerPool[e].terminate();return this._workerPool.length=0,this}setDecoderPath(e){return this._decoderPath=e,this}setDecoderConfig(e){return this._decoderConfig=e,this}setWorkerLimit(e){return this._workerLimit=e,this}load(e,t,i,r){const a=new THREE.FileLoader(this.manager);a.setPath(this.path),a.setResponseType("arraybuffer"),this.crossOrigin&&a.setWithCredentials(!0),a.load(e,(e=>{const i={attributeIDs:this._defaultAttributeIDs,attributeTypes:this._defaultAttributeTypes,useUniqueIDs:!1};this.decodeDataBuffer(e,i).then(t).catch(r)}),i,r)}decodeByUrl(e,t,i,a){const n={url:e,xhr:!0,version:(t=t||{}).version,packToBuffer:!!t.packToBuffer},s=r.Utils.str2ab(e);this.decodeDataBuffer(s,n).then(i).catch(a)}decodeByBuffer(e,t,i,r){const a={url:t.url,version:t.version};this.decodeDataBuffer(e,a).then(i).catch(r)}decodeDataBuffer(t,i){const r=JSON.stringify(i);if(e.taskCache.has(t)){const i=e.taskCache.get(t);if(i.key===r)return i.promise;if(0===t.byteLength)throw new Error("CLOUD.Loader.TilesWorkerDecoder: Unable to re-decode a buffer with different settings. Buffer has already been transferred.")}let a;const n=this._workerNextTaskID++,s=t.byteLength,o=this._getWorker(n,s).then((e=>(a=e,new Promise(((e,r)=>{a._callbacks[n]={resolve:e,reject:r},a.postMessage({type:"decode",id:n,taskConfig:i,buffer:t},[t])}))))).then((e=>e.data),(e=>{console.log(e)}));return o.finally((()=>{a&&n&&this._releaseTask(a,n)})),e.taskCache.set(t,{key:r,promise:o}),o}_loadLibrary(e,t){const i=new THREE.FileLoader(this.manager);return i.setPath(this._decoderPath),i.setResponseType(t),new Promise(((t,r)=>{i.load(e,t,void 0,r)}))}_initDecoder(){if(this._decoderPending)return this._decoderPending;const t=[];return t.push(this._loadLibrary("bimtiles_decoder.js","text")),t.push(this._loadLibrary("bimtiles_decoder.wasm","arraybuffer")),this._decoderPending=Promise.all(t).then((t=>{const i=t[0];this._decoderConfig.wasmBinary=t[1];const r=e.DecoderWorker.toString(),a=[i,"",r.substring(r.indexOf("{")+1,r.lastIndexOf("}"))].join("\n");this._workerSourceURL=URL.createObjectURL(new Blob([a]))})),this._decoderPending}_getWorker(e,t){return this._initDecoder().then((()=>{if(this._workerPool.length<this._workerLimit){const e=new Worker(this._workerSourceURL);e._callbacks={},e._taskCosts={},e._taskLoad=0,e.postMessage({type:"init",decoderConfig:this._decoderConfig}),e.onmessage=function(t){const i=t.data;switch(i.type){case"decode":e._callbacks[i.id].resolve(i);break;case"error":e._callbacks[i.id].reject(i);break;default:console.error('CLOUD.Loader.TilesWorkerDecoder: Unexpected message, "'+i.type+'"')}},this._workerPool.push(e)}else this._workerPool.sort((function(e,t){return e._taskLoad>t._taskLoad?-1:1}));const i=this._workerPool[this._workerPool.length-1];return i._taskCosts[e]=t,i._taskLoad+=t,i}))}_releaseTask(e,t){e._taskLoad-=e._taskCosts[t],delete e._callbacks[t],delete e._taskCosts[t]}}e.taskCache=new WeakMap,e.DecoderWorker=function(){let e,t;function i(e,t,i,r,v){try{const y=t.packToBuffer,M=void 0===t.version?0:t.version,E=function(e,t,i,r,v){const y=t.DecodeFromArray(new Int8Array(i),i.byteLength,v);if(!y.ok())throw console.log(r.url),new Error("CLOUD.Loader.TilesWorkerDecoder: Decoding failed: "+y.error_msg());const M=t.GetBlockTypeCount();if(M<1)throw new Error("CLOUD.Loader.TilesWorkerDecoder: no blockData data.");let E=[];for(let i=0;i<M;i++){const r=t.GetBlockType(i),y=t.GetBlockCount(r,v);if(y<1)throw new Error("CLOUD.Loader.TilesWorkerDecoder: no blockData data.");let M=null;switch(r){case e.BT_LINE:case e.BT_MESH:M=a.decode(e,t,y);break;case e.BT_POINT:M=n.decode(e,t,y);break;case e.BT_INSTANCE:M=s.decode(e,t,y);break;case e.BT_INDEX:M=v===e.DV_V1?o.decode(e,t,y):f.decode(e,t,y);break;case e.BT_MATERIAL:M=l.decode(e,t,y);break;case e.BT_USERID:M=v===e.DV_V1?d.decode(e,t,y):g.decode(e,t,y);break;case e.BT_USERDATA:M=h.decode(e,t,y);break;case e.BT_TILEID:M=c.decode(e,t,y);break;case e.BT_VIEWTREE:M=u.decode(e,t,y);break;case e.BT_NODEID:M=p.decode(e,t,y);break;case e.BT_NODEBOX:M=m.decode(e,t,y);break;default:console.log("CLOUD.Loader.TilesWorkerDecoder: Unexpected blockData type.")}M&&E.push({type:r,data:M})}return E.length?E:void 0}(i,r,e,t,M),b=function(e,t,i,r){if(!t)return;let n={};t.forEach((e=>{const t=e.type,i=e.data;void 0===n[t]&&(n[t]=[]),n[t].push(i)}));const v=Object.keys(n);if(0===v.length)return;let y={};return v.forEach((t=>{const v=n[t];switch(Number(t)){case e.BT_LINE:case e.BT_MESH:parsedData=a.parse(v,r);break;case e.BT_INSTANCE:parsedData=s.parse(v,r);break;case e.BT_MATERIAL:parsedData=l.parse(v,r);break;case e.BT_USERID:i===e.DV_V1?parsedData=d.parse(v,r):parsedData=g.parse(v,r);break;case e.BT_USERDATA:parsedData=h.parse(v,r);break;case e.BT_TILEID:parsedData=c.parse(v,r);break;case e.BT_INDEX:i===e.DV_V1?parsedData=o.parse(v,r):parsedData=f.parse(v,r);break;case e.BT_VIEWTREE:parsedData=u.parse(v,r);break;case e.BT_NODEID:parsedData=p.parse(v,r);break;case e.BT_NODEBOX:parsedData=m.parse(v,r)}parsedData&&(y[t]=parsedData)})),y}(i,E,M,y),I=Date.now();if(b){const t=function(e,t,i,r){let a=[];return Object.keys(t).forEach((r=>{const n=t[r];switch(Number(r)){case e.BT_LINE:case e.BT_MESH:n.nodes.forEach((e=>{const t=e.geometry;t.attributes.forEach((e=>{a.push(e.array.buffer)})),t.index&&a.push(t.index.array.buffer)}));break;case e.BT_INSTANCE:n.nodes.forEach((e=>{e.geometry.attributes.forEach((e=>{Array.isArray(e.attribute)?e.attribute.forEach((e=>{a.push(e.array.buffer)})):a.push(e.attribute.array.buffer)}))}));break;case e.BT_MATERIAL:const t=n.materialDataMap;Object.keys(t).forEach((e=>{t[e].images.forEach((e=>{e.imageBuffer&&a.push(e.imageBuffer)}))}));break;case e.BT_USERID:case e.BT_USERDATA:case e.BT_TILEID:break;case e.BT_NODEBOX:n.nodes.forEach((e=>{a.push(e.buffer)}));break;case e.BT_INDEX:i===e.DV_V1?(n.nodeIdBoxes.forEach((e=>{a.push(e.buffer)})),n.treeNodeItems.forEach((e=>{e.nodeIds&&e.nodeIds.length&&a.push(e.nodeIds.buffer),e.children&&e.children.length&&a.push(e.children.buffer),e.boundingBox&&e.boundingBox.length&&a.push(e.boundingBox.buffer)}))):n.nodes.forEach((e=>{e.nodeIds&&e.nodeIds.length&&a.push(e.nodeIds.buffer),e.children&&e.children.length&&a.push(e.children.buffer),e.boundingBox&&e.boundingBox.length&&a.push(e.boundingBox.buffer)}))}})),a}(i,b,M);r.ReleaseAllBuffers(),self.postMessage({type:"decode",id:v,data:{byteLength:e.byteLength,parsedData:b,packToBuffer:y,tickTime:I}},t)}else r.ReleaseAllBuffers(),self.postMessage({type:"error",id:v,error:"Decoder: no data."})}catch(e){console.error(e),self.postMessage({type:"error",id:v,error:e.message})}finally{i.destroy(r)}}onmessage=function(a){const n=a.data;switch(n.type){case"init":e=n.decoderConfig,t=new Promise(((t,i)=>{e.onModuleLoaded=function(e){t({protobuf:e})},ProtobufDecoderModule(e)}));break;case"decode":const a=n.buffer,s=n.taskConfig,o=n.id;t.then((e=>{const t=e.protobuf,n=new t.Decoder;if(s.xhr){!function(e,t,a,n,s){r.xhr(e,t,(e=>{i(e,t,a,n,s)}),void 0,(e=>{self.postMessage({type:"error",id:s,error:e})}))}(s.url,s,t,n,o)}else i(a,s,t,n,o)}))}};const r={Matrix3IdentityElements:[1,0,0,0,1,0,0,0,1],Matrix4:{identity:function(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]},fromArray(e,t,i=0){for(let r=0;r<16;r++)e[r]=t[r+i];return e},multiplyMatrices:function(e,t){const i=new Array[16],r=e[0],a=e[4],n=e[8],s=e[12],o=e[1],l=e[5],d=e[9],h=e[13],c=e[2],u=e[6],p=e[10],m=e[14],f=e[3],g=e[7],v=e[11],y=e[15],M=t[0],E=t[4],b=t[8],I=t[12],x=t[1],T=t[5],_=t[9],S=t[13],C=t[2],w=t[6],R=t[10],B=t[14],L=t[3],O=t[7],P=t[11],D=t[15];return i[0]=r*M+a*x+n*C+s*L,i[4]=r*E+a*T+n*w+s*O,i[8]=r*b+a*_+n*R+s*P,i[12]=r*I+a*S+n*B+s*D,i[1]=o*M+l*x+d*C+h*L,i[5]=o*E+l*T+d*w+h*O,i[9]=o*b+l*_+d*R+h*P,i[13]=o*I+l*S+d*B+h*D,i[2]=c*M+u*x+p*C+m*L,i[6]=c*E+u*T+p*w+m*O,i[10]=c*b+u*_+p*R+m*P,i[14]=c*I+u*S+p*B+m*D,i[3]=f*M+g*x+v*C+y*L,i[7]=f*E+g*T+v*w+y*O,i[11]=f*b+g*_+v*R+y*P,i[15]=f*I+g*S+v*B+y*D,i},setPosition:function(e,t,i,r){return e[12]=t,e[13]=i,e[14]=r,e}},str2ab:function(e){return(new TextEncoder).encode(e).buffer},ab2str:function(e){return(new TextDecoder).decode(new Uint8Array(e))},isDefined:function(e){return null!=e},xhr:function(e,t,i,r,a){void 0===t.responseType&&(t.responseType="arraybuffer");const{responseType:n,requestHeader:s,withCredentials:o,mimeType:l}=t;let d=new XMLHttpRequest;d.open("GET",e,!0),d.addEventListener("load",(function(e){const t=this.response;200===this.status||0===this.status?(0===this.status&&console.warn("XHR: HTTP Status 0 received."),i&&i(t)):a&&a(e)}),!1),d.addEventListener("progress",(function(e){r&&r(e)}),!1),d.addEventListener("error",(function(e){a&&a(e)}),!1),d.addEventListener("abort",(function(e){a&&a(e)}),!1),void 0!==n&&(d.responseType=n),void 0!==o&&(d.withCredentials=o),d.overrideMimeType&&d.overrideMimeType(void 0!==l?l:"text/plain");for(const e in s)d.setRequestHeader(e,s[e]);return d.send(null),d}},a={getAttributeName:function(e,t,i){switch(t){case e.GAT_POSITION:return"position";case e.GAT_INDEX:return"index";case e.GAT_NORMAL:return i?"cNormal":"normal";case e.GAT_COLOR:return"color";case e.GAT_TEX_COORD:return"uv";case e.GAT_TEX_COORD2:return"uv2";default:return"invalid"}},decode:function(e,t,i){const r=[];for(let n=0;n<i;n++){const i=t.GetMesh(n),s={header:a.getMeshHeader(e,i,n),geometries:[]},o=i.num_mesh_entities();for(let r=0;r<o;++r){const n=i.GetMeshEntity(r),o=a.decodeGeometry(e,t,i,n);s.geometries.push(o)}r.push(s)}return r},parse:function(e){const t={nodes:[]},i=t.nodes;return e.forEach((e=>{e.forEach((e=>{const t=e.header;e.geometries.forEach((e=>{const r=a.getNodeInfo(t,e);i.push({nodeInfo:r,geometry:{index:e.index,attributes:e.attributes}}),e.index=void 0,e.attributes=void 0}))}))})),t},getNodeInfo:function(e,t){const i=t.summary,n=e.tileId,s=`${e.tileId}_${e.blockId}_${i.nodeId}`,o=-1===e.materialBlockId?"-1_0":`${e.tileId}_${e.materialBlockId}`;let l,d,h,c;if(r.isDefined(i.matrix)&&16===i.matrix.itemSize){l=r.Matrix4.identity(),r.Matrix4.fromArray(l,i.matrix.array);const e=i.translation;r.isDefined(e)&&3===e.itemSize&&r.Matrix4.setPosition(l,e.array[0],e.array[1],e.array[2])}if(r.isDefined(i.bbox)){const e=Object.values(i.bbox.array);e.length>=10&&(d=[(e[6]+e[7])/2,(e[8]+e[9])/2],h=[(e[7]-e[6])/2,(e[9]-e[8])/2]),c=e.slice(0,6)}let u={tileId:n,nodeId:s,materialBlockId:o,materialId:i.materialId,primitiveMode:i.primitiveMode,bbox:c,matrix:l,userIdMapIndex:[],indexStart:0,indexCount:i.index_count,uvCenter:d,uvHalfExtent:h,vertexColors:!1,useCompressedNormal:!1,useCompressedColor:!1,useCompressedUv:!1,hasLightMap:!1};t.attributes.forEach((e=>{"cNormal"===e.name&&(u.useCompressedNormal=!0),"color"===e.name&&(u.vertexColors=!0,u.useCompressedColor=i.color_compressed),"uv"===e.name&&(u.useCompressedUv=i.uv_compressed),"uv2"===e.name&&(u.hasLightMap=!0)}));let p=new Map;const m=t.groups;if(m.length)m.forEach(((t,r)=>{const n=a.addSubNodeInfo(u,e,i,t,r);!1===p.has(n.userId)&&p.set(n.userId,new Map),p.get(n.userId).set(n.meshId,n.indexInfo)}));else{const t=a.addNodeInfo(u,e,i);p.set(t.userId,new Map),p.get(t.userId).set(t.meshId,t.indexInfo)}return u.indexInfos=p,u},addSubNodeInfo:function(e,t,i,r,a){const n=r.userId,s=`${t.tileId}_${t.blockId}_${r.nodeId}`,o=!!i.uv_count,l=!!i.color_count,d=i.normal_count&&i.compressed;let h={userId:n,meshId:s,indexInfo:{positionStart:void 0!==r.vertex_start?(r.vertex_start-i.vertex_start)/4:void 0,positionCount:void 0!==r.vertex_count?3*r.vertex_count:0,indexStart:void 0!==r.index_start?(r.index_start-i.index_start)/i.index_stride:void 0,indexCount:void 0!==r.index_count?r.index_count:0,uvStart:o?(r.uv_start-i.uv_start)/4:0,uvCount:o?2*r.uv_count:0,colorStart:l?(r.color_start-i.color_start)/i.color_stride:0,colorCount:l?r.color_count:0,cNormalStart:d?(r.normal_start-i.normal_start)/2:0,cNormalCount:d?r.normal_count:0}};e.userIdMapIndex.push({userId:n,index:a});const c=-1!==r.materialId?`${e.materialBlockId}_${r.materialId}`:-1;return h.meshNodeInfo={parent:e.nodeId,matrix:e.matrix,materialId:c},h},addNodeInfo:function(e,t,i){const r=i.userId;let a={userId:r,meshId:e.nodeId,indexInfo:{positionStart:0,positionCount:3*i.vertex_count,indexStart:0,indexCount:i.index_count,uvStart:0,uvCount:i.uv_count?2*i.uv_count:0,colorStart:0,colorCount:i.color_count||0,cNormalStart:0,cNormalCount:i.normal_count&&i.compressed?i.normal_count:0}};return e.userIdMapIndex.push({userId:r,index:0}),a.meshNodeInfo={parent:e.nodeId,matrix:e.matrix,materialId:e.materialId},a},getMeshHeader:function(e,t,i){return{id:i,tileId:t.get_tile_id(),blockId:t.get_block_id(),bufferBlockId:t.get_buffer_block_id(),materialBlockId:t.get_material_block_id(),userdataBlockId:t.get_userdata_block_id(),matrix:a.getMatrix(e,t),bbox:a.getBbox(e,t),translation:a.getTranslation(e,t)}},getMatrix:function(e,t){const i=t.num_components_matrix();if(0===i)return;const r=i,a=t.byte_length_per_component_matrix(),n=r*a;4!==a&&console.log("entity.byte_length_per_component_matrix:",a);let s=e._malloc(n);t.GetMatrixFloat32Array(n,s);const o=new Float32Array(e.HEAPF32.buffer,s,r).slice();return e._free(s),{array:o,itemSize:i}},getBbox:function(e,t){const i=t.num_components_bbox();if(0===i)return;const r=i,a=t.byte_length_per_component_bbox(),n=r*a;4!==a&&console.log("entity.byte_length_per_component_bbox:",a);let s=e._malloc(n);t.GetBBoxFloat32Array(n,s);const o=new Float32Array(e.HEAPF32.buffer,s,r).slice();return e._free(s),{array:o,itemSize:i}},getTranslation:function(e,t){const i=t.num_components_translation();if(0===i)return;const r=i,a=t.byte_length_per_component_translation(),n=r*a;8!==a&&console.log("entity.byte_length_per_component_translation:",a);let s=e._malloc(n);t.GetTranslationFloat64Array(n,s);const o=new Float64Array(e.HEAPF64.buffer,s,r).slice();return e._free(s),{array:o,itemSize:i}},decodeGeometry:function(e,t,i,r){const n={userId:r.get_user_id(),userdataId:r.get_userdata_id(),materialId:r.get_material_id(),sceneId:r.get_scene_id(),sceneName:r.get_scene_name(),nodeId:r.get_node_id(),nodeType:r.node_type(),primitiveId:r.get_primitive_id(),primitiveMode:r.primitive_mode(),matrix:a.getMatrix(e,r),bbox:a.getBbox(e,r),translation:a.getTranslation(e,r)},s={index:null,attributes:[]},o=r.num_attributes();for(let l=0;l<o;++l){const o=r.GetAttribute(l),d=a.getAttributeParms(e,o),h=a.decodeAttribute(e,t,i,d,o);d.attributeType===e.GAT_INDEX?s.index=h:s.attributes.push(h),a.setGeometrySummary(e,d,n)}return s.summary=n,s.groups=a.getGeometryGroups(e,r),s},getAttributeParms(e,t){const i=t.attribute_type(),r=t.compressed();return{attributeType:i,attributeName:a.getAttributeName(e,i,r),dataType:t.data_type(),numComponents:t.num_components(),numPoints:t.num_points(),byteOffset:t.byte_offset(),byteStride:t.byte_stride(),byteLength:t.byte_length(),normalized:t.normalized(),compressed:r}},setGeometrySummary:function(e,t,i){let r;switch(t.attributeType){case e.GAT_POSITION:r="vertex_";break;case e.GAT_INDEX:r="index_";break;case e.GAT_NORMAL:r="normal_";break;case e.GAT_COLOR:r="color_";break;case e.GAT_TEX_COORD:r="uv_";break;case e.GAT_TEX_COORD2:r="uv2_"}r&&(i[`${r}start`]=t.byteOffset,i[`${r}count`]=t.numPoints,i[`${r}value_type`]=t.dataType,i[`${r}length`]=t.byteLength,i[`${r}stride`]=t.byteStride,i[`${r}components`]=t.numComponents,i[`${r}normalized`]=t.normalized,i[`${r}compressed`]=t.compressed)},getGeometryGroups:function(e,t){const i=t.num_sub_entities(),r=[];for(let n=0;n<i;++n){const i=t.GetSubMeshEntity(n),s={userId:i.get_user_id(),userdataId:i.get_userdata_id(),materialId:i.get_material_id(),nodeId:i.get_node_id()},o=i.num_attributes();for(let t=0;t<o;++t){const r=i.GetAttribute(t),n=a.getAttributeParms(e,r);a.setGeometrySummary(e,n,s)}r.push(s)}return r},decodeAttribute:function(e,t,i,r,a){const{attributeName:n,numComponents:s,numPoints:o,dataType:l,normalized:d,compressed:h}=r,c=o*s;let u,p,m;switch(l){case e.DT_FLOAT32:m=4*c,u=e._malloc(m),t.GetAttributeDataArray(i,a,m,u),p=new Float32Array(e.HEAPF32.buffer,u,c).slice(),e._free(u);break;case e.DT_INT8:u=e._malloc(c),t.GetAttributeDataArray(i,a,c,u),p=new Int8Array(e.HEAP8.buffer,u,c).slice(),e._free(u);break;case e.DT_INT16:m=2*c,u=e._malloc(m),t.GetAttributeDataArray(i,a,m,u),p=new Int16Array(e.HEAP16.buffer,u,c).slice(),e._free(u);break;case e.DT_INT32:m=4*c,u=e._malloc(m),t.GetAttributeDataArray2(i,a,m,u),p=new Int32Array(e.HEAP32.buffer,u,c).slice(),e._free(u);break;case e.DT_UINT8:u=e._malloc(c),t.GetAttributeDataArray(i,a,c,u),p=new Uint8Array(e.HEAPU8.buffer,u,c).slice(),e._free(u);break;case e.DT_UINT16:m=2*c,u=e._malloc(m),t.GetAttributeDataArray(i,a,m,u),p=new Uint16Array(e.HEAPU16.buffer,u,c).slice(),e._free(u);break;case e.DT_UINT32:m=4*c,u=e._malloc(m),t.GetAttributeDataArray(i,a,m,u),p=new Uint32Array(e.HEAPU32.buffer,u,c).slice(),e._free(u);break;default:throw new Error("CLOUD.Loader.TilesWorkerDecoder: Unexpected attribute type.")}return{name:n,array:p,itemSize:s,normalized:d,compressed:h}}},n={decode:function(e,t,i){return console.log("BT_POINT"),null}},s={decode:function(e,t,i){const r=[];for(let a=0;a<i;a++){const i=t.GetInstance(a);let n={type:e.BT_INSTANCE,header:s.getHeader(e,i,a),entities:[]};const o=i.num_instance_entities();for(let t=0;t<o;++t){const r=i.GetInstanceEntity(t);n.entities.push({userId:r.get_user_id(),userdataId:r.get_userdata_id(),matrix:s.getMatrix(e,i,r),bbox:s.getBbox(e,i,r),translation:s.getTranslation(e,i,r)})}r.push(n)}return r},parse:function(e){const t={nodes:[]},i=t.nodes;return e.forEach((e=>{e.forEach((e=>{const t=e.header,r=e.entities;i.push({nodeInfo:s.getNodeInfo(t,r),geometry:{attributes:s.getCustomAttributes(r.length)}})}))})),t},getNodeInfo:function(e,t){const i=[],a=e.entityUrl,n=`${e.tileId}_${e.blockId}`,s=r.Matrix4.identity();if(r.isDefined(e.matrix)&&16===e.matrix.itemSize){r.Matrix4.fromArray(s,e.matrix.array);const t=e.translation;r.isDefined(t)&&3===t.itemSize&&r.Matrix4.setPosition(s,t.array[0],t.array[1],t.array[2])}return t.forEach((e=>{const t=r.Matrix4.identity();if(r.isDefined(e.matrix)&&16===e.matrix.itemSize){r.Matrix4.fromArray(t,e.matrix.array);const i=e.translation;r.isDefined(i)&&3===i.itemSize&&r.Matrix4.setPosition(t,i.array[0],i.array[1],i.array[2])}i.push({userID:e.userId,userDataID:e.userdataId,entityMatrix:t})})),{nodeId:n,entityId:a,entityInfoArray:i,rootMatrix:s}},createMatrixAttribute:function(e){const t=[],i=3*e;for(let e=0;e<4;++e){const r=new Float32Array(i);r.fill(0),t.push({name:`mcol${e}`,array:r,itemSize:3,normalized:!1,meshPerAttribute:1})}return t},createUVMatrixAttribute:function(e){const t=[],i=3*e,a=r.Matrix3IdentityElements;for(let r=0;r<3;++r){const n=new Float32Array(i);let s=0;for(let t=0;t<e;++t)n[s++]=a[0+3*r],n[s++]=a[1+3*r],n[s++]=a[2+3*r];t.push({name:`muvCol${r}`,array:n,itemSize:3,normalized:!1,meshPerAttribute:1})}return t},createColorAttribute:function(e){const t=new Float32Array(4*e);return t.fill(0),{array:t,itemSize:4,normalized:!1,meshPerAttribute:1}},createClippingAttribute:function(e){const t=new Float32Array(e);return t.fill(0),{array:t,itemSize:1,normalized:!1,meshPerAttribute:1}},createStateAttribute:function(e,t){const i=new Float32Array(e);return i.fill(t),{array:i,itemSize:1,normalized:!1,meshPerAttribute:1}},getCustomAttributes:function(e){const t=[];return t.push({name:"mcols",attribute:s.createMatrixAttribute(e)}),t.push({name:"muvCols",attribute:s.createUVMatrixAttribute(e)}),t.push({name:"aColor",attribute:s.createColorAttribute(e)}),t.push({name:"vState",attribute:s.createStateAttribute(e,0)}),t.push({name:"vState2",attribute:s.createStateAttribute(e,-1)}),t.push({name:"vClipping",attribute:s.createClippingAttribute(e)}),t},getHeader:function(e,t,i){return{id:i,tileId:t.get_tile_id(),blockId:t.get_block_id(),entityUrl:t.get_entity_url(),matrix:s.getHeaderMatrix(e,t),bbox:s.getHeaderBbox(e,t),translation:s.getHeaderTranslation(e,t)}},getMatrix:function(e,t,i){const r=i.num_components_matrix();if(0===r)return;const a=r,n=4*a;let s=e._malloc(n);t.GetMatrixFloat32Array(i,n,s);const o=new Float32Array(e.HEAPF32.buffer,s,a).slice();return e._free(s),{array:o,itemSize:r}},getBbox:function(e,t,i){const r=i.num_components_bbox();if(0===r)return;const a=r,n=4*a;let s=e._malloc(n);t.GetBBoxFloat32Array(i,n,s);const o=new Float32Array(e.HEAPF32.buffer,s,a).slice();return e._free(s),{array:o,itemSize:r}},getTranslation:function(e,t,i){const r=i.num_components_translation();if(0===r)return;const a=r,n=8*a;let s=e._malloc(n);t.GetTranslationFloat64Array(i,n,s);const o=new Float64Array(e.HEAPF64.buffer,s,a).slice();return e._free(s),{array:o,itemSize:r}},getHeaderMatrix:function(e,t){const i=t.num_components_matrix();if(0===i)return;const r=i,a=4*r;let n=e._malloc(a);t.GetHeaderMatrixFloat32Array(a,n);const s=new Float32Array(e.HEAPF32.buffer,n,r).slice();return e._free(n),{array:s,itemSize:i}},getHeaderBbox:function(e,t){const i=t.num_components_bbox();if(0===i)return;const r=i,a=4*r;let n=e._malloc(a);t.GetHeaderBBoxFloat32Array(a,n);const s=new Float32Array(e.HEAPF32.buffer,n,r).slice();return e._free(n),{array:s,itemSize:i}},getHeaderTranslation:function(e,t){const i=t.num_components_translation();if(0===i)return;const r=i,a=8*r;let n=e._malloc(a);t.GetHeaderTranslationFloat64Array(a,n);const s=new Float64Array(e.HEAPF64.buffer,n,r).slice();return e._free(n),{array:s,itemSize:i}}},o={decode:function(e,t,i){const r=[];for(let a=0;a<i;a++){const i=t.GetSearchTree(a),n=i.GetNodeIdCount(),s=[],l=[];for(let t=0;t<n;t++){const r=i.GetNodeIdItem(t);s.push({tileId:r.get_tile_id(),blockId:r.get_block_id(),nodeId:r.get_node_id(),userId:r.get_user_id(),userdataId:r.get_userdata_id()});const a=o.getNodeIdBoundingBox(e,i,r);l.push(a)}const d=i.GetTreeNodeCount(),h=[];for(j=0;j<d;j++){const t=i.GetTreeNodeItem(j);h.push({treeNodeId:t.get_node_id(),nodeIds:o.getNodeIdsFromOctree(e,i,t),children:o.getChildrenNodeIdsFromOctree(e,i,t),boundingBox:o.getTreeNodeBoundingBox(e,i,t)})}r.push({nodeIdItems:s,nodeIdBoxes:l,treeNodeItems:h})}return r},parse:function(e){const t=[],i=[],r=[];return e.forEach((e=>{e.forEach((e=>{t.push(...e.nodeIdItems),i.push(...e.nodeIdBoxes),r.push(...e.treeNodeItems)}))})),{nodeIdItems:JSON.stringify(t),nodeIdBoxes:i,treeNodeItems:r}},getNodeIdBoundingBox:function(e,t,i){const r=i.num_components_bbox();if(0===r)return;const a=r*i.byte_lenth_per_component_bbox();let n=e._malloc(a);t.GetNodeIdBBoxFloat32Array(i,a,n);const s=new Float32Array(e.HEAPF32.buffer,n,r).slice();return e._free(n),s},getTreeNodeBoundingBox:function(e,t,i){const r=i.num_components_bbox();if(0===r)return;const a=r*i.byte_lenth_per_component_bbox();let n=e._malloc(a);t.GetTreeNodeBBoxFloat32Array(i,a,n);const s=new Float32Array(e.HEAPF32.buffer,n,r).slice();return e._free(n),s},getNodeIdsFromOctree:function(e,t,i){const r=i.num_nodes();if(0===r)return;const a=r*i.byte_lenth_per_component_node();let n=e._malloc(a);t.GetTreeNodeInt32Array(i,a,n);const s=new Int32Array(e.HEAP32.buffer,n,r).slice();return e._free(n),s},getChildrenNodeIdsFromOctree:function(e,t,i){const r=i.num_children();if(0===r)return;const a=r*i.byte_lenth_per_component_childnode();let n=e._malloc(a);t.GetTreeChildNodeInt32Array(i,a,n);const s=new Int32Array(e.HEAP32.buffer,n,r).slice();return e._free(n),s}},l={decode:function(e,t,i){const r=[];for(let a=0;a<i;a++){const i=t.GetMaterial(a);let n,s={id:a,type:e.BT_MATERIAL,header:{tileId:i.get_tile_id(),blockId:i.get_block_id(),materialCount:i.get_material_count(),textureCount:i.get_texture_count(),imageCount:i.get_image_count()},materials:[],textures:[],images:[]};const o=i.GetMaterialItemCount();for(n=0;n<o;++n){const t=i.GetMaterialItem(n);s.materials.push({name:t.get_name(),type:t.get_type(),color:t.get_color(),doubleSide:t.get_double_side(),receiveIbl:t.get_receive_ibl(),opacity:t.get_opacity(),metalness:t.get_metalness(),roughness:t.get_roughness(),textureIds:l.getTextureIds(e,i,t),customData:l.getMaterialCustomData(e,i,t)})}const d=i.GetTextureItemCount();for(n=0;n<d;++n){const t=i.GetTextureItem(n);s.textures.push({name:t.get_name(),type:t.get_type(),image:t.get_image(),repeatU:t.get_repeat_u(),repeatV:t.get_repeat_v(),angle:t.get_angle(),alpha:t.get_alpha(),depth:t.get_depth(),offsetU:t.get_offset_u(),offsetV:t.get_offset_v(),scaleU:t.get_scale_u(),scaleV:t.get_scale_v(),lodImageIds:l.getLodImageIds(e,i,t)})}const h=i.GetImageItemCount();for(n=0;n<h;++n){const t=i.GetImageItem(n);s.images.push({url:t.get_url(),type:t.get_type(),width:t.get_width(),height:t.get_height(),dimension:t.get_dimension(),bufferId:t.get_buffer_id(),byteOffset:t.get_byte_offset(),byteLength:t.get_byte_length(),imageBuffer:l.getImageBuffer(e,t)})}r.push(s)}return r},parse:function(e){const t={materialDataMap:{}},i=t.materialDataMap;return e.forEach((e=>{e.forEach((e=>{const{tileId:t,blockId:r}=e.header,a=`${t}_${r}`;void 0===i[a]?i[a]=e:console.log("The material has been parsed!")}))})),t},getImageBuffer:function(e,t){if(!t.HasImageBuffer())return;const i=t.get_byte_length();if(0===i)return;let r=e._malloc(i);t.GetImageBuffer(i,r);const a=new Int8Array(e.HEAP8.buffer,r,i).slice().buffer;return e._free(r),a},getTextureIds:function(e,t,i){const r=i.num_entries_textures();if(0===r)return;const a=r*i.byte_length_per_entry_textures();let n=e._malloc(a);t.GetTextureIdsInt32Array(i,a,n);const s=new Int32Array(e.HEAP32.buffer,n,r).slice();return e._free(n),s},getLodImageIds:function(e,t,i){const r=i.num_entries_lod_images();if(0===r)return;const a=r*i.byte_length_per_entry_lod_images();let n=e._malloc(a);t.GetLodImageIdsInt32Array(i,a,n);const s=new Int32Array(e.HEAP32.buffer,n,r).slice();return e._free(n),s},GetKeyValueInt32ArrayForCustomData:function(e,t,i){const r=i.num_entries_int32();if(0===r)return;const a=r*i.byte_length_per_entry_int32();let n=e._malloc(a);t.GetValueInt32ArrayForCustomData(i,a,n);const s=new Int32Array(e.HEAP32.buffer,n,r).slice();e._free(n);const o=[];for(let e=0;e<r;++e)o.push(t.GetKeyForCustomDataWithInt32Values(i,e));return{keys:o,values:s}},GetKeyValueFloatArrayForCustomData:function(e,t,i){const r=i.num_entries_float();if(0===r)return;const a=r*i.byte_length_per_entry_float();let n=e._malloc(a);t.GetValueFloatArrayForCustomData(i,a,n);const s=new Float32Array(e.HEAPF32.buffer,n,r).slice();e._free(n);const o=[];for(let e=0;e<r;++e)o.push(t.GetKeyForCustomDataWithFloatValues(i,e));return{keys:o,values:s}},GetKeyValueStringArrayForCustomData:function(e,t,i){const r=i.num_entries_string();if(0===r)return;const a=[],n=[];for(let e=0;e<r;++e)a.push(t.GetKeyForCustomDataWithStringValues(i,e)),n.push(t.GetValueForCustomDataWithStringValues(i,e));return{keys:a,values:n}},getMaterialCustomData:function(e,t,i){const r=i.num_entries_custom_data_items();if(0===r)return;const a=[];for(let n=0;n<r;++n){const r=i.GetCustomDataItem(n);a.push([{I32:l.GetKeyValueInt32ArrayForCustomData(e,t,r)},{F32:l.GetKeyValueFloatArrayForCustomData(e,t,r)},{STR:l.GetKeyValueStringArrayForCustomData(e,t,r)}])}return a}},d={decode:function(e,t,i){const r=[];for(let a=0;a<i;a++){const i=t.GetUserId(a),n=i.num_user_id_infos(),s=i.get_user_id_min(),o=i.get_user_id_max(),l={tileId:i.get_tile_id(),blockId:i.get_block_id(),minUserId:s,maxUserId:o};let h={};for(let t=0;t<n;++t){const r=i.GetUserIdInfo(t),a=r.get_tile_id(),n=r.get_block_id(),s=r.get_node_id(),o=r.get_user_id(),l=d.getUserInfoBox(e,i,r);h[`${a}_${n}_${s}`]={userId:o,tileId:a,blockId:n,nodeId:s,userdataId:r.get_userdata_id(),boundingBox:l}}const c={},u={},p=i.num_user_ids();for(let e=0;e<p;++e){const t=i.GetUserIdStr(e),r=s+e;c[r]=t,u[t]=r}r.push({header:l,userIdInfoMap:h,userIdMap:c,userIdIndexMap:u})}return r},parse:function(e){const t={},i={},r={};return e.forEach((e=>{e.forEach((e=>{const a=e.userIdInfoMap,n=e.userIdMap,s=e.userIdIndexMap;for(const e in n)i[e]=n[e];for(const e in s)r[e]=s[e];for(const e in a)t[e]=a[e]}))})),JSON.stringify({userIdInfoMap:t,userIdMap:i,userIdIndexMap:r})},getUserInfoBox:function(e,t,i){const r=i.num_bbox_components(),a=r*i.bytesize_bbox_per_component();let n=e._malloc(a);t.GetBBoxFloat32Array(i,a,n);const s=new Float32Array(e.HEAPF32.buffer,n,r).slice();return e._free(n),s}},h={decode:function(e,t,i){const r=[];for(let a=0;a<i;a++){const i=t.GetUserData(a);let n={header:{tileId:i.GetTileId(),blockId:i.GetBlockId(),userdataCount:i.GetUserdataCount()},userDataKeyMap:{},userDataKeys:[],userDataValueMap:{},userDataValues:[],userDataItems:[]};const s=n.userDataKeyMap,o=n.userDataKeys,l=i.GetKeysCount();let d;for(d=0;d<l;++d){const e=i.GetStringKey(d);s[e]=d,o.push(e)}const c=n.userDataValueMap,u=n.userDataValues,p=i.GetValuesCount();for(d=0;d<p;++d){const e=i.GetStringValue(d);c[e]=d,u.push(e)}const m=i.GetUserDataItemCount(),f=n.userDataItems;for(d=0;d<m;++d){const t=i.GetUserDataItem(d),r=h.getUserDataKeyIndices(e,i,t),a=h.getUserDataValueIndices(e,i,t),n=r.length,s={};for(let e=0;e<n;e++)s[r[e]]=a[e];f.push(s)}r.push(n)}return r},parse:function(e){const t={userDataKeyMap:{},userDataKeys:{},userDataValueMap:{},userDataValues:{},userDataItems:{}},i=t.userDataKeyMap,r=t.userDataKeys,a=t.userDataValueMap,n=t.userDataValues,s=t.userDataItems;return e.forEach(((e,t)=>{e.forEach((e=>{const o=e.header,l=`${t}_${o.blockId}`;i[l]=e.userDataKeyMap,r[l]=e.userDataKeys,a[l]=e.userDataValueMap,n[l]=e.userDataValues,s[l]=e.userDataItems}))})),JSON.stringify(t)},getUserDataKeyIndices:function(e,t,i){const r=i.num_entries_string()*i.num_components(),a=r*i.byte_length_per_component();let n=e._malloc(a);t.GetKeyIndexStringArray(i,a,n);const s=new Int32Array(e.HEAP32.buffer,n,r).slice();return e._free(n),s},getUserDataValueIndices:function(e,t,i){const r=i.num_entries_string()*i.num_components(),a=r*i.byte_length_per_component();let n=e._malloc(a);t.GetValueIndexStringArray(i,a,n);const s=new Int32Array(e.HEAP32.buffer,n,r).slice();return e._free(n),s}},c={decode:function(e,t,i){const r=[];for(let e=0;e<i;e++){const i=t.GetTileId(e);let a={tileIds:[],tileIdMap:{}};const n=a.tileIds,s=a.tileIdMap,o=i.num_tile_ids();for(let e=0;e<o;++e){const t=i.get_tile_path(e);s[t]=e,n.push(t)}r.push(a)}return r},parse:function(e){const t={tileIdMap:{},tileIds:{}},i=t.tileIdMap,r=t.tileIds;return e.forEach(((e,t)=>{e.forEach(((e,a)=>{const n=`${t}_${a}`;i[n]=e.tileIdMap,r[n]=e.tileIds}))})),JSON.stringify(t)}},u={decode:function(e,t,i){const r=[];for(let a=0;a<i;a++){const i=t.GetViewTree(a),n=i.GetViewNodeCount(),s=[];for(let t=0;t<n;++t){const r=i.GetViewNodeItem(t);s.push({nodeId:r.get_node_id(),parentId:r.get_node_parent_id(),bbox:u.getViewNodeBoundingBox(e,i,r),tileIds:u.getViewNodeTileIds(e,i,r)})}r.push({treeType:i.get_tree_type(),geometryErrors:GetGeometryErrors(),viewNodes:s})}return r},parse:function(e){const t=[];return e.forEach((e=>{e.forEach((e=>{for(let i=0,r=e.length;i<r;++i)t.push(e[i])}))})),{nodes:t}},GetGeometryErrors:function(e,t){const i=t.num_geometry_errors(),r=i*t.byte_lenth_per_geometry_error();let a=e._malloc(r);t.GetGeometryErrorsFloat32Array(r,a);const n=new Float32Array(e.HEAPF32.buffer,a,i).slice();return e._free(a),n},getViewNodeBoundingBox:function(e,t,i){const r=i.num_components_bbox(),a=r*i.byte_lenth_per_component_bbox();let n=e._malloc(a);t.GetViewNodeBBoxFloat32Array(i,a,n);const s=new Float32Array(e.HEAPF32.buffer,n,r).slice();return e._free(n),s},getViewNodeTileIds:function(e,t,i){const r=i.num_tile_ids();if(0===r)return;const a=r*i.byte_lenth_per_tile_ids();let n=e._malloc(a);t.GetViewNodeTileIdsInt32Array(i,a,n);const s=new Int32Array(e.HEAP32.buffer,n,r).slice();return e._free(n),s}},p={decode:function(e,t,i){const r=[];for(let e=0;e<i;e++){const i=t.GetNodeId(e),a=i.GetNodeIdItemCount(),n=[];for(let e=0;e<a;++e){const t=i.GetNodeIdItem(e);n.push({tileId:t.get_tile_id(),nodeId:t.get_node_id(),userId:t.get_user_id(),bboxId:t.get_bbox_id()})}r.push(n)}return r},parse:function(e){const t=[];return e.forEach((e=>{e.forEach((e=>{for(let i=0,r=e.length;i<r;++i)t.push(e[i])}))})),{nodes:t}}},m={decode:function(e,t,i){const r=[];for(let a=0;a<i;a++){const i=t.GetNodeBox(a),n=i.GetNodeBBoxItemCount(),s=[];for(let t=0;t<n;++t){const r=i.GetNodeBBoxItem(t),a=m.getBoundingBox(e,i,r);s.push(a)}r.push(s)}return r},parse:function(e){const t=[];return e.forEach((e=>{e.forEach((e=>{for(let i=0,r=e.length;i<r;++i)t.push(e[i])}))})),{nodes:t}},getBoundingBox:function(e,t,i){const r=i.num_components_bbox(),a=r*i.byte_lenth_per_component_bbox();let n=e._malloc(a);t.GetBBoxFloat32Array(i,a,n);const s=new Float32Array(e.HEAPF32.buffer,n,r).slice();return e._free(n),s}},f={decode:function(e,t,i){const r=[];for(let a=0;a<i;a++){const i=t.GetSearchTreeV2(a),n=i.GetTreeNodeCount(),s=[];for(let t=0;t<n;t++){const r=i.GetTreeNodeItem(t);s.push({treeNodeId:r.get_node_id(),nodeIds:f.getNodeIdsFromOctree(e,i,r),children:f.getChildrenNodeIdsFromOctree(e,i,r),boundingBox:f.getTreeNodeBoundingBox(e,i,r)})}r.push(s)}return r},parse:function(e){const t=[];return e.forEach((e=>{e.forEach((e=>{for(let i=0,r=e.length;i<r;++i)t.push(e[i])}))})),{nodes:t}},getNodeIdBoundingBox:function(e,t,i){const r=i.num_components_bbox(),a=r*i.byte_lenth_per_component_bbox();let n=e._malloc(a);t.GetNodeIdBBoxFloat32Array(i,a,n);const s=new Float32Array(e.HEAPF32.buffer,n,r).slice();return e._free(n),s},getTreeNodeBoundingBox:function(e,t,i){const r=i.num_components_bbox(),a=r*i.byte_lenth_per_component_bbox();let n=e._malloc(a);t.GetTreeNodeBBoxFloat32Array(i,a,n);const s=new Float32Array(e.HEAPF32.buffer,n,r).slice();return e._free(n),s},getNodeIdsFromOctree:function(e,t,i){const r=i.num_nodes();if(0===r)return;const a=r*i.byte_lenth_per_component_node();let n=e._malloc(a);t.GetTreeNodeInt32Array(i,a,n);const s=new Int32Array(e.HEAP32.buffer,n,r).slice();return e._free(n),s},getChildrenNodeIdsFromOctree:function(e,t,i){const r=i.num_children();if(0===r)return;const a=r*i.byte_lenth_per_component_childnode();let n=e._malloc(a);t.GetTreeChildNodeInt32Array(i,a,n);const s=new Int32Array(e.HEAP32.buffer,n,r).slice();return e._free(n),s}},g={decode:function(e,t,i){const r=[];for(let a=0;a<i;a++){const i=t.GetUserIdV2(a),n=i.get_user_id_min(),s=i.get_user_id_max(),o={header:{tileId:i.get_tile_id(),blockId:i.get_block_id(),minUserId:n,maxUserId:s},userIds:g.getUserIds(i),nodelistIds:g.getNodeListIds(e,i),userdataIds:g.getUserDataIds(e,i)};r.push(o)}return r},parse:function(e,t){const i={},r={},a={};return e.forEach((e=>{e.forEach((e=>{const{header:t,userIds:n,userdataIds:s}=e,o=t.minUserId;for(let e=0,t=n.length;e<t;++e){const t=n[e],l=o+e;i[l]=t,r[t]=l,a[l]=s[e]}}))})),JSON.stringify({userIdMap:i,userIdIndexMap:r,userdataIdMap:a})},getUserIds:function(e){const t=[],i=e.num_user_ids();for(j=0;j<i;++j){const i=e.GetUserIdStr(j);t.push(i)}return t},getUserIdDoublyMap:function(e,t){const i={},r={},a=e.num_user_ids();for(j=0;j<a;++j){const a=e.GetUserIdStr(j),n=t+j;i[n]=a,r[a]=n}return{userIdMap:i,reverseUserIdMap:r}},getNodeListIds:function(e,t){const i=t.num_nodelist_ids();if(0===i)return;const r=4*i;let a=e._malloc(r);t.GetNodeListIdsInt32Array(r,a);const n=new Int32Array(e.HEAP32.buffer,a,i).slice();return e._free(a),n},getUserDataIds:function(e,t){const i=t.num_userdata_ids();if(0===i)return;const r=4*i;let a=e._malloc(r);t.GetUserDataIdsInt32Array(r,a);const n=new Int32Array(e.HEAP32.buffer,a,i).slice();return e._free(a),n}}},r.Loader.TilesWorkerDecoder=e}(),function(){class e extends THREE.BufferGeometry{constructor(e,t=64,i=1,r=8,a=!1){super(),this.type="TubeGeometry",this.parameters={path:e,tubularSegments:t,radius:i,radialSegments:r,closed:a};let n=[];t<2&&(n.push(0),n.push(1));for(let e=0;e<=t-2;e++){if(1==e||e==t-2){const t=1==e?.01:.99;n.push(t)}if(t-2==1){const t=1==e?.01:.99;n.push(t)}const i=e/(t-2);n.push(i)}const s=function(e,t,i){const r=new THREE.Vector3,a=[],s=[],o=[],l=new THREE.Vector3,d=new THREE.Matrix4;for(let i=0;i<=t;i++){let t=e.getTangentAt(n[i],new THREE.Vector3);t.normalize(),a.push(t)}s[0]=new THREE.Vector3,o[0]=new THREE.Vector3;let h=Number.MAX_VALUE;const c=Math.abs(a[0].x),u=Math.abs(a[0].y),p=Math.abs(a[0].z);c<=h&&(h=c,r.set(1,0,0));u<=h&&(h=u,r.set(0,1,0));p<=h&&r.set(0,0,1);l.crossVectors(a[0],r).normalize(),s[0].crossVectors(a[0],l),o[0].crossVectors(a[0],s[0]);for(let e=1;e<=t;e++){if(s[e]=s[e-1].clone(),o[e]=o[e-1].clone(),l.crossVectors(a[e-1],a[e]),l.length()>Number.EPSILON){l.normalize();const t=Math.acos(THREE.MathUtils.clamp(a[e-1].dot(a[e]),-1,1));s[e].applyMatrix4(d.makeRotationAxis(l,t))}o[e].crossVectors(a[e],s[e])}if(!0===i){let e=Math.acos(THREE.MathUtils.clamp(s[0].dot(s[t]),-1,1));e/=t,a[0].dot(l.crossVectors(s[0],s[t]))>0&&(e=-e);for(let i=1;i<=t;i++)s[i].applyMatrix4(d.makeRotationAxis(a[i],e*i)),o[i].crossVectors(a[i],s[i])}return{tangents:a,normals:s,binormals:o}}(e,t,a);this.tangents=s.tangents,this.normals=s.normals,this.binormals=s.binormals;const o=new THREE.Vector3,l=new THREE.Vector3,d=new THREE.Vector2;let h=new THREE.Vector3;const c=[],u=[],p=[],m=[];function f(t){h=e.getPointAt(n[t],h);const a=s.normals[t],d=s.binormals[t];for(let e=0;e<=r;e++){const t=e/r*Math.PI*2,n=Math.sin(t),s=-Math.cos(t);l.x=s*a.x+n*d.x,l.y=s*a.y+n*d.y,l.z=s*a.z+n*d.z,l.normalize(),u.push(l.x,l.y,l.z),o.x=h.x+i*l.x,o.y=h.y+i*l.y,o.z=h.z+i*l.z,c.push(o.x,o.y,o.z)}}!function(){for(let e=0;e<t;e++)f(e);f(!1===a?t:0),function(){for(let e=0;e<=t;e++)for(let t=0;t<=r;t++)d.x=n[e],d.y=t/r,p.push(d.x,d.y)}(),function(){for(let e=1;e<=t;e++)for(let t=1;t<=r;t++){const i=(r+1)*(e-1)+(t-1),a=(r+1)*e+(t-1),n=(r+1)*e+t,s=(r+1)*(e-1)+t;m.push(i,a,s),m.push(a,n,s)}}()}(),this.setIndex(m),this.setAttribute("position",new THREE.Float32BufferAttribute(c,3)),this.setAttribute("normal",new THREE.Float32BufferAttribute(u,3)),this.setAttribute("uv",new THREE.Float32BufferAttribute(p,2))}toJSON(){const e=THREE.BufferGeometry.prototype.toJSON.call(this);return e.path=this.parameters.path.toJSON(),e}}r.TubeGeometry=e}(),r.Ground=class{constructor(e){e=r.Utils.defaultValue(e,{}),this._referencePlane=new THREE.Plane,this._elevation=r.Utils.defaultValue(e.elevation,0);const t=r.Utils.defaultValue(e.position,new THREE.Vector3(0,0,0));t.y=this._elevation,this._position=t,this._direction=r.Utils.defaultValue(e.direction,new THREE.Vector3(0,1,0)),this._referencePlane.setFromNormalAndCoplanarPoint(this._direction,this._position),this._scratchInsertPoint=null}get elevation(){return this._elevation}show(){}hide(){}remove(){this._referencePlane=null}update(){}setColor(){}setElevation(e){this._position.y=e,this._elevation=e,this._referencePlane.setFromNormalAndCoplanarPoint(this._direction,this._position)}getElevation(){return this._elevation}intersect(e){return this._scratchInsertPoint||(this._scratchInsertPoint=new THREE.Vector3),e.intersectPlane(this._referencePlane,this._scratchInsertPoint)}},function(){class e extends THREE.MeshBasicMaterial{constructor(e){super(e),this.type="BlinkMeshBasicMaterial";var t=r.Blink.DefaultBlinkColor;this.blinkColor=new THREE.Vector4(t.color.r,t.color.g,t.color.b,t.opacity),this.blinkCoefficient=0,this.uniforms=THREE.UniformsUtils.merge([THREE.ShaderLib.basic.uniforms,{blinkColor:{value:this.blinkColor.clone()},blinkCoefficient:{value:0}}]),this.vertexShader=THREE.ShaderLib.basic.vertexShader,this.fragmentShader=this._getFragmentShader(THREE.ShaderLib.basic.fragmentShader)}destroy(){this.blinkColor=null,this.uniforms=null,this.dispose()}copy(e){super.copy(e),e.blinkColor&&this.blinkColor.copy(e.blinkColor),e.blinkCoefficient&&(this.blinkCoefficient=e.blinkCoefficient)}setBlinkColor(e){this.blinkColor.fromArray(e.toArray()),this.uniforms.blinkColor.value.copy(this.blinkColor),this.uniforms.blinkCoefficient.value=this.blinkCoefficient}resetBlinkUniformValue(){this.uniforms.blinkColor.value.copy(this.blinkColor),this.uniforms.blinkCoefficient.value=this.blinkCoefficient}updateBlinkUniformValue(e,t,i){this.uniforms.blinkColor.value.copy(t),this.uniforms.blinkCoefficient.value=i}_getFragmentShader(e){var t=e.replace("uniform float opacity;","uniform float opacity;\n                uniform vec4 blinkColor;\n                uniform float blinkCoefficient;");return t=t.replace("#include <fog_fragment>","\n                gl_FragColor = mix(gl_FragColor, blinkColor, blinkCoefficient);\n                #include <fog_fragment>")}}class t extends THREE.MeshStandardMaterial{constructor(e){super(e),this.type="BlinkMeshStandardMaterial";var t=r.Blink.DefaultBlinkColor;this.blinkColor=new THREE.Vector4(t.color.r,t.color.g,t.color.b,t.opacity),this.blinkCoefficient=0,this.uniforms=THREE.UniformsUtils.merge([THREE.ShaderLib.basic.uniforms,{blinkColor:{value:this.blinkColor.clone()},blinkCoefficient:{value:0}}]),this.vertexShader=THREE.ShaderLib.standard.vertexShader,this.fragmentShader=this._getFragmentShader(THREE.ShaderLib.standard.fragmentShader)}destroy(){this.blinkColor=null,this.uniforms=null,this.dispose()}copy(e){super.copy(e),e.blinkColor&&this.blinkColor.copy(e.blinkColor),e.blinkCoefficient&&(this.blinkCoefficient=e.blinkCoefficient)}setBlinkColor(e){this.blinkColor.fromArray(e.toArray()),this.uniforms.blinkColor.value.copy(this.blinkColor),this.uniforms.blinkCoefficient.value=this.blinkCoefficient}resetBlinkUniformValue(){this.uniforms.blinkColor.value.copy(this.blinkColor),this.uniforms.blinkCoefficient.value=this.blinkCoefficient}updateBlinkUniformValue(e,t,i){this.uniforms.blinkColor.value.copy(t),this.uniforms.blinkCoefficient.value=i}_getFragmentShader(e){var t=e.replace("uniform float opacity;","uniform float opacity;\n                uniform vec4 blinkColor;\n                uniform float blinkCoefficient;");return t=t.replace("#include <dithering_fragment>","#include <dithering_fragment>\n                gl_FragColor = mix(gl_FragColor, blinkColor, blinkCoefficient);")}}class i extends THREE.MeshPhongMaterial{constructor(e){super(e),this.type="BlinkMeshBasicMaterial";var t=r.Blink.DefaultBlinkColor;this.blinkColor=new THREE.Vector4(t.color.r,t.color.g,t.color.b,t.opacity),this.blinkCoefficient=0,this.uniforms=THREE.UniformsUtils.merge([THREE.ShaderLib.phong.uniforms,{blinkColor:{value:this.blinkColor.clone()},blinkCoefficient:{value:0}}]),this.vertexShader=THREE.ShaderLib.phong.vertexShader,this.fragmentShader=this._getFragmentShader(THREE.ShaderLib.phong.fragmentShader)}destroy(){this.blinkColor=null,this.uniforms=null,this.dispose()}copy(e){super.copy(e),e.blinkColor&&this.blinkColor.copy(e.blinkColor),e.blinkCoefficient&&(this.blinkCoefficient=e.blinkCoefficient)}setBlinkColor(e){this.blinkColor.fromArray(e.toArray()),this.uniforms.blinkColor.value.copy(this.blinkColor),this.uniforms.blinkCoefficient.value=this.blinkCoefficient}resetBlinkUniformValue(){this.uniforms.blinkColor.value.copy(this.blinkColor),this.uniforms.blinkCoefficient.value=this.blinkCoefficient}updateBlinkUniformValue(e,t,i){this.uniforms.blinkColor.value.copy(t),this.uniforms.blinkCoefficient.value=i}_getFragmentShader(e){var t=e.replace("uniform float opacity;","uniform float opacity;\n                uniform vec4 blinkColor;\n                uniform float blinkCoefficient;");return t=t.replace("#include <dithering_fragment>","#include <dithering_fragment>\n                gl_FragColor = mix(gl_FragColor, blinkColor, blinkCoefficient);")}}class a extends THREE.MeshLambertMaterial{constructor(e){super(e),this.type="BlinkMeshBasicMaterial";var t=r.Blink.DefaultBlinkColor;this.blinkColor=new THREE.Vector4(t.color.r,t.color.g,t.color.b,t.opacity),this.blinkCoefficient=0,this.uniforms=THREE.UniformsUtils.merge([THREE.ShaderLib.lambert.uniforms,{blinkColor:{value:this.blinkColor.clone()},blinkCoefficient:{value:0}}]),this.vertexShader=THREE.ShaderLib.lambert.vertexShader,this.fragmentShader=this._getFragmentShader(THREE.ShaderLib.lambert.fragmentShader)}destroy(){this.blinkColor=null,this.uniforms=null,this.dispose()}copy(e){super.copy(e),e.blinkColor&&this.blinkColor.copy(e.blinkColor),e.blinkCoefficient&&(this.blinkCoefficient=e.blinkCoefficient)}setBlinkColor(e){this.blinkColor.fromArray(e.toArray()),this.uniforms.blinkColor.value.copy(this.blinkColor),this.uniforms.blinkCoefficient.value=this.blinkCoefficient}resetBlinkUniformValue(){this.uniforms.blinkColor.value.copy(this.blinkColor),this.uniforms.blinkCoefficient.value=this.blinkCoefficient}updateBlinkUniformValue(e,t,i){this.uniforms.blinkColor.value.copy(t),this.uniforms.blinkCoefficient.value=i}_getFragmentShader(e){var t=e.replace("uniform float opacity;","uniform float opacity;\n                uniform vec4 blinkColor;\n                uniform float blinkCoefficient;");return t=t.replace("#include <dithering_fragment>","#include <dithering_fragment>\n                gl_FragColor = mix(gl_FragColor, blinkColor, blinkCoefficient);")}}class n extends THREE.LineBasicMaterial{constructor(e){super(e),this.type="BlinkLineBasicMaterial";var t=r.Blink.DefaultBlinkColor;this.blinkColor=new THREE.Vector4(t.color.r,t.color.g,t.color.b,t.opacity),this.blinkCoefficient=0,this.uniforms=THREE.UniformsUtils.merge([THREE.ShaderLib.basic.uniforms,{blinkColor:{value:this.blinkColor.clone()},blinkCoefficient:{value:0}}]),this.vertexShader=THREE.ShaderLib.basic.vertexShader,this.fragmentShader=this._getFragmentShader(THREE.ShaderLib.basic.fragmentShader)}destroy(){this.blinkColor=null,this.uniforms=null,this.dispose()}copy(e){super.copy(e),e.blinkColor&&this.blinkColor.copy(e.blinkColor),e.blinkCoefficient&&(this.blinkCoefficient=e.blinkCoefficient)}setBlinkColor(e){this.blinkColor.fromArray(e.toArray()),this.uniforms.blinkColor.value.copy(this.blinkColor),this.uniforms.blinkCoefficient.value=this.blinkCoefficient}resetBlinkUniformValue(){this.uniforms.blinkColor.value.copy(this.blinkColor),this.uniforms.blinkCoefficient.value=this.blinkCoefficient}updateBlinkUniformValue(e,t,i){this.uniforms.blinkColor.value.copy(t),this.uniforms.blinkCoefficient.value=i}_getFragmentShader(e){var t=e.replace("uniform float opacity;","uniform float opacity;\n                uniform vec4 blinkColor;\n                uniform float blinkCoefficient;");return t=t.replace("#include <fog_fragment>","\n                gl_FragColor = mix(gl_FragColor, blinkColor, blinkCoefficient);\n                #include <fog_fragment>")}}class s extends THREE.PointsMaterial{constructor(e){super(e),this.type="BlinkPointsMaterial";var t=r.Blink.DefaultBlinkColor;this.blinkColor=new THREE.Vector4(t.color.r,t.color.g,t.color.b,t.opacity),this.blinkCoefficient=0,this.uniforms=THREE.UniformsUtils.merge([THREE.ShaderLib.points.uniforms,{blinkColor:{value:this.blinkColor.clone()},blinkCoefficient:{value:0}}]),this.vertexShader=THREE.ShaderLib.points.vertexShader,this.fragmentShader=this._getFragmentShader(THREE.ShaderLib.points.fragmentShader)}destroy(){this.blinkColor=null,this.uniforms=null,this.dispose()}copy(e){super.copy(e),e.blinkColor&&this.blinkColor.copy(e.blinkColor),e.blinkCoefficient&&(this.blinkCoefficient=e.blinkCoefficient)}setBlinkColor(e){this.blinkColor.fromArray(e.toArray()),this.uniforms.blinkColor.value.copy(this.blinkColor),this.uniforms.blinkCoefficient.value=this.blinkCoefficient}resetBlinkUniformValue(){this.uniforms.blinkColor.value.copy(this.blinkColor),this.uniforms.blinkCoefficient.value=this.blinkCoefficient}updateBlinkUniformValue(e,t,i){this.uniforms.blinkColor.value.copy(t),this.uniforms.blinkCoefficient.value=i}_getFragmentShader(e){var t=e.replace("uniform float opacity;","uniform float opacity;\n                uniform vec4 blinkColor;\n                uniform float blinkCoefficient;");return t=t.replace("#include <fog_fragment>","\n                gl_FragColor = mix(gl_FragColor, blinkColor, blinkCoefficient);\n                #include <fog_fragment>")}}r.Blink=r.Blink||{},r.Blink.MeshBasicMaterial=e,r.Blink.MeshStandardMaterial=t,r.Blink.MeshPhongMaterial=i,r.Blink.MeshLambertMaterial=a,r.Blink.LineBasicMaterial=n,r.Blink.PointsMaterial=s,r.Blink.DefaultBlinkColor={color:(new THREE.Color).setHex(3330982),opacity:1},r.Blink.MaterialFactory={MeshBasicMaterial:function(e){return new r.Blink.MeshBasicMaterial(e)},MeshStandardMaterial:function(e){return new r.Blink.MeshStandardMaterial(e)},MeshPhongMaterial:function(e){return new r.Blink.MeshPhongMaterial(e)},MeshLambertMaterial:function(e){return new r.Blink.MeshLambertMaterial(e)},LineBasicMaterial:function(e){return new r.Blink.LineBasicMaterial(e)},PointsMaterial:function(e){return new r.Blink.PointsMaterial(e)}}}(),(()=>{var e=new THREE.Matrix4;class t extends r.ObjectGroup{constructor(){super(r.ObjectGroupType.AXISGRIDMANAGER,{priority:20}),this.globalSpace=!0,this.materialMap={},this.meshUuidMap={},this.floorHeightMap={},this.gridLineColor="#333333",this.gridBubbleColor="#000000",this.bEnableHover=!0,this.mapAxisTypes={GRIDLINE:"GRIDLINE",GRIDBUBBLE:"GRIDBUBBLE"},this.translateMatrix=new THREE.Matrix4,this.bHasTranslation=!1,this.mapTranslateDelta={},this.mapLinkFloorId={},this.mapFileIdGridjson={},this.mapIntersectAxisLines={},this.modelTransformation=new THREE.Matrix4}getAxisGridState(){var e={},t=this.meshUuidMap,i=[];for(var r in t)if(t.hasOwnProperty(r)){var a=[];for(var n in t[r])if(t[r].hasOwnProperty(n)&&0!==Object.keys(t[r][n]).length){var s={};s.id=n,s.height=this.floorHeightMap[r][n].height,a.push(s)}i.push({fileId:r,floorInfos:a})}var o={};return e.hasOwnProperty("default")?o.fileInfos={fileId:"",floorInfos:e.default}:o.fileInfos=i,o.gridLineColor=this.gridLineColor,o.gridBubbleColor=this.gridBubbleColor,o}addMeshUuidInMap(e,t,i,r){var a=this.meshUuidMap;a.hasOwnProperty(e)||(a[e]={}),a[e].hasOwnProperty(t)||(a[e][t]={}),a[e][t].hasOwnProperty(i)||(a[e][t][i]={}),a[e][t][i][r]=!0}addFloorHeightInMap(e,t,i){var r=this.floorHeightMap;r.hasOwnProperty(e)||(r[e]={}),r[e].hasOwnProperty(t)||(r[e][t]={});var a=e+"_"+t;r[e][t]={height:i,translation:this.mapTranslateDelta[a]}}removeFloorHeightInMap(e,t){var i=this.floorHeightMap;i.hasOwnProperty(e)&&i[e].hasOwnProperty(t)&&delete i[e][t]}addLinesNode(e,t,i,a,n,s){var o=new THREE.BufferGeometry;o.setAttribute("position",new THREE.Float32BufferAttribute(e,3));var l=new THREE.Line(o,t);l.renderOrder=r.EnumRenderOrder.Effect,l.name=s,this.add(l),this.addMeshUuidInMap(i,a,n,l.uuid),this.updateMatrixWorld(!0)}getLabelCanvas(e,t="#000000"){const i=document.createElement("canvas"),a=i.getContext("2d"),n='16px -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Helvetica,"PingFang SC","Hiragino Sans GB","Microsoft YaHei",SimSun,sans-serif';a.font=n;const s=a.measureText(e),{width:o,actualBoundingBoxAscent:l}=s,d=Math.max(r.MaterialUtil.nextHighestPowerOfTwo(o),r.MaterialUtil.nextHighestPowerOfTwo(l));return i.width=d,i.height=d,a.font=n,a.fillStyle=t,a.fillText(e,(d-o)/2,(d+l)/2),{canvas:i,size:d}}addLabelNodes(e,t,i,a,n){const{canvas:s,size:o}=this.getLabelCanvas(e.name),l=new THREE.CanvasTexture(s);e.label.positions.forEach((s=>{const d={...s,z:n||0},h=this.translate(t,i,d),c=new r.PointsMaterial({sizeAttribute:!0,map:l,depthTest:!0,alphaTest:.001,transparent:!0}),u=new Float32Array(3),p=new Float32Array(1),m=new Uint8Array(1);h.toArray(u,0),p[0]=o,m[0]=0;const f=new THREE.BufferGeometry;f.setAttribute("position",new THREE.BufferAttribute(u,3)),f.setAttribute("attrSize",new THREE.BufferAttribute(p,1)),f.setAttribute("attrHoverAnimation",new THREE.BufferAttribute(m,1));const g=new r.PointsEx(f,c);g.name=`${this.mapAxisTypes.GRIDBUBBLE}_${e.name}`,this.add(g),g.matrixAutoUpdate=!1,g.updateMatrixWorld(!0),this.addMeshUuidInMap(t,i,a,g.uuid),this.updateMatrixWorld(!0)}))}createMaterial(e,t){return this.materialMap.hasOwnProperty(e)||(this.materialMap[e]={}),this.materialMap[e][t.color]||("string"!=typeof t.color&&(t.color="#"+t.color.getHEX()),this.materialMap[e][t.color]=r.MaterialUtil.createStandardMaterial(t)),this.materialMap[e][t.color]}loadAxisGridsByHeight(e,i,r,a,n){var s=this,o=new THREE.FileLoader;this.axisGridHeight=r,null!=r&&this.addFloorHeightInMap(i,a,r),o.load(e,(function(o){var l=t.adaptGridData(JSON.parse(o));s.gridsJson=l;var d=l.grids.length,h=d;if(d&&d>0){var c=i+"_"+a;s.mapFileIdGridjson[i]||(s.mapFileIdGridjson[i]=l);for(var u=0;u<d;u++){var p=s.mapLinkFloorId[c]||a;if(-1==p.toString().indexOf("_")){var m=l.grids[u].floors;if(null!=m&&-1==m.indexOf(p.toString())){s.floorHeightMap[i][a].hideAxisGridIndex||(s.floorHeightMap[i][a].hideAxisGridIndex=[]),s.floorHeightMap[i][a].hideAxisGridIndex.push(u),0==--h&&n&&n();continue}}s.loadAxisGrid(e,i,u,r,a,(function(){0==--h&&n&&n()}))}}else console.warn("There is no grid on this floor.")}))}unloadAxisGridsByFloor(e,t){var i=this.children,r=this.meshUuidMap;if(r.hasOwnProperty(e)&&r[e].hasOwnProperty(t)){for(var a in r[e][t]){for(var n=r[e][t][a],s=0;s<i.length;){n[i[s].uuid]?i.splice(s,1):s++}delete r[e][t][a]}this.removeFloorHeightInMap(e,t)}}loadAxisGrid(e,i,r,a,n,s){var o=e.split("/");null==a&&(n=o[o.length-1].split(".")[0]);var l=0,d=this.gridsJson;if(r&&r>=0){if(!(r<d.grids.length))return void console.log("Input grid index is invalid.");l=r}const{color:h}=d.grids[l],c=d.grids[l].geometry,u=h||this.gridLineColor,p=this.mapAxisTypes.GRIDLINE,m=this.createMaterial(p,{color:u,side:THREE.DoubleSide}),f=[];c.forEach((e=>{if("Line"===e.lineType)f.push(e.startPoint,e.endPoint);else if("Arc"===e.lineType){const i=t.getArcGridPoints(e);f.push(...i)}e.linePoints=f}));const g=this.prepareLinesBuffer(i,n,f,a);this.addLinesNode(g,m,i,n,l,p),this.addLabelNodes(d.grids[l],i,n,l,a),s&&s()}prepareLinesBuffer(e,t,i,r){const a=[];return i.forEach((i=>{const n={...i};n.z=r||0;const s=this.translate(e,t,n);a.push(...Object.values(s))})),a}unloadAxisGrid(e,t,i){var r=this.children,a=this.meshUuidMap;if(a.hasOwnProperty(e)&&a[e].hasOwnProperty(t)&&a[e][t].hasOwnProperty(i)){for(var n=a[e][t][i],s=0;s<r.length;){n[r[s].uuid]?r.splice(s,1):s++}delete a[e][t][i]}}unloadAllAxisGrids(){var e=this.meshUuidMap;for(var t in e)if(e.hasOwnProperty(t))for(var i in e[t])if(e[t].hasOwnProperty(i)){for(var r in e[t][i])e[t][i].hasOwnProperty(r)&&this.unloadAxisGrid(t,i,r);this.removeFloorHeightInMap(t,i)}}enableDepthTest(e){for(var t=this.children,i=0;i<t.length;i++)t[i].material.depthTest=e}formatHidedAxisGridIndex(e,t,i){e||(e="default");let r=this.floorHeightMap[e]={},a=0;for(const e of t.grids){let t=e.floors;for(const e of i){0==r.hasOwnProperty(e)&&(r[e]={});let i=r[e];-1==t.indexOf(e)&&(0==i.hasOwnProperty("hideAxisGridIndex")&&(i.hideAxisGridIndex=[]),i.hideAxisGridIndex.push(a))}a++}}getHidedAxisGridIndex(e,t){e||(e="default");let i=this.floorHeightMap[e][t];return i.hasOwnProperty("hideAxisGridIndex")?i.hideAxisGridIndex:[]}prepareGridLines(e,t,i){if(e){null==t&&(t=[0,0,0]),this.verticalLines=[],this.horizontalLines=[];var r=e.grids;for(let e=0;e<r.length;e++){if(i&&i.indexOf(e)>=0)continue;let n=r[e].geometry[0];if("Line"!==n.lineType)continue;var a=[0,0,0,0,0,0];a.name=r[e].name;const s=this.modelTransformation.clone(),o=new THREE.Vector3(n.startPoint.x+t[0],n.startPoint.y+t[1],0).applyMatrix4(s),l=new THREE.Vector3(n.endPoint.x+t[0],n.endPoint.y+t[1],0).applyMatrix4(s);a[0]=o.x,a[1]=o.y,a[3]=l.x,a[4]=l.y,Math.abs(n.startPoint.x-n.endPoint.x)<Math.abs(n.startPoint.y-n.endPoint.y)?this.horizontalLines.push(a):this.verticalLines.push(a)}}}getNearestIntersection(e,t){let i={dist:Number.MAX_SAFE_INTEGER,intersect:null};e=new THREE.Vector3(e.x,e.y,e.z);for(const r of this.intersections){let a=r.clone();a.z=t;let n=a.distanceTo(e);n<i.dist&&(i.dist=n,i.intersect=r)}return i}getIntersectLines(e){return this.mapIntersectAxisLines[e]}destroy(){this.mapIntersectAxisLines=null,this.horizontalLines=null,this.verticalLines=null,this.intersections=null,this.floorHeightMap=null,this.mapTranslateDelta=null,this.mapLinkFloorId=null,this.mapFileIdGridjson=null}calculateIntersections(e){var t,i,r,a;null==e&&(e=[0,0,0]),this.intersections=[];var n=this.horizontalLines.length,s=this.verticalLines.length;for(let l=0;l<n;l++){const n=this.horizontalLines[l];n[0]+=e[0],n[1]+=e[1],n[3]+=e[0],n[4]+=e[1],t=new THREE.Vector2(n[0],n[1]),i=new THREE.Vector2(n[3],n[4]);for(let l=0;l<s;l++){const s=this.verticalLines[l];s[0]+=e[0],s[1]+=e[1],s[3]+=e[0],s[4]+=e[1],r=new THREE.Vector2(s[0],s[1]),a=new THREE.Vector2(s[3],s[4]);const d=this.computeSegmentsIntersect(t,i,r,a);if(d){var o=new THREE.Vector3(d.x,d.y,this.axisGridHeight);o.name=n.name+s.name,this.mapIntersectAxisLines.hasOwnProperty(o.name)||(this.mapIntersectAxisLines[o.name]=[]),this.mapIntersectAxisLines[o.name].push(n),this.mapIntersectAxisLines[o.name].push(s),this.intersections.push(o)}}}}getAxisGridHeight(){return this.axisGridHeight}getAxisGridPlane(e){var t=new THREE.Plane;return t.setFromNormalAndCoplanarPoint(new THREE.Vector3(0,0,1),new THREE.Vector3(0,0,e)),t}getAxisGridPlanes(){var e=[],t=this.floorHeightMap;for(var i in t)if(t.hasOwnProperty(i))for(var r in t[i])if(t[i].hasOwnProperty(r)){var a=t[i][r].height,n=t[i][r].translation||[0,0,0];e.push(this.getAxisGridPlane(a+n[2]))}return e}snapOnFloors(e){var t=this.floorHeightMap,i=this.mapFileIdGridjson;if(0==Object.keys(i).length)return[];var r=0,a=[];for(var n in t)if(t.hasOwnProperty(n))for(var s in t[n])if(t[n].hasOwnProperty(s))if(null!=e[r]){var o=t[n][s].height,l=t[n][s].translation||[0,0,0];this.axisGridHeight=o+l[2];var d=t[n][s].hasOwnProperty("hideAxisGridIndex")?t[n][s].hideAxisGridIndex:null;this.prepareGridLines(i[n],l,d),a.push(this.snaping(e[r++],l))}else r++;return a}snaping(e,t){this.calculateIntersections(t);var i={toIntersection:1/0,toGridLine:1/0},r={toIntersection:new THREE.Vector3,toGridLine:new THREE.Vector3};for(let t=0;t<this.intersections.length;t++){let n=this.intersections[t].clone();n.name=this.intersections[t].name;var a=n.distanceTo(e);a<i.toIntersection&&(i.toIntersection=a,r.toIntersection=n)}var n=null,s=0;const o=t=>{const a=new THREE.Line3(new THREE.Vector3(t[0],t[1],this.axisGridHeight),new THREE.Vector3(t[3],t[4],this.axisGridHeight)),o=new THREE.Vector3;a.closestPointToPoint(e,!0,o),(s=new THREE.Line3(e,o).distance())<i.toGridLine&&(i.toGridLine=s,n=t,r.toGridLine=o)};for(let e=0;e<this.horizontalLines.length;e++){o(this.horizontalLines[e])}for(let e=0;e<this.verticalLines.length;e++){o(this.verticalLines[e])}var l={};return l.intersectLines=this.mapIntersectAxisLines[r.toIntersection.name],l.gridLine=n,{point:e,height:this.axisGridHeight,snapLines:l,nearestPoint:r,minDistance:i}}setGridBubblesColor(e){this.gridBubbleColor=e;for(var t=this.children,i=0;i<t.length;i++)if(t[i].name.indexOf(this.mapAxisTypes.GRIDBUBBLE)>=0){const r=t[i].name.slice(t[i].name.lastIndexOf("_")+1),{canvas:a}=this.getLabelCanvas(r,`rgba(${e.red}, ${e.green}, ${e.blue}, ${e.alpha})`),n=new THREE.CanvasTexture(a);t[i].material.map&&t[i].material.map.dispose(),t[i].material.map=n}}getGridBubblesColor(){return this.gridBubbleColor}setGridLinesColor(e){this.gridLineColor=e;for(var t=this.children,i=0;i<t.length;i++)t[i].name==this.mapAxisTypes.GRIDLINE&&(t[i].material.color=new THREE.Color(e.red/255,e.green/255,e.blue/255),t[i].material.alpha=e.alpha)}getGridLinesColor(){return this.gridLineColor}getElements(){return this.children}setIsEnableHover(e){this.bEnableHover=e}getIsEnableHover(){return this.bEnableHover}setTranslation(e,t,i,r,a){var n=e+"_"+t;this.mapTranslateDelta[n]=[i,r,a]}translate(e,t,i){var r=e+"_"+t,a=this.mapTranslateDelta[r],n=new THREE.Vector3(i.x,i.y,i.z);return a&&(this.translateMatrix.makeTranslation(a[0],a[1],a[2]),n.applyMatrix4(this.translateMatrix)),n}setLinkFloorId(e,t,i){var r=e+"_"+t;this.mapLinkFloorId[r]=i}getIntersectPoints(t,i){var r=[];e.copy(i).invert();var a=this.getAxisGridPlanes();for(const n of a){n.applyMatrix4(i);let a=new THREE.Vector3;t.ray.intersectPlane(n,a),a&&a.applyMatrix4(e),r.push(a)}return r}getAxisGridsIntersection(e,t,i){i||"[object Array]"!==Object.prototype.toString.call(t)||(i=t,t=e,e="default");var r=this.computeIntersection(e,i),a=this.floorHeightMap[e][t].height,n={};for(var s in r)for(var o=r[s],l=0;l<o.intersects.length;l++){var d=o.intersects[l];d.intersectPoint.z=a;var h={intersection:d.intersectPoint,axisGrids:d.axisGrids};n[d.name]=h}return Object.values(n)}computeIntersection(e,t){t||"[object Array]"!==Object.prototype.toString.call(e)||(t=e,e="default"),t=t.map((e=>e.toString()));for(var i=this.mapFileIdGridjson[e].grids.filter((e=>t.indexOf(e.name)>=0)),r={},a=0;a<i.length-1;a++){var n,s=i[a];r[s.name]?n=r[s.name].lineSegments:(n=this.getGridLineSegments(s),r[s.name]={lineSegments:n,intersects:[]});for(var o=a+1;o<i.length;o++){var l,d=i[o];r[d.name]?l=r[d.name].lineSegments:(l=this.getGridLineSegments(d),r[d.name]={lineSegments:l,intersects:[]});for(var h=0,c=0;c<n.length;c++)for(var u=n[c],p=0;p<l.length;p++){var m=l[p],f=this.computeSegmentsIntersect(u[0],u[1],m[0],m[1]);f&&(r[s.name].intersects.push({name:`${s.name}_${d.name}_${h}`,axisGrids:[s.name,d.name],intersectPoint:f,segmentNum:c}),r[d.name].intersects.push({name:`${s.name}_${d.name}_${h}`,axisGrids:[s.name,d.name],intersectPoint:f,segmentNum:p}),h++)}}}return r}getPartitionDataByAxisGrids(e,t){t||"[object Array]"!==Object.prototype.toString.call(e)||(t=e,e="default");var i=this.computeIntersection(e,t),r={},a=0;for(u in i){var n=i[u];n.intersects.sort(((e,t)=>{if(e.segmentNum!==t.segmentNum)return e.segmentNum-t.segmentNum;var i=n.lineSegments[e.segmentNum][0],r=e.intersectPoint,a=t.intersectPoint;return(r.x-i.x)*(r.x-i.x)+(r.y-i.y)*(r.y-i.y)-((a.x-i.x)*(a.x-i.x)+(a.y-i.y)*(a.y-i.y))}));for(var s=1;s<n.intersects.length;s++){if((f={origin:n.intersects[s].name,target:n.intersects[s-1].name,id:a++,linePoints:[n.intersects[s].intersectPoint]}).axis=u,n.intersects[s].segmentNum>n.intersects[s-1].segmentNum)for(var o=n.intersects[s].segmentNum;o>n.intersects[s-1].segmentNum;o--)f.linePoints.push(n.lineSegments[o][0]);else if(n.intersects[s].segmentNum<n.intersects[s-1].segmentNum)for(o=n.intersects[s].segmentNum;o<n.intersects[s-1].segmentNum;o++)f.linePoints.push(n.lineSegments[o][1]);f.linePoints.push(n.intersects[s-1].intersectPoint),r[n.intersects[s].name]||(r[n.intersects[s].name]={subLines:[],name:n.intersects[s].name}),r[n.intersects[s].name].subLines.push(f),r[n.intersects[s-1].name]||(r[n.intersects[s-1].name]={subLines:[],name:n.intersects[s-1].name});for(var l={origin:f.target,target:f.origin,id:f.id,axis:f.axis,linePoints:[]},d=f.linePoints.length-1;d>=0;d--)l.linePoints.push(f.linePoints[d]);r[n.intersects[s-1].name].subLines.push(l)}}var h=[],c=e=>{var t=e[e.length-1].subLine;if(!t.used){for(var i,a=t.linePoints,n=a[a.length-1],s=a[a.length-2],o=new THREE.Vector2(s.x-n.x,s.y-n.y),l=r[t.target],d=2*Math.PI,u=0;u<l.subLines.length;u++){var p=l.subLines[u];if(p.id!==t.id){var m=p.linePoints,f=m[0],g=m[1],v=new THREE.Vector2(g.x-f.x,g.y-f.y).angle()-o.angle();v<0&&(v+=2*Math.PI),v>=0&&v<d&&(d=v,i=p)}}if(i)if(e.push({intersect:l,subLine:i,angle:d}),i.target===e[0].subLine.target){var y=0;e.forEach((e=>{e.subLine.used=!0,y+=e.angle||0})),y-(e.length-1)*Math.PI<.001&&h.push(e)}else c(e)}};for(var u in r){var p=r[u],m=p.subLines;for(s=0;s<m.length;s++){var f=m[s];c([{intersect:p,subLine:f}])}}return h}getPartitionByAxisGrids(e,t){t||"[object Array]"!==Object.prototype.toString.call(e)||(t=e,e="default");var i,r=this.getPartitionDataByAxisGrids(e,t);if(1===r.length){var a=r[0].slice(1,r[0].length);(i=[]).push(a[0].subLine.linePoints[0]),a.forEach((e=>{var t=e.subLine.linePoints.slice(1,e.subLine.linePoints.length);i=i.concat(t)}))}else if(r.length>1)for(var n=0;n<r.length;n++){var s=new Set,o=(a=r[n].slice(1,r[n].length),[]);if(o.push(a[0].subLine.linePoints[0]),a.forEach((e=>{s.add(e.subLine.axis);var t=e.subLine.linePoints.slice(1,e.subLine.linePoints.length);o=o.concat(t)})),s.size===t.length){i=o;break}}return i}getGridLineSegments(e){const t=[];return e.geometry.forEach((e=>{if("Line"===e.lineType)t.push([e.startPoint,e.endPoint]);else if("Arc"===e.lineType)for(let i=0;i<e.linePoints.length-1;i++)t.push([e.linePoints[i],e.linePoints[i+1]])})),t}computeSegmentsIntersect(e,t,i,r){var a=(e.x-i.x)*(t.y-i.y)-(e.y-i.y)*(t.x-i.x),n=(e.x-r.x)*(t.y-r.y)-(e.y-r.y)*(t.x-r.x);if(a*n>0)return!1;var s=(i.x-e.x)*(r.y-e.y)-(i.y-e.y)*(r.x-e.x);if(s*((i.x-t.x)*(r.y-t.y)-(i.y-t.y)*(r.x-t.x))>0)return!1;var o=s/(n-a),l=o*(t.x-e.x),d=o*(t.y-e.y);let h=e.x+l,c=e.y+d;const u=this.modelTransformation.clone();return new THREE.Vector3(h,c,0).applyMatrix4(u)}}t.getInstance=function(e,i){return e.axisGridManagerMap||(e.axisGridManagerMap={},e.axisGridEnableHover=!0),e.axisGridManagerMap[i]||(e.axisGridManagerMap[i]=new r.AxisGridManager(e),e.objectGroups.add(e.axisGridManagerMap[i]),t.updateTransformation(e,i)),e.axisGridManagerMap[i]},t.updateTransformation=function(e,t){if(!e.axisGridManagerMap)return;const i=e.axisGridManagerMap[t];if(!i)return;const[r]=e.objectGroups.children.filter((e=>e.name.includes(`|${t}`)));r?i.matrix.copy(r.matrix):i.matrix.copy(e.geometryGroup.matrix),i.matrixAutoUpdate=!1,i.updateMatrixWorld(!0);const a=e.getMatrixGlobal(),n=(new THREE.Matrix4).copy(a).invert();i.modelTransformation=i.matrix.clone().premultiply(n)},t.setEnableHover=function(e,t){e.axisGridManagerMap&&(e.axisGridEnableHover=t)},t.adaptGridData=e=>{let t={grids:[]};return 2!==e.version?e.grids.forEach((e=>{const i={id:e.id,name:e.name,floors:e.floors,geometry:[],label:{positions:[]},color:""};e.gridLines.forEach((e=>{"Circle"!==e.type?i.geometry.push(...e.lines.map((e=>({startPoint:{x:e[0],y:e[1]},endPoint:{x:e[3],y:e[4]},lineType:"Line"})))):i.label.positions.push({x:e.circleCenter[0],y:e.circleCenter[1]})})),t.grids.push(i)})):t={...e},t},t.getArcGridPoints=e=>{const{centerPoint:t,startAngle:i,endAngle:r,radius:a}=e;return new THREE.EllipseCurve(t.x,t.y,a,a,i,r,!1,0).getPoints(50)},t.destroy=function(e){e.axisGridManagerMap=null},r.AxisGridManager=t})();class X extends r.ObjectGroup{constructor(){super(r.ObjectGroupType.CUSTOMPLANE,{priority:20}),this.globalSpace=!0}addPlane(e,t,i,a){var n=new THREE.Vector3;n.addVectors(new THREE.Vector3(e.x,e.y,e.z),new THREE.Vector3(t.x,t.y,t.z)),n.multiplyScalar(.5);var s=new THREE.PlaneBufferGeometry(t.x-e.x,t.y-e.y),o=new THREE.Mesh(s,new THREE.MeshBasicMaterial({side:THREE.DoubleSide,transparent:!0,depthTest:!0}));o.position.copy(n),o.renderOrder=r.EnumRenderOrder.ClipPlane,this.add(o),o.updateMatrixWorld(!0);var l=new THREE.TextureLoader;l.setCrossOrigin("anonymous"),l.load(i,(function(e){o.material.map=e,o.material.needsUpdate=!0,a&&a(o)}))}removePlane(e){e&&this.remove(e)}showPlane(e){e&&(e.visible=!0)}hidePlane(e){e&&(e.visible=!1)}setPlaneOpacity(e,t){e&&(e.material.opacity=t)}}X.getInstance=function(e){return null==e.customPlaneManager&&(e.customPlaneManager=new r.CustomPlaneManager,e.objectGroups.add(e.customPlaneManager),e.customPlaneManager.matrix.copy(e.geometryGroup.matrix),e.customPlaneManager.matrixAutoUpdate=!1,e.customPlaneManager.updateMatrixWorld(!0)),e.customPlaneManager},X.destroy=function(e){e.customPlaneManager=null},r.CustomPlaneManager=X,r.Marker3D=class{constructor(e){this._viewer=e,this._scene=e.getScene(),this._group=null,this._isHidden=!1,this._markersGroup={},this._textures={},this._defaultSize=32,this._defaultColor=16777215,this._textureLoader=new THREE.TextureLoader,this._textureLoader.setCrossOrigin("anonymous"),this.visibleState={}}loadTextures(e){let t=0;const i=e.length;let a=()=>{++t,t>=i&&(this.update(),this._viewer.render())};for(let t=0;t<i;++t){const i=e[t];void 0===this._textures[i]?this._textures[i]=this._textureLoader.load(i,(e=>{e.image=r.MaterialUtil.ensureQuadrate(e.image),a()}),void 0,(()=>{a()})):a()}}unloadTextures(){for(const e in this._textures)this._textures.hasOwnProperty(e)&&delete this._textures[e]}add(e){let t=[];const i=e.length;if(e&&e instanceof Array){for(let r=0;r<i;++r){const i=e[r],a={id:i.id?i.id:THREE.Math.generateUUID(),position:{x:i.position.x,y:i.position.y,z:i.position.z},size:i.size?i.size:this._defaultSize,iconUrl:i.iconUrl?i.iconUrl:null,tooltip:i.tooltip,hoverAnimation:0==i.hoverAnimation?0:1};let n;a.iconUrl?(n=a.iconUrl,t.push(a.iconUrl)):n=""+this._defaultColor,void 0===this._markersGroup[n]&&(this._markersGroup[n]=[]),null==this.visibleState[a.id]&&(this.visibleState[a.id]=!0),this._markersGroup[n].push(a)}this.loadTextures(t)}}remove(e){if(!e)return;const t=e.iconUrl?e.iconUrl:""+this._defaultColor;if(void 0===this._markersGroup[t])return;let i=!1;const r=this._markersGroup[t];for(var a=0,n=r.length;a<n;++a)if(r[a].id===e.id){r.splice(a,1),i=!0;break}i&&this.update()}removeById(e){let t=!1;for(const i in this._markersGroup){if(!this._markersGroup.hasOwnProperty(i))continue;const r=this._markersGroup[i],a=r.length;for(let i=0;i<a;++i)if(r[i].id===e){r.splice(i,1),t=!0;break}}t&&this.update()}getItemById(e){for(const t in this._markersGroup){if(!this._markersGroup.hasOwnProperty(t))continue;const i=this._markersGroup[t],r=i.length;for(let t=0;t<r;++t){const r=i[t];if(r.id===e)return{id:r.id,position:{x:r.position.x,y:r.position.y,z:r.position.z},size:r.size,iconUrl:r.iconUrl,tooltip:r.tooltip,hoverAnimation:r.hoverAnimation}}}return null}getItems(){let e=[];for(const t in this._markersGroup){if(!this._markersGroup.hasOwnProperty(t))continue;const i=this._markersGroup[t],r=i.length;for(let t=0;t<r;++t){const r=i[t];e.push({id:r.id,position:{x:r.position.x,y:r.position.y,z:r.position.z},size:r.size,iconUrl:r.iconUrl,tooltip:r.tooltip,hoverAnimation:r.hoverAnimation})}}return e.length>0?e:null}clear(){this._group&&this._group.clear(),this.unloadTextures();for(const e in this._markersGroup)this._markersGroup.hasOwnProperty(e)&&delete this._markersGroup[e];this.update()}activate(){this.clear()}deactivate(){this.clear(),this._group&&(this._scene.removeObjectGroup(this._group),this._group=null)}show(){this._group&&(this._group.visible=!0),this._isHidden=!1;for(let e in this.visibleState)this.visibleState.hasOwnProperty(e)&&(this.visibleState[e]=!0);this.update()}showByIds(e){if(this._group&&(this._group.visible=!0),this._isHidden=!1,!(e&&e instanceof Array))return;const t=e.length;for(let i=0;i<t;i++)this.visibleState[e[i]]=!0;this.update()}hide(){this._group&&(this._group.visible=!1),this._isHidden=!0;for(const e in this.visibleState)this.visibleState.hasOwnProperty(e)&&(this.visibleState[e]=!1);this.update()}hideByIds(e){if(!(e&&e instanceof Array))return;const t=e.length;for(var i=0;i<t;i++)this.visibleState[e[i]]=!1;this.update()}load(e){this.clear(),this.add(e),this.update()}_createParticle(e,t,i){const a=this._textures[i];let n=[];for(let i=0;i<t;++i){const t=e[i];t.isHideByClustering||this.visibleState[t.id]&&n.push(i)}const s=n.length;let o=new Float32Array(3*s);const l=new Float32Array(s),d=new Uint8Array(s);let h=new THREE.Vector3,c=0,u=[],p=0;n.map((t=>{const i=e[t];h.set(i.position.x,i.position.y,i.position.z),h.toArray(o,3*p),l[p]=i.size,d[p]=i.hoverAnimation,u.push(i.id),c<i.size&&(c=i.size),p++}));let m=new THREE.BufferGeometry;m.setAttribute("position",new THREE.BufferAttribute(o,3)),m.setAttribute("attrSize",new THREE.BufferAttribute(l,1)),m.setAttribute("attrHoverAnimation",new THREE.BufferAttribute(d,1));const f=new r.PointsMaterial({size:c,sizeAttenuation:!1,positionOffset:!0,sizeAttribute:!0,map:a,depthTest:!0,alphaTest:.001,transparent:!0});f.color.setHex(this._defaultColor);let g=new r.PointsEx(m,f);g.name=i,g.size=c,g.pointIds=u,1==r.GlobalData.IncrementRender?g.renderOrder=r.EnumRenderOrder.Effect:g.renderOrder=r.EnumRenderOrder.BeforeComponent,this._group.add(g),g.matrixAutoUpdate=!1,g.updateMatrixWorld(!0)}update(){if(!this._isHidden){this._group||(this._group=this._scene.getOrCreateObjectGroup(r.ObjectGroupType.MARKER3D,{pickableType:r.PICKABLETYPE.Marker3d,hoverEnabled:!0,priority:2,globalSpace:!0})),this._group.clear();for(const e in this._markersGroup){if(!this._markersGroup.hasOwnProperty(e))continue;const t=this._markersGroup[e],i=t.length;i<1||this._createParticle(t,i,e)}this._group.updateMatrixWorld(!0)}}},function(){class e extends r.Marker3D{constructor(e,t){super(e),this.shpPointId=t}update(){this._group||(this._group=this._scene.getOrCreateObjectGroup(`${r.ObjectGroupType.MARKER3D}|${this.shpPointId}`,{pickableType:r.PICKABLETYPE.Marker3d,hoverEnabled:!0,priority:2,globalSpace:!0})),super.update()}destroy(){this._group&&this._scene.removeObjectGroup(this._group),this._group=null,this._viewer=null,this._scene=null,this._markersGroup=null,this._textures=null,this._textureLoader=null,this.visibleState=null}}r.ShpPointMarker=e}(),r.LabelCollection=class{constructor(e){this.viewer=e,this.scene=e.getScene(),this.labelMap={}}destroy(){this.labelMap=null}addLabel(e){const t={id:e.id?e.id:THREE.Math.generateUUID(),position:{x:e.position.x,y:e.position.y,z:e.position.z},size:e.size?e.size:this.defaultFontSize,text:e.text?e.text:null,fontSize:e.fontSize?e.fontSize:24};if(null!=this.labelMap[t.id])return;this.labelMap[t.id]={},this.labelMap[t.id].info=t;let i=document.createElement("div");i.innerHTML=`<span style='font-size:${t.fontSize}px; color:black;pointer-events:none;'>${e.text}</br></span>`,i.style.display="none",i.style.position="absolute",i.style.pointerEvents="none",this.labelMap[t.id].visible=!0,this.labelMap[t.id].domLabel=i,this.viewer.domElement.parentNode.appendChild(i)}update(){var e=window.innerWidth,t=window.innerHeight;for(const i in this.labelMap){if(!1===this.labelMap[i].visible)continue;let r=this.labelMap[i].info.position;if(r=this.viewer.worldToClient(r),r.x<0||r.y<0||r.x>e||r.y>t)continue;let a=this.labelMap[i].domLabel;a.style.display="block",a.style.right="",a.style.left=r.x.toString()+"px",a.style.bottom="",a.style.top=r.y.toString()+"px"}}removeById(e){this.labelMap[e]&&this.labelMap[e].domLabel&&(this.viewer.domElement.parentNode.removeChild(this.labelMap[e].domLabel),delete this.labelMap[e])}showById(e){this.labelMap[e]&&(this.labelMap[e].visible=!0)}hideById(e){this.labelMap[e]&&(this.labelMap[e].visible=!1,this.labelMap[e].domLabel.style.display="none")}hideAll(){for(const e in this.labelMap)this.hideById(e)}},function(){new THREE.Vector3;r.ClipCapsManager=class{constructor(e){this.viewer=e,this.scene=e.getScene(),this.camera=e.camera,this.modelManager=e.modelManager;let t=e.getRenderer();this.size=new THREE.Vector2,t.getDrawingBufferSize(this.size),this.pixelRatio=t.getPixelRatio(),this.backSceneRenderTarget=new THREE.WebGLRenderTarget(this.size.x,this.size.y,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat}),this.needsUpdate=!0,this.viewer.registerEventListener(r.EVENTS.ON_TILES_LOAD_COMPLETE,(e=>{this.needsUpdate=!0})),this.viewer.registerEventListener(r.EVENTS.ON_TILES_LOAD_PROGRESS,(e=>{this.needsUpdate=!1})),this.hatchByMaterialForBox=!1,this.hatchByMaterialForPlane=!1,this.capsScene=new r.Scene,this.capMeshPrepared=!1,this.addedCapPlane=null,this.addedCapBox=null,this.isReverse=!1}render(e){if(0==r.GlobalData.ClippingCapsType||!r.GlobalData.ClippingCaps||this.modelManager.isBimtilesAsset()&&!1===this.needsUpdate)return;let t=this.scene,i=this.camera,a=this.viewer;const n=r.ExtrudeBodyManager.getInstance(a)._getAlphaTestNodeGroupVisible();r.ExtrudeBodyManager.getInstance(a)._setAlphaTestNodeGroupVisible(!1);var s=t.getObjectGroup(r.GlobalData.TilePlaneGroupName);s&&(s.preVisible=s.visible,s.visible=!1);const o=t.getObjectGroup(r.ObjectGroupType.CONTACTSHADOW);o&&(o.preVisible=o.visible,o.visible=!1),this._prepareCapScene(),this._renderBackSceneForCaps(e,t,i),e.autoClear&&(e.clear(),e.autoClear=!1),t.fillClipPlane&&t.fillClipPlane.updateCamera(a);var l=e.getContext(),d=e.state;d.buffers.stencil.setTest(!0),d.buffers.stencil.setLocked(!0),d.buffers.stencil.setFunc(l.ALWAYS,1,255),d.buffers.stencil.setOp(l.KEEP,l.KEEP,l.INCR),t.overrideMaterial=t.backMaterial,t.backFrontStencil=!0,e.render(t,i),d.buffers.stencil.setFunc(l.ALWAYS,1,255),d.buffers.stencil.setOp(l.KEEP,l.KEEP,l.DECR),t.overrideMaterial=t.frontMaterial,e.render(t,i),t.backFrontStencil=!1,d.buffers.stencil.setFunc(l.LEQUAL,1,255),d.buffers.stencil.setOp(l.KEEP,l.KEEP,l.KEEP),e.render(this.capsScene,i),d.buffers.stencil.setLocked(!1),d.buffers.stencil.setTest(!1),t.overrideMaterial=null,s&&(s.visible=s.preVisible),o&&(o.visible=o.preVisible),r.ExtrudeBodyManager.getInstance(a)._setAlphaTestNodeGroupVisible(n)}_renderBackSceneForCaps(e,t,i){if(!this.hatchByMaterialForBox&&!this.hatchByMaterialForPlane||0==r.GlobalData.ClippingCapsType)return;this._getBackScene();var a=e.getRenderTarget();let n=this.backSceneRenderTarget;e.setRenderTarget(n),e.clear(),e.render(this.backScene,i),e.setRenderTarget(a)}_getBackScene(){if(this.backScene&&!this.modelManager.isFilterApplied())return;this.backScene||(this.backScene=new THREE.Scene,this.backScene.matrixAutoUpdate=!1),this.backScene.clear();var e=this.modelManager.modelCollection;let t={},i=this;e.traverse((e=>{e.getMeshesForCap(t,"cap"),t[e.id]&&i.backScene.add(t[e.id])})),this.backScene.matrix.copy(this.scene.getMatrixGlobal()),this.backScene.updateMatrixWorld(!0)}setSize(e,t){let i=e*this.pixelRatio,r=t*this.pixelRatio;this.size.x==i&&this.size.y==r||(this.size.set(i,r),this.backSceneRenderTarget.setSize(i,r))}_prepareCapScene(){this.capMeshPrepared||(r.GlobalData.ClippingCapsType==r.EnumClippingCapsTypes.ClipBox?this._initCapBox(this.backSceneRenderTarget.texture,this.size,this.hatchByMaterialForBox):this._initCapPlane(this.backSceneRenderTarget.texture,this.size,this.hatchByMaterialForPlane)),this._createCapStencilMaterials()}_createCapStencilMaterials(){this.scene.backMaterial||(this.scene.backMaterial=new r.ClippingStencilMaterial({color:16711680,colorWrite:!1,depthWrite:!1,side:THREE.BackSide}),this.scene.frontMaterial=new r.ClippingStencilMaterial({color:255,colorWrite:!1,depthWrite:!1,side:THREE.FrontSide}),this.scene.backInstanceMaterial=new r.ClippingStencilMaterial({color:16711680,colorWrite:!1,depthWrite:!1,side:THREE.BackSide}),this.scene.backInstanceMaterial.defines.USE_INSTANCE="",this.scene.frontInstanceMaterial=new r.ClippingStencilMaterial({color:255,colorWrite:!1,depthWrite:!1,side:THREE.FrontSide}),this.scene.frontInstanceMaterial.defines.USE_INSTANCE="")}resetClippingCapsStatus(e){this.capMeshPrepared=!1,r.GlobalData.ClippingCapsType=null==e?r.EnumClippingCapsTypes.None:e,null!==this.addedCapPlane&&(this.capsScene.remove(this.addedCapPlane.lineMesh),this.capsScene.remove(this.addedCapPlane.planeMesh),this.addedCapPlane=null),null!==this.addedCapBox&&(this.capsScene.remove(this.addedCapBox),this.addedCapBox=null),this.scene.getOrCreateObjectGroup(r.ObjectGroupType.CAPSWIREFRAME).clear()}_initCapPlane(){var e=r.FillClipPlaneManager.getInstance(this.scene).initCapsPlane(this.backSceneRenderTarget.texture,this.size,this.hatchByMaterialForPlane);this.capsScene.add(e.lineMesh),this.capsScene.add(e.planeMesh),this.addedCapPlane=e,this.capMeshPrepared=!0}_initCapBox(){var e=r.ClipPlaneManager.getInstance(this.scene).initCapsBox(this.backSceneRenderTarget.texture,this.size,this.hatchByMaterialForBox);this.capsScene.add(e),this.addedCapBox=e,this.capMeshPrepared=!0}dispose(){this.viewer=null,this.scene=null,this.camera=null,this.modelManager=null,this.backSceneRenderTarget=null,this.capsScene=null,this.addedCapPlane=null,this.addedCapBox=null}_updateMaterial(e){this.viewer.modelManager.modelCollection.traverse((t=>{t.updateMaterialsValue("useForCap",e)}))}enableHatchByMaterial(e,t){t?this.hatchByMaterialForBox=e:this.hatchByMaterialForPlane=e,t&&this.addedCapBox&&(e?(this.addedCapBox.children[0].visible=!1,this.addedCapBox.children[1].material.defines.USE_CAP=""):(this.addedCapBox.children[0].visible=!0,delete this.addedCapBox.children[1].material.defines.USE_CAP)),!t&&this.addedCapPlane&&(e?(this.addedCapPlane.lineMesh.visible=!1,this.addedCapPlane.planeMesh.material.defines.USE_CAP=""):(this.addedCapPlane.lineMesh.visible=!0,delete this.addedCapPlane.planeMesh.material.defines.USE_CAP))}enableHatch(e){if(r.GlobalData.ClippingCapsType!=e&&r.GlobalData.ClippingCapsType!=r.EnumClippingCapsTypes.ClipPlane){r.GlobalData.ClippingCapsType=e?r.EnumClippingCapsTypes.ClipBox:r.EnumClippingCapsTypes.None;var t=r.ClipPlaneManager.getInstance(this.scene);t.capsWireframe&&(t.capsWireframe.visible=e),e&&t.reCalculateClippingIds()}}changeDirection(e,t,i){let a=[],n=this.scene;n.backMaterial&&(a.push(n.backMaterial),a.push(n.frontMaterial),a.push(n.backInstanceMaterial),a.push(n.frontInstanceMaterial)),a.forEach((t=>{t.clippingPlanes=e,t.clipIntersection=i}));var s=n.getOrCreateObjectGroup(r.ObjectGroupType.CAPSWIREFRAME).children;for(let e=0;e<s.length;e++)s[e].material.clippingPlanes=t;if(!this.addedCapBox||this.isReverse==i)return;let o=this.addedCapBox.children[0].children;for(let e=0;e<o.length;e++)i?o[e].material.defines.USE_OUTNORMAL="":delete o[e].material.defines.USE_OUTNORMAL;this.addedCapBox.children[1].material.side=i?THREE.BackSide:THREE.FrontSide,this.isReverse=i}}}(),function(){class e extends r.ObjectGroup{constructor(e,t){super(r.ObjectGroupType.CLIPREGION,{priority:20,globalSpace:!0}),this.planes=[],this.planeMaterial=new r.PhongLightingMaterial({color:1170103,opacity:.1,transparent:!0,side:THREE.DoubleSide,lights:!0}),this.wireFramesMaterial=new r.PhongLightingMaterial({color:1170103,lights:!0}),this.uniforms={iClipPlane:{type:"i",value:0},vClipPlane:{type:"v4v",value:new Array}},this.init(e,t)}clear(){super.clear(),this.planes.length=0,this.planes=null,this.planeMaterial.dispose(),this.wireFramesMaterial.dispose(),this.planeMaterial=null,this.wireFramesMaterial=null,this.uniforms=null}addSidePlaneMesh(e){let t=new THREE.BufferGeometry;const i=new THREE.BufferAttribute(e,3);t.setAttribute("position",i),t.setIndex([0,1,2,2,3,1]);const r=new THREE.Mesh(t,this.planeMaterial);this.add(r),this.addSideWireFrames(e)}addSideWireFrames(e){let t=new THREE.BufferGeometry;t.setIndex([0,1,0,2,2,3]),t.setAttribute("position",new THREE.Float32BufferAttribute(e,3)),t.setAttribute("color",new THREE.Float32BufferAttribute([1,1,1,1,1,1,1,1,1,1,1,1],3)),t.computeBoundingSphere();var i=new THREE.LineSegments(t,this.wireFramesMaterial);i.name="WireFrames",i.customTag=!0,this.add(i)}addTopWireFrames(e){let t=[],i=[],r=[];e.map(((e,a)=>{t.push(e.x,e.y,e.z),i.push(1,1,1),r.push(a)}));let a=new THREE.BufferGeometry;a.setIndex(r),a.setAttribute("position",new THREE.Float32BufferAttribute(t,3)),a.setAttribute("color",new THREE.Float32BufferAttribute(i,3)),a.computeBoundingSphere();var n=new THREE.LineSegments(a,this.wireFramesMaterial);n.name="WireFrames",n.customTag=!0,this.add(n)}addTopPlaneMesh(e){let t=new THREE.BufferGeometry,i=new THREE.Shape(e),r=new THREE.ShapeBufferGeometry(i);t.attributes=r.attributes;let a=r.attributes.position.array;const n=a.length;for(let t=2;t<n;t+=3)a[t]=e[0].z;t.groups=r.groups,t.index=r.index;const s=new THREE.Mesh(t,this.planeMaterial);this.add(s),this.addTopWireFrames(e)}init(e,t){this.planes=[];let i=[];const r=new THREE.Vector3(0,0,t),a=e.length,n=e[0].z;for(let t=0;t<a-1;++t){const s=e[t],o=e[t+1];s.z=n,o.z=n;const l=e[t].clone().add(r),d=e[t+1].clone().add(r),h=(new THREE.Plane).setFromCoplanarPoints(s,l,o);this.planes.push(h);const c=new Float32Array([s.x,s.y,s.z,o.x,o.y,o.z,l.x,l.y,l.z,d.x,d.y,d.z]);this.addSidePlaneMesh(c),i.push(l),t===a-2&&i.push(d)}this.addTopPlaneMesh(e),this.addTopPlaneMesh(i);const s=(new THREE.Plane).setFromCoplanarPoints(e[0],e[1],e[2]),o=(new THREE.Plane).setFromCoplanarPoints(i[0],i[2],i[1]);this.planes.push(o),this.planes.push(s)}hide(){this.visible=!1}show(){this.visible=!0}}r.ClipRegion=e}(),r.ClipRegionManager=class{constructor(){this.isReverse=!1}static setClipRegion(e,t,i){let a=e.getScene();a.clipRegion&&a.removeObjectGroup(a.clipRegion),a.clipRegion=new r.ClipRegion(t,i);let n=a.clipRegion;const s=a.geometryGroup.matrix;n.matrix.copy(s),n.matrixAutoUpdate=!1,n.updateMatrixWorld(!0),a.objectGroups.add(n);const o=n.planes.length;n.uniforms.iClipPlane.value=o;let l=n.uniforms.vClipPlane.value;n.planes.map(((e,t)=>{e.applyMatrix4(s);let i=new THREE.Vector4(e.normal.x,e.normal.y,e.normal.z,e.constant);l.push(i)})),r.ClipPlanesTool.updateClippingParams(e,n.uniforms,this.isReverse),e.updateShadowMap()}static changeClipDirection(e,t){let i=e.getScene();i.clipRegion&&(this.isReverse=t,r.ClipPlanesTool.updateClippingParams(e,i.clipRegion.uniforms,t))}static exit(e){this.isReverse=!1;let t=e.getScene();t.clipRegion&&(r.ClipPlanesTool.updateClippingParams(e,{iClipPlane:{type:"i",value:0}},this.isReverse),t.clipRegion.clear(),t.removeObjectGroup(t.clipRegion),t.clipRegion=null)}static hide(e){let t=e.getScene();t.clipRegion&&t.clipRegion.hide()}static show(e){let t=e.getScene();t.clipRegion&&t.clipRegion.show()}},function(){let e=new THREE.Vector3,t=new THREE.Vector3,i=!1,a=!1;class n extends r.EditTool{constructor(e){super(r.EditToolMode.CLIP_BY_BOX),this.viewer=e,this.scene=e.getScene(),this.enablePick=!1,this.cameraControl=e.cameraControl,this.startPt=new THREE.Vector2,this.onClipBox=!1,this.isReverse=!1,this.mapLockedBoxFaces={},this.mapBoxFaceIndex={0:"Right",1:"Left",2:"Top",3:"Bottom",4:"Front",5:"Back"},this.clipPlanes=r.ClipPlaneManager.getInstance(this.scene),this.clipPlanes.updateClippingParams=t=>{n.updateClippingParams(e,t,this.isReverse),this.clipPlanes.calculateClipBoundingBox(),this.viewer.updateShadowMap()},this.clipPlanes.calculateClippingIds=(e,t)=>{if(!r.GlobalData.ClippingCapsType==r.EnumClippingCapsTypes.ClipBox)return;var i=this.clipPlanes;let a=i.uniforms.vClipPlane.value[i.selectIndex];i.renderClipPlane.setComponents(a.x,a.y,a.z,a.w),i.renderClipPlane.normalize(),this.viewer.modelManager.calculateClippingIds(e,t),this.viewer.setRenderStateChanged(!0)},this.clipPlanes.init(),this.clipPlanes.clipCapsManager=this.viewer.getClipCapsManager(),this.selectIndex=null,this.lastSelectIndex=null,this.planeDistance=0,this.offsetSpeed=.02,this._planIntersect=new THREE.Vector3,this.clipStartPoint=new THREE.Vector3}toggle(e,t){this.clipPlanes.enable(e,t)}visible(e){this.clipPlanes.visible=e,!e&&this.cancelHighLight()}rotatable(e){this.clipPlanes.rotatable=e}store(){return this.clipPlanes.store()}restore(e){this.clipPlanes.restore(e)}reset(){this.isReverse=!1,this.clipPlanes.reset()}changeDirection(e){this.isReverse=e,this.clipPlanes.update()}visibleCapsWireframe(e){this.clipPlanes.capsWireframe&&(this.clipPlanes.capsWireframe.visible=e)}pointToScreen(e){let t=this.cameraControl.camera,i=new THREE.Matrix4;i.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse);let r=new THREE.Vector4(e.x,e.y,e.z,1);r.applyMatrix4(i);let a=new THREE.Vector2;a.x=(r.x/r.w+1)/2,a.y=1-(r.y/r.w+1)/2;let n=this.cameraControl.getContainerDimensions();return a.x=a.x*n.width+n.left,a.y=a.y*n.height+n.top,a}getPlaneDistanceInScreen(){if(null==this.selectIndex)return null;if(this.selectIndex<2){let e=this.clipPlanes.center.clone(),t=this.clipPlanes.center.clone();e.x-=this.clipPlanes.cubeSize.x,t.x+=this.clipPlanes.cubeSize.x;const i=this.pointToScreen(e),r=this.pointToScreen(t);return i.x-r.x}{let e=this.clipPlanes.center.clone(),t=this.clipPlanes.center.clone();t.y-=this.clipPlanes.cubeSize.y,e.y+=this.clipPlanes.cubeSize.y;const i=this.pointToScreen(t),r=this.pointToScreen(e);return i.y-r.y}}getPickPoint(e,t){let i=this.cameraControl.camera,a=this.cameraControl.getContainerDimensions();const n=e-a.left,s=t-a.top,o=n/a.width*2-1,l=(a.height-s)/a.height*2-1;let d=new r.Raycaster;d.setFromCamera(new THREE.Vector2(o,l),i);return d.ray.intersectPlane(this.plane,this._planIntersect)}getSelectIndex(){return this.clipPlanes.selectIndex}getLastSelectIndex(){return this.lastSelectIndex}setLastSelectIndex(e){this.lastSelectIndex=e}_isVisible(){return this.clipPlanes.visible}isRotate(){return this.clipPlanes.rotatable}offset(e){const t=Math.floor(this.selectIndex/2);this.selectIndex<=3||this.selectIndex%2==1?this.clipPlanes.offset(this.selectIndex,-e*this.clipPlanes.cubeSize.getComponent(t)*2):this.clipPlanes.offset(this.selectIndex,e*this.clipPlanes.cubeSize.getComponent(t)*2)}setSectionBox(e,t){let i=new THREE.Box3(new THREE.Vector3(e.x,e.y,e.z),new THREE.Vector3(t.x,t.y,t.z));i.applyMatrix4(this.scene.getMatrixGlobal()),this.clipPlanes.setSectionBox(i.min,i.max)}calculateOffsetByBox(i,r){let a=new THREE.Box3(new THREE.Vector3(i.x,i.y,i.z),new THREE.Vector3(r.x,r.y,r.z));a.applyMatrix4(this.scene.getMatrixGlobal()),a.getCenter(t),a.setFromCenterAndSize(t,a.getSize(e).multiplyScalar(this.scene.getExpandScalar())),this.clipPlanes.calculateOffsetByBox(a.min,a.max)}moveSectionPlane(e,t){this.clipPlanes.moveSectionPlane(e,t)}rotateSectionBox(e,t){this.clipPlanes.rotateSectionBox(e,t)}rotate(e,t){2==this.selectIndex||3==this.selectIndex?this.clipPlanes.rotX(t/180*Math.PI*.1):this.clipPlanes.rotY(e/180*Math.PI*.1)}update(e){this.clipPlanes.update(e)}cancelHighLight(){this.clipPlanes.cancelHighLight()}cancelHighLightByIndex(e){this.clipPlanes.cancelHighLightByIndex(e)}highLight(){this.clipPlanes.highLight()}lockBoxFaces(e){for(const t of e)this.mapLockedBoxFaces[t]=!0}unlockBox(){this.mapLockedBoxFaces={}}setProcess(e,t){this.mapLockedBoxFaces[e]||this.clipPlanes.setProcess(e,t)}getProcess(e){return this.clipPlanes.getProcess(e)}destroy(){this.cameraControl=null,this.intersectPoint=null,this.selectIndex=null,this.normal=null,this.plane=null,this.pickHelper=null,this.scene=null,this.viewer=null,this.lastSelectIndex=null}onExit(){this.toggle(!1,!1)}processMouseDown(e){if(this.startPt.set(e.clientX,e.clientY),!this.enablePick&&e.button===THREE.MOUSE.LEFT){let t=this.cameraControl.getRaycaster(e.clientX,e.clientY),i=r.ClipPlaneManager.getInstance(this.scene).hitTest(t),a=this.cameraControl.getIntersectContext(new THREE.Vector2(e.clientX,e.clientY)),n=this.cameraControl.intersector.intersect(a,null,!0);if(null!=n&&n.distance<=i.distance)return r.EditTool.prototype.processMouseDown(this,e);if(this.selectIndex=this.getSelectIndex(),this.planeDistance=this.getPlaneDistanceInScreen(),null!=this.selectIndex){if(r.GlobalData.ClippingCapsType==r.EnumClippingCapsTypes.ClipBox){r.ClipPlaneManager.getInstance(this.scene).clearCapsWireframeForSelectIndex(),r.GlobalData.ClippingCaps=!1,this.visibleCapsWireframe(!1)}return this.highLight(),this.cameraControl.needUpdateRenderList(!0),this.cameraControl.update(!0),this.enablePick=!0,this.clipStartPoint=t.ray.at(i.distance,this.clipStartPoint),!0}}return super.processMouseDown(e)}processHover(e){if(!this.enablePick){let t=!1,i=this.cameraControl.getRaycaster(e.clientX,e.clientY),a=r.ClipPlaneManager.getInstance(this.scene);const n=this.getLastSelectIndex();null!==n&&this.cancelHighLightByIndex(n);a.hitTest(i);if(this.selectIndex=this.getSelectIndex(),null!=this.selectIndex){if(this.highLight(),this.setLastSelectIndex(this.selectIndex),!this.onClipBox){this.onClipBox=!0,this.cameraControl.viewer.modelManager.dispatchEvent({type:r.EVENTS.ON_CLIP_HOVER,onClipBox:!0})}t=!0}else if(this.onClipBox){this.onClipBox=!1,this.cameraControl.viewer.modelManager.dispatchEvent({type:r.EVENTS.ON_CLIP_HOVER,onClipBox:!1})}return this.selectIndex!==n&&(this.cameraControl.needUpdateRenderList(!0),this.cameraControl.update(!0)),t}return super.processHover(e)}processMouseUp(e){if(e.button===THREE.MOUSE.LEFT){let t=this.cameraControl.getRaycaster(e.clientX,e.clientY),i=r.ClipPlaneManager.getInstance(this.scene);if(null!==this.getSelectIndex()){if(r.GlobalData.ClippingCapsType==r.EnumClippingCapsTypes.ClipBox){r.ClipPlaneManager.getInstance(this.scene).calculateClippingIds(),r.GlobalData.ClippingCaps=!0,this.visibleCapsWireframe(!0)}this.cancelHighLight(),this.cameraControl.needUpdateRenderList(!0),this.cameraControl.update(!0)}i.hitTest(t);if(this.selectIndex=this.getSelectIndex(),null!=this.selectIndex){if(this.highLight(),this.cameraControl.needUpdateRenderList(!0),this.cameraControl.update(!0),!this.onClipBox){this.onClipBox=!0,this.cameraControl.viewer.modelManager.dispatchEvent({type:r.EVENTS.ON_CLIP_HOVER,onClipBox:!0})}}else if(this.onClipBox){this.onClipBox=!1,this.cameraControl.viewer.modelManager.dispatchEvent({type:r.EVENTS.ON_CLIP_HOVER,onClipBox:!1})}if(this.enablePick)return this.planeDistance=0,this.enablePick=!1,!0}return super.processMouseUp(e)}processMouseMove(e){if(this.enablePick){if(this.isRotate())this.rotate(e.clientX-this.startPt.x,e.clientY-this.startPt.y),this.startPt.set(e.clientX,e.clientY);else{const t=this.mapBoxFaceIndex[this.selectIndex];if(this.mapLockedBoxFaces[t])return!0;if(!(e.clientX==this.startPt.x&&e.clientY==this.startPt.y)){let t=r.ClipPlaneManager.getInstance(this.scene),i=t.clipplanes[this.selectIndex],a=this.cameraControl.movePlane(i,e,this.startPt,!0,this.clipStartPoint);null!=a&&t.offset(this.selectIndex,a),this.startPt.set(e.clientX,e.clientY)}this.cameraControl.viewer.modelManager.dispatchEvent({type:r.EVENTS.ON_CLIP_MOUSE_MOVE,draggedFaceName:t})}return this.cameraControl.setCameraChanging(!0),this.cameraControl.update(!0),!0}return super.processMouseMove(e)}processTouchstart(e){if(this.startPt.set(e.touches[0].clientX,e.touches[0].clientY),this.enablePick)return super.processTouchstart(e);{let t=this.cameraControl.getRaycaster(e.touches[0].clientX,e.touches[0].clientY);if(r.ClipPlaneManager.getInstance(this.scene).hitTest(t),this.selectIndex=this.getSelectIndex(),this.planeDistance=this.getPlaneDistanceInScreen(),null!=this.selectIndex)return this.highLight(),this.cameraControl.needUpdateRenderList(!0),this.cameraControl.update(!0),this.update(),!0}}processTouchmove(e){if(null!=this.selectIndex){if(this.isRotate())this.rotate(e.touches[0].clientX-this.startPt.x,e.touches[0].clientY-this.startPt.y),this.startPt.set(e.touches[0].clientX,e.touches[0].clientY);else{let t=0;t=this.selectIndex<2?e.touches[0].clientX-this.startPt.x:e.touches[0].clientY-this.startPt.y,this.offset(t/this.planeDistance),this.startPt.set(e.touches[0].clientX,e.touches[0].clientY)}return this.cameraControl.update(!0),this.update(),!0}return super.processTouchmove(e)}processTouchend(e){return this.selectIndex=null,this.planeDistance=0,this.enablePick&&(this.onUpdateUI({visible:!1}),this.startPt.x==e.touches[0].clientX&&this.startPt.y==e.touches[0].clientY&&this.pickHelper.click(e)),this.cameraControl.needUpdateRenderList(!0),this.cancelHighLight(),this.cameraControl.update(!0),this.update(),super.processTouchend(e)}static updateClippingParams(e,t,n){const s=t.iClipPlane.value;if(0==s)return e.getRenderer().localClippingEnabled=!1,void(e.getRenderer().clippingPlanes=Object.freeze([]));let o=[],l=[];for(let e=0;e<s;++e){let e=new THREE.Plane;o.push(e)}for(let e=0;e<s;++e){const i=t.vClipPlane.value[e].clone();let r=o[e];r.setComponents(-i.x,-i.y,-i.z,-i.w),r.normalize(),l.push(r.clone()),n&&r.negate()}let d=!1,h=e.modelManager,c=[],u=[];h.modelCollection.traverse((e=>{if(e instanceof r.ExtrudeBodyManager){e.getAllNodes().forEach((e=>{u.push(e.material)}))}else if(e instanceof r.ExternalComponentManager){e.getAllMeshes().forEach((e=>{if(void 0===e.material)return;const t=e.material.length;t&&t>0?e.material.forEach((e=>{u.push(e)})):u.push(e.material),e._materialHold&&u.push(e._materialHold)}))}else{if(e.materialManager&&(a!=n||n)){let t=e=>{for(let t in e){let i=e[t];if(i instanceof Array)for(let e=0,t=i.length;e<t;e++)u.push(i[e]);else u.push(i)}};t(e.materialManager.materials),t(e.materialManager.instanceMaterials),e.materialManager instanceof r.BimTileMaterialManager&&(u.push(e.materialManager.globalMaterial),e.updateMaterialsValue("clippingPlanes",o,!1),e.updateMaterialsValue("clipIntersection",n,!1),u.push(e.getWireframeMaterial()),u.push(e.getInstanceWireframeMaterial())),null!=e.wireframeManager&&(u.push(e.wireframeManager.wireframeMaterial),u.push(e.wireframeManager.instanceWireframeMaterial),u.push(e.wireframeManager.defaultWireframeColor)),a=n}let t=null;e.getInstanceWireframeMaterial&&(t=e.getInstanceWireframeMaterial(),t&&(u.push(t),c.push(t)));let i=e.getFilter();if(i){const e=i.materialSelector.getAllTypeMaterial();if(u.push(...e),i._hasLocalClipping()){let e=i.getAllMaterialsForClip();for(let t in e)e[t].clippingPlanes=o,u.push(e[t]);let r=i.getAllInstanceMaterialsForClip();for(let e in r){let t=r[e];t.instanceMaterial&&(t.instanceMaterial.clippingPlanes=o,u.push(t))}t&&(t.clippingPlanes=o,u.push(t)),d=!0}}}}));let p=e.rendererManager.getPickingEffecter();if(p.selectedMaterialForClip.clippingPlanes=o,p.wireframeMaterialForClip.clippingPlanes=o,p.instancedSelectedMaterialForClip.clippingPlanes=o,p.instancedWireFrameMaterialForClip.clippingPlanes=o,u.push(p.selectedMaterialForClip),u.push(p.wireframeMaterialForClip),u.push(p.instancedSelectedMaterialForClip),u.push(p.instancedWireFrameMaterialForClip),u.push(p.instancedWireFrameMaterial),u.push(p.selectedMaterial),u.push(p.wireframeMaterial),u.push(p.selectedLineMaterial),u.push(p.skinningSelectedMaterial),u.push(p.skinningWireframeMaterial),d||n?(e.getRenderer().localClippingEnabled=!0,e.getRenderer().clippingPlanes=Object.freeze([])):(e.getRenderer().localClippingEnabled=!1,e.getRenderer().clippingPlanes=o),i!=d){if(d){h.updateMaterialsValue("localClipping",1);for(let e=0;e<c.length;e++)c[e].localClipping=1,c[e].refreshUniforms()}else{h.updateMaterialsValue("localClipping",-1);for(let e=0;e<c.length;e++)c[e].localClipping=-1,c[e].refreshUniforms()}i=d}u.forEach((e=>{e.clippingPlanes=d||n?o:null,e.clipIntersection=n})),e.clipCapsManager&&e.clipCapsManager.changeDirection(o,l,n)}}r.ClipPlanesTool=n}(),(()=>{var e=[new THREE.Plane],t=!1;let i=new THREE.Vector3;class a extends r.EditTool{constructor(a){super(r.EditToolMode.CLIP_FILL),this.viewer=a,this.scene=a.getScene(),this.enablePick=!1,this.rotX=!0,this.onClipPlane=!1,this.cameraControl=a.cameraControl,this.startPt=new THREE.Vector2,this.modelManager=this.cameraControl.viewer.modelManager,this.planeDistance=0,this.offsetSpeed=.02;var n=this;this._planIntersect=new THREE.Vector3,this.fillClipPlane=r.FillClipPlaneManager.getInstance(this.scene),this.fillClipPlane.updateClippingParams=function(s){if(0==s.iClipPlane.value)a.getRenderer().localClippingEnabled=!1,a.getRenderer().clippingPlanes=Object.freeze([]);else{var o=s.vClipPlane.value[0],l=e[0];l.setComponents(-o.x,-o.y,-o.z,-o.w),l.normalize();var d=!1,h=a.modelManager,c=[],u=[],p=[];h.modelCollection.traverse((t=>{var i,a;if(t.getInstanceWireframeMaterial&&(i=t.getInstanceWireframeMaterial())&&(c.push(i),u.push(i)),t.getWireframeMaterial&&(a=t.getWireframeMaterial())&&u.push(a),t.localClippingMode)if(d=!0,t.localClippingPlanes=e,t.innerClippingMode=n.fillClipPlane.innerClipping?1:-1,!t.innerClippingMatrix&&(t.innerClippingMatrix=new THREE.Matrix4),t.innerClippingMatrix.copy(n.fillClipPlane.orthoViewProjMatrix),a&&(a.clippingPlanes=e,p.push(a)),i&&(i.clippingPlanes=e,p.push(i)),t instanceof r.Model){for(var s in t.materialManager.materials){(h=t.materialManager.materials[s]).clippingPlanes=e,p.push(h)}for(var s in t.materialManager.instanceMaterials){if((h=t.materialManager.instanceMaterials[s])instanceof Array)for(var o=0,l=h.length;o<l;o++)h[o].clippingPlanes=e,p.push(h[o]);else h.clippingPlanes=e,p.push(h)}}else if(t instanceof r.BimTilesModel)for(var s in t.materialManager.materialMap){var h;(h=t.materialManager.materialMap[s]).clippingPlanes=e,p.push(h)}var m=t.getFilter();if(m&&m._hasLocalClipping()){var f=m.getAllMaterialsForClip();for(var g in f)f[g].clippingPlanes=e,p.push(f[g]);var v=m.getAllInstanceMaterialsForClip();for(var g in v){var y=v[g];y.instanceMaterial&&(y.instanceMaterial.clippingPlanes=e,p.push(y.instanceMaterial))}i&&(i.clippingPlanes=e),d=!0}}));var m=a.rendererManager.getPickingEffecter();if(m.selectedMaterialForClip.clippingPlanes=e,m.wireframeMaterialForClip.clippingPlanes=e,m.instancedSelectedMaterialForClip.clippingPlanes=e,m.instancedWireFrameMaterialForClip.clippingPlanes=e,a.getClipCapsManager()._prepareCapScene(),d){a.getRenderer().localClippingEnabled=!0,a.getRenderer().clippingPlanes=Object.freeze([]),n.scene.backMaterial.clippingPlanes=e,n.scene.frontMaterial.clippingPlanes=e,n.scene.backInstanceMaterial.clippingPlanes=e,n.scene.frontInstanceMaterial.clippingPlanes=e,p.push(m.selectedMaterialForClip),p.push(m.wireframeMaterialForClip),p.push(m.instancedSelectedMaterialForClip),p.push(m.instancedWireFrameMaterialForClip),p.push(n.scene.backMaterial),p.push(n.scene.frontMaterial),p.push(n.scene.backInstanceMaterial),p.push(n.scene.frontInstanceMaterial);for(var f=0;f<p.length;f++)p[f].orthoViewProjMatrix&&(p[f].orthoViewProjMatrix.copy(this.orthoViewProjMatrix),p[f].innerClipping=this.innerClipping?1:-1,p[f].refreshUniforms())}else{a.getRenderer().localClippingEnabled=!1,a.getRenderer().clippingPlanes=e,n.scene.backMaterial.clippingPlanes=Object.freeze([]),n.scene.frontMaterial.clippingPlanes=Object.freeze([]),n.scene.backInstanceMaterial.clippingPlanes=Object.freeze([]),n.scene.frontInstanceMaterial.clippingPlanes=Object.freeze([]),u.push(m.selectedMaterial),u.push(m.wireframeMaterial),u.push(m.instancedSelectedMaterial),u.push(m.instancedWireFrameMaterial),u.push(n.scene.backMaterial),u.push(n.scene.frontMaterial),u.push(n.scene.backInstanceMaterial),u.push(n.scene.frontInstanceMaterial),h.updateMaterialsValue("orthoViewProjMatrix",this.orthoViewProjMatrix),h.updateMaterialsValue("innerClipping",this.innerClipping?1:-1);for(f=0;f<u.length;f++)u[f].orthoViewProjMatrix&&(u[f].orthoViewProjMatrix.copy(this.orthoViewProjMatrix),u[f].innerClipping=this.innerClipping?1:-1,u[f].refreshUniforms())}if(t!=d){if(d){h.updateMaterialsValue("localClipping",1);for(f=0;f<c.length;f++)c[f].localClipping=1,c[f].refreshUniforms();h.updateMaterialsValue("innerClipping",-1);for(f=0;f<u.length;f++)u[f].innerClipping=-1,u[f].refreshUniforms()}else{h.updateMaterialsValue("localClipping",-1);for(f=0;f<c.length;f++)c[f].localClipping=-1,c[f].refreshUniforms();for(f=0;f<p.length;f++)p[f].innerClipping=-1,p[f].refreshUniforms()}t=d}this.renderClipPlane=new THREE.Plane,this.renderClipPlane.setComponents(o.x,o.y,o.z,o.w),this.renderClipPlane.normalize(),this.calculateFillClipBoundingBox(l.coplanarPoint(i)),a.updateShadowMap()}},this.fillClipPlane.calculateClippingIds=function(e){a.modelManager.calculateClippingIds(e)},this.fillClipPlane.init(),this.fillClipPlane.clipCapsManager=this.viewer.getClipCapsManager()}toggle(e,t){this.fillClipPlane.enable(e,t),this.fillClipPlane.update(),this.viewer.updateShadowMap()}visible(e){this.fillClipPlane.visible=e,this.fillClipPlane.update()}rotatable(e){this.fillClipPlane.rotatable=e,this.fillClipPlane.update()}hit(){return this.fillClipPlane.hit}pointToScreen(e){var t=this.cameraControl.camera,i=new THREE.Matrix4;i.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse);var r=new THREE.Vector4(e.x,e.y,e.z,1);r.applyMatrix4(i);var a=new THREE.Vector2;a.x=(r.x/r.w+1)/2,a.y=1-(r.y/r.w+1)/2;var n=this.cameraControl.getContainerDimensions();return a.x=a.x*n.width+n.left,a.y=a.y*n.height+n.top,a}getPlaneDistanceInScreen(){if(null==this.selectIndex)return null;if(this.selectIndex<2){var e=clipPlanes.center.clone(),t=clipPlanes.center.clone();e.x-=clipPlanes.cubeSize.x,t.x+=clipPlanes.cubeSize.x;var i=this.pointToScreen(e),r=this.pointToScreen(t);return i.x-r.x}var a=clipPlanes.center.clone(),n=clipPlanes.center.clone();n.y-=clipPlanes.cubeSize.y,a.y+=clipPlanes.cubeSize.y;var s=this.pointToScreen(n),o=this.pointToScreen(a);return s.y-o.y}getPickPoint(e,t){var i=this.cameraControl.camera,a=this.cameraControl.getContainerDimensions(),n=e-a.left,s=t-a.top,o=n/a.width*2-1,l=(a.height-s)/a.height*2-1,d=new r.Raycaster;return d.setFromCamera(new THREE.Vector2(o,l),i),d.ray.intersectPlane(this.plane,this._planIntersect)}_isVisible(){return this.fillClipPlane.visible}isRotate(){return this.fillClipPlane.rotatable}offset(e){this.fillClipPlane.offset(e)}setOffset(e){this.fillClipPlane.setOffset(e)}rotate(e,t){this.rotX?this.fillClipPlane.rotX(t/180*Math.PI*.1):this.fillClipPlane.rotY(e/180*Math.PI*.1)}rotateAngleOffset(e,t){this.fillClipPlane.rotateAngleOffset(e,t)}setRotateAngle(e,t){this.fillClipPlane.setRotateAngle(e,t)}getRotateAngle(){return this.fillClipPlane.getRotateAngle()}changeNormal(e){this.fillClipPlane.changeNormal(e)}update(e){this.fillClipPlane.update(e)}cancelHighLight(){this.fillClipPlane.cancelHighLight()}highLight(){this.fillClipPlane.highLight()}store(){return this.fillClipPlane.store()}restore(e){this.viewer.clipCapsManager.enableHatchByMaterial(e.isHatchMaterial,!1),this.fillClipPlane.restore(e)}setProcess(e){this.fillClipPlane.setProcess(e)}getProcess(){return this.fillClipPlane.getProcess()}destroy(){this.cameraControl=null,this.normal=null,this.plane=null,this.pickHelper=null,this.scene=null,this.viewer=null}onExit(){this.toggle(!1,!1)}processMouseDown(e){if(this.startPt.set(e.clientX,e.clientY),!this.enablePick&&e.button===THREE.MOUSE.LEFT){var t=this.cameraControl.getRaycaster(e.clientX,e.clientY);if(r.FillClipPlaneManager.getInstance(this.scene).hitTest(t),this.hit())return this.highLight(),this.cameraControl.needUpdateRenderList(!0),this.cameraControl.update(!0),!1}return r.EditTool.prototype.processMouseDown(this,e)}processMouseUp(e){this.planeDistance=0;var t=!1;if(this.enablePick&&e.button===THREE.MOUSE.LEFT)if(this.startPt.x==e.clientX&&this.startPt.y==e.clientY)this.pickHelper.click(e);else if(e.shiftKey||e.ctrlKey||e.altKey){this.endPt.set(e.clientX,e.clientY);var i=r.OPSELECTIONTYPE.Clear;e.ctrlKey?i=r.OPSELECTIONTYPE.Add:e.altKey&&(i=r.OPSELECTIONTYPE.Remove);var a=this;this.scene.pickByRect(this.frustum,i,(function(){a.pickHelper.notifySelectionChanged(null,0,e)})),this.cameraControl.updateView(!0),t=!0}var n=this.cameraControl.getRaycaster(e.clientX,e.clientY);return r.FillClipPlaneManager.getInstance(this.scene).hitTest(n),this.hit()?(this.highLight(),this.cameraControl.needUpdateRenderList(!0),this.cameraControl.update(!0),this.onClipPlane||(this.onClipPlane=!0,this.modelManager.dispatchEvent({type:r.EVENTS.ON_CLIP_HOVER,onClipPlane:!0,event:e})),t=!0):(this.cancelHighLight(),this.cameraControl.needUpdateRenderList(!0),this.cameraControl.update(!0),this.onClipPlane&&(this.onClipPlane=!1,this.modelManager.dispatchEvent({type:r.EVENTS.ON_CLIP_HOVER,onClipPlane:!1,event:e}))),this.modelManager.dispatchEvent({type:r.EVENTS.ON_TOOL_END}),t}processMouseMove(e){return this.modelManager.dispatchEvent({type:r.EVENTS.ON_CLIP_MOUSE_MOVE,event:e}),r.EditTool.prototype.processMouseMove(this,e)}processTouchstart(e){if(this.startPt.set(e.touches[0].clientX,e.touches[0].clientY),!this.enablePick){var t=this.cameraControl.getRaycaster(e.touches[0].clientX,e.touches[0].clientY);r.FillClipPlaneManager.getInstance(this.scene).hitTest(t)}return r.EditTool.prototype.processTouchstart(this,e)}processTouchmove(e){}processTouchend(e){return this.enablePick&&(this.onUpdateUI({visible:!1}),this.startPt.x==e.touches[0].clientX&&this.startPt.y==e.touches[0].clientY&&this.pickHelper.click(e)),this.cameraControl.needUpdateRenderList(!0),this.cancelHighLight(),this.cameraControl.update(!0),r.EditTool.prototype.processTouchmove(this,e)}processHover(e){if(!this.enablePick){var t=!1,i=this.cameraControl.getRaycaster(e.clientX,e.clientY);return r.FillClipPlaneManager.getInstance(this.scene).hitTest(i),this.hit()?(this.onClipPlane||(this.highLight(),this.cameraControl.needUpdateRenderList(!0),this.cameraControl.update(!0),this.onClipPlane=!0,this.modelManager.dispatchEvent({type:r.EVENTS.ON_CLIP_HOVER,onClipPlane:!0,event:e})),t=!0):this.onClipPlane?(this.cancelHighLight(),this.cameraControl.needUpdateRenderList(!0),this.cameraControl.update(!0),this.onClipPlane=!1,this.modelManager.dispatchEvent({type:r.EVENTS.ON_CLIP_HOVER,onClipPlane:!1,event:e})):this.modelManager.dispatchEvent({type:r.EVENTS.ON_CLIP_HOVER,onClipPlane:!1,event:e}),t}return r.EditTool.prototype.processHover(this,e)}}r.FillClipPlaneTool=a})(),(()=>{let e=[];e.push("clipPlane_right"),e.push("clipPlane_left"),e.push("clipPlane_top"),e.push("clipPlane_bottom"),e.push("clipPlane_front"),e.push("clipPlane_back");let t=new THREE.Quaternion,i=new THREE.Vector3(1,0,0),a=new THREE.Vector3(0,1,0),n=new THREE.Vector3(0,0,1),s=new THREE.Matrix4;class o extends r.ObjectGroup{constructor(e,t){super(r.ObjectGroupType.CLIPPLANE,{priority:20}),this.cubeSize=e.clone(),this.center=t.clone(),this.visible=!1,this.rotatable=!1,this.selectIndex=null,this.planeOffset=new Array(6),this.planeRotate=[0,0,0],this.observer=null,this.uniforms={iClipPlane:{type:"i",value:0},vClipPlane:{type:"v4v",value:new Array(new THREE.Vector4,new THREE.Vector4,new THREE.Vector4,new THREE.Vector4,new THREE.Vector4,new THREE.Vector4)}},this.clipplanes=null,this.calculation=!0,this.boundingBox=new THREE.Box3,this.planeMaterial=new r.PhongLightingMaterial({color:16777215,opacity:0,transparent:!0,side:THREE.DoubleSide,lights:!0}),this.planeHighLightMatrial=new r.PhongLightingMaterial({color:1170103,opacity:.1,transparent:!0,side:THREE.DoubleSide,lights:!0}),this.capsIntersectPosition=[[],[],[],[],[],[]],this.renderClipPlane=new THREE.Plane,this.renderOrder=r.EnumRenderOrder.ClipPlane}calculateClipBoundingBox(e){this.boundingBox.setFromObject(this)}getClipBoundingBox(){return this.boundingBox}isVisible(){return this.visible}getPlaneNormal(e){var t=new THREE.Vector4,i=Math.floor(e/2),r=e%2;return t.setComponent(i,Math.pow(-1,r)),t.w=.5*-this.cubeSize.getComponent(i),this.planeOffset[e]=0,t}initPlaneModel(t){var i=Math.floor(t/2),a=t%2,n=0==i?this.cubeSize.z:this.cubeSize.x,s=1==i?this.cubeSize.z:this.cubeSize.y,o=new THREE.PlaneGeometry(n,s),l=new THREE.Mesh(o,this.planeMaterial);l.name=e[t],l.customTag=!0,l.position.setComponent(i,Math.pow(-1,a)*this.cubeSize.getComponent(i)*.5),0==i?l.rotation.y=Math.pow(-1,a)*Math.PI*.5:1==i&&(l.rotation.x=Math.pow(-1,a)*Math.PI*.5),l.renderOrder=r.EnumRenderOrder.ClipPlane,this.add(l)}initCapsBox(e,t,i){var a=new THREE.BoxBufferGeometry(this.cubeSize.x,this.cubeSize.y,this.cubeSize.z);a.groups=null;var n=new r.PhongLightingMaterial({color:6380315,side:THREE.DoubleSide,viewportSize:t,backSceneTexture:e}),s=new THREE.Mesh(a,n);let o=this.cubeSize.x,l=this.cubeSize.y,d=this.cubeSize.z,h=[new THREE.Vector3(1,0,0),new THREE.Vector3(-1,0,0),new THREE.Vector3(0,1,0),new THREE.Vector3(0,-1,0),new THREE.Vector3(0,0,1),new THREE.Vector3(0,0,-1)];this.boxCap=new THREE.Group;let c=new THREE.Group;return c.add(this._getLine(l,d,.5*o,0,h[0])),c.add(this._getLine(l,d,.5*-o,1,h[1])),c.add(this._getLine(o,d,.5*l,2,h[2])),c.add(this._getLine(o,d,.5*-l,3,h[3])),c.add(this._getLine(o,l,.5*d,4,h[4])),c.add(this._getLine(o,l,.5*-d,5,h[5])),this.boxCap.add(c),i&&(n.defines.USE_CAP="",c.visible=!1),this.boxCap.add(s),this.boxCap.matrixWorld=this.matrixWorld,this.boxCap.matrix=this.matrix,this.boxCap.matrixAutoUpdate=!1,this.boxCap.updateMatrixWorld(!0),this.boxCap}_getLineMesh(e,t){var i=new THREE.LineMaterial({color:2236962,polygonOffset:!0,polygonOffsetFactor:-1,polygonOffsetUnits:-10,resolution:new THREE.Vector2(window.innerWidth,window.innerHeight),outNormal:t});i.uniforms.outNormal.value=t;var r=new THREE.LineSegmentsGeometry;return r.setPositions(e),new THREE.LineSegments2(r,i)}_getLine(e,t,i,r,a){let n=[];for(var s=.5*e,o=.5*t,l=5;l<e+t;l+=5){var d,h,c,u;l<t?(d=-s,h=-o+l):(d=-s+l-t,h=o),l<e?(c=-s+l,u=-o):(c=s,u=-o+l-e),r<2?(n.push(i,d,h),n.push(i,c,u)):r>3?(n.push(d,h,i),n.push(c,u,i)):(n.push(d,i,h),n.push(c,i,u))}return this._getLineMesh(n,a)}addToCapsWireframe(e){if(this.capsWireframe&&this.capsWireframe.children.length>0){let e=this.capsWireframe.children[this.selectIndex];e.geometry.setPositions(this.capsIntersectPosition[this.selectIndex]),e.geometry._maxInstanceCount=void 0}else{for(var t=e.manager.scene.getOrCreateObjectGroup(r.ObjectGroupType.CAPSWIREFRAME,{globalSpace:!0}),i=e.manager.getModelLengthUnitsMatrix(e),a=0;a<6;a++){var n=new THREE.LineSegmentsGeometry;a==this.selectIndex&&n.setPositions(this.capsIntersectPosition[this.selectIndex]);let e=new THREE.LineSegments2(n,new THREE.LineMaterial({color:2236962,linewidth:1,polygonOffset:!0,polygonOffsetFactor:-1,polygonOffsetUnits:-10,resolution:new THREE.Vector2(window.innerWidth,window.innerHeight),clipping:!0,clippingTolerance:.001}));t.add(e),i&&e.applyMatrix4(i),e.updateMatrixWorld(!0)}this.capsWireframe=t}}clearCapsWireframeForSelectIndex(){this.capsWireframe&&this.capsWireframe.children&&this.capsWireframe.children[this.selectIndex]&&(this.capsWireframe.children[this.selectIndex].geometry.deleteAttribute("instanceStart"),this.capsWireframe.children[this.selectIndex].geometry.deleteAttribute("instanceEnd"))}clearCapsWireframe(){if(this.capsWireframe&&r.GlobalData.ClippingCapsType==r.EnumClippingCapsTypes.ClipBox){var e=this.capsWireframe.children;for(let t=0;t<e.length;t++)e[t].geometry.deleteAttribute("instanceStart"),e[t].geometry.deleteAttribute("instanceEnd")}}reCalculateClippingIds(e){if(r.GlobalData.ClippingCapsType!=r.EnumClippingCapsTypes.ClipBox)return;let t=this.selectIndex;for(let t=0;t<6;t++)this.selectIndex=t,this.calculateClippingIds(e,0==t);this.selectIndex=t}initWireframes(){var e=[.5*-this.cubeSize.x,.5*-this.cubeSize.y,.5*-this.cubeSize.z,.5*this.cubeSize.x,.5*-this.cubeSize.y,.5*-this.cubeSize.z,.5*this.cubeSize.x,.5*this.cubeSize.y,.5*-this.cubeSize.z,.5*-this.cubeSize.x,.5*this.cubeSize.y,.5*-this.cubeSize.z,.5*-this.cubeSize.x,.5*-this.cubeSize.y,.5*this.cubeSize.z,.5*this.cubeSize.x,.5*-this.cubeSize.y,.5*this.cubeSize.z,.5*this.cubeSize.x,.5*this.cubeSize.y,.5*this.cubeSize.z,.5*-this.cubeSize.x,.5*this.cubeSize.y,.5*this.cubeSize.z],t=new THREE.BufferGeometry,i=new r.PhongLightingMaterial({color:1170103,lights:!0});t.setIndex([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,3,7,1,5,2,6]),t.setAttribute("position",new THREE.Float32BufferAttribute(e,3)),t.setAttribute("color",new THREE.Float32BufferAttribute([1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],3)),t.computeBoundingSphere();var a=new THREE.LineSegments(t,i);a.name="Wireframes",a.customTag=!0,this.add(a)}updateClippingParams(e){}enable(e,t){this.visible=t,this.uniforms.iClipPlane.value=e?6:0,this.updateClippingParams(this.uniforms)}isEnabled(){return 0!==this.uniforms.iClipPlane.value}store(){let e=r.GlobalData.ClippingCapsType>0;return new l(!!this.uniforms.iClipPlane.value,this.visible,this.rotatable,this.calculation,this.planeOffset,this.planeRotate,this.position.clone(),this.scale.clone(),this.quaternion.clone(),this.cubeSize.clone(),this.center.clone(),this.boundingBox.clone(),e,this.clipCapsManager.hatchByMaterialForBox)}restore(e){this.calculation=!0,this.calculationPlanes(e.cubeSize,e.center),this.enable(e.enable,e.visible),this.rotatable=e.rotatable,this.calculation=e.calculation;for(var t=0;t<6;++t)this.planeOffset[t]=e.planeOffset[t];for(t=0;t<3;++t)this.planeRotate[t]=e.planeRotate[t];this.position.copy(e.position),this.scale.copy(e.scale),this.quaternion._w=e.quaternion._w,this.quaternion._x=e.quaternion._x,this.quaternion._y=e.quaternion._y,this.quaternion._z=e.quaternion._z,this.update(),this.clipCapsManager.enableHatch(e.isHatchEnabled),this.clipCapsManager.enableHatchByMaterial(e.isHatchByMaterial,!0),this.reCalculateClippingIds()}reset(){this.calculation=!0;for(var e=0;e<6;++e)this.planeOffset[e]=0;for(e=0;e<3;++e)this.planeRotate[e]=0;this.position.copy(this.center),this.scale.copy(new THREE.Vector3(1,1,1)),this.quaternion.copy(new THREE.Quaternion),this.update(),this.clearCapsWireframe(),this.reCalculateClippingIds()}calculationPlanes(e,t){if(this.calculation){this.cubeSize.copy(e),this.center.copy(t);for(var i=this.children.length-1;i>=0;--i)this.remove(this.children[i]);for(i=0;i<6;++i)this.uniforms.vClipPlane.value[i]=this.getPlaneNormal(i),this.initPlaneModel(i);this.initWireframes(),this.clipplanes=this.uniforms.vClipPlane.value.slice(0),this.reset()}}update(){this.updateMatrixWorld(),this.boxCap&&(this.boxCap.matrixWorld=this.matrixWorld,this.boxCap.matrix=this.matrix,this.boxCap.updateMatrixWorld(!0)),s.copy(this.matrix).invert(),s.transpose();for(var e=0;e<6;++e)this.uniforms.vClipPlane.value[e]=this.clipplanes[e].clone().applyMatrix4(s);this.updateClippingParams(this.uniforms),this.observer&&this.observer()}offset(e,t){this.calculation=!1;var i=Math.floor(e/2);this.cubeSize.getComponent(i);e%2==0&&this.planeOffset[e]+t>0&&(t=-this.planeOffset[e]),e%2==1&&this.planeOffset[e]+t<0&&(t=-this.planeOffset[e]),this.planeOffset[e]+=t;for(var r=new THREE.Vector3,a=0;a<6;++a){var n=this.clipplanes[a].clone(),s=this.planeOffset[a],o=new THREE.Vector3(n.x*s,n.y*s,n.z*s);r.add(o)}var l=1+r.getComponent(i)/this.cubeSize.getComponent(i);if((l=0==l?1e-5:l)>0){this.scale.setComponent(i,l);var d=this.uniforms.vClipPlane.value[e].clone(),h=new THREE.Vector3(d.x,d.y,d.z);h.normalize();o=t;var c=new THREE.Vector3(h.x*o,h.y*o,h.z*o);e%2==1?this.position.sub(c.multiplyScalar(.5)):this.position.add(c.multiplyScalar(.5)),this.update()}else this.planeOffset[e]-=t}rotX(e){this.calculation=!1,t.setFromAxisAngle(i,e),this.quaternion.multiply(t),this.update()}rotY(e){this.calculation=!1,t.setFromAxisAngle(a,e),this.quaternion.multiply(t),this.update()}setSectionBox(e,t){this.calculation=!0;var i=new THREE.Vector3(t.x-e.x,t.y-e.y,t.z-e.z),a=new THREE.Vector3(.5*(e.x+t.x),.5*(e.y+t.y),.5*(e.z+t.z));this.calculationPlanes(i,a),this.clipCapsManager.resetClippingCapsStatus(r.GlobalData.ClippingCapsType)}calculateOffsetByBox(e,t){var i=t.x-this.center.x-.5*this.cubeSize.x;i<this.planeOffset[0]?(this.moveSectionPlane("Left",this.center.x-.5*this.cubeSize.x-e.x),this.moveSectionPlane("Right",i)):(this.moveSectionPlane("Right",i),this.moveSectionPlane("Left",this.center.x-.5*this.cubeSize.x-e.x));var r=t.y-this.center.y-.5*this.cubeSize.y;r<this.planeOffset[2]?(this.moveSectionPlane("Bottom",this.center.y-.5*this.cubeSize.y-e.y),this.moveSectionPlane("Top",r)):(this.moveSectionPlane("Top",r),this.moveSectionPlane("Bottom",this.center.y-.5*this.cubeSize.y-e.y));var a=t.z-this.center.z-.5*this.cubeSize.z;a<this.planeOffset[4]?(this.moveSectionPlane("Back",this.center.z-.5*this.cubeSize.z-e.z),this.moveSectionPlane("Front",a)):(this.moveSectionPlane("Front",a),this.moveSectionPlane("Back",this.center.z-.5*this.cubeSize.z-e.z))}getPlaneIndexByName(e){var t=-1;return"Right"==e?t=0:"Left"==e?t=1:"Top"==e?t=2:"Bottom"==e?t=3:"Front"==e?t=4:"Back"==e&&(t=5),t}moveSectionPlane(e,t){var i=this.getPlaneIndexByName(e);if(-1!=i){i%2!=0&&(t=-t);var r=t-this.planeOffset[i];this.offset(i,r)}}setProcess(e,t){var i=this.getPlaneIndexByName(e),r=0;if(i<2?r=this.cubeSize.x:i<4?r=this.cubeSize.y:i<6&&(r=this.cubeSize.z),t>1?t=1:t<0&&(t=0),-1!=i){i%2==0&&(t=-t);var a=t*r-this.planeOffset[i];if(0==a)return;this.offset(i,a)}this.reCalculateClippingIds()}getProcess(e){var t=this.getPlaneIndexByName(e);-1==t&&console.log("faceName is illegal");var i=0;t<2?i=this.cubeSize.x:t<4?i=this.cubeSize.y:t<6&&(i=this.cubeSize.z);var r=1;t%2!=1&&(r=-1);var a=r*this.planeOffset[t]/i;return a>1?a=1:a<0&&(a=0),a}rotateSectionBox(e,t){"x"==e?this.planeRotate[0]=t:"y"==e?this.planeRotate[1]=t:"z"==e&&(this.planeRotate[2]=t),this.calculation=!0;var r=new THREE.Quaternion;r.setFromAxisAngle(i,this.planeRotate[0]);var s=new THREE.Quaternion;s.setFromAxisAngle(a,this.planeRotate[1]);var o=new THREE.Quaternion;o.setFromAxisAngle(n,this.planeRotate[2]);var l=new THREE.Quaternion;l.multiply(r),l.multiply(s),l.multiply(o),this.quaternion.copy(l),this.update()}highLight(){null!=this.selectIndex&&(this.children[this.selectIndex].material=this.planeHighLightMatrial)}cancelHighLight(){null!=this.selectIndex&&(this.children[this.selectIndex].material=this.planeMaterial,this.selectIndex=null)}cancelHighLightByIndex(e){this.children[e].material=this.planeMaterial}init(){this.calculationPlanes(this.cubeSize,this.center)}hitTest(e){var t=null,i=null;if(this.raycast(e),null!=this.selectIndex){var r=e.ray,a=new THREE.Plane,n=this.uniforms.vClipPlane.value[this.selectIndex];a.setComponents(n.x,n.y,n.z,n.w),t=r.distanceToPlane(a),i=r.direction.dot(a.normal)<0}return{sign:i,distance:t}}raycast(e){if(this.visible){var t=[],i=null;this.selectIndex=null;for(var r=0;r<6;r++)if(this.children[r].raycast(e,t),t.length>0){var a=t.pop();(!i||a.distance<i.distance)&&(i=a,this.selectIndex=r),t=[]}}}}var l=function(e,t,i,r,a,n,s,o,l,d,h,c,u,p){this.enable=e,this.visible=t,this.rotatable=i,this.calculation=r,this.planeOffset=a.slice(0),this.planeRotate=n.slice(0),this.position=s,this.scale=o,this.quaternion=l,this.cubeSize=d,this.center=h,this.boundingBox=c,this.isHatchEnabled=u,this.isHatchByMaterial=p};r.ClipPlanes=o})(),(()=>{var e=new THREE.Quaternion,t=new THREE.Vector3(1,0,0),i=new THREE.Vector3(0,1,0),a=new THREE.Vector3(0,0,1);let n=new THREE.Matrix4,s=function(e,t,i,r,a,n,s,o,l,d,h){this.enable=e,this.visible=t,this.rotatable=i,this.planeOffset=r,this.position=a,this.scale=n,this.quaternion=s,this.cubeSize=o,this.center=l,this.normalIndex=d,this.isHatchByMaterial=h};class o extends r.ObjectGroup{constructor(e,t){super(r.ObjectGroupType.FILLCLIPPLANE,{priority:20}),this.cubeSize=e.clone(),this.originBoundingBox=(new THREE.Box3).setFromCenterAndSize(t,e),this.boundingBox=this.originBoundingBox.clone(),this.center=t.clone(),this.length=Math.max(this.cubeSize.x,Math.max(this.cubeSize.y,this.cubeSize.z)),this.planeOffset=0,this.normalIndex=3,this.visible=!1,this.rotatable=!1,this.hit=!1,this.clipplane=new THREE.Vector4,this.observer=null,this.renderClipPlane=new THREE.Plane,this.angleA=0,this.angleB=0,this.capsIntersectPosition=[],this.capsIntersectContour={},this.clipPlaneBox=null,this.innerClipping=!1,this.limitDragging=!0,this.orthoViewProjMatrix=new THREE.Matrix4,this.planeWidth=null,this.planeHeight=null,this.uniforms={iClipPlane:{value:0},vClipPlane:{value:new Array(new THREE.Vector4)}},this.planeMaterial=new r.PhongLightingMaterial({color:16777215,opacity:0,transparent:!0,side:THREE.DoubleSide,lights:!0}),this.planeHighLightMatrial=new r.PhongLightingMaterial({color:1170103,opacity:.1,transparent:!0,side:THREE.DoubleSide,lights:!0}),this.renderOrder=r.EnumRenderOrder.ClipPlane}initPlaneModel(){for(var e=this.children.length-1;e>=0;--e)this.remove(this.children[e]);this.planeOffset=0;var t=this.length,i=new THREE.PlaneGeometry(t,t),a=new THREE.Mesh(i,this.planeMaterial);a.name="fillClipPlane",a.customTag=!0,a.renderOrder=r.EnumRenderOrder.ClipPlane,this.position.copy(this.center),this.clipplane.set(0,0,1,0),this.planeMesh=a,this.planeMesh.geometry.computeBoundingBox(),this.clipPlaneBox=this.planeMesh.geometry.boundingBox,this.add(a)}initWireframes(){var e=.5*this.length,t=[-e,e,0,e,e,0,-e,-e,0,e,-e,0],i=new THREE.BufferGeometry,a=new r.PhongLightingMaterial({color:1170103,lights:!0});i.setIndex([0,1,1,3,3,2,2,0]),i.setAttribute("position",new THREE.Float32BufferAttribute(t,3));var n=new THREE.LineSegments(i,a);n.name="Wireframes",n.customTag=!0,this.wireframeMesh=n,this.add(n)}resizeGeometry(e,t){var i=new THREE.PlaneGeometry(e,t);this.planeMesh.geometry=i,this.planeMesh.geometry.computeBoundingBox(),this.clipPlaneBox=this.planeMesh.geometry.boundingBox;var r=.5*e,a=.5*t,n=[-r,a,0,r,a,0,-r,-a,0,r,-a,0],s=new THREE.BufferGeometry;if(s.setIndex([0,1,1,3,3,2,2,0]),s.setAttribute("position",new THREE.Float32BufferAttribute(n,3)),this.wireframeMesh.geometry=s,this.capPlane){var o=new THREE.PlaneGeometry(e,t);this.capPlane.planeMesh.geometry=o}}getCoordinate(){var e=this.planeWidth?.5*this.planeWidth:.5*this.length,t=this.planeHeight?.5*this.planeHeight:.5*this.length,i=new THREE.Vector3(-e,t,0);i.applyMatrix4(this.matrix);var r=new THREE.Vector3(e,t,0);r.applyMatrix4(this.matrix);var a=new THREE.Vector3(-e,-t,0);return a.applyMatrix4(this.matrix),{axisX:i.clone().sub(r).normalize(),axisY:i.clone().sub(a).normalize()}}initCapsPlane(e,t,i){if(this.capPlane)return this.capPlane;var a=this.length,n=new THREE.PlaneGeometry(a,a),s=new r.PhongLightingMaterial({color:6380315,side:THREE.DoubleSide,viewportSize:t,backSceneTexture:e}),o=new THREE.Mesh(n,s),l=this.planeMesh;o.matrixWorld=l.matrixWorld,o.matrix=this.matrix;for(var d=.5*this.length,h=[],c=5;c<2*this.length;c+=5){var u,p;c<this.length?(u=-d,p=-d+c):(u=-d+c-this.length,p=d),h.push(u,p,0),h.push(p,u,0)}var m=new THREE.LineMaterial({color:2236962});m.linewidth=1,m.resolution.set(t.x,t.y),m.depthTest=!1;var f=new THREE.LineSegmentsGeometry;f.setPositions(h);var g=new THREE.LineSegments2(f,m);return g.matrix=this.matrix,g.matrixWorld=l.matrixWorld,i&&(s.defines.USE_CAP="",g.visible=!1),this.capPlane={planeMesh:o,lineMesh:g},this.capPlane}addToCapsWireframe(e){if(this.capsWireframe)this.capsWireframe.geometry.setPositions(this.capsIntersectPosition),this.capsWireframe.geometry._maxInstanceCount=void 0;else{var t=new THREE.LineSegmentsGeometry;t.setPositions(this.capsIntersectPosition),this.capsWireframe=new THREE.LineSegments2(t,new THREE.LineMaterial({color:2236962,linewidth:1,polygonOffset:!0,polygonOffsetFactor:-1,polygonOffsetUnits:-10,resolution:new THREE.Vector2(window.innerWidth,window.innerHeight)}));var i=e.manager.getModelLengthUnitsMatrix(e),a=e.manager.scene.getOrCreateObjectGroup(r.ObjectGroupType.CAPSWIREFRAME,{globalSpace:!0});i&&a.applyMatrix4(i),a.add(this.capsWireframe),a.updateMatrixWorld(!0)}}clearCapsWireframe(){this.capsIntersectPosition.length=0,this.capsIntersectPosition=[],this.capsWireframe&&this.capsWireframe.geometry.deleteAttribute("instanceStart"),this.capsWireframe&&this.capsWireframe.geometry.deleteAttribute("instanceEnd")}calculateClippingIds(){}reCalculateClippingIds(e){this.calculateClippingIds(e)}updateClippingParams(e){}getFillClipBoundingBox(){return this.boundingBox}getFillClipPlaneBoundingBox(){let e=this.clipPlaneBox.clone();const t=this.planeMesh.matrix;return e.applyMatrix4(t),e}calculateFillClipBoundingBox(e){this.boundingBox=this.originBoundingBox.clone(),0!=this.clipplane.x?1==this.clipplane.x?this.boundingBox.max.x=e.x:this.boundingBox.min.x=e.x:0!=this.clipplane.y?1==this.clipplane.y?this.boundingBox.max.y=e.y:this.boundingBox.min.y=e.y:0!=this.clipplane.z&&(1==this.clipplane.z?this.boundingBox.max.z=e.z:this.boundingBox.min.z=e.z)}enable(e,t){this.visible=t,this.uniforms.iClipPlane.value=e?1:0,this.update()}isEnabled(){return 0!=this.uniforms.iClipPlane.value}update(){if(this.updateMatrixWorld(),n.copy(this.matrix).invert(),n.transpose(),this.uniforms.vClipPlane.value[0]=this.clipplane.clone().applyMatrix4(n),this.innerClipping){var e=this.planeWidth,t=this.planeHeight;this.orthoCamera=new THREE.OrthographicCamera(-e/2,e/2,t/2,-t/2,.1,2e3),this.orthoCamera.position.set(this.position.x,this.position.y,this.position.z);var i=this.uniforms.vClipPlane.value[0].clone(),r=new THREE.Vector3(i.x,i.y,i.z);r.normalize();var a=new THREE.Vector3(this.position.x,this.position.y,this.position.z);a.add(r),this.orthoCamera.lookAt(a),this.orthoCamera.updateMatrixWorld(!0),this.orthoViewProjMatrix.copy(this.orthoCamera.projectionMatrix),n.copy(this.orthoCamera.matrixWorld).invert(),this.orthoViewProjMatrix.multiply(n)}this.updateClippingParams(this.uniforms),this.observer&&this.observer()}getClipPlane(){return this.clipplane.clone()}offset(e){var t=0;this.normalIndex<2?t=this.cubeSize.x:this.normalIndex<4?t=this.cubeSize.z:this.normalIndex<6&&(t=this.cubeSize.y),this.planeOffset+=e,this.limitDragging&&Math.abs(this.planeOffset)>.5*t&&(this.planeOffset=this.planeOffset>0?.5*t:.5*-t);var i=this.uniforms.vClipPlane.value[0].clone(),r=new THREE.Vector3(i.x,i.y,i.z);r.normalize();var a=new THREE.Vector3(r.x*this.planeOffset,r.y*this.planeOffset,r.z*this.planeOffset);this.position.copy(this.center).add(a),this.update()}setOffset(e){var t=0;this.normalIndex<2?t=this.cubeSize.x:this.normalIndex<4?t=this.cubeSize.z:this.normalIndex<6&&(t=this.cubeSize.y),this.planeOffset=e,this.limitDragging&&Math.abs(e)>.5*t&&(this.planeOffset=e>0?.5*t:.5*-t);var i=this.uniforms.vClipPlane.value[0].clone(),r=new THREE.Vector3(i.x,i.y,i.z);r.normalize();var a=new THREE.Vector3(r.x*this.planeOffset,r.y*this.planeOffset,r.z*this.planeOffset);this.position.copy(this.center).add(a),this.update()}changeNormal(e){this.quaternion.set(0,0,0,1),this.angleA=0,this.angleB=0,this.setNormal(e)}setNormal(e){var t=this.planeMesh,i=this.wireframeMesh;0==e?(this.clipplane.set(1,0,0,0),t.rotation.set(0,Math.PI/2,0),i.rotation.set(0,Math.PI/2,0)):1==e?(this.clipplane.set(-1,0,0,0),t.rotation.set(0,-Math.PI/2,0),i.rotation.set(0,-Math.PI/2,0)):2==e?(this.clipplane.set(0,0,-1,0),t.rotation.set(Math.PI,0,0),i.rotation.set(Math.PI,0,0)):3==e?(this.clipplane.set(0,0,1,0),t.rotation.set(0,0,0),i.rotation.set(0,0,0)):4==e?(this.clipplane.set(0,1,0,0),t.rotation.set(-Math.PI/2,0,0),i.rotation.set(-Math.PI/2,0,0)):5==e&&(this.clipplane.set(0,-1,0,0),t.rotation.set(Math.PI/2,0,0),i.rotation.set(Math.PI/2,0,0)),this.normalIndex=e,t.updateMatrixWorld(),i.updateMatrixWorld(),this.capPlane&&(this.capPlane.planeMesh.matrixWorld=t.matrixWorld,this.capPlane.lineMesh.matrixWorld=t.matrixWorld),this.update()}rotX(i){e.setFromAxisAngle(t,i),this.quaternion.multiply(e),this.update()}rotY(t){e.setFromAxisAngle(i,t),this.quaternion.multiply(e),this.update()}rotateByAxis(t,i){e.setFromAxisAngle(t,i),this.quaternion.multiply(e)}rotateAngleOffset(e,r){var n=this.normalIndex;e=e%360/180*Math.PI,0==n||1==n?("y"==r&&this.rotateByAxis(a,e),"z"==r&&this.rotateByAxis(i,e)):2==n||3==n?("x"==r&&this.rotateByAxis(t,e),"z"==r&&this.rotateByAxis(i,e)):4!=n&&5!=n||("x"==r&&this.rotateByAxis(t,e),"y"==r&&this.rotateByAxis(a,e)),this.update()}setRotateAngle(e,r){this.quaternion.set(0,0,0,1);var n=this.normalIndex;e=(e=null==e?this.angleA:e%360)<0?360+e:e,r=(r=null==r?this.angleB:r%360)<0?360+r:r,this.angleA=e,this.angleB=r,e=e/180*Math.PI,r=r/180*Math.PI,0==n||1==n?(e=0==n?-e:e,r=0==n?r:-r,this.rotateByAxis(a,e),this.rotateByAxis(i,r)):2==n||3==n?(this.rotateByAxis(t,e),this.rotateByAxis(i,r)):4!=n&&5!=n||(e=3==n?-e:e,r=3==n?r:-r,this.rotateByAxis(t,e),this.rotateByAxis(a,r)),this.update()}getRotateAngle(){return{angleA:this.angleA,angleB:this.angleB}}highLight(){this.planeMesh.material=this.planeHighLightMatrial}cancelHighLight(){this.planeMesh.material=this.planeMaterial,this.hit=!1}store(e){return new s(!!this.uniforms.iClipPlane.value,this.visible,this.rotatable,this.planeOffset,this.position.clone(),this.scale.clone(),this.quaternion.clone(),this.cubeSize.clone(),this.center.clone(),this.normalIndex,this.clipCapsManager.hatchByMaterialForPlane)}restore(e){this.enable(e.enable,e.visible),this.rotatable=e.rotatable,this.planeOffset=e.planeOffset,this.position.copy(e.position),this.scale.copy(e.scale),this.quaternion._w=e.quaternion._w,this.quaternion._x=e.quaternion._x,this.quaternion._y=e.quaternion._y,this.quaternion._z=e.quaternion._z,this.normalIndex=null==e.normalIndex?this.normalIndex:e.normalIndex,this.setNormal(this.normalIndex),this.setBorder(this.length,this.length,!1),this.cubeSize.set(e.cubeSize.x,e.cubeSize.y,e.cubeSize.z),this.clipCapsManager.enableHatchByMaterial(e.isHatchByMaterial,!1),this.clearCapsWireframe(),this.calculateClippingIds()}setProcess(e){var t=0;this.normalIndex<2?t=this.cubeSize.x:this.normalIndex<4?t=this.cubeSize.z:this.normalIndex<6&&(t=this.cubeSize.y),e>1?e=1:e<-1&&(e=-1),this.planeOffset=e*t*.5;var i=this.uniforms.vClipPlane.value[0].clone(),r=new THREE.Vector3(i.x,i.y,i.z);r.normalize();var a=new THREE.Vector3(r.x*this.planeOffset,r.y*this.planeOffset,r.z*this.planeOffset);this.position.copy(this.center).add(a),this.update()}restoreRotation(){this.quaternion.set(0,0,0,1),this.update()}getProcess(){var e=0;return this.normalIndex<2?e=this.cubeSize.x:this.normalIndex<4?e=this.cubeSize.z:this.normalIndex<6&&(e=this.cubeSize.y),this.planeOffset/e*2}init(){this.initPlaneModel(),this.initWireframes()}hitTest(e){if(this.visible){var t=null,i=null;if(this.hit=this.raycast(e),this.hit){var r=e.ray,a=new THREE.Plane,n=this.uniforms.vClipPlane.value[0];a.setComponents(n.x,n.y,n.z,n.w),t=r.distanceToPlane(a),i=r.direction.dot(a.normal)<0}return{sign:i,distance:t}}this.hit=!1}raycast(e,t){var i=[];return this.planeMesh.raycast(e,i),i.length>0}resize(e){var t=Math.max(e.x,Math.max(e.y,e.z))/this.length;this.scale.set(t,t,t),this.cubeSize.copy(e)}setBorder(e,t,i){this.planeWidth=e,this.planeHeight=t,this.resizeGeometry(e,t),this.cubeSize.set(1,e,t),this.originBoundingBox=(new THREE.Box3).setFromCenterAndSize(this.center,this.cubeSize),this.boundingBox=this.originBoundingBox.clone(),this.innerClipping=!r.Utils.isDefined(i)||i,this.limitDragging=!1,this.update()}getSideLength(){return this.length*this.scale.x}updateCamera(e){!1!==this.visible&&(e.calculateNearFar({fillClipPlane:!0}),e.cameraControl.updateCamera())}}r.FillClipPlane=o})(),r.ClipPlaneService=function(e){this.viewer=e},r.ClipPlaneService.prototype={construtor:r.ClipPlaneService,destroy:function(){this.viewer=null},update:function(e){var t=this.getEditor();t&&(t.update(e),this.viewer.render())},getEditor:function(){for(var e=this.viewer.editorManager.tools,t=0;t<e.length;t++)if(e[t].getName()==r.EditToolMode.CLIP_BY_BOX)return e[t];return null},setSectionBox:function(e,t){this.getEditor().setSectionBox(e,t)},toggle:function(e,t){this.getEditor().toggle(e,t)},setVisible:function(e){this.getEditor().visible(e)},setRotatable:function(e){this.getEditor().rotatable(e)},enablePick:function(e){this.getEditor().enablePick=e},saveState:function(){return this.getEditor().store()},loadState:function(e){this.getEditor().restore(e)},reset:function(){r.ClipPlaneManager.resetClipPlanes(this.viewer.getScene()),this.getEditor().reset()},recalculate:function(){return this.viewer.getFilter().getVisibleComponentsBbox()},setProcess:function(e,t){this.getEditor().setProcess(e,t)},getProcess:function(e){return this.getEditor().getProcess(e)},changeDirection:function(e){this.getEditor().changeDirection(e)},visibleCapsWireframe:function(e){return this.getEditor().visibleCapsWireframe(e)}},(()=>{let e=new THREE.Vector3,t=new THREE.Vector3;class i{constructor(){}}i.getInstance=function(i){if(null==i.clipPlanes){var a=i.getBoundingBox();i.clipPlanes=new r.ClipPlanes(a.getSize(t).multiplyScalar(i.expandScalar),a.getCenter(e)),i.objectGroups.add(i.clipPlanes)}return i.clipPlanes},i.destroy=function(e){e.clipPlanes=null},i.setClipPlanes=function(i,a){if(a){var n=r.ClipPlaneManager.getInstance(i);a.setFromCenterAndSize(a.getCenter(e),a.getSize(t).multiplyScalar(i.expandScalar)),n.setSectionBox(a.min,a.max)}},i.resetClipPlanes=function(i){var a=r.ClipPlaneManager.getInstance(i),n=i.getBoundingBox();a.reset(),n.max.x!=-1/0&&n.max.y!=-1/0&&n.max.z!=-1/0&&n.min.x!=1/0&&n.min.y!=1/0&&n.min.z!=1/0?(n.setFromCenterAndSize(n.getCenter(e),n.getSize(t).multiplyScalar(i.expandScalar)),a.setSectionBox(n.min,n.max)):i.clipPlanes=null},i.disableClipPlanes=function(e){null!=e.clipPlanes&&(e.clipPlanes.enable(!1,!1),e.clipPlanes.update())},r.ClipPlaneManager=i})(),(()=>{let e=new THREE.Vector3,t=new THREE.Vector3;class i{constructor(){}}i.getInstance=function(i){if(null==i.fillClipPlane){var a=new THREE.Box3;a.copy(i.getBoundingBoxWithoutDEM()),i.fillClipPlane=new r.FillClipPlane(a.getSize(t).multiplyScalar(i.expandScalar),a.getCenter(e)),i.objectGroups.add(i.fillClipPlane)}return i.fillClipPlane},i.destroy=function(e){e.fillClipPlane=null},i.disableClipPlanes=function(e){null!=e.fillClipPlane&&(e.fillClipPlane.enable(!1,!1),e.fillClipPlane.update())},i.getFillClipPlaneBoundingBoxWorld=function(e){const t=i.getInstance(e).planeMesh;t.geometry.computeBoundingBox();let r=t.geometry.boundingBox.clone();var a=e.getInverseMatrixGlobal();return r.applyMatrix4(t.matrixWorld).applyMatrix4(a),r},i.getCreatedFillClipPlane=function(e){return e.fillClipPlane},r.FillClipPlaneManager=i})(),function(){class e{constructor(){}static getContours(t,i,a){let n,s,o=[],l=(e,t,i)=>{let r=0;for(let a=0;a<i.length;a++){let n=i[a];if(a!=t&&0==n.checked&&n.faceIndex==e.faceIndex){r=a;break}}return r},d=(t,i)=>{let a=-1;for(let n=0;n<i.length;n++){let s=i[n];if(0==s.checked&&r.GeomUtil.isVector3Equal(s,t,e.tolerance)){a=n;break}}return a},h=(t,i,a)=>{let n=d(t,i);if(-1===n&&(t.x=a[0].x,t.y=a[0].y,t.z=a[0].z,a.reverse(),n=d(t,i),-1===n))return a;let s=i[n];s.checked=!0;let o=i[l(s,n,i)];return o.checked=!0,r.GeomUtil.isVector3Equal(o,a[0],e.tolerance)?(a.push(a[0].clone()),a):(a.push(o.clone()),h(o,i,a))},c=0,u=0;for(let e=0;e<t.length;e++)if(1!=t[e].checked){c=e,n=t[c],n.checked=!0,u=l(n,c,t),s=t[u],s.checked=!0,o.push(n.clone()),o.push(s.clone());break}o=h(s,t,o),i.push(o);let p=0;return t.forEach((e=>{p+=1==e.checked?1:0})),p!=t.length?this.getContours(t,i,!1):i}static concatContours(t){if(1===t.length)return t[0];let i=[];t.map((e=>{e.map((e=>{let t={checked:!1};t.line=e,i.push(t)}))}));let a=[],n=t=>{let i,s=(t,i,a)=>{let n=-1;for(let o=0;o<a.length;o++){const l=a[o],d=l.line;if(o!==i&&1!=l.checked){if(r.GeomUtil.isVector3Equal(t[0],d[0],e.tolerance)){t.reverse(),d.map(((e,i)=>{0!=i&&t.push(e)})),n=o,a[o].checked=!0,s(t,n,a);break}if(r.GeomUtil.isVector3Equal(t[0],d[d.length-1],e.tolerance)){d.reverse(),d.map(((e,i)=>{0!=i&&t.unshift(e)})),n=o,a[o].checked=!0,s(t,n,a);break}if(r.GeomUtil.isVector3Equal(t[t.length-1],d[0],e.tolerance))d.map(((e,i)=>{0!=i&&t.push(e)})),n=o,a[o].checked=!0,s(t,n,a);else if(r.GeomUtil.isVector3Equal(t[t.length-1],d[d.length-1],e.tolerance)){d.reverse(),d.map(((e,i)=>{0!=i&&t.push(e)})),n=o,a[o].checked=!0,s(t,n,a);break}}}},o=0;for(let e=0;e<t.length;e++){if(!0===t[e].checked)continue;i=t[e],t[e].checked=!0,o=e,s(i.line,o,t),a.push(i.line);let r=0;if(t.forEach((e=>{r+=1==e.checked?1:0})),r!=t.length)return n(t)}return a};return n(i)}static searchInnerRing(e){let t=e=>{const t=e[0],i=e[e.length-1];return r.GeomUtil.isVector3Equal(t,i,.1)};e.length;let i=[];e.map((e=>{let t={checked:!1};t.line=e,t.box=new THREE.Box3,e.map((e=>{t.box.expandByPoint(e)})),i.push(t)}));let a={},n=e=>{let i,r=(e,t,i)=>{for(let r=0;r<i.length;r++){const n=i[r],s=n.box;if(r!==t&&1!=n.checked)if(e.containsBox(s)){void 0===a[t]?a[t]=[r]:a[t].push(r),a[r]&&a[r].length>0&&(a[t]=a[t].concat(a[r]),delete a[r]);for(const e in a)a[e].indexOf(t)>-1&&(a[e]=a[e].concat(a[t]),delete a[t]);i[r].checked=!0}else if(s.containsBox(e)){void 0===a[r]?a[r]=[t]:a[r].push(t),i[r].checked=!0,a[t]&&a[t].length>0&&(a[r]=a[r].concat(a[t]),delete a[t]);for(const e in a)a[e].indexOf(r)>-1&&(a[e]=a[e].concat(a[r]),delete a[r])}else;}},s=0;for(let a=0;a<e.length;a++){if(!t(e[a].line))continue;if(!0===e[a].checked)continue;i=e[a],e[a].checked=!0,s=a,r(i.box,s,e);let o=0;if(e.forEach((e=>{o+=1==e.checked?1:0})),o!=e.length)return n(e)}};return n(i),a}}e.tolerance=.001,r.ClipPlaneContourManager=e}(),(()=>{let e=new THREE.Matrix4,t=new THREE.Vector3;class i extends r.BaseModel{constructor(e){super(e.getModelManager(),{modelId:"ExternalComponent"}),this.manager.addModel(this),this.filter=new r.FilterManager,this.filter.setObserverForSceneState(this.manager.getFilter().getObserverForSceneState()),this.castShadow=!1,this.receiveShadow=!1,this.meshes={},this.customSelectMaterials={},this.databagId="ExternalComponent",this.objectIds=null,this.lastFilteredIds=null,this.firstAnimation=!0,this.animationIds={},this.animationLength=0,this.animationId=0,this.invalidObjectType=["invalidPlane"],this.floorExplosion=!1,this.blinkMaterials=[],this.blinkMaterialMap={},this.blinkOriginMaterialMap={},this.rawBoundingBoxMap={},this.bindModelMap={},this.mixers={},this.activeMixerIndex={},this.actions={},this.hoveredRenderOrder=-100}destroy(){if(this.manager.removeModel(this.id),this.pickingNodeGenerators){for(var e in this.pickingNodeGenerators)this.pickingNodeGenerators.hasOwnProperty(e)&&this.pickingNodeGenerators[e].destroy();this.pickingNodeGenerators=null}this._removeNodeGroup(),this.meshes=null,this.customSelectMaterials=null,this.objectIds=null,this.lastFilteredIds=null,this._cancelAnimate(),this.firstAnimation=null,this.animationIds=null,this.invalidObjectType=null,this.blinkMaterials=null,this.blinkMaterialMap=null,this.blinkOriginMaterialMap=null,this.selectedIds=null,this.blinkedIds=null,this.rawBoundingBoxMap=null,this.bindModelMap=null,super.destroy()}cloneNode(e,t){this.addNode(t,this.meshes[e])}addNode(t,i,a={}){if(!r.Utils.isDefined(i))return void console.log("Warning: the object is invalid");if(this.meshes[t])return void console.log("Warning: name is already exist, please change name ");if(-1!=this.invalidObjectType.indexOf(i.type))return void console.log("Warning: the object is invalid");let n;i.externalComponentManager=this,i instanceof Array||(i=[i]);for(let e in this.meshes)if(this.meshes[e][0].uuid===i[0].uuid){n=e;break}if(n){this.meshes[t]=[];let e=this.meshes[n].length;for(let i=0;i<e;i++)this.meshes[t][i]=r.SkeletonUtils.clone(this.meshes[n][i]),this.meshes[t][i].animations=this.meshes[n][i].animations,this.meshes[t][i].position.copy(this.meshes[n][i]._oriPosition),this.meshes[t][i].quaternion.copy(this.meshes[n][i]._oriQuaternion),this.meshes[t][i].scale.copy(this.meshes[n][i]._oriScale),this.meshes[t][i].matrix=(new THREE.Matrix4).copy(this.meshes[n][i]._oriMatrix),this.meshes[t][i].visible=!0;i=this.meshes[t]}else this.meshes[t]=i;var s,o,l=[r.ExternalObjectConverterGroup];for(s=0,o=i.length;s<o;s++){var d=!1;l.some((e=>(i[s]instanceof e&&(d=!0),d))),d?(c=i[s].clone(),i[s]=c):c=i[s],void 0===c._oriMatrix&&(c._oriMatrix=new THREE.Matrix4),c._oriPosition=(new THREE.Vector3).copy(c.position),c._oriQuaternion=(new THREE.Quaternion).copy(c.quaternion),c._oriScale=(new THREE.Vector3).copy(c.scale),c._oriMatrix.compose(c.position,c.quaternion,c.scale)}this._isPickingEffectEnabled()&&this.getPickingNodeGenerator().addNode(t,i),a.customSelectMaterial&&(this.customSelectMaterials[t]=a.customSelectMaterial);var h=this.getModelManager().viewer;for(s=0,o=i.length;s<o;s++){var c;(c=i[s]).name=t;var u=new THREE.Box3;u.setFromObject(c),c.box=u,e.copy(c.matrix).invert(),c.originBox=u.clone().applyMatrix4(e),this._initializeAutoAnimation(c,t),this._getNodeGroup().add(c),c.updateMatrixWorld(!0);let n=r.Utils.defaultValue(a.holdMaterialWhenPicked,!1);this._cacheNodeMaterial(c,n),r.GlobalData.EnableShadowMap&&(h.traverseGroupEnableShadow(c,this.castShadow,this.receiveShadow),h.updateShadowMap())}let p=r.Utils.defaultValue(a.objectData,{});if(r.Utils.isDefined(i[0].sourceComponentId)){let e=h.getUserdataByUserId(i[0].sourceComponentId);r.Utils.isDefined(e)&&(p=Object.assign({},p,e))}this._addToNodeInfoMap({name:t,userId:t,boundingBox:new THREE.Box3,state:r.EnumObjectState.Visible,userData:p}),this._updateBoundingBoxByObjectId(t),this._updateFilterManager(),this.objectIds=Object.keys(this.meshes),this.rawBoundingBoxMap[t]=this.getBoundingBoxById(t).clone()}setObjectData(e,t){this._updateUserData(e,t)}getObjectData(e){if(!this.nodeInfoMap)return;const t=this.nodeInfoMap[e];return r.Utils.isDefined(t)?t[0].userData:void 0}bindModel(e,t,i){if(t=r.Utils.defaultValue(t,"ExternalComponent"),this.meshes[e]&&this.getModelManager().modelCollection.getIds().indexOf(t.toString())>=0){if(this.getBindedInfo(e))return;this.bindModelMap[t]||(this.bindModelMap[t]={}),this.bindModelMap[t][e]=i||-1;let r=this.getModelManager().explosionManager;if(0!==r.getFloorExplosionExtent(t)){let i=r.getFloorInfos(t),a=this.meshes[e],n=this.getPickingNodeGenerator().pickingNodeMap[e];for(let e=0;e<a.length;e++){let t=a[e],r=n[e];this.explodeMesh(t,r,i,!0)}}}}unbindModel(e,t){if(this.bindModelMap[t]&&this.bindModelMap[t][e]){delete this.bindModelMap[t][e];const i=(e,t)=>{if(void 0!==e.explodedHeight){const i=e.explodedDirection.clone().negate().multiplyScalar(e.explodedHeight);let r=new THREE.Matrix4;r.makeTranslation(i.x,i.y,i.z),e.applyMatrix4(r),e.updateMatrixWorld(),t.applyMatrix4(r),t.updateMatrixWorld(),delete e.explodedDirection,delete e.explodedHeight,delete e.preExplodedDirection,delete e.preExplodedHeight}};let r=this.meshes[e];if(!r)return;let a=this.getPickingNodeGenerator().pickingNodeMap[e];for(let e=0;e<r.length;e++){i(r[e],a[e])}}}getBindedInfo(e){let t,i;return Object.keys(this.bindModelMap).some((r=>{let a=this.bindModelMap[r][e];if(a)return t=r,i=a,!0})),t?-1==i?{modelId:t}:{modelId:t,objectId:i}:void 0}getNodeById(e){var t=this.meshes[e];return t&&1===t.length?t[0]:t}removeNodeById(e){if(!this._hasObjectId(e))return;var t=this.meshes[e];t[0].autoAnimation&&(delete this.animationIds[e],this.animationLength--,0==this.animationLength&&this._cancelAnimate()),delete this.meshes[e],delete this.rawBoundingBoxMap[e],this._isPickingEffectEnabled()&&this.getPickingNodeGenerator().removeNodeById(e),this.customSelectMaterials[e]&&delete this.customSelectMaterials[e];for(var i=this._getNodeGroup(),r=0,a=t.length;r<a;r++)i.remove(t[r]);this._removeFromNodeInfoMap(e),this._updateFilterManager(),this.filteredIds&&this.filteredIds[e]&&(delete this.filteredIds[e],this.lastFilteredIds=Object.keys(this.filteredIds)),this.objectIds=Object.keys(this.meshes),this.getModelManager().viewer.updateShadowMap();let n=this.getBindedInfo(e);n&&this.unbindModel(e,n.modelId)}clearGroup(e){for(;e.children.length>0;)this.clearGroup(e.children[0]),e.remove(e.children[0]);e.geometry&&e.geometry.dispose(),e.geometry=null;let t=e=>{Object.keys(e).forEach((t=>{e[t]&&null!==e[t]&&"function"==typeof e[t].dispose&&e[t].dispose()})),e.dispose(),e=null};e.material&&(e.material.length>0?(e.material.map((e=>{t(e)})),e.material.length=0):t(e.material),e.material=null)}clearNodes(){this._isPickingEffectEnabled()&&this.getPickingNodeGenerator().clearNodes(),this.clearGroup(this._getNodeGroup()),this._getNodeGroup().clear(),this._clearNodeInfoMap(),this.meshes={},this.rawBoundingBoxMap={},this.customSelectMaterials={},this.objectIds=null,this.animationIds={},this.animationLength=0,this._cancelAnimate(),this._updateFilterManager(),this.filteredIds&&(this.filteredIds={},this.lastFilteredIds=Object.keys(this.filteredIds)),this.getModelManager().viewer.updateShadowMap(),this.bindModelMap={}}getAllNodes(){return this.meshes}getAllMeshes(){let e=[],t=i=>{r.Utils.isGroupObject(i)?i.children.forEach((function(i){r.Utils.isMeshObject(i)?e.push(i):t(i)})):e.push(i)};for(let e in this.meshes){this.meshes[e].forEach((e=>{t(e)}))}return e}setAccumulateTransform(e,t,i,r,a){if(this.floorExplosion&&a)a();else if(this._hasObjectId(e)){for(var n=this.meshes[e],s=0,o=n.length;s<o;s++){var l=n[s];this.setAccumulateTransformForMesh(l,t,i,r),l.box=l.originBox.clone().applyMatrix4(l.matrix)}this._updateBoundingBoxByObjectId(e),this._isPickingEffectEnabled()&&this.getPickingNodeGenerator().setAccumulateTransform(e,t,i,r),this.getModelManager().viewer.updateShadowMap()}}setAccumulateOffset(e,t){if(this._hasObjectId(e)&&"[object Object]"===Object.prototype.toString.call(t)&&t.hasOwnProperty("x")&&t.hasOwnProperty("y")&&t.hasOwnProperty("z")){t instanceof THREE.Vector3||(t=new THREE.Vector3(t.x,t.y,t.z));var i=this.meshes[e];if(i.length>0){var r=i[0],a=t.applyQuaternion(r.quaternion);this.setAccumulateTransform(e,a)}}}setTransform(e,t,i,r,a,n){if(this.floorExplosion&&a)a();else if(this._hasObjectId(e)){for(var s=this.meshes[e],o=0,l=s.length;o<l;o++){var d=s[o];this.setTransformForMesh(d,t,i,r,n),d.box=d.originBox.clone().applyMatrix4(d.matrix)}this._updateBoundingBoxByObjectId(e),this._isPickingEffectEnabled()&&this.getPickingNodeGenerator().setTransform(e,t,i,r,n),this.getModelManager().viewer.updateShadowMap()}}rotateOnBasePoint(e,t,i,r){if(!this._hasObjectId(e))return;var a=this.meshes[e];let n=new THREE.Vector3(t.x,t.y,t.z),s=new THREE.Vector3(i.x,i.y,i.z).normalize();for(var o=0,l=a.length;o<l;o++){let e=a[o],t=e.quaternion.clone().clone().invert(),i=e.position.clone(),l=(new THREE.Quaternion).setFromAxisAngle(s,r);e.quaternion.multiply(l);let d=n.clone().sub(i).applyQuaternion(t).applyQuaternion(e.quaternion);e.position.sub(d).add(n.clone().sub(i)),e.updateMatrixWorld(),e.box=e.originBox.clone().applyMatrix4(e.matrix)}this._updateBoundingBoxByObjectId(e),this._isPickingEffectEnabled()&&this.getPickingNodeGenerator().rotateOnBasePoint(e,n,s,r),this.getModelManager().viewer.updateShadowMap()}scaleOnBasePoint(e,t,i){if(!this._hasObjectId(e))return;var r=this.meshes[e];let a=new THREE.Vector3(t.x,t.y,t.z),n=new THREE.Vector3(i.x,i.y,i.z);for(var s=0,o=r.length;s<o;s++){let e=r[s];e.scale.multiply(n);let t=n.clone().sub(new THREE.Vector3(1,1,1)),i=e.quaternion.clone(),o=i.clone().invert(),l=e.position.clone(),d=a.clone().sub(l).applyQuaternion(o).multiply(t).applyQuaternion(i);e.position.sub(d),e.updateMatrixWorld(),e.box=e.originBox.clone().applyMatrix4(e.matrix)}this._updateBoundingBoxByObjectId(e),this._isPickingEffectEnabled()&&this.getPickingNodeGenerator().scaleOnBasePoint(e,a,n)}getTransform(e){if(!this._hasObjectId(e))return null;var t=this.meshes[e];return{position:t[0].position,scale:t[0].scale,rotate:t[0].quaternion}}applyTransform(e,t,i,r){if(this._hasObjectId(e)){var a=this.getTransformMatrix(t,i,r);this.applyTransformMatrix(e,a),this.getModelManager().viewer.updateShadowMap()}}applyTransformMatrix(e,t,i){if(this._hasObjectId(e)){for(var r=this.meshes[e],a=0,n=r.length;a<n;a++){var s=r[a];this.updateMatrixWorldForMesh(s,t,i);var o=s.originBox.clone();s.box=o.applyMatrix4(s.matrix)}this._updateBoundingBoxByObjectId(e),this._isPickingEffectEnabled()&&this.getPickingNodeGenerator().applyTransformMatrix(e,t,i),this.getModelManager().viewer.updateShadowMap()}}getTransformMatrix(e,t,i){e=e||new THREE.Vector3,t=t||new THREE.Vector3(1,1,1),i=i||new THREE.Quaternion;var r=new THREE.Matrix4;return r.compose(e,i,t),r}setAccumulateTransformForMesh(e,t,i,r){t&&(e.position.x+=t.x,e.position.y+=t.y,e.position.z+=t.z),i&&(e.scale.x*=i.x,e.scale.y*=i.y,e.scale.z*=i.z),r&&(e.rotation.x+=r.x,e.rotation.y+=r.y,e.rotation.z+=r.z),e.updateMatrixWorld(),this.getModelManager().viewer.updateShadowMap()}setTransformForMesh(e,t,i,r,a){t=t||e.position,i=i||e.scale,r=r||e.quaternion;var n=this.getTransformMatrix(t,i,r);this.updateMatrixWorldForMesh(e,n,a),this.getModelManager().viewer.updateShadowMap()}updateMatrixWorldForMesh(e,t,i){var r;i?r=t:r=(e._oriMatrix?e._oriMatrix:new THREE.Matrix4).clone().premultiply(t);r.decompose(e.position,e.quaternion,e.scale),e.matrixAutoUpdate||e.matrix.copy(r),e.updateMatrixWorld(!0),this.getModelManager().viewer.updateShadowMap()}applyFilter(){this._hasNode()&&(this._collectFilteredIds(),this._collectSelectedIds(),this._collectBlinkedIds(),this._collectHoveredIds(),this._updateNodes())}applySelection(){this._hasNode()&&(this._collectSelectedIds(),this._collectHoveredIds(),this._updateNodes())}clearSelection(){this._hasNode()&&(this._clearSelectedIds(),this.applyHover())}applyHover(){this._hasNode()&&(this._collectHoveredIds(),this._updateNodes())}clearHover(){this._hasNode()&&(this._clearHoveredIds(),this._updateNodes())}applyBlink(){this._hasNode()&&(this._collectBlinkedIds(),this._collectHoveredIds(),this._updateNodes())}clearBlink(){this._clearBlinkedIds(),this.applyHover()}getAllNodeInfos(){return this.nodeInfoMap}getNodeInfosByUserId(e){return this.nodeInfoMap?this.nodeInfoMap[e]:void 0}_addToNodeInfoMap(e){this.nodeInfoMap||(this.nodeInfoMap={}),this.nodeInfoMap[e.userId]||(this.nodeInfoMap[e.userId]=[]),this.nodeInfoMap[e.userId].push(e)}_removeFromNodeInfoMap(e){this.nodeInfoMap&&this.nodeInfoMap[e]&&delete this.nodeInfoMap[e]}_updateUserData(e,t){if(!this.nodeInfoMap)return;const i=this.nodeInfoMap[e];r.Utils.isDefined(i)&&(i.forEach((e=>{e.userData=Object.assign({},e.userData,t)})),this._updateFilterManager())}_clearNodeInfoMap(){this.nodeInfoMap={}}_updateFilterManager(){var e={};e[this.id]=this.getAllNodeInfos(),this.getFilter().reinitFilterManager(e)}checkVisibleComponentsBox(){var e=0;for(var t in this.meshes)for(var i=this.meshes[t],r=0;r<i.length;r++){var a=i[r];0!=a.children.length&&(e++,this.nodeInfoMap[t]&&this.nodeInfoMap[t][r]&&this.nodeInfoMap[t][r].boundingBox.isEmpty()&&this.nodeInfoMap[t][r].boundingBox.copy(a.box))}return 0!=e}_updateBoundingBoxByObjectId(e){if(this.nodeInfoMap&&this._hasObjectId(e)){var t,i,r=this.meshes[e],a=new THREE.Box3;for(t=0,i=r.length;t<i;t++)a.union(r[t].box);var n=this.nodeInfoMap[e];for(t=0,i=n.length;t<i;t++)n[t].boundingBox.copy(a)}}_canBePick(e){return!e._materialHold}_getNodeGroup(){return this.getModelManager().getScene().getOrCreateObjectGroup(r.ObjectGroupType.EXTERNALCOMPONENTMANAGER,{pickableType:r.PICKABLETYPE.ExternalComponent,globalSpace:!0})}_removeNodeGroup(){this.getModelManager().getScene().removeObjectGroupByName(r.ObjectGroupType.EXTERNALCOMPONENTMANAGER)}_cacheNodeMaterial(e,t){r.Utils.isGroupObject(e)?e.traverse((function(e){if(r.Utils.isMeshObject(e)&&!e._oriMaterial&&(e._oriRenderOrder=e.renderOrder,e._oriMaterial=e.material,e._materialHold=t,!e.geometry.index&&e.geometry.attributes&&e.geometry.attributes.position)){for(var i=[],a=0,n=e.geometry.attributes.position.array.length/3;a<n;a++)i.push(a);e.geometry.setIndex(new THREE.BufferAttribute(new Uint32Array(i),1))}})):e._oriMaterial||(e._oriRenderOrder=e.renderOrder,e._oriMaterial=e.material,e._materialHold=t)}_collectFilteredIds(){var e=this.filteredIds={},t=this.getFilter(),i=t._hasHiddenFileIdFilter(),a=t._hasVisibleFilter(),n=t._hasOverrideMaterialFilter(),s=t._hasTransparentFilter();if(i||a||n||s)for(var o=this.objectIds,l=r.Model.EnumFilterState,d=0,h=o.length;d<h;d++){var c=o[d],u={name:c};if(a&&!1===t._isVisible(u))e[c]||(e[c]={}),e[c][l.HIDDEN]=!0;else if(s&&t._isTransparent(u))e[c]||(e[c]={}),e[c][l.TRANSPARENT]=!0;else if(n&&t._hasOverrideMaterial(u)){var p=t._getOverrideMaterial(u),m=null!=p?p.name:"";e[c]||(e[c]={}),e[c][l.OVERRIDED]=m}else;}}_collectSelectedIds(){var e=this.filteredIds=this.filteredIds||{},t=r.Model.EnumFilterState,i=this.getModelManager().sceneState.getSelection(),a={};this._clearSelectedIds();for(var n=0,s=i.length;n<s;n++){var o=i[n];this.canBeSelectedId(o)&&(e[o]||(e[o]={}),e[o][t.SELECTED]=!0,a[o]=!0)}this.selectedIds=Object.keys(a)}_clearSelectedIds(){if(this.filteredIds&&this.selectedIds&&this.selectedIds.length){for(var e=0,t=this.selectedIds.length;e<t;e++){var i=this.selectedIds[e];this.filteredIds[i]&&delete this.filteredIds[i][r.Model.EnumFilterState.SELECTED]}this.selectedIds=null}}_collectHoveredIds(){this._clearHoveredIds();var e=this.getModelManager().sceneState.hoverId;if(e&&this._hasObjectId(e)){var t=this.filteredIds=this.filteredIds||{};this.hoveredId=e,t[e]||(t[e]={}),t[e][r.Model.EnumFilterState.HOVER]=!0}}_clearHoveredIds(){this.filteredIds&&this.hoveredId&&this.filteredIds[this.hoveredId]&&(delete this.filteredIds[this.hoveredId][r.Model.EnumFilterState.HOVER],this.hoveredId=void 0)}_collectBlinkedIds(){var e=this.manager.sceneState.getBlinkComponentsIdMap(this.id),t=this.filteredIds=this.filteredIds||{},i=r.Model.EnumFilterState,a={};for(var n in this._clearBlinkedIds(),e)this._hasObjectId(n)&&(t[n]||(t[n]={}),t[n][i.BLINK]=!0,a[n]=!0);this.blinkedIds=Object.keys(a)}_clearBlinkedIds(){if(this.filteredIds&&this.blinkedIds&&this.blinkedIds.length){for(var e=0,t=this.blinkedIds.length;e<t;e++){var i=this.blinkedIds[e];this.filteredIds[i]&&delete this.filteredIds[i][r.Model.EnumFilterState.BLINK]}this.blinkedIds=null}}_hasObjectId(e){var t=this.meshes[e];return!(!t||!t.length)}canBeSelectedId(e){var t=this.meshes[e];return!(!t||t[0].disPickable)}_hasNode(){return!(!this.objectIds||!this.objectIds.length)}_traverseNodeById(e,t){if(this._hasObjectId(e))for(var i=this.meshes[e],a=0,n=i.length;a<n;a++){var s=i[a];r.Utils.isGroupObject(s)?s.traverseVisible((function(e){r.Utils.isMeshObject(e)&&t&&t(e)})):r.Utils.isMeshObject(s)&&t&&t(s)}}_resetNodeMaterial(){var e=this.lastFilteredIds;if(e&&e.length)for(var t=0,i=e.length;t<i;t++)this._updateNodeVisible(e[t],!0),this._traverseNodeById(e[t],(function(e){e.material=e._oriMaterial,e.renderOrder=e._oriRenderOrder}))}_updateNodeVisible(e,t){for(var i=this.meshes[e],r=0,a=i.length;r<a;r++)i[r].groundCurve?!0===t?i[r].show():i[r].hide():i[r].visible=t}updateSelectEffect(){for(let t in this.meshes){var e=this.meshes[t];e[0]._geometryUpdated&&(this.getPickingNodeGenerator().removeNodeById(t),this.getPickingNodeGenerator().addNode(t,e),e[0]._geometryUpdated=!0)}}_updateNodeById(e,t){if(this._hasObjectId(e)){var i=this,a=this.hoveredRenderOrder,n=this.getModelManager().sceneState,s=r.Model.EnumFilterState,o=this.filteredIds[e];if(o)if(o[s.HIDDEN])this._updateNodeVisible(e,!1);else if(o[s.TRANSPARENT]){var l=t._getMaterialByName("scene");this._traverseNodeById(e,(function(e){i._canBePick(e)&&(e._oriMaterial instanceof r.CloudStandardMaterial?e.material=l:e.material=r.MaterialUtil.cloneMaterialBaseOnColor(e._oriMaterial,l))}))}else if(this._isPickingEffectEnabled()||!o[s.SELECTED])if(o[s.BLINK])if(o[s.OVERRIDED]){var d=t._getMaterialByName(o[s.OVERRIDED]),h=n.getBlinkMaterial(d,this.id);this._traverseNodeById(e,(function(e){var t=!1;if(e._oriMaterial instanceof r.CloudStandardMaterial)t=!0,e.material=h;else{var a=r.Blink.MaterialFactory[e._oriMaterial.type];a?(t=!0,e.material=i.blinkOriginMaterialMap[e.uuid]||a(),e.material.copy(e._oriMaterial)):e.material=r.MaterialUtil.cloneMaterialBaseOnColor(e._oriMaterial,d)}var n=e.material.uuid;t&&void 0===i.blinkMaterialMap[n]&&(i.blinkMaterialMap[n]=!0,i.blinkOriginMaterialMap[e.uuid]=e.material,i.blinkMaterials.push(e.material))}))}else this._traverseNodeById(e,(e=>{var t=!1;if(e._oriMaterial instanceof r.CloudStandardMaterial)t=!0,e.material=n.getBlinkMaterial(e._oriMaterial,this.id);else{var a=r.Blink.MaterialFactory[e._oriMaterial.type];a&&(t=!0,e.material=i.blinkOriginMaterialMap[e.uuid]||a(),e.material.copy(e._oriMaterial))}var s=e.material.uuid;t&&void 0===i.blinkMaterialMap[s]&&(i.blinkMaterialMap[s]=!0,i.blinkOriginMaterialMap[e.uuid]=e.material,i.blinkMaterials.push(e.material))}));else if(o[s.HOVER])if(o[s.OVERRIDED]){l=n.getHoverMaterial(t._getMaterialByName(o[s.OVERRIDED]));this._traverseNodeById(e,(function(e){i._canBePick(e)&&(e.renderOrder=a,e._oriMaterial instanceof r.CloudStandardMaterial?e.material=l:e.material=r.MaterialUtil.cloneMaterialBaseOnColor(e._oriMaterial,l))}))}else this._traverseNodeById(e,(function(e){if(i._canBePick(e)){e.renderOrder=a;var t=n.getHoverMaterial(e._oriMaterial);e._oriMaterial instanceof r.CloudStandardMaterial?e.material=t:e.material=r.MaterialUtil.cloneMaterialBaseOnColor(e._oriMaterial,t)}}));else if(o[s.OVERRIDED]){var c=t._getMaterialByName(o[s.OVERRIDED]);this._traverseNodeById(e,(function(e){i._canBePick(e)&&(e._oriMaterial instanceof r.CloudStandardMaterial?e.material=c:e.material=r.MaterialUtil.cloneMaterialBaseOnColor(e._oriMaterial,c),e._oriMaterial.useCSM&&null===e.material.uniforms.csmCascades.value&&(e.material.uniforms.csmCascades=e._oriMaterial.uniforms.csmCascades))}))}else;else{var u=n.selectionMaterial,p=this.customSelectMaterials[e];this._traverseNodeById(e,(function(e){i._canBePick(e)&&(p?e.material=p:e._oriMaterial.isMeshPhongMaterial?(e.material=n.phongSelectionMaterial,e.material.skinning=e._oriMaterial.skinning):e._oriMaterial instanceof r.CloudStandardMaterial?e.material=u:e.material=r.MaterialUtil.cloneMaterialBaseOnColor(e._oriMaterial,u))}))}}}_updateNodes(){var e=this.getFilter();if(this._resetNodeMaterial(),this.blinkMaterialMap={},this.blinkMaterials.length=0,this.filteredIds){for(var t in this.filteredIds)this._updateNodeById(t,e);this.lastFilteredIds=Object.keys(this.filteredIds)}}_initializeAutoAnimation(e,i){var a=this.getModelManager().viewer;if(e.autoAnimation){if("fire"==e.type){var n=r.GlobalData.SceneSize,s=a.getBoundingBoxWorld().getSize(t),o=n/Math.max(s.x,s.y,s.z);e._initializeSizetween(o)}this._initializeAnimation(i)}}_initializeAnimation(e){this.firstAnimation&&(this._clock=new THREE.Clock,this._animate(),this.firstAnimation=!1),this.animationIds[e]=!0,this.animationLength++}play(e,t=0){if(this.actions[e]||(this.actions[e]=[]),!this.actions[e][t]){let i=this.getNodeById(e),r=new THREE.AnimationMixer(i);this.actions[e][t]=r.clipAction(i.animations[t]),this.mixers[e]||(this.mixers[e]=[]),this.mixers[e][t]=r,this._initializeAnimation(e,t)}this.activeMixerIndex[e]&&this.stop(e),this.activeMixerIndex[e]=t,this.actions[e][t].play(),this.actions[e][t].paused=!1}pause(e,t){void 0===t&&(t=this.activeMixerIndex[e]),void 0!==t&&this.actions[e]&&this.actions[e][t]&&(this.actions[e][t].paused=!0)}stop(e,t){void 0===t&&(t=this.activeMixerIndex[e]),void 0!==t&&this.actions[e]&&this.actions[e][t]&&(this.actions[e][t].paused=!1,this.actions[e][t].stop())}isAnimation(e){let t=this.getNodeById(e);return!!(t.animations&&t.animations.length>0)}_animate(){var e=this,t=this.getModelManager().viewer;!function i(){e.animationId=requestAnimationFrame(i);var r=e._clock.getDelta(),a=(JSON.parse(t.getCamera()),0);for(var n in e.meshes){var s=e.meshes[n];if(e.mixers[n]&&void 0!==e.activeMixerIndex[n])e.mixers[n][e.activeMixerIndex[n]].update(r);for(var o=0,l=s.length;o<l;o++)s[o].autoAnimation?s[o].update&&s[o].update():s[o].updateMatrixWorld(),null!=s[o].unrender&&0!=s[o].unrender||a++}a>0&&t.render()}()}_cancelAnimate(){this.firstAnimation=!0,cancelAnimationFrame(this.animationId),this.animationId=0}explodeMesh(e,t,i,r,a){let n,s,o,l;const d=t=>{n=e.explodedHeight=t.explodedHeight-t.elevation,s=e.explodedDirection=(t.explodedDirection||new THREE.Vector3).clone(),o=e.preExplodedHeight=t.preExplodedHeight-t.elevation,l=e.preExplodedDirection=(t.preExplodedDirection||new THREE.Vector3).clone()};let h=0;for(let t=i.length-1;t>=0;t--){let n=i[t];if(a){if(n.name==a){d(n);break}}else{let a=i[t].preExplodedTranslation?i[t].preExplodedTranslation.z:0;if(h=r?i[t].boundingBox.min.z:a+i[t].boundingBox.min.z,c=h,e.position.z>=c-1||0===t){d(n);break}}}var c;let u=new THREE.Matrix4;const p=s.clone().multiplyScalar(n).sub(l.clone().multiplyScalar(o));u.makeTranslation(p.x,p.y,p.z),e.applyMatrix4(u),e.updateMatrixWorld(),e.box=e.originBox.clone().applyMatrix4(e.matrix),t.applyMatrix4(u),t.updateMatrixWorld()}explode(e){const t=e.id;if(!t)return;let i=this.bindModelMap[t];if(!i)return;let r=Object.keys(i),a=this.getModelManager().explosionManager.getFloorInfos(t);for(let t=0;t<r.length;t++){let n=r[t],s=i[n],o=-1!=s?e.modelExplosion.getLevelNameByObjId(s):null,l=this.meshes[n];if(!l)continue;let d=this.getPickingNodeGenerator().pickingNodeMap[n];for(let e=0;e<l.length;e++){let t=l[e],i=d[e];this.explodeMesh(t,i,a,void 0,o)}this._updateBoundingBoxByObjectId(n)}}elementExplode(e,t,i){let a=e.id;if(!a)return;let n=this.bindModelMap[a];if(!n)return;let s=Object.keys(n),o=new THREE.Matrix4;for(let a=0;a<s.length;a++){let l=s[a],d=n[l],h=this.meshes[l];if(!h)continue;let c=this.getPickingNodeGenerator().pickingNodeMap[l];for(let a=0;a<h.length;a++){let n=h[a],s=c[a];n.elementExplodeBox||(n.elementExplodeBox=n.box);let l=-1!=d?e.modelExplosion.getExplosionTranslationByObjId(d):r.Utils.computeExplodeTranslation(i,n.elementExplodeBox,t);o.makeTranslation(l.x,l.y,l.z),n.applyMatrix4(o),n.updateMatrixWorld(),n.box=n.originBox.clone().applyMatrix4(n.matrix),s.applyMatrix4(o),s.updateMatrixWorld()}this._updateBoundingBoxByObjectId(l)}}isPickableNode(e){if(!this.canBeSelectedId(e.userId))return!1;var t=this.getFilter();return!t._isHiddenFileId(e)&&!1!==t._isVisible(e)&&!t._isTransparent(e)}hasTransforms(){return!1}isUserIdExist(e){return!!this.meshes[e]}_isPickingEffectEnabled(){return!!r.GlobalData.PickingEffect}getPickingNodeGenerator(e){if(e=null==e?"pick":e,this.pickingNodeGenerators||(this.pickingNodeGenerators={}),this.pickingNodeGenerators[e]||(this.pickingNodeGenerators[e]=new r.PickingExternalMeshGenerator(this),this.pickingNodeGenerators[e].reserveMaterial=!!e.startsWith("glow")),"pick"==e||null==this.pickingNodeGenerators.pick.pickingNodeMap||null!=this.pickingNodeGenerators[e].pickingNodeMap&&!this._checkDirtyData(this.pickingNodeGenerators.pick.pickingNodeMap,this.pickingNodeGenerators[e].pickingNodeMap)){if("pick"!=e&&null!=this.pickingNodeGenerators.pick.pickingNodeMap&&null!=this.pickingNodeGenerators[e].pickingNodeMap)for(o=0;o<this.pickingNodeGenerators[e].pickingNodeGroup.children.length;o++){var t=this.pickingNodeGenerators[e].pickingNodeGroup.children[o].name;if(this.pickingNodeGenerators[e].manager.meshes[t]&&this.pickingNodeGenerators[e].manager.meshes[t].length>0){var i=this.pickingNodeGenerators[e].manager.meshes[t][0];this.pickingNodeGenerators[e].pickingNodeGroup.children[o].rotation.copy(i.rotation),this.pickingNodeGenerators[e].pickingNodeGroup.children[o].position.copy(i.position),this.pickingNodeGenerators[e].pickingNodeGroup.children[o].scale.copy(i.scale)}}}else for(var a=this.pickingNodeGenerators[e],n=this.pickingNodeGenerators.pick.pickingNodeMap,s=Object.keys(n),o=0;o<s.length;o++)a.addToPickingNodeMap(s[o],[n[s[o]][0]]);return this.pickingNodeGenerators[e]}_checkDirtyData(e,t){for(var i=Object.keys(e),r=0;r<i.length;r++)if(null==t[i[r]])return!0;return!1}getPickingMeshes(e,t,i,r,a){var n=this.getPickingNodeGenerator(a).updatePickingMeshes(e,i,r);n&&(t[this.databagId]=n)}getBoundingBoxById(e){return this.isUserIdExist(e)?this.nodeInfoMap[e][0].boundingBox:new THREE.Box3}getBlinkMaterials(){return this.blinkMaterials}getBoundaryPoints(e){let t=this.rawBoundingBoxMap[e],i=this.getTransform(e);const r=(new THREE.Matrix4).compose(i.position,i.rotate,i.scale),a=[new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3];return a[0].set(t.min.x,t.min.y,t.min.z).applyMatrix4(r),a[1].set(t.max.x,t.min.y,t.min.z).applyMatrix4(r),a[2].set(t.max.x,t.max.y,t.min.z).applyMatrix4(r),a[3].set(t.min.x,t.max.y,t.min.z).applyMatrix4(r),a[4].set(t.min.x,t.min.y,t.max.z).applyMatrix4(r),a[5].set(t.max.x,t.min.y,t.max.z).applyMatrix4(r),a[6].set(t.max.x,t.max.y,t.max.z).applyMatrix4(r),a[7].set(t.min.x,t.max.y,t.max.z).applyMatrix4(r),a}getAllNodeGroups(){return this._getNodeGroup().children}collectBlinkedMaterial(e,t){t.push(...this.blinkMaterials)}}r.ExternalComponentManager=i})(),function(){r.ExternalObjectConverter=class{constructor(e){this.viewer=e,this.geometryMapFromComponentId={},this.externalObjectMap={},this.defaultMaterial=r.MaterialUtil.getDefaultStandardMaterial()}destroy(){this.viewer=null,this.geometryMapFromComponentId=null,this.externalObjectMap=null,this.defaultMaterial=null}clear(){this.geometryMapFromComponentId={},this.externalObjectMap={},this.cancelAllHidden()}cancelHiddenByComponentId(e){this.viewer.setRenderStateChanged(!0),this.viewer.modelManager.getSourceObjectManager().cancelHiddenByUserId(e)}cancelAllHidden(){this.viewer.setRenderStateChanged(!0),this.viewer.modelManager.getSourceObjectManager().cancelAllHidden()}convertToExternalObject(e,t,i){if("[object Object]"!==Object.prototype.toString.call(t))t=this.viewer.modelManager.filterHelper.distributeId(t);else if(!this.viewer.modelManager.getModel(t.modelId))return null;return this._hideByUserId(t,i),this.externalObjectMap[e]||(this.externalObjectMap[e]=this._createMeshNodes(e,t)),this.externalObjectMap[e].clone()}getExternalObject(e){return this.externalObjectMap[e]}_hideByUserId(e,t){this.viewer.setRenderStateChanged(!0);var{modelId:i,objectId:r}=e;const a=function(e){if(e.tilesLoader){const t=e.tilesLoader.tileReader.getIndexByUserId(r);void 0!==t&&(r=t,e.filter.enableStateChanged(),e.filter.enableWireFrameStateChanged(),i=e.id)}else e.isUserIdExist(r)&&(i=e.id)};i?a(this.viewer.modelManager.getModel(i)):this.viewer.modelManager.traverseModels(a),this.viewer.modelManager.getSourceObjectManager().hideByUserId(r,t,i)}_getGeometries(e){var{modelId:t,objectId:i}=e,a=this.geometryMapFromComponentId[`${t}_${i}`];if(a)return a;var n=[];if(t){var s=this.viewer.modelManager.getModel(t);if(s._handler)n=n.concat(s._handler.getGeometryBuffersByUserId(i));else if(s.tilesLoader){const e=s.tilesLoader.tileReader.getIndexByUserId(i);n=n.concat(s.getGeometryBuffersByUserId(e))}}else this.viewer.modelManager.traverseModels((function(e){if(e._handler)n=n.concat(e._handler.getGeometryBuffersByUserId(i));else if(e.tilesLoader){const t=e.tilesLoader.tileReader.getIndexByUserId(i);if(!r.Utils.isDefined(t))return;n=n.concat(e.getGeometryBuffersByUserId(t))}}));return a=this.geometryMapFromComponentId[`${t}_${i}`]=this._createGeometry(n)}_createGeometry(e){for(var t=[],i=0,r=e.length;i<r;i++){var a=e[i],n=new THREE.BufferGeometry;if(n.setIndex(new THREE.BufferAttribute(a.index,1)),n.setAttribute("position",new THREE.BufferAttribute(a.position,3)),a.uv&&n.setAttribute("uv",new THREE.BufferAttribute(a.uv,2)),a.isLines||n.computeVertexNormals(),a.color){const e=new THREE.Uint8BufferAttribute(a.color,4);e.normalized=!0,n.setAttribute("color",e)}t.push({info:a,geometry:n})}return t}_createMeshNodes(t,i){var r=new e;r.name=t,r.sourceComponentId=i;for(var a=this._getGeometries(i),n=0,s=a.length;n<s;n++){var o=a[n].geometry,l=a[n].info,{objectId:d}=i;let e=null,t=this.viewer.modelManager.modelCollection.getById(l.databagId);if(t&&t.tilesLoader){let i;if(l.isInstance){const e=t.tilesLoader.getInstanceMeshNodeById(l.nodeId);for(const t in e){i=e[t].mesh}}else i=t.tilesLoader.getMeshNodeById(l.nodeId);e=null==i?this.defaultMaterial:i.material[0].clone(),e.forInstance=!1}else e=this.viewer.modelManager.getMaterialByNodeId(l.databagId,d,l.nodeId)||this.defaultMaterial;var h=new THREE.Mesh(o,e);h=l.isLines?new THREE.LineSegments(o,e):new THREE.Mesh(o,e),delete e.defines.CNORMAL,delete e.defines.USE_INSTANCE,delete e.defines.USE_INSTANCE_NORMAL,h._databagId=l.databagId,h._nodeId=l.nodeId,h._oriUserId=i,h._oriMaterial=e,h._cloned=!0,l.matrix&&(h.matrix.copy(l.matrix),h.matrix.decompose(h.position,h.quaternion,h.scale)),r.add(h)}return r}};class e extends THREE.Group{constructor(){super(),this.sourceComponentId=null}clone(e){return(e=super.clone(e)).sourceComponentId=this.sourceComponentId,e}}r.ExternalObjectConverterGroup=e}(),function(){let e,t=new THREE.Matrix4;r.GroundPrimitiveManager=class{constructor(e){this.viewer=e,this.groundCurveScene=new THREE.Scene,this.depthRenderTarget=new THREE.WebGLRenderTarget(1024,1024,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter}),this.depthWithoutDEMRenderTarget=new THREE.WebGLRenderTarget(1024,1024,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter}),this.shadowVolumes=[],this.shadowVolumeScene=new THREE.Scene,this.backMaterial=new THREE.MeshBasicMaterial({color:16711680,colorWrite:!1,depthWrite:!1,side:THREE.BackSide}),this.frontMaterial=new THREE.MeshBasicMaterial({color:255,colorWrite:!1,depthWrite:!1,side:THREE.FrontSide}),this.inVisibleModelIdMap=void 0,this.inVisibleGroupMap={},this.groundMinHeight=void 0}destroy(){this.groundCurveScene=null,this.depthRenderTarget=null,this.depthWithoutDEMRenderTarget=null,this.shadowVolumes=null,this.shadowVolumeScene=null,this.backMaterial.dispose(),this.backMaterial=null,this.frontMaterial.dispose(),this.frontMaterial=null,this.inVisibleModelIdMap=null,this.inVisibleGroupMap=null,this.viewer=null}createGroundCurve(e){var t=e.color,i=e.width;e.viewer=this.viewer;var a=new r.GroundCurveMaterial({color:new THREE.Color(t.red/255,t.green/255,t.blue/255)});a.side=THREE.DoubleSide,a.depthFunc=THREE.AlwaysDepth,a.depthWrite=!1,a.transparent=!0,a.blending=THREE.NormalBlending,a.opacity=t.alpha,a.lineWidth=i;var n=new r.GroundCurveGeometry(e),s=new r.GroundCurveMesh(n,a),o=this;return s.onBeforeRender=function(e,t,i,r,a,n){var s=a.frustumPlanes;s.x=i.near*Math.tan(.5*THREE.Math.degToRad(i.fov)),s.y=-s.x,s.w=i.aspect*s.x,s.z=-s.w,a.cameraNear=i.near,a.cameraFar=i.far,a.pixelRatio=e.getPixelRatio(),a.viewport.set(0,0,e.getContext().drawingBufferWidth,e.getContext().drawingBufferHeight);var l,d=a.viewport,h=THREE.Math.degToRad(i.fov);l=h?d.w>d.z?2*Math.tan(.5*h)/d.w:2*Math.tan(.5*h)/d.z:1/Math.max(d.z,d.w),a.geometricToleranceOverMeter=2*l,a.cameraProjection.copy(i.projectionMatrix),a.inverseProjection.copy(i.projectionMatrix).invert(),a.globeDepthTexture=o.depthRenderTarget.texture,a.customDepthTexture=o.depthWithoutDEMRenderTarget.texture,a.refreshUniforms()},s}removeGroundCurve(e){this.groundCurveScene.remove(e),0===this.groundCurveScene.children.length&&(this.inVisibleModelIdMap=void 0)}addGroundCurve(e){this.groundCurveScene.add(e)}beforeRender(){if(!this.inVisibleModelIdMap)return;this.inVisibleGroupMap={};const e=this.viewer.getScene();for(const t in this.inVisibleModelIdMap){const i=`${r.ObjectGroupType.BIMTILESGROUP}|${t}`,a=e.getObjectGroup(i);a&&(this.inVisibleGroupMap[i]=a.visible,a.visible=!1)}}afterRender(e,t){if(!this.inVisibleModelIdMap)return;const i=this.viewer.getScene();for(const e in this.inVisibleGroupMap){const t=i.getObjectGroup(e);t&&(t.visible=this.inVisibleGroupMap[e])}}render(e,t,i){i=null==i?null:i,this.renderShadowVolumes(e,t,i),this.renderGroundCurves(e,t,i)}renderGroundCurves(e,t,i){var r=this.groundCurveScene;if(!(r.children.length<=0)){for(var a=!0,n=0;n<r.children.length;n++)r.children[n].visible&&(a=!1);if(!a){this.beforeRender();var s=this.viewer.rendererManager.renderer;s.renderCustomDepth&&s.renderCustomDepth(e,this.viewer.getScene(),t,this.depthRenderTarget,!1),s.renderCustomDepthWithoutDEM&&s.renderCustomDepthWithoutDEM(e,this.viewer.getScene(),t,this.depthWithoutDEMRenderTarget);var o=e.autoClear;e.autoClear=!1;var l=e.getRenderTarget();e.setRenderTarget(i),e.render(r,t),this.afterRender(e,t),e.autoClear=o,e.setRenderTarget(l)}}}renderShadowVolumes(e,t,i){if(!(this.shadowVolumes.length<=0)){var r=e.autoClear;e.autoClear=!1;var a=e.getRenderTarget(),n=this.shadowVolumeScene,s=this.backMaterial,o=this.frontMaterial,l=e.getContext(),d=e.state;d.buffers.stencil.setTest(!0);for(var h=0;h<this.shadowVolumes.length;h++)this.shadowVolumes[h].visible&&(n.add(this.shadowVolumes[h]),d.buffers.stencil.setLocked(!0),d.buffers.stencil.setFunc(l.ALWAYS,0,255),d.buffers.stencil.setOp(l.KEEP,l.INCR,l.KEEP),n.overrideMaterial=s,e.setRenderTarget(i),e.render(n,t),d.buffers.stencil.setFunc(l.ALWAYS,0,255),d.buffers.stencil.setOp(l.KEEP,l.DECR,l.KEEP),n.overrideMaterial=o,e.render(n,t),d.buffers.stencil.setFunc(l.NOTEQUAL,0,255),d.buffers.stencil.setOp(l.ZERO,l.ZERO,l.ZERO),n.overrideMaterial=null,e.render(n,t),d.buffers.stencil.setLocked(!1),n.remove(this.shadowVolumes[h]));e.setRenderTarget(a),d.buffers.stencil.setTest(!1),e.autoClear=r}}createGroundPolygon(e){e.viewer=this.viewer;var t=e.color,i=new THREE.MeshBasicMaterial({color:new THREE.Color(t.red/255,t.green/255,t.blue/255)});i.side=THREE.BackSide,i.depthFunc=THREE.AlwaysDepth,i.depthWrite=!1,i.transparent=!0,i.blending=THREE.NormalBlending,i.opacity=t.alpha;var a=new r.GroundPolygonGeometry(e);return new r.GroundPolygonMesh(a,i)}getGroundMinHeight(){return this.groundMinHeight}computeGroundMinHeight(){0!==this.shadowVolumes.length?(this.groundMinHeight=0,this.shadowVolumes.forEach((e=>{const t=e.geometry.minHeight||0;this.groundMinHeight=Math.min(this.groundMinHeight,t)}))):this.groundMinHeight=void 0}addGroundPolygon(e){this.shadowVolumes.push(e),this.computeGroundMinHeight()}removeGroundPolygon(e){var t=this.shadowVolumes.indexOf(e);-1!==t&&(this.shadowVolumes.splice(t,1),this.computeGroundMinHeight())}setSize(e,t){this.depthRenderTarget.setSize(e,t),this.depthWithoutDEMRenderTarget.setSize(e,t)}setInVisibleModelIdMap(e){this.inVisibleModelIdMap=e}getInVisibleModelIdMap(){return this.inVisibleModelIdMap}getSkyline3D(){var e=this.viewer.getRenderer(),i=this.viewer.camera,a=this.viewer.rendererManager.renderer;a.renderCustomDepth&&a.renderCustomDepth(e,this.viewer.getScene(),i,this.depthRenderTarget,!0);var n=this.viewer.getViewportSize(),s=n.width,o=n.height,l=new Uint8Array(s*o*4);e.readRenderTargetPixels(this.depthRenderTarget,0,0,s,o,l);var d=i.near,h=i.far,c=2/(Math.log(h+1)/Math.LN2),u=i.projectionMatrix;t.copy(u).invert();for(var p=i.matrixWorld,m=new THREE.Vector4,f=new THREE.Vector4,g=new Array,v=0;v<s;v++)for(var y=o-1;y>=0;y--){var M=4*(y*s+v),E=l[M],b=l[M+1],I=l[M+2],x=l[M+3];m.set(E,b,I,x);var T=r.Utils.unpackRGBAToDepth(m);if(0!=T){var _=v,S=y,C=2*(T/=255)/c,w=Math.pow(2,C)-1,R=h*(1-d/w)/(h-d),B=2*_/s-1,L=2*S/o-1;R=2*R-1,f.set(B,L,R,1),f.multiplyScalar(w),f.applyMatrix4(t),f.applyMatrix4(p),g.push(new THREE.Vector3(f.x,f.y,f.z));break}}return g}static destroyInstance(){e.destroy(),e=void 0}static getInstance(){return e}static createInstance(t){return e||(e=new r.GroundPrimitiveManager(t)),e}}}(),(()=>{new THREE.Matrix4,new THREE.Vector3;class e extends r.ExternalComponentManager{constructor(e,t){super(e),this.id=t,this.databagId=this.id}_getNodeGroup(){return this.getModelManager().getScene().getOrCreateObjectGroup(this.id,{pickableType:r.PICKABLETYPE.ExternalComponent,globalSpace:!0})}_removeNodeGroup(){this.getModelManager().getScene().removeObjectGroupByName(this.id)}}r.EffectComponentManager=e})();r.AreaInfo=class{constructor(e){this.roomName=e,this.belong="user",this.roomBoundary=null,this.offsetZ=0,this.boundingBox=0,this.roomInnerBoundary=null}checkRoomBoundaryWithHoles(e,t){if(t.length>0){this.roomInnerBoundary=[];for(let e=0;e<t.length;e++){this.checkRoomBoundary(t[e])&&this.roomInnerBoundary.push(this.roomBoundary)}}return this.checkRoomBoundary(e)}checkRoomBoundary(e){function t(e,t,i){return(t.x-e.x)*(i.y-e.y)-(i.x-e.x)*(t.y-e.y)}function i(e,i,r,a){var n=t(e,i,r)*t(e,i,a),s=t(r,a,e)*t(r,a,i);return!(n>0)&&(!(s>0)&&(0!=n||0!=s||!function(e,t,i,r){return!(Math.min(e.x,t.x)<=i.x&&i.x<=Math.max(e.x,t.x)&&Math.min(e.y,t.y)<=i.y&&i.y<=Math.max(e.y,t.y))&&!(Math.min(e.x,t.x)<=r.x&&r.x<=Math.max(e.x,t.x)&&Math.min(e.y,t.y)<=r.y&&r.y<=Math.max(e.y,t.y))}(e,i,r,a)))}if(!(e instanceof Array)||e.length<3)return console.log("Failed to create room boundary, the number of the points must be more than three."),!1;this.offsetZ=e[0][2];var r=new THREE.Box2,a=[];a.push(new THREE.Vector2(e[0][0],e[0][1]));for(var n=1,s=e.length;n<s;n++){if(3!=e[n].length)return console.log("Failed to create room boundary, the format of boundary is not right, please follow [[x1,y1,z1],...]"),!1;for(n=1;n<e.length;n++){for(var o=!1,l=0;l<a.length;l++)if(e[n][0]==a[l].x&&e[n][1]==a[l].y){o=!0;break}if(!1===o){var d=new THREE.Vector2(e[n][0],e[n][1]);a.push(d),r.expandByPoint(d)}}}var h,c,u=a.length;if(u<3)return console.log("Failed to create room boundary, points are collinear."),!1;if(3==u)return 0==t(a[0],a[1],a[2])?(console.log("Failed to create room boundary, points are collinear."),!1):(a.push(new THREE.Vector2(e[0][0],e[0][1])),this.roomBoundary=a,this.boundingBox=r,!0);for(n=0;n<u;n++){h=a[n],c=a[n==u-1?0:n+1];for(l=n+2;l<u;l++)if((0!=n||l!=u-1)&&i(h,c,a[l],a[l==u-1?0:l+1]))return console.log("Failed to create room boundary, the room boundary is self-intersection."),!1}return a.push(new THREE.Vector2(e[0][0],e[0][1])),this.roomBoundary=a,this.boundingBox=r,!0}clone(){return(new this.constructor).copy(this)}copy(e){return this.roomName=e.roomName,this.belong=e.belong,void 0!==e.roomBoundary&&(this.roomBoundary=JSON.parse(JSON.stringify(e.roomBoundary))),this.offsetZ=e.offsetZ,this.boundingBox=e.boundingBox.clone(),this}};class Y extends r.ObjectGroup{constructor(){super(r.ObjectGroupType.BoundaryEdgeManager,{priority:20}),this.globalSpace=!0,this.areaInfo=new Array,this.areaGeometries=new Array,this.areaMeshes=new Array,this.areaMaterial=new THREE.LineMaterial({color:1005740}),this.areaMaterial.linewidth=5,this.areaMaterial.depthTest=!1}addAreaInfo(e){var t=this.areaInfo.length;return this.areaInfo.push(e),this.update(t),t}setAreaInfo(e,t){return void 0!==e&&(this.areaInfo.length>e&&(this.areaInfo[e]=t,this.update(e),!0))}setAreaLineColor(e){this.areaMaterial=new THREE.LineMaterial(e),this.areaMaterial.linewidth=1}removeAreaInfo(e){if(void 0===e)return!1;if(this.areaMesh&&this.remove(this.areaMesh),this.areaInfo.length>e){this.areaInfo.splice(e,1),this.areaGeometries.splice(e,1);var t=this.areaMeshes[e];return this.remove(t),this.areaMeshes.splice(e,1),!0}return!1}update(e){if(!(void 0===e||this.areaInfo.length<e)){for(var t=this.areaInfo[e].length,i=new Array,a=0;a<t;++a)for(var n=this.areaInfo[e][a],s=0,o=n.length;s<o;++s){var l=n[s];i.push(l.x),i.push(l.y),i.push(l.z)}this.areaMesh&&this.remove(this.areaMesh);var d=new THREE.LineSegmentsGeometry;d.setPositions(i),this.areaMaterial.resolution.set(window.innerWidth,window.innerHeight),this.areaMesh=new THREE.LineSegments2(d,this.areaMaterial),this.areaMesh.renderOrder=r.EnumRenderOrder.Effect,this.add(this.areaMesh),this.updateMatrixWorld(!0)}}}Y.getInstance=function(e){return null==e.boundaryEdge&&(e.boundaryEdge=new r.BoundaryEdgeManager,e.objectGroups.add(e.boundaryEdge),e.boundaryEdge.matrix.copy(e.geometryGroup.matrix),e.boundaryEdge.matrixAutoUpdate=!1,e.boundaryEdge.updateMatrixWorld(!0)),e.boundaryEdge},Y.destroy=function(e){e.boundaryEdge=null},r.BoundaryEdgeManager=Y;class K extends r.BaseModel{constructor(e){super(e.getModelManager(),{modelId:r.ObjectGroupType.EXTRUDEBODYMANAGER}),this.viewer=e,this.manager.addModel(this),this.filter=new r.FilterManager,this.filter.setObserverForSceneState(this.manager.getFilter().getObserverForSceneState()),this.castShadow=!1,this.receiveShadow=!1,this.mapColorToNodeId={},this.selectionColor={red:50,green:224,blue:240,alpha:.4},this.selectionEdgeColor={red:50,green:224,blue:240,alpha:1},this.blinkMaterials=[],this.blinkMaterialMap={},this.bindModelMap={},this.mapDepthTestToNodeId={}}destroy(){this.manager.removeModel(this.id),this._removeNodeGroup(),this.mapColorToNodeId=null,this.selectionColor=null,this.selectionEdgeColor=null,this.blinkMaterials=null,this.blinkMaterialMap=null,this.filteredIds=null,this.selectedIds=null,this.blinkedIds=null,this.bindModelMap=null,this.mapDepthTestToNodeId=null,super.destroy()}_getNodeGroup(){return this.getModelManager().getScene().getOrCreateObjectGroup(r.ObjectGroupType.EXTRUDEBODYMANAGER,{pickableType:r.PICKABLETYPE.Room,priority:20,globalSpace:!0})}_getAlphaTestNodeGroup(){return this.getModelManager().getScene().getOrCreateObjectGroup(r.ObjectGroupType.EXTRUDEBODYMANAGERTEST,{pickableType:r.PICKABLETYPE.Room,priority:20,globalSpace:!0})}getAllNodes(){return this._getNodeGroup().children.concat(this._getAlphaTestNodeGroup().children)}_removeNodeGroup(){this.getModelManager().getScene().removeObjectGroupByName(r.ObjectGroupType.EXTRUDEBODYMANAGER),this.getModelManager().getScene().removeObjectGroupByName(r.ObjectGroupType.EXTRUDEBODYMANAGERTEST)}addNode(e,t,i,r,a,n){n=null==n||n,this.getNode(e)&&this.removeNodeById(e);var s=new Array,o=0,l=0,d=0,h=[];let c=[],u=[],p=[];if(t.belong&&"user"==t.belong){o=t.offsetZ;for(var m=0,f=t.roomBoundary.length;m<f;m++){var g=t.roomBoundary[m];s[m]=new THREE.Vector2(g.x,g.y)}if(t.roomInnerBoundary)for(m=0,f=t.roomInnerBoundary.length;m<f;m++){var v=t.roomInnerBoundary[m];u.push(v);let e=[];v.forEach((t=>{e.push(t.clone())})),p.push(e)}}else{if(t.version&&"2.0"==t.version){t.loops&&t.loops.length>0&&(h=t.loops[0]);const e=JSON.stringify(h);if(t.loops.length>1)for(let i=1;i<t.loops.length;i++)JSON.stringify(t.loops[i])!==e&&c.push(t.loops[i])}let e=e=>{var t=e.length;let i=[];for(var r=0;r<t;++r)for(var a=e[r],n=a.length,s=0;s<n-1;s++){var l=a[s];i.push(new THREE.Vector2(l.x,l.y)),0==r&&0==s&&(o=l.z)}return i.length>0&&i.push(i[0].clone()),i};c.forEach((t=>{let i=e(t);u.push(i);let r=[];i.forEach((e=>{r.push(e.clone())})),p.push(r)})),s=e(h)}if(!t.offsetZ&&(t.offsetZ=o),s.length<=0)return;var y=[];let M=[];(e=>{y=[],l=0,d=0,l=e[0].x,d=e[0].y;for(var t=0,i=e.length-1;t<i;t++){var r=e[t];l>r.x&&(l=r.x),d>r.y&&(d=r.y),y.push({x:r.x,y:r.y,z:o})}for(t=0,i=e.length;t<i;t++)e[t].x-=l,e[t].y-=d})(s);let E=[];p.forEach((e=>{let t=new THREE.Vector2(-l,-d);if(e.forEach((e=>{e.add(t)})),!(e=>{let t=JSON.stringify(e).toString();for(let e=0;e<E.length;e++){let i=E[e];if(t===JSON.stringify(i).toString())return!0}return!1})(e)){let t=new THREE.Path(e);M.push(t),E.push(e)}}));var b=new THREE.Shape(s);b.holes=M;var I={depth:i,bevelEnabled:!1};this._genShap(b,I,r,l,d,o,e,y),this._genWireframe(u,y,n,a,l,d,o,i,e)}getBoundingBox(){let e=new THREE.Box3;const t=this.getAllNodeGroups();for(let i=0;i<t.length;i++){const r=t[i];if("LineSegments"===r.type)continue;const a=r.geometry.boundingBox.clone();a.applyMatrix4(r.matrix),e.expandByPoint(a.min),e.expandByPoint(a.max)}return e}_genShap(e,t,i,r,a,n,s,o){var l=new THREE.ExtrudeGeometry(e,t);l.contour=o,this._faceToContour(l,r,a),l.boundingBox||l.computeBoundingBox();var d=new THREE.Mesh(l,i);d.name=s.toString(),d._oriMaterial=i,d.translateX(r),d.translateY(a),d.translateZ(n),this.setColorInMap(d.name,i),this._getNodeGroup().add(d),this._getNodeGroup().updateMatrixWorld(!0)}_genWireframe(e,t,i,r,a,n,s,o,l){let d=new THREE.Geometry;e.forEach((e=>{for(var t=[],i=0,r=e.length-1;i<r;i++){var l=e[i];t.push({x:l.x,y:l.y,z:s})}let h=this._genWireFrameGeometry(t,a,n,s,o);null!=h&&d.merge((new THREE.Geometry).fromBufferGeometry(h))}));let h=this._genWireFrameGeometry(t,a,n,s,o);null!=h&&d.merge((new THREE.Geometry).fromBufferGeometry(h)),r.depthTest=!i,r.transparent=!0;let c=d.toBufferGeometry();c.deleteAttribute("normal");const u=new THREE.LineSegments(c,r);u.name="wireframe_"+l,u._oriMaterial=r,u.translateX(a),u.translateY(n),u.translateZ(s),u.updateMatrixWorld(!0),this.setColorInMap(u.name,r),this.mapDepthTestToNodeId[l]=!1,this._getNodeGroup().add(u),this._getNodeGroup().updateMatrixWorld(!0)}_genWireFrameGeometry(e,t,i,a,n){if(!(e.length<3)){var s=this._checkVertices(e.slice(),n);return r.BuildRoomEdge(s,t,i,a,n)}}bindModel(e,t){if(this.getNode(e)&&this.getModelManager().modelCollection.getIds().indexOf(t.toString())>=0){if(this.getBindedModelId(e))return;this.bindModelMap[t]||(this.bindModelMap[t]=[]),this.bindModelMap[t].push(e);let i=this.getNode(e),r=this.getNode("wireframe_"+e);i.explodedHeight=r.explodedHeight=0,i.explodedDirection=r.explodedDirection=new THREE.Vector3;let a=this.getModelManager().explosionManager;if(0!==a.getFloorExplosionExtent(t)){let i=a.getFloorInfos(t);this.explodeMesh(this.getNode(e),i,!0),this.explodeMesh(this.getNode("wireframe_"+e),i,!0)}let n=a.getExplosionExtent(t);if(0!==n){const i=this.getModelManager().getModel(t);let r=new THREE.Vector3;const a=i.getBoundingBoxWorld().getCenter(r);this.elementExplodeMesh(this.getNode(e),n,a),this.elementExplodeMesh(this.getNode("wireframe_"+e),n,a)}const s=this.getModelManager().getModel(t).transformMatrix;i.lastTransformation=(new THREE.Matrix4).copy(s),i.applyMatrix4(s),i.updateMatrixWorld(),r.lastTransformation=(new THREE.Matrix4).copy(s),r.applyMatrix4(s),r.updateMatrixWorld()}}unbindModel(e,t){if(this.bindModelMap[t]){let i=this.bindModelMap[t].indexOf(e);if(i>=0){this.bindModelMap[t].splice(i,1);const r=e=>{if(void 0!==e.explodedHeight){const t=e.explodedDirection.clone().negate().multiplyScalar(e.explodedHeight);let i=new THREE.Matrix4;i.makeTranslation(t.x,t.y,t.z),e.applyMatrix4(i),e.updateMatrixWorld(),delete e.explodedDirection,delete e.explodedHeight,delete e.preExplodedDirection,delete e.preExplodedHeight}},a=e=>{null!=e.preModelExplodedMatrix&&(e.preModelExplodedMatrix.invert(),e.applyMatrix4(e.preModelExplodedMatrix),e.updateMatrixWorld(),delete e.preModelExplodedMatrix)},n=e=>{const i=this.getModelManager().getModel(t).transformMatrixInverse;e.lastTransformation=(new THREE.Matrix4).copy(i),e.applyMatrix4(i),e.updateMatrixWorld()};if(!this.getNode(e))return;r(this.getNode(e)),r(this.getNode("wireframe_"+e)),a(this.getNode(e)),a(this.getNode("wireframe_"+e)),n(this.getNode(e)),n(this.getNode("wireframe_"+e))}}}getBindedModelId(e){let t;return Object.keys(this.bindModelMap).some((i=>{if(this.bindModelMap[i].indexOf(e)>=0)return t=i,!0})),t}_checkVertices(e,t){var i=.1;function r(e,t,r){return void 0!==e&&void 0!==t&&void 0!==r&&(Math.abs(t.x-e.x)<i&&Math.abs(r.x-e.x)<i||(Math.abs(t.y-e.y)<i&&Math.abs(r.y-e.y)<i||Math.abs((t.x-e.x)*(r.y-e.y)-(r.x-e.x)*(t.y-e.y))<100*i))}"Meter"===this.viewer.getSceneUnit()&&(i=1e-4);for(var a=e.length;r(e[0],e[1],e[a-1]);)e.shift(),a=e.length;for(a=e.length;r(e[0],e[a-2],e[a-1]);)e.pop(),a=e.length;a=e.length;for(var n=0;n+2<a;){for(var s=n;s+2<a&&r(e[n],e[s+1],e[s+2]);)e.splice(s+1,1),a=e.length;n++}return e}_faceToContour(e,t,i){const r=e.contour,a=e.attributes.position;let n=[];const s=a.count,o=r.length;let l=new THREE.Vector3;function d(e,t){return Math.abs(e-t)<=.1}for(let e=0;e<o;e++)for(let o=0;o<s;o++)l.fromBufferAttribute(a,o),d(l.x+t,r[e].x)&&d(l.y+i,r[e].y)&&(n[o]=e);function h(e,t){var i=e<t?e:t,r=e>t?e:t;return 0==i&&r==o-1?{st:r,ed:i}:{st:i,ed:r}}let c=[];for(var u=0;u<s;u+=3){let e={},t=[];for(let e=u;e<u+3;e++){const i=n[e];i&&t.push(i)}t.length>2?e.contourIndex=h(t[1],t[2]):t.length>1?e.contourIndex=h(t[0],t[1]):1==t.length&&(e.contourIndex=h(t[0],t[0]+1)),c.push(e)}e.faces=c}applyFrontEffect(e,t,i){const r=this._getNodeGroupVisible(),a=this._getNodeGroup().parent.children,n=a.length;let s=new Array(n);for(var o=0;o<n;++o)s[o]=a[o].visible,a[o].visible=!1;this._setNodeGroupVisible(r);var l=e.autoClear,d=e.autoClearColor,h=e.autoClearDepth,c=e.autoClearStencil;e.autoClear=!0,e.autoClearColor=!1,e.autoClearDepth=!0,e.autoClearStencil=!1,e.render(t,i),e.autoClear=l,e.autoClearColor=d,e.autoClearDepth=h,e.autoClearStencil=c;for(o=0;o<n;++o)a[o].visible=s[o]}setColorInMap(e,t){var i={red:255*t.color.r,green:255*t.color.g,blue:255*t.color.b,alpha:t.opacity};this.mapColorToNodeId[e]=i}createMaterial(e){return r.MaterialUtil.createStandardMaterial(e)}setNodeMaterial(e,t,i){var r=this.getNode(e);if(r){var a=r._oriMaterial;for(var n in t){var s=n;a.hasOwnProperty(s)&&(a[s]="color"==s?new THREE.Color(t[n]):t[n])}}if(r=this.getNode("wireframe_"+e)){a=r._oriMaterial;for(var n in i){s=n;a.hasOwnProperty(s)&&(a[s]="color"==s?new THREE.Color(i[n]):i[n])}}this._updateNodeById(e)}getNode(e){let t=t=>{for(let i=0,r=t.length;i<r;i++)if(t[i].name==e.toString())return t[i]};return t(this._getNodeGroup().children)||t(this._getAlphaTestNodeGroup().children)}removeNodeById(e){var t=this.getNode(e);if(t&&(delete this.mapColorToNodeId[t.name],this._getNodeGroup().remove(t),this._getAlphaTestNodeGroup().remove(t)),this.filter.enableStateChanged(),t=this.getNode("wireframe_"+e)){delete this.mapColorToNodeId[t.name],this._getNodeGroup().remove(t),this._getAlphaTestNodeGroup().remove(t);let i=this.getBindedModelId(e);return i&&this.unbindModel(e,i),!0}return!1}clearNodes(){this._getNodeGroup().clear(),this._getAlphaTestNodeGroup().clear(),this.mapColorToNodeId={},this.bindModelMap={},this.filter.enableStateChanged()}setNodeVisibleById(e,t){var i=this.getNode(e);if(i&&(i.visible=t),this.filter.enableStateChanged(),i=this.getNode("wireframe_"+e))return i.visible=t,!0}_getNodeGroupVisible(){return this._getNodeGroup().visible}_setNodeVisible(e){const t=this._getNodeGroup().children;for(let i=0,r=t.length;i<r;i++)t[i].visible=e}_setNodeGroupVisible(e){this._getNodeGroup().visible=e}_getAlphaTestNodeGroupVisible(){return this._getAlphaTestNodeGroup().visible}_setAlphaTestNodeVisible(e){const t=this._getAlphaTestNodeGroup().children;for(let i=0,r=t.length;i<r;i++)t[i].visible=e}_setAlphaTestNodeGroupVisible(e){this._getAlphaTestNodeGroup().visible=e}showAllNodes(){this._setNodeVisible(!0),this._setAlphaTestNodeVisible(!0),this.filter.enableStateChanged()}hideAllNodes(){this._setNodeVisible(!1),this._setAlphaTestNodeVisible(!1),this.filter.enableStateChanged()}setNodeColorById(e,t){var i=this.getNode(e);if(i){var r=i._oriMaterial;return r.color=new THREE.Color(t.red/255,t.green/255,t.blue/255),r.opacity=t.alpha,t!=this.selectionColor&&t!=this.selectionEdgeColor&&this.setColorInMap(i.name,r),this._updateNodeById(e),this.filter.enableStateChanged(),!0}return!1}getNodeColorById(e){return this.mapColorToNodeId[e]}setWireframeColorById(e,t){return this.setNodeColorById("wireframe_"+e,t)}getWireframeColorById(e){return this.getNodeColorById("wireframe_"+e)}applySelection(){this._hasNode()&&(this._collectSelectedIds(),this._collectHoveredIds(),this._updateNodes())}clearSelection(){this._hasNode()&&(this._clearSelectedIds(),this.applyHover())}applyHover(){this._hasNode()&&(this._collectHoveredIds(),this._updateNodes())}clearHover(){this._hasNode()&&(this._clearHoveredIds(),this._updateNodes())}applyBlink(){this._hasNode()&&(this._collectBlinkedIds(),this._collectHoveredIds(),this._updateNodes())}clearBlink(){this._clearBlinkedIds(),this.applyHover()}_collectSelectedIds(){var e=this.filteredIds=this.filteredIds||{},t=r.Model.EnumFilterState,i=this.getModelManager().sceneState.getSelection(),a={};this._clearSelectedIds();for(var n=0,s=i.length;n<s;n++){var o=i[n];this._hasObjectId(o)&&(e[o]||(e[o]={}),e[o][t.SELECTED]=!0,a[o]=!0)}this.selectedIds=Object.keys(a)}_clearSelectedIds(){if(this.filteredIds&&this.selectedIds&&this.selectedIds.length){for(var e=0,t=this.selectedIds.length;e<t;e++){var i=this.selectedIds[e];this.filteredIds[i]&&delete this.filteredIds[i][r.Model.EnumFilterState.SELECTED]}this.selectedIds=null}}_collectHoveredIds(){this._clearHoveredIds();var e=this.getModelManager().sceneState.hoverId;if(e&&this._hasObjectId(e)){var t=this.filteredIds=this.filteredIds||{};this.hoveredId=e,t[e]||(t[e]={}),t[e][r.Model.EnumFilterState.HOVER]=!0}}_clearHoveredIds(){this.filteredIds&&this.hoveredId&&this.filteredIds[this.hoveredId]&&(delete this.filteredIds[this.hoveredId][r.Model.EnumFilterState.HOVER],this.hoveredId=void 0)}_collectBlinkedIds(){var e=this.getModelManager().sceneState.getBlinkComponentsIdMap(this.id),t=this.filteredIds=this.filteredIds||{},i=r.Model.EnumFilterState,a={};for(var n in this._clearBlinkedIds(),e)this._hasObjectId(n)&&(t[n]||(t[n]={}),t[n][i.BLINK]=!0,a[n]=!0);this.blinkedIds=Object.keys(a)}_clearBlinkedIds(){if(this.filteredIds&&this.blinkedIds&&this.blinkedIds.length){for(var e=0,t=this.blinkedIds.length;e<t;e++){var i=this.blinkedIds[e];this.filteredIds[i]&&delete this.filteredIds[i][r.Model.EnumFilterState.BLINK]}this.blinkedIds=null}}_hasObjectId(e){return!!this.mapColorToNodeId[e]}_hasNode(){for(var e in this.mapColorToNodeId)if(this.mapColorToNodeId.hasOwnProperty(e))return!0;return!1}_updateNodes(){if(this._resetMaterial(),this.blinkMaterialMap={},this.blinkMaterials.length=0,this.filteredIds)for(var e in this.filteredIds)this._updateNodeById(e)}_resetMaterial(){let e=e=>{for(let t=0,i=e.length;t<i;t++){let i=e[t],r=this.mapColorToNodeId[i.name];i._oriMaterial.color.setRGB(r.red/255,r.green/255,r.blue/255),i._oriMaterial.opacity=r.alpha,i.material=i._oriMaterial}};e(this._getNodeGroup().children),e(this._getAlphaTestNodeGroup().children)}_updateNodeById(e){if(this._hasObjectId(e)&&this.filteredIds&&this.filteredIds[e]){var t=this.filteredIds[e],i=r.Model.EnumFilterState,a=this.getNode(e),n=this.getNode("wireframe_"+e),s=this.getModelManager().sceneState;if(t[i.SELECTED]){var o=this.selectionColor;if(a.material=a._oriMaterial,a.material.color.setRGB(o.red/255,o.green/255,o.blue/255),a.material.opacity=o.alpha,n){var l=this.selectionEdgeColor;n.material=n._oriMaterial,n.material.color.setRGB(l.red/255,l.green/255,l.blue/255),n.material.opacity=l.alpha}}else if(t[i.BLINK]){if(void 0===this.blinkMaterialMap[e]){this.blinkMaterialMap[e]=!0;var d=s.getBlinkMaterial(a._oriMaterial,this.id);a.material=d,this.blinkMaterials.push(d)}}else if(t[i.HOVER]){a.material=a._oriMaterial;var h=this.mapColorToNodeId[e],c=r.MaterialUtil.getHoverColorByColor({r:h.red/255,g:h.green/255,b:h.blue/255,a:h.alpha});return a.material.color.setRGB(c.r,c.g,c.b),void(a.material.opacity=c.a)}}}sortRenderOrder(e){for(var t=this._getNodeGroup().children,i=e.camera.position.clone(),r=new Map,a=0,n=t.length;a<n;++a){var s=t[a];if(-1!=s.name.indexOf("wireframe"));else{var o={};o[s.name]=null;var l=e.getBoundingBoxByIds(o).getCenter(),d=i.distanceTo(l);r.set(a,d)}}var h=Array.from(r);h.sort((function(e,t){return t[1]-e[1]}));var c=1;for(a=0,n=h.length;a<n;++a)t[h[a][0]].renderOrder=c,null!=t[h[a][0]+1]&&(t[h[a][0]+1].renderOrder=c),++c}explodeMesh(e,t,i){let r,a,n,s;const o=t=>{n=e.preExplodedHeight=e.explodedHeight,s=e.preExplodedDirection=e.explodedDirection.clone(),r=e.explodedHeight=t.explodedHeight-t.elevation,a=e.explodedDirection=(t.explodedDirection||new THREE.Vector3).clone()};let l=0;for(let r=t.length-1;r>=0;r--){let a=t[r],n=t[r].preExplodedTranslation?t[r].preExplodedTranslation.z:0;l=i?t[r].boundingBox.min.z:n+t[r].boundingBox.min.z;let s=e.position.z;if(s>=l-1||0===r){o(a);break}}let d=new THREE.Matrix4;const h=a.clone().multiplyScalar(r).sub(s.clone().multiplyScalar(n));d.makeTranslation(h.x,h.y,h.z),e.applyMatrix4(d),e.updateMatrixWorld()}explode(e){let t,i=this._getNodeGroup().children.concat(this._getAlphaTestNodeGroup().children);if(e){let o=this.bindModelMap[e];if(o&&o.length>0){t=this.getModelManager().explosionManager.getFloorInfos(e);for(var r=0,a=i.length;r<a;r++){var n=i[r],s=n.name.indexOf("wireframe_")<0?n.name:n.name.split("wireframe_")[1];o.indexOf(s)>=0&&this.explodeMesh(n,t)}}}}elementExplodeMesh(e,t,i){let a=new THREE.Box3;void 0!==e.preModelExplodedMatrix&&e.applyMatrix4(e.preModelExplodedMatrix.invert()),e.preModelExplodedMatrix=new THREE.Vector3,e.geometry.boundingBox||e.geometry.computeBoundingBox();const n=e.position,s=(new THREE.Vector3).subVectors(e.geometry.boundingBox.max,e.geometry.boundingBox.min),o=(new THREE.Vector3).addVectors(n,s);a=(new THREE.Box3).setFromPoints([n,o]);let l=r.Utils.computeExplodeTranslation(i,a,t),d=new THREE.Vector3;const h=a.getCenter(d),c=(new THREE.Matrix4).makeTranslation(-h.x,-h.y,-h.z),u=(new THREE.Matrix4).copy(c).invert(),p=(new THREE.Matrix4).makeTranslation(l.x,l.y,l.z);e.preModelExplodedMatrix=p.clone().multiply(u).multiply(c),e.applyMatrix4(e.preModelExplodedMatrix),e.updateMatrixWorld()}elementExplode(e,t,i){let r=e.id;if(!r)return;if(!this.bindModelMap[r])return;let a=this._getNodeGroup().children.concat(this._getAlphaTestNodeGroup().children);if(a)for(let e=0;e<a.length;e++){let r=a[e];this.elementExplodeMesh(r,t,i)}}enableDepthTest(e,t){for(const i of e)void 0!==this.mapColorToNodeId[i]&&(this.mapDepthTestToNodeId[i]=t,this.mapDepthTestToNodeId[`wireframe_${i}`]=t,this.getNode(`wireframe_${i}`).material.depthTest=t,1==t?(this._getAlphaTestNodeGroup().add(this.getNode(i)),this._getAlphaTestNodeGroup().add(this.getNode(`wireframe_${i}`)),this._getNodeGroup().remove(this.getNode(i)),this._getNodeGroup().remove(this.getNode(`wireframe_${i}`))):(this._getNodeGroup().add(this.getNode(i)),this._getNodeGroup().add(this.getNode(`wireframe_${i}`)),this._getAlphaTestNodeGroup().remove(this.getNode(i)),this._getAlphaTestNodeGroup().remove(this.getNode(`wireframe_${i}`))))}getBoundingBoxWorld(){const e=(new THREE.Box3).setFromObject(this._getNodeGroup());return e.applyMatrix4(this.viewer.getScene().getInverseMatrixGlobal()),e}getBlinkMaterials(){return this.blinkMaterials}isUserIdExist(e){return this._hasObjectId(e)}getAllNodeGroups(){return this._getNodeGroup().children}updateTransformation(e,t){const i=(new THREE.Matrix4).fromArray(e);let a=this.viewer.getScene().getObjectGroup(r.ObjectGroupType.EXTRUDEBODYMANAGER),n=this.bindModelMap[t];if(n&&n.length>0){let e=a.children;for(let t=0;t<e.length;t++){let r=e[t],a=r.name.indexOf("wireframe_")<0?r.name:r.name.split("wireframe_")[1];n.indexOf(a)>=0&&(r.lastTransformation&&r.applyMatrix4((new THREE.Matrix4).copy(r.lastTransformation).invert()),r.lastTransformation=i,r.applyMatrix4(i),r.updateMatrixWorld())}}}getPickingMeshes(e,t,i,a,n){if(!1===!(!n||"string"!=typeof n||!n.startsWith("glow")))return;const s=this.getId();t[s]=new r.ObjectGroup,t[s].matrix.copy(this.getTransformMatrix()),t[s].matrixAutoUpdate=!1,i.map((e=>{const i=this.getNode(e);let r=new THREE.Mesh(i.geometry,i.material.clone());r.visible=i.visible,r.matrix.copy(i.matrix),r.matrixAutoUpdate=!1,r.updateMatrixWorld(!0),i&&t[s].add(r)}))}collectBlinkedMaterial(e,t){e.map((e=>{if(!this._hasObjectId(e))return;const i=this.getNode(e),r=this.getModelManager().sceneState.getBlinkMaterial(i._oriMaterial,this.id);t.push(r)}))}}K.getInstance=function(e){var t=e.getModelManager().getScene();if(null==t.extrudeBodyManager){t.extrudeBodyManager=new r.ExtrudeBodyManager(e);var i=t.extrudeBodyManager._getNodeGroup();t.objectGroups.add(i),i.matrix.copy(t.geometryGroup.matrix),i.matrixAutoUpdate=!1,i.updateMatrixWorld(!0)}return t.extrudeBodyManager},K.destroy=function(e){var t=e.getModelManager().getScene();t.extrudeBodyManager.destroy(),t.extrudeBodyManager=null},r.ExtrudeBodyManager=K,r.MaterialOverrider=class{constructor(e,t,i){this.id=e,this.condition=t,this.material=i}},r.MaterialOverriderSet=class{constructor(e,t){this.overriders=[],this.overrideData=e,this.materials={},this.materialsByName={},this.textures={},this.defaultColor=t||"#808080",this.loader=new r.MaterialOverriderLoader(this.defaultColor)}load(e,t,i,a,n){i=null!=i&&i,(new r.MaterialOverriderLoader).getMaterialOverriders(this.overriders,e,t,i,a,n)}loadByDemand(e,t,i){this.loader.getMaterialsByDemand(this.materials,this.materialsByName,this.textures,this.overrideData,e,t,i)}setDefaultColor(e){this.defaultColor=e,this.loader.defaultColor=e}getOverrideMaterials(){return this.materials}getOverrideMaterialByNodeInfo(e,t){var i=this.materials;return t&&"user"==t.tag?i["elementId_"+e.userId]||t||i["systemTypeId_"+e.userData.systemTypeId]||i["familyId_"+e.userData.familyId]:i["elementId_"+e.userId]||i["systemTypeId_"+e.userData.systemTypeId]||i["familyId_"+e.userData.familyId]}getOverrideMaterialByName(e){return this.materialsByName[e]}updateMaterialsValue(e,t){var i,r=this.materials;for(var a in r)(i=r[a])&&i[e]&&(i[e]=t,void 0!==i.refreshUniforms&&i.refreshUniforms(),i.needsUpdate=!0)}},r.MaterialOverriderLoader=class{constructor(e){this.loader=new THREE.FileLoader,this.loadTaskCount=0,this.maxLoadTask=0,this.defaultColor=e}getMaterialOverriders(e,t,i,r,a,n){var s=t.overrides;this._getOverridesByData(e,s,i,r,a,n),0==this.maxLoadTask&&a&&a()}getMaterialsByDemand(e,t,i,a,n,s,o){if(a.overrides){this.maxLoadTask=0,this.loadTaskCount=0;for(var l=[],d=a.overrides,h=a.textureMaterials,c=n.familyIds,u=n.elementIds,p=n.systemTypeIds,m=d.length-1;m>=0;m--){var f,g=d[m].targetType,v=d[m].target;if("family"==g){if(!c[v])continue;f="familyId_"+v}else if("element"==g){if(!u[v])continue;f="elementId_"+v}else{if("systemType"!=g)continue;if(!p[v])continue;f="systemTypeId_"+v}if(!e[f]){var y=d[m].colorMaterial;if(!y){if(!d[m].textureMaterial)continue;y=this.defaultColor}var M=new r.CloudStandardMaterial;if(M.pureColor=y,M.color.setStyle(y),M.name=y,d[m].textureMaterial){var E=JSON.parse(d[m].textureMaterial),b=E.materialId,I=h[E.materialId];if(M.name=I?b+M.name:M.name,w=t[M.name]){e[f]=w;continue}if(I){var x=JSON.parse(I);if(x.diffuse_color){var T=x.diffuse_color.split(",");M.color.setRGB(parseFloat(T[0]),parseFloat(T[1]),parseFloat(T[2])),M.opacity=parseFloat(T[3])}var _=M.opacity<1;if(M.transparent=_,M.roughness=x.roughness,M.metalness=x.metallic,M.bumpScale=x.enableBump,!l[E.materialId]&&!i[E.materialId]){if(x.diffuse_texture){var S=x.diffuse_texture.texture_file;S&&""!=S?(this.maxLoadTask+=2,l[E.materialId]={diffuse:x.diffuse_texture},"1"==x.useAlphaCulling&&(M.alphaTest=parseFloat(x.alphaCulling),M.useAlphaMap=!0,M.defines.USE_ALPHAMAP="")):M.textureColor=M.color.getStyle()}if(x.bump_texture){var C=x.bump_texture.texture_file;C&&""!=C&&(this.maxLoadTask+=2,l[E.materialId]?l[E.materialId].bump=x.bump_texture:l[E.materialId]={bump:x.bump_texture})}}}else M.textureColor=y,console.log("Warning: there is no corresponding textureMaterial whose materialId is "+E.materialId)}else{var w;if(w=t[M.name]){e[f]=w;continue}M.textureColor=y}M.needsUpdate=!0,M.side=THREE.DoubleSide,e[f]=M,t[M.name]=M}}this._mappingTexturesByDemand(t,i,l,s,o),0==this.maxLoadTask&&s&&s()}else s&&s()}_getOverridesByData(e,t,i,a,n,s){for(var o=i.familyIds,l=i.elementIds,d=i.systemTypeIds,h=!1,c=[],u=[],p=0,m=t.length;p<m;p++){var f,g,v=t[p].targetType,y=t[p].target;if("family"==v){if(!o[y])continue;f=[{familyId:y}]}else if("element"==v){if(!l[y])continue;f=[{elementId:y}]}else{if("systemType"!=consitionType)continue;if(!d[y])continue;f=[{systemTypeId:y}]}if(h=!0,a){if(!(E=t[p].colorMaterial))continue;(g=new r.CloudStandardMaterial).color.setStyle(E),g.name=t[p].id}else{if(!t[p].textureMaterial)continue;var M=JSON.parse(t[p].textureMaterial);if(!M.diffuse_color)continue;var E=M.diffuse_color.split(","),b=1==M.transparent;(g=new r.CloudStandardMaterial({opacity:parseFloat(E[3]),roughness:M.roughness,metalness:M.metallic,transparent:b,bumpScale:M.enableBump})).name=M.id,g.color.setRGB(parseFloat(E[0]),parseFloat(E[1]),parseFloat(E[2]));var I=M.diffuse_texture.texture_file;I&&""!=I&&(this.maxLoadTask+=2,c[p]={diffuse:M.diffuse_texture});var x=M.bump_texture.texture_file;x&&""!=x&&(this.maxLoadTask+=2,c[p]?c[p].bump=M.bump_texture:c[p]={bump:M.bump_texture}),g.needsUpdate=!0}u[p]=g;var T=new r.MaterialOverrider(t[p].id,f,g);e.push(T)}this._mappingTextures(u,c,n,s),h||(console.log("there is no conditions matched"),s&&s())}_mappingTextures(e,t,i,r){for(var a=0;a<e.length;a++)if(e[a]&&t[a]){if(t[a].diffuse){var n=this._loadTexture(t[a].diffuse,i,r);e[a].map=n}if(t[a].bump){var s=this._loadTexture(t[a].bump,i,r);e[a].bumpMap=s}e[a].needsUpdate=!0}}_mappingTexturesByDemand(e,t,i,r,a){for(var n in e)if(e.hasOwnProperty(n)){var s=e[n],o=s.name.split("#")[0];if(s&&i[o]){if(!t[o]){if(t[o]=[],i[o].diffuse){var l=this._loadTexture(i[o].diffuse,r,a);l.texturetype="map",t[o].push(l)}if(i[o].bump){var d=this._loadTexture(i[o].bump,r,a);d.texturetype="bumpMap",t[o].push(d)}}let s=t[o].length;for(let i=0;i<s;i++){let r=t[o][i];(l.texturetype="map")?e[n].map=r:e[n].bumpMap=r}e[n].needsUpdate=!0}}}_loadTexture(e,t,i){var a=new THREE.Texture,n=this,s=new TEST.CryptoResourceLoader;const o=e.texture_file;return r.Storage.IndexedDBHelper.loadWithStorage("ModelData",o,(()=>new Promise(((e,t)=>{s.loadURL(o,e,t)}))),(i=>{var s=new Blob([i],{type:"jpeg"}),o=n._loadImage(URL.createObjectURL(s),(function(){n._onLoadFinished(t)}));a.image=o,a.encoding=THREE.GammaEncoding;var l=e.scale.split(","),d=e.offset.split(",");a.repeat.fromArray([parseFloat(l[0]),parseFloat(l[1])]),a.offset.fromArray([parseFloat(d[0]),parseFloat(d[1])]),a.wrapS=n._getTextureWrapping(e.wrap_parameter_s),a.wrapT=n._getTextureWrapping(e.wrap_parameter_t),a.magFilter=n._getTextureFilter(e.filter_mode_mag),a.minFilter=n._getTextureFilter(e.filter_mode_min),a.rotation=THREE.Math.degToRad(e.rotation),r.MaterialUtil.updateUVMatrix(a),a.needsUpdate=!0,n._onLoadFinished(t)}),(e=>{i&&i()})),a}_loadImage(e,t){var i=new Image;return i.onload=function(){var e=document.createElement("canvas");e.width=r.MaterialUtil.nextHighestPowerOfTwo(i.width),e.height=r.MaterialUtil.nextHighestPowerOfTwo(i.height),e.getContext("2d").drawImage(i,0,0,i.width,i.height,0,0,e.width,e.height),t()},i.onerror=function(e){console.log("Error: image is failed to loaded"),t()},i.src=e,i}_getTextureFilter(e){switch(e){case"NEAREST":default:return THREE.NearestFilter;case"NEAREST_MIPMAP_NEAREST":return THREE.NearestMipMapNearestFilter;case"NEAREST_MIPMAP_LINEAR":return THREE.NearestMipMapLinearFilter;case"LINEAR":return THREE.LinearFilter;case"LINEAR_MIPMAP_NEAREST":return THREE.LinearMipMapNearestFilter;case"LINEAR_MIPMAP_LINEAR":return THREE.LinearMipMapLinearFilter}}_getTextureWrapping(e){switch(e){case"REPEAT":default:return THREE.RepeatWrapping;case"CLAMP":return THREE.ClampToEdgeWrapping;case"MIRROR":return THREE.MirroredRepeatWrapping}}_onLoadFinished(e){this.loadTaskCount++,this.loadTaskCount>=this.maxLoadTask&&e&&e()}},function(){class e{constructor(e){this.viewer=e,this.model=e.modelManager.getFirstModel(),this.model.registerPlugin(this),this.material=r.MaterialUtil.getDefaultStandardMaterial(),this.loader=new r.SegmentLoader(this),this.index=0,this.segmentIdMap={},this.segmentPathMap={},this.segmentIdArray=[],this.elementIdMap={},this.partialElementMap={},this.partialNodeInfoMapFromNodeId={},this.partialNodeIdMapFromSegmentId={},this.partialParentUserIdMapFromSegmentId={},this.partialNodeIdMapFromUserId={},this.geometryIdMapFromDataId={},this.dataBufferMapFromGeometryId={},this.geometryMapFromGeometryId={},this.meshNodeMapFromNodeId={},this.nodeIdMapOctantMap={},this.selectedNodeIdArray=[],this.hoveredNodeIdArray=[],this.isolateApplied=!1}destroy(){if(this.pickingNodeGenerators){for(var e in this.pickingNodeGenerators)this.pickingNodeGenerators.hasOwnProperty(e)&&this.pickingNodeGenerators[e].destroy();this.pickingNodeGenerators=null}this.removeSegmentBufferByDataIds(Object.keys(this.geometryIdMapFromDataId)),this.destroyGeometries(),this.model=null,this.loader.destroy(),this.loader=null,this.material=null,this.segmentIdMap=null,this.segmentPathMap=null,this.segmentIdArray=null,this.elementIdMap=null,this.partialElementMap=null,this.partialNodeInfoMapFromNodeId=null,this.partialNodeIdMapFromSegmentId=null,this.partialParentUserIdMapFromSegmentId=null,this.partialNodeIdMapFromUserId=null,this.geometryIdMapFromDataId=null,this.dataBufferMapFromGeometryId=null,this.meshNodeMapFromNodeId=null,this.nodeIdMapOctantMap=null,this.selectedNodeIdArray=null,this.hoveredNodeIdArray=null,this.segmentIdMapFromPartialElementId&&(this.segmentIdMapFromPartialElementId=null),this.viewer=null}removeFromSegmentIdMap(e){for(var t=0,i=e.length;t<i;t++){var a=e[t],n=this.segmentIdMap[a];n&&(delete this.segmentIdMap[a],delete this.segmentPathMap[n][a],r.Utils.isOwnEmptyObject(this.segmentPathMap[n])&&delete this.segmentPathMap[n])}this.segmentIdArray=Object.keys(this.segmentIdMap)}loadSegmentsByPaths(e,t){var i=this,r=e.length;requestAnimationFrame(function e(a){var n=a;return function(){i.loadSegmentByTaskId(n,(function(){n<r-1?requestAnimationFrame(e(n+1)):t&&t()}))}}(0))}loadSegmentByTaskId(e,t){var i=this.addedSegmentPaths[e];-1!==i&&"-1"!==i?this.loader.load(i,(function(){t&&t()})):t&&t()}cacheSegmentBuffer(e,t,i){this.geometryIdMapFromDataId[e]||(this.geometryIdMapFromDataId[e]=[]);var r=e+"|"+t;this.geometryIdMapFromDataId[e].push(r),this.dataBufferMapFromGeometryId[r]=i}removeSegmentBufferByDataIds(e){for(var t=0,i=e.length;t<i;t++){var a=r.Utils.getEncodedId(e[t]),n=this.geometryIdMapFromDataId[a];if(n){for(var s=0,o=n.length;s<o;s++){var l=n[s];this.disposeGeometryByGeometryId(l),delete this.dataBufferMapFromGeometryId[l]}delete this.geometryIdMapFromDataId[a]}}}hasNodeInfoFromPartialNodeInfoMap(e){return!!this.partialNodeInfoMapFromNodeId[e]}classifyNodeInfos(e){this.partialNodeInfoMapFromNodeId[e.nodeId]=e,this.partialNodeIdMapFromSegmentId[e.segmentId]||(this.partialNodeIdMapFromSegmentId[e.segmentId]=[]),this.partialNodeIdMapFromSegmentId[e.segmentId].push(e.nodeId),this.partialParentUserIdMapFromSegmentId[e.segmentId]||(this.partialParentUserIdMapFromSegmentId[e.segmentId]={}),this.partialParentUserIdMapFromSegmentId[e.segmentId][e.parentUserId]||(this.partialParentUserIdMapFromSegmentId[e.segmentId][e.parentUserId]={}),this.partialParentUserIdMapFromSegmentId[e.segmentId][e.parentUserId][e.userId]=!0,this.partialNodeIdMapFromUserId[e.userId]||(this.partialNodeIdMapFromUserId[e.userId]=[]),this.partialNodeIdMapFromUserId[e.userId].push(e.nodeId)}getAllPartialSegmentIds(){return Object.keys(this.partialNodeIdMapFromSegmentId)}getNodeIdsBySegmentId(e){return this.partialNodeIdMapFromSegmentId[e]}getNodeInfoByNodeId(e){return this.partialNodeInfoMapFromNodeId[e]}getNodeIdsByUserId(e){return this.partialNodeIdMapFromUserId[e]}getNodeInfosBySegmentId(e){var t=this.getNodeIdsBySegmentId(e);if(!t)return[];for(var i=[],r=0,a=t.length;r<a;r++){var n=this.getNodeInfoByNodeId(t[r]);n&&i.push(n)}return i}getNodeInfosBySegmentIds(e){var t,i,r=[],a=this.getUsedAndNotUsedSegmentIdsBySegmentIds(e),n=a.usedSegmentIds,s=a.notUsedSegmentIds;for(t=0,i=n.length;t<i;t++)r=r.concat(this.getNodeInfosBySegmentId(n[t]));for(t=0,i=s.length;t<i;t++)r=r.concat(this.getNodeInfosBySegmentId(s[t]));return r}getMeshesNodeByNodeId(e){var t=this.getNodeInfoByNodeId(e);if(!t)return null;var i=this.getMeshNodesByNodeInfo(t);return i||null}getMeshNodesByNodeInfo(e){if(this.meshNodeMapFromNodeId[e.nodeId])return this.meshNodeMapFromNodeId[e.nodeId];var t=this.getGeometriesByNodeInfo(e);if(!t)return null;for(var i=[],a=this.model.materialManager.getMaterialById(e.materialId)||this.material,n=0,s=t.length;n<s;n++){var o=new r.MeshEx(t[n],a);o.spawn({databagId:this.model.databagId,fileId:this.model.fileId,matrix:e.matrix}),o.name=e.userId,o._nodeId=e.nodeId,o._oriMaterial=a,i.push(o)}if(!e.boundingBox){e.boundingBox=new THREE.Box3;for(var l=0,d=i.length;l<d;l++)e.boundingBox.union(i[l].computeBoundingBox());e.matrix&&e.boundingBox.applyMatrix4(e.matrix)}return this.meshNodeMapFromNodeId[e.nodeId]=i,this.meshNodeMapFromNodeId[e.nodeId]}getMeshNodesWithNotUsedSegment(e,t){for(var i=r.Utils.arrayToMap(this.getParentUserIdsBySegmentIds(e)),a=[],n=0,s=t.length;n<s;n++){var o=this.getNodeIdsBySegmentId(t[n]);if(o)for(var l=0,d=o.length;l<d;l++){var h=this.getNodeInfoByNodeId(o[l]);h&&i[h.parentUserId]&&a.push(h)}}return this.getMeshNodesByNodeInfos(a)}getMeshNodesByNodeInfos(e){for(var t=[],i=0,r=e.length;i<r;i++){var a=this.getMeshNodesByNodeInfo(e[i]);if(a)for(var n=0,s=a.length;n<s;n++)t.push(a[n])}return t}getMeshNodesBySegmentId(e){var t=this.getNodeIdsBySegmentId(e);if(!t)return[];for(var i=[],r=0,a=t.length;r<a;r++){var n=this.getMeshesNodeByNodeId(t[r]);if(n)for(var s=0,o=n.length;s<o;s++)i.push(n[s])}return i}getMeshNodesBySegmentIds(e){for(var t=[],i=this.getUsedAndNotUsedSegmentIdsBySegmentIds(e),r=i.usedSegmentIds,a=i.notUsedSegmentIds,n=0,s=r.length;n<s;n++)t=t.concat(this.getMeshNodesBySegmentId(r[n]));return t=t.concat(this.getMeshNodesWithNotUsedSegment(r,a))}getUserIdsBySegmentId(e){var t={},i={},r=this.getNodeIdsBySegmentId(e);if(r)for(var a=0,n=r.length;a<n;a++){var s=this.getNodeInfoByNodeId(r[a]);s&&(t[s.userId]=!0,i[s.parentUserId]=!0)}for(var o=this.elementIdMap[e],l=0,d=o.length;l<d;l++)i[o[l]]||(t[o[l]]=!0);return Object.keys(t)}getUserIdsBySegmentIds(e){for(var t=[],i=0,r=e.length;i<r;i++)t=t.concat(this.getUserIdsBySegmentId(e[i]));return t}getUserIdMapBySegmentIdAndParentUserId(e,t){return this.partialParentUserIdMapFromSegmentId[e]?this.partialParentUserIdMapFromSegmentId[e][t]:null}getParentUserIdsBySegmentId(e){return this.partialParentUserIdMapFromSegmentId[e]?Object.keys(this.partialParentUserIdMapFromSegmentId[e]):[]}getParentUserIdsBySegmentIds(e){for(var t=[],i=0,r=e.length;i<r;i++)t=t.concat(this.getParentUserIdsBySegmentId(e[i]));return t}hasSegmentIdFromSegmentIdMap(e){return!!this.segmentIdMap[e]}getGeometriesByNodeInfo(e){var t=e.geometryId;if(this.geometryMapFromGeometryId[t])return this.geometryMapFromGeometryId[t];var i=this.getGeometryDataBuffer(t),r=this._createBufferGeometry(e.type,i);return r?(r instanceof Array||(r=[r]),this.geometryMapFromGeometryId[t]=r,this.geometryMapFromGeometryId[t]):null}_createBufferGeometry(e,t){var i=r.ModelView.BaseDescriptor.EnumNodeItemType,a=null;switch(e){case i.MESH:case i.MESH_REF:if(!t)return null;(a=new THREE.BufferGeometry).setIndex(new THREE.BufferAttribute(t.I,1)),a.setAttribute("position",new THREE.BufferAttribute(t.P,3)),t.N?a.setAttribute("normal",new THREE.BufferAttribute(t.N,3)):a.computeVertexNormals(),t.UV&&a.setAttribute("uv",new THREE.BufferAttribute(t.UV,2));break;case i.TUBE:case i.PIPE:a=r.GeomUtil.UnitCylinderInstance;break;case i.BOX:a=r.GeomUtil.UnitBoxInstance;break;case i.BOX_M:a=r.GeomUtil.getUnitTextureBox();break;case i.PIPE_M:a=r.GeomUtil.getUnitTextureCylinder();break;case i.LINE:if(!t)return null;(a=new THREE.BufferGeometry).setIndex(new THREE.BufferAttribute(t.I,1)),a.setAttribute("position",new THREE.BufferAttribute(t.P,3))}return a}_isParameterizedGeometry(e){var t=r.ModelView.BaseDescriptor.EnumNodeItemType;return e===t.TUBE||e===t.PIPE||e===t.BOX||e===t.BOX_M||e===t.PIPE_M}getGeometryDataBuffer(e){return this.dataBufferMapFromGeometryId[e]}destroyGeometries(){for(var e=Object.keys(this.geometryMapFromGeometryId),t=0,i=e.length;t<i;t++)this.disposeGeometryByGeometryId(e[t]);this.disposeGeometryByGeometryId=null}disposeGeometryByGeometryId(e){if(this.geometryMapFromGeometryId[e]){for(var t=this.geometryMapFromGeometryId[e],i=0,r=t.length;i<r;i++)t[i].dispose();delete this.geometryMapFromGeometryId[e]}}getUsedAndNotUsedSegmentIdsBySegmentIds(e){var t,i,r={};for(t=0,i=e.length;t<i;t++)this.hasSegmentIdFromSegmentIdMap(e[t])&&(r[e[t]]=!0);var a=[],n=this.getAllPartialSegmentIds();for(t=0,i=n.length;t<i;t++)r[n[t]]||a.push(n[t]);return{usedSegmentIds:Object.keys(r),notUsedSegmentIds:a}}getNotUsedPartialUserIds(e,t){for(var i=[],a=r.Utils.arrayToMap(this.getParentUserIdsBySegmentIds(e)),n=r.Utils.arrayToMap(this.getParentUserIdsBySegmentIds(t)),s=Object.keys(n),o=[],l=0,d=s.length;l<d;l++){var h=s[l];a[h]&&o.push(h)}for(var c=0,u=o.length;c<u;c++)for(var p=0,m=t.length;p<m;p++){var f=this.getUserIdMapBySegmentIdAndParentUserId(t[p],o[c]);f&&(i=i.concat(Object.keys(f)))}return i}updateNodeInfos(){var e=this,t=this._getTranslationMatrix();this.traversePartialElements((function(i,a,n){var s=e.getDescriptor().getNodeInfosByUserId(a);if(s)for(var o=0,l=s.length;o<l;o++){var d=s[o];d.finalState||(d.finalState=!0,d.nodeId=i+"|"+d.nodeId,e.hasNodeInfoFromPartialNodeInfoMap(d.nodeId)||(d.state=r.EnumObjectState.Visible,d.material=null,e._isParameterizedGeometry(d.type)?d.geometryId=d.geometryId:d.geometryId=i+"|"+d.geometryId,d.segmentId=n.segmentId||"",d.parentUserId=n.parentUserId,d.single=!0,d.uv=!1,d.isSegment=!0,t&&(d.matrix=d.matrix?d.matrix.premultiply(t):(new THREE.Matrix4).copy(t),d.boundingBox=d.boundingBox?d.boundingBox.applyMatrix4(t):null),e.classifyNodeInfos(d)))}})),this.initFilterManager()}_isSourceNodeInfoLoaded(e){return!!e.sourceLoaded}getNodeGroup(){return this.model._getNodeGroup("FlowSegments",{globalSpace:!0})}updateMeshNodes(){this.clearAllMeshNodes();var e=this.segmentIdArray;if(this.applyReplacementBySegmentIds(e),0!==e.length){for(var t=this.getMeshNodesBySegmentIds(e),i=this.getNodeGroup(),r=0,a=t.length;r<a;r++)i.add(t[r]),this.addMeshToOctantMap(t[r]);i.updateMatrixWorld(!0)}}addMeshToOctantMap(e){var t=this.model.manager,i=this.model.getEncodedDatabagId(),a=e._nodeId,n=this.getNodeInfoByNodeId(e._nodeId);t.addNodeInfoToOctantMap(i,n.cellId,n),t.addMeshToOctantMap(i,n.nodeId,new r.SingleCapsuleObject(n.nodeId,e)),this.nodeIdMapOctantMap[a]=!0}clearMeshNodesFromOctantMap(){for(var e=this.model.manager,t=this.model.getEncodedDatabagId(),i=Object.keys(this.nodeIdMapOctantMap),r=0,a=i.length;r<a;r++)e.removeMeshFromOctantMap(t,this.getNodeInfoByNodeId(i[r]));this.nodeIdMapOctantMap={}}clearAllMeshNodes(){this.getNodeGroup().clear(),this.clearMeshNodesFromOctantMap()}removeFromMeshNodeMap(e){for(var t=0,i=e.length;t<i;t++){var r=this.getNodeIdsBySegmentId(e[t]);if(r)for(var a=0,n=r.length;a<n;a++){var s=r[a];this.disposeGeometryByGeometryId(this.getNodeInfoByNodeId(s).geometryId),delete this.meshNodeMapFromNodeId[s]}}}applyReplacementBySegmentIds(e){if(!e||!e.length)return this.model.setReplacedUserIdMap(null),void this.model.applyReplacement();this.model.setReplacedUserIdMap(r.Utils.arrayToMap(this.getParentUserIdsBySegmentIds(e))),this.model.applyReplacement()}restoreComponentsState(){for(var e=this.getMeshNodesBySegmentIds(this.segmentIdArray),t=0,i=e.length;t<i;t++)e[t].material=e[t]._oriMaterial,e[t].visible=!0}restoreMeshNodeMaterialByNodeIds(e){for(var t=0,i=e.length;t<i;t++){var r=this.getMeshesNodeByNodeId(e[t]);if(r)for(var a=0,n=r.length;a<n;a++)r[a].material=r[a]._oriMaterial}}updateFilterManager(){var e=this.model.getFilter();let t={};t[this.model.fileId]=this.model.getAllNodeInfos(),e.reinitFilterManager(t)}_updateNodeInfosBySourceNodeInfo(){Object.keys(this.partialNodeInfoMapFromNodeId).forEach((e=>{const t=this.partialNodeInfoMapFromNodeId[e];if(this._isSourceNodeInfoLoaded(t))return;const i=this.model.getModelDescriptor().getNodeInfosByUserId(t.parentUserId);t.sourceLoaded=!!i,t.materialId=i?i[0].materialId:-1,t.cellId=i?i[0].cellId:0,t.userData=t.userData?t.userData:i?i[0].userData:null}))}addToNodeInfoMap(){this.removeFromNodeInfoMap(),this._updateNodeInfosBySourceNodeInfo(),this.usedNodeInfos=this.getNodeInfosBySegmentIds(this.segmentIdArray),this.model.getModelDescriptor().addToNodeInfoMap(this.usedNodeInfos)}removeFromNodeInfoMap(){this.usedNodeInfos&&(this.model.getModelDescriptor().removeFromNodeInfoMap(this.usedNodeInfos),this.usedNodeInfos=void 0)}initFilterManager(){this.addToNodeInfoMap(),this.updateFilterManager()}deinitFilterManager(){this.removeFromNodeInfoMap(),this.updateFilterManager()}applyFilter(){for(var e=this.model.getFilter(),t=e._hasHiddenFileIdFilter(),i=e._hasVisibleFilter(),r=e._hasOverrideMaterialFilter(),a=e._hasTransparentFilter(),n=e._getMaterialByName("scene"),s=this.getMeshNodesBySegmentIds(this.segmentIdArray),o=0,l=s.length;o<l;o++){var d=s[o];d.visible=!0,d.material=d._oriMaterial;var h=this.getNodeInfoByNodeId(d._nodeId);if(t&&e._isHiddenFileId(h)||i&&!1===e._isVisible(h))d.visible=!1;else if(a&&e._isTransparent(h))d.material=n;else if(r&&e._hasOverrideMaterial(h)){var c=e._getOverrideMaterial(h);if(!c||""===c.name)continue;d.material=e._getMaterialByName(c.name)}else;}}applySelection(){if(!r.GlobalData.PickingEffect){var e=this.model.manager.sceneState,t=this.model.selectedMaterial,i=e.getSelection();this.clearSelection();var a=this.selectedNodeIdArray;this.traverseMeshNodeMapByUserIds(i,(function(e,i){for(var r=0,n=e.length;r<n;r++)e[r].material=t;a.push(i)}))}}clearSelection(){r.GlobalData.PickingEffect||this.selectedNodeIdArray.length&&(this.restoreMeshNodeMaterialByNodeIds(this.selectedNodeIdArray),this.selectedNodeIdArray.length=0)}applyHover(){var e=this.model.manager,t=e.sceneState;if(t.hoverId&&!t.isSelected(t.hoverId)){this.clearHover();var i=this.model.getFilter(),r=this.hoveredNodeIdArray;this.traverseMeshNodeMapByUserIds([t.hoverId],(function(a,n,s){for(var o=0,l=a.length;o<l;o++){var d=a[o],h=e.getOverrideMaterialByNodeInfo(s,this.model.materialManager.getMaterialById(s.materialId))||i._getOverrideMaterial(s)||d._oriMaterial;d.material=t.getHoverMaterial(h)}r.push(n)}))}}clearHover(){this.hoveredNodeIdArray.length&&(this.restoreMeshNodeMaterialByNodeIds(this.hoveredNodeIdArray),this.hoveredNodeIdArray.length=0)}traverseMeshNodeMapByUserIds(e,t){for(var i=0,r=e.length;i<r;i++){var a=e[i],n=this.getNodeIdsByUserId(e[i]);if(n&&n.length)for(var s=0,o=n.length;s<o;s++){var l=n[s],d=this.getNodeInfoByNodeId(l),h=this.getMeshNodesByNodeInfo(d);h&&t(h,l,d,a)}}}getSegmentIdsByPartialElementId(e){if(this.segmentIdMapFromPartialElementId)return this.segmentIdMapFromPartialElementId[e];var t=this.segmentIdMapFromPartialElementId={};return this.traversePartialElements((function(e,i,r){t[i]||(t[i]=[]),t[i].push(r.segmentId),t[r.parentUserId]||(t[r.parentUserId]=[]),t[r.parentUserId].push(r.segmentId)})),t[e]}cachePartialElements(e,t){this.partialElementMap[e]||(this.partialElementMap[e]={}),this.partialElementMap[e][t.partialElementId]={userId:t.partialElementId,segmentId:t.segmentId,parentUserId:t.elementId}}traversePartialElements(e){for(var t in this.partialElementMap)for(var i in this.partialElementMap[t])e(t,i,this.partialElementMap[t][i])}getSegmentIsolateOption(){return e.IsolateOption}getSegmentMetadata(e,t,i){this.loader._loadMetadata(e,t,i)}resetFilterState(){this.isolateApplied&&(this.model.getFilter().clearIsolation(),this.isolateApplied=!1)}unloadSegments(e){this.resetFilterState(),this.deinitFilterManager(),this.removeFromSegmentIdMap(e),this.removeFromMeshNodeMap(e),this.updateMeshNodes()}loadSegments(e,t){if(e instanceof Array&&0!==e.length){this.elementIdMap={};for(var i={},a={},n=0,s=e.length;n<s;n++){var o,l=e[n].id;o=e[n].paths.length?e[n].paths[0].databag:-1,i[l]=o,a[o]||(a[o]={}),a[o][l]=!0,this.elementIdMap[l]=e[n].elementIds||[]}var d=r.Utils.getDifferentialIdxs(i,this.segmentIdMap);this.segmentIdMap=d.objCurrUsedIdxs,this.segmentIdArray=Object.keys(this.segmentIdMap);var h=r.Utils.getDifferentialIdxs(a,this.segmentPathMap);this.segmentPathMap=h.objCurrUsedIdxs,this.addedSegmentPaths=h.addIdxs;var c=!1;if(d.removeIdxs.length&&(c=!0,this.removeFromMeshNodeMap(d.removeIdxs)),h.removeIdxs.length&&(c=!0,this.removeSegmentBufferByDataIds(h.removeIdxs)),0!==this.addedSegmentPaths.length){this.applyReplacementBySegmentIds(null);var u=this;this.loader.resetTaskCount(),this.loadSegmentsByPaths(this.addedSegmentPaths,(function(){u.updateNodeInfos(),u.updateMeshNodes(),t&&t()}))}else c&&this.updateMeshNodes()}}hideComponentsBySegment(e){var t=this.model.getFilter(),i=this.getUsedAndNotUsedSegmentIdsBySegmentIds(e),r=this.getUserIdsBySegmentIds(i.usedSegmentIds);t.hideByIds(r)}showComponentsBySegment(e){var t=this.model.getFilter(),i=this.getUsedAndNotUsedSegmentIdsBySegmentIds(e),r=this.getUserIdsBySegmentIds(i.usedSegmentIds);t.showByIds(r)}isolateComponentsBySegment(t,i){const r=this.model.getFilter(),a=this.getUsedAndNotUsedSegmentIdsBySegmentIds(t),n=this.getUserIdsBySegmentIds(a.usedSegmentIds),s=this.getNotUsedPartialUserIds(a.usedSegmentIds,a.notUsedSegmentIds),o=n.concat(s);switch(this.restoreComponentsState(),i){case e.IsolateOption.HIDDEN:r.setIsolationByIds(n,"HideOthers");break;case e.IsolateOption.TRANSLUCENT:r.setIsolationByIds(o,"TranslucentOthers");break;case e.IsolateOption.PARTLYTRANSLUCENT:r.setIsolationByIds(o,"HideOthers"),s.length&&r.setIsolationByIds(n,"TranslucentOthers")}this.isolateApplied=!0}disable(){this.getNodeGroup().visible=!1,this.applyReplacementBySegmentIds(null)}enable(){this.getNodeGroup().visible=!0,this.applyReplacementBySegmentIds(this.segmentIdArray)}getDescriptor(){return this.loader.descriptor}getMeshesByUserIds(e){const t=model.getLengthUnitsMatrix();for(let i=0,r=e.length;i<r;i++){const r=e[i],a=this.getNodeIdsByUserId(r);if(a&&a.length)for(let e=0,i=a.length;e<i;e++){const i=this.getNodeInfoByNodeId(a[e]);if(!this.isPickableNode(i))continue;const n=this.getMeshNodesByNodeInfo(i);if(n)for(let e=0,a=n.length;e<a;e++)this.model.minDistanceObjects[r].push({mesh:n[e],matrix:i.matrix,unitsMatrix:t,boundingBox:i.boundingBox})}}}isPickableNode(e){var t=this.model.getFilter(),i=t._hasHiddenFileIdFilter(),r=t._hasVisibleFilter(),a=t._hasTransparentFilter();return!(i&&t._isHiddenFileId(e)||r&&!1===t._isVisible(e))&&(!a||!t._isTransparent(e))}getPickingNodeGenerator(e){return e=null==e?"pick":e,this.pickingNodeGenerators||(this.pickingNodeGenerators={}),this.pickingNodeGenerators[e]||(this.pickingNodeGenerators[e]=new r.PickingSegmentMeshGenerator(this),this.pickingNodeGenerators[e].reserveMaterial=!!e.startsWith("glow")),this.pickingNodeGenerators[e]}_getTranslationMatrix(){if(void 0!==this._translationMatrix)return this._translationMatrix;const e=void 0===this.model.config.view?[0,0,0]:this.model.config.view.translation;return this._translationMatrix=e?(new THREE.Matrix4).makeTranslation(-e[0],-e[1],-e[2]):null,this._translationMatrix}}e.IsolateOption=r.Utils.freezeObject({HIDDEN:0,TRANSLUCENT:1,PARTLYTRANSLUCENT:2}),r.SegmentManager=e}(),function(){class e extends r.SegmentManager{constructor(e){super(e),this.loader=new r.BimtilesSegmentLoader(this)}applyReplacementBySegmentIds(e){if(!e||!e.length)return this.model.setReplacedUserIdMap(null),void this.model.applyReplacement();this.model.setReplacedUserIdMap(r.Utils.arrayToMap(this.getParentUserIdsBySegmentIds(e))),this.model.applyReplacement()}}r.BimtilesSegmentManager=e}(),r.SegmentLoader=class{constructor(e){this.model=e,this.loader=new THREE.FileLoader,this.url=new r.Loader.Url({serverUrl:"",databagId:""}),this.currentTaskCount=0,this.maxTaskCount=0,this.mpkTaskManager=new r.TaskManager,this.databagId="",this.descriptor=new r.ModelView.DefaultDescriptor,this.cfg=null}destroy(){this.model=null,this.loader=null,this.url=null,this.mpkTaskManager=null,this.descriptor.destroy(),this.descriptor=null,this.cfg=null}load(e,t){var i=this;this.finishedCallback=t,this.databagId=e,this.url.databagPath=e,this.loader.setResponseType(""),this.loader.load(this.url.projectUrl(),(function(e){var r;try{r=JSON.parse(e)}catch(e){return console.log("Config data exceptions!"),void(t&&t())}i.cfg=r;var a=r.metadata,n=a.scenes?1:0;if(0===n)return console.log("empty scene!"),void(t&&t());var s=a.mpks||0;if(0!==s){var o=a.symbol?1:0,l=a.userdata?1:0,d=a.lines||0;i.maxTaskCount+=n,i.maxTaskCount+=o,i.maxTaskCount+=1,i.maxTaskCount+=l,i.maxTaskCount+=d,i.maxTaskCount+=s,i._loadScene(),o&&i._loadSymbol(),i._loadUserId(),l&&i._loadUserData(),d&&i._loadLine(),i._loadMpks(s)}else t&&t()}))}_loadMetadata(e,t,i){var a=this;e=r.Utils.getEncodedId(e),this.loader.setResponseType(""),this.loader.load(t,(function(t){for(var r=JSON.parse(t).partialElements,n=0,s=r.length;n<s;n++)a.model.cachePartialElements(e,r[n]);i&&i()}),void 0,(function(e){i&&i()}))}_loadScene(){var e=this,t=this.cfg.metadata;this.loader.setResponseType("arraybuffer"),this.loader.load(this.url.sceneUrl(0),(function(i){e.descriptor.mapSceneReader[0]=new r.Loader.SceneReader(i,t.version),e._onTaskFinished()}),void 0,(function(t){e._onTaskFinished()}))}_loadLine(){var e=this,t=r.Utils.getEncodedId(this.databagId);this.loader.setResponseType("arraybuffer"),this.loader.load(this.url.lineUrl(),(function(i){for(var a=new r.Loader.LineReader(i),n=0,s=a.header.lineCount;n<s;++n){var o=a.getPtBuffer(n),l=a.getIdxBuffer(n);if(null!=o&&null!=l){var d=a.getLineData(n);if(0===d.lineType){for(var h=[],c=1,u=l.length;c<u;c++)h.push(l[c-1]),h.push(l[c]);h.length&&(l=h)}e.model.cacheSegmentBuffer(t,"line-"+d.line_id,{P:o,I:l})}else r.Logger.log("Error Geometry!")}a=null,e._onTaskFinished()}),void 0,(function(t){e._onTaskFinished()}))}_loadSymbol(){var e=this,t=this.cfg.metadata;this.loader.setResponseType("arraybuffer"),this.loader.load(this.url.symbolUrl(),(function(i){e.descriptor.symbolReader=new r.Loader.SymbolReader(i,t.version),e._onTaskFinished()}),void 0,(function(t){e._onTaskFinished()}))}_loadUserId(){var e=this;this.loader.setResponseType("arraybuffer"),this.loader.load(this.url.userIdUrl(),(function(t){e.descriptor.userIdReader=new r.Loader.IdReader(t),e._onTaskFinished()}),void 0,(function(t){e._onTaskFinished()}))}_loadUserData(){var e=this;this.loader.setResponseType(""),this.loader.load(this.url.userDataUrl(),(function(t){e.descriptor.userDataReader=new r.Loader.UserDataReader(t),e._onTaskFinished()}),void 0,(function(t){e._onTaskFinished()}))}_loadMpks(e){for(var t=0;t<e;++t)this.mpkTaskManager.addTask(t);this.mpkTaskManager.processTasks(this.loadMpk.bind(this))}loadMpk(e,t){var i=this,a=r.Utils.getEncodedId(this.databagId);this.loader.setResponseType("arraybuffer"),this.loader.load(this.url.mpkUrl(e),(function(e){for(var n=new r.Loader.MPKReader(e),s=n.header.meshCount,o=new THREE.Matrix4,l=0;l<s;++l){var d=n.getPtBuffer(l),h=n.getIdxBuffer(l);if(null!=d&&null!=h){var c=n.getNormalBuffer(l),u=n.getMeshData(l),p=n.getUVBuffer(l);0!==u.baseScale&&(d=new Float32Array(d),o.identity(),o.setPosition(new THREE.Vector3(u.baseX,u.baseY,u.baseZ)),o.scale(new THREE.Vector3(u.baseScale,u.baseScale,u.baseScale)),r.GeomUtil.applyMatrix4ToBuffer(o,d)),i.model.cacheSegmentBuffer(a,u.mesh_id,{P:d,I:h,N:c,UV:p})}else r.Logger.log("Error Geometry!")}n=null,t(),i._onTaskFinished()}),void 0,(function(e){i._onTaskFinished()}))}_onTaskFinished(){this.currentTaskCount++,this.currentTaskCount>=this.maxTaskCount&&(this.prepareData(),this.finishedCallback())}prepareData(){this.descriptor.parseItemData(),this.descriptor.classifyAllNodeInfo()}resetTaskCount(){this.maxTaskCount=0,this.currentTaskCount=0}},function(){class e extends r.SegmentLoader{constructor(e){super(e)}load(e,t){this.finishedCallback=t,this.databagId=e,this.url.databagPath=e,this.loader.setResponseType(""),this.loader.load(this.url.projectUrl(),(e=>{var i;try{i=JSON.parse(e)}catch(e){return console.log("Config data exceptions!"),void(t&&t())}this.cfg=i;const r=this.model.viewer,a=(r.getModelManager(),"bimface.com"),n=this.databagId.split(a);r.load({serverUrl:n[0]+a,databagId:n[1],loadConfig:{enableBorderLine:!0}})}))}}r.BimtilesSegmentLoader=e}(),function(){class e extends r.ObjectGroup{constructor(e){super(r.ObjectGroupType.VIEWSHED,{priority:20}),e=e||{},this._position=new THREE.Vector3(0,0,0),this._direction=new THREE.Vector3(0,0,-1),this._visibleAreaColor=new THREE.Vector4(0,255,0,.8),this._hiddenAreaColor=new THREE.Vector4(255,0,0,.8),this._distance=null!=e.distance?e.distance:200,this._horizontalFov=null!=e.horizontalFov?e.horizontalFov:2*Math.PI/3,this._verticalFov=null!=e.verticalFov?e.verticalFov:Math.PI/2,this._translucenceAvailable=!1!==e.translucenceAvailable,this._frustumVisible=e.frustumVisible,this._effectVisible=!0,this.visible=this._frustumVisible,this._up=new THREE.Vector3(0,1,0),this._right=new THREE.Vector3(1,0,0),this._unitAngle=5,this._cornerLeftTop=new THREE.Vector3,this._cornerRightTop=new THREE.Vector3,this._cornerLeftBottom=new THREE.Vector3,this._cornerRightBottom=new THREE.Vector3,this._viewer=null,this._lineGeometry=new THREE.BufferGeometry,this._lineMaterial=new THREE.LineBasicMaterial({color:16777215}),this._lineMesh=new THREE.LineSegments(this._lineGeometry,this._lineMaterial),this._sphereGeometry=new THREE.BufferGeometry,this._sphereMaterial=new THREE.MeshBasicMaterial({color:16777215,side:THREE.DoubleSide}),this._sphereMesh=new THREE.Mesh(this._sphereGeometry,this._sphereMaterial),this._sphereMesh.visible=!1,this.camera=new THREE.PerspectiveCamera,this.viewMatrix=new THREE.Matrix4,this.viewProjMatrix=new THREE.Matrix4,this.depthRenderTarget=new THREE.WebGLRenderTarget(1024,1024,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter});var t=new THREE.Vector3;this.updateViewMatrix=function(){t.copy(this._position),t.add(this._direction),this.camera.position.copy(this._position),this.camera.lookAt(t),this.camera.updateMatrixWorld(!0),this.viewMatrix.copy(this.camera.matrixWorld).invert()};var i=new THREE.Vector3;new THREE.Vector3;this.updateProjMatrix=function(){var e=Math.cos(this._horizontalFov/2),t=Math.tan(this._verticalFov/2),r=Math.atan(e*t),a=this._distance*Math.cos(r)*Math.cos(this._horizontalFov/2);i.copy(this._position),i.addScaledVector(this._direction,a);var n=a*Math.tan(this._horizontalFov/2),s=a*Math.tan(this._verticalFov/2);this._cornerLeftTop.copy(i),this._cornerLeftTop.addScaledVector(this._right,-n),this._cornerLeftTop.addScaledVector(this._up,s),this._cornerRightTop.copy(i),this._cornerRightTop.addScaledVector(this._right,n),this._cornerRightTop.addScaledVector(this._up,s),this._cornerLeftBottom.copy(i),this._cornerLeftBottom.addScaledVector(this._right,-n),this._cornerLeftBottom.addScaledVector(this._up,-s),this._cornerRightBottom.copy(i),this._cornerRightBottom.addScaledVector(this._right,n),this._cornerRightBottom.addScaledVector(this._up,-s);var o=Math.tan(.5*this._horizontalFov)/Math.tan(.5*this._verticalFov);this.camera.fov=THREE.Math.radToDeg(this._verticalFov),this.camera.aspect=o,this.camera.near=.01,this.camera.far=Math.max(this._distance),this.camera.updateProjectionMatrix()},this.getViewProjMatrix=function(){return this.viewProjMatrix.multiplyMatrices(this.camera.projectionMatrix,this.viewMatrix),this.viewProjMatrix},this.createSideLines=function(){for(var e=[],t=[this._cornerLeftBottom,this._cornerRightBottom,this._cornerRightTop,this._cornerLeftTop],i=0;i<t.length;i++)e.push(this._position.x,this._position.y,this._position.z),e.push(t[i].x,t[i].y,t[i].z);return e};var a=new THREE.Vector3,n=new THREE.Vector3,s=new THREE.Vector3,o=new THREE.Vector3,l=[],d=this;this.createTopSideLines=function(){var e=[];function t(e,t,i){var r=[];if(i){for(var a=e;a<t;)if(r.push(a),(a+=d._unitAngle)>=t){r.push(t);break}}else for(a=t;a>e;)if(r.push(a),(a-=d._unitAngle)<=e){r.push(e);break}return r}a.copy(this._cornerLeftTop),a.sub(this._position),n.copy(this._cornerRightTop),n.sub(this._position),s.copy(this._cornerRightBottom),s.sub(this._position);var i,r,h=THREE.Math.radToDeg(n.angleTo(s)),c=THREE.Math.radToDeg(a.angleTo(n)),u=[{axis:"up",outerAngle:-this._horizontalFov/2,innerAngles:t(-h/2,h/2,!0)},{axis:"right",outerAngle:this._verticalFov/2,innerAngles:t(-c/2,c/2,!0)},{axis:"up",outerAngle:this._horizontalFov/2,innerAngles:t(-h/2,h/2,!1)},{axis:"right",outerAngle:-this._verticalFov/2,innerAngles:t(-c/2,c/2,!1)}];l=[];for(var p=0;p<u.length;p++){"up"==u[p].axis?(i=this._up,r=this._right):"right"==u[p].axis&&(i=this._right,r=this._up);for(var m=[],f=0;f<u[p].innerAngles.length;f++){o.copy(this._direction),o.applyAxisAngle(r,THREE.Math.degToRad(u[p].innerAngles[f])),o.applyAxisAngle(i,u[p].outerAngle),o.multiplyScalar(this._distance);var g=new THREE.Vector3;g.copy(this._position),g.add(o),m.push(g),l.push(g)}for(f=0;f<m.length-1;f++)e.push(m[f].x,m[f].y,m[f].z),e.push(m[f+1].x,m[f+1].y,m[f+1].z)}return e};var h=new THREE.Vector3,c=new THREE.Vector3,u=new THREE.Vector3,p=new THREE.Vector3,m=new THREE.Quaternion;this.createTopLines=function(){var e=[];h.copy(this._position),h.addScaledVector(this._direction,this._distance),c.copy(h),c.sub(this._position),c.normalize();for(var t=[],i=0,r=0;r<l.length;r++){p.copy(l[r]),p.sub(this._position),p.normalize(),u.copy(c),u.cross(p),u.normalize();for(var a=THREE.Math.radToDeg(c.angleTo(p)),n=[],s=0;;s+=this._unitAngle){s>=a&&(s=a),m.setFromAxisAngle(u,THREE.Math.degToRad(s)),o.copy(c),o.applyQuaternion(m);var d=new THREE.Vector3;if(d.copy(this._position),d.addScaledVector(o,this._distance),n.push(d),s>=a)break}i=Math.max(i,n.length),t.push(n)}for(r=0;r<t.length;r++)for(s=0;s<t[r].length-1;s++)e.push(t[r][s].x,t[r][s].y,t[r][s].z),e.push(t[r][s+1].x,t[r][s+1].y,t[r][s+1].z);for(r=1;r<i;r++)for(s=0;s<t.length-1;s++)t[s][r]&&t[s+1][r]&&(e.push(t[s][r].x,t[s][r].y,t[s][r].z),e.push(t[s+1][r].x,t[s+1][r].y,t[s+1][r].z));return e},this.updateMeshGeometry=function(){this.updateViewMatrix(),this.updateProjMatrix(),this._sphereGeometry=new THREE.SphereGeometry(this._distance,40,40),this._sphereGeometry.translate(this._position.x,this._position.y,this._position.z);var e=[];return e=(e=(e=e.concat(this.createSideLines())).concat(this.createTopSideLines())).concat(this.createTopLines()),this._lineGeometry.deleteAttribute("position"),this._lineGeometry.setAttribute("position",new THREE.BufferAttribute(new Float32Array(e),3)),this._lineGeometry},this.initPrimitive=function(){this.updateMeshGeometry(),this._lineMesh.geometry=this._lineGeometry,this.add(this._lineMesh),this._sphereMesh.geometry=this._sphereGeometry,this.add(this._sphereMesh)},this.updatePrimitive=function(){this.updateMeshGeometry(),this._lineMesh.geometry=this._lineGeometry,this._sphereMesh.geometry=this._sphereGeometry},r.Viewshed.prototype.getId=function(){return this.uuid};var f={x:0,y:0,z:0};r.Viewshed.prototype.getPositon=function(){return f.x=this._position.x,f.y=this._position.y,f.z=this._position.z,f};var g=new THREE.Vector3;r.Viewshed.prototype.setPosition=function(e){g.x=e.x,g.y=e.y,g.z=e.z,this._position!=g&&(this._position.copy(g),this.updatePrimitive())};var v={x:0,y:0,z:0};r.Viewshed.prototype.getDirection=function(){return v.x=this._direction.x,v.y=this._direction.y,v.z=this._direction.z,v};var y=new THREE.Vector3(0,1,0),M=new THREE.Vector3;r.Viewshed.prototype.setDirection=function(e){M.x=e.x,M.y=e.y,M.z=e.z,M.normalize(),this._direction!=M&&(0!==M.lengthSq()?(this._direction.copy(M),this._right.crossVectors(y,M),0===this._right.lengthSq()&&(1===Math.abs(y.z)?M.x+=1e-4:M.z+=1e-4,M.normalize(),this._right.crossVectors(y,M)),this._right.normalize(),this._up.crossVectors(M,this._right),this.updatePrimitive()):r.Logger.warn("WARNING: Invalid direction when CLOUD.Viewshed.prototype.setDirection()"))};var E={x:0,y:0,z:0,w:0};r.Viewshed.prototype.getVisibleAreaColor=function(){return E.x=this._visibleAreaColor.x,E.y=this._visibleAreaColor.y,E.z=this._visibleAreaColor.z,E.w=this._visibleAreaColor.w,E};var b=new THREE.Vector4;r.Viewshed.prototype.setVisibleAreaColor=function(e){b.x=e.red||e.x?e.red||e.x:0,b.y=e.green||e.y?e.green||e.y:0,b.z=e.blue||e.z?e.blue||e.z:0,b.w=e.alpha||e.w?e.alpha||e.w:0,this._visibleAreaColor!=b&&(this._visibleAreaColor.copy(b),this.updatePrimitive())};var I={x:0,y:0,z:0,w:0};r.Viewshed.prototype.getHiddenAreaColor=function(){return I.x=this._hiddenAreaColor.x,I.y=this._hiddenAreaColor.y,I.z=this._hiddenAreaColor.z,I.w=this._hiddenAreaColor.w,I};var x=new THREE.Vector4;r.Viewshed.prototype.setHiddenAreaColor=function(e){x.x=e.red||e.x?e.red||e.x:0,x.y=e.green||e.y?e.green||e.y:0,x.z=e.blue||e.z?e.blue||e.z:0,x.w=e.alpha||e.w?e.alpha||e.w:0,this._hiddenAreaColor!=x&&(this._hiddenAreaColor.copy(x),this.updatePrimitive())},r.Viewshed.prototype.getDistance=function(){return this._distance},r.Viewshed.prototype.setDistance=function(e){this._distance!=e&&(this._distance=e,this.updatePrimitive())},r.Viewshed.prototype.getHorizontalFov=function(){return this._horizontalFov},r.Viewshed.prototype.setHorizontalFov=function(e){this._horizontalFov!=e&&(this._horizontalFov=e,this.updatePrimitive())},r.Viewshed.prototype.getVerticalFov=function(){return this._verticalFov},r.Viewshed.prototype.setVerticalFov=function(e){this._verticalFov!=e&&(this._verticalFov=e,this.updatePrimitive())},r.Viewshed.prototype.setTranslucenceAvailable=e=>{this._translucenceAvailable=e},r.Viewshed.prototype.getTranslucenceAvailable=()=>this._translucenceAvailable,r.Viewshed.prototype.show=function(){this._effectVisible=!0,this._frustumVisible&&(this.visible=!0),this._viewer&&this._viewer.viewshedManager.update()},r.Viewshed.prototype.hide=function(){this._effectVisible=!1,this.visible=!1,this._viewer&&this._viewer.viewshedManager.update()},r.Viewshed.prototype.setFrustumVisible=function(e){this._frustumVisible=e,this.visible=e,this._viewer&&this._viewer.viewshedManager.update()},r.Viewshed.prototype.isFrustumVisible=function(){return this._frustumVisible},r.Viewshed.prototype.isEffectVisible=function(){return!0===this._effectVisible},this.setPosition(null!=e.position?e.position:this._position),this.setDirection(null!=e.direction?e.direction:this._direction),this.setVisibleAreaColor(null!=e.visibleAreaColor?e.visibleAreaColor:this._visibleAreaColor),this.setHiddenAreaColor(null!=e.hiddenAreaColor?e.hiddenAreaColor:this._hiddenAreaColor),this.initPrimitive()}}r.Viewshed=e}(),(()=>{class e extends r.EditTool{constructor(e){super(r.EditToolMode.VIEW_SHED_ANALYSIS),this.viewer=e,this.scene=e.getScene(),this.viewshed=new r.Viewshed({position:new THREE.Vector3(0,0,0),direction:new THREE.Vector3(0,0,-1),distance:500,horizontalFov:2*Math.PI/3,verticalFov:Math.PI/2}),this.viewshed.show(),this.scene.objectGroups.add(this.viewshed)}enable(e){e?this.viewshed.show():this.viewshed.hide()}destroy(){}onEnter(){this.enable(!0)}onExit(){this.enable(!1)}processMouseDown(e){}processHover(e){}processMouseUp(e){}processMouseMove(e){}processTouchstart(e){}processTouchmove(e){}processTouchend(e){}}r.ViewshedTool=e})(),r.ViewshedManager=class{constructor(e){this.viewer=e,this.scene=e.getScene(),this.modelManager=e.modelManager,this._viewsheds=[],this._maxViewshedCount=4,this._viewshedContents=[],this._viewshedDepthMaps=[];for(var t=0;t<this._maxViewshedCount;t++)this._viewshedDepthMaps.push(new THREE.Texture),this._viewshedContents.push({viewshedViewProjMatrix:new THREE.Matrix4,viewshedViewMatrix:new THREE.Matrix4,viewshedVisibleColor:new THREE.Vector4,viewshedHiddenColor:new THREE.Vector4,viewshedMinMax:new THREE.Vector2,viewshedLogDepthBufFC:1})}destroy(){this._viewsheds=null,this._viewshedContents=null,this._viewshedDepthMaps=null,this.scene=null,this.modelManager=null,this.viewer=null}addViewshed(e){return this._viewsheds.push(e),this.scene.objectGroups.add(e),e._viewer=this.viewer,e}getViewshedById(e){for(var t=0;t<this._viewsheds.length;t++)if(this._viewsheds[t].getId()==e)return this._viewsheds[t]}getViewsheds(){return this._viewsheds}hideById(e){var t=this.getViewshedById(e);t&&t.hide(),this.update()}showById(e){var t=this.getViewshedById(e);t&&t.show(),this.update()}removeById(e){for(var t=0;t<this._viewsheds.length;t++)if(this._viewsheds[t].getId()==e){this.scene.objectGroups.remove(this._viewsheds[t]),this._viewsheds.splice(t,1);break}this.update()}clear(){for(var e=0;e<this._viewsheds.length;e++)this.scene.objectGroups.remove(this._viewsheds[e]);this._viewsheds=[],this.update()}update(){if(this._viewsheds.length>this._maxViewshedCount)console.warn("WARNING: Viewshed count exceeds max count limit");else{this._resetContents();for(var e=this.viewer.rendererManager.renderer,t=this.viewer.getScene(),i=0,r=0;r<this._viewsheds.length;r++)if(this._viewsheds[r].isEffectVisible()){var a=this._viewsheds[r].camera,n=this._viewsheds[r].depthRenderTarget;e.renderCustomDepth&&(this._viewsheds[r]._sphereMesh.visible=!0,!0===this._viewsheds[r].getTranslucenceAvailable()?e.renderCustomDepthByOpacity(e.renderer,t,a,n,.7,!0):e.renderCustomDepth(e.renderer,t,a,n,!0),this._viewsheds[r]._sphereMesh.visible=!1);var s=this._viewsheds[r].getVisibleAreaColor(),o=this._viewsheds[r].getHiddenAreaColor();this._viewshedContents[i].viewshedViewProjMatrix.copy(this._viewsheds[r].getViewProjMatrix()),this._viewshedContents[i].viewshedViewMatrix.copy(this._viewsheds[r].viewMatrix),this._viewshedContents[i].viewshedVisibleColor.set(s.x/255,s.y/255,s.z/255,s.w),this._viewshedContents[i].viewshedHiddenColor.set(o.x/255,o.y/255,o.z/255,o.w),this._viewshedContents[i].viewshedMinMax.set(a.near,a.far),this._viewshedContents[i].viewshedLogDepthBufFC=2/(Math.log(a.far+1)/Math.LN2),this._viewshedDepthMaps[i]=n.texture,i++}this.modelManager.updateMaterialsValue("viewshedCount",0==i?-1:i),this.modelManager.updateMaterialsValue("viewshedContents",this._viewshedContents),this.modelManager.updateMaterialsValue("viewshedDepthMaps",this._viewshedDepthMaps)}}_resetContents(){for(var e=0;e<this._maxViewshedCount;e++)this._viewshedContents[e].viewshedViewProjMatrix.identity(),this._viewshedContents[e].viewshedViewMatrix.identity(),this._viewshedContents[e].viewshedVisibleColor.set(0,1,0,.8),this._viewshedContents[e].viewshedHiddenColor.set(1,0,0,.8),this._viewshedContents[e].viewshedMinMax.set(0,0),this._viewshedContents[e].viewshedLogDepthBufFC=1}},r.VideoCast=class{constructor(e){e=e||{},this._id=e.id,this._position=void 0!==e.position?new THREE.Vector3(e.position.x,e.position.y,e.position.z):new THREE.Vector3(0,0,0),this._direction=void 0!==e.direction?new THREE.Vector3(e.direction.x,e.direction.y,e.direction.z):new THREE.Vector3(0,0,-1),this._distance=void 0!==e.distance?e.distance:2e3,this._horizontalFov=void 0!==e.horizontalFov?e.horizontalFov:2*Math.PI/3,this._verticalFov=void 0!==e.verticalFov?e.verticalFov:Math.PI/2,this._projectorMap=void 0!==e.projectorMap?e.projectorMap:new THREE.Texture,this._up=new THREE.Vector3(0,1,0),this._right=new THREE.Vector3(1,0,0),this.camera=new THREE.PerspectiveCamera,this.viewMatrix=new THREE.Matrix4,this.viewProjMatrix=new THREE.Matrix4,this.depthRenderTarget=new THREE.WebGLRenderTarget(1024,1024,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter}),this._visible=!0,this.scratchAt=new THREE.Vector3,this.updateViewMatrix(),this.updateProjMatrix()}destroy(){this._id=void 0,this._position=null,this._direction=null,this._distance=void 0,this._horizontalFov=void 0,this._verticalFov=void 0,this._projectorMap=null,this._up=null,this._right=null,this.camera=null,this.viewMatrix=null,this.viewProjMatrix=null,this.depthRenderTarget=null,this._visible=void 0,this.scratchAt=null}setVisible(e){this._visible=e}getVisible(){return this._visible}updateViewMatrix(){this.scratchAt.copy(this._position),this.scratchAt.add(this._direction),this.camera.position.copy(this._position),this.camera.lookAt(this.scratchAt),this.camera.updateMatrixWorld(!0),this.viewMatrix.copy(this.camera.matrixWorld).invert()}updateProjMatrix(){const e=Math.tan(.5*this._horizontalFov)/Math.tan(.5*this._verticalFov);this.camera.fov=THREE.Math.radToDeg(this._verticalFov),this.camera.aspect=e,this.camera.near=.01,this.camera.far=this._distance,this.camera.updateProjectionMatrix()}getViewMatrix(){return this.viewMatrix}getViewProjMatrix(){return this.viewProjMatrix.multiplyMatrices(this.camera.projectionMatrix,this.viewMatrix),this.viewProjMatrix}getId(){return this._id}setProjectorMap(e){this._projectorMap=e}getProjectorMap(){return this._projectorMap}getPosition(){return this._position}setPosition(e){this._position!=e&&(this._position=e)}getDirection(){return this._direction}setDirection(e){this._direction!=e&&(this._direction=e)}getDistance(){return this._distance}setDistance(e){this._distance!=e&&(this._distance=e)}getHorizontalFov(){return this._horizontalFov}setHorizontalFov(e){this._horizontalFov!=e&&(this._horizontalFov=e)}getVerticalFov(){return this._verticalFov}setVerticalFov(e){this._verticalFov!=e&&(this._verticalFov=e)}},r.VideoCastManager=class{constructor(e){this.viewer=e,this.scene=e.getScene(),this.modelManager=e.modelManager,this._videoCasts=[],this._maxVideoCastCount=4,this._videoCastContents=[],this._videoCastDepthMaps=[],this._videoCastProjectorMaps=[];for(var t=0;t<this._maxVideoCastCount;t++)this._videoCastDepthMaps.push(new THREE.Texture),this._videoCastProjectorMaps.push(new THREE.Texture),this._videoCastContents.push({viewProjMatrix:new THREE.Matrix4,viewMatrix:new THREE.Matrix4,logDepthBufFC:1});this.firstAnimate=!0}destroy(){this._cancelAnimate();for(let e=0;e<this._videoCasts.length;e++)this.scene.objectGroups.remove(this._videoCasts[e]);this._videoCasts=null,this._videoCastContents=null,this._videoCastDepthMaps=null,this.scene=null,this.modelManager=null,this.viewer=null}addVideoCast(e){this._videoCasts.push(e),this.update(),!0===this.firstAnimate&&(this.firstAnimate=!1,this._animate())}getVideoCastById(e){for(var t=0;t<this._videoCasts.length;t++)if(this._videoCasts[t].getId()==e)return this._videoCasts[t]}getVideoCasts(){return this._videoCasts}hideById(e){var t=this.getVideoCastById(e);t&&t.setVisible(!1),this.update()}showById(e){var t=this.getVideoCastById(e);t&&t.setVisible(!0),this.update()}removeById(e){for(var t=0;t<this._videoCasts.length;t++)if(this._videoCasts[t].getId()==e){this._videoCasts.splice(t,1);break}this.update(),0===this.getVisibleCount()&&(this.firstAnimate=!0,this._cancelAnimate())}clear(){for(let e=0;e<this._videoCasts.length;e++)this.scene.objectGroups.remove(this._videoCasts[e]);this._videoCasts=[],this.update()}getVisibleCount(){let e=0;for(let t=0;t<this._videoCasts.length;t++)this._videoCasts[t].getVisible()&&e++;return e}update(){if(this._videoCasts.length>this._maxVideoCastCount)return void console.warn("WARNING: VideoCast count exceeds max count limit");const e=this.viewer.rendererManager.renderer,t=this.viewer.getScene();let i=0;for(let r=0;r<this._videoCasts.length;r++)if(this._videoCasts[r].getVisible()){const a=this._videoCasts[r].camera,n=this._videoCasts[r].depthRenderTarget;e.renderCustomDepth&&e.renderCustomDepth(e.renderer,t,a,n,!0),this._videoCastContents[i].viewProjMatrix.copy(this._videoCasts[r].getViewProjMatrix()),this._videoCastContents[i].viewMatrix.copy(this._videoCasts[r].getViewMatrix()),this._videoCastContents[i].logDepthBufFC=2/(Math.log(a.far+1)/Math.LN2),this._videoCastDepthMaps[i]=n.texture,this._videoCastProjectorMaps[i]=this._videoCasts[r].getProjectorMap(),i++}this.modelManager.updateMaterialsValue("videoCastCount",0==i?-1:i),this.modelManager.updateMaterialsValue("videoCastContents",this._videoCastContents),this.modelManager.updateMaterialsValue("videoCastDepthMaps",this._videoCastDepthMaps),this.modelManager.updateMaterialsValue("videoCastProjectorMaps",this._videoCastProjectorMaps)}_animate(){let e=()=>{this.animationId=requestAnimationFrame(e),0!==this.getVisibleCount()&&this.viewer.render()};e()}_cancelAnimate(){cancelAnimationFrame(this.animationId),this.animationId=0}},r.TerrainExcavation=class{constructor(e){this.geometry=null,this.material=null,this.id=e.id||"",this.visible=e.visible||!1,this.terrainOperationManager=e.terrainOperationManager}init(e){for(var t=e.length,i=new Array,a=0,n=new THREE.Vector3,s=new Array(2*t),o=0;o<t;o++)n.copy(e[o]),n.y=0,s[2*o]=n.x,s[2*o+1]=n.z,n.toArray(i,a),a+=3;var l=r.earcut(s),d=new THREE.BufferGeometry;d.setIndex(l),d.setAttribute("position",new THREE.Float32BufferAttribute(i,3)),d.computeBoundingBox(),this.geometry=d;var h=new THREE.ShaderMaterial({uniforms:{},side:THREE.DoubleSide,vertexShader:"\n                    void main()\n                    {\n                        gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n                    }\n                ",fragmentShader:"\n                    precision highp float;\n                    void main()\n                    {\n                        gl_FragColor = vec4(1.0, 0.0, 0.0 , 1.0);\n                    }\n                "});this.material=h}dispose(){this.geometry.dispose(),this.material.dispose()}setId(e){this.id=e}getId(){return this.id}setVisible(e){this.visible=e}getVisible(){return this.visible}getAABBMin(){return this.geometry.boundingBox.min}getAABBMax(){return this.geometry.boundingBox.max}},G=new THREE.Vector3,r.TerrainFlatten=class{constructor(e){this.visible=e.visible||!1,this.id=e.id||"",this.elevation=e.elevation||0,this.viewer=e.viewer,this.modelIds=e.modelIds,this.boundingBox=new THREE.Box3,this.pointsInDrawing=[]}init(e){this.pointsInDrawing=[];for(var t=new THREE.Vector3(1/0,0,1/0),i=new THREE.Vector3(-1/0,0,-1/0),r=0;r<e.length;r++)this.pointsInDrawing.push(new THREE.Vector2(e[r].x,e[r].z)),t.x=Math.min(t.x,e[r].x),t.z=Math.min(t.z,e[r].z),i.x=Math.max(i.x,e[r].x),i.z=Math.max(i.z,e[r].z);this.boundingBox.min.copy(t),this.boundingBox.max.copy(i)}setId(e){this.id=e}getId(){return this.id}getModelIds(){return this.modelIds}setModelId(e){this.modelIds=e}setVisible(e){this.visible=e}getVisible(){return this.visible}isInRegionDrawing(e,t){return-1!==this.modelIds.indexOf(t)&&r.Utils.pointInPolygon(e,this.pointsInDrawing)}isIntersectRegionBboxDrawing(e,t){return-1!==this.modelIds.indexOf(t)&&this.boundingBox.intersectsBox(e)}transformElevation(e){G.set(0,0,this.elevation),(G=this.viewer.worldToDrawing(G)).applyMatrix4(e),this.worldElevation=G.z}transformPolygon(e){for(var t=[],i=0;i<this.pointsInDrawing.length;i++)G.set(this.pointsInDrawing[i].x,0,this.pointsInDrawing[i].y),G.applyMatrix4(e),t.push(new THREE.Vector2(G.x,G.y));return t}},r.TerrainOperationManager=class{constructor(e){this.frustum=new THREE.Frustum,this.viewer=e,this.terrainExcavations={},this.terrainExcavationsNumber=0,this.terrainFlattens=[]}render(e){}pickExcavation(e){}calcOrthoCamera(){}setSize(e,t){}dispose(){this.clearExcavationRegions(),this.clearFlattenRegions(),this.frustum=null,this.viewer=null,this.terrainExcavations=null,this.terrainFlattens=null}addExcavationRegion(e,t){if(this.terrainExcavations.hasOwnProperty(e))console.warn("the terrain Excavation id '"+e+"' is existed.");else{var i=new r.TerrainExcavation({terrainOperationManager:this,id:e,visible:!0});i.init(t),this.terrainExcavations[e]=i,this.isDirty=!0,this.terrainExcavationsNumber++}}hideExcavationRegionsById(e){for(var t=0;t<e.length;++t)this.terrainExcavations.hasOwnProperty(e[t])&&(this.terrainExcavations[e[t]].setVisible(!1),this.isDirty=!0)}showExcavationRegionsById(e){for(var t=0;t<e.length;++t)this.terrainExcavations.hasOwnProperty(e[t])&&(this.terrainExcavations[e[t]].setVisible(!0),this.isDirty=!0)}removeExcavationRegionsById(e){for(var t=0;t<e.length;++t)this.terrainExcavations.hasOwnProperty(e[t])&&(this.terrainExcavations[e[t]].dispose(),delete this.terrainExcavations[e[t]],this.isDirty=!0,this.terrainExcavationsNumber--)}clearExcavationRegions(){for(var e in this.terrainExcavations)this.terrainExcavations[e].dispose(),delete this.terrainExcavations[e],this.isDirty=!0,this.terrainExcavationsNumber--}addFlattenRegion(e,t,i,a){if(this._hasFlattenRegion(e))console.warn("the terrain flatten id '"+e+"' is existed.");else{var n=new r.TerrainFlatten({viewer:this.viewer,id:e,visible:!0,elevation:i,modelIds:a});n.init(t),this.terrainFlattens.push(n),this._updateTerrainForFlatten(a)}}removeFlattenRegionsById(e){for(var t=this.terrainFlattens.length-1;t>=0;--t)if(e.indexOf(this.terrainFlattens[t].getId())>=0){const e=this.terrainFlattens[t].getModelIds();this.terrainFlattens.splice(t,1),this._updateTerrainForFlatten(e)}}clearFlattenRegions(){for(let e=this.terrainFlattens.length-1;e>=0;--e){const t=this.terrainFlattens[e].getModelIds();this.terrainFlattens.splice(e,1),this._updateTerrainForFlatten(t)}this.terrainFlattens=[]}isInFlattenRegionDrawing(e,t){for(var i=this.terrainFlattens.length-1;i>=0;--i)if(this.terrainFlattens[i].isInRegionDrawing(e,t))return this.terrainFlattens[i];return!1}isIntersectFlattenBboxDrawing(e,t){for(let i=this.terrainFlattens.length-1;i>=0;--i)if(this.terrainFlattens[i].isIntersectRegionBboxDrawing(e,t))return!0;return!1}_hasFlattenRegion(e){for(var t=0;t<this.terrainFlattens.length;t++)if(e==this.terrainFlattens[t].getId())return!0;return!1}_updateTerrainForFlatten(e){e.map((e=>{const t=this.viewer.modelManager.getModel(e);t&&t.tileManager?t.tileManager.updateTileMeshForFlatten():t.updateTileMeshForFlatten()}))}};r.Walkthrough=class{constructor(e){this.name=e||"",this.keyFrameList=[],this.walkthroughTime=5,this.isFrameTimeMode=!1,this.interpolateType=0,this.fps=60,this.parts=100,this.rotateSpeed=Math.PI/this.fps/4,this.parameters={segments:this.walkthroughTime*this.fps*this.parts,closed:!1,curveType:"centripetal",tension:.25},this.modificationId=0,this.allocateSegmentList=null,this.frameTimeSegmentList=null}addKeyFrame(e){var t=new THREE.Vector3(e.position.x,e.position.y,e.position.z),i=new THREE.Vector3(e.target.x,e.target.y,e.target.z);const{id:r,name:a,timeBetweenFrames:n,stayTime:s}=e;this.keyFrameList.push({id:r,name:a,timeBetweenFrames:n,stayTime:s,position:t,target:i}),this.modificationId++}setKeyFrameList(e){this.keyFrameList=[];for(var t=0,i=e.length;t<i;t++)this.addKeyFrame(e[t])}removeKeyFrame(e){var t=this.keyFrameList.length;e>=0&&e<t&&(this.keyFrameList.splice(e,1),this.modificationId++)}checkFrameTimeMode(){return this.isFrameTimeMode=!1,this.keyFrameList.some((e=>{const{timeBetweenFrames:t,stayTime:i}=e;return isNaN(t)&&isNaN(i)||(this.isFrameTimeMode=!0),this.isFrameTimeMode})),this.isFrameTimeMode}getKeyFrames(){return this.keyFrameList}getKeyFrameCount(){return this.keyFrameList.length}clearFrames(){this.keyFrameList=[]}getJumpCounts(e){var t=e/(1e3/this.fps)*this.parts;return t=parseInt(t)}setWalkthroughTime(e){const t=Object.prototype.toString.call(e);"[object Array]"===t?e.forEach((e=>{if(void 0!==e.id){const t=this.keyFrameList.find((t=>t.id.toString()===e.id.toString()));t&&(t.timeBetweenFrames=e.timeBetweenFrames||0,t.stayTime=e.stayTime||0)}})):"[object Number]"===t&&(this.keyFrameList.forEach((e=>{delete e.timeBetweenFrames,delete e.stayTime})),this.walkthroughTime=e,this.setSegments(e*this.fps*this.parts)),this.modificationId++}setWalkthroughTimeByFrame(){let e=this.keyFrameList.length;this.allocateSegmentList=[],this.frameTimeSegmentList=[],this.keyFrameList.forEach(((t,i)=>{const{timeBetweenFrames:r,stayTime:a}=t,n={move:0,stay:0},s=i===e-1;isNaN(r)||s||(n.move=r*this.fps*this.parts),isNaN(a)||(n.stay=a*this.fps*this.parts),0===n.move&&(n.move=1),this.frameTimeSegmentList.push(n),s||this.allocateSegmentList.push(n.stay+n.move)})),this.allocateSegmentList.length&&this.setSegments(this.allocateSegmentList.reduce(((e,t)=>e+t)))}setInterpolateType(e){this.interpolateType=e,1==e&&this.setSplineTension(0)}getInterpolateType(){return this.interpolateType}setName(e){this.name=e}getName(){return this.name}getKeyFramePositions(){for(var e=[],t=0,i=this.keyFrameList.length;t<i;t++){var r=this.keyFrameList[t];e.push(r.position)}return e}getKeyFramePosition(e){return this.keyFrameList[e].position}getKeyFrameDirection(e){var t=this.keyFrameList[e];return t.target.clone().sub(t.position)}getKeyFrameTarget(e){return this.keyFrameList[e].target}allocateSegments(){if(this.checkFrameTimeMode())this.setWalkthroughTimeByFrame();else{for(var e=[],t=0,i=this.keyFrameList.length;t<i-1;t++){var r=this.keyFrameList[t].position,a=this.keyFrameList[t+1].position;e.push(a.clone().sub(r).length())}var n=0,s=0;for(i=e.length;s<i;s++)n+=e[s];var o=this.getSegments(),l=0;for(i=e.length;0!=n&&l<i;l++)e[l]/=n,e[l]*=this.getSegments(),e[l]=Math.floor(e[l]),o-=e[l];for(var d=0;d<o;d++)e[d]>0&&e[d]++;this.allocateSegmentList=e}}getAllocateSegmentCount(e){return null==this.allocateSegmentList&&this.allocateSegments(),this.allocateSegmentList[e]}getSplineParam(e,t){null==this.allocateSegmentList&&this.allocateSegments();var i=this.allocateSegmentList.length;return(e+t/this.allocateSegmentList[e])/i}calculateDeltaAngleCurrentKeyFrame(e,t,i,r){var a=this.allocateSegmentList,n=i.clone().sub(t),s=this.getKeyFrameDirection(e+1),o=n.angleTo(s);if(this.isFrameTimeMode){if(this.frameTimeSegmentList[e].stay>r)return 0}const l=a[e]-r;if(0==l){var d=Math.floor(o/this.rotateSpeed)*this.parts;return a[e]=d,o/d}return o/l}getRotateAxis(e){var t=this.getKeyFrameDirection(e),i=this.getKeyFrameDirection(e+1);return t.clone().cross(i.clone()).normalize()}getRotateAxisCurrentKeyFrame(e,t,i){var r=i.clone().sub(t),a=this.getKeyFrameDirection(e+1);return r.clone().cross(a.clone()).normalize()}calculateDeltaOffsetCurrentKeyFrame(e,t,i,r){var a=this.allocateSegmentList;if(this.isFrameTimeMode){if(this.frameTimeSegmentList[e].stay>r)return new THREE.Vector3}const n=a[e]-r;var s=t,o=this.getKeyFramePositions()[e+1];return 0==n?new THREE.Vector3:o.clone().sub(s).divideScalar(n)}setSplineTension(e){e>=0&&e<=1&&(this.parameters.tension=e,this.modificationId++)}setSegments(e){this.parameters.segments=e,this.modificationId++}getSegments(){return this.parameters.segments}setParameters(e){this.parameters=e,this.modificationId++}getParameters(){return this.parameters}setFps(e){this.fps=e,this.modificationId++}getModificationId(){return this.modificationId}};r.WalkthroughPlayer=class{constructor(e){this.viewer=e,this.walkthrough=null,this.bPause=!1,this.bContinue=!1,this.bStop=!1,this.spline=null,this.reqid=0,this.playBinded=this.play.bind(this),this.recordId=-1,this.keyFrameIdx=0,this.count=-1,this.camera=this.viewer.cameraControl.camera,this.pausePlayCallback=null,this.stopPlayCallback=null,this.timeRecorder={last:0,pause:0,deltaTime:0},this.keyFrameCallback=null}setWalkthrough(e){this.walkthrough=e,this.bPause=!1,this.recordId=-1,this.spline=null,this.keyFrameIdx=0,this.count=-1}updateCamera(e,t){this.camera.position.add(e),this.camera.target.addVectors(this.camera.position,t),this.camera.up.copy(new THREE.Vector3(0,1,0)),this.viewer.cameraControl._changeCallBack()}play(){this.viewer.cameraControl.lockPan=!0,this.reqid=requestAnimationFrame(this.playBinded),0==this.bContinue?(this.bContinue=!0,this.timeRecorder.deltaTime=this.timeRecorder.pause-this.timeRecorder.last):this.timeRecorder.deltaTime=performance.now()-this.timeRecorder.last,this.timeRecorder.last=performance.now();var e=this.walkthrough.getJumpCounts(this.timeRecorder.deltaTime);if(this.recordId!==this.walkthrough.getModificationId()&&(this.walkthrough.allocateSegments(),this.recordId=this.walkthrough.getModificationId()),this.bPause)return this.viewer.cameraControl.lockPan=!1,this.timeRecorder.pause=performance.now(),console.log("Walkthrough pause now,key frame index is "+this.keyFrameIdx),cancelAnimationFrame(this.reqid),this.pausePlayCallback&&this.pausePlayCallback(),this.bPause=!1,void(this.bContinue=!1);var t=this.walkthrough.getKeyFrameCount(),i=this.walkthrough.getAllocateSegmentCount(this.keyFrameIdx);if(0==i)this.keyFrameIdx++,1===this.keyFrameIdx?this.triggerKeyFrameCallback(0):this.triggerKeyFrameCallback(this.keyFrameIdx),this.count=-1;else{if(this.bStop||this.keyFrameIdx==t-1)return this.viewer.cameraControl.lockPan=!1,void this.stop(!0);if(-1==this.count){this.timeStart=performance.now(),this.triggerKeyFrameCallback(this.keyFrameIdx);var r=this.walkthrough.getKeyFramePosition(this.keyFrameIdx),a=this.walkthrough.getKeyFrameTarget(this.keyFrameIdx);this.camera.position.copy(r),this.camera.target.copy(a),this.count=0}else if(this.count<i){this.count+e>i&&(e=i-this.count);var n=this.walkthrough.calculateDeltaOffsetCurrentKeyFrame(this.keyFrameIdx,this.camera.position,this.camera.target.clone(),this.count),s=this.walkthrough.calculateDeltaAngleCurrentKeyFrame(this.keyFrameIdx,this.camera.position,this.camera.target.clone(),this.count),o=this.walkthrough.getRotateAxisCurrentKeyFrame(this.keyFrameIdx,this.camera.position,this.camera.target.clone()),l=new THREE.Vector3;l.subVectors(this.camera.target.clone(),this.camera.position),0==isNaN(o.length())&&l.applyAxisAngle(o,s*e),this.count+e==i?(this.keyFrameIdx++,this.triggerKeyFrameCallback(this.keyFrameIdx),this.count=0):this.count+=e,this.updateCamera(n.clone().multiplyScalar(e),l)}}this.viewer.cameraControl.setCameraChanging(!0),this.viewer.render()}pause(){this.bPause=!0,this.viewer.cameraControl.lockPan=!1}stop(e){e&&(this.viewer.cameraControl.lockPan=!1,this.bStop=!1,this.keyFrameIdx=0,this.count=-1,console.log("Time cost "+(performance.now()-this.timeStart)+"ms."),cancelAnimationFrame(this.reqid),this.stopPlayCallback&&this.stopPlayCallback())}startFrom(e){for(var t=this.walkthrough,i=t.getKeyFrameCount(),r=t.getKeyFrames(),a=0;a<i;a++)if(r[a].id==e)return this.keyFrameIdx=a,void(this.count=-1)}setKeyFrameCallback(e){this.keyFrameCallback=e}triggerKeyFrameCallback(e){this.keyFrameCallback&&this.keyFrameCallback(e)}addPausePlayCallback(e){this.pausePlayCallback=e}addStopPlayCallback(e){this.stopPlayCallback=e}updataSpline(){var e=this.walkthrough.getKeyFramePositions(),t=this.walkthrough.getParameters();this.spline=new THREE.CatmullRomCurve3(e,t.closed,t.curveType,t.tension)}};r.WalkthroughManager=class{constructor(){this.walkthroughList=[]}clear(){this.walkthroughList=[]}add(e){this.walkthroughList.push(e)}remove(e){for(var t=0,i=this.walkthroughList.length;t<i;t++){if(this.walkthroughList[t].getName()==e)return void this.walkthroughList.splice(t,1)}}save(){return JSON.stringify(this.walkthroughList)}load(e){this.clear();for(var t=JSON.parse(e),i=0,a=t.length;i<a;i++){var n=new r.Walkthrough;n.setName(t[i].name),n.setKeyFrameList(t[i].keyFrameList),n.setParameters(t[i].parameters),n.setWalkthroughTime(t[i].walkthroughTime),n.setInterpolateType(t[i].type),n.setFps(t[i].fps),this.add(n)}return this.walkthroughList}},function(){let e=new THREE.Matrix4;r.HeightLimitManager=class{constructor(e){this.viewer=e,this.renderTargetForLimitedColor=new THREE.WebGLRenderTarget(1024,1024,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter}),this.renderTargetForLimitedHeight=new THREE.WebGLRenderTarget(1024,1024,{minFilter:THREE.NearestFilter,magFilter:THREE.NearestFilter}),this.limitAnalyses={},this.limitAnalysesNumber=0,this.orthoCamera=null,this.orthoViewProjMatrix=new THREE.Matrix4,this.isDirty=!1,this.sceneForLimitedRegion=new THREE.Scene;var t=e.getScene().getRawMatrixGlobal();this.meshGroup=new r.ObjectGroup("limitedRegion"),this.meshGroup.matrix.copy(t),this.meshGroup.matrixAutoUpdate=!1,this.meshGroup.updateMatrixWorld(!0),this.sceneForLimitedRegion.add(this.meshGroup),this.modelIds={}}render(e){var t=e.clippingPlanes;if(e.clippingPlanes=[],this.renderer=e,0!=this.limitAnalysesNumber){if(this.isDirty){this._calcOrthoCamera(),this._changeMaterialMode(!0);var i=e.getRenderTarget();e.setRenderTarget(this.renderTargetForLimitedHeight),e.clear(),e.render(this.sceneForLimitedRegion,this.orthoCamera),this._changeMaterialMode(!1),e.setRenderTarget(this.renderTargetForLimitedColor),e.clear(),e.render(this.sceneForLimitedRegion,this.orthoCamera),e.setRenderTarget(i),this._updateMaterial(),this.isDirty=!1}e.clippingPlanes=t}else this.isDirty&&(this._updateMaterial(),this.isDirty=!1)}_changeMaterialMode(e){var t=this.meshGroup.children;if(e)for(var i=0;i<t.length;i++){(r=t[i].children[0].material).uniforms.useHeightLimit.value=!0,r.transparent=!1,r.needsUpdate=!0}else for(i=0;i<t.length;i++){var r;(r=t[i].children[0].material).uniforms.useHeightLimit.value=!1,r.transparent=!1,r.needsUpdate=!0}}_calcOrthoCamera(){var t=new THREE.Vector3(1/0,1/0,1/0),i=new THREE.Vector3(-1/0,-1/0,-1/0);for(var r in this.limitAnalyses)if(this.limitAnalyses[r].areaMesh.visible){var a=this.limitAnalyses[r]._getBox(),n=a.min,s=a.max;t.x=Math.min(n.x,t.x),t.y=Math.min(n.y,t.y),t.z=Math.min(n.z,t.z),i.x=Math.max(s.x,i.x),i.y=Math.max(s.y,i.y),i.z=Math.max(s.z,i.z)}var o=.5*(i.x-t.x),l=.5*(i.z-t.z),d=.5*(i.x+t.x),h=.5*(i.y+t.y),c=.5*(i.z+t.z),u=new THREE.Vector3(d,t.y-1,c),p=new THREE.Vector3(d,h+1,c);this.orthoCamera=new THREE.OrthographicCamera(-o,o,l,-l,-.1,i.y-t.y+2),this.orthoCamera.position.set(u.x,u.y,u.z),this.orthoCamera.lookAt(p),this.orthoCamera.updateMatrixWorld(!0),this.orthoViewProjMatrix=this.orthoCamera.projectionMatrix.clone(),e.copy(this.orthoCamera.matrixWorld).invert(),this.orthoViewProjMatrix.multiply(e)}setSize(e,t){}dispose(){this.clearLimitAnalyses(),null!=this.renderTargetForLimitedColor&&(this.renderTargetForLimitedColor.dispose(),this.renderTargetForLimitedColor=null),null!=this.renderTargetForLimitedHeight&&(this.renderTargetForLimitedHeight.dispose(),this.renderTargetForLimitedHeight=null),null!=this.sceneForLimitedRegion&&(this.sceneForLimitedRegion=null)}clearLimitAnalyses(){for(var e in this.limitAnalyses)delete this.limitAnalyses[e],this.isDirty=!0,this.limitAnalysesNumber--;this._updateModelIds()}addLimitAnalysis(e,t){this.limitAnalyses.hasOwnProperty(e)||(this.limitAnalyses[e]=t,this.isDirty=!0,this.limitAnalysesNumber++,t.areaMesh&&(this._initializePlaneMaterial(t.areaMesh,t._drawingHeight),this.meshGroup.add(t.areaMesh)),this._updateModelIds())}removeLimitAnalysisById(e){if(this.limitAnalyses.hasOwnProperty(e)){let t=this.meshGroup.children;for(let i=0;i<t.length;i++)if(t[i].name==e){this.meshGroup.remove(t[i]);break}delete this.limitAnalyses[e],this._updateModelIds(),this.limitAnalysesNumber--,this.isDirty=!0}}_updateMaterial(){this.viewer.modelManager.modelCollection.traverse((e=>{this.modelIds[e.id]&&(e.updateMaterialsValue("heightColorSampler",this.renderTargetForLimitedColor.texture),e.updateMaterialsValue("heightLimitSampler",this.renderTargetForLimitedHeight.texture),e.updateMaterialsValue("heightLimitOrthoMatrix",this.orthoViewProjMatrix))}))}_initializePlaneMaterial(e,t){var i=e.children[0];null!=i&&(i.material.defines.USE_COLORWITHOUTLIGHT="",i.material.defines.HEIGHT_LIMIT_WRITE="",i.material.heightLimit=t,i.material.refreshUniforms(),i.material.needsUpdate=!0)}_updatePlaneMaterial(e,t){var i=e.children[0];null!=i&&(i.material.heightLimit=t,i.material.uniforms.heightLimit.value=t)}update(e,t){let i=this.limitAnalyses[e];if(t){this._initializePlaneMaterial(i.areaMesh,i._drawingHeight);let t=this.meshGroup.children;for(let r=0;r<t.length;r++)t[r].name==e&&(t[r]=i.areaMesh,i.areaMesh.parent=this.meshGroup);i._updateBox(),this._updateModelIds()}else this._updatePlaneMaterial(i.areaMesh,i._drawingHeight);this.isDirty=!0}_updateModelIds(){let e={};for(let i in this.limitAnalyses){let r=this.limitAnalyses[i];if("global"==r.mode||!r._modelIds){this.viewer.modelManager.modelCollection.traverse((t=>{e[t.id]=!0}));break}for(var t=0;t<r._modelIds.length;t++)e[r._modelIds[t]]=!0}this.viewer.modelManager.modelCollection.traverse((t=>{this.modelIds[t.id]&&!e[t.id]&&(t.updateMaterialsValue("heightColorSampler",null),t.updateMaterialsValue("heightLimitSampler",null))})),this.modelIds=e}}}(),function(){let e=new THREE.Matrix4,t=new THREE.Vector3,i=new THREE.Vector3;class a extends THREE.Group{constructor(e){super();let t=this;t.disPickable=!0,t.autoAnimation=!1,t.view=e.viewer,null!=e.viewer.getViewer()&&(t.viewer=e.viewer.getViewer()),t.level=0,t.boundary=[],t.tileManager=null,t.worldBoxScratch=new THREE.Box3,t.tileBuilder=new r.Tile.PlaneTileBuilder,t.worldMatrixScratch=new THREE.Matrix4,t.inverseWorldMatrixScratch=new THREE.Matrix4,t.worldMatrixRestore=new THREE.Matrix4,t.pointVector3_a=new THREE.Vector3,t.pointVector3_b=new THREE.Vector3,t.pointVector3_c=new THREE.Vector3,t.lineStartScratch=new THREE.Vector2,t.lineEndScratch=new THREE.Vector2,t.worldCutPointData=[],t.worldFillPointData=[],t.worldFlatPointData=[],t.worldCutPlaneData=[],t.worldFillPlaneData=[],t.demTileList=[],t.detailWorldCutPointData=[],t.detailWorldFillPointData=[],t.detailWorldFlatPointData=[],t.totalArea=0,t.cutArea=0,t.fillArea=0,t.cutVolume=0,t.fillVolume=0,t.totalSuperficialArea=0,t.setOpts(e),t._getDemTileManager(),(!t.layerIds&&null!=t.tileManager||t.layerIds)&&t.updateCutFillVolume(),this.renderOrder=r.EnumRenderOrder.WireFrame,t.show()}updateCutFillVolume(){let e=this;e.clearGriddingMesh(),e.pointsBoundary=[],e.worldPointsBoundary=[],e.worldCutPointData=[],e.worldFillPointData=[],e.worldFlatPointData=[],e.demTileList=[],e.newIndexCut=[],e.newIndexFill=[],e.newIndexGround=[],e.newPositionsCut=[],e.newPositionsFill=[],e.newPositionsGround=[],e.cutFillHeight={max:-1/0,min:1/0},e.modelAltitude=0,e.tileManager&&(e.modelAltitude=e.tileManager.modelAltitude*r.Tile.TileMath.unitScale),0==e.viewer.gisMode&&(e.modelAltitude*=-1);for(var t=0;t<e.boundary.length;t++){e.pointsBoundary.push(new THREE.Vector2(e.boundary[t].x,e.boundary[t].z));var i=e.viewer.drawingToWorld(e.boundary[t]);e.worldPointsBoundary.push(i)}e._initBoundingBox(),e._checkTileMeshBox(),e.cutFillHeight.max===-1/0&&e.cutFillHeight.min===1/0||(e._showVisualization(),e._setTotalArea(),e._setVolume(),e._setSuperficialArea())}updateCutFillVolumeData(e){const t=this;t.worldCutPointData=[],t.worldFillPointData=[],t.worldFlatPointData=[],t._collectPointData(e)}_setSuperficialArea(){let e=this;e.totalSuperficialArea=0;for(let t=0;t<e.newIndexCut.length;t+=3){const i=[0,1,2].map((i=>e.newIndexCut[t+i])).map((t=>new THREE.Vector3(e.newPositionsCut[3*t+0],e.newPositionsCut[3*t+1],e.newPositionsCut[3*t+2]))),r=e.computeAreaOfTriangle(i[0],i[1],i[2],!1);e.totalSuperficialArea+=r}for(let t=0;t<e.newIndexFill.length;t+=3){const i=[0,1,2].map((i=>e.newIndexFill[t+i])).map((t=>new THREE.Vector3(e.newPositionsFill[3*t+0],e.newPositionsFill[3*t+1],e.newPositionsFill[3*t+2]))),r=e.computeAreaOfTriangle(i[0],i[1],i[2],!1);e.totalSuperficialArea+=r}for(let t=0;t<e.newIndexGround.length;t+=3){const i=[0,1,2].map((i=>e.newIndexGround[t+i])).map((t=>new THREE.Vector3(e.newPositionsGround[3*t+0],e.newPositionsGround[3*t+1],e.newPositionsGround[3*t+2]))),r=e.computeAreaOfTriangle(i[0],i[1],i[2],!1);e.totalSuperficialArea+=r}if(0==e.totalSuperficialArea&&0==e.totalSuperficialArea&&0==e.totalSuperficialArea){let t=e._calcSpatialArea();e.totalSuperficialArea=t/r.Tile.TileMath.unitScale/r.Tile.TileMath.unitScale}else e.totalSuperficialArea=e.totalSuperficialArea/r.Tile.TileMath.unitScale/r.Tile.TileMath.unitScale}_calcSpatialArea(){var e=this;const r=e.worldPointsBoundary.length;if(r<3)return 0;let a=0,n=new THREE.Triangle;for(let s=2;s<r;s++){let r=n.clone().set(e.worldPointsBoundary[s-1],e.worldPointsBoundary[s],e.worldPointsBoundary[0]),o=r.getArea();if(s>2){let a=n.getNormal(t),l=r.getNormal(i),d=a.angleTo(l);if((Math.abs(d-3.1415)<2e-4||Math.abs(d)<2e-4)&&(n.containsPoint(e.worldPointsBoundary[s])||r.containsPoint(e.worldPointsBoundary[s-2]))){let e=n.getArea();o=Math.abs(o-e)-e}}a+=o,n.copy(r)}return a}_setTotalArea(){let e=this;e.totalArea=0,e.cutArea=0,e.worldCutPlaneData=[],e.fillArea=0,e.worldFillPlaneData=[];for(let t=0;t<e.newIndexCut.length;t+=3){const i=[0,1,2].map((i=>e.newIndexCut[t+i])).map((t=>new THREE.Vector3(e.newPositionsCut[3*t+0],e.newPositionsCut[3*t+1],e.newPositionsCut[3*t+2]))),r=e.computeAreaOfTriangle(i[0],i[1],i[2]);e.worldCutPlaneData.push(r),e.cutArea+=r}for(let t=0;t<e.newIndexFill.length;t+=3){const i=[0,1,2].map((i=>e.newIndexFill[t+i])).map((t=>new THREE.Vector3(e.newPositionsFill[3*t+0],e.newPositionsFill[3*t+1],e.newPositionsFill[3*t+2]))),r=e.computeAreaOfTriangle(i[0],i[1],i[2]);e.worldFillPlaneData.push(r),e.fillArea+=r}let t=0;for(let i=0;i<e.newIndexGround.length;i+=3){const r=[0,1,2].map((t=>e.newIndexGround[i+t])).map((t=>new THREE.Vector3(e.newPositionsGround[3*t+0],e.newPositionsGround[3*t+1],e.newPositionsGround[3*t+2])));t+=e.computeAreaOfTriangle(r[0],r[1],r[2])}e.totalArea=e.cutArea+e.fillArea+t,e.cutArea=e.cutArea/r.Tile.TileMath.unitScale/r.Tile.TileMath.unitScale,e.fillArea=e.fillArea/r.Tile.TileMath.unitScale/r.Tile.TileMath.unitScale,e.totalArea=e.totalArea/r.Tile.TileMath.unitScale/r.Tile.TileMath.unitScale}_setVolume(){let e=this;e.cutVolume=0,e.fillVolume=0;for(let t=0;t<e.newIndexCut.length;t+=3){const i=[0,1,2].map((i=>e.newIndexCut[t+i])).map((t=>new THREE.Vector3(e.newPositionsCut[3*t+0],e.newPositionsCut[3*t+1],e.newPositionsCut[3*t+2]))),r=e.worldCutPlaneData[t/3]*(i[0].z-e._level-e.modelAltitude+i[1].z-e._level-e.modelAltitude+i[2].z-e._level-e.modelAltitude)/3;e.cutVolume+=r}for(var t=0;t<e.newIndexFill.length;t+=3){const r=[0,1,2].map((i=>e.newIndexFill[t+i])).map((t=>new THREE.Vector3(e.newPositionsFill[3*t+0],e.newPositionsFill[3*t+1],e.newPositionsFill[3*t+2])));var i=e.worldFillPlaneData[t/3]*(e._level+e.modelAltitude-r[0].z+e._level+e.modelAltitude-r[1].z+e._level+e.modelAltitude-r[2].z)/3;e.fillVolume+=i}e.cutVolume=e.cutVolume/r.Tile.TileMath.unitScale/r.Tile.TileMath.unitScale/r.Tile.TileMath.unitScale,e.fillVolume=e.fillVolume/r.Tile.TileMath.unitScale/r.Tile.TileMath.unitScale/r.Tile.TileMath.unitScale}_initBoundingBox(){let e=this;e.boundingBox=new THREE.Box3,e.pointsBoundary.forEach((t=>e.boundingBox.expandByPoint(new THREE.Vector3(t.x,0,t.y))))}_checkTileMeshBox(){let e=this;if(e.layerIds){let t=[];for(let i of e.layerIds){const r=e.view.getLayerManager().getLayer(i),a=r.customId||r.modelId,n=r.model.getCloudViewer().getModelManager().getModel(a),s=n._tileset,o=n.viewer.getScene().getInverseMatrixGlobal();s.traverseContentAvailableNode((e=>{e._content._meshes.traverse((e=>{if("MeshEx"!==e.type||!e.visible)return;const i=o.clone().multiply(e.matrixWorld),r=[...e.geometry.attributes.position.array],a=[...e.geometry.index.array];for(let e=0,n=a.length;e<n;e++){const n=r[3*a[e]+0],s=r[3*a[e]+1],o=r[3*a[e]+2],l=new THREE.Vector3(n,s,o);l.applyMatrix4(i),t.push(l)}}))}))}t=t.filter((t=>{let i=!1;const r=e.worldPointsBoundary;for(let e=0,a=r.length-1;e<r.length;a=e++)r[e].y>t.y!=r[a].y>t.y&&t.x<(r[a].x-r[e].x)*(t.y-r[e].y)/(r[a].y-r[e].y)+r[e].x&&(i=!i);return i}));let i={},a=[],n=new THREE.Box3;t.forEach((e=>n.expandByPoint(e)));for(let e=0,r=t.length;e<r;e++){let r=t[e];const a=21*Math.floor(20*r.clone().sub(n.min).x/(n.max.x-n.min.x))+Math.floor(20*r.clone().sub(n.min).y/(n.max.y-n.min.y));!i[a]&&(i[a]=[]),i[a].push(e)}for(let e in i){i[e].sort((()=>.5-Math.random())),i[e].length>5&&(i[e]=i[e].slice(0,5));for(let r=0,n=i[e].length;r<n;r++)a.push(t[i[e][r]])}t=a;for(let i=0,r=e.worldPointsBoundary.length;i<r;i++){const r=e.worldPointsBoundary[i],a=e.worldPointsBoundary[(i+1)%e.worldPointsBoundary.length];for(let i=0;i<1;i+=.05){let n=r.clone().add(a.clone().sub(r).multiplyScalar(i));n.z=void 0;for(let t of e.layerIds){const i=e.view.getLayerManager().getLayer(t),r=i.model,a=i.modelId,s=r.getCloudViewer().getModelManager().getModel(a).rayCastVertical(n);s&&(!n.z||s.z>n.z)&&(n=s)}n.z&&t.push(n)}}t.forEach((t=>{e.cutFillHeight.max=Math.max(e.cutFillHeight.max,t.z),e.cutFillHeight.min=Math.min(e.cutFillHeight.min,t.z)}));let s=t.map((e=>[e.x,e.y])),o=r.Utils.delaunay(s),l=[];t.forEach((e=>{l.push(e.x),l.push(e.y),l.push(e.z)}));for(let t=0,i=o.length;t<i;t+=3){const i=o[t+0],r=o[t+1],a=o[t+2],n=new THREE.Vector3(l[3*i+0],l[3*i+1],l[3*i+2]),s=new THREE.Vector3(l[3*r+0],l[3*r+1],l[3*r+2]),d=new THREE.Vector3(l[3*a+0],l[3*a+1],l[3*a+2]),h=(e.level-n.z)/(s.z-n.z),c=(e.level-s.z)/(d.z-s.z),u=(e.level-d.z)/(n.z-d.z);if(h>0&&h<1&&c>0&&c<1){const e=n.clone().add(s.clone().sub(n).multiplyScalar(h)),r=s.clone().add(d.clone().sub(s).multiplyScalar(c));l=l.concat([e.x,e.y,e.z,r.x,r.y,r.z]);const u=l.length/3-2;o[t+0]=u+0,o[t+2]=u+1,o=o.concat([i,u+0,u+1,i,u+1,a])}else if(h>0&&h<1&&u>0&&u<1){const e=n.clone().add(s.clone().sub(n).multiplyScalar(h)),i=d.clone().add(n.clone().sub(d).multiplyScalar(u));l=l.concat([e.x,e.y,e.z,i.x,i.y,i.z]);const c=l.length/3-2;o[t+1]=c+0,o[t+2]=c+1,o=o.concat([c+0,r,a,c+1,c+0,a])}else if(c>0&&c<1&&u>0&&u<1){const e=s.clone().add(d.clone().sub(s).multiplyScalar(c)),a=d.clone().add(n.clone().sub(d).multiplyScalar(u));l=l.concat([e.x,e.y,e.z,a.x,a.y,a.z]);const h=l.length/3-2;o[t+0]=h+1,o[t+1]=h+0,o=o.concat([i,r,h+1,h+1,r,h+0])}}e.newPositionsCut=l,e.newPositionsFill=l,e.newPositionsGround=l;for(let t=0,i=o.length;t<i;t+=3){const i=[0,1,2].map((e=>o[t+e])),r=i.map((e=>new THREE.Vector3(l[3*e+0],l[3*e+1],l[3*e+2])));let a=!1,n=!1;r.forEach((t=>{a=a||t.z>e.level+.01,n=n||t.z<e.level-.01})),a&&n?e.newIndexGround=e.newIndexGround.concat(i):a?e.newIndexCut=e.newIndexCut.concat(i):e.newIndexFill=e.newIndexFill.concat(i)}}else if(null!=e.tileManager.globeLayer)for(var t=e.tileManager.globeLayer._tileset.getTileMesh(),i=0;i<t.length;i++){if((c=t[i]).content&&c.content.meshes&&c.boundingBox){var a=c.content.meshes;if(a.children.length>0&&a.visible){var n=a.children[0],s=c._tileset._objectGroup.matrix;if(e.worldBoxScratch.copy(c.boundingBox),e.worldBoxScratch.applyMatrix4(s),e.worldBoxScratch.min.y=e.worldBoxScratch.max.y=0,e.boundingBox.intersectsBox(e.worldBoxScratch)){e.worldMatrixScratch.multiplyMatrices(s,n.matrix),e.inverseWorldMatrixScratch.copy(e.worldMatrixScratch).invert(),e.setMyPointsBoundary();const t={geometry:n.geometry,demTile:c,posX:0,posY:0,matrixWorld:s,tileMatrixWorld:e.worldMatrixScratch.clone(),tileMeshMatrix:n.matrix};e.demTileList.push(t),e._createTileGeometry(n.geometry,0,0,e.worldMatrixScratch)}}}}else if(null!=e.tileManager.globalLayer){var o=e.tileManager.globalLayer;for(var l in o)for(var d in o[l])for(var h in o[l][d]){var c;if(o[l][d][h])(c=o[l][d][h]).box&&c.terrainData&&(e.worldBoxScratch.copy(c.box),e.worldBoxScratch.min.y=e.worldBoxScratch.max.y=0,e.boundingBox.intersectsBox(e.worldBoxScratch)&&e._checkTileGeometryTriangular(c))}}}_showVisualization(){var e=this;if(e.showVisualization){null==e.wallWireframeGeometry&&(e.wallWireframeGeometry=new THREE.BufferGeometry),null==e.blGeometry&&(e.blGeometry=new THREE.BufferGeometry),null==e.bpGeometry&&(e.bpGeometry=new THREE.BufferGeometry),null==e.wallGeometry1&&(e.wallGeometry1=new THREE.BufferGeometry),null==e.wallGeometry2&&(e.wallGeometry2=new THREE.BufferGeometry);const u=[],p=[],m=[],f=[],g=[],v=[];let y=[],M=e.worldPointsBoundary.length;for(var t=0;t<M;t++)if(y.push(new THREE.Vector2(e.worldPointsBoundary[t].x,e.worldPointsBoundary[t].y)),p.push(new THREE.Vector3(e.worldPointsBoundary[t].x,e.worldPointsBoundary[t].y,e.cutFillHeight.min),new THREE.Vector3(e.worldPointsBoundary[t].x,e.worldPointsBoundary[t].y,e.cutFillHeight.max)),m.push(e.worldPointsBoundary[t].x,e.worldPointsBoundary[t].y,e.cutFillHeight.min,e.worldPointsBoundary[t].x,e.worldPointsBoundary[t].y,e._level+e.modelAltitude),f.push(e.worldPointsBoundary[t].x,e.worldPointsBoundary[t].y,e.cutFillHeight.max,e.worldPointsBoundary[t].x,e.worldPointsBoundary[t].y,e._level+e.modelAltitude),t<M-1){u.push(new THREE.Vector3(e.worldPointsBoundary[t].x,e.worldPointsBoundary[t].y,e._level+e.modelAltitude),new THREE.Vector3(e.worldPointsBoundary[t+1].x,e.worldPointsBoundary[t+1].y,e._level+e.modelAltitude)),p.push(new THREE.Vector3(e.worldPointsBoundary[t+1].x,e.worldPointsBoundary[t+1].y,e.cutFillHeight.max),new THREE.Vector3(e.worldPointsBoundary[t+1].x,e.worldPointsBoundary[t+1].y,e.cutFillHeight.min),new THREE.Vector3(e.worldPointsBoundary[t].x,e.worldPointsBoundary[t].y,e.cutFillHeight.min));var i=2*t;g.push(i,i+1,i+3,i,i+2,i+3),v.push(i,i+1,i+3,i,i+2,i+3)}else{u.push(new THREE.Vector3(e.worldPointsBoundary[t].x,e.worldPointsBoundary[t].y,e._level+e.modelAltitude),new THREE.Vector3(e.worldPointsBoundary[0].x,e.worldPointsBoundary[0].y,e._level+e.modelAltitude)),p.push(new THREE.Vector3(e.worldPointsBoundary[0].x,e.worldPointsBoundary[0].y,e.cutFillHeight.max),new THREE.Vector3(e.worldPointsBoundary[0].x,e.worldPointsBoundary[0].y,e.cutFillHeight.min),new THREE.Vector3(e.worldPointsBoundary[t].x,e.worldPointsBoundary[t].y,e.cutFillHeight.min));i=2*t;g.push(i,i+1,1,i,0,1),g.push(i,i+1,1,i,0,1)}const E=new THREE.ShapeGeometry(new THREE.Shape(y)),b=E.attributes.position,I=b.count;for(let t=0;t<I;t++){const i=3*t+2;b.array[i]=e._level+e.modelAltitude}if(e.wallWireframeGeometry.setFromPoints(p),e.blGeometry.setFromPoints(u),e.wallGeometry1.setIndex(g),e.wallGeometry1.setAttribute("position",new THREE.Float32BufferAttribute(m,3)),e.wallGeometry2.setIndex(v),e.wallGeometry2.setAttribute("position",new THREE.Float32BufferAttribute(f,3)),e.bpGeometry.setAttribute("position",E.attributes.position),e.bpGeometry.index=E.index,null===e.wallGeometry1.boundingSphere&&e.wallGeometry1.computeBoundingSphere(),null===e.wallGeometry2.boundingSphere&&e.wallGeometry2.computeBoundingSphere(),null===e.wallWireframeGeometry.boundingSphere&&e.wallWireframeGeometry.computeBoundingSphere(),null===e.blGeometry.boundingSphere&&e.blGeometry.computeBoundingSphere(),null===e.bpGeometry.boundingSphere&&e.bpGeometry.computeBoundingSphere(),null==e.wallMesh1){var a=new THREE.MeshBasicMaterial({side:THREE.DoubleSide,depthTest:!0,transparent:!0,depthWrite:!1,wireframe:!1,color:new THREE.Color("#32D3A6"),opacity:.4,blending:THREE.NormalBlending});e.wallMesh1=new THREE.Mesh(e.wallGeometry1,a),e.wallMesh1.renderOrder=r.EnumRenderOrder.Effect,e.add(e.wallMesh1)}if(null==e.wallMesh2){var n=new THREE.MeshBasicMaterial({side:THREE.DoubleSide,depthTest:!0,transparent:!0,depthWrite:!1,wireframe:!1,color:new THREE.Color("#32D3A6"),opacity:.15,blending:THREE.NormalBlending});e.wallMesh2=new THREE.Mesh(e.wallGeometry2,n),e.wallMesh2.renderOrder=r.EnumRenderOrder.Effect,e.add(e.wallMesh2)}if(null==e.wallWireframeMesh){var s=new THREE.LineBasicMaterial({depthTest:!0,transparent:!1,depthWrite:!1,color:new THREE.Color("#00825E")});e.wallWireframeMesh=new THREE.Line(e.wallWireframeGeometry,s),e.wallWireframeMesh.renderOrder=r.EnumRenderOrder.Effect,e.add(e.wallWireframeMesh)}if(null==e.blMesh){var o=new THREE.LineBasicMaterial({depthTest:!0,transparent:!1,depthWrite:!1,color:new THREE.Color("#32D3A6"),linewidth:4,opacity:1});e.blMesh=new THREE.Line(e.blGeometry,o),e.blMesh.renderOrder=r.EnumRenderOrder.Effect,e.add(e.blMesh)}if(null==e.bpMesh&&r.GlobalData.EnableLogarithmicDepthBuffer){var l=new THREE.MeshBasicMaterial({side:THREE.DoubleSide,depthTest:!0,transparent:!0,depthWrite:!1,wireframe:!1,color:new THREE.Color("#32D3A6"),opacity:.4});e.bpMesh=new THREE.Mesh(e.bpGeometry,l),e.bpMesh.renderOrder=r.EnumRenderOrder.Effect,e.add(e.bpMesh)}null==e.cutMaterial&&(e.cutMaterial=new r.CutFillMaterial({color:new THREE.Color("#E82C2C"),opacity:1}));var d=new THREE.BufferGeometry;d.setIndex(new THREE.Uint32BufferAttribute(e.newIndexCut,1)),d.setAttribute("position",new THREE.Float32BufferAttribute(e.newPositionsCut,3)),e.cutMesh=new THREE.Mesh(d,e.cutMaterial),e.add(e.cutMesh),null==e.fillMaterial&&(e.fillMaterial=new r.CutFillMaterial({color:new THREE.Color("#FF9D0B"),opacity:1}));var h=new THREE.BufferGeometry;h.setIndex(new THREE.Uint32BufferAttribute(e.newIndexFill,1)),h.setAttribute("position",new THREE.Float32BufferAttribute(e.newPositionsFill,3)),e.fillMesh=new THREE.Mesh(h,e.fillMaterial),e.add(e.fillMesh),null==e.groundMaterial&&(e.groundMaterial=new r.CutFillMaterial({color:new THREE.Color("#32D3A6"),opacity:1}));var c=new THREE.BufferGeometry;c.setIndex(new THREE.Uint32BufferAttribute(e.newIndexGround,1)),c.setAttribute("position",new THREE.Float32BufferAttribute(e.newPositionsGround,3)),e.groundMesh=new THREE.Mesh(c,e.groundMaterial),e.add(e.groundMesh),e.updateMatrixWorld()}}_requestTerrainData(e,t,i,r){const a=e.getTerrainUrl(t,i,r);return new Promise(((n,s)=>{e.loadArrayBufferImmediately(a,(a=>{n({terrainData:e.getTerrainDataArray(a),x:t,y:i,level:r})}))}))}_requestTerrainDataByTileManager(e,t,i,r){return new Promise(((a,n)=>{e.getTerrainData(t,i,r,(e=>{a({terrainData:e,x:t,y:i,level:r})}))}))}_praseDemPointData(t,i,r,a,n){const s=this,[o,l,d]=s.tileBuilder.getTileGeometryTriangular(s,n,t);s.worldMatrixRestore.makeTranslation(i,r,0),s.worldMatrixRestore.multiplyMatrices(a,s.worldMatrixRestore);const h=s.viewer.getScene().getMatrixGlobal();e.copy(h).invert();for(let t=0;t<l.length;t+=3)s.pointVector3_a.set(l[t],l[t+1],l[t+2]),s.pointVector3_a.applyMatrix4(s.worldMatrixRestore),s.pointVector3_a.applyMatrix4(e),s.worldCutPointData.push(s.pointVector3_a.clone());for(let t=0;t<o.length;t+=3)s.pointVector3_a.set(o[t],o[t+1],o[t+2]),s.pointVector3_a.applyMatrix4(s.worldMatrixRestore),s.pointVector3_a.applyMatrix4(e),s.worldFillPointData.push(s.pointVector3_a.clone());for(let t=0;t<d.length;t+=3)s.pointVector3_a.set(d[t],d[t+1],d[t+2]),s.pointVector3_a.applyMatrix4(s.worldMatrixRestore),s.pointVector3_a.applyMatrix4(e),s.worldFlatPointData.push(s.pointVector3_a.clone())}_cutDemData(e,t,i,r,a,n){const s=t.x,o=t.y,l=1<<14-t.level,d=[];for(let t=s*l;t<(s+1)*l;++t)for(let i=o*l;i<(o+1)*l;++i)d.push(this._requestTerrainData(e,t,i,14));Promise.all(d).then((t=>{t.map((t=>{t.tileTerrain={terrainData:t.terrainData},t.updateTerrainHeight=()=>{};const n=e.getTileGeometry(t),s=n.geometry;this.worldMatrixScratch.multiplyMatrices(a,n.matrix),this.inverseWorldMatrixScratch.copy(this.worldMatrixScratch).invert(),this.setMyPointsBoundary(),this._praseDemPointData(s,i,r,a,this.worldMatrixScratch.clone())})),n&&n()}))}_cutDemData2(e,t,i,a){const n=t.x,s=t.y,o=1<<14-t.zoom,l=[];for(let t=n*o;t<(n+1)*o;++t)for(let i=s*o;i<(s+1)*o;++i)l.push(this._requestTerrainDataByTileManager(e,t,i,14));Promise.all(l).then((t=>{t.map((t=>{const a=e.mercatorPerimeter/Math.pow(2,t.level)*r.Tile.TileMath.unitScale*2;let n=e.createTerrainGeometry(t.level,e.seg,a,t.x,t.y,t.terrainData,!0)[0];const s=e.mercatorPerimeter/Math.pow(2,e.maxZoom)*r.Tile.TileMath.unitScale*2,o=(t.x*Math.pow(2,e.maxZoom-t.level)-e.modelTileX)*s+Math.pow(2,e.maxZoom-t.level)/2*s,l=-(t.y*Math.pow(2,e.maxZoom-t.level)-e.modelTileY)*s-Math.pow(2,e.maxZoom-t.level)/2*s,d=(new THREE.Matrix4).makeTranslation(o,l,0);this.worldMatrixScratch.multiplyMatrices(i,d),this.inverseWorldMatrixScratch.copy(this.worldMatrixScratch).invert(),this.setMyPointsBoundary(),this._praseDemPointData(n,o,l,i,this.worldMatrixScratch.clone())})),a&&a()}))}_collectPointData(e){const t=this;let i=(e,i)=>{if(e<=0){t._setTotalArea(),t._setVolume(),t._setSuperficialArea();const e={level:t.level,totalArea:t.totalArea,cutArea:t.cutArea,cutVolume:t.cutVolume,fillArea:t.fillArea,fillVolume:t.fillVolume};i&&i(e)}},r=t.demTileList.length;if(0!==r)t.demTileList.map((a=>{if(void 0!==t.tileManager.tileProvider){const n=t.tileManager.tileProvider.terrainProvider,{geometry:s,demTile:o,posX:l,posY:d,matrixWorld:h,tileMatrixWorld:c,tileMeshMatrix:u}=a;if(o.level<14)return void this._cutDemData(n,o,l,d,h,(()=>{r--,i(r,e)}));t.worldMatrixScratch.multiplyMatrices(h,u),t.inverseWorldMatrixScratch.copy(t.worldMatrixScratch).invert(),t.setMyPointsBoundary(),this._praseDemPointData(s,l,d,h,c),r--,i(r,e)}else if(void 0!==t.tileManager.globalLayer){const{geometry:n,demTile:s,posX:o,posY:l,matrixWorld:d,tileMatrixWorld:h,tileMeshMatrix:c}=a;if(s.zoom<14)return void this._cutDemData2(t.tileManager,s,d,(()=>{r--,i(r,e)}));t.worldMatrixScratch.multiplyMatrices(d,c),t.inverseWorldMatrixScratch.copy(t.worldMatrixScratch).invert(),t.setMyPointsBoundary(),n.translate(-o,-l,0),this._praseDemPointData(n,o,l,d,h),n.translate(o,l,0),r--,i(r,e)}}));else{const i={level:t.level,totalArea:t.totalArea,cutArea:t.cutArea,cutVolume:t.cutVolume,fillArea:t.fillArea,fillVolume:t.fillVolume};e&&e(i)}}_createTileGeometry(t,i,r,a){var n=this,[s,o,l]=n.tileBuilder.getTileGeometryTriangular(n,n.worldMatrixScratch,t);n.worldMatrixRestore.makeTranslation(i,r,0),n.worldMatrixRestore.multiplyMatrices(a,n.worldMatrixRestore);var d=n.viewer.getScene().getMatrixGlobal();e.copy(d).invert();for(var h=n.newIndexCut.length,c=0;c<o.length;c+=3)n.newIndexCut.push(h+c/3),n.pointVector3_a.set(o[c],o[c+1],o[c+2]),n.pointVector3_a.applyMatrix4(n.worldMatrixRestore),n.pointVector3_a.applyMatrix4(e),n.newPositionsCut.push(n.pointVector3_a.x,n.pointVector3_a.y,n.pointVector3_a.z),n.worldCutPointData.push(n.pointVector3_a.clone()),n.cutFillHeight.max=Math.max(n.pointVector3_a.z,n.cutFillHeight.max),n.cutFillHeight.min=Math.min(n.pointVector3_a.z,n.cutFillHeight.min);var u=n.newIndexFill.length;for(c=0;c<s.length;c+=3)n.newIndexFill.push(u+c/3),n.pointVector3_a.set(s[c],s[c+1],s[c+2]),n.pointVector3_a.applyMatrix4(n.worldMatrixRestore),n.pointVector3_a.applyMatrix4(e),n.newPositionsFill.push(n.pointVector3_a.x,n.pointVector3_a.y,n.pointVector3_a.z),n.worldFillPointData.push(n.pointVector3_a.clone()),n.cutFillHeight.max=Math.max(n.pointVector3_a.z,n.cutFillHeight.max),n.cutFillHeight.min=Math.min(n.pointVector3_a.z,n.cutFillHeight.min);var p=n.newIndexGround.length;for(c=0;c<l.length;c+=3)n.newIndexGround.push(p+c/3),n.pointVector3_a.set(l[c],l[c+1],l[c+2]),n.pointVector3_a.applyMatrix4(n.worldMatrixRestore),n.pointVector3_a.applyMatrix4(e),n.newPositionsGround.push(n.pointVector3_a.x,n.pointVector3_a.y,n.pointVector3_a.z),n.worldFlatPointData.push(n.pointVector3_a.clone()),n.cutFillHeight.max=Math.max(n.pointVector3_a.z,n.cutFillHeight.max),n.cutFillHeight.min=Math.min(n.pointVector3_a.z,n.cutFillHeight.min)}_checkTileGeometryTriangular(e){var t=this;if(e.box&&e.terrainData){var i=e.x,a=e.y,n=e.zoom,s=t.tileManager.mercatorPerimeter/Math.pow(2,t.tileManager.maxZoom)*r.Tile.TileMath.unitScale*2,o=(i*Math.pow(2,t.tileManager.maxZoom-n)-t.tileManager.modelTileX)*s+Math.pow(2,t.tileManager.maxZoom-n)/2*s,l=-(a*Math.pow(2,t.tileManager.maxZoom-n)-t.tileManager.modelTileY)*s-Math.pow(2,t.tileManager.maxZoom-n)/2*s;t.worldMatrixScratch.makeTranslation(o,l,0),t.worldMatrixScratch.multiplyMatrices(t.tileManager.earthMatrix,t.worldMatrixScratch),t.inverseWorldMatrixScratch.copy(t.worldMatrixScratch).invert(),t.setMyPointsBoundary(),e.geometry.translate(-o,-l,0);const d={geometry:e.geometry,demTile:e,posX:o,posY:l,matrixWorld:t.tileManager.earthMatrix,tileMatrixWorld:t.worldMatrixScratch.clone(),tileMeshMatrix:(new THREE.Matrix4).makeTranslation(o,l,0)};t.demTileList.push(d),t._createTileGeometry(e.geometry,o,l,t.tileManager.earthMatrix),e.geometry.translate(o,l,0)}}setMyPointsBoundary(){let e=this;e.myPointsBoundary=[];for(var t=0;t<e.pointsBoundary.length;t++)e.pointVector3_a.set(e.pointsBoundary[t].x,0,e.pointsBoundary[t].y),e.pointVector3_a.applyMatrix4(e.inverseWorldMatrixScratch),e.myPointsBoundary.push(new THREE.Vector2(e.pointVector3_a.x,e.pointVector3_a.y))}getIntersectPos(e,t){var i=this,a=[];i.lineStartScratch.set(e.x,e.y);for(var n=0;n<t.length;n++){i.lineEndScratch.set(t[n].x,t[n].y);var s=r.Utils.linePolygonIntersection2(i.lineStartScratch,i.lineEndScratch,i.myPointsBoundary);null!=s&&a.push(s)}for(n=0;n<a.length;n++){var o=t[n].x-e.x,l=t[n].y-e.y,d=Math.sqrt(o*o+l*l),h=a[n].x-e.x,c=a[n].y-e.y,u=Math.sqrt(h*h+c*c);a[n].z=e.z+u/d*(t[n].z-e.z)}if(a.length>2&&a[0].index!=a[1].index){var p=a[0].index>a[1].index?a[0].index:a[1].index;Math.abs(a[0].index-a[1].index)>1&&(0==a[0].index||0==a[1].index)&&(p=0),a[0].point={x:i.myPointsBoundary[p].x,y:i.myPointsBoundary[p].y,z:(a[0].z+a[1].z)/2}}return a}isInRegionDrawing(e){return r.Utils.pointInPolygon({x:e.x,y:e.z},this.pointsBoundary)}_getDemTileManager(){let e=this;null==e.tileManager&&e.viewer.modelManager.modelCollection.traverse((t=>{t.isDemLayer&&(e.tileManager=t.tileManager)}))}computeAreaOfTriangle(e,t,i,r=!0){var a=this;r?(a.pointVector3_a.set(e.x,e.y,0),a.pointVector3_b.set(t.x,t.y,0),a.pointVector3_c.set(i.x,i.y,0)):(a.pointVector3_a.set(e.x,e.y,e.z),a.pointVector3_b.set(t.x,t.y,t.z),a.pointVector3_c.set(i.x,i.y,i.z));var n=Math.sqrt(a.pointVector3_a.distanceToSquared(a.pointVector3_b)),s=Math.sqrt(a.pointVector3_b.distanceToSquared(a.pointVector3_c)),o=Math.sqrt(a.pointVector3_c.distanceToSquared(a.pointVector3_a)),l=(n+s+o)/2;return Math.sqrt(l*(l-n)*(l-s)*(l-o))}clearGriddingMesh(){var e=this;null!=e.cutMesh&&(e.remove(e.cutMesh),e.cutMesh.geometry.dispose(),e.cutMesh=null),null!=e.fillMesh&&(e.remove(e.fillMesh),e.fillMesh.geometry.dispose(),e.fillMesh=null),null!=e.groundMesh&&(e.remove(e.groundMesh),e.groundMesh.geometry.dispose(),e.groundMesh=null)}removeAllMesh(){var e=this;e.clearGriddingMesh(),null!=e.cutMaterial&&e.cutMaterial.dispose(),null!=e.fillMaterial&&e.fillMaterial.dispose(),null!=e.groundMaterial&&e.groundMaterial.dispose(),null!=e.wallMesh1&&(e.remove(e.wallMesh1),e.wallMesh1.geometry.dispose(),e.wallMesh1.material.dispose(),e.wallMesh1=null),null!=e.wallMesh2&&(e.remove(e.wallMesh2),e.wallMesh2.geometry.dispose(),e.wallMesh2.material.dispose(),e.wallMesh2=null),null!=e.wallWireframeMesh&&(e.remove(e.wallWireframeMesh),e.wallWireframeMesh.geometry.dispose(),e.wallWireframeMesh.material.dispose(),e.wallWireframeMesh=null),null!=e.blMesh&&(e.remove(e.blMesh),e.blMesh.geometry.dispose(),e.blMesh.material.dispose(),e.blMesh=null),null!=e.bpMesh&&(e.remove(e.bpMesh),e.bpMesh.geometry.dispose(),e.bpMesh.material.dispose(),e.bpMesh=null)}destroy(){var e=this;e.removeAllMesh(),e.level=null,e.boundary=null,e.showVisualization=null,e.tileManager=null,e.worldBoxScratch=null,e.tileBuilder=null,e.worldMatrixScratch=null,e.inverseWorldMatrixScratch=null,e.worldMatrixRestore=null,e.pointVector3_a=null,e.pointVector3_b=null,e.pointVector3_c=null,e.lineStartScratch=null,e.lineEndScratch=null}checkHighLowTerrain(e,t,i,r,a,n){var s=this;if(e[2]>s._level&&t[2]>s._level&&i[2]>s._level)a.push(e[0],e[1],e[2]),a.push(t[0],t[1],t[2]),a.push(i[0],i[1],i[2]);else if(e[2]<s._level&&t[2]<s._level&&i[2]<s._level)r.push(e[0],e[1],e[2]),r.push(t[0],t[1],t[2]),r.push(i[0],i[1],i[2]);else if(e[2]==s._level&&t[2]==s._level&&i[2]==s._level)n.push(e[0],e[1],e[2]),n.push(t[0],t[1],t[2]),n.push(i[0],i[1],i[2]);else{var o=[],l=[],d=[];if(e[2]>s._level?o.push(e[0],e[1],e[2]):e[2]<s._level?l.push(e[0],e[1],e[2]):d.push(e[0],e[1],e[2]),t[2]>s._level?o.push(t[0],t[1],t[2]):t[2]<s._level?l.push(t[0],t[1],t[2]):d.push(t[0],t[1],t[2]),i[2]>s._level?o.push(i[0],i[1],i[2]):i[2]<s._level?l.push(i[0],i[1],i[2]):d.push(i[0],i[1],i[2]),0==l.length)a.push(e[0],e[1],e[2]),a.push(t[0],t[1],t[2]),a.push(i[0],i[1],i[2]);else if(0==o.length)r.push(e[0],e[1],e[2]),r.push(t[0],t[1],t[2]),r.push(i[0],i[1],i[2]);else if(3==d.length){var h=s.getGradient(l[2],d[2],o[2]),c=l[0]+h*(o[0]-l[0]),u=l[1]+h*(o[1]-l[1]),p=s._level;r.push(c,u,p),r.push(l[0],l[1],l[2]),r.push(d[0],d[1],d[2]),a.push(c,u,p),a.push(o[0],o[1],o[2]),a.push(d[0],d[1],d[2])}else if(6==l.length){var m=s.getGradient(o[2],s._level,l[2]),f=s.getGradient(o[2],s._level,l[5]),g=o[0]+m*(l[0]-o[0]),v=o[1]+m*(l[1]-o[1]),y=s._level,M=o[0]+f*(l[3]-o[0]),E=o[1]+f*(l[4]-o[1]),b=s._level;a.push(g,v,y),a.push(M,E,b),a.push(o[0],o[1],o[2]),r.push(g,v,y),r.push(M,E,b),r.push(l[0],l[1],l[2]),r.push(M,E,b),r.push(l[0],l[1],l[2]),r.push(l[3],l[4],l[5])}else if(6==o.length){m=s.getGradient(l[2],s._level,o[2]),f=s.getGradient(l[2],s._level,o[5]),g=l[0]+m*(o[0]-l[0]),v=l[1]+m*(o[1]-l[1]),y=s._level,M=l[0]+f*(o[3]-l[0]),E=l[1]+f*(o[4]-l[1]),b=s._level;r.push(g,v,y),r.push(M,E,b),r.push(l[0],l[1],l[2]),a.push(g,v,y),a.push(M,E,b),a.push(o[0],o[1],o[2]),a.push(M,E,b),a.push(o[0],o[1],o[2]),a.push(o[3],o[4],o[5])}else console.log("数据丢失~")}}getGradient(e,t,i){return Math.abs((t-e)/(i-e))}effectOpt(e){var t=this;t.setOpts(e),null!=t.tileManager&&t.updateCutFillVolume()}setVisible(e){var t=this;null!=t.cutMesh&&(t.cutMesh.material.visible=e),null!=t.fillMesh&&(t.fillMesh.material.visible=e),null!=t.groundMesh&&(t.groundMesh.material.visible=e),null!=t.wallMesh1&&(t.wallMesh1.material.visible=e),null!=t.wallMesh2&&(t.wallMesh2.material.visible=e),null!=t.wallWireframeMesh&&(t.wallWireframeMesh.material.visible=e),null!=t.blMesh&&(t.blMesh.material.visible=e),null!=t.bpMesh&&(t.bpMesh.material.visible=e)}hide(){this.setVisible(!1)}show(){this.setVisible(!0)}setOpts(e){let t=this;e&&(t.layerIds=e.layerIds,e.level&&(t.level=e.level),e.boundary&&(t.boundary=e.boundary),e.showVisualization&&(t.showVisualization=e.showVisualization)),t._level=t.level*r.Tile.TileMath.unitScale*r.GlobalData.TerrainScale}getTotalArea(){return this.totalArea}getTotalSuperficialArea(){return this.totalSuperficialArea}getCutArea(){return this.cutArea}getCutVolume(){return this.cutVolume}getFillArea(){return this.fillArea}getFillVolume(){return this.fillVolume}}r.CutFillMeasure=a}(),function(){let e=new THREE.Vector2;r.ScissorViewportManager=class{constructor(e){var t=this;t.embeddedViewFlg=!1,t.viewer=e,t.modelManager=t.viewer.getModelManager(),t.oldSceneMap={},t.mainViewContents=[],t.subViewContents=[],t.subViewRegion={},t.needUpdate=!1,t.tempMaterial=new THREE.ShaderMaterial}dispose(){var e=this;e.embeddedViewFlg=null,e.subViewRegion=null,e.mainViewContents=null,e.subViewContents=null,e.oldSceneMap=null,e.modelManager=null}isEmbeddedView(){return this.embeddedViewFlg}effectOpt(e){this.setOpts(e),this.update()}getTileManager(){var e=this;null==e.tileManager&&e.modelManager.modelCollection.traverse((t=>{t.isDemLayer&&(e.tileManager=t.tileManager)}));return e.tileManager}setOpts(e){var t=this;null!=e.subViewRegion&&(null!=e.subViewRegion.locationX&&(t.subViewRegion.locationX=e.subViewRegion.locationX),null!=e.subViewRegion.locationY&&(t.subViewRegion.locationY=e.subViewRegion.locationY),null!=e.subViewRegion.widthRatio&&(t.subViewRegion.widthRatio=e.subViewRegion.widthRatio),null!=e.subViewRegion.heightRatio&&(t.subViewRegion.heightRatio=e.subViewRegion.heightRatio)),null!=e.mainViewContents&&(t.mainViewContents=e.mainViewContents,t.needUpdate=!0),null!=e.subViewContents&&(t.subViewContents=e.subViewContents,t.needUpdate=!0)}show(){this.embeddedViewFlg=!0,this.update()}hide(){this.embeddedViewFlg=!1,this.recoverVisible(!0)}setViewRegionRender(t,i,r){var a=this;t.setScissorTest(!0),t.getSize(e);var n=e.width,s=e.height,o=a.subViewRegion.locationX,l=a.subViewRegion.locationY;a.recoverVisible(),a.setContentsVisible(a.mainViewContents),this.viewer.getScene().updateCSMParameter(),t.setScissor(0,0,n,s),t.render(i,r);var d=s-l-s*a.subViewRegion.heightRatio;d<0&&(d=0);var h=s*a.subViewRegion.heightRatio;h+d>s-l&&(h=s-l),h<=0&&(h=0);var c=n*a.subViewRegion.widthRatio;c+o>n&&(c=n-o),c<=0&&(c=0),0!=c&&0!=h&&(a.recoverVisible(),a.setContentsVisible(a.subViewContents),this.viewer.getScene().updateCSMParameter(),t.setScissor(o,d,c,h),t.render(i,r)),a.showViewContents(),t.setScissorTest(!1)}showViewContents(){var e=this;if(e.embeddedViewFlg){let t;for(t=0;t<e.mainViewContents.length;t++)null!=e.mainViewContents[t].modelId&&e.modelManager.getModel(e.mainViewContents[t].modelId).setVisible(!0);for(t=0;t<e.subViewContents.length;t++)null!=e.subViewContents[t].modelId&&e.modelManager.getModel(e.subViewContents[t].modelId).setVisible(!0)}}setContentsVisible(e){var t=this;for(let i=0;i<e.length;i++)null==e[i].modelId?e[i].isVisible?t.getTileManager().show(e[i].imageryId):t.getTileManager().hide(e[i].imageryId):t.modelManager.getModel(e[i].modelId).setVisible(e[i].isVisible)}recoverVisible(e=!1){var t=this;for(let i in t.oldSceneMap)t.oldSceneMap[i].isImagery?t.oldSceneMap[i].isVisible?t.getTileManager().show(i):t.getTileManager().hide(i):t.modelManager.getModel(i).setVisible(t.oldSceneMap[i].isVisible),e&&delete t.oldSceneMap[i]}backupVisible(e){var t=this;let i,r,a;var n=t.getTileManager().tileProvider.tileVisible;for(let s=0;s<e.length;s++)null==e[s].modelId?(i=e[s].imageryId,a=!0,r=n[i]):(i=e[s].modelId,r=t.modelManager.getModel(i).visible,a=!1),null==t.oldSceneMap[i]?t.oldSceneMap[i]={isVisible:r,dirty:!1,isImagery:a}:t.oldSceneMap[i].dirty=!1}update(){var e=this;if(e.embeddedViewFlg&&e.needUpdate){for(let t in e.oldSceneMap)e.oldSceneMap[t].dirty=!0;e.backupVisible(e.mainViewContents),e.backupVisible(e.subViewContents);for(let t in e.oldSceneMap)e.oldSceneMap[t].dirty&&(e.modelManager.getModel(t).setVisible(e.oldSceneMap[t].isVisible),delete e.oldSceneMap[t])}}}}(),(()=>{let e=new THREE.Vector3,t=new THREE.Vector3,i=new THREE.Vector3,a=new THREE.Vector3;class n{constructor(e){this.renderWire=void 0,this.currentLevel=void 0,this.orthoCamera=new THREE.OrthographicCamera,this.spacing=e.getModelManager().isMeterUnit()?1:1e3,this.lastTime=(new Date).getTime(),this.timeInterval=1e3,this.viewer=e,this.cameraOriginCallBack=this.viewer.cameraControl._changeCallBack,this.currentDrawingStyle=void 0,this.hasFitterState=void 0,this.filterSate=void 0,this.sectionBoxEnable=void 0,this.sectionBoxVisible=null,this.sectionPlaneEnable=void 0,this.sectionPlaneVisible=null,this.externalComponentVisible=void 0,this.externalBodyVisible=null,this.cameraChangedHandle=()=>{const{force:e,bottom:t,maxLevel:i,modelSpacing:r,scale:a,useBorder:n,successCallback:s}=this.handleInputOption;let o=Math.floor((this.viewer.camera.position.y-t)/r);if(o>i&&(o=i),!e&&(o===this.currentLevel||o<0))return;const l=(new Date).getTime();if(!e&&l-this.lastTime<this.timeInterval)return;this.lastTime=l,this.currentLevel=o;const d=r*o+.5;this.createMap(a,d,n,void 0,s),this.handleInputOption.force=!1}}destroy(){this.removeCreateMapEvent(),this.orthoCamera=null,this.spacing=void 0,this.lastTime=null,this.timeInterval=void 0,this.currentDrawingStyle=void 0,this.filterSate=void 0,this.hasFitterState=void 0,this.sectionBoxEnable=void 0,this.sectionBoxState=null,this.externalComponentVisible=void 0,this.externalBodyVisible=null}updateCamera(e,t,i,r,a,n,s,o){this.orthoCamera.left=e,this.orthoCamera.right=t,this.orthoCamera.top=i,this.orthoCamera.bottom=r,this.orthoCamera.near=a,this.orthoCamera.far=n,this.orthoCamera.updateProjectionMatrix(),this.orthoCamera.position.set(s.x,s.y,s.z),this.orthoCamera.up.set(0,0,1),this.orthoCamera.target=o,this.orthoCamera.lookAt(o),this.orthoCamera.updateMatrixWorld(!0)}_beforeCreateMap(e){const t=this.viewer.getScene();t.updateLights(this.orthoCamera,this.viewer);const i=this.viewer.getFilter();this.filterSate=i.saveState(),this.hasFitterState=i._hasVisibleFilter()||i._hasTransparentFilter()||i._hasHiddenFileIdFilter()||i._hasOverrideMaterialFilter(),!0===this.hasFitterState&&(this.viewer.getFilter().clear(),this.viewer.rendererManager.renderer._render(!0)),this.sectionBoxEnable=t.clipPlanes&&t.clipPlanes.isEnabled(),!0===this.sectionBoxEnable&&(this.sectionBoxVisible=t.clipPlanes.visible,t.clipPlanes.enable(!1,!1)),this.sectionPlaneEnable=t.fillClipPlane&&!0===t.fillClipPlane.isEnabled(),!0===this.sectionPlaneEnable&&(this.sectionPlaneVisible=t.fillClipPlane.visible,t.fillClipPlane.enable(!1,!1));const a=this.viewer.modelManager.getModel("ExternalComponent");this.externalComponentVisible=a&&a._getNodeGroup().visible,!0===this.externalComponentVisible&&(a._getNodeGroup().visible=!1);const n=this.viewer.getScene().extrudeBodyManager;this.externalBodyVisible=a&&[n._getNodeGroupVisible(),n._getAlphaTestNodeGroupVisible()],this.externalBodyVisible&&(n._getNodeGroup().visible=!1,n._getAlphaTestNodeGroup().visible=!1),this.currentDrawingStyle=r.GlobalData.DrawingStyle,e&&(this.viewer.setDrawingStyle(r.DrawingStyle.SHADINGWITHLINE),!0!==this.renderWire&&(this.renderWire,this.viewer.rendererManager.renderer._render(!0)))}_endCreateMap(){!0===this.hasFitterState&&this.viewer.getFilter().loadState(this.filterSate);const e=this.viewer.getScene();if(!0===this.sectionBoxEnable&&e.clipPlanes.enable(!0,this.sectionBoxVisible),!0===this.sectionPlaneEnable&&e.fillClipPlane.enable(!0,this.sectionPlaneVisible),!0===this.externalComponentVisible){this.viewer.modelManager.getModel("ExternalComponent")._getNodeGroup().visible=!0}if(this.externalBodyVisible){const t=e.extrudeBodyManager;t._getNodeGroup().visible=this.externalBodyVisible[0],t._getAlphaTestNodeGroup().visible=this.externalBodyVisible[1]}}createMap(i,r,s,o,l){let d=this.viewer.getScene().getBoundingBox();void 0!==o&&(d=o);const h=(d.min.x+d.max.x)/2,c=(d.min.z+d.max.z)/2,u=d.max.y;e.set(h,u,c),t.set(h,u-1,c),d.getSize(a);const p=a.x/2,m=a.z/2;this.updateCamera(-p,p,m,-m,a.y-r,a.y,e,t),this._beforeCreateMap(s);const f=this.viewer.rendererManager.getRenderer(),g=f.autoClear;f.autoClear=!1;const v=f.getRenderTarget(),y=Math.max(parseInt(a.x*i),1),M=Math.max(parseInt(a.z*i),1),E=new THREE.WebGLRenderTarget(y,M);E.texture.flipY=!1,E.texture.encoding=THREE.GammaEncoding,f.setRenderTarget(E),f.clear(),f.render(this.viewer.getScene(),this.orthoCamera),f.autoClear=g,f.setRenderTarget(v);const b=n.exportCanvas(f,E,y,M);this._endCreateMap(),l&&l(b)}createMapByHeight(e){const{maxPixel:t,useBorder:i,height:r,boundingbox:a,successCallback:n}=e,s=this.viewer.getBoundingBox();if(Array.isArray(r)){let e=[],o=t=>{e.push(t)};for(let e=0;e<r.length;e++){const n=r[e],l=a[e],d=this.getScaleByPixel(l,t),h=this.viewer.worldToDrawing({x:0,y:0,z:n}).y+.5-s.min.y;h<s.min.y?console.warn("the height beyond the bottom of the model"):this.createMap(d,h,i,l,o)}n(e)}else{const e=this.getScaleByPixel(s,t),a=this.viewer.worldToDrawing({x:0,y:0,z:r}).y+.5-s.min.y;if(a<s.min.y)return void console.warn("the height beyond the bottom of the model");this.createMap(e,a,i,void 0,n)}}getScaleByPixel(e,t){e.getSize(a);return t/Math.max(a.x,a.z)}addCreateMapEvent(e){const{maxPixel:t,useBorder:n,spacing:s,successCallback:o}=e,l=this.viewer.getBoundingBox(),d=l.min.y,h=l.max.y,c=this.getScaleByPixel(l,t);this.viewer.getBoundingBoxWorld().getSize(i),null!=s&&(this.spacing=s);const u=this.spacing*a.y/i.z,p=Math.floor((h-d)/u)+1;this.handleInputOption={force:!0,bottom:d,maxLevel:p,modelSpacing:u,scale:c,useBorder:n,successCallback:o},this.viewer.registerEventListener(r.EVENTS.ON_CAMERA_CHANGED_AND_RENDERED,this.cameraChangedHandle)}removeCreateMapEvent(){this.viewer.unregisterEventListener(r.EVENTS.ON_CAMERA_CHANGED_AND_RENDERED,this.cameraChangedHandle),document.querySelectorAll(".modelMap").forEach((e=>{document.body.removeChild(e)}))}}n.exportCanvas=(e,t,i,r)=>{const a=document.createElement("canvas");a.width=i,a.height=r;const n=a.getContext("2d"),s=new Uint8Array(4*i*r),o=new Uint8ClampedArray(s.buffer);e.readRenderTargetPixels(t,0,0,i,r,s);let l=new ImageData(o,i,r);for(let e=3;e<4*i*r;e+=4)l.data[e]*=.8;return n.putImageData(l,0,0),a.toDataURL("image/png")},r.MapManager=n})(),(()=>{let e=null,t=new THREE.Vector3,i=new THREE.Vector3;class a{constructor(e){this.viewer=e,this.shadowGroup=e.getScene().getOrCreateObjectGroup(r.ObjectGroupType.CONTACTSHADOW),this.offset=-0,this.blur=3.5,this.darkness=1,this.opacity=1,this.color=new THREE.Color(0,0,0),this.renderTarget=new THREE.WebGLRenderTarget(512,512),this.renderTarget.texture.generateMipmaps=!1,this.renderTargetBlur=new THREE.WebGLRenderTarget(512,512),this.renderTargetBlur.texture.generateMipmaps=!1;const a=this.viewer.getBoundingBox();a.getCenter(t),a.getSize(i);const n=new THREE.PlaneGeometry(1,1).rotateX(Math.PI/2),s=new THREE.MeshBasicMaterial({map:this.renderTarget.texture,opacity:this.opacity,transparent:!0,depthWrite:!1,polygonOffset:!0,polygonOffsetFactor:1,polygonOffsetUnits:10,side:THREE.DoubleSide});this.plane=new THREE.Mesh(n,s),this.plane.renderOrder=r.EnumRenderOrder.WireFrame,this.plane.name="ContactShadow",this.plane.scale.y=-1,this.shadowGroup.add(this.plane),this.blurPlane=new THREE.Mesh(n),this.blurPlane.visible=!1,this.blurPlane.renderOrder=r.EnumRenderOrder.WireFrame,this.shadowGroup.add(this.blurPlane);const o=new THREE.MeshBasicMaterial({color:new THREE.Color(0,0,0),opacity:0,transparent:!0,depthWrite:!1,side:THREE.DoubleSide});this.fillPlane=new THREE.Mesh(n,o),this.fillPlane.rotateX(Math.PI),this.fillPlane.renderOrder=r.EnumRenderOrder.Component,this.fillPlane.visible=!1,this.shadowGroup.add(this.fillPlane),this.shadowGroup.matrixAutoUpdate=!1,this.planeScale=1.2,this.shadowBox=null,this.updatePlane(this.plane,a,t,i),this.updatePlane(this.blurPlane,a,t,i),this.updatePlane(this.fillPlane,a,t,i),this.shadowCamera=new THREE.OrthographicCamera(-i.x/2*this.planeScale,i.x/2*this.planeScale,i.z/2*this.planeScale,-i.z/2*this.planeScale,0,i.y),this.shadowCamera.position.set(t.x,a.min.y+this.offset,t.z),this.shadowCamera.rotation.x=Math.PI/2,this.cameraHelper=new THREE.CameraHelper(this.shadowCamera),this.cameraHelper.visible=!1,this.shadowGroup.add(this.cameraHelper),this.depthMaterial=new r.CustomMeshDepthMaterial,this.depthMaterial.side=THREE.DoubleSide,this.depthMaterial.depthPacking=THREE.BasicDepthPacking,this.depthMaterial.blending=THREE.NoBlending,this.depthMaterial.userData.darkness={value:this.darkness},this.depthMaterial.userData.color={value:this.color},this.depthMaterial.onBeforeCompile=e=>{e.uniforms.darkness=this.depthMaterial.userData.darkness,e.uniforms.color=this.depthMaterial.userData.color,e.fragmentShader=`\n\t\t\t\t\t\tuniform float darkness;\n                        uniform vec3 color;\n\t\t\t\t\t\t${e.fragmentShader.replace("gl_FragColor = vec4( vec3( fragZ ), opacity );","gl_FragColor = vec4( fragZ*color, darkness );")}\n\t\t\t\t\t`},this.depthMaterial.depthTest=!1,this.depthMaterial.depthWrite=!1,this.InstancedDepthMaterial=new r.CustomInstancedMeshDepthMaterial,this.InstancedDepthMaterial.side=THREE.DoubleSide,this.InstancedDepthMaterial.depthPacking=THREE.BasicDepthPacking,this.InstancedDepthMaterial.blending=THREE.NoBlending,this.InstancedDepthMaterial.userData.darkness={value:this.darkness},this.InstancedDepthMaterial.userData.color={value:this.color},this.InstancedDepthMaterial.onBeforeCompile=e=>{e.uniforms.darkness=this.depthMaterial.userData.darkness,e.uniforms.color=this.depthMaterial.userData.color,e.fragmentShader=`\n\t\t\t\t\t\tuniform float darkness;\n                        uniform vec3 color;\n\t\t\t\t\t\t${e.fragmentShader.replace("gl_FragColor = vec4( vec3( fragZ ), opacity );","gl_FragColor = vec4( fragZ*color, darkness );")}\n\t\t\t\t\t`},this.InstancedDepthMaterial.depthTest=!1,this.InstancedDepthMaterial.depthWrite=!1,this.horizontalBlurMaterial=new THREE.ShaderMaterial(r.HorizontalBlurShader),this.horizontalBlurMaterial.depthTest=!1,this.horizontalBlurMaterial.side=THREE.DoubleSide,this.verticalBlurMaterial=new THREE.ShaderMaterial(r.VerticalBlurShader),this.verticalBlurMaterial.depthTest=!1,this.verticalBlurMaterial.side=THREE.DoubleSide,this.shadowGroup.updateMatrixWorld(!0)}destroy(){this.viewer.getScene().removeObjectGroupByName(r.ObjectGroupType.CONTACTSHADOW),this.shadowGroup=null,this.blur=void 0,this.darkness=void 0,this.opacity=void 0,this.color=null,this.renderTarget=null,this.renderTargetBlur=null,this.shadowCamera=null,this.cameraHelper=null,this.plane=null,this.blurPlane=null,this.fillPlane=null,this.depthMaterial=null,this.horizontalBlurMaterial=null,this.verticalBlurMaterial=null}getShadowBoxWorld(){if(this.shadowBox)return this.shadowBox.clone();this.shadowBox=new THREE.Box3,this.shadowBox.copy(this.viewer.getBoundingBox()),this.shadowBox.expandByVector(new THREE.Vector3(i.x*(this.planeScale-1),0,i.z*(this.planeScale-1))),this.shadowBox.min.y+=this.offset;const e=this.viewer.getScene().geometryGroup.matrix.clone();return e.invert(),this.shadowBox.applyMatrix4(e),this.shadowBox.clone()}updatePlane(e,t,i,r){e.position.y=t.min.y+this.offset,e.position.x=i.x,e.position.z=i.z,e.scale.x=r.x*this.planeScale,e.scale.z=r.z*this.planeScale}render(e,t,i){const r=t.background,a=t.clipPlanes&&!0===t.clipPlanes.visible,n=t.fillClipPlane&&!0===t.fillClipPlane.visible,s=t.clipPlanes&&t.clipPlanes.capsWireframe&&!0===t.clipPlanes.capsWireframe.visible,o=e.autoClear;e.autoClear=!1,t.background=null,this.plane.visible=!1,!0===a&&(t.clipPlanes.visible=!1),!0===s&&(t.clipPlanes.capsWireframe.visible=!1),!0===n&&(t.fillClipPlane.visible=!1),t.overrideMaterial=this.depthMaterial,this.viewer.modelManager.adjustVisibility(!0),this.viewer.modelManager.adjustInstanceVisibility(!1);const l=e.getRenderTarget();e.setRenderTarget(this.renderTarget),e.clear(),e.render(t,this.shadowCamera),t.overrideMaterial=this.InstancedDepthMaterial,this.viewer.modelManager.adjustVisibility(!1),this.viewer.modelManager.adjustInstanceVisibility(!0),e.render(t,this.shadowCamera),this.blurShadow(e,this.blur),this.blurShadow(e,.4*this.blur),e.setRenderTarget(l),t.overrideMaterial=null,this.viewer.modelManager.adjustVisibility(!0),e.autoClear=o,t.background=r,!0===a&&(t.clipPlanes.visible=!0),!0===s&&(t.clipPlanes.capsWireframe.visible=!0),!0===n&&(t.fillClipPlane.visible=!0),this.plane.visible=!0}blurShadow(e,t){this.blurPlane.visible=!0,this.blurPlane.material=this.horizontalBlurMaterial,this.blurPlane.material.uniforms.tDiffuse.value=this.renderTarget.texture,this.horizontalBlurMaterial.uniforms.h.value=1*t/256,e.setRenderTarget(this.renderTargetBlur),e.render(this.blurPlane,this.shadowCamera),this.blurPlane.material=this.verticalBlurMaterial,this.blurPlane.material.uniforms.tDiffuse.value=this.renderTargetBlur.texture,this.verticalBlurMaterial.uniforms.v.value=1*t/256,e.setRenderTarget(this.renderTarget),e.render(this.blurPlane,this.shadowCamera),this.blurPlane.visible=!1}getBlur(){return this.blur}setBlur(e){this.blur=e}getDarkness(){return this.darkness}setDarkness(e){this.darkness=e,this.depthMaterial.userData.darkness.value=e}getOpacity(){return this.opacity}setOpacity(e){this.opacity=e,this.plane.material.opacity=e}getColor(){return this.color}setColor(e){this.color=e,this.depthMaterial.userData.color.value=e}setHeight(e){const r=this.viewer.getBoundingBoxWorld();if(e>r.max.z)return void console.warn("Height greater than the scene bounding box");this.height=e,r.min.z=e;const a=this.viewer.getScene().getMatrixGlobal(),n=r.applyMatrix4(a);n.getCenter(t),n.getSize(i);const s=this.viewer.getBoundingBox();this.offset=n.min.y-s.min.y,this.update()}getHeight(){return this.height}update(){const e=this.viewer.getBoundingBox();e.getCenter(t),e.getSize(i),this.updatePlane(this.plane,e,t,i),this.updatePlane(this.blurPlane,e,t,i),this.updatePlane(this.fillPlane,e,t,i),this.shadowGroup.updateMatrixWorld(!0),this.shadowCamera.left=-i.x/2*this.planeScale,this.shadowCamera.right=i.x/2*this.planeScale,this.shadowCamera.top=i.z/2*this.planeScale,this.shadowCamera.bottom=-i.z/2*this.planeScale,this.shadowCamera.near=0,this.shadowCamera.far=i.y-this.offset,this.shadowCamera.updateProjectionMatrix(),this.shadowCamera.position.set(t.x,e.min.y+this.offset,t.z),this.shadowCamera.updateMatrixWorld(!0)}}a.destroyInstance=()=>{e&&e.destroy(),e=null},a.getInstance=()=>e,a.createInstance=t=>(e||(e=new r.ContactShadow(t)),e),r.ContactShadow=a})(),function(){class e extends r.TerrainOperationManager{constructor(e){super(e),this.viewer=e,this.modelId={},this.holeId,this.imageLayerIds=[],this.boundary=[],this.originBoundary=[],this.lowestHeight=1/0,this.hasOsgbLayer=!1}getTerrainExcavation(e){return this.terrainExcavations[e]}dispose(){super.dispose(),this.modelId=null,this.imageLayerIds=null}setImageLayerIds(e){this.imageLayerIds=e}setModelId(e){this.modelId=e}getModelIds(){return this.modelId}setHoleId(e){this.holeId=e}getHoleId(){return this.holeId}setBoundary(e){this.boundary=e}getBoundary(){return this.boundary}setOriginBoundary(e){for(let t=0;t<e.length;++t)this.originBoundary.push(e[t])}getOriginBoundary(){return this.originBoundary}setBBoxLowestPos(e){this.hasOsgbLayer&&this.lowestHeight>e.pos.z&&(this.lowestHeight=e.pos.z)}calcOriginBBox(e){let t=this.getOriginBoundary(),i=[];for(let r=0;r<t.length;r++){let a=this.viewer.drawingToWorld(t[r]);a.z=e?this.lowestHeight:0,i.push(a)}this.boundary.splice(0,this.boundary.length);let r=[];for(let e=0;e<i.length;e++){let t=this.viewer.worldToDrawing(i[e]);r.push(t),this.boundary.push(t)}let a=new THREE.Vector3(1/0,1/0,1/0),n=new THREE.Vector3(-1/0,-1/0,-1/0);for(let e=0;e<t.length;e++)a.x=Math.min(t[e].x,a.x),a.y=Math.min(t[e].y,a.y),a.z=Math.min(t[e].z,a.z),n.x=Math.max(t[e].x,n.x),n.y=Math.max(t[e].y,n.y),n.z=Math.max(t[e].z,n.z);for(let e=0;e<r.length;e++)a.x=Math.min(r[e].x,a.x),a.y=Math.min(r[e].y,a.y),a.z=Math.min(r[e].z,a.z),n.x=Math.max(r[e].x,n.x),n.y=Math.max(r[e].y,n.y),n.z=Math.max(r[e].z,n.z);return new THREE.Box3(a,n)}getOriginBBox(){let e=this.getOriginBoundary(),t=new THREE.Vector3(1/0,1/0,1/0),i=new THREE.Vector3(-1/0,-1/0,-1/0);for(let r=0;r<e.length;r++)t.x=Math.min(e[r].x,t.x),t.y=Math.min(e[r].y,t.y),t.z=Math.min(e[r].z,t.z),i.x=Math.max(e[r].x,i.x),i.y=Math.max(e[r].y,i.y),i.z=Math.max(e[r].z,i.z);return new THREE.Box3(t,i)}updateOriginBBox(e){return this.hasOsgbLayer?this.calcOriginBBox(e):this.getOriginBBox()}setIfExistOsgbLayer(e){this.hasOsgbLayer=e}}r.Hole=e}(),r.HolesManager=class{constructor(e){this.viewer=e,this._maxHoleCount=4,this.holeMap=new Map,this.size={},this._imageLayerScene=[],this._modelIds=[],this.isDirty=!0,this.isUseTerrain=!1,this.tempBoundary=[],this.orthoCameraFar=2e4,this.orthoCameraPosHeight=1e4}dispose(){for(const e of this.holeMap.values())e.dispose();this.holeMap=null,this._maxHoleCount=void 0,this.size=null,this._imageLayerScene.forEach((e=>{e.renderTargetForExcavation.dispose(),e.pickingExcavationRenderTarget.dispose(),e.pickingExcavationMaterial=null,e.sceneForExcavation=null})),this._imageLayerScene=null}mergeExcavationScene(e,t){e.holes.push(t);let i=t.getTerrainExcavation(t.getHoleId()),r=new THREE.Mesh(i.geometry,i.material);r.terrainExcavationId=i.id,e.sceneForExcavation.add(r);const{orthoViewProjMatrix:a,orthoCamera:n}=this.createOrthoViewProjMatrix(e.holes);e.orthoViewProjMatrix=a,e.orthoCamera=n}createExcavationGISScene(e,t,i,a){let n=new THREE.Scene,s=new THREE.WebGLRenderTarget(1024,1024,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter}),o=new r.PickingExcavationMaterial,l=new THREE.WebGLRenderTarget(1024,1024,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter}),d=e.getTerrainExcavation(e.getHoleId()),h=new THREE.Mesh(d.geometry,d.material);h.terrainExcavationId=d.id,n.add(h);let c=[];c.push(e);const{orthoViewProjMatrix:u,orthoCamera:p}=this.createOrthoViewProjMatrix(c);this._imageLayerScene.push({sceneForExcavation:n,renderTargetForExcavation:s,pickingExcavationMaterial:o,pickingExcavationRenderTarget:l,orthoViewProjMatrix:u,orthoCamera:p,imageId:t,layerId:i,modelId:a,holes:c})}createExcavation3DScene(e,t){if(this.isDirty){this.isDirty=!1;let i=new THREE.Scene,a=new THREE.WebGLRenderTarget(1024,1024,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter}),n=new r.PickingExcavationMaterial,s=new THREE.WebGLRenderTarget(1024,1024,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter}),o=e.getTerrainExcavation(e.getHoleId()),l=new THREE.Mesh(o.geometry,o.material);l.terrainExcavationId=o.id,i.add(l);let d=[];d.push(e);const{orthoViewProjMatrix:h,orthoCamera:c}=this.createOrthoViewProjMatrix(d);this._imageLayerScene.push({sceneForExcavation:i,renderTargetForExcavation:a,pickingExcavationMaterial:n,pickingExcavationRenderTarget:s,orthoViewProjMatrix:h,orthoCamera:c,modelId:t,holes:d})}else this._imageLayerScene.forEach((t=>{this.mergeExcavationScene(t,e)}))}createOrthoViewProjMatrix(e){let t=new THREE.Vector3(1/0,1/0,1/0),i=new THREE.Vector3(-1/0,-1/0,-1/0);return e.forEach((e=>{let r=e.getTerrainExcavation(e.getHoleId());if(r.getVisible()){let e=r.getAABBMin(),a=r.getAABBMax();t.x=Math.min(e.x,t.x),t.y=Math.min(e.y,t.y),t.z=Math.min(e.z,t.z),i.x=Math.max(a.x,i.x),i.y=Math.max(a.y,i.y),i.z=Math.max(a.z,i.z)}})),this.createOrthoViewProjMatrixByBox({max:i,min:t})}createOrthoViewProjMatrixByBox(e){const t=e.max,i=e.min;let r=.5*(t.x-i.x),a=.5*(t.z-i.z),n=.5*(t.x+i.x),s=.5*(t.y+i.y),o=.5*(t.z+i.z),l=new THREE.Vector3(n,this.orthoCameraPosHeight,o),d=new THREE.Vector3(n,s,o),h=new THREE.OrthographicCamera(-r,r,a,-a,.1,this.orthoCameraFar);h.position.set(l.x,l.y,l.z),h.up.set(0,0,1),h.lookAt(d),h.updateMatrixWorld(!0);let c=new THREE.Matrix4,u=new THREE.Matrix4;return c=h.projectionMatrix.clone(),u.copy(h.matrixWorld).invert(),c.multiply(u),{orthoCamera:h,orthoViewProjMatrix:c}}getExcavationInfo(e,t){const i=e.getRenderTarget();return e.setRenderTarget(t.renderTargetForExcavation),e.clearColor(),e.render(t.sceneForExcavation,t.orthoCamera),e.setRenderTarget(i),{isExcavation:!0,samplerExcavation:t.renderTargetForExcavation.texture,cullOrthoMatrix:t.orthoViewProjMatrix,cullImageLayerIds:t.imageId}}addHole(e,t){const{points:i,modelIds:a}=t;let n=this.holeMap.get(e);if(!n){n=new r.Hole(this.viewer),n.setSize(this.size.width,this.size.height),n.setHoleId(e),n.addExcavationRegion(e,i),n.setBoundary(i),n.setOriginBoundary(i);let t=!1;for(const e in a)"TileGroup"!=e&&(t=!0);n.setIfExistOsgbLayer(t),this.setHoleBBoxLowestPos(n),this.holeMap.set(e,n)}for(const e in a){let t=a[e],i=[];if(t.forEach((e=>{e.pImageryId&&i.push(e.pImageryId)})),"TileGroup"===e)t.forEach((t=>{let i=!1;for(let e=0;e<this._imageLayerScene.length;e++)if(this._imageLayerScene[e].imageId===t.pImageryId){i=!0;break}i?this._imageLayerScene.forEach((e=>{e.imageId===t.pImageryId&&this.mergeExcavationScene(e,n)})):this.createExcavationGISScene(n,t.pImageryId,t.pLayerId,e)})),0===a[e].length&&this.createExcavation3DScene(n,e);else{let i=!1;for(let t=0;t<this._imageLayerScene.length;t++)if(this._imageLayerScene[t].modelId===e){i=!0;break}i?this._imageLayerScene.forEach((t=>{t.modelId===e&&this.mergeExcavationScene(t,n)})):this.createExcavationGISScene(n,t[0].pImageryId,t[0].pLayerId,e)}}this.viewer.render()}updateExcavationMaterial(e,t){this.viewer.modelManager.modelCollection.traverse((i=>{if(t.modelId==i.id&&"TileGroup"==i.id){const t=i.tileManager;t&&t.setExcavation(e)}else t.modelId==i.id&&i.setExcavation(e)})),t.pickingExcavationMaterial.updateExcavation(e),t.pickingExcavationMaterial.updateSide({isExcavation:e&&e.isExcavation})}updateImageryId(e,t){this._imageLayerScene.forEach((i=>{i.layerId===e&&(i.imageId=t)}))}removeHoleByIds(e){for(const t of this.holeMap.values())t.removeExcavationRegionsById(e);e.forEach((e=>{let t=this.holeMap.get(e);if(t){this.holeMap.delete(e);let i=[];for(let r=0;r<this._imageLayerScene.length;r++)if(this._imageLayerScene[r].sceneForExcavation.children.forEach((i=>{i.terrainExcavationId==e&&(this._imageLayerScene[r].sceneForExcavation.remove(i),this._imageLayerScene[r].holes.forEach((function(e,i,r){e===t&&r.splice(i,1)})))})),0===this._imageLayerScene[r].sceneForExcavation.children.length){i.push(r);let e={isExcavation:!1,samplerExcavation:this._imageLayerScene[r].renderTargetForExcavation.texture,cullOrthoMatrix:this._imageLayerScene[r].orthoViewProjMatrix,cullImageLayerIds:this._imageLayerScene[r].imageId};this.updateExcavationMaterial(e,this._imageLayerScene[r])}if(0!==i.length)for(let e=i.length-1;e>=0;e--)this._imageLayerScene.splice(i[e],1);0===this._imageLayerScene.length&&(this.isDirty=!0)}}))}showHoleByIdAndLayerIds(e,t){t.forEach((t=>{this._imageLayerScene.forEach((i=>{i.layerId===t&&i.sceneForExcavation.children.forEach((t=>{t.terrainExcavationId==e&&(t.visible=!0)}))}))}))}hideHoleByIdAndLayerIds(e,t){t.forEach((t=>{this._imageLayerScene.forEach((i=>{i.layerId===t&&i.sceneForExcavation.children.forEach((t=>{t.terrainExcavationId==e&&(t.visible=!1)}))}))}))}showHideLayerByLayerIds(e,t){let i=this.holeMap.get(e);this._imageLayerScene.forEach((t=>{t.sceneForExcavation.children.forEach((t=>{t.terrainExcavationId===e&&(t.visible=!1)}))})),t.forEach((t=>{let r=!0;this._imageLayerScene.forEach((a=>{if(a.layerId===t.pLayerId){r=!1;let t=!0;a.sceneForExcavation.children.forEach((i=>{i.terrainExcavationId===e&&(t=!1,i.visible=!0)})),t&&this.mergeExcavationScene(a,i)}})),r&&this.createExcavationGISScene(i,t.pImageryId,t.pLayerId,t.pModelId)}))}clearHoles(){let e=[];for(const t of this.holeMap.values())e.push(t.getHoleId());this.removeHoleByIds(e)}hideHoleByIds(e){for(const t of this.holeMap.values())t.hideExcavationRegionsById(e);e.forEach((e=>{this._imageLayerScene.forEach((t=>{t.sceneForExcavation.children.forEach((t=>{t.terrainExcavationId==e&&(t.visible=!1)}))}))}))}showHoleByIds(e){for(const t of this.holeMap.values())t.showExcavationRegionsById(e);e.forEach((e=>{this._imageLayerScene.forEach((t=>{t.sceneForExcavation.children.forEach((t=>{t.terrainExcavationId==e&&(t.visible=!0)}))}))}))}setSize(e,t){this.size={width:e,height:t},this._imageLayerScene.forEach((i=>{i.pickingExcavationRenderTarget.setSize(e,t)}))}pickExcavation(e){return 0!==this.holeMap.size&&this.renderer&&this._imageLayerScene.length,!1}calcHoleScreenHeight(e){let t=new THREE.Vector2(1/0,1/0),i=new THREE.Vector2(-1/0,-1/0);const r=this.size.width/2,a=this.size.height/2;for(let n=0;n<e.length;n++){const s=new THREE.Vector3(e[n].x,e[n].y,e[n].z).project(this.viewer.camera),o=Math.round(r*s.x+r),l=Math.round(-a*s.y+a);t.x=Math.min(o,t.x),t.y=Math.min(l,t.y),i.x=Math.max(o,i.x),i.y=Math.max(l,i.y)}return Math.abs(i.y-t.y)>6}calcBoxIntersect(e,t){var i=new THREE.Box3(e.boxMinValue,e.boxMaxValue);let r,a=this.viewer.camera.frustum.intersectsBox(i);this.viewer.getModelManager().getModel("TileGroup")&&this.viewer.getModelManager().getModel("TileGroup").tileManager&&(r=this.viewer.getModelManager().getModel("TileGroup").tileManager);let n=!1;r&&(n=r.isUseTerrain());var s=t.updateOriginBBox(n);let o=this.viewer.camera.frustum.intersectsBox(s);if(a||o){let e=this.calcHoleScreenHeight(t.getBoundary()),i=this.calcHoleScreenHeight(t.getOriginBoundary());return e||i}return!1}getHoleWorldBox(e){let t=e.getBoundary(),i=new THREE.Vector3(1/0,1/0,1/0),r=new THREE.Vector3(-1/0,-1/0,-1/0);for(let e=0;e<t.length;e++)i.x=Math.min(t[e].x,i.x),i.y=Math.min(t[e].y,i.y),i.z=Math.min(t[e].z,i.z),r.x=Math.max(t[e].x,r.x),r.y=Math.max(t[e].y,r.y),r.z=Math.max(t[e].z,r.z);return{boxMinValue:i,boxMaxValue:r}}updateCameraLookAtRegion(){this._imageLayerScene.forEach((e=>{let t=new THREE.Vector3(1/0,1/0,1/0),i=new THREE.Vector3(-1/0,-1/0,-1/0);e.holes.forEach((e=>{let r=this.getHoleWorldBox(e);if(this.calcBoxIntersect(r,e)){let r=e.getTerrainExcavation(e.getHoleId());if(r.getVisible()){let e=r.getAABBMin(),a=r.getAABBMax();t.x=Math.min(e.x,t.x),t.y=Math.min(e.y,t.y),t.z=Math.min(e.z,t.z),i.x=Math.max(a.x,i.x),i.y=Math.max(a.y,i.y),i.z=Math.max(a.z,i.z)}}}));const{orthoViewProjMatrix:r,orthoCamera:a}=this.createOrthoViewProjMatrixByBox({max:i,min:t});e.orthoViewProjMatrix=r,e.orthoCamera=a}))}addAllTempBoundaryPoint(e){this.tempBoundary.push(e)}setHoleBBoxLowestPos(e){let t;if(this.viewer.getModelManager().getModel("TileGroup")&&this.viewer.getModelManager().getModel("TileGroup").tileManager&&(t=this.viewer.getModelManager().getModel("TileGroup").tileManager),t){let i=e.getOriginBoundary();for(let r=0;r<i.length;r++){const a=this.viewer.drawingToWorld(i[r]);let n=t.worldPositionToLngLat(a),s={lon:n.x,lat:n.y,id:e.holeId,order:r};t.lngLatToWorldPositionWithObj(s,(function(t,i,r){e.setBBoxLowestPos({pos:t,id:i,order:r})}))}}}updateHolesVertex(){let e,t=0;for(const e of this.holeMap.values())t+=e.boundary.length;if(0!=t&&t==this.tempBoundary.length){for(const e of this.holeMap.values()){let t=e.holeId;e.boundary.splice(0,e.boundary.length);for(let i=0;i<this.tempBoundary.length;i++)if(this.tempBoundary[i].id==t){let t=this.viewer.worldToDrawing(this.tempBoundary[i].pos);e.boundary.push(t)}}this.tempBoundary.splice(0,this.tempBoundary.length)}this.viewer.getModelManager().getModel("TileGroup")&&this.viewer.getModelManager().getModel("TileGroup").tileManager&&(e=this.viewer.getModelManager().getModel("TileGroup").tileManager);var i=this;if(e&&this.isUseTerrain!=e.isUseTerrain()){this.isUseTerrain=e.isUseTerrain();for(const t of this.holeMap.values()){let r=t.getBoundary();for(let a=0;a<r.length;a++){const n=this.viewer.drawingToWorld(r[a]);let s=e.worldPositionToLngLat(n),o={lon:s.x,lat:s.y,id:t.holeId,order:a};e.lngLatToWorldPositionWithObj(o,(function(e,t,r){i.addAllTempBoundaryPoint({pos:e,id:t,order:r})}))}}}}render(e){this.renderer=e,this.updateHolesVertex(),this.updateCameraLookAtRegion(),this._imageLayerScene.forEach((t=>{let i=this.getExcavationInfo(e,t);this.viewer.modelManager.modelCollection.traverse((e=>{if(t.modelId==e.id&&"TileGroup"==e.id){const t=e.tileManager;t&&t.setExcavation(i)}else t.modelId==e.id&&e.setExcavation(i)}))}))}},(()=>{class e extends r.ObjectGroup{constructor(e){super(r.ObjectGroupType.InteractionHelper,{priority:20}),this.name="InteractionHelper",this.viewer=e,this.controls={};const t=e.getScene().getMatrixGlobal();this.invertMatrix=(new THREE.Matrix4).copy(t).invert(),this.raycaster=new THREE.Raycaster,this.domElementEvents=[{element:this.viewer.domElement,type:"mousemove",event:e=>{var t=new THREE.Vector2(e.clientX,e.clientY),i=this.viewer.cameraControl.getRaycaster(t.x,t.y);let r=i.ray.origin.clone(),a=i.ray.direction.clone();this.raycaster.set(r,a),this.dispatchEvent({type:"HitTest",raycaster:this.raycaster}),this.dispatchEvent({type:"MouseMove",event:e});let n=!1;Object.values(this.controls).sort(((e,t)=>e.hitTestPriority-t.hitTestPriority)).some((e=>{if(e.selectedObject)n=!0;else{if(!e.hitTest)return;const t=e.hitTest(this.raycaster);t&&(n=t,this._hitControlId&&this._hitControlId!==e.controlId&&this.getControl(this._hitControlId).cancelHitTest(),this._hitControlId=e.controlId)}return n})),n||(this._hitControlId=null)}},{element:this.viewer.domElement,type:"mousedown",useCapture:!0,event:e=>{this._hitControlId&&(this.viewer.editorManager.enabled=!1),this.dispatchEvent({type:"MouseDown",event:e})}},{element:this.viewer.domElement,type:"mouseup",event:e=>{this.viewer.editorManager.enabled=!0,this.dispatchEvent({type:"MouseUp",event:e})}}],this.viewer.registerEventListener(r.EVENTS.ON_CAMERA_CHANGED_AND_RENDERED,(()=>{const e=this.viewer.camera._direction.clone().applyMatrix4(this.invertMatrix).normalize(),t=this.viewer.camera.position.clone().applyMatrix4(this.invertMatrix),i=this.viewer.camera.fov;this.dispatchEvent({type:"CameraChanged",cameraDirection:e,cameraPosition:t,cameraFov:i})})),this.addDomElementEvents()}addDomElementEvents(){this.domElementEvents.forEach((({element:e,type:t,useCapture:i,event:r})=>{e.addEventListener(t,r,i)}))}removeDomElementEvents(){this.domElementEvents.forEach((({element:e,type:t,event:i})=>{e.removeEventListener(t,i)}))}addControl(e,t,i){const a=new r.Interaction.Control[t]({helper:this,id:e,...i});return this.add(a),this.controls[e]=a,a}getControl(e){return this.controls[e]}removeControl(e){const t=this.controls[e];t&&t.destroy()}destroy(){this.removeDomElementEvents(),Object.values(this.controls).forEach((e=>{e.destroy()}))}}e.getInstance=function(t){const i=t.getInteractionScene();if(!i._interactionHelper){const r=i._interactionHelper=new e(t);i.add(r);const a=t.getScene().getMatrixGlobal();r.applyMatrix4(a),r.updateMatrixWorld()}return i._interactionHelper},e.destroy=function(e){e._interactionHelper&&(e._interactionHelper.destroy(),e._interactionHelper=null)},r.Interaction=r.Interaction||{},r.Interaction.InteractionHelper=e})(),(()=>{class e extends THREE.Object3D{constructor(e){super(),this._config=e,this.controlId=e.id,this.helper=e.helper,this.clock=new THREE.Clock,this.animationList=[],this.hoveredObject=null,this.selectedObject=null,this.visible=!1,this.hitTestPriority=isNaN(e.hitTestPriority)?3:e.hitTestPriority;let t=null;this.helperEvents={MouseDown:({event:e})=>{this.visible&&this.hoveredObject&&(this.selectedObject=this.hoveredObject,this.helper.dispatchEvent({type:"TransformStarted",control:this,object:this.selectedObject,id:this.controlId}),this._isClick=!0,t={clientX:e.clientX,clientY:e.clientY})},MouseMove:({event:e})=>{if(this.visible&&this.selectedObject){if(t&&Math.abs(e.clientX-t.clientX)<2&&Math.abs(e.clientY-t.clientY)<2)return;this._isClick=!1;const i=new THREE.Vector2(e.clientX,e.clientY);this.transform(i),this.helper.dispatchEvent({type:"TransformChanged",control:this,object:this.selectedObject,id:this.controlId})}},MouseUp:({event:e})=>{if(this.visible&&this.selectedObject){this.transformFinished();const e=this.selectedObject;this.selectedObject=null,this.helper.dispatchEvent({type:"TransformFinished",control:this,object:e,id:this.controlId}),this._isClick&&this.helper.dispatchEvent({type:"Clicked",control:this,object:e,id:this.controlId}),delete this._isClick,t=null}}},Object.entries(this.helperEvents).forEach((([e,t])=>{this.helper.addEventListener(e,t)})),this.init&&this.init(),requestAnimationFrame((()=>{this.visible=!1!==this.getConfig().visible;const e=this.getViewer().camera.position.clone().applyMatrix4(this.helper.invertMatrix),t=this.getViewer().camera.fov;this.updateScaleFactor&&this.updateScaleFactor({cameraPosition:e,cameraFov:t}),this.updateMatrixWorld(),this.getViewer().render()}));const i=()=>{if(this._destroyed)return;const e=this.clock.getDelta();let t=!1;this.animationList.forEach((({mixer:i,action:r,object:a})=>{r.isRunning()&&(t=!0,i.update(e),a.updateMatrixWorld(!0))})),t&&this.getViewer().render(),requestAnimationFrame(i)};i()}init(){}addHelperEvent(e,t){this.helperEvents[e]=t,this.helper.addEventListener(e,t)}cancelHitTest(){this.visible&&(this.hoveredObject=null,this.children.forEach((e=>{e.isGrayMode?e.cancelGray():e.isHighlightMode&&e.cancelHighlight()})))}hitTest(e){if(!this.visible)return;let t=null;return this.children.some((i=>{if(!i.isEnabled)return!1;const r=i.hitTest(e);return r&&(t=i),r})),this.hoveredObject=t,this.children.forEach((e=>{t?e===t?e.setHighlight():e.setGray():e.isGrayMode?e.cancelGray():e.isHighlightMode&&e.cancelHighlight()})),!!this.hoveredObject}getConfig(){return this._config}getViewer(){return this.helper.viewer}getFactor(e,t){const i=this.position.clone().clone().sub(e.clone()).length(),r=2*Math.tan(t*Math.PI/360)*i,a=this.getViewer().domElement.offsetHeight;return this.factor=r/a,this.factor}addAnimation({mixer:e,action:t,object:i}){this.animationList.push({mixer:e,action:t,object:i})}transform(e){this.selectedObject&&this.selectedObject.transform&&this.selectedObject.transform(e)}transformFinished(){this.selectedObject&&this.selectedObject.transformFinished&&this.selectedObject.transformFinished()}destroy(){for(this._destroyed=!0,Object.entries(this.helperEvents).forEach((([e,t])=>{this.helper.removeEventListener(e,t)}));this.children.length>0;)this.children[0].destroy();this.helper.remove(this),this.helper.viewer.render()}}r.Interaction=r.Interaction||{},r.Interaction.Control=r.Interaction.Control||{},r.Interaction.Control.BaseControl=e})(),(()=>{class e extends r.Interaction.Control.BaseControl{constructor(e){super(e),this.name="TranslateControl";const{position:t,boundingBox:i}=e;t&&this.setPosition(t),i&&this.setBoundingBox(i),this.addHelperEvent("CameraChanged",(e=>this.updateScaleFactor(e))),this.addHelperEvent("TransformStarted",(({id:e,object:t})=>{e===this.controlId&&(this.children.forEach((e=>{e instanceof r.Interaction.Item.TranslateArrow&&e!==t?e.showDashedLine():e instanceof r.Interaction.Item.TranslatePlane&&e!==t&&(e.lastVisible=e.visible,e.visible=!1)})),this.getViewer().render())})),this.addHelperEvent("TransformFinished",(({id:e,object:t})=>{e===this.controlId&&(this.children.forEach((e=>{e instanceof r.Interaction.Item.TranslateArrow?e.hideDashedLine():e instanceof r.Interaction.Item.TranslatePlane&&(e.visible=e.lastVisible)})),this.getViewer().render())}))}init(){const e=16,t=new r.Interaction.Item.TranslatePlane({helper:this.helper,control:this,centerPoint:{x:0,y:-16,z:e},normal:{x:1,y:0,z:0},color:"#F99D0B",name:"PlaneX"});this.add(t);const i=new r.Interaction.Item.TranslatePlane({helper:this.helper,control:this,centerPoint:{x:e,y:0,z:e},normal:{x:0,y:-1,z:0},color:"#F99D0B",name:"PlaneY"});this.add(i);const a=new r.Interaction.Item.TranslatePlane({helper:this.helper,control:this,centerPoint:{x:e,y:-16,z:0},normal:{x:0,y:0,z:1},color:"#F99D0B",name:"PlaneZ"});this.add(a);const n=new r.Interaction.Item.TranslateArrow({helper:this.helper,control:this,startPoint:{x:0,y:0,z:0},endPoint:{x:123,y:0,z:0},color:"#FF2905",name:"AxisX"});this.add(n);const s=new r.Interaction.Item.TranslateArrow({helper:this.helper,control:this,startPoint:{x:0,y:0,z:0},endPoint:{x:0,y:-123,z:0},color:"#1922FB",name:"AxisY"});this.add(s);const o=new r.Interaction.Item.TranslateArrow({helper:this.helper,control:this,startPoint:{x:0,y:0,z:0},endPoint:{x:0,y:0,z:123},color:"#32D3A6",name:"AxisZ"});this.add(o)}updateScaleFactor(e){let t,i;e?(t=e.cameraPosition,i=e.cameraFov):(t=this.getViewer().camera.position.clone().applyMatrix4(this.helper.invertMatrix),i=this.getViewer().camera.fov);const r=this.getFactor(t,i);if(this.scale.set(r,r,r),this.updateMatrixWorld(),this.boundingBox){const e=1/r;this.boundingBox.children.forEach((t=>{t.scale.set(e,e,e),t.updateMatrixWorld()}))}}transform(e){super.transform(e),this.updateScaleFactor()}setPosition(e){this.position.set(e.x,e.y,e.z),this.updateMatrixWorld()}getPosition(){return this.position.clone()}setBoundingBox(e){this.boundingBox&&this.remove(this.boundingBox),this.boundingBox=new r.Interaction.Item.BoundingBox({helper:this.helper,control:this,name:"BoundingBox",boundingBoxData:e}),this.add(this.boundingBox),this.updateScaleFactor()}updateBoundingBox(e){this.boundingBox&&this.boundingBox.update(e),this.updateScaleFactor()}destroy(){this.boundingBox&&(this.boundingBox.destroy(),this.helper.remove(this.boundingBox)),super.destroy()}}r.Interaction=r.Interaction||{},r.Interaction.Control=r.Interaction.Control||{},r.Interaction.Control.TranslateControl=e})(),(()=>{class e extends r.Interaction.Control.BaseControl{constructor(e){super(e),this.name="StrechControl";const{position:t,boundingBox:i}=e;t&&this.setPosition(t),i&&this.setBoundingBox(i),this.addHelperEvent("CameraChanged",(e=>this.updateScaleFactor(e))),this.addHelperEvent("TransformStarted",(({id:e,object:t})=>{e===this.controlId&&(this.children.forEach((e=>{e instanceof r.Interaction.Item.TranslateArrow&&e!==t&&e.showDashedLine()})),this.getViewer().render())})),this.addHelperEvent("TransformFinished",(({id:e,object:t})=>{e===this.controlId&&(this.children.forEach((e=>{e instanceof r.Interaction.Item.TranslateArrow&&e.hideDashedLine()})),this.getViewer().render())}))}init(){const e=new r.Interaction.Item.TranslateArrow({helper:this.helper,control:this,startPoint:{x:0,y:0,z:0},endPoint:{x:0,y:0,z:56},color:"#FFF227",name:"StrechZ"});this.add(e)}transform(e){super.transform(e),this.updateScaleFactor()}setPosition(e){this.position.set(e.x,e.y,e.z),this.updateMatrixWorld()}getPosition(){return this.position.clone()}setBoundingBox(e){this.boundingBox&&this.remove(this.boundingBox),this.boundingBox=new r.Interaction.Item.BoundingBox({helper:this.helper,control:this,name:"BoundingBox",boundingBoxData:e}),this.add(this.boundingBox),this.updateScaleFactor()}updateScaleFactor(e){let t,i;e?(t=e.cameraPosition,i=e.cameraFov):(t=this.getViewer().camera.position.clone().applyMatrix4(this.helper.invertMatrix),i=this.getViewer().camera.fov);const r=this.getFactor(t,i);if(this.scale.set(r,r,r),this.updateMatrixWorld(),this.boundingBox){const e=1/r;this.boundingBox.children.forEach((t=>{t.scale.set(e,e,e),t.updateMatrixWorld()}))}}updateBoundingBox(e){this.boundingBox&&this.boundingBox.update(e),this.updateScaleFactor()}destroy(){this.boundingBox&&(this.boundingBox.destroy(),this.helper.remove(this.boundingBox)),super.destroy()}}r.Interaction=r.Interaction||{},r.Interaction.Control=r.Interaction.Control||{},r.Interaction.Control.StrechControl=e})(),(()=>{class e extends r.Interaction.Control.BaseControl{constructor(e){super(e),this.name="ScaleControl";const{position:t,boundingBox:i}=e;if(t&&this.setPosition(t),i){this.setBoundingBox(i);const e=new THREE.Vector3;i.getCenter(e);const t=i.max.clone().sub(e);this.setArrows(t);const a=new r.Interaction.Item.ScaleCube({helper:this.helper,control:this,length:20,color:"#F99D0B"});this.add(a),this.cube=a;const n=this.dashedX=new r.Interaction.Item.Line({helper:this.helper,control:this,points:[{x:0,y:0,z:0},{x:t.x,y:0,z:0}],color:"#FF2905",dashed:!0});this.add(n);const s=this.dashedY=new r.Interaction.Item.Line({helper:this.helper,control:this,points:[{x:0,y:0,z:0},{x:0,y:-t.y,z:0}],color:"#1922FB",dashed:!0});this.add(s);const o=this.dashedZ=new r.Interaction.Item.Line({helper:this.helper,control:this,points:[{x:0,y:0,z:0},{x:0,y:0,z:t.z}],color:"#32D3A6",dashed:!0});this.add(o)}this.addHelperEvent("CameraChanged",(e=>this.updateScaleFactor(e))),this.addHelperEvent("TransformStarted",(({control:e,object:t})=>{e===this&&t===this.cube&&this.arrows.forEach((e=>{e.originVisible=e.visible,e.visible=!1}))})),this.addHelperEvent("TransformFinished",(({control:e})=>{e===this&&this.arrows.forEach((e=>e.visible=e.originVisible))}))}init(){}setBoundingBox(e){this.boundingBox&&(this.remove(this.boundingBox),this.boundingBox.destroy()),this.boundingBox=new r.Interaction.Item.BoundingBox({helper:this.helper,control:this,name:"BoundingBox",boundingBoxData:e}),this.add(this.boundingBox)}setArrows(e){const t=40;this.arrows=[];const i=new r.Interaction.Item.ScaleArrow({helper:this.helper,control:this,startPoint:{x:0,y:0,z:0},endPoint:{x:t,y:0,z:0},position:{x:e.x,y:0,z:0},color:"#FF2905",name:"AxisX"});this.add(i),this.arrows.push(i);const a=new r.Interaction.Item.ScaleArrow({helper:this.helper,control:this,startPoint:{x:0,y:0,z:0},endPoint:{x:-40,y:0,z:0},position:{x:-e.x,y:0,z:0},color:"#FF2905",name:"AxisXN"});this.add(a),this.arrows.push(a);const n=new r.Interaction.Item.ScaleArrow({helper:this.helper,control:this,startPoint:{x:0,y:0,z:0},endPoint:{x:0,y:t,z:0},position:{x:0,y:e.y,z:0},color:"#1922FB",name:"AxisY"});this.add(n),this.arrows.push(n);const s=new r.Interaction.Item.ScaleArrow({helper:this.helper,control:this,startPoint:{x:0,y:0,z:0},endPoint:{x:0,y:-40,z:0},position:{x:0,y:-e.y,z:0},color:"#1922FB",name:"AxisYN"});this.add(s),this.arrows.push(s);const o=new r.Interaction.Item.ScaleArrow({helper:this.helper,control:this,startPoint:{x:0,y:0,z:0},endPoint:{x:0,y:0,z:t},position:{x:0,y:0,z:e.z},color:"#32D3A6",name:"AxisZ"});this.add(o),this.arrows.push(o);const l=new r.Interaction.Item.ScaleArrow({helper:this.helper,control:this,startPoint:{x:0,y:0,z:0},endPoint:{x:0,y:0,z:-40},position:{x:0,y:0,z:-e.z},color:"#32D3A6",name:"AxisZN"});this.add(l),this.arrows.push(l)}update(e){this.boundingBox.update(e);const t=new THREE.Vector3;e.getCenter(t);const i=e.max.clone().sub(t);this.arrows[0].updatePosition(new THREE.Vector3(i.x,0,0)),this.arrows[1].updatePosition(new THREE.Vector3(-i.x,0,0)),this.arrows[2].updatePosition(new THREE.Vector3(0,i.y,0)),this.arrows[3].updatePosition(new THREE.Vector3(0,-i.y,0)),this.arrows[4].updatePosition(new THREE.Vector3(0,0,i.z)),this.arrows[5].updatePosition(new THREE.Vector3(0,0,-i.z));const r={x:0,y:0,z:0};this.dashedX.update([r,{x:i.x,y:0,z:0}]),this.dashedY.update([r,{x:0,y:-i.y,z:0}]),this.dashedZ.update([r,{x:0,y:0,z:i.z}])}updateScaleFactor(e){const{cameraPosition:t,cameraFov:i}=e,r=this.getFactor(t,i);this.arrows.forEach((e=>e.updateScaleFactor(r))),this.cube.updateScaleFactor(r),[this.dashedX,this.dashedY,this.dashedZ].forEach((e=>e.updateScaleFactor(r)))}transform(e){this.scaleInfo=null,super.transform(e);const t=this.getViewer().camera.position.clone().applyMatrix4(this.helper.invertMatrix),i=this.getViewer().camera.fov;this.updateScaleFactor({cameraPosition:t,cameraFov:i})}setPosition(e){this.position.set(e.x,e.y,e.z),this.updateMatrixWorld()}getPosition(){return this.position.clone()}}r.Interaction=r.Interaction||{},r.Interaction.Control=r.Interaction.Control||{},r.Interaction.Control.ScaleControl=e})(),(()=>{class e extends r.Interaction.Control.BaseControl{constructor(e){super(e),this.name="PolygonControl",this.isEditPointMode=!1,this.addHelperEvent("CameraChanged",(e=>this.updateScaleFactor(e))),this.addHelperEvent("Clicked",(({id:e,object:t})=>{this.selectedObject=null,e===this.controlId&&(this.editingPoints.indexOf(t)>=0?(t!==this.selectedObject&&(t.isSelected=!0,this.selectedPoint=t,t.setHighlight(),this.editPoint(t)),this.editingPoints.forEach((e=>{e!==t&&(e.isSelected=!1,e.cancelHighlight())}))):t===this.plane&&this.selectedPoint&&(this.selectedPoint.isSelected=!1,this.selectedPoint.cancelHighlight(),this.selectedPoint=null,this.cancelEditPoint()))}))}init(){this.editingPoints=[];const e=this.getConfig().points.map((e=>new THREE.Vector3(e.x,e.y,e.z))),t=(new THREE.Box3).setFromPoints(e);e.forEach(((e,t)=>{const i=new r.Interaction.Item.EditingPoint({helper:this.helper,control:this,name:"EditingPoint",point:e});this.add(i),this.editingPoints.push(i)})),this.addPlane(e),this.addTranslateControl(t),this.addPointTranslateControl()}addPlane(e){this.plane=new r.Interaction.Item.Plane({helper:this.helper,control:this,name:"EditingPlane",points:e,color:"#FFF227",edgeColor:"#FFF227"}),this.plane.enable(!1),this.add(this.plane)}addTranslateControl(e){this.translateControlId=`${this.controlId}_Translate`;const t=this.center=new THREE.Vector3;e.getCenter(t),this.translateControl=this.helper.addControl(this.translateControlId,"TranslateControl",{position:t,boundingBox:e,hitTestPriority:2}),this.addHelperEvent("TransformChanged",(({id:e,control:t})=>{if(e===this.translateControlId){const{x:e,y:i,z:r}=t.position.clone().sub(this.center);this.position.set(e,i,r),this.updateScaleFactor(),this.updateMatrixWorld()}if(e===this.pointTranslateControlId){const{x:e,y:i}=t.position.clone().sub(this.position);this.selectedPoint.position.set(e,i,this.selectedPoint.position.z),this.selectedPoint.updateMatrixWorld();const r=this.editingPoints.map((e=>e.position.clone()));this.plane.update(r),this.updateScaleFactor(),this.updateMatrixWorld()}}))}addPointTranslateControl(){this.pointTranslateControlId=`${this.controlId}_PointTranslate`,this.pointTranslateControl=this.helper.addControl(this.pointTranslateControlId,"TranslateControl",{visible:!1,hitTestPriority:2});const e=["PlaneX","PlaneY","AxisZ"];this.pointTranslateControl.children.forEach((t=>{e.indexOf(t.name)>=0&&(t.enable(!1),t.visible=!1)}))}editPoint(e){this.translateControl.visible=!1,this.pointTranslateControl.visible=!0,this.pointTranslateControl.setPosition(e.position.clone().add(this.position)),this.pointTranslateControl.updateScaleFactor(),this.plane.enable(!0),this.getViewer().render()}cancelEditPoint(){this.translateControl.visible=!0,this.pointTranslateControl.visible=!1;const e=this.editingPoints.map((e=>e.position.clone().add(this.position))),t=(new THREE.Box3).setFromPoints(e),i=new THREE.Vector3;t.getCenter(i),this.center=i.clone().sub(this.position),this.translateControl.setPosition(i),this.translateControl.updateBoundingBox(t),this.translateControl.updateScaleFactor(),this.plane.cancelHighlight(),this.plane.enable(!1),this.getViewer().render()}transform(e){}updateScaleFactor(e){let t,i;e?(t=e.cameraPosition,i=e.cameraFov):(t=this.getViewer().camera.position.clone().applyMatrix4(this.helper.invertMatrix),i=this.getViewer().camera.fov),this.editingPoints.forEach((e=>e.updateScaleFactor(t,i)))}getPointsData(){return this.editingPoints.map((e=>e.position.clone().add(this.position)))}setPoints(e){if(!e||!Array.isArray(e)||e.length!==this.editingPoints.length)return;e.forEach(((e,t)=>{const i=this.editingPoints[t];i.position.set(e.x-this.position.x,e.y-this.position.y,e.z-this.position.z),i.updateMatrixWorld()}));const t=this.editingPoints.map((e=>e.position.clone()));this.plane.update(t),this.updateScaleFactor(),this.updateMatrixWorld(),!0===this.translateControl.visible?this.cancelEditPoint():!0===this.pointTranslateControl.visible&&this.selectedPoint&&this.editPoint(this.selectedPoint)}destroy(){this.pointTranslateControl.destroy(),this.translateControl.destroy(),super.destroy()}}r.Interaction=r.Interaction||{},r.Interaction.Control=r.Interaction.Control||{},r.Interaction.Control.PolygonControl=e})(),(()=>{class e extends r.Interaction.Control.BaseControl{constructor(e){super(e),this.name="LineControl",this.isEditPointMode=!1,this.addHelperEvent("CameraChanged",(e=>this.updateScaleFactor(e))),this.addHelperEvent("Clicked",(({id:e,object:t})=>{this.selectedObject=null,e===this.controlId&&(this.editingPoints.indexOf(t)>=0?(t!==this.selectedObject&&(t.isSelected=!0,this.selectedPoint=t,t.setHighlight(),this.editPoint(t)),this.editingPoints.forEach((e=>{e!==t&&(e.isSelected=!1,e.cancelHighlight())}))):t===this.curveLine&&this.selectedPoint&&(this.selectedPoint.isSelected=!1,this.selectedPoint.cancelHighlight(),this.selectedPoint=null,this.cancelEditPoint()))}))}init(){this.editingPoints=[];const e=this.getConfig().points.map((e=>new THREE.Vector3(e.x,e.y,e.z))),t=(new THREE.Box3).setFromPoints(e);e.forEach(((e,t)=>{const i=new r.Interaction.Item.EditingPoint({helper:this.helper,control:this,name:"EditingPoint",point:e});this.add(i),this.editingPoints.push(i)})),this.addCurveLine(e),this.addTranslateControl(t),this.addPointTranslateControl()}addCurveLine(e){this.curveLine=new r.Interaction.Item.Curve({helper:this.helper,control:this,name:"CurveLine",points:e,color:"#FFF227"}),this.curveLine.enable(!1),this.add(this.curveLine)}addTranslateControl(e){this.translateControlId=`${this.controlId}_Translate`;const t=this.center=new THREE.Vector3;e.getCenter(t),this.translateControl=this.helper.addControl(this.translateControlId,"TranslateControl",{position:t,boundingBox:e,hitTestPriority:2}),this.addHelperEvent("TransformChanged",(({id:e,control:t})=>{if(e===this.translateControlId){const{x:e,y:i,z:r}=t.position.clone().sub(this.center);this.position.set(e,i,r),this.updateScaleFactor(),this.updateMatrixWorld()}if(e===this.pointTranslateControlId){const{x:e,y:i,z:r}=t.position.clone().sub(this.position);this.selectedPoint.position.set(e,i,r),this.selectedPoint.updateMatrixWorld();const a=this.editingPoints.map((e=>e.position.clone()));this.curveLine.update(a),this.updateScaleFactor(),this.updateMatrixWorld()}}))}addPointTranslateControl(){this.pointTranslateControlId=`${this.controlId}_PointTranslate`,this.pointTranslateControl=this.helper.addControl(this.pointTranslateControlId,"TranslateControl",{visible:!1,hitTestPriority:2})}editPoint(e){this.translateControl.visible=!1,this.pointTranslateControl.visible=!0,this.pointTranslateControl.setPosition(e.position.clone().add(this.position)),this.pointTranslateControl.updateScaleFactor(),this.curveLine.enable(!0),this.getViewer().render()}cancelEditPoint(){this.translateControl.visible=!0,this.pointTranslateControl.visible=!1;const e=this.editingPoints.map((e=>e.position.clone().add(this.position))),t=(new THREE.Box3).setFromPoints(e),i=new THREE.Vector3;t.getCenter(i),this.center=i.clone().sub(this.position),this.translateControl.setPosition(i),this.translateControl.updateBoundingBox(t),this.translateControl.updateScaleFactor(),this.curveLine.cancelHighlight(),this.curveLine.enable(!1),this.getViewer().render()}transform(e){}updateScaleFactor(e){let t,i;e?(t=e.cameraPosition,i=e.cameraFov):(t=this.getViewer().camera.position.clone().applyMatrix4(this.helper.invertMatrix),i=this.getViewer().camera.fov),this.editingPoints.forEach((e=>e.updateScaleFactor(t,i))),this.updateCurveRigidTimeout&&(clearTimeout(this.updateCurveRigidTimeout),this.updateCurveRigidTimeout=null),this.updateCurveRigidTimeout=setTimeout((()=>{this.curveLine.updateScaleFactor(t,i)}),200)}getPointsData(){return this.editingPoints.map((e=>e.position.clone().add(this.position)))}destroy(){this.pointTranslateControl.destroy(),this.translateControl.destroy(),super.destroy()}}r.Interaction=r.Interaction||{},r.Interaction.Control=r.Interaction.Control||{},r.Interaction.Control.LineControl=e})(),(()=>{class e extends r.Interaction.Control.BaseControl{constructor(e){super(e),this.name="CircleControl",this.drawAngle="boolean"!=typeof e.drawAngle||e.drawAngle,this.addHelperEvent("CameraChanged",(e=>this.updateScaleFactor(e))),this.addHelperEvent("Clicked",(({event:e})=>{}))}init(){this.drawAngle="boolean"!=typeof this._config.drawAngle||this._config.drawAngle,this.basePosition=new THREE.Vector3(0,0,0),this.editingPoints=[];let{center:e,radius:t,thetaStart:i,thetaLength:a}=this.getConfig();this.radius=t,i=this.thetaStart=i||0,a=this.thetaLength=a||Math.PI/3,this.position.set(e.x,e.y,e.z);const n=this.pointCenter=new r.Interaction.Item.EditingPoint({helper:this.helper,control:this,name:"EditingPointCenter",point:this.basePosition,enableAnimation:!1,showText:!1});if(this.add(n),this.editingPoints.push(n),this.drawAngle){const e=this.pointStart=new r.Interaction.Item.EditingPoint({helper:this.helper,control:this,name:"EditingPointStart",point:new THREE.Vector3(t,0,0).applyAxisAngle(new THREE.Vector3(0,0,1),i),showText:!1});this.add(e),this.editingPoints.push(e);const n=()=>{this.editingSector&&(this.editingSector.visible=!1),this.circleSector&&this.circleSector.update(this.basePosition,this.radius,this.thetaStart,this.thetaLength),this.translateControl&&(this.translateControl.visible=!0),this.getViewer().render()};e.transform=t=>{this.updateSectorByPoint(e,t)},e.transformFinished=n;const s=this.pointEnd=new r.Interaction.Item.EditingPoint({helper:this.helper,control:this,name:"EditingPointEnd",point:new THREE.Vector3(t,0,0).applyAxisAngle(new THREE.Vector3(0,0,1),i+a),showText:!1});this.add(s),this.editingPoints.push(s),s.transform=e=>{this.updateSectorByPoint(s,e)},s.transformFinished=n}const s=this.circle=new r.Interaction.Item.Circle({helper:this.helper,control:this,name:"Circle",center:this.basePosition,radius:t,color:"#FFF227",edgeColor:"#FFFFFF",opacity:.1,hitTestEdge:!0});if(this.add(s),s.transform=e=>{this.updateRadius(e)},s.transformFinished=()=>{this.translateControl&&(this.translateControl.visible=!0),this.getViewer().render()},this.drawAngle){const e=this.circleSector=new r.Interaction.Item.Circle({helper:this.helper,control:this,name:"CircleSector",center:this.basePosition,radius:t,color:"#FFF227",edgeColor:"#FFF227",opacity:.26,thetaStart:i,thetaLength:a});this.add(e);const n=this.editingSector=new r.Interaction.Item.Circle({helper:this.helper,control:this,name:"EditingSector",center:this.basePosition,radius:t,color:"#FFF227",edgeColor:"#FFF227",opacity:.26,thetaStart:i,thetaLength:a,enableAnimation:!1});this.add(n),n.visible=!1;const s=this.sectorAngle=new r.Interaction.Item.SectorAngle({helper:this.helper,control:this,name:"SectorAngle",center:this.basePosition,radius:t,thetaStart:i,thetaLength:a});this.add(s)}this.addTranslateControl(e)}updateScaleFactor(e){let t,i;e?(t=e.cameraPosition,i=e.cameraFov):(t=this.getViewer().camera.position.clone().applyMatrix4(this.helper.invertMatrix),i=this.getViewer().camera.fov),this.editingPoints.forEach((e=>e.updateScaleFactor(t,i))),this.sectorAngle&&this.sectorAngle.updateScaleFactor(t,i),this.updateCicleRigidTimeout&&(clearTimeout(this.updateCicleRigidTimeout),this.updateCicleRigidTimeout=null),this.updateCicleRigidTimeout=setTimeout((()=>{this.circle.updateScaleFactor(t,i)}),200)}addTranslateControl(e){this.translateControlId=`${this.controlId}_Translate`,this.translateControl=this.helper.addControl(this.translateControlId,"TranslateControl",{position:e,hitTestPriority:2}),this.addHelperEvent("TransformChanged",(({id:e,control:t})=>{if(e===this.translateControlId){const{x:e,y:i,z:r}=t.position.clone();this.position.set(e,i,r),this.drawAngle&&this.updateScaleFactor(),this.updateMatrixWorld()}}))}getIntersectPosition(e){const t=this.getViewer().cameraControl.getRaycaster(e.x,e.y),i=this.getViewer().drawingToWorld(t.ray.direction).normalize(),r=new THREE.Vector3(0,0,1),a=new THREE.Plane(r),n=this.getViewer().drawingToWorld(this.getViewer().camera.position.clone()),s=-a.distanceToPoint(this.position);a.set(r,s);const o=new THREE.Ray(n,i),l=new THREE.Vector3;return o.intersectPlane(a,l),l}updateRadius(e){this.translateControl.visible=!1;const t=this.getIntersectPosition(e).clone().sub(this.position).length();this.setRadius(t)}updateSectorByPoint(e,t){this.translateControl.visible=!1;const i=this.getIntersectPosition(t).clone().sub(this.position).normalize().multiplyScalar(this.radius);if(e.position.set(i.x,i.y,i.z),e.updateMatrixWorld(),this.editingSector){this.editingSector.visible=!0;const e=this.thetaStart=new THREE.Vector2(this.pointStart.position.x,this.pointStart.position.y).angle();let t=new THREE.Vector2(this.pointEnd.position.x,this.pointEnd.position.y).angle()-e;t<0&&(t+=2*Math.PI),this.thetaLength=t,this.editingSector.update(this.basePosition,this.radius,e,t),this.sectorAngle&&this.sectorAngle.update(this.basePosition,this.radius,e,t)}this.getViewer().render()}setPosition(e){this.position.set(e.x,e.y,e.z),this.updateMatrixWorld(),this.translateControl.setPosition(e),this.getViewer().render()}setRadius(e){if(this.radius=e,this.pointStart){const t=new THREE.Vector3(e,0,0).applyAxisAngle(new THREE.Vector3(0,0,1),this.thetaStart);this.pointStart.position.set(t.x,t.y,t.z),this.pointStart.updateMatrixWorld()}if(this.pointEnd){const t=new THREE.Vector3(e,0,0).applyAxisAngle(new THREE.Vector3(0,0,1),this.thetaStart+this.thetaLength);this.pointEnd.position.set(t.x,t.y,t.z),this.pointEnd.updateMatrixWorld()}this.circle.update(this.basePosition,e),this.circleSector&&this.circleSector.update(this.basePosition,e,this.thetaStart,this.thetaLength),this.drawAngle&&(this.editingSector.update(this.basePosition,e,this.thetaStart,this.thetaLength),this.sectorAngle.radius=e,this.sectorAngle.updateScaleFactor()),this.getViewer().render()}setThetaLength(e){e>2*Math.PI&&(e=2*Math.PI),this.thetaLength=e;const t=this.thetaStart=new THREE.Vector2(this.pointStart.position.x,this.pointStart.position.y).angle(),i=t+e,r=new THREE.Vector3(1,0,0).applyAxisAngle(new THREE.Vector3(0,0,1),i).multiplyScalar(this.radius);this.pointEnd.position.set(r.x,r.y,r.z),this.pointEnd.updateMatrixWorld(),this.circleSector&&this.circleSector.update(this.basePosition,this.radius,t,e),this.sectorAngle&&this.sectorAngle.update(this.basePosition,this.radius,t,e),this.getViewer().render()}getCircleData(){return{center:this.position.clone(),radius:this.radius,thetaStart:this.thetaStart,thetaLength:this.thetaLength}}hitTest(e){if(!this.visible)return;const t=[...this.editingPoints,this.circle];let i=null;return t.some((t=>{if(!t.isEnabled)return!1;const r=t.hitTest(e);return r&&(i=t),r})),this.hoveredObject=i,i===this.circle?(this.circle.setHighlight(),this.circleSector&&this.circleSector.setHighlight(),this.editingPoints.forEach((e=>e.cancelHighlight()))):(this.circle.cancelHighlight(),this.circleSector&&this.circleSector.cancelHighlight(),this.editingPoints.forEach((e=>{e===i?e.setHighlight():e.cancelHighlight()}))),!!this.hoveredObject}destroy(){this.translateControl.destroy(),super.destroy()}}r.Interaction=r.Interaction||{},r.Interaction.Control=r.Interaction.Control||{},r.Interaction.Control.CircleControl=e})(),(()=>{class e extends THREE.Object3D{constructor(e){super(),this._config=e,this.controlId=e.id,this.helper=e.helper,this.helperEvents={},this.name="DrawPolygonControl",this.editingPoints=[],this.finished=!1,this.addHelperEvent("CameraChanged",(e=>this.updateScaleFactor(e)));let t=null;this.addHelperEvent("MouseDown",(({event:e})=>{this.finished||(this._isMousePressed=!0,this._isClick=!0,t={clientX:e.clientX,clientY:e.clientY})})),this.addHelperEvent("MouseMove",(({event:e})=>{if(!this.finished&&(this._isMousePressed&&this._isClick&&(t&&Math.abs(e.clientX-t.clientX)<2&&Math.abs(e.clientY-t.clientY)<2||(this._isClick=!1)),this.editingPoints.length>0)){const e=this.getPointByRayCaster();e&&this.updateByMove(e),this.helper.viewer.render()}})),this.addHelperEvent("MouseUp",(({event:e})=>{if(!this.finished){if(this._isMousePressed&&this._isClick){if(2===e.button)return this.finished=!0,this.editingPoints.length>2?(this.showPolygon(this.getPoints()),this.helper.dispatchEvent({type:"DrawFinished",control:this,id:this.controlId})):this.reset(),delete this._isMousePressed,delete this._isClick,void(t=null);const i=this.getPointByRayCaster();i&&this.addEditingPoint(i)}delete this._isMousePressed,delete this._isClick,t=null}}))}addHelperEvent(e,t){this.helperEvents[e]=t,this.helper.addEventListener(e,t)}getPoints(){return this.editingPoints.map((e=>e.position.clone()))}addEditingPoint(e){0===this.editingPoints.length&&(this.planeZ=e.z);const t=new r.Interaction.Item.EditingPoint({helper:this.helper,control:this,name:"EditingPoint",point:{...e,z:this.planeZ},enableAnimation:!1});this.add(t),this.editingPoints.push(t),this.showPolygon(this.getPoints()),this.updateMatrixWorld()}updateByMove(e){const t=this.getPoints();t.push({...e,z:this.planeZ}),this.showPolygon(t),this.updateMatrixWorld()}showPolygon(e){if(!e||e.length<2)return;const t=2===e.length?e:[...e,e[0]];this.planeEdge?this.planeEdge.update(t):(this.planeEdge=new r.Interaction.Item.Line({helper:this.helper,control:this,name:"EditingPlaneEdge",points:t,color:"#FFF227"}),this.add(this.planeEdge)),e.length<3||(this.plane?this.plane.update(e):(this.plane=new r.Interaction.Item.Plane({helper:this.helper,control:this,name:"EditingPlane",points:e,color:"#FFF227",edgeColor:"#FFF227",enableAnimation:!1}),this.add(this.plane)))}getPointByRayCaster(){const e=this.helper.raycaster,t=e.ray.origin.clone().applyMatrix4(this.helper.invertMatrix),i=e.ray.direction.clone().applyMatrix4(this.helper.invertMatrix).normalize(),r=this.helper.viewer.getComponentsByRaycaster(t,i,[]);if(!r||0===r.length)return null;const a=r[0].position;return new THREE.Vector3(a.x,a.y,a.z)}updateScaleFactor(e){let t,i;e?(t=e.cameraPosition,i=e.cameraFov):(t=this.getViewer().camera.position.clone().applyMatrix4(this.helper.invertMatrix),i=this.getViewer().camera.fov),this.editingPoints.forEach((e=>e.updateScaleFactor(t,i)))}clear(){for(;this.children.length>0;)this.children[0].destroy();this.editingPoints=[],this.plane=null,this.planeEdge=null}reset(){this.clear(),this.finished=!1}getPointsData(){return this.editingPoints.map((e=>e.position.clone().add(this.position)))}destroy(){Object.entries(this.helperEvents).forEach((([e,t])=>{this.helper.removeEventListener(e,t)})),this.clear(),this.helper.remove(this),this.helper.viewer.render()}}r.Interaction=r.Interaction||{},r.Interaction.Control=r.Interaction.Control||{},r.Interaction.Control.DrawPolygonControl=e})(),(()=>{class e extends THREE.Object3D{constructor(e){super(),this._config=e,this.controlId=e.id,this.helper=e.helper,this.helperEvents={},this.name="DrawLineControl",this.editingPoints=[],this.finished=!1,this.autoClose=e.autoClose||!1,this.autoClosePix=e.autoClosePix?e.autoClosePix:4,this.isCurve=void 0===e.isCurve||e.isCurve,this.addHelperEvent("CameraChanged",(e=>this.updateScaleFactor(e)));let t=null;this.addHelperEvent("MouseDown",(({event:e})=>{this.finished||(this._isMousePressed=!0,this._isClick=!0,t={clientX:e.clientX,clientY:e.clientY})})),this.addHelperEvent("MouseMove",(({event:e})=>{if(!this.finished&&(this._isMousePressed&&this._isClick&&(t&&Math.abs(e.clientX-t.clientX)<2&&Math.abs(e.clientY-t.clientY)<2||(this._isClick=!1)),this.editingPoints.length>0)){let e=this.getPointByRayCaster();this._initPoint&&(e=this.autoClosePoint(e,!1)),e&&this.updateByMove(e),this.helper.viewer.render()}})),this.addHelperEvent("MouseUp",(({event:e})=>{if(!this.finished){if(this._isMousePressed&&this._isClick){if(2===e.button)return this.finished=!0,this.editingPoints.length>1?(this.isCurve?this.showCurveLine(this.getPoints()):this.showLine(this.getPoints()),this.helper.dispatchEvent({type:"DrawFinished",control:this,id:this.controlId})):this.reset(),delete this._isMousePressed,delete this._isClick,void(t=null);const i=this.getPointByRayCaster();i&&this.addEditingPoint(i),this._autoCloseFinished&&(this.helper.dispatchEvent({type:"DrawFinished",control:this,id:this.controlId}),delete this._autoCloseFinished,delete this._initPoint)}delete this._isMousePressed,delete this._isClick,t=null}}))}addHelperEvent(e,t){this.helperEvents[e]=t,this.helper.addEventListener(e,t)}getPoints(){return this.editingPoints.map((e=>e.position.clone()))}autoClosePoint(e,t=!1){const i=this.helper.viewer.worldToClient(this._initPoint),r=this.helper.viewer.worldToClient(e);return Math.abs(i.x-r.x)<this.autoClosePix&&Math.abs(i.y-r.y)<this.autoClosePix?(t&&(this._autoCloseFinished=!0),this._initPoint):e}addEditingPoint(e){this._initPoint&&this.editingPoints.length>2&&(e=this.autoClosePoint(e,!0));const t=new r.Interaction.Item.EditingPoint({helper:this.helper,control:this,name:"EditingPoint",point:e,enableAnimation:!1});this.add(t),this.editingPoints.push(t),this.isCurve?this.showCurveLine(this.getPoints()):this.showLine(this.getPoints()),this.autoClose&&1==this.editingPoints.length&&(this._initPoint=e),this.updateMatrixWorld()}updateByMove(e){const t=this.getPoints();t.push(e),this.isCurve?this.showCurveLine(t):this.showLine(t),this.updateMatrixWorld()}showCurveLine(e){!e||e.length<2||(this.curveLine?this.curveLine.update(e):(this.curveLine=new r.Interaction.Item.Curve({helper:this.helper,control:this,name:"CurveLine",points:e,color:"#FFF227",enableAnimation:!1}),this.add(this.curveLine)))}showLine(e){!e||e.length<2||(this.curveLine?this.curveLine.update(e):(this.curveLine=new r.Interaction.Item.Line({helper:this.helper,control:this,name:"Line",points:e,color:"#FFF227",enableAnimation:!1}),this.add(this.curveLine)))}getPointByRayCaster(){const e=this.helper.raycaster,t=e.ray.origin.clone().applyMatrix4(this.helper.invertMatrix),i=e.ray.direction.clone().applyMatrix4(this.helper.invertMatrix).normalize(),r=this.helper.viewer.getComponentsByRaycaster(t,i,[]);if(!r||0===r.length)return null;const a=r[0].position;return new THREE.Vector3(a.x,a.y,a.z)}updateScaleFactor(e){let t,i;e?(t=e.cameraPosition,i=e.cameraFov):(t=this.getViewer().camera.position.clone().applyMatrix4(this.helper.invertMatrix),i=this.getViewer().camera.fov),this.editingPoints.forEach((e=>e.updateScaleFactor(t,i)))}clear(){for(;this.children.length>0;)this.children[0].destroy();this.editingPoints=[],this.curveLine=null}reset(){this.clear(),this.finished=!1}getPointsData(){return this.editingPoints.map((e=>e.position.clone().add(this.position)))}destroy(){Object.entries(this.helperEvents).forEach((([e,t])=>{this.helper.removeEventListener(e,t)})),this.clear(),this.helper.remove(this),this.helper.viewer.render()}}r.Interaction=r.Interaction||{},r.Interaction.Control=r.Interaction.Control||{},r.Interaction.Control.DrawLineControl=e})(),(()=>{class e extends THREE.Object3D{constructor(e){super(),this._config=e,this.controlId=e.id,this.helper=e.helper,this.helperEvents={},this.name="DrawCircleControl",this.editingPoints=[],this.finished=!1,this.thetaLength=Math.PI/3,this.drawAngle="boolean"!=typeof e.drawAngle||e.drawAngle,this.addHelperEvent("CameraChanged",(e=>this.updateScaleFactor(e)));let t=null;this.addHelperEvent("MouseDown",(({event:e})=>{this.finished||(this._isMousePressed=!0,this._isClick=!0,t={clientX:e.clientX,clientY:e.clientY})})),this.addHelperEvent("MouseMove",(({event:e})=>{if(!this.finished&&(this._isMousePressed&&this._isClick&&(t&&Math.abs(e.clientX-t.clientX)<2&&Math.abs(e.clientY-t.clientY)<2||(this._isClick=!1)),this.editingPoints.length>0)){const e=this.getPointByRayCaster();e&&this.updateByMove(e),this.helper.viewer.render()}})),this.addHelperEvent("MouseUp",(({event:e})=>{if(!this.finished){if(this._isMousePressed&&this._isClick){if(2===e.button)return this.finished=!0,this.editingPoints.length>1?(this.showCircle(this.getPoints()),this.helper.dispatchEvent({type:"DrawFinished",control:this,id:this.controlId})):this.reset(),delete this._isMousePressed,delete this._isClick,void(t=null);const i=this.getPointByRayCaster();i&&this.addEditingPoint(i);2===this.getPoints().length&&(this.finished=!0,this.showCircle(this.getPoints()),this.helper.dispatchEvent({type:"DrawFinished",control:this,id:this.controlId}))}delete this._isMousePressed,delete this._isClick,t=null}}))}addHelperEvent(e,t){this.helperEvents[e]=t,this.helper.addEventListener(e,t)}getPoints(){return this.editingPoints.map((e=>e.position.clone()))}addEditingPoint(e){0===this.editingPoints.length&&(this.planeZ=e.z);const t=new r.Interaction.Item.EditingPoint({helper:this.helper,control:this,name:"EditingPoint",point:{...e,z:this.planeZ},enableAnimation:!1});this.add(t),this.editingPoints.push(t),this.showCircle(this.getPoints()),this.updateMatrixWorld()}updateByMove(e){const t=this.getPoints();t.push(new THREE.Vector3(e.x,e.y,this.planeZ)),this.showCircle(t),this.updateMatrixWorld()}showCircle(e){if(!e||e.length<2)return;const t=this.center=e[0],i=e[1].clone().sub(t),a=this.radius=i.length(),n=this.thetaStart=new THREE.Vector2(i.x,i.y).angle(),s=i.clone().applyAxisAngle(new THREE.Vector3(0,0,1),this.thetaLength).add(t);if(this.circle)this.circle.update(t,a),this.drawAngle&&(this.circleSector.update(t,a,n,this.thetaLength),this.sectorAngle.update(t,a,n,this.thetaLength));else if(this.circle=new r.Interaction.Item.Circle({helper:this.helper,control:this,name:"Circle",center:t,radius:a,color:"#FFF227",edgeColor:"#FFFFFF",opacity:.1,enableAnimation:!1}),this.add(this.circle),this.drawAngle){this.circleSector=new r.Interaction.Item.Circle({helper:this.helper,control:this,name:"CircleSector",center:t,radius:a,color:"#FFF227",edgeColor:"#FFF227",opacity:.26,thetaStart:n,thetaLength:this.thetaLength,enableAnimation:!1}),this.add(this.circleSector);const e=this.sectorAngle=new r.Interaction.Item.SectorAngle({helper:this.helper,control:this,name:"SectorAngle",center:t,radius:a,thetaStart:n,thetaLength:this.thetaLength});this.add(e)}2===this.editingPoints.length&&(this.editingPointEnd=new r.Interaction.Item.EditingPoint({helper:this.helper,control:this,name:"EditingPointEnd",point:s,enableAnimation:!1}),this.add(this.editingPointEnd))}getPointByRayCaster(){const e=this.helper.raycaster,t=e.ray.origin.clone().applyMatrix4(this.helper.invertMatrix),i=e.ray.direction.clone().applyMatrix4(this.helper.invertMatrix).normalize(),r=this.helper.viewer.getComponentsByRaycaster(t,i,[]);if(!r||0===r.length)return null;const a=r[0].position;return new THREE.Vector3(a.x,a.y,a.z)}updateScaleFactor(e){let t,i;e?(t=e.cameraPosition,i=e.cameraFov):(t=this.getViewer().camera.position.clone().applyMatrix4(this.helper.invertMatrix),i=this.getViewer().camera.fov),this.editingPoints.forEach((e=>e.updateScaleFactor(t,i))),this.editingPointEnd&&this.editingPointEnd.updateScaleFactor(t,i),this.sectorAngle&&this.sectorAngle.updateScaleFactor(t,i)}clear(){for(;this.children.length>0;)this.children[0].destroy();this.editingPoints=[],this.circle=null,this.circleSector=null,this.sectorAngle=null}reset(){this.clear(),this.finished=!1}getCircleData(){return this.finished?{center:this.center,radius:this.radius,thetaStart:this.thetaStart,thetaLength:this.thetaLength}:null}destroy(){Object.entries(this.helperEvents).forEach((([e,t])=>{this.helper.removeEventListener(e,t)})),this.clear(),this.helper.remove(this),this.helper.viewer.render()}}r.Interaction=r.Interaction||{},r.Interaction.Control=r.Interaction.Control||{},r.Interaction.Control.DrawCircleControl=e})(),(()=>{class e extends THREE.Object3D{constructor(e){super(),this._config=e,this.controlId=e.id,this.helper=e.helper,this.helperEvents={},this.name="DrawSurfaceControl",this.editingPoints=[],this.finished=!1,this.addHelperEvent("CameraChanged",(e=>this.updateScaleFactor(e)));let t=null;this.addHelperEvent("MouseDown",(({event:e})=>{this.finished||(this._isMousePressed=!0,this._isClick=!0,t={clientX:e.clientX,clientY:e.clientY})})),this.addHelperEvent("MouseMove",(({event:e})=>{if(!this.finished&&(this._isMousePressed&&this._isClick&&(t&&Math.abs(e.clientX-t.clientX)<2&&Math.abs(e.clientY-t.clientY)<2||(this._isClick=!1)),this.editingPoints.length>0)){const e=this.getPointByRayCaster();e&&this.updateByMove(e),this.helper.viewer.render()}})),this.addHelperEvent("MouseUp",(({event:e})=>{if(!this.finished){if(this._isMousePressed&&this._isClick){if(2===e.button)return this.finished=!0,this.editingPoints.length>2?(this.showSurface(this.getPoints()),this.helper.dispatchEvent({type:"DrawFinished",control:this,id:this.controlId})):this.reset(),delete this._isMousePressed,delete this._isClick,void(t=null);const i=this.getPointByRayCaster();i&&this.addEditingPoint(i)}delete this._isMousePressed,delete this._isClick,t=null}}))}addHelperEvent(e,t){this.helperEvents[e]=t,this.helper.addEventListener(e,t)}getPointByRayCaster(){const e=this.helper.raycaster,t=e.ray.origin.clone().applyMatrix4(this.helper.invertMatrix),i=e.ray.direction.clone().applyMatrix4(this.helper.invertMatrix).normalize(),r=this.helper.viewer.getComponentsByRaycaster(t,i,[]);if(!r||0===r.length)return null;const a=r[0].position;return new THREE.Vector3(a.x,a.y,a.z)}updateScaleFactor(e){let t,i;e?(t=e.cameraPosition,i=e.cameraFov):(t=this.getViewer().camera.position.clone().applyMatrix4(this.helper.invertMatrix),i=this.getViewer().camera.fov),this.editingPoints.forEach((e=>e.updateScaleFactor(t,i)))}getPoints(){return this.editingPoints.map((e=>e.position.clone()))}getPointsData(){return this.editingPoints.map((e=>e.position.clone().add(this.position)))}getMaxZ(){let e=Number.NEGATIVE_INFINITY;return this.getPointsData().forEach((t=>{t.z>e&&(e=t.z)})),e}updateByMove(e){const t=this.getPoints();t.push(e),this.showSurface(t),this.updateMatrixWorld()}showSurface(e){if(!e||e.length<2)return;const t=2===e.length?e:[...e,e[0]];this.planeEdge?(e=[...e,e[0]],this.planeEdge.geometry.updateGeometry({points:e})):(this.planeEdge=r.GroundPrimitiveManager.getInstance().createGroundCurve({helper:this.helper,control:this,points:t,name:"EditingSurfacePlaneEdge",color:new Glodon.Web.Graphics.Color("#FFF227",1),width:1.5,style:"Continuous",type:"polyline"}),this.planeEdge.onAdded()),e.length<3||(this.surface?this.surface.geometry.updateGeometry({points:e}):(this.surface=r.GroundPrimitiveManager.getInstance().createGroundPolygon({helper:this.helper,control:this,name:"EditingSurfacePlane",points:e,color:new Glodon.Web.Graphics.Color("#FFF227",.5)}),this.surface.onAdded()))}disposeSurface(){this.surface&&(this.surface.onRemoved(),this.surface.dispose(),this.surface=null)}disposePlaneEdge(){this.planeEdge&&(this.planeEdge.onRemoved(),this.planeEdge.dispose(),this.planeEdge=null)}clear(){for(;this.children.length>0;)this.children[0].destroy();this.editingPoints=[],this.disposeSurface(),this.disposePlaneEdge()}reset(){this.clear(),this.finished=!1}addEditingPoint(e){const t=new r.Interaction.Item.EditingPoint({helper:this.helper,control:this,name:"EditingPoint",point:e,enableAnimation:!1});this.add(t),this.editingPoints.push(t),this.showSurface(this.getPoints()),this.updateMatrixWorld()}destroy(){Object.entries(this.helperEvents).forEach((([e,t])=>{this.helper.removeEventListener(e,t)})),this.clear(),this.helper.remove(this),this.helper.viewer.render()}}r.Interaction=r.Interaction||{},r.Interaction.Control=r.Interaction.Control||{},r.Interaction.Control.DrawSurfaceControl=e})(),(()=>{class e extends r.Interaction.Control.BaseControl{constructor(e){super(e),this.name="SurfaceControl",this.addHelperEvent("CameraChanged",(e=>this.updateScaleFactor(e))),this.addHelperEvent("Clicked",(({id:e,object:t})=>{this.selectedObject=null,e===this.controlId&&(this.editingPoints.indexOf(t)>=0?(t!==this.selectedObject&&(t.isSelected=!0,this.selectedPoint=t,t.setHighlight(),this.editPoint(t)),this.editingPoints.forEach((e=>{e!==t&&(e.isSelected=!1,e.cancelHighlight())}))):t===this.airPlane&&this.selectedPoint&&(this.selectedPoint.isSelected=!1,this.selectedPoint.cancelHighlight(),this.selectedPoint=null,this.cancelEditPoint()))}))}init(e){this.editingPoints=[],this.isEditingFlap=!0,this.maxZ=null==this.maxZ?this._config.maxZ:this.maxZ;const t=e||this.getConfig().points.map((e=>new THREE.Vector3(e.x,e.y,e.z))),i=this.getMaxHeightPoints(t),r=(new THREE.Box3).setFromPoints(i);this.points=this._config.hidePlane?t:i,this.lowPoints=JSON.parse(JSON.stringify(t)),this._config.hidePlane||this.addPlane(t),this.addPointTranslateControl(),this._config.streching?this.addSurfaceStrechControl(r,t):(!this._config.hidePlane&&this.addPlaneEdge(t),this.addPoints(t))}setPoints(e){if(this.pointTranslateControl.destroy(),this.strechControl&&this.strechControl.destroy(),this.plane&&this.plane.onRemoved(),this.planeEdge&&this.planeEdge.onRemoved(),this.facade&&(this.remove(this.facade),this.remove(this.airPlane),this.facade.destroy(),this.airPlane&&this.airPlane.destroy(),this.facade=null,this.airPlane=null,this.strechControl=null),this.selectedPoint&&(this.selectedPoint.isSelected=!1,this.selectedPoint.cancelHighlight(),this.selectedPoint=null),this.removePoints(),this.init(e),this._config.streching){const t=this.getMaxHeightPoints(e);this.points=t,this.strechControl&&requestAnimationFrame((()=>{this.strechControl.visible=!1})),this.addPoints(t)}this.updateMatrixWorld()}addPoints(e){e.forEach(((t,i)=>{if(this._config.hidePlane&&i==e.length-1&&JSON.stringify(t)==JSON.stringify(e[0]))return void(this.autoClosed=!0);const a=new r.Interaction.Item.EditingPoint({helper:this.helper,control:this,name:"EditingPoint",point:t});this.add(a),this.editingPoints.push(a)})),this.points=e,this.updateScaleFactor(),this.updateMatrixWorld()}addPlaneEdge(e){this.planeEdge=r.GroundPrimitiveManager.getInstance().createGroundCurve({helper:this.helper,control:this,name:"EditingSurfacePlaneEdge",points:[...e,e[0]],color:new Glodon.Web.Graphics.Color("#FFF227",1),width:1.5,style:"Continuous",type:"polyline"}),this.planeEdge.onAdded()}addPlane(e){this.plane=r.GroundPrimitiveManager.getInstance().createGroundPolygon({helper:this.helper,control:this,name:"EditingSurfacePlane",points:e,color:new Glodon.Web.Graphics.Color("#FFF227",.5)}),this.plane.onAdded()}removePoints(){this.editingPoints.forEach((e=>this.remove(e))),this.editingPoints=[]}getCenter(e){const t=(new THREE.Box3).setFromPoints(e),i=new THREE.Vector3;return t.getCenter(i)}getGroundPointHeight(e,t){const i=new THREE.Vector3(e,t,1e4),r=new THREE.Vector3(0,0,-1);return this.helper.viewer.getComponentsByRaycaster(i,r,[])}addPointTranslateControl(){this.pointTranslateControlId=`${this.controlId}_PointTranslate`,this.pointTranslateControl=this.helper.addControl(this.pointTranslateControlId,"TranslateControl",{visible:!1,hitTestPriority:2});const e=["PlaneX","PlaneY","AxisZ"];this.pointTranslateControl.children.forEach((t=>{e.indexOf(t.name)>=0&&(t.enable(!1),t.visible=!1)})),this.addHelperEvent("TransformChanged",(({id:e,control:t})=>{if(e===this.pointTranslateControlId){const{x:e,y:i}=t.position.clone().sub(this.position);this.selectedPoint.position.set(e,i,this.selectedPoint.position.z),this.selectedPoint.updateMatrixWorld();const r=this.editingPoints.map((e=>e.position.clone()));if(this.plane&&this.plane.geometry.updateGeometry({points:r}),this.planeEdge){this.planeEdge.geometry.updateGeometry({points:[...r,r[0]]});const t=this.getGroundPointHeight(e,i);this.movingPointZ=t.length>0?t[0].position.z:0,this.selectedPoint.position.set(e,i,this.movingPointZ)}if(this.points=r,this._config.hidePlane){const e=JSON.parse(JSON.stringify(r)),t=[];e.forEach((e=>{e.z-=this.maxZ,t.push(e)})),this.lowPoints=this.autoClosed?[...t,t[0]]:t}if(this.airPlane&&this.airPlane.update(r),this.facade&&(this._config.hidePlane?this.facade.update(this.lowPoints,this.maxZ,!1):this.facade.update(r,this.maxZ)),this.strechControl){const e=this.getCenter(r);this.strechControl.setPosition(e)}}if(this.strechControl&&e===this.strechControlId){const{z:e}=t.position.clone();this.setCurrentHeight(e)}this.updateScaleFactor(),this.updateMatrixWorld()})),this.addHelperEvent("TransformFinished",(({id:e,control:t})=>{if(e===this.pointTranslateControlId&&this.planeEdge){const{x:e,y:i}=t.position.clone().sub(this.position);t.setPosition({x:e,y:i,z:this.movingPointZ})}}))}getCurrentHeight(){return this.maxZ}setCurrentHeight(e){this.maxZ=e;let t=[];if(this.editingPoints&&this.editingPoints.length>2?this.editingPoints.map((e=>{t.push(e.position.clone())})):t=this.points,t.forEach((t=>{t.z=e})),this.airPlane&&this.airPlane.update(t),this.facade&&(this._config.hidePlane?this.facade.update(this.lowPoints,e,!1):this.facade.update(t,e)),this.editingPoints&&this.editingPoints.forEach((t=>{t.position.z=e})),this.strechControl){const t=this.strechControl.getPosition();t.z=e,this.strechControl.setPosition(t)}}getMaxHeightPoints(e){const t=JSON.parse(JSON.stringify(e));return t.forEach((e=>{e.z=this._config.hidePlane?e.z+this.maxZ:this.maxZ})),t}addSurfaceStrechControl(e,t){const i=this.getMaxHeightPoints(t);this.facade=new r.Interaction.Item.Facade({helper:this.helper,control:this,name:"EditingPlane",points:t,zPoints:i,color:"#FFF227",hideLastFacade:this._config.hidePlane}),this.add(this.facade),this._config.hidePlane||(this.airPlane=new r.Interaction.Item.Plane({helper:this.helper,control:this,name:"EditingPlane",points:i,color:"#FFF227",edgeColor:"#FFF227",notHittest:!0}),this.airPlane.enable(!0),this.add(this.airPlane)),this.strechControlId=`${this.controlId}_StrechTranslate`;const a=this.getCenter(t);a.z=this._config.hidePlane?a.z+this.maxZ:this.maxZ,this.strechControl=this.helper.addControl(this.strechControlId,"StrechControl",{position:a,hitTestPriority:2})}updateScaleFactor(e){let t,i;e?(t=e.cameraPosition,i=e.cameraFov):(t=this.getViewer().camera.position.clone().applyMatrix4(this.helper.invertMatrix),i=this.getViewer().camera.fov),this.editingPoints.forEach((e=>e.updateScaleFactor(t,i)))}editPoint(e){this.strechControl&&(this.strechControl.visible=!1),this.pointTranslateControl.visible=!0,this.pointTranslateControl.setPosition(e.position.clone().add(this.position)),this.pointTranslateControl.updateScaleFactor(),this.getViewer().render()}cancelEditPoint(){this.pointTranslateControl.visible=!1;const e=this.editingPoints.map((e=>e.position.clone().add(this.position))),t=(new THREE.Box3).setFromPoints(e),i=new THREE.Vector3;t.getCenter(i),this.center=i.clone().sub(this.position),this.strechControl&&(this.strechControl.visible=!0,this.strechControl.setPosition(i),this.strechControl.updateScaleFactor()),this.getViewer().render()}toggleEditingMode(e){if(this.isEditingFlap=e,e)this.pointTranslateControl.visible=!1,this.strechControl.visible=!0,this.removePoints();else if(this.strechControl.visible=!1,this._config.hidePlane){const e=JSON.parse(JSON.stringify(this.lowPoints));this.highPoints=[],e.forEach((e=>{e.z+=this.maxZ,this.highPoints.push(e)})),this.addPoints(this.highPoints)}else this.addPoints(this.points)}getPointsData(){return this.editingPoints.map((e=>e.position.clone().add(this.position)))}getInitPointsData(){return this.lowPoints}getGroundPointsData(){const e=[...this.getPointsData()];return e.forEach((e=>{const t=this.getGroundPointHeight(e.x,e.y);e.z=t&&t.length>0?t[0].position.z:0})),e}destroy(){this.pointTranslateControl.destroy(),this.strechControl&&this.strechControl.destroy(),this.plane&&this.plane.onRemoved(),this.planeEdge&&this.planeEdge.onRemoved(),this.pointTranslateControlId=null,super.destroy()}}r.Interaction=r.Interaction||{},r.Interaction.Control=r.Interaction.Control||{},r.Interaction.Control.SurfaceControl=e})(),(()=>{class e extends THREE.Object3D{constructor(e){super(),this._config=e,this.name=e.name,this.helper=e.helper,this.control=e.control,this.enableAnimation=!1!==e.enableAnimation,this.isHighlightMode=!1,this.isGrayMode=!1,this.isEnabled=!0,this.animationStatusMap={Default:"Default",HighlightPlaying:"HighlightPlaying",HighlightFinished:"HighlightFinished",CancelHighlightPlaying:"CancelHighlightPlaying",CancelHighlightFinished:"CancelHighlightFinished",GrayPlaying:"GrayPlaying",GrayFinished:"GrayFinished",CancelGrayPlaying:"CancelGrayPlaying",CancelGrayFinished:"CancelGrayFinished"},this.animationStatus=this.animationStatusMap.Default,this.animationTimeScale=4,this.highlightActionList=[],this.grayActionList=[],this.init&&this.init()}init(){this.enableAnimation&&(this.initHighlightAnimation(),this.initGrayAnimation())}getConfig(){return this._config}getViewer(){return this.helper.viewer}initHighlightAnimation(){}setHighlight(){this.isEnabled&&this.enableAnimation&&(this.isHighlightMode||(this.isHighlightMode=!0,this.isGrayMode=!1,this.grayActionList.forEach((e=>e.stop())),this.highlightActionList.forEach((e=>{e.timeScale=this.animationTimeScale,e.paused=!1,e.play()})),this.animationStatus=this.animationStatusMap.HighlightPlaying))}cancelHighlight(){this.isEnabled&&this.enableAnimation&&this.isHighlightMode&&(this.isHighlightMode=!1,this.isGrayMode=!1,this.grayActionList.forEach((e=>e.stop())),this.highlightActionList.forEach((e=>{e.timeScale=-this.animationTimeScale,e.paused=!1,e.play()})),this.animationStatus=this.animationStatusMap.CancelHighlightPlaying)}initGrayAnimation(){}setGray(){this.isEnabled&&this.enableAnimation&&(this.isGrayMode||(this.isGrayMode=!0,this.isHighlightMode=!1,this.highlightActionList.forEach((e=>e.stop())),this.grayActionList.forEach((e=>{e.timeScale=this.animationTimeScale,e.paused=!1,e.play()})),this.animationStatus=this.animationStatusMap.GrayPlaying))}cancelGray(){this.isEnabled&&this.enableAnimation&&this.isGrayMode&&(this.isGrayMode=!1,this.isHighlightMode=!1,this.highlightActionList.forEach((e=>e.stop())),this.grayActionList.forEach((e=>{e.timeScale=-this.animationTimeScale,e.paused=!1,e.play()})),this.animationStatus=this.animationStatusMap.CancelGrayPlaying)}transform(e){}transformFinished(){}hitTest(){return!1}enable(e){e?(this.isEnabled=e,this.cancelGray()):(this.setGray(),this.isEnabled=e)}getLinearColor(e){const t=new THREE.Color(e),i=e=>{let t;return t=e<=.04045?e/12.92:Math.pow((e+.055)/1.055,2.4),t},r=i(t.r),a=i(t.g),n=i(t.b);return new THREE.Color(r,a,n)}destroy(){this.children.forEach((e=>{e.geometry&&e.geometry.dispose&&e.geometry.dispose(),e.material&&e.material.dispose&&e.material.dispose()})),this.control.remove(this)}}r.Interaction=r.Interaction||{},r.Interaction.Item=r.Interaction.Item||{},r.Interaction.Item.BaseItem=e})(),(()=>{class e{constructor({helper:e,object:t,position:i,direction:r,color:a}){this.helper=e,this.object=t,this.position=i,this.direction=r,this.color=a,this.object.control.addHelperEvent("CameraChanged",(e=>this.updateDirection(e.cameraDirection))),this.init();const n=this.helper.viewer.camera._direction.clone().applyMatrix4(this.helper.invertMatrix).normalize();this.updateDirection(n)}init(){const e=new THREE.BufferGeometry,t=new Float32Array([-7,0,0,7,0,0,0,0,14]);e.setAttribute("position",new THREE.BufferAttribute(t,3));const i=new THREE.MeshBasicMaterial({color:this.color,depthTest:!1,side:2,transparent:!0,opacity:1}),a=new THREE.Mesh(e,i),n=new THREE.Vector3(...Object.values(this.direction)).normalize(),s=(new THREE.Quaternion).setFromUnitVectors(new THREE.Vector3(0,0,1),n);this.directionQuaternion=s,a.applyQuaternion(s);const o=new THREE.Vector3(...Object.values(this.position));a.position.set(o.x,o.y,o.z),a.name="arrowHead",a.renderOrder=r.EnumRenderOrder.Effect+1e3,this.object.add(a),a.updateMatrixWorld(!0),this.mesh=a}updateDirection(e){const t=this.object.control.quaternion.clone().invert(),i=new THREE.Vector3(0,1,0).applyQuaternion(this.directionQuaternion),r=new THREE.Plane(new THREE.Vector3(...Object.values(this.direction)).normalize()),a=new THREE.Vector3;r.projectPoint(e.clone().applyQuaternion(t),a);const n=(new THREE.Quaternion).setFromUnitVectors(i,a.normalize()).multiply(this.directionQuaternion.clone());this.mesh.quaternion.set(n.x,n.y,n.z,n.w),this.mesh.updateMatrixWorld(!0)}}class t extends r.Interaction.Item.BaseItem{constructor(e){super(e)}init(){const{helper:t,startPoint:i,endPoint:r,color:a}=this.getConfig(),n=this.getLinearColor(a),s=[...Object.values(i),...Object.values(r)];this.addLine(s,{color:n});const o=this.vectorStart=new THREE.Vector3(...Object.values(i)),l=this.vectorEnd=new THREE.Vector3(...Object.values(r)),d=this.direction=l.clone().sub(o);if(this.arrowHead=new e({helper:t,object:this,position:r,direction:d,color:n}),this._config.streching){const a=new THREE.Vector3(...Object.values(r)),s=new THREE.Vector3(...Object.values(i)).clone().sub(a);this.arrowTail=new e({helper:t,object:this,position:i,direction:s,color:n})}const h=d.clone().normalize().multiplyScalar(10),c=l.clone().sub(o).add(h).multiplyScalar(.5).add(o);this.rigidBody=this.addRigidBody(c,d.clone().add(h),{color:n}),this.addDashedLine(s,{color:n}),super.init()}addLine(e,t){const i=new THREE.LineGeometry;i.setPositions(e);const a=new THREE.LineMaterial({color:t.color,linewidth:4,dashed:!1,depthTest:!1,transparent:!0});a.resolution.set(this.getViewer().domElement.clientWidth,this.getViewer().domElement.clientHeight);const n=this.line=new THREE.Line2(i,a);n.renderOrder=r.EnumRenderOrder.Effect+1e3,n.name="AxisArrowLine",this.add(n)}addDashedLine(e,t){const i=new THREE.BufferGeometry;i.setAttribute("position",new THREE.Float32BufferAttribute(e,3));const a=new THREE.LineDashedMaterial({depthTest:!1,linewidth:1,scale:1,dashSize:12,gapSize:8,...t}),n=this.dashedLine=new THREE.Line(i,a);n.computeLineDistances(),n.renderOrder=r.EnumRenderOrder.Effect,n.name="AxisArrowDashedLine",n.visible=!1,this.add(n)}showDashedLine(){this.line.visible=!1,this.arrowHead.mesh.visible=!1,this.arrowTail&&(this.arrowTail.mesh.visible=!1),this.dashedLine.visible=!0}hideDashedLine(){this.line.visible=!0,this.arrowHead.mesh.visible=!0,this.arrowTail&&(this.arrowTail.mesh.visible=!0),this.dashedLine.visible=!1}addRigidBody(e,t,i){const a=t.length(),n=new THREE.CylinderGeometry(5,5,a,3),s=r.MaterialUtil.createStandardMaterial(i);var o=new THREE.Mesh(n,s);o.name="RigidBody";const l=(new THREE.Quaternion).setFromUnitVectors(new THREE.Vector3(0,1,0),t.clone().normalize());return o.applyQuaternion(l),o.position.set(e.x,e.y,e.z),o.updateMatrixWorld(),o.visible=!1,this.add(o),o}hitTest(e){const t=[];return this.rigidBody.raycast(e,t),t.length>0}initHighlightAnimation(){const e=new THREE.ColorKeyframeTrack(".material.color",[0,1],[...this.line.material.color.toArray(),1,.8879231178819663,.0202885630566524]),t=new THREE.NumberKeyframeTrack(".material.linewidth",[0,1],[4,6]),i=new THREE.AnimationClip("Action",1,[t,e]);this.mixerHighlight=new THREE.AnimationMixer(this.line),this.actionHighlight=this.mixerHighlight.clipAction(i),this.actionHighlight.setLoop(THREE.LoopOnce),this.actionHighlight.timeScale=this.animationTimeScale,this.actionHighlight.clampWhenFinished=!0,this.highlightActionList.push(this.actionHighlight),this.control.addAnimation({mixer:this.mixerHighlight,action:this.actionHighlight,object:this.line});const r=new THREE.VectorKeyframeTrack(".scale",[0,1],[1,1,1,2,2,2]),a=new THREE.AnimationClip("Action",1,[r,e]);this.mixerHighlightForHead=new THREE.AnimationMixer(this.arrowHead.mesh),this.actionHighlightForHead=this.mixerHighlightForHead.clipAction(a),this.actionHighlightForHead.setLoop(THREE.LoopOnce),this.actionHighlightForHead.timeScale=this.animationTimeScale,this.actionHighlightForHead.clampWhenFinished=!0,this.highlightActionList.push(this.actionHighlightForHead),this.control.addAnimation({mixer:this.mixerHighlightForHead,action:this.actionHighlightForHead,object:this.arrowHead.mesh}),this.arrowTail&&(this.mixerHighlightForTail=new THREE.AnimationMixer(this.arrowTail.mesh),this.actionHighlightForTail=this.mixerHighlightForTail.clipAction(a),this.actionHighlightForTail.setLoop(THREE.LoopOnce),this.actionHighlightForTail.timeScale=this.animationTimeScale,this.actionHighlightForTail.clampWhenFinished=!0,this.highlightActionList.push(this.actionHighlightForTail),this.control.addAnimation({mixer:this.mixerHighlightForTail,action:this.actionHighlightForTail,object:this.arrowTail.mesh})),this.mixerHighlight.addEventListener("finished",(()=>{this.animationStatus!==this.animationStatusMap.HighlightPlaying?this.animationStatus=this.animationStatusMap.Default:this.animationStatus=this.animationStatusMap.HighlightFinished}))}initGrayAnimation(){const e=new THREE.ColorKeyframeTrack(".material.color",[0,1],[...this.line.material.color.toArray(),.4969329950608704,.4969329950608704,.4969329950608704]),t=new THREE.AnimationClip("Action",1,[e]);this.mixerGray=new THREE.AnimationMixer(this.line),this.actionGray=this.mixerGray.clipAction(t),this.actionGray.setLoop(THREE.LoopOnce),this.actionGray.timeScale=this.animationTimeScale,this.actionGray.clampWhenFinished=!0,this.grayActionList.push(this.actionGray),this.control.addAnimation({mixer:this.mixerGray,action:this.actionGray,object:this.line});const i=new THREE.AnimationClip("Action",1,[e]);this.mixerGrayForHead=new THREE.AnimationMixer(this.arrowHead.mesh),this.actionGrayForHead=this.mixerGrayForHead.clipAction(i),this.actionGrayForHead.setLoop(THREE.LoopOnce),this.actionGrayForHead.timeScale=this.animationTimeScale,this.actionGrayForHead.clampWhenFinished=!0,this.grayActionList.push(this.actionGrayForHead),this.control.addAnimation({mixer:this.mixerGrayForHead,action:this.actionGrayForHead,object:this.arrowHead.mesh}),this.arrowTail&&(this.mixerGrayForTail=new THREE.AnimationMixer(this.arrowTail.mesh),this.actionGrayForTail=this.mixerGrayForTail.clipAction(i),this.actionGrayForTail.setLoop(THREE.LoopOnce),this.actionGrayForTail.timeScale=this.animationTimeScale,this.actionGrayForTail.clampWhenFinished=!0,this.grayActionList.push(this.actionGrayForTail),this.control.addAnimation({mixer:this.mixerGrayForTail,action:this.actionGrayForTail,object:this.arrowTail.mesh})),this.mixerGray.addEventListener("finished",(()=>{this.animationStatus!==this.animationStatusMap.GrayPlaying?this.animationStatus=this.animationStatusMap.Default:this.animationStatus=this.animationStatusMap.GrayFinished}))}}r.Interaction=r.Interaction||{},r.Interaction.Item=r.Interaction.Item||{},r.Interaction.Item.TranslateArrow=class extends t{constructor(e){super(e)}transform(e){const t=this.getViewer().cameraControl.getRaycaster(e.x,e.y),i=this.getViewer().drawingToWorld(t.ray.direction).normalize(),r=this.direction.clone().applyQuaternion(this.control.quaternion),a=new THREE.Ray(this.control.position.clone(),r),n=i.clone().cross(i.clone().cross(r)),s=new THREE.Plane(n),o=this.getViewer().drawingToWorld(this.getViewer().camera.position.clone()),l=-s.distanceToPoint(o);s.set(n,l),a.intersectsPlane(s)||a.set(a.origin.clone(),r.clone().negate());const d=new THREE.Vector3;a.intersectPlane(s,d),this.mouseDownOffset=this.mouseDownOffset||d.clone().sub(this.control.position);const h=d.clone().sub(this.mouseDownOffset);this.control.position.set(h.x,h.y,h.z),this.control.updateMatrixWorld(),this.getViewer().render()}transformFinished(){this.mouseDownOffset=null}},r.Interaction.Item.ScaleArrow=class extends t{constructor(e){super(e),this.position.set(e.position.x,e.position.y,e.position.z),this.updateMatrixWorld()}updateScaleFactor(e){this.position.set(0,0,0),this.scale.set(e,e,e);const t=this.getConfig().position;this.position.set(t.x,t.y,t.z),this.updateMatrixWorld(!0)}updatePosition(e){this.getConfig().position=e,this.position.set(e.x,e.y,e.z),this.updateMatrixWorld(!0)}transform(e){}transformFinished(){}}})(),(()=>{class e extends r.Interaction.Item.BaseItem{constructor(e){super(e)}init(){const{centerPoint:e,normal:t,color:i}=this.getConfig();this.addPlane(e,t,this.getLinearColor(i)),super.init()}addPlane(e,t,i){const a=new THREE.BufferGeometry,n=new Float32Array([-10,0,-10,10,0,-10,10,0,10,10,0,10,-10,0,10,-10,0,-10]);a.setAttribute("position",new THREE.BufferAttribute(n,3));const s=new THREE.MeshBasicMaterial({color:i,depthTest:!1,side:2,transparent:!0}),o=new THREE.Mesh(a,s);this.normal=new THREE.Vector3(...Object.values(t)).normalize();const l=(new THREE.Quaternion).setFromUnitVectors(new THREE.Vector3(0,1,0),this.normal);o.applyQuaternion(l);const d=new THREE.Vector3(...Object.values(e));o.position.set(d.x,d.y,d.z),o.name="plane",o.renderOrder=r.EnumRenderOrder.Effect+1e3,this.add(o),o.updateMatrixWorld(!0),this.mesh=o}hitTest(e){const t=[];return this.mesh.raycast(e,t),t.length>0}initHighlightAnimation(){const e=new THREE.ColorKeyframeTrack(".material.color",[0,1],[...this.children[0].material.color.toArray(),1,.8879231178819663,.0202885630566524]),t=new THREE.AnimationClip("Action",1,[e]);this.mixerHighlight=new THREE.AnimationMixer(this.children[0]),this.actionHighlight=this.mixerHighlight.clipAction(t),this.actionHighlight.setLoop(THREE.LoopOnce),this.actionHighlight.timeScale=this.animationTimeScale,this.actionHighlight.clampWhenFinished=!0,this.highlightActionList.push(this.actionHighlight),this.control.addAnimation({mixer:this.mixerHighlight,action:this.actionHighlight,object:this.children[0]}),this.mixerHighlight.addEventListener("finished",(()=>{this.animationStatus!==this.animationStatusMap.HighlightPlaying?this.animationStatus=this.animationStatusMap.Default:this.animationStatus=this.animationStatusMap.HighlightFinished}))}initGrayAnimation(){const e=new THREE.ColorKeyframeTrack(".material.color",[0,1],[...this.children[0].material.color.toArray(),.4969329950608704,.4969329950608704,.4969329950608704]),t=new THREE.AnimationClip("Action",1,[e]);this.mixerGray=new THREE.AnimationMixer(this.children[0]),this.actionGray=this.mixerGray.clipAction(t),this.actionGray.setLoop(THREE.LoopOnce),this.actionGray.timeScale=this.animationTimeScale,this.actionGray.clampWhenFinished=!0,this.grayActionList.push(this.actionGray),this.control.addAnimation({mixer:this.mixerGray,action:this.actionGray,object:this.children[0]}),this.mixerGray.addEventListener("finished",(()=>{this.animationStatus!==this.animationStatusMap.GrayPlaying?this.animationStatus=this.animationStatusMap.Default:this.animationStatus=this.animationStatusMap.GrayFinished}))}transform(e){const t=this.getViewer().cameraControl.getRaycaster(e.x,e.y),i=this.getViewer().drawingToWorld(t.ray.direction).normalize(),r=this.normal.clone().applyQuaternion(this.control.quaternion),a=new THREE.Plane(r),n=this.getViewer().drawingToWorld(this.getViewer().camera.position.clone()),s=-a.distanceToPoint(this.control.position);a.set(r,s);const o=new THREE.Ray(n,i),l=new THREE.Vector3;o.intersectPlane(a,l),this.mouseDownOffset=this.mouseDownOffset||l.clone().sub(this.control.position);const d=l.clone().sub(this.mouseDownOffset);this.control.position.set(d.x,d.y,d.z),this.control.updateMatrixWorld(),this.getViewer().render()}transformFinished(){this.mouseDownOffset=null}}r.Interaction=r.Interaction||{},r.Interaction.Item=r.Interaction.Item||{},r.Interaction.Item.TranslatePlane=e})(),(()=>{class e extends r.Interaction.Item.BaseItem{constructor(e){super(e),this.enableAnimation=!1}init(){const{boundingBoxData:e}=this.getConfig();this.addBoundingBoxEdge(e)}getEdgesGeometry(e){const t=e.max.x-e.min.x,i=e.max.y-e.min.y,r=e.max.z-e.min.z,a=new THREE.BoxGeometry(t,i,r);return new THREE.EdgesGeometry(a)}addBoundingBoxEdge(e){const t=this.getEdgesGeometry(e),i=new THREE.LineSegments(t,new THREE.LineBasicMaterial({color:this.getLinearColor(1170103)}));this.add(i);const r=t.clone(),a=new THREE.LineSegments(r,new THREE.LineBasicMaterial({color:this.getLinearColor(9674396),depthFunc:THREE.GreaterDepth}));this.add(a)}update(e){for(;this.children.length>0;){const e=this.children[0];this.remove(e),e.geometry.dispose(),e.material.dispose()}this.addBoundingBoxEdge(e),this.updateMatrixWorld()}hitTest(e){}}r.Interaction=r.Interaction||{},r.Interaction.Item=r.Interaction.Item||{},r.Interaction.Item.BoundingBox=e})(),(()=>{class e extends r.Interaction.Item.BaseItem{constructor(e){super(e)}init(){const{length:e,color:t}=this.getConfig();this.addCube(e,this.getLinearColor(t)),super.init()}addCube(e,t){const i=new THREE.BoxGeometry(e,e,e),a=new THREE.MeshBasicMaterial({color:t,depthTest:!1,transparent:!0}),n=new THREE.Mesh(i,a);n.name="cube",n.renderOrder=r.EnumRenderOrder.Effect+1e3,this.add(n),this.cube=n;const s=new THREE.EdgesGeometry(i),o=new THREE.LineSegments(s,new THREE.LineBasicMaterial({color:3355443,transparent:!0,opacity:.3}));o.renderOrder=r.EnumRenderOrder.Effect+1e3,this.add(o)}hitTest(e){const t=[];return this.cube.raycast(e,t),t.length>0}initHighlightAnimation(){const e=new THREE.ColorKeyframeTrack(".material.color",[0,1],[...this.children[0].material.color.toArray(),1,.8879231178819663,.0202885630566524]),t=new THREE.AnimationClip("Action",1,[e]);this.mixerHighlight=new THREE.AnimationMixer(this.children[0]),this.actionHighlight=this.mixerHighlight.clipAction(t),this.actionHighlight.setLoop(THREE.LoopOnce),this.actionHighlight.timeScale=this.animationTimeScale,this.actionHighlight.clampWhenFinished=!0,this.highlightActionList.push(this.actionHighlight),this.control.addAnimation({mixer:this.mixerHighlight,action:this.actionHighlight,object:this.children[0]}),this.mixerHighlight.addEventListener("finished",(()=>{this.animationStatus!==this.animationStatusMap.HighlightPlaying?this.animationStatus=this.animationStatusMap.Default:this.animationStatus=this.animationStatusMap.HighlightFinished}))}initGrayAnimation(){const e=new THREE.ColorKeyframeTrack(".material.color",[0,1],[...this.children[0].material.color.toArray(),.4969329950608704,.4969329950608704,.4969329950608704]),t=new THREE.AnimationClip("Action",1,[e]);this.mixerGray=new THREE.AnimationMixer(this.children[0]),this.actionGray=this.mixerGray.clipAction(t),this.actionGray.setLoop(THREE.LoopOnce),this.actionGray.timeScale=this.animationTimeScale,this.actionGray.clampWhenFinished=!0,this.grayActionList.push(this.actionGray),this.control.addAnimation({mixer:this.mixerGray,action:this.actionGray,object:this.children[0]}),this.mixerGray.addEventListener("finished",(()=>{this.animationStatus!==this.animationStatusMap.GrayPlaying?this.animationStatus=this.animationStatusMap.Default:this.animationStatus=this.animationStatusMap.GrayFinished}))}updateScaleFactor(e){this.scale.set(e,e,e),this.updateMatrixWorld()}transform(e){if(void 0===this.mouseDownX)this.mouseDownX=e.x;else{const t=1+(e.x-this.mouseDownX)/this.helper.viewer.domElement.clientWidth;this.control.scaleInfo={type:"ScaleCube",scaleFactor:t}}}transformFinished(){this.mouseDownX=void 0}}r.Interaction=r.Interaction||{},r.Interaction.Item=r.Interaction.Item||{},r.Interaction.Item.ScaleCube=e})(),(()=>{class e extends r.Interaction.Item.BaseItem{constructor(e){super(e)}init(){const{points:e,color:t}=this.getConfig(),i=[];e.forEach((e=>i.push(e.x,e.y,e.z))),this.addLine(i,{color:this.getLinearColor(t)}),super.init()}addLine(e,t){t||(t={});const i=new THREE.BufferGeometry;i.setAttribute("position",new THREE.Float32BufferAttribute(e,3)),this.lineMaterial||(!0===this.getConfig().dashed?this.lineMaterial=new THREE.LineDashedMaterial({depthTest:!1,linewidth:1,scale:1,dashSize:12,gapSize:8,...t}):this.lineMaterial=new THREE.LineBasicMaterial({depthTest:!1,linewidth:1,...t}));const a=new THREE.Line(i,this.lineMaterial);a.computeLineDistances(),a.renderOrder=r.EnumRenderOrder.Effect+100,this.add(a),this.line=a}update(e){this.remove(this.line),this.line.geometry.dispose();const t=[];e.forEach((e=>t.push(e.x,e.y,e.z))),this.addLine(t),this.updateMatrixWorld()}updateScaleFactor(e){!0===this.getConfig().dashed&&(this.line.material.dashSize=12*e,this.line.material.gapSize=8*e,this.line.computeLineDistances())}hitTest(e){return!1}}r.Interaction=r.Interaction||{},r.Interaction.Item=r.Interaction.Item||{},r.Interaction.Item.Line=e})(),(()=>{class e extends r.Interaction.Item.BaseItem{constructor(e){super(e)}init(){const{points:e,color:t}=this.getConfig();this.addCurveLine(e,{color:this.getLinearColor(t)}),super.init()}addCurveLine(e,t){const i=new THREE.CatmullRomCurve3(e),r=i.getPoints(20*e.length),a=[];r.forEach((e=>a.push(e.x||0,e.y||0,e.z||0)));const n=new THREE.LineGeometry;n.setPositions(a),this.curveLineMaterial||(this.curveLineMaterial=new THREE.LineMaterial({linewidth:1.5,dashed:!1,depthTest:!1,transparent:!0,...t}),this.curveLineMaterial.resolution.set(this.getViewer().domElement.clientWidth,this.getViewer().domElement.clientHeight));const s=this.curveLine=new THREE.Line2(n,this.curveLineMaterial);this.add(s),this.addRigidBody(i)}addRigidBody(e,t){const i=new THREE.TubeGeometry(e,void 0,t||4);this.rigidBodyMaterial||(this.rigidBodyMaterial=new THREE.MeshBasicMaterial);const r=this.rigidBody=new THREE.Mesh(i,this.rigidBodyMaterial);r.visible=!1,this.add(r)}update(e){this.remove(this.curveLine),this.curveLine.geometry.dispose(),this.remove(this.rigidBody),this.rigidBody.geometry.dispose(),this.addCurveLine(e),this.updateMatrixWorld(),this.getConfig().points=e}updateScaleFactor(e,t){if(this.rigidBody){const i=this.control.position.clone().add(this.control.center).clone().sub(e.clone()).length(),r=2*Math.tan(t*Math.PI/360)*i,a=this.getViewer().domElement.offsetHeight,n=this.factor=4*r/a;this.remove(this.rigidBody),this.rigidBody.geometry.dispose();const s=new THREE.CatmullRomCurve3(this.getConfig().points);this.addRigidBody(s,n)}this.updateMatrixWorld()}hitTest(e){const t=[];return this.rigidBody.raycast(e,t),t.length>0}initHighlightAnimation(){const e=new THREE.ColorKeyframeTrack(".material.color",[0,1],[...this.children[0].material.color.toArray(),.005605391624202723,.7011018919329731,.47353149614800955]),t=new THREE.NumberKeyframeTrack(".material.linewidth",[0,1],[1.5,3]),i=new THREE.AnimationClip("Action",1,[e,t]);this.mixerHighlight=new THREE.AnimationMixer(this.children[0]),this.actionHighlight=this.mixerHighlight.clipAction(i),this.actionHighlight.setLoop(THREE.LoopOnce),this.actionHighlight.timeScale=this.animationTimeScale,this.actionHighlight.clampWhenFinished=!0,this.highlightActionList.push(this.actionHighlight),this.control.addAnimation({mixer:this.mixerHighlight,action:this.actionHighlight,object:this.children[0]}),this.mixerHighlight.addEventListener("finished",(()=>{this.animationStatus!==this.animationStatusMap.HighlightPlaying?this.animationStatus=this.animationStatusMap.Default:this.animationStatus=this.animationStatusMap.HighlightFinished}))}setGray(){}cancelGray(){}}r.Interaction=r.Interaction||{},r.Interaction.Item=r.Interaction.Item||{},r.Interaction.Item.Curve=e})(),(()=>{class e extends r.Interaction.Item.BaseItem{constructor(e){super(e)}init(){const{points:e,zPoints:t,color:i,hideLastFacade:r}=this.getConfig();this.color=i,this.trangles=[],this.edges=[],this.hideLastFacade=r,this.addFacade(e,t),super.init()}drawTrangle(e,t,i,a){const n=new THREE.BufferGeometry,s=new Float32Array([e.x,e.y,e.z,t.x,t.y,t.z,i.x,i.y,i.z]);n.setAttribute("position",new THREE.BufferAttribute(s,3)),n.computeVertexNormals();const o=new THREE.MeshBasicMaterial({color:this.getLinearColor(this.color),depthTest:!1,depthWrite:!0,side:2,transparent:!0,opacity:.5}),l=new THREE.Mesh(n,o);l.renderOrder=r.EnumRenderOrder.Effect,l.position.set(0,0,0),l.name="drawTrangle",this.trangles.push(l),this.add(l),this.updateMatrixWorld()}addEgeLines(e,t){e.forEach(((e,i)=>{const a=[e,t[i]],n=new r.Interaction.Item.Line({helper:this.helper,control:this,name:"EditingFacadeEdge",points:a,color:this.color});this.edges.push(n),this.add(n),this.updateMatrixWorld()}))}addFacade(e,t){for(let i=0;i<e.length;i++)i<e.length-1?(this.drawTrangle(t[i],e[i],e[i+1]),this.drawTrangle(e[i+1],t[i+1],t[i])):this.hideLastFacade||(this.drawTrangle(t[i],e[i],e[0]),this.drawTrangle(e[0],t[0],t[i]));this.addEgeLines(e,t,this.color)}update(e,t,i=!0){let r;this.trangles.length>0&&(this.trangles.forEach((e=>{this.remove(e),e.geometry.dispose()})),this.trangles=[],this.edges.forEach((e=>{this.remove(e)})),this.edges=[]),i?(r=JSON.parse(JSON.stringify(e)),r.forEach((e=>{const t=this.getGroundPointHeight(e.x,e.y);e.z=t.length>0?t[0].position.z:0})),this.addFacade(r,e),this.addEgeLines(r,e)):(r=JSON.parse(JSON.stringify(e)),r.forEach((e=>{e.z=t+e.z}))),this.addFacade(r,e),this.addEgeLines(r,e)}getGroundPointHeight(e,t){const i=new THREE.Vector3(e,t,1e4),r=new THREE.Vector3(0,0,-1);return this.helper.viewer.getComponentsByRaycaster(i,r,[])}}r.Interaction=r.Interaction||{},r.Interaction.Item=r.Interaction.Item||{},r.Interaction.Item.Facade=e})(),(()=>{class e extends r.Interaction.Item.BaseItem{constructor(e){super(e)}init(){const{points:e,color:t,edgeColor:i,notHittest:r}=this.getConfig();this.addPlane(e,{color:this.getLinearColor(t)},{color:this.getLinearColor(i)}),this.notHittest=r,super.init()}addPlane(e,t,i){const a=e.map((e=>new THREE.Vector2(e.x,e.y))),n=e[0].z,s=new THREE.Shape(a),o=new THREE.ShapeGeometry(s);this.planeMeterial||(this.planeMeterial=new THREE.MeshBasicMaterial({depthTest:!1,side:2,transparent:!0,opacity:.3,...t}));const l=this.plane=new THREE.Mesh(o,this.planeMeterial);l.renderOrder=r.EnumRenderOrder.Effect,l.position.set(0,0,n),this.add(l),this.addPlaneEdge(e,i),this.updateMatrixWorld()}addPlaneEdge(e,t){const i=[],a=e[0].z;e.forEach((e=>i.push(e.x,e.y,a))),i.push(e[0].x,e[0].y,a);const n=new THREE.LineGeometry;n.setPositions(i),this.lineMaterial||(this.lineMaterial=new THREE.LineMaterial({linewidth:1.5,dashed:!1,depthTest:!1,transparent:!0,...t}),this.lineMaterial.resolution.set(this.getViewer().domElement.clientWidth,this.getViewer().domElement.clientHeight));const s=this.edgeLine=new THREE.Line2(n,this.lineMaterial);s.renderOrder=r.EnumRenderOrder.Effect+100,this.add(s)}update(e){this.plane&&(this.remove(this.plane),this.plane.geometry.dispose()),this.edgeLine&&(this.remove(this.edgeLine),this.edgeLine.geometry.dispose()),this.addPlane(e)}hitTest(e){if(this.notHittest)return;const t=[];return this.plane.raycast(e,t),t.length>0}initHighlightAnimation(){const e=new THREE.ColorKeyframeTrack(".material.color",[0,1],[...this.edgeLine.material.color.toArray(),.005605391624202723,.7011018919329731,.47353149614800955]),t=new THREE.NumberKeyframeTrack(".material.linewidth",[0,1],[1.5,3]),i=new THREE.AnimationClip("Action",1,[e,t]);this.mixerHighlight=new THREE.AnimationMixer(this.edgeLine),this.actionHighlight=this.mixerHighlight.clipAction(i),this.actionHighlight.setLoop(THREE.LoopOnce),this.actionHighlight.timeScale=this.animationTimeScale,this.actionHighlight.clampWhenFinished=!0,this.highlightActionList.push(this.actionHighlight),this.control.addAnimation({mixer:this.mixerHighlight,action:this.actionHighlight,object:this.edgeLine}),this.mixerHighlight.addEventListener("finished",(()=>{this.animationStatus!==this.animationStatusMap.HighlightPlaying?this.animationStatus=this.animationStatusMap.Default:this.animationStatus=this.animationStatusMap.HighlightFinished}))}}r.Interaction=r.Interaction||{},r.Interaction.Item=r.Interaction.Item||{},r.Interaction.Item.Plane=e})(),(()=>{class e extends r.Interaction.Item.BaseItem{constructor(e){super(e),this.isSelected=!1}init(){const{point:e,showText:t}=this.getConfig();this.position.set(e.x,e.y,e.z),this.showText=0!=t||t,this.updateMatrixWorld(),this.addPoint(),this.addRigidBody(),super.init()}addPoint(){this.updateScaleFactor(),this.defaultTexture=this.getTexture("#"+this.getLinearColor("#FFD000").getHexString()),this.highlightTexture=this.getTexture("#"+this.getLinearColor("#32D3A6").getHexString());const e=new THREE.SpriteMaterial({map:this.defaultTexture,depthTest:!1}),t=this.point=new THREE.Sprite(e);t.renderOrder=r.EnumRenderOrder.Effect+200,this.add(t)}getTexture(e){const t=document.createElement("canvas");t.width=16,t.height=16;const i=t.getContext("2d");i.beginPath(),i.arc(8,8,8,0,2*Math.PI),i.fillStyle=e,i.fill(),i.beginPath(),i.arc(8,8,4,0,2*Math.PI),i.fillStyle="#FFFFFF",i.fill();return new THREE.CanvasTexture(t)}addRigidBody(){const e=new THREE.BoxGeometry(1,1,1),t=new THREE.MeshBasicMaterial,i=this.rigidBody=new THREE.Mesh(e,t);i.visible=!1,this.add(i)}updateScaleFactor(e,t){e=e||this.getViewer().camera.position.clone().applyMatrix4(this.helper.invertMatrix),t=t||this.getViewer().camera.fov;const i=this.position.clone().add(this.control.position).clone().sub(e.clone()).length(),r=2*Math.tan(t*Math.PI/360)*i,a=this.getViewer().domElement.offsetHeight,n=this.factor=10*r/a;this.scale.set(n,n,n),this.updateMatrixWorld()}hitTest(e){const t=[];return this.rigidBody.raycast(e,t),t.length>0}initHighlightAnimation(){const e=new THREE.VectorKeyframeTrack(".scale",[0,1],[1,1,1,1.3,1.3,1.3]),t=new THREE.AnimationClip("Action",1,[e]);this.mixerHighlight=new THREE.AnimationMixer(this.children[0]),this.actionHighlight=this.mixerHighlight.clipAction(t),this.actionHighlight.setLoop(THREE.LoopOnce),this.actionHighlight.timeScale=this.animationTimeScale,this.actionHighlight.clampWhenFinished=!0,this.highlightActionList.push(this.actionHighlight),this.control.addAnimation({mixer:this.mixerHighlight,action:this.actionHighlight,object:this.children[0]}),this.mixerHighlight.addEventListener("finished",(()=>{this.animationStatus!==this.animationStatusMap.HighlightPlaying?(this.point.material.map=this.defaultTexture,this.animationStatus=this.animationStatusMap.Default):this.animationStatus=this.animationStatusMap.HighlightFinished}))}setHighlight(){this.point.material.map=this.highlightTexture,!this.hintText&&this.showText&&(this.hintText=new r.Interaction.Item.HintText({text:"点击可编辑",position:{x:0,y:0,z:0}}),this.add(this.hintText),this.updateMatrixWorld()),super.setHighlight()}cancelHighlight(){this.hintText&&(this.hintText.cancelHighlight(),this.remove(this.hintText),this.hintText=null),this.isSelected||super.cancelHighlight()}setGray(){}cancelGray(){}}r.Interaction=r.Interaction||{},r.Interaction.Item=r.Interaction.Item||{},r.Interaction.Item.EditingPoint=e})(),(()=>{class e extends r.Interaction.Item.BaseItem{constructor(e){super(e)}init(){this.text=this.getConfig().text;const e=this.getConfig().position;this.setHighlight(e),super.init()}setHighlight(e){if(this.map)return;const t=e,i=this.text,a=document.createElement("canvas"),n=a.getContext("2d"),s='64px -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Helvetica,"PingFang SC","Hiragino Sans GB","Microsoft YaHei",SimSun,sans-serif';n.font=s,a.width=1024,a.height=1024,n.font=s;const o=512,l=542,d=912,h=702;n.fillStyle="#000000",n.globalAlpha=.8,n.fillRect(516,546,392,152),n.fillStyle="#FFFFFF",n.globalAlpha=1,n.fillText(i,552,647),n.strokeStyle="#F2F2F2",n.lineWidth=4,n.beginPath(),n.moveTo(o,l),n.lineTo(o,698),n.arcTo(o,h,516,h,8),n.lineTo(908,h),n.arcTo(d,h,d,698,8),n.lineTo(d,546),n.arcTo(d,l,908,l,8),n.lineTo(516,l),n.arcTo(o,l,o,546,8),n.stroke();const c=new THREE.CanvasTexture(a);this.map=c;const u=new THREE.SpriteMaterial({map:c,depthTest:!1}),p=new THREE.Sprite(u);p.position.set(t.x,t.y,t.z),p.scale.set(20,20,20),p.renderOrder=r.EnumRenderOrder.Effect+200,this.add(p),this.updateMatrixWorld()}cancelHighlight(){this.map&&(this.map=null)}}r.Interaction=r.Interaction||{},r.Interaction.Item=r.Interaction.Item||{},r.Interaction.Item.HintText=e})(),(()=>{class e extends r.Interaction.Item.BaseItem{constructor(e){super(e)}init(){const{center:e,radius:t,thetaStart:i,thetaLength:r,color:a,opacity:n,edgeColor:s}=this.getConfig();this.addCircle(e,t,i,r,{color:this.getLinearColor(a),opacity:n||.3},{color:this.getLinearColor(s)}),super.init()}addCircle(e,t,i,a,n,s){i=i||0,a=a||2*Math.PI,this.center=e,this.radius=t,this.thetaStart=i,this.thetaLength=a;const o=new THREE.CircleGeometry(t,128,i,a);this.circleMaterial||(this.circleMaterial=new THREE.MeshBasicMaterial({depthTest:!1,transparent:!0,...n}));const l=this.circle=new THREE.Mesh(o,this.circleMaterial);l.renderOrder=r.EnumRenderOrder.Effect+100,l.position.set(e.x,e.y,e.z),this.add(l),this.addCircleEdge(e,t,i,a,s),this.updateMatrixWorld()}addCircleEdge(e,t,i,a,n){const s=new THREE.EllipseCurve(0,0,t,t,i,i+a,!1,0).getPoints(128),o=[];s.forEach((e=>o.push(e.x||0,e.y||0,e.z||0)));const l=new THREE.LineGeometry;l.setPositions(o),this.circleEdgeMaterial||(this.circleEdgeMaterial=new THREE.LineMaterial({linewidth:1.5,dashed:!1,depthTest:!1,transparent:!0,...n}),this.circleEdgeMaterial.resolution.set(this.getViewer().domElement.clientWidth,this.getViewer().domElement.clientHeight));const d=this.edgeCurve=new THREE.Line2(l,this.circleEdgeMaterial);if(d.position.set(e.x,e.y,e.z),d.renderOrder=r.EnumRenderOrder.Effect+100,this.add(d),this.circleEdges=[],this.circleEdges.push(d),a-i!=2*Math.PI){const s=new THREE.BufferGeometry;s.setAttribute("position",new THREE.Float32BufferAttribute([0,0,0,t,0,0],3)),this.edgeMaterial||(this.edgeMaterial=new THREE.LineBasicMaterial({depthTest:!1,...n}));const o=new THREE.Line(s,this.edgeMaterial);o.rotateOnAxis(new THREE.Vector3(0,0,1),i),o.position.set(e.x,e.y,e.z),o.renderOrder=r.EnumRenderOrder.Effect+100,this.add(o),this.circleEdges.push(o);const l=new THREE.Line(s,this.edgeMaterial);l.rotateOnAxis(new THREE.Vector3(0,0,1),i+a),l.position.set(e.x,e.y,e.z),l.renderOrder=r.EnumRenderOrder.Effect+100,this.add(l),this.circleEdges.push(l)}if(this.getConfig().hitTestEdge){const i=new THREE.TorusGeometry(t,10,3,16);this.rigidBodyMaterial||(this.rigidBodyMaterial=new THREE.MeshBasicMaterial);const r=this.rigidBody=new THREE.Mesh(i,this.rigidBodyMaterial);r.position.set(e.x,e.y,e.z),r.visible=!1,this.add(r);const a=this.getViewer().camera.position.clone().applyMatrix4(this.helper.invertMatrix),n=this.getViewer().camera.fov;this.updateScaleFactor(a,n)}}updateScaleFactor(e,t){if(!this.rigidBody)return;const i=this.position.clone().add(this.control.position).clone().sub(e.clone()).length(),r=2*Math.tan(t*Math.PI/360)*i,a=this.getViewer().domElement.offsetHeight,n=this.factor=5*r/a;this.remove(this.rigidBody),this.rigidBody.geometry.dispose();const s=new THREE.TorusGeometry(this.radius,n,3,16),o=this.rigidBody=new THREE.Mesh(s,this.rigidBodyMaterial);o.position.set(this.center.x,this.center.y,this.center.z),o.visible=!1,this.add(o),this.updateMatrixWorld()}update(e,t,i,r){this.center=e,this.radius=t,this.thetaStart=i,this.thetaLength=r,this.remove(this.circle),this.circle.geometry.dispose(),this.circleEdges.forEach((e=>{this.remove(e),e.geometry.dispose()})),this.circleEdges=[],this.rigidBody&&(this.remove(this.rigidBody),this.rigidBody.geometry.dispose()),this.addCircle(e,t,i,r),this.updateMatrixWorld()}hitTest(e){if(!this.rigidBody)return!1;const t=[];return this.rigidBody.raycast(e,t),t.length>0}initHighlightAnimation(){const e=new THREE.ColorKeyframeTrack(".material.color",[0,1],[...this.edgeCurve.material.color.toArray(),.005605391624202723,.7011018919329731,.47353149614800955]),t=new THREE.NumberKeyframeTrack(".material.linewidth",[0,1],[1.5,3]),i=new THREE.AnimationClip("Action",1,[e,t]);this.mixerHighlight=new THREE.AnimationMixer(this.edgeCurve),this.actionHighlight=this.mixerHighlight.clipAction(i),this.actionHighlight.setLoop(THREE.LoopOnce),this.actionHighlight.timeScale=this.animationTimeScale,this.actionHighlight.clampWhenFinished=!0,this.highlightActionList.push(this.actionHighlight),this.control.addAnimation({mixer:this.mixerHighlight,action:this.actionHighlight,object:this.edgeCurve}),this.mixerHighlight.addEventListener("finished",(()=>{this.animationStatus!==this.animationStatusMap.HighlightPlaying?this.animationStatus=this.animationStatusMap.Default:this.animationStatus=this.animationStatusMap.HighlightFinished}))}setGray(){}cancelGray(){}}r.Interaction=r.Interaction||{},r.Interaction.Item=r.Interaction.Item||{},r.Interaction.Item.Circle=e})(),(()=>{class e extends r.Interaction.Item.BaseItem{constructor(e){super(e),this.isSelected=!1,this.enableAnimation=!1}init(){const{center:e,radius:t,thetaStart:i,thetaLength:r}=this.getConfig();this.radius=t,this.angleRadius=3,this.addCircleEdge(e,i,r),this.addAngleText(e,i,r),this.updateScaleFactor()}addCircleEdge(e,t,i){const a=new THREE.EllipseCurve(0,0,this.angleRadius,this.angleRadius,t,t+i,!1,0).getPoints(128),n=(new THREE.BufferGeometry).setFromPoints(a);this.circleEdgeMaterial||(this.circleEdgeMaterial=new THREE.LineBasicMaterial({depthTest:!1,color:this.getLinearColor("#FFF227")}));const s=this.line=new THREE.Line(n,this.circleEdgeMaterial);s.renderOrder=r.EnumRenderOrder.Effect+200,s.position.set(e.x,e.y,e.z),this.add(s)}addAngleText(e,t,i){const a=this.center=new THREE.Vector3(e.x,e.y,e.z),n=new THREE.Vector3(this.angleRadius+2,0,0).applyAxisAngle(new THREE.Vector3(0,0,1),t+i/2).add(a),s=`${Math.round(180*i/Math.PI)}°`,o=document.createElement("canvas"),l=o.getContext("2d"),d='32px -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Helvetica,"PingFang SC","Hiragino Sans GB","Microsoft YaHei",SimSun,sans-serif';l.font=d;const h=l.measureText(s),{width:c,actualBoundingBoxAscent:u}=h;o.width=64,o.height=64,l.font=d,l.fillStyle="#ffffff",l.fillText(s,(64-c)/2,(64+u)/2);const p=new THREE.CanvasTexture(o),m=new THREE.SpriteMaterial({map:p,depthTest:!1}),f=this.text=new THREE.Sprite(m);f.position.set(n.x,n.y,n.z),f.renderOrder=r.EnumRenderOrder.Effect+200,this.add(f)}updateScaleFactor(e,t){e=e||this.getViewer().camera.position.clone().applyMatrix4(this.helper.invertMatrix),t=t||this.getViewer().camera.fov;const i=this.position.clone().add(this.control.position).clone().sub(e.clone()).length(),r=2*Math.tan(t*Math.PI/360)*i,a=this.getViewer().domElement.offsetHeight,n=this.factor=10*r/a;if(7*n>this.radius)return void(this.visible=!1);this.visible=!0,this.line.scale.set(n,n,n),this.updateMatrixWorld();const s=this.text.position.clone().sub(this.center).normalize().multiplyScalar(5*n).add(this.center);this.text.position.set(0,0,0),this.text.scale.set(4*n,4*n,1),this.text.position.set(s.x,s.y,s.z),this.text.updateMatrixWorld()}update(e,t,i,r){this.radius=t,this.remove(this.line),this.line.geometry.dispose(),this.remove(this.text),this.text.geometry.dispose(),this.text.material.dispose(),this.addCircleEdge(e,i,r),this.addAngleText(e,i,r),this.updateScaleFactor()}}r.Interaction=r.Interaction||{},r.Interaction.Item=r.Interaction.Item||{},r.Interaction.Item.SectorAngle=e})(),r.SceneStateHelper=function(e){this.selectionSet={},this.selectionMaterial=r.MaterialUtil.createHighlightMaterial(),this.selectionMaterial.colorState=r.EnumShaderColorState.SELECT,this.selectionMaterial.name="selection",this.selectionMaterial.refreshUniforms(),this.hoverId=void 0,this.hoverMaterialDefaultParams={color:14540253,opacity:.9,transparent:!0,side:THREE.DoubleSide},this.hoverMaterial=r.MaterialUtil.createStandardMaterial(this.hoverMaterialDefaultParams),this.hoverMaterial.name="hover",this.modelManager=e,this.blinkComponentIdsMap={},this.blinkComponentIdsDetailMap={},this.blinkMaterialMap={};var t=this;this.filter=e.getFilter(),this.filter.setObserverForSceneState((function(i,r){t.removeSelection(i,r),t.clearBlinkComponentsById(i,r),e.viewer.render()})),this.phongHoverMaterial=new THREE.MeshPhongMaterial(this.hoverMaterialDefaultParams),this.phongSelectionMaterial=new THREE.MeshPhongMaterial(r.GlobalData.SelectionColor)},r.SceneStateHelper.prototype={constructor:r.SceneStateHelper,destroy:function(){this.selectionSet=null,this.blinkComponentIdsMap=null,this.blinkComponentIdsDetailMap=null,this.blinkMaterialMap=null,this.modelManager=null,this.selectionMaterial.destroy(),this.selectionMaterial=null,this.hoverMaterial.destroy(),this.hoverMaterial=null,this.phongHoverMaterial.dispose(),this.phongHoverMaterial=null,this.phongSelectionMaterial.dispose(),this.phongSelectionMaterial=null},_dispatchChangeEvent:function(){var e=this.getSelectionMap();this.modelManager.dispatchEvent({type:r.EVENTS.ON_SELECTION_CHANGED,selectionList:e})},getSelectionMap:function(){var e={};for(var t in this.selectionSet)e[t]=Object.keys(this.selectionSet[t]);return e},clearSelection:function(e,t){var i,a=!1;if(t=r.Utils.defaultValue(t,!0),void 0===e){var n=[];for(var s in this.selectionSet){for(var o in a=!1,i=this.getSelectionSet(s))if(i.hasOwnProperty(o)){a=!0;break}a&&n.push(s)}if(n.length){for(var l=0,d=n.length;l<d;l++)this.selectionSet[n[l]]={},this.modelManager.clearSelection(n[l]);t&&this._dispatchChangeEvent()}}else{for(var o in i=this.getSelectionSet(e))if(i.hasOwnProperty(o)){a=!0;break}a&&(this.selectionSet[e]={},this.modelManager.clearSelection(e),t&&this._dispatchChangeEvent())}},addSelection:function(e,t){if(e&&!(e.length<1)){var i,a=[],n=!1,s=this.modelManager,o=this.filter;if(void 0===t){for(var l={},d=s.getModelIds(),h=[],c=0,u=d.length;c<u;c++){var p=d[c];i=this.getSelectionSet(p),n=!1;for(var m=e.length-1;m>=0;m--){var f=e[m];s.isUserIdExist(f,p)&&(!i[f]&&o.isComponentActive(f,p)&&(i[f]=p,n=!0),l[f]=!0)}n&&h.push(p)}for(m=e.length-1;m>=0;m--){l[f=e[m]]||a.push(f)}if(a.length>0&&s.dispatchEvent({type:r.EVENTS.ON_SELECTION_FAILED,failedId:a}),h.length){for(var g=0,v=h.length;g<v;g++)this.modelManager.applySelection(h[g]);this._dispatchChangeEvent()}}else{i=this.getSelectionSet(t);for(m=e.length-1;m>=0;m--){f=e[m];s.isUserIdExist(f,t)?!i[f]&&o.isComponentActive(f,t)&&(i[f]=t,n=!0):a.push(f)}a.length>0&&s.dispatchEvent({type:r.EVENTS.ON_SELECTION_FAILED,failedId:a}),n&&(this.modelManager.applySelection(t),this._dispatchChangeEvent())}}},setSelection:function(e,t){if(e&&!(e.length<1))if(void 0===t){for(var i in this.selectionSet){let e=Object.keys(this.selectionSet[i]).length>0;delete this.selectionSet[i],e&&this.modelManager.applySelection(i)}this.addSelection(e)}else this.selectionSet[t]={},this.addSelection(e,t)},removeSelection:function(e,t){if(e&&!(e.length<1)){var i=!1;if(void 0===t){var r=[];for(var a in this.selectionSet){var n=this.getSelectionSet(a);i=!1;for(var s=0,o=e.length;s<o;++s){n[l=e[s]]&&(delete n[l],i=!0)}i&&r.push(a)}if(r.length){for(s=0,o=r.length;s<o;s++)this.modelManager.applySelection(r[s]);this._dispatchChangeEvent()}}else{for(n=this.getSelectionSet(t),s=0,o=e.length;s<o;++s){var l;n[l=e[s]]&&(delete n[l],i=!0)}i&&(this.modelManager.applySelection(t),this._dispatchChangeEvent())}}},getSelection:function(e){var t={};if(void 0===e)for(var i in this.selectionSet)for(var r=this.getSelectionSet(i),a=Object.keys(r),n=0,s=a.length;n<s;n++)t[a[n]]=!0;else t=this.getSelectionSet(e);return Object.keys(t)},getSelectionWithModelId:function(e){const t=[];if(void 0===e)for(var i in this.selectionSet){var r=this.getSelectionSet(i);for(const[e,a]of Object.entries(r))i===a&&t.push({modelId:i,selectedId:e})}else selList=this.getSelectionSet(e);return t},hasSelection:function(e){var t,i=!1;if(void 0===e)for(var r in this.selectionSet){for(var a in t=this.getSelectionSet(r))if(t.hasOwnProperty[a]){i=!0;break}if(i)break}else for(var a in t=this.getSelection(e))if(t.hasOwnProperty[a]){i=!0;break}return i},getSelectionSet:function(e){if(void 0===e){var t={};for(var i in this.selectionSet)for(var r=this.getSelectionSet(i),a=Object.keys(r),n=0,s=a.length;n<s;n++)t[a[n]]=!0;return t}return void 0===this.selectionSet[e]&&(this.selectionSet[e]={}),this.selectionSet[e]},isSelected:function(e,t){var i,r=!1;if(void 0===t){for(var a in this.selectionSet)if((i=this.selectionSet[a])&&i[e]){r=!0;break}}else(i=this.selectionSet[t])&&i[e]&&(r=!0);return r},setHoverId:function(e,t){this.hoverId=e,this.modelManager.applyHover(t)},clearHover:function(e){this.hoverId=void 0,this.modelManager.clearHover(e)},getHoverMaterial:function(e){let t=e&&e.isMeshPhongMaterial?this.phongHoverMaterial.clone():this.hoverMaterial.clone();if(e&&e.hasOwnProperty("color")){var i=e.color.clone();t.color.setHex(i.getHex()),void 0!==e.opacity?t.opacity=e.opacity:t.opacity=this.hoverMaterialDefaultParams.opacity,void 0!==e.transparent?t.transparent=e.transparent:t.transparent=this.hoverMaterialDefaultParams.transparent,void 0!==e.side?t.side=e.side:t.side=this.hoverMaterialDefaultParams.side,void 0!==e.metalness&&(t.metalness=e.metalness),void 0!==e.roughness&&(t.roughness=e.roughness),void 0!==e.bumpMap&&(t.bumpMap=e.bumpMap),void 0!==e.alphaMap&&(t.alphaMap=e.alphaMap),void 0!==e.emissiveMap&&(t.emissiveMap=e.emissiveMap),void 0!==e.envMap&&(t.envMap=e.envMap),void 0!==e.envMapIntensity&&(t.envMapIntensity=e.envMapIntensity),void 0!==e.map&&null!==e.map&&(t.map=e.map),!0===e.useCompressedColor&&(t.defines.CCOLOR="",t.useCompressedColor=!0),!0===e.vertexColors&&(t.vertexColors=!0),!0===e.useCompressedNormal&&(t.defines.CNORMAL="",t.useCompressedNormal=!0),r.Utils.isDefined(e.useCompressedUv)&&!0===e.useCompressedUv&&(t.uvCenter=e.uvCenter,t.uvHalfExtent=e.uvHalfExtent,t.defines.USE_COMPRESS_UV="",t.useCompressedUv=!0),t.opacity=r.MaterialUtil.getHoverOpacity(t.opacity),t.transparent=!0,t.needsUpdate=!0}return t.refreshUniforms(),t},getHoverColorByMaterial:function(e){var t=void 0!==e.opacity?e.opacity:this.hoverMaterialDefaultParams.opacity;if(t=r.MaterialUtil.getHoverOpacity(t),!e.hasOwnProperty("color"))return{rgbaColor:[this.hoverMaterial.color.r,this.hoverMaterial.color.g,this.hoverMaterial.color.b,t],transparent:true};var i=e.color.clone();return{rgbaColor:[i.r,i.g,i.b,t],transparent:true}},setSelectionColor:function(e,t){var i=this.selectionMaterial.color,r=this.selectionMaterial.opacity;t=null==t?r:t,"0x"+i.getHexString()==e&&r==t||(this.selectionMaterial.color.setHex(e),t&&(this.selectionMaterial.opacity=t),this.selectionMaterial.needsUpdate=!0)},getSelectionMaterial:function(){return this.selectionMaterial.clone()},getModelIdByUserId:function(e){var t,{modelId:i,objectId:r}=this.modelManager.filterHelper.distributeId(e);return i?(t=i,e=r):this.modelManager.modelCollection.some((i=>{if(i.isUserIdExist(e))return t=i.id,!0})),t},addBlinkComponentsByDetail:function(e,t,i,a){void 0===this.blinkComponentIdsDetailMap[a]&&(this.blinkComponentIdsDetailMap[a]={},this.blinkComponentIdsDetailMap[a].detail=i,this.blinkComponentIdsDetailMap[a].enable=!0,this.blinkComponentIdsDetailMap[a].materials=[],this.blinkComponentIdsDetailMap[a].models=[]);let n={};n.modelId=t,n.ids=e,this.addBlinkComponentsById(e,t,i),n.isBimtiles=!1;const s=this.modelManager.getModel(t);s instanceof r.BimTilesModel&&(n.isBimtiles=!0,e.map((e=>{s.blinkTimesMap[e]=0})),delete this.blinkComponentIdsDetailMap[a].materials),this.blinkComponentIdsDetailMap[a].models.push(n);let o=[];s.collectBlinkedMaterial(e,o),this.blinkComponentIdsDetailMap[a].materials&&this.blinkComponentIdsDetailMap[a].materials.push(...o)},setBlinkComponentsById:function(e,t,i){if(e&&0!==e.length){for(var r={},a=e.length-1;a>=0;a--){var n=e[a];r[t=t||this.getModelIdByUserId(n)]||(this.blinkComponentIdsMap[t]={},r[t]=!0),this.filter.isComponentActive(n,t)&&(this.blinkComponentIdsMap[t]=this.blinkComponentIdsMap[t]||{},this.blinkComponentIdsMap[t][n]=i||{})}this.modelManager.blinkManager.applyBlink(t)}},addBlinkComponentsById:function(e,t,i){if(e&&e.length){for(var r=!1,a=e.length-1;a>=0;a--){var n=e[a];t=t||this.getModelIdByUserId(n),this.blinkComponentIdsMap[t]&&this.blinkComponentIdsMap[t][n]||!this.filter.isComponentActive(n,t)||(this.blinkComponentIdsMap[t]=this.blinkComponentIdsMap[t]||{},r=!0),this.blinkComponentIdsMap[t]&&(this.blinkComponentIdsMap[t][n]=i||{})}r&&this.modelManager.blinkManager.applyBlink(t)}},clearBlinkComponentsById:function(e,t){if(e&&e.length){for(var i=!1,r=0,a=e.length;r<a;++r){var n=e[r];t=t||this.getModelIdByUserId(n),this.blinkComponentIdsMap[t]&&this.blinkComponentIdsMap[t][n]&&(this.blinkComponentIdsMap[t]=this.blinkComponentIdsMap[t]||{},delete this.blinkComponentIdsMap[t][n],i=!0)}i&&this.modelManager.blinkManager.applyBlink(t)}},clearBlinkComponentsByDetail:function(e){const t=this.blinkComponentIdsDetailMap[e];if(t){for(const e of t.models)this.clearBlinkComponentsById(e.ids,e.modelId);this.modelManager.blinkManager.clearTime(e),delete this.blinkComponentIdsDetailMap[e]}},enableBlinkComponentsByDetail(e,t){if(!this.blinkComponentIdsDetailMap[e])return;this.blinkComponentIdsDetailMap[e].enable=t;const i=this.blinkComponentIdsDetailMap[e].materials;if(i)i.map((e=>{e.resetBlinkUniformValue()}));else{this.blinkComponentIdsDetailMap[e].models}},clearAllBlinkComponents:function(e){var t=!1,i=this.blinkComponentIds;if(r.Utils.isOwnEmptyObject(i),e){var a=this.blinkComponentIdsMap[e];r.Utils.isOwnEmptyObject(a)||(t=!0,this.blinkComponentIdsMap[e]={})}else t=!0,Object.keys(this.blinkComponentIdsMap).forEach((e=>this.blinkComponentIdsMap[e]=[]));t&&this.modelManager.blinkManager.clearBlink(e)},getBlinkComponents:function(e){if(e)return Object.keys(this.blinkComponentIdsMap[e]||{});var t=[];return Object.keys(this.blinkComponentIdsMap).forEach((e=>t=t.concat(this.blinkComponentIdsMap[e]))),t},getBlinkComponentsIdMap:function(e){return this.modelManager.blinkManager.getBlinkEnabled()?e?this.blinkComponentIdsMap[e]||{}:this.blinkComponentIdsMap:null},getBlinkComponentsColor:function(e,t){if(this.blinkComponentIdsMap[e]&&this.blinkComponentIdsMap[e][t]&&this.blinkComponentIdsMap[e][t].color){const i=this.blinkComponentIdsMap[e][t].color;return new THREE.Vector4(i.red/255,i.green/255,i.blue/255,i.alpha)}},getBlinkComponentIdsDetailMap:function(){return this.modelManager.blinkManager.getBlinkEnabled()?this.blinkComponentIdsDetailMap:null},getBlinkMaterial:function(e,t){return this.blinkMaterialMap[t]&&this.blinkMaterialMap[t][e.uuid]||(void 0===this.blinkMaterialMap[t]&&(this.blinkMaterialMap[t]={}),this.blinkMaterialMap[t][e.uuid]=r.MaterialUtil.getBlinkMaterial(e,this.modelManager.blinkManager.getBlinkColor(t))),this.blinkMaterialMap[t][e.uuid]},getBlinkMaterialV3:function(e,t){return this.blinkMaterialMap[t]&&this.blinkMaterialMap[t][e.uuid]||(void 0===this.blinkMaterialMap[t]&&(this.blinkMaterialMap[t]={}),this.blinkMaterialMap[t][e.uuid]=r.MaterialUtil.getBlinkMaterialV3(e,this.modelManager.blinkManager.getBlinkColor(t))),this.blinkMaterialMap[t][e.uuid]}},r.TimeConstants={SECONDS_PER_MILLISECOND:.001,SECONDS_PER_MINUTE:60,MINUTES_PER_HOUR:60,HOURS_PER_DAY:24,SECONDS_PER_HOUR:3600,MINUTES_PER_DAY:1440,SECONDS_PER_DAY:86400,DAYS_PER_JULIAN_CENTURY:36525,PICOSECOND:1e-9,MODIFIED_JULIAN_DATE_DIFFERENCE:2400000.5},function(){var e;function t(e,t){t=r.JulianDate.addSeconds(e,32.184,t);var i,a=r.JulianDate.totalDays(t)-2451545;return t=r.JulianDate.addSeconds(t,(i=6.239996+.0172019696544*a,.001657*Math.sin(i+.01671*Math.sin(i))),t)}var i=r.Math.RADIANS_PER_DEGREE,a=r.Math.RADIANS_PER_ARCSECOND,n=new THREE.Matrix3;function s(e,t,i,a,s,l,d){if(i<0&&(i=-i,s+=Math.PI),i<0||i>Math.PI)throw new Error("The inclination is out of range. Inclination must be greater than or equal to zero and less than or equal to Pi radians.");var h=e*(1-t),c=a-s,u=s,p=function(e,t){if(t<0||t>=1)throw new Error("eccentricity out of range.");return function(e,t){if(t<0||t>=1)throw new Error("eccentricity out of range.");var i=Math.floor(e/r.Math.TWO_PI);e-=i*r.Math.TWO_PI;var a=Math.cos(e)-t,n=Math.sin(e)*Math.sqrt(1-t*t),s=Math.atan2(n,a);s=r.Math.zeroToTwoPi(s),e<0&&(s-=r.Math.TWO_PI);return s+=i*r.Math.TWO_PI}(function(e,t){if(t<0||t>=1)throw new Error("eccentricity out of range.");var i,a=Math.floor(e/r.Math.TWO_PI),n=(e-=a*r.Math.TWO_PI)+t*Math.sin(e)/(1-Math.sin(e+t)+Math.sin(e)),s=Number.MAX_VALUE;for(i=0;i<50&&Math.abs(s-n)>o;++i){n=(s=n)-(s-t*Math.sin(s)-e)/(1-t*Math.cos(s))}if(i>=50)throw new Error("Kepler equation did not converge");return s=n+a*r.Math.TWO_PI}(e,t),t)}(l-a,t),m=function(e,t){if(e<0)throw new Error("eccentricity cannot be negative.");if(e<=t)return"Circular";if(e<1-t)return"Elliptical";if(e<=1+t)return"Parabolic";return"Hyperbolic"}(t,0);if("Hyperbolic"===m&&Math.abs(r.Math.negativePiToPi(p))>=Math.acos(-1/t))throw new Error("The true anomaly of the hyperbolic orbit lies outside of the bounds of the hyperbola.");!function(e,t,i,a){if(t<0||t>Math.PI)throw new Error("inclination out of range");var n=Math.cos(e),s=Math.sin(e),o=Math.cos(t),l=Math.sin(t),d=Math.cos(i),h=Math.sin(i);r.Utils.defined(a)||(a=new THREE.Matrix3);a.set(d*n-h*s*o,-d*s-h*n*o,h*l,h*n+d*s*o,-h*s+d*n*o,-d*l,s*l,n*l,o)}(c,i,u,n);var f=h*(1+t),g=Math.cos(p),v=Math.sin(p),y=1+t*g;if(y<=r.Math.Epsilon10)throw new Error("elements cannot be converted to cartesian");var M=f/y;return r.Utils.defined(d)?(d.x=M*g,d.y=M*v,d.z=0):d=new THREE.Vector3(M*g,M*v,0),d.applyMatrix3(n)}var o=r.Math.EPSILON8;var l,d=100.46645683*i,h=1295977422.83429*a;var c;function u(n,o){return o=function(n,o){t(n,l);var d=(l.dayNumber-e.dayNumber+(l.secondsOfDay-e.secondsOfDay)/r.TimeConstants.SECONDS_PER_DAY)/r.TimeConstants.DAYS_PER_JULIAN_CENTURY,h=d*d,c=h*d,u=c*d,p=383397.7725+.004*d,m=.055545526-16e-9*d,f=5.15668983*i,g=-8e-5*d+.02966*h-42e-6*c-13e-8*u,v=83.35324312*i,y=14643420.2669*d-38.2702*h-.045047*c+21301e-8*u,M=125.04455501*i,E=-6967919.3631*d+6.3602*h+.007625*c-3586e-8*u,b=218.31664563*i,I=1732559343.4847*d-6.391*h+.006588*c-3169e-8*u,x=297.85019547*i+a*(1602961601.209*d-6.3706*h+.006593*c-3169e-8*u),T=134.96340251*i+a*(1717915923.2178*d+31.8792*h+.051635*c-2447e-7*u),_=357.52910918*i+a*(129596581.0481*d-.5532*h+136e-6*c-1149e-8*u),S=310.17137918*i-a*(6967051.436*d+6.2068*h+.007618*c-3219e-8*u),C=2*x,w=4*x,R=6*x,B=2*T,L=3*T,O=4*T,P=2*(93.27209062*i+a*(1739527262.8478*d-12.7512*h-.001037*c+417e-8*u));p+=3400.4*Math.cos(C)-635.6*Math.cos(C-T)-235.6*Math.cos(T)+218.1*Math.cos(C-_)+181*Math.cos(C+T),m+=.014216*Math.cos(C-T)+.008551*Math.cos(C-B)-.001383*Math.cos(T)+.001356*Math.cos(C+T)-.001147*Math.cos(w-L)-914e-6*Math.cos(w-B)+869e-6*Math.cos(C-_-T)-627e-6*Math.cos(C)-394e-6*Math.cos(w-O)+282e-6*Math.cos(C-_-B)-279e-6*Math.cos(x-T)-236e-6*Math.cos(B)+231e-6*Math.cos(w)+229e-6*Math.cos(R-O)-201e-6*Math.cos(B-P),g+=486.26*Math.cos(C-P)-40.13*Math.cos(C)+37.51*Math.cos(P)+25.73*Math.cos(B-P)+19.97*Math.cos(C-_-P),y+=-55609*Math.sin(C-T)-34711*Math.sin(C-B)-9792*Math.sin(T)+9385*Math.sin(w-L)+7505*Math.sin(w-B)+5318*Math.sin(C+T)+3484*Math.sin(w-O)-3417*Math.sin(C-_-T)-2530*Math.sin(R-O)-2376*Math.sin(C)-2075*Math.sin(C-L)-1883*Math.sin(B)-1736*Math.sin(R-5*T)+1626*Math.sin(_)-1370*Math.sin(R-L),E+=-5392*Math.sin(C-P)-540*Math.sin(_)-441*Math.sin(C)+423*Math.sin(P)-288*Math.sin(B-P),I+=-3332.9*Math.sin(C)+1197.4*Math.sin(C-T)-662.5*Math.sin(_)+396.3*Math.sin(T)-218*Math.sin(C-_);var D=2*S,A=3*S;g+=46.997*Math.cos(S)*d-.614*Math.cos(C-P+S)*d+.614*Math.cos(C-P-S)*d-.0297*Math.cos(D)*h-.0335*Math.cos(S)*h+.0012*Math.cos(C-P+D)*h-16e-5*Math.cos(S)*c+4e-5*Math.cos(A)*c+4e-5*Math.cos(D)*c;var N=2.116*Math.sin(S)*d-.111*Math.sin(C-P-S)*d-.0015*Math.sin(S)*h;return y+=N,I+=N,E+=-520.77*Math.sin(S)*d+13.66*Math.sin(C-P+S)*d+1.12*Math.sin(C-S)*d-1.06*Math.sin(P-S)*d+.66*Math.sin(D)*h+.371*Math.sin(S)*h-.035*Math.sin(C-P+D)*h-.015*Math.sin(C-P+S)*h+.0014*Math.sin(S)*c-.0011*Math.sin(A)*c-9e-4*Math.sin(D)*c,s(p*=1e3,m,f+g*a,v+y*a,M+E*a,b+I*a,o)}(n,o),o.multiplyScalar(-.01215058143522694)}var p=new THREE.Vector3;r.Simon1994PlanetaryPositions=class{constructor(){}static computeSunPositionInEarthInertialFrame(n,o){return r.Utils.defined(n)||(n=r.JulianDate.now()),r.Utils.defined(o)||(o=new THREE.Vector3),c||(c=new THREE.Matrix3).set(1.0000000000000002,5619723173785822e-31,4690511510146299e-34,-5154129427414611e-31,.9174820620691819,-.39777715593191376,-223970096136568e-30,.39777715593191376,.9174820620691819),p=function(n,o){l||(l=new r.JulianDate(0,0,r.TimeStandard.TAI)),t(n,l),e||(e=new r.JulianDate(2451545,0,r.TimeStandard.TAI));var c=(l.dayNumber-e.dayNumber+(l.secondsOfDay-e.secondsOfDay)/r.TimeConstants.SECONDS_PER_DAY)/(10*r.TimeConstants.DAYS_PER_JULIAN_CENTURY),u=.3595362*c,p=149598022260.7121+957426.3679999999*Math.cos(16002*u)+-2243968.05*Math.sin(16002*u)+-2273887.624*Math.cos(21863*u)+-688150.202*Math.sin(21863*u)+927506.794*Math.cos(32004*u)+1017265.516*Math.sin(32004*u)+-119678.29599999999*Math.cos(10931*u)+807828.498*Math.sin(10931*u)+478713.18399999995*Math.cos(14529*u)+209437.01799999998*Math.sin(14529*u)+-613351.267*Math.cos(16368*u)+359034.888*Math.sin(16368*u)+284235.953*Math.cos(15318*u)+-418874.03599999996*Math.sin(15318*u)+-164557.657*Math.cos(32794*u)+329115.314*Math.sin(32794*u),m=d+h*c+-325e-7*Math.cos(10*u)+-105e-7*Math.sin(10*u)+-322e-7*Math.cos(16002*u)+-137e-7*Math.sin(16002*u)+-7899999999999999e-21*Math.cos(21863*u)+258e-7*Math.sin(21863*u)+23199999999999998e-21*Math.cos(10931*u)+35e-7*Math.sin(10931*u)+-5199999999999999e-21*Math.cos(1473*u)+-11599999999999999e-21*Math.sin(1473*u)+97e-7*Math.cos(32004*u)+-88e-7*Math.sin(32004*u)+55e-7*Math.cos(4387*u)+-112e-7*Math.sin(4387*u)+-41e-7*Math.cos(73*u)+-8e-6*Math.sin(73*u);return s(p,.0167086342-.0004203654*c,469.97289*a*c,102.93734808*i+11612.3529*a*c,174.87317577*i-8679.27034*a*c,m,o)}(n,p),o.copy(p),o.negate(),u(n,p),o.sub(p),o.applyMatrix3(c),o}}}(),function(){var e,t={UTC:0,TAI:1};class i{constructor(e,t){this.julianDate=e,this.offset=t}}function a(e,t,i){var a=t/r.TimeConstants.SECONDS_PER_DAY|0;return e+=a,(t-=r.TimeConstants.SECONDS_PER_DAY*a)<0&&(e--,t+=r.TimeConstants.SECONDS_PER_DAY),i.dayNumber=e,i.secondsOfDay=t,i}function n(e,t){return o.compare(e.julianDate,t.julianDate)}function s(t){e||(e=new i),e.julianDate=t;var a=o.leapSeconds,s=r.Utils.binarySearch(a,e,n);s<0&&(s=~s),s>=a.length&&(s=a.length-1);var l=a[s].offset;s>0&&(o.secondsDifference(a[s].julianDate,t)>l&&(l=a[--s].offset));o.addSeconds(t,l,t)}class o{constructor(e,i,n){this.dayNumber=void 0,this.secondsOfDay=void 0,e=r.Utils.defaultValue(e,0),i=r.Utils.defaultValue(i,0),n=r.Utils.defaultValue(n,t.UTC);var o=0|e;a(o,i+=(e-o)*r.TimeConstants.SECONDS_PER_DAY,this),n===t.UTC&&s(this)}static compare(e,t){if(!r.Utils.defined(e))throw new Error("left is required.");if(!r.Utils.defined(t))throw new Error("right is required.");var i=e.dayNumber-t.dayNumber;return 0!==i?i:e.secondsOfDay-t.secondsOfDay}static secondsDifference(e,t){if(!r.Utils.defined(e))throw new Error("left is required.");if(!r.Utils.defined(t))throw new Error("right is required.");return(e.dayNumber-t.dayNumber)*r.TimeConstants.SECONDS_PER_DAY+(e.secondsOfDay-t.secondsOfDay)}static addSeconds(e,t,i){if(!r.Utils.defined(e))throw new Error("julianDate is required.");if(!r.Utils.defined(t))throw new Error("seconds is required.");if(!r.Utils.defined(i))throw new Error("result is required.");return a(e.dayNumber,e.secondsOfDay+t,i)}static fromDate(e,i){if(!(e instanceof Date)||isNaN(e.getTime()))throw new Error("date must be a valid JavaScript Date.");var n=function(e,t,i,a,n,s,o){var l=(t-14)/12|0,d=e+4800+l,h=(1461*d/4|0)+(367*(t-2-12*l)/12|0)-(3*((d+100)/100|0)/4|0)+i-32075;(a-=12)<0&&(a+=24);var c=s+(a*r.TimeConstants.SECONDS_PER_HOUR+n*r.TimeConstants.SECONDS_PER_MINUTE+o*r.TimeConstants.SECONDS_PER_MILLISECOND);return c>=43200&&(h-=1),[h,c]}(e.getUTCFullYear(),e.getUTCMonth()+1,e.getUTCDate(),e.getUTCHours(),e.getUTCMinutes(),e.getUTCSeconds(),e.getUTCMilliseconds());return r.Utils.defined(i)?(a(n[0],n[1],i),s(i),i):new o(n[0],n[1],t.UTC)}static now(e){return o.fromDate(new Date,e)}static computeTaiMinusUtc(t){e.julianDate=t;var i=o.leapSeconds,a=r.Utils.binarySearch(i,e,n);return a<0&&(a=~a,--a<0&&(a=0)),i[a].offset}static totalDays(e){if(!r.Utils.defined(e))throw new Error("julianDate is required.");return e.dayNumber+e.secondsOfDay/r.TimeConstants.SECONDS_PER_DAY}}o.leapSeconds=[new i(new o(2441317,43210,t.TAI),10),new i(new o(2441499,43211,t.TAI),11),new i(new o(2441683,43212,t.TAI),12),new i(new o(2442048,43213,t.TAI),13),new i(new o(2442413,43214,t.TAI),14),new i(new o(2442778,43215,t.TAI),15),new i(new o(2443144,43216,t.TAI),16),new i(new o(2443509,43217,t.TAI),17),new i(new o(2443874,43218,t.TAI),18),new i(new o(2444239,43219,t.TAI),19),new i(new o(2444786,43220,t.TAI),20),new i(new o(2445151,43221,t.TAI),21),new i(new o(2445516,43222,t.TAI),22),new i(new o(2446247,43223,t.TAI),23),new i(new o(2447161,43224,t.TAI),24),new i(new o(2447892,43225,t.TAI),25),new i(new o(2448257,43226,t.TAI),26),new i(new o(2448804,43227,t.TAI),27),new i(new o(2449169,43228,t.TAI),28),new i(new o(2449534,43229,t.TAI),29),new i(new o(2450083,43230,t.TAI),30),new i(new o(2450630,43231,t.TAI),31),new i(new o(2451179,43232,t.TAI),32),new i(new o(2453736,43233,t.TAI),33),new i(new o(2454832,43234,t.TAI),34),new i(new o(2456109,43235,t.TAI),35),new i(new o(2457204,43236,t.TAI),36),new i(new o(2457754,43237,t.TAI),37)],r.TimeStandard=t,r.LeapSecond=i,r.JulianDate=o}(),(()=>{let e=new THREE.Vector3,t=new THREE.Vector3,i=new THREE.Plane,a=new THREE.Frustum,n=new THREE.Box3,s=new THREE.Box3,o=new THREE.Matrix4,l=new THREE.Matrix4,d=!0;r.Viewer=class{constructor(e={}){this._options=r.Utils.defaultValue(e,{}),this._initEarth=r.Utils.defaultValue(this._options.setupEarth,!1),this._earthResource=this._options.earthResource,this.globalRendering=this._initEarth,this._demOptions=r.Utils.defaultValue(this._options.demOptions,{});this._baseGeoCoordinates=r.Utils.defaultValue(this._options.initialGeoCoordinates,{lon:116.40016,lat:39.91645,height:100}),this._staticResourcesHost=r.Utils.defaultValue(this._options.staticResourcesHost,"../../resources"),this._dampingOpts=r.Utils.defaultValue(this._options.damping,{}),this.domElement=null,this.camera=null,this.gisMode=r.Utils.defaultValue(this._options.gisMode,!1),this.callbacks={},this.tmpBox=new THREE.Box3,this.enableCameraNearFar=!0,this.currentHomeView=r.EnumStandardView.ISO,this.initialView=r.EnumStandardView.ISO,this.modelManager=new r.ModelManager(this),this.editorManager=new r.EditorManager,this.inputStatusMonitor=new r.InputStatusMonitor(this.editorManager),this.viewshedManager=new r.ViewshedManager(this),this.videoCastManager=new r.VideoCastManager(this),r.GroundPrimitiveManager.createInstance(this),r.GIS.ApproximateTerrainHeights._viewer=this,this.isRecalculationPlanes=!1,this.calculationPlanesBind=this.calculationPlanes.bind(this),this.addRenderFinishedCallback(this.calculationPlanesBind),this.transitionAnimationState=!0,this.animator=new r.CameraAnimator,this.animator.setDuration(1e3),this.IBLManager=new r.IBLManager(this),this.TextureManager=new r.TextureManager(this),this.rendererManager=new r.RendererManager(this),this.terrainOperationManager=new r.TerrainOperationManager(this),this.holesManager=new r.HolesManager(this),this.refleRefraManager=new r.RefleRefraManager(this),this.scissorViewportManager=new r.ScissorViewportManager(this),this.cameraStateWithFrustum=!1,this.filterHelper=this.modelManager.getFilterHelper(),this.ground=null,this.basePointPositionOnLonLat=null,this.virtualEarthComplete=!0,this._setupEarth(!0),this.minimumFPS=4,this.clientSize=new THREE.Vector2,this.webgl2Support=!0,this.showTileType=r.EnumShowTileType.All,this._foveatedConeLimit={priorityEnabled:r.Utils.defaultValue(e.foveatedConePriority,!1),foveatedConeFactor:r.Utils.defined(e.foveatedConeFactor)?r.Math.clamp(e.foveatedConeFactor,0,1):1,foveatedSseRelaxation:r.Utils.defined(e.foveatedSseRelaxation)?e.foveatedSseRelaxation:0,degradedFactor:r.Utils.defined(e.degradedFactor)?r.Math.clamp(e.degradedFactor,0,1):1},r.EnableStorage=this._options.enableStorage,window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB||window.msIndexedDB||(r.EnableStorage=!1)}addCallbacks(e,t){var i=this.callbacks[e];i||(i=[],this.callbacks[e]=i),-1===i.indexOf(t)&&i.push(t)}removeCallbacks(e,t){var i=this.callbacks[e];if(i){var r=i.indexOf(t);-1!==r&&i.splice(r,1)}}removeAllCallbacks(){for(var e in this.callbacks)for(var t=this.callbacks[e],i=0,r=t.length;i<r;i++)t.splice(0,1);for(var e in this.callbacks)delete this.callbacks[e];this.callbacks={}}onCallbacks(e){var t=this.callbacks[e];if(t)for(var i=0;i<t.length;i++)t[i]&&t[i]()}addRenderCallback(e){this.addCallbacks(r.EnumRenderCallbackType.RENDER,e)}removeRenderCallback(e){this.removeCallbacks(r.EnumRenderCallbackType.RENDER,e)}onRenderCallback(){this.onCallbacks(r.EnumRenderCallbackType.RENDER)}addRenderFinishedCallback(e){this.addCallbacks(r.EnumRenderCallbackType.FINISH_RENDER,e)}removeRenderFinishedCallback(e){this.removeCallbacks(r.EnumRenderCallbackType.FINISH_RENDER,e)}onRenderFinishedCallback(){this.onCallbacks(r.EnumRenderCallbackType.FINISH_RENDER)}destroy(){this.removeAllCallbacks(),this.refleRefraManager.dispose(),this.scissorViewportManager.dispose(),this.terrainOperationManager.dispose(),this.holesManager.dispose(),this.heightLimitManager&&this.heightLimitManager.dispose(),this.clipCapsManager&&this.clipCapsManager.dispose(),this.terrainOperationManager=null,this.holesManager=null,this.refleRefraManager=null,this.scissorViewportManager=null,this.renderSettings.canvas=null,this.renderSettings.context=null,this.renderSettings=null,this.rendererManager.destroy(),this.rendererManager=null,this.cameraControl.destroy(),this.cameraControl=null,this.camera=null,this.defaultCamera=null,this.viewshedManager.destroy(),this.viewshedManager=null,this.videoCastManager.destroy(),this.videoCastManager=null,this.filterHelper=null,this.editorManager.destroy(),this.inputStatusMonitor.destroy(),this.inputStatusMonitor=null,this.modelManager.destroy(),this.modelManager=null,this.editorManager=null,this.domElement=null,this.callbacks=null,this.tmpBox=null,this.calculationPlanesBind=null,this.animator=null,this.IBLManager=null,this._options=null,this.TextureManager.destroy(),this.TextureManager=null,r.GIS.ApproximateTerrainHeights._viewer=null,r.GroundPrimitiveManager.destroyInstance()}init(e){r.GlobalData.IsMobile=!this.isDesktop();var t,i=this,a={alpha:!0,preserveDrawingBuffer:!0,antialias:!0,maxDrawCacheNum:r.GlobalData.maxDrawCacheNum,stencil:!0,logarithmicDepthBuffer:!1,xrCompatible:!0};r.GlobalData.EnableLogarithmicDepthBuffer&&(a.logarithmicDepthBuffer=!0);try{t=document.createElement("canvas");let e=null,i=r.Utils.getOS();"macOS"!==i&&"ios"!==i||(r.GlobalData.ForcedUseWebgl1=!0);let n=()=>{this.webgl2Support=!1,e=t.getContext("webgl",a)||t.getContext("experimental-webgl",a)};!0===r.GlobalData.ForcedUseWebgl1?n():(e=t.getContext("webgl2",a),r.Utils.isDefined(e)||n()),r.Utils.isDefined(e)||(a.antialias=!1),a.context=e}catch(e){return!1}this.domElement=e,r.GeomUtil.initializeUnitInstances(),a.canvas=t,this.renderSettings=a;var n=e.offsetWidth,s=e.offsetHeight,o={width:n,height:s,fov:45,near:.1,far:20*r.GlobalData.SceneSize};return this.camera=this.defaultCamera=new r.Camera(r.CAMERATYPE.PERSPECTIVE,o),this.cameraControl=new r.CameraControl(this,this.getScene(),this.camera,this.domElement,(function(e){i.render(e)}),this._dampingOpts),r.GroundPrimitiveManager.getInstance().setSize(n,s),this.terrainOperationManager.setSize(n,s),this.holesManager.setSize(n,s),this.setEditorDefault(),this.getScene().lightManager.initCSM(this),this.modelManager.onUpdateViewer=function(){i.render(!0)},this.registerEventListener(r.EVENTS.ON_LOAD_INVALID_SCENE,(e=>{})),this.editorManager.registerDomEventListeners(this.domElement),!0}render(e){var t=this.getRenderer();t&&t.xr&&t.xr.enabled||this.rendererManager.render(e)}renderWithXR(){this.rendererManager.renderer._render()}resize(e,t){this.camera&&(this.camera.setSize(e,t),this.camera.updateProjectionMatrix(),this.getRenderer()&&(this.rendererManager.setSize(e,t),r.GroundPrimitiveManager.getInstance().setSize(e,t),this.terrainOperationManager.setSize(e,t),this.holesManager.setSize(e,t),this.modelManager.updateMaterialsValue("viewportSize",new THREE.Vector2(e,t)),this.clipCapsManager&&this.clipCapsManager.setSize(e,t),this.onCallbacks("resize"),this.render()))}resizeByFrustum(e,t){this.camera&&this.getRenderer()&&(this.camera.updateProjectionMatrixByFrustum=!0,this.camera.setSizeByFrustum(e,t),this.render(),this.camera.updateProjectionMatrixByFrustum=!1)}calculateNearFar(e){if(!this.enableCameraNearFar)return;const t=this.getScene(),i=t.getBoundingBoxWorld();if(!i)return;var a=this.camera,n=this.tmpBox;if(n.copy(i),r.GlobalData.EnableGisMap){var s=t.calculateGisMapBox(a);n.union(s)}var o=this.getCurrentEditor();if(o.name===r.EditorMode.THIRDPERSONWALK&&o.prepared){var l=o.object.box;n.union(l)}if(4==r.GlobalData.LightPreset&&t.lightManager.shadowBox){var d=t.getShadowBoxWorld();n.union(d)}if(null!==r.ContactShadow.getInstance()){const e=r.ContactShadow.getInstance().getShadowBoxWorld();n.union(e)}if(n.applyMatrix4(t.getMatrixGlobal()),e&&e.fillClipPlane&&t.fillClipPlane){const e=t.fillClipPlane.getFillClipPlaneBoundingBox();n.union(e)}const h=r.GroundPrimitiveManager.getInstance();if(h){const e=h.getGroundMinHeight();void 0!==e&&(n.min.y=Math.min(n.min.y,e))}const c=this.globalRendering?.1:void 0;a.calculateNearFar(n,c)}resetSelectionColor(e,t){this.modelManager.sceneState.setSelectionColor(e,t)}calculateMinDistance(e,t){function i(e,t){for(var i=0,r=0,a=0;a<3;a++){var n=e.min.getComponent(a),s=e.max.getComponent(a),o=t.min.getComponent(a),l=t.max.getComponent(a),d=0;n>l?d=n-l:s<o&&(d=o-s),i+=d*d;var h=Math.max(l,s)-Math.min(n,o);r+=h*h}return{minDis:Math.sqrt(i),maxDis:Math.sqrt(r)}}var a=new THREE.Vector3,d=new THREE.Vector3,h=new THREE.Vector3;function c(e,t,i,r,n,s){a.fromBufferAttribute(t,i),d.fromBufferAttribute(t,r),h.fromBufferAttribute(t,n),s&&(a.applyMatrix4(s),d.applyMatrix4(s),h.applyMatrix4(s)),e.push(a),e.push(d),e.push(h)}function u(e,t,i){for(var a={start:null,end:null,minDistance:i},n=e.mesh,s=e.indexInfo,d=p(e,o),h=n.geometry,u=h.attributes.position,m=s?s.indexStart:0,f=h.getIndex().array,g=s?s.indexStart+s.indexCount:f.length,v=t.mesh,y=t.indexInfo,M=p(t,l),E=m,b=g;E<b;E+=3){var I=[];c(I,u,f[E],f[E+1],f[E+2],d);var x=r.Utils.minDistanceBetweenTriToMesh(I,v,y,M);x.minDistance<a.minDistance&&(a.minDistance=x.minDistance,a.start=x.start,a.end=x.end)}return a}function p(e,t){return e.unitsMatrix?e.matrix?t.copy(e.matrix).premultiply(e.unitsMatrix):t.copy(e.unitsMatrix):e.matrix?t.copy(e.matrix):void 0}var m=this.modelManager.getMinDistanceObjects(e,t);if(!m)return-1;var f=[],g={start:null,end:null,minDistance:Number.POSITIVE_INFINITY};for(var v in m)f.push(m[v]);if(f[0].length<1||f[1].length<1)return-1;var y=f[0],M=f[1],E=y.length,b=M.length,I=null,x=Number.POSITIVE_INFINITY;if(E>1||b>1){I={};for(var T=0;T<E;T++)for(var _=y[T],S=0;S<b;S++){var C=M[S];n.copy(_.boundingBox),_.unitsMatrix&&n.applyMatrix4(_.unitsMatrix),s.copy(C.boundingBox),C.unitsMatrix&&s.applyMatrix4(_.unitsMatrix);var w=i(n,s);x=x<w.maxDis?x:w.maxDis,I[T+"_"+S]=w}}for(T=0;T<E;T++)for(_=y[T],S=0;S<b;S++){if(I){var R=I[T+"_"+S].minDis;if(R>x||R>g.minDistance)continue}var B=u(_,C=M[S],g.minDistance);if(B.minDistance<g.minDistance&&(g.minDistance=B.minDistance,g.start=B.start,g.end=B.end),0==g.minDistance)return g}return I=null,g}registerDomEventListeners(){this.domElement&&this.editorManager.registerDomEventListeners(this.domElement)}unregisterDomEventListeners(){this.domElement&&this.editorManager.unregisterDomEventListeners(this.domElement)}registerEventListener(e,t){this.modelManager.addEventListener(e,t)}unregisterEventListener(e,t){this.modelManager.removeEventListener(e,t)}load(e){var t=this,i=this.getModelManager();return e.lightmapDatabagId&&(r.GlobalData.InstanceSharedMeshEnabled=!1),i.load(e,(function(){t.rendererManager.setupRenderer(t.renderSettings)}),(function(r){i.updateFilterManager(),i.getFilter().calculateVisibleComponentsBbox(),i.setDrawableModel(!0),i.checkIfFirstModelLoaded(),t.camera.dirty||e.loadConfig&&!1===e.loadConfig.zoomAll?t.render():(t.goToInitialView(),t.zoomAll()),r.materialManager&&r.materialManager.delayUpdateTexturePkgMapping(void 0,(()=>{i.setRenderStateChanged(!0),t.render()}))}))}_setupEarth(e){if(this.globeEarth||!this._initEarth)return void this.modelManager.dispatchEvent({type:r.EVENTS.ON_EARTH_ANIMATION_COMPLETE});this.virtualEarthComplete=!1,e=r.Utils.defaultValue(e,!0);const t={_baseGeoCoordinates:this._baseGeoCoordinates,earthResource:this._earthResource},i=this.globeEarth=new r.VirtualEarth(this,t);i.setupEarth().then((()=>{const t={destination:this._baseGeoCoordinates,globe:i,changeToWorkSpace:!0};this.cameraControl.zoomToHeight(t,i).then((()=>{e&&this.showWorkSpaceScene()}))})).catch((()=>{this.showWorkSpaceScene(),console.log("can not load texture, setup earth failed")}))}unload(e){var t=this;this.getModelManager().unload(e,(function(){t.render()}))}unloadAll(){this.getModelManager().unloadAll(),this.render()}showScene(e,t){var i=this;this.getModelManager().setModelVisibility(e,t,(function(){i.render()}))}showWorkSpaceScene(){this.globalRendering=!1,this.getScene().changeToWorkSpaceScene(),this.globeEarth&&(this.globeEarth.destroy(),this.globeEarth=null,this._initEarth=!1);const e=this.transitionAnimationState;this.transitionAnimationState=!1,this.setStandardView(this.initialView,null,null,(()=>{this.transitionAnimationState=e,this.virtualEarthComplete=!0,this.zoomAll(),this.modelManager.dispatchEvent({type:r.EVENTS.ON_EARTH_ANIMATION_COMPLETE}),this.setRenderStateChanged(!0),this.render()}))}isEarthComplete(){return this.virtualEarthComplete}setModelShellVisible(e,t){this.modelManager.setModelShellVisibility(e,t),this.setRenderStateChanged(!0),this.render()}clearAll(){this.getScene().clearAll()}restore(){this.getFilter().clear(),this.getScene().disableClipPlanes(),this.modelManager.dispatchEvent({type:r.EVENTS.ON_VIEWER_RESTORED})}getScene(){return this.modelManager.scene}getInteractionScene(){return this.modelManager.interactionScene}getCapsScene(){return this.clipCapsManager&&this.clipCapsManager.capsScene}getEditorManager(){return this.editorManager}getUserdataByUserId(e,t){var i=this.modelManager.getNodeInfosByUserId(e,t);return i&&i instanceof Array?i[0].userData:null}getFilter(){return this.modelManager.getFilter()}getCurrentEditorName(){return this.editorManager.getCurrentEditorName()}getCurrentEditor(){return this.editorManager.getCurrentEditor()}setEditorMode(e){this.editorManager.setEditorMode(this,e)}setEditorDefault(){this.editorManager.setupUserInputEditor(this),this.setEditorMode(r.EditorMode.PICK)}getUserInputEditor(){return this.editorManager.getUserInputEditor()}setZoomSpeed(e){this.getUserInputEditor().setZoomSpeed(e)}getZoomSpeed(){return this.getUserInputEditor().getZoomSpeed()}setPickMode(){console.warn("CLOUD.Viewer.setPickMode() has been deprecated. Use CLOUD.Viewer.setEditorMode(name) instead."),this.setEditorMode(r.EditorMode.PICK)}setRectPickMode(){console.warn("CLOUD.Viewer.setRectPickMode() has been deprecated. Use CLOUD.Viewer.setEditorMode(name) instead."),this.setEditorMode(r.EditorMode.PICK_BY_RECT)}setOrbitMode(){console.warn("CLOUD.Viewer.setOrbitMode() has been deprecated. Use CLOUD.Viewer.setEditorMode(name) instead."),this.setEditorMode(r.EditorMode.ORBIT)}setZoomMode(){console.warn("CLOUD.Viewer.setZoomMode() has been deprecated. Use CLOUD.Viewer.setEditorMode(name) instead."),this.setEditorMode(r.EditorMode.ZOOM)}setRectZoomMode(){console.warn("CLOUD.Viewer.setRectZoomMode() has been deprecated. Use CLOUD.Viewer.setEditorMode(name) instead."),this.setEditorMode(r.EditorMode.ZOOM_BY_RECT)}setPanMode(){console.warn("CLOUD.Viewer.setPanMode() has been deprecated. Use CLOUD.Viewer.setEditorMode(name) instead."),this.setEditorMode(r.EditorMode.PAN)}setFlyMode(){console.warn("CLOUD.Viewer.setFlyMode() has been deprecated. Use CLOUD.Viewer.setEditorMode(name) instead."),this.setEditorMode(r.EditorMode.FLY)}setMeasureMode(){console.warn("CLOUD.Viewer.setMeasureMode() has been deprecated. Use CLOUD.Viewer.setEditorMode(name) instead."),this.setEditorMode(r.EditorMode.MEASURE)}setClipPlanesMode(){console.warn("CLOUD.Viewer.setClipPlanesMode() has been deprecated. Use CLOUD.Viewer.setEditorMode(name) instead."),this.setEditorMode(r.EditorMode.CLIP_BY_BOX)}getBoundingBoxWorld(){return this.getScene().getBoundingBoxWorld()}getBoundingBox(){return this.getScene().getBoundingBox()}zoomIn(e){void 0===e&&(e=.1),e<0&&(e=0),this.cameraControl.zoom(e),this.modelManager.dispatchEvent({type:r.EVENTS.ON_EDITOR_ZOOM_END})}zoomOut(e){void 0===e&&(e=.1),e>0?e*=-1:e=0,this.cameraControl.zoom(e),this.modelManager.dispatchEvent({type:r.EVENTS.ON_EDITOR_ZOOM_END})}zoomAll(e,t){var i=this.getScene().getBoundingBox();r.Utils.isDefined(i)&&this._zoomToLocalBBox(i,e,t)}zoomToBuilding(e,t){this.zoomAll(e,t)}zoomToSelection(e,t,i,a,n=1e3){var s=this.getScene(),o=this.modelManager.sceneState,l=this.getBoundingBoxByIds(o.getSelectionSet(a),a);if(l.isEmpty()&&(l=s.getBoundingBox()),1==this.getTransitionAnimationState()){let t=this.animator.getDuration();this.animator.setDuration(n),this.animator.setStandardView(void 0,this,l,e,void 0,(()=>{"[object Function]"===Object.prototype.toString.call(i)&&i(),this.modelManager.dispatchEvent({type:r.EVENTS.ON_EDITOR_ZOOM_END})})),this.animator.setDuration(t)}else this._zoomToLocalBBox(l,e,t)}_zoomToLocalBBox(e,t,i,a){this.camera.zoomToBBox(e,t,i,a),this.cameraControl.dirtyCamera(!0),this.render(),this.modelManager.dispatchEvent({type:r.EVENTS.ON_EDITOR_ZOOM_END})}zoomToBBox(e,t,i,a,n=1e3){var s=new THREE.Box3;if(e?(s.copy(e),s.applyMatrix4(this.getScene().getMatrixGlobal())):s.copy(this.getScene().getBoundingBox()),1==this.getTransitionAnimationState()){let e=this.animator.getDuration();this.animator.setDuration(n),this.animator.setStandardView(void 0,this,s,t,void 0,(()=>{"[object Function]"===Object.prototype.toString.call(a)&&a(),this.modelManager.dispatchEvent({type:r.EVENTS.ON_EDITOR_ZOOM_END})})),this.animator.setDuration(e)}else this._zoomToLocalBBox(s,t,i)}zoomToBBoxByDirection(i,r,a,n){if(r){if(r&&i){var s=i.clone(),o=s.getCenter(e).add(r);s.applyMatrix4(this.getScene().getMatrixGlobal()),o.applyMatrix4(this.getScene().getMatrixGlobal());var l=o.sub(s.getCenter(t));l.length()>1e-4?(l.normalize(),viewer.camera.realUp.copy(THREE.Object3D.DefaultUp),this._zoomToLocalBBox(s,a,n,l)):this._zoomToLocalBBox(s,a,n)}}else this.zoomToBBox(i,a,n)}zoomToBBoxWithOuterBox(i,r,a,n){if(r){if(r&&i){var s=i.clone(),o=r.getCenter(e);s.applyMatrix4(this.getScene().getMatrixGlobal()),o.applyMatrix4(this.getScene().getMatrixGlobal());var l=o.sub(s.getCenter(t));l.length()>1e-4?(l.normalize(),this.camera.realUp.copy(THREE.Object3D.DefaultUp),this._zoomToLocalBBox(s,a,n,l)):this._zoomToLocalBBox(s,a,n)}}else this.zoomToBBox(i,a,n)}getObjectsInBox(e){var t=new THREE.Box3;return t.copy(e),t.applyMatrix4(this.getScene().getMatrixGlobal()),r.PickUtil.getObjectsInBox(this.getScene(),t,this.modelManager,this)}setStandardView(e,t,i,a){var n,s=this.camera;if(n=this.getScene().getBoundingBox(),r.Utils.isDefined(n))if(this.transitionAnimationState)this.animator.setStandardView(e,this,n,t,i,a);else{s.setStandardView(e,n);this.camera.zoomToBBox(n,t);this.render(),a&&a()}}getLineSelectRange(){return r.GlobalData.LineSelectRange}setLineSelectRange(e){r.GlobalData.LineSelectRange=e}_setStandardView(e,t){var i=this.camera,r=this.getScene().getBoundingBox();i.setStandardView(e,r),i.zoomToBBox(r,t)}setStandardViewWithBox(e,t,i,r){if(t?t.applyMatrix4(this.getScene().getMatrixGlobal()):t=this.getScene().getBoundingBox(),this.transitionAnimationState)this.animator.setStandardView(e,this,t,i);else{var a=this.camera;a.setStandardView(e,t),a.zoomToBBox(t,i,r),this.render()}}setTopView(e,t,i){this.setStandardViewWithBox(r.EnumStandardView.ISO,e,t,i)}setInitialViewType(e){console.warn("CLOUD.Viewer.setInitialViewType() has been deprecated. Use CLOUD.Viewer.setInitialView() instead."),this.setInitialView(e)}setInitialView(e){this.initialView=e,this._setStandardView(e)}goToInitialView(e){this.setStandardView(this.initialView,e,null)}flyToLngLat(e){const t=r.Utils.defaultValue(e,{});return this.cameraControl.flyToLngLat(t)}setHomeViewType(e){console.warn("CLOUD.Viewer.setHomeViewType() has been deprecated. Use CLOUD.Viewer.setHomeView() instead."),this.setHomeView(e)}setHomeView(e){this.currentHomeView=e,this._setStandardView(e)}getHomeView(){return this.currentHomeView}goToHomeView(e){this.setStandardView(this.currentHomeView,e,null)}rotateByAxis(e,t,i){var r=2*Math.PI/60/60*e;if(t&&"x"!=t){if("y"!=t)return void console.warn("Illegal rotation axis for Viewer.rotateByAxis().");this.cameraControl.handleRotation(0,-r,i)}else this.cameraControl.handleRotation(-r,0,i);this.cameraControl.update(!0)}setImageResPath(e){r.GlobalData.TextureResRoot=e}setLightIntensityFactor(e){r.GlobalData.LightIntensityFactor=e}setLimitFrameTime(e){r.GlobalData.IncrementRender&&(e<=0&&(e=30),r.GlobalData.LimitFrameTime=e)}limitFrameRate(e){r.GlobalData.IncrementRender&&(e<=0&&(e=4),this.minimumFPS=e,r.GlobalData.LimitFrameTime=1e3/e)}transformCamera(e){return r.CameraUtil.transformCamera(e,this.modelManager.scene)}getCamera(){var e=this.getScene().getMatrixGlobal(),t=this.cameraControl.getCamera(),i=this.cameraControl.getCameraName(),a=new r.CameraInfo(i,t.position,t.target,t.realUp||t.up);if(a=r.Camera.drawingToWorld(a,e),this.cameraStateWithFrustum)var n=2*(t.near*Math.tan(.5*THREE.Math.DEG2RAD*t.fov)/t.zoom),s=t.aspect*n;let o=null;return o=t.isPerspective?new r.PerspectiveCameraInfo(a.position,a.target,a.up,t.fov,t.aspect,t.near,t.far,t.zoom,void 0,s,n):new r.OrthographicCameraInfo(a.position,a.target,a.up,t.left,t.right,t.top,t.bottom,t.near,t.far,t.zoom,void 0,s,n),o=r.Camera.nearFarDrawingToWorld(o,e),JSON.stringify(o)}setCameraStateWithFrustum(e){this.cameraStateWithFrustum=e}setCamera(e,t,i,a){this.camera.dirty=!0;var n=this,s=r.CameraUtil.parseCameraInfo(e);if(null===s)console.log("Invalid camera info string. Fail to set camera.");else if(this.switchToCamera(s.name)){var o=this.getScene().getMatrixGlobal(),l=r.Camera.worldToDrawing(s,o);if(l.name=s.name,l.zoom=s.zoom,a){var d=new THREE.Vector3(l.position.x,l.position.y,l.position.z),h=new THREE.Vector3(l.target.x,l.target.y,l.target.z),c=new THREE.Vector3(h.distanceTo(d),0,0),u=h.clone().sub(d).normalize(),p=new THREE.Vector3(l.up.x,l.up.y,l.up.z);p.normalize();var m=new THREE.Vector3(l.zoom,0,0);return this.camera.setZoom(m.x),this.camera.LookAt(h,u,p,c.x),void(i&&i())}if(this.transitionAnimationState){var f={position:this.camera.position.clone(),target:this.camera.target.clone(),up:this.camera.realUp.clone()||this.camera.up.clone(),zoom:this.camera.zoom};this.animator.active(f,l,this,(function(e){n.cameraControl.update(!0,!0)}),(function(){s.frustumWidth&&s.frustumHeight&&n.resizeByFrustum(s.frustumWidth,s.frustumHeight),i&&i()}))}else{"orth"===s.name&&n.camera.setZoom(s.zoom);var g=new THREE.Vector3;g.subVectors(l.target,l.position),this.camera.LookAt(l.target,g,l.up),t&&this.cameraControl.updateCamera(),s.frustumWidth&&s.frustumHeight&&(n.cameraControl.update(!0,!0),n.resizeByFrustum(s.frustumWidth,s.frustumHeight)),i&&i()}}}setCameraMinimumElevation(e){if(null!=e){this.camera.minimumElevation=e,e>0?this.cameraControl.updateMinPitch(0):this.cameraControl.updateMinPitch(-Math.PI/2);let t=JSON.parse(this.getCamera());e>t.position.z&&(t.position.z=e,t=JSON.stringify(t),this.setCamera(t,!0,null,!1))}else this.camera.minimumElevation=null,this.cameraControl.updateMinPitch(-Math.PI/2)}getRenderBufferScreenShot(e,t){var i=this.getRenderer().domElement,r=i.toDataURL("image/png"),a=i.width,n=i.height,s=window.devicePixelRatio||1,o=a/s,l=n/s;if(!o||!l)return t?(t(r),null):r;var d,h,c,u=0,p=0;if(o>l||a/n<o/l?(d=o,p=l/2-(h=n/a*o)/2):(h=l,u=o/2-(d=a/n*l)/2),t)return(c=new Image).onload=function(){var i=document.createElement("canvas"),r=i.getContext("2d");i.width=o,i.height=l,e&&(r.fillStyle=e,r.fillRect(0,0,o,l)),r.drawImage(c,u,p,d,h);var a=i.toDataURL("image/png");t(a)},c.src=r,null;(c=new Image).src=r;var m=document.createElement("canvas"),f=m.getContext("2d");return m.width=o,m.height=l,e&&(f.fillStyle=e,f.fillRect(0,0,o,l)),f.drawImage(c,u,p,d,h),m.toDataURL("image/png")}screenShot(e,t,i){var r=this;var a=function(e,t,i){var a=r.getRenderer().domElement,n=a.toDataURL("image/png"),s=a.width,o=a.height,l=(window.devicePixelRatio,e),d=t;if(!l||!d)return i?(i(n),null):n;var h,c,u=0,p=0;if(l>d||s/o<l/d?(h=l,p=d/2-(c=o/s*l)/2):(c=d,u=l/2-(h=s/o*d)/2),i){var m=new Image;return m.onload=function(){var e=document.createElement("canvas"),t=e.getContext("2d");e.width=l,e.height=d,t.drawImage(m,u,p,h,c);var r=e.toDataURL("image/png");i(r)},m.src=n,null}}(e,t,i);return this.render(),a}canvas2image(e,t){var i,r=this;return t?(this.getRenderBufferScreenShot(e,(function(e){t(e),r.render()})),null):(i=this.getRenderBufferScreenShot(e),this.render(),i)}lockAxisZ(t,i){var r=this.cameraControl;if(r){var a=r.getZenith(),n=this.getBoundingBox().getCenter(e);if(t&&void 0!==i||(i=null),i){const e=i[0],t=i[1];a>t?r.handleRotation(0,t-a,n):a<e&&r.handleRotation(0,e-a,n),this.render()}this.cameraControl.lockAxisZ(t),this.cameraControl.setLockAxisZRange(i)}}isLockedAxisZ(){return this.cameraControl.isLockedAxisZ()}enableTranslucentByDClick(e){r.GlobalData.EnableDemolishByDClick=e}enableHitDetection(e){r.GlobalData.EnableHitDetection=e}rotateCamera(e){this.cameraControl.processRotate(e),this.cameraControl.update()}setRotationCenter(e){this.rotationCenter=new THREE.Vector3(e.x,e.y,e.z)}clearRotationCenter(){this.rotationCenter=void 0}getRotationCenter(){return this.rotationCenter}getActiveCameraInfo(){var e={};e.up=new THREE.Vector3,e.dir=new THREE.Vector3,e.quaternion=new THREE.Quaternion;var t=this.camera;return t.getWorldDirection(e.dir),e.up.copy(t.realUp||t.up),t.getWorldQuaternion(e.quaternion),e}calculationPlanes(){if(this.isRecalculationPlanes){this.isRecalculationPlanes=!1;var i=this.getScene(),a=this.getBoundingBoxByIds();a.isEmpty()&&(a=i.getBoundingBox()),r.ClipPlaneManager.getInstance(i).calculationPlanes(a.getSize(t),a.getCenter(e)),this.render()}}recalculationPlanes(){this.isRecalculationPlanes=!0}setOctantDepth(e){r.GlobalData.OctantDepth=e}resizePool(e){r.GlobalData.maxObjectNumInPool=e,this.modelManager.updateSceneRenderable(),this.render()}setCategoriesToHighPriority(e,t){var i=0==t?"inner":"outer";this.modelManager.setCategoriesToHighPriority(e,i)}clearCategoriesFromHighPriority(e){var t=0==e?"inner":"outer";this.modelManager.clearCategoriesFromHighPriority(t)}clearAllCategoriesFromHighPriority(){this.modelManager.clearAllCategoriesFromHighPriority()}isolate(e,t){this.getFilter().isolate(e,t)}setIsolateMaterial(e){this.getFilter().setIsolateMaterial(e)}resetIsolateMaterial(){this.getFilter().resetIsolateMaterial()}setOrbitButton(e){const t=this.editorManager.userInputEditor;r.Utils.isDefined(t)&&t.switchHandMode(e)}showPickedInformation(e){r.UIHelper.showPickedInformation(e)}setOrbitEnabled(e){r.EditorConfig.NoRotate=!0!==e}getOrbitEnabled(){return!r.EditorConfig.NoRotate}setSelectPadCallback(e){var t=this.editorManager.getCurrentEditor();t&&t.selectPad&&(t.selectPad.callback=e)}setDeviceMobile(e){r.GlobalData.IsMobile=e||!1}setPointRotateMode(e){r.EditorConfig.RotatePivotMode=e}worldToDrawing(e){return this.cameraControl?this.getScene().worldToDrawing(e):(console.log("camera is not initialized!!!"),null)}drawingToWorld(e){return this.cameraControl?this.getScene().drawingToWorld(e):(console.log("camera is not initialized!!!"),null)}worldToCanvas(e){var t=this.cameraControl;if(!t)return console.log("camera is not initialized!!!"),null;var i=t.getContainerDimensions();if(!i)return null;var a=t.getCamera(),n=this.getScene().worldToDrawing(e);return r.CameraUtil.drawingToCanvas(a,n,i.width,i.height)}intersectReferencePlane(){r.CameraUtil.intersectReferencePlane(this.camera,this.getScene())}canvasToWorld(e){var t=this.cameraControl;if(!t)return console.log("camera is not initialized!!!"),null;var i=t.getContainerDimensions();if(!i)return null;var a=t.getCamera(),n=this.getScene(),s=r.CameraUtil.canvasToDrawing(a,e,i.width,i.height),o=n.drawingToWorld(s);return{x:o.x,y:o.y,z:o.z}}worldToClient(e){var t=this.cameraControl;if(!t)return console.log("camera is not initialized!!!"),null;var i=t.getContainerDimensions();if(!i)return null;var a=t.getCamera(),n=this.getScene().worldToDrawing(e),s=r.CameraUtil.drawingToCanvas(a,n,i.width,i.height);return s?(s.x+=i.left,s.y+=i.top,s):null}worldPointsToClient(e,t){var i=this.cameraControl;if(!i)return console.log("camera is not initialized!!!"),null;var a=i.getContainerDimensions();if(!a)return null;var n=i.getCamera(),s=this.getScene(),o=s.worldToDrawing(e),l=s.worldToDrawing(t),d=r.CameraUtil.drawingPointsToCanvas(n,o,l,a.width,a.height);return d?(d.start.x+=a.left,d.start.y+=a.top,d.end.x+=a.left,d.end.y+=a.top,d):null}clientToWorld(e){var t=this.cameraControl;if(!t)return console.log("camera is not initialized!!!"),null;var i=t.getContainerDimensions();if(!i)return null;(s={x:e.x,y:e.y,z:e.z}).x-=i.left,s.y-=i.top;var a=t.getCamera(),n=this.getScene(),s=r.CameraUtil.canvasToDrawing(a,s,i.width,i.height),o=n.drawingToWorld(s);return{x:o.x,y:o.y,z:o.z}}insideCamera(e){var t=this.cameraControl;if(!t)return console.log("camera is not initialized!!!"),!1;var i=this.getScene().worldToDrawing(e);return t.getFrustum().containsPoint(i)}locateToPointWithParallelEye(e){var t=this.cameraControl;if(!t)return console.log("camera is not initialized!!!"),!1;var i=this.getScene().worldToDrawing(e);t.flyToPointWithParallelEye(i)}locateToPoint(e){var t=this.cameraControl;if(!t)return console.log("camera is not initialized!!!"),!1;var i=this.getScene().worldToDrawing(e);t.flyToPoint(i)}enableHover(e){e||(this.modelManager.clearHover(),this.render()),r.GlobalData.Hover=e}enableMouseMovePick(e){r.GlobalData.MouseMovePick=e}getObjectsByClientCoordinates(e){return new r.IntersectHelper(this).getObjectsByClientCoordinates(e)}getIBLManager(){return this.IBLManager}loadEnvMap(e){for(var t=["posx.hdr","negx.hdr","posy.hdr","negy.hdr","posz.hdr","negz.hdr"],i=[],r=0;r<6;++r)i.push("/"+e+"/"+t[r]);var a=this;(new THREE.HDRCubeTextureLoader).load(THREE.FloatType,i,(function(e){a.environmentCubeMap=e,a.modelManager.updateMaterialsValue("envMap",e),a.setRenderStateChanged(!0),a.render()}))}setEnvMapIntensity(e){this.modelManager.updateMaterialsValue("envMapIntensity",e),this.setRenderStateChanged(!0),this.render()}closeEnvMap(){this.modelManager.updateMaterialsValue("envMap",null),this.setRenderStateChanged(!0),this.render()}isSupportSSAO(){return!r.GlobalData.IncrementRender}isSSAOEnabled(){return r.GlobalData.SSAO}enableSSAO(e){return 0!=this.isSupportSSAO()&&(r.GlobalData.SSAO==e||(r.GlobalData.SSAO=e,this.setRenderStateChanged(!0),this.render()),!0)}switchNewStyleMaterial(e){this.modelManager.switchNewStyleMaterial(e),this.setRenderStateChanged(!0),this.render()}enableColorWithoutLight(e){this.modelManager.enableColorWithoutLight(e),this.setRenderStateChanged(!0),this.render()}createGround(e){const t=new r.Ground(e);return this.ground=t,t}removeGround(){this.ground&&(this.ground.remove(),this.ground=null)}addPlane(e,t,i,a){var n=new THREE.Vector3;n.addVectors(new THREE.Vector3(e.x,e.y,e.z),new THREE.Vector3(t.x,t.y,t.z)),n.multiplyScalar(.5);var s=new THREE.PlaneBufferGeometry(t.x-e.x,t.y-e.y),o=new THREE.Mesh(s,new THREE.MeshBasicMaterial({side:THREE.DoubleSide,transparent:!0,depthTest:!0}));o.position.copy(n),o.renderOrder=r.EnumRenderOrder.ClipPlane,this.getScene().getOrCreateObjectGroup(r.ObjectGroupType.CUSTOMPLANE,{globalSpace:!0}).add(o),o.updateMatrixWorld(!0);var l=this,d=new THREE.TextureLoader;return d.setCrossOrigin("anonymous"),d.load(i,(function(e){o.material.map=e,o.material.needsUpdate=!0,l.setRenderStateChanged(!0),a&&a()})),o}removePlane(e){var t=this.getScene().getObjectGroup(r.ObjectGroupType.CUSTOMPLANE);t&&t.remove(e)}clearPlane(){var e=this.getScene().getObjectGroup(r.ObjectGroupType.CUSTOMPLANE);e&&e.clear()}enableTextureMapping(e){r.GlobalData.EnableTextureMapping=e}enableLightmap(e){r.GlobalData.EnableLightmap!=e&&(r.GlobalData.EnableLightmap=e)}setLightmapIntensity(e){r.GlobalData.LightmapIntensity!=e&&(r.GlobalData.LightmapIntensity=e)}setReverseWheelDirection(e){r.EditorConfig.ReverseWheelDirection=!!e}getReverseWheelDirection(){return r.EditorConfig.ReverseWheelDirection}setMovementSpeedRate(e){void 0!==e&&(r.EditorConfig.MovementSpeedRate=e)}getMovementSpeedRate(){return r.EditorConfig.MovementSpeedRate}moveTo(e,t,i){var r=this.editorManager.editor;r&&r.moveTo(e,t,i)}rotateTo(e){var t=this.editorManager.editor;t&&t.rotateTo(e)}enableOcclusionTranslucent(e){r.GlobalData.OcclusionTranslucentEnabled=!!e}setOcclusionOpacity(e){r.GlobalData.OcclusionOpacity=e}setOcclusionDistanceToCamera(e){r.GlobalData.OcclusionDistanceToCamera=e}fitAndRotateBySelection(){this.cameraControl&&this.cameraControl.fitAndRotateBySelection()}setRoamingWalkHeight(e,t,i){if(e instanceof Array){var a=this.cameraControl;if(!a)return console.log("camera is not initialized!!!"),!1;if(t<=0&&(t=1750),void 0===i&&(i=!0),a.setCameraHeight(e,t),i){var n=this.editorManager.getCurrentEditor();n&&n.name===r.EditorMode.WALK&&n.update&&a.flyOnWorld()}}else console.log("elevations is not arry")}setRoamingWalkAbsoluteHeight(e,t){var i=this.cameraControl;if(!i)return console.log("camera is not initialized!!!"),!1;if(void 0===t&&(t=!0),i.setCameraAbsoluteHeight(e),t){var a=this.editorManager.getCurrentEditor();a&&a.name===r.EditorMode.WALK&&a.update&&i.flyOnWorld()}}cameraToWorld(e){return this.camera?r.Camera.drawingToWorld(e,this.getScene().getMatrixGlobal()):null}cameraToDrawing(e){return this.camera?r.Camera.worldToDrawing(e,this.getScene().getMatrixGlobal()):null}clearSelection(e){this.modelManager.sceneState.clearSelection(e)}addToSelection(e,t){this.filterHelper.executeIds(e,((e,t)=>{this.modelManager.sceneState.addSelection(t,e.id)}),t)}removeFromSelection(e,t){this.filterHelper.executeIds(e,((e,t)=>{this.modelManager.sceneState.removeSelection(t,e.id)}),t)}setSelection(e,t){this.filterHelper.executeIds(e,((e,t)=>{this.modelManager.sceneState.setSelection(t,e.id)}),t)}getSelection(e){return this.modelManager.sceneState.getSelection(e,e)}getSelectionWithModelId(e){return this.modelManager.sceneState.getSelectionWithModelId(e)}setSelectionColor(e){this.modelManager.sceneState.setSelectionColor(e)}pickByPoint(e,t){var i=this.cameraControl;if(!1===i.enabled)return!1;var r,a=new THREE.Vector2(e.x,e.y),n=i.getIntersectContext(a);r=t?i.intersector.pickGlobe(n):i.intersector.pick(n);var s=this.getScene();if(r){s.intersectToWorld(r,this);var o={};return o.faceIndex=r.faceIndex,o.meshId=r.userId,o.worldPosition=r.worldPosition,o.worldBoundingBox=r.worldBoundingBox,o}return null}pickByPointWithNormal(e){var t=this.getScene(),i=this.cameraControl;if(!1===i.enabled)return null;var r=new THREE.Vector2(e.x,e.y),a=i.getIntersectContext(r),n=i.intersector.pick(a);if(!n)return null;t.intersectToWorld(n,this),n.cx=r.x,n.cy=r.y;var s=[];s.push(n);var o=t.getMatrixGlobal(),l=n.face.normal.clone(),d=n.worldPosition.clone(),h=new THREE.Ray(d,l);h.applyMatrix4(o);var c=i.intersector.getIntersectByRay(a,h);return c&&(t.intersectToWorld(c,this),s.push(c)),s}toDefaultOrthographicCamera(e){this.switchToCamera("orth"),(e||void 0===e)&&this.render()}toDefaultPerspectiveCamera(e){this.switchToCamera("persp"),(e||void 0===e)&&this.render()}getCameraNameList(){return["pesp","orth"].concat(this.modelManager.getCameraNameList())}switchToCamera(e){var t=!0;if("persp"===e)this.camera=this.defaultCamera,this.camera.toPerspective();else if("orth"===e)this.camera=this.defaultCamera,this.camera.toOrthographic();else{var i=this.modelManager.getCamera(e);i?this.camera=i:(console.log("Fail to switch because not found camera '"+e+"'"),t=!1)}return t&&this.cameraControl.setCamera(this.camera),t}getNumOfElements(e){return this.modelManager.getNumOfElements(e)}getNumOfRenderables(e){return this.modelManager.getNumOfRenderables(e)}getNumOfTriangles(e){return this.modelManager.getNumOfTriangles(e)}getNumOfVertices(e){return this.modelManager.getNumOfVertices(e)}setLightPreset(e){r.GlobalData.LightPreset=e,this.getScene().lightPreset(),this.setRenderStateChanged(!0)}getLightPreset(){return r.GlobalData.LightPreset}setAmbientLightIntensity(e){var t=this.getScene().ambientLight;t&&(t.intensity=e,this.setRenderStateChanged(!0))}getAmbientLightIntensity(){var e=this.getScene().ambientLight;return e?e.intensity:void 0}setWalkHeightLocked(e){var t=this.editorManager.getCurrentEditor();t&&t.name===r.EditorMode.WALK&&t.setHeightLocked(e)}setWalkLookMousePressed(e){var t=this.editorManager.getCurrentEditor();t&&t.name===r.EditorMode.WALK&&t.setDragLook(e)}setWalkSpeedRate(e){var t=this.editorManager.getCurrentEditor();t&&(t.name===r.EditorMode.WALK||r.EditorMode.THIRDPERSONWALK)&&(r.EditorConfig.WalkSpeedRate=e)}getWalkSpeedRate(){return r.EditorConfig.WalkSpeedRate}setDrawingStyle(e){r.GlobalData.DrawingStyle=e;const t=e=>{this.modelManager.traverseModels(void 0,(t=>{t instanceof r.BimTilesModel&&t.setBorderLineVisible(e)}))};switch(e){case r.DrawingStyle.SHADINGWITHLINE:t(!0);break;case r.DrawingStyle.SHADING:default:t(!1)}this.setRenderStateChanged(!0)}getWireframeColor(){let e;return this.modelManager.traverseModels(void 0,(t=>{const i=t.wireframeManager;return i?(e=i.getWireframeColor(),!0):t instanceof r.BimTilesModel?(e=t.getWireframeColor(),!0):void 0})),e||r.MaterialUtil.DefaultWireframeColor}setWireframeColor(e){this.modelManager.traverseModels((t=>{const i=t.wireframeManager;i&&i.setWireframeColor(new THREE.Color(e.red/255,e.green/255,e.blue/255),e.alpha),t instanceof r.BimTilesModel&&t.setWireframeColor(new THREE.Color(e.red/255,e.green/255,e.blue/255),e.alpha)})),this.setRenderStateChanged(!0)}restoreWireframeColor(){this.modelManager.traverseModels((e=>{const t=e.wireframeManager;t&&t.restoreWireframeColor(),e instanceof r.BimTilesModel&&e.restoreWireframeColor()})),this.setRenderStateChanged(!0)}setInstanceMode(e){if(!r.GlobalData.Instance===e){if(r.GlobalData.Instance=e,e)this.getScene().getOrCreateObjectGroup(r.ObjectGroupType.INSTANCEGEOMETRY,{globalSpace:!0}).visible=!0;else this.getScene().getOrCreateObjectGroup(r.ObjectGroupType.INSTANCEGEOMETRY,{globalSpace:!0}).visible=!1;this.setRenderStateChanged(!0)}}setTransitionAnimationState(e){this.transitionAnimationState=e}getTransitionAnimationState(){return this.transitionAnimationState}clipConditionPoint(e){const t=r.FillClipPlaneManager.getInstance(this.getScene());if(!(t&&t.isEnabled()&&t.uniforms.vClipPlane.value))return!1;const a=t.uniforms.vClipPlane.value;for(var n=0;n<a.length;++n){const t=a[n];i.setComponents(-t.x,-t.y,-t.z,-t.w),i.normalize();const r=i.normal;if(e.dot(r)<-i.constant)return!0}return!1}clipPoint(e){var t=this.getRenderer();if(!t)return!1;const i=r.FillClipPlaneManager.getCreatedFillClipPlane(this.getScene());if(i&&i.isEnabled()&&i.innerClipping)return o.identity(),a.setFromProjectionMatrix(o.multiplyMatrices(i.orthoCamera.projectionMatrix,i.orthoCamera.matrixWorldInverse)),!!a.containsPoint(e);var n=t.clippingPlanes;if(n&&n.length>0)for(var s=0;s<n.length;++s){var l=n[s],d=l.normal;if(e.dot(d)<-l.constant)return!0}return!1}getExplosionExtent(e){return this.modelManager.explosionManager.getExplosionExtent(e)}setExplosionExtent(e,t){r.GlobalData.EnableExplosion&&this.modelManager.explosionManager.setExplosionExtent(e,t)}setFloorExplosion(e,t,i,a){r.GlobalData.EnableExplosion&&this.modelManager.explosionManager.setFloorExplosion(e,t,i,a)}getFloorExplosionExtent(e){return this.modelManager.explosionManager.getFloorExplosionExtent(e)}getFloorExplosionDirection(e){return this.modelManager.explosionManager.getFloorExplosionDirection(e)}getFloorExplosionList(e){return this.modelManager.explosionManager.getFloorExplosionList(e)}setFloorInfos(e,t){this.modelManager.explosionManager.setFloorInfos(e,t)}getFloorInfos(e){return this.modelManager.explosionManager.getFloorInfos(e)}setExposureShift(e){this.exposureShift=e,r.GlobalData.ToneMapping=1,this.modelManager.setExposureShift(e),this.setRenderStateChanged(!0)}getExposureShift(){return this.exposureShift}setRenderStateChanged(e){this.modelManager&&this.modelManager.setRenderStateChanged(e)}isDesktop(){return r.Utils.isDesktop()}getComponentInfoByUserId(e,t){return this.modelManager.getComponentInfoByUserId(e,t)}getBoundingBoxByIds(e,t){var i=this.modelManager.getBoundingBoxByIds(e,t);return i.isEmpty()||i.applyMatrix4(this.getScene().getMatrixGlobal()),i}convertAnnotationsToV3(e){return r.Compatibility.convertAnnotationsToV3(this,e)}loadMpkOnDemand(e,t,i){var r=this;this.modelManager.getLoadOnDemandDirector().loadMpkOnDemandByConditionsWithDelay(e,(function(){r.rendererManager.forceRenderClearScreen();const e={};d&&(e.forceUpdate=!0,d=!1),r.getModelManager().updateScene(null,e)}),t,i)}getBoundingBoxOnDemand(){return this.modelManager.hasLoadOnDemandDirector()?this.modelManager.getLoadOnDemandDirector().getBoundingBoxOnDemand():null}updateGlowEffect(e,t){var i=this;i.rendererManager&&i.rendererManager.renderer&&i.rendererManager.renderer instanceof r.BatchedRenderer&&null!=i.rendererManager.renderer.composer&&i.rendererManager.renderer.composer.updateGlowEffect(e,t)}setGlowEffectById(e,t,i){var a=this;if(a.rendererManager&&a.rendererManager.renderer&&a.rendererManager.renderer instanceof r.BatchedRenderer){null==a.rendererManager.renderer.composer&&a.rendererManager.renderer._createComposer();var n=a.rendererManager.renderer.composer;if(null==t||0==t.length)return;null!=i.isGis&&1==i.isGis?n.isGis=!0:n.isGis=!1,"body"==i.type&&n.setGlowEffectById(e,t,i),"outline"==i.type&&null!=n.highlightoutlinePass&&n.highlightoutlinePass.setHighLightOutlineById(e,t,i)}}removeGlowEffectById(e,t){this.rendererManager.renderer.composer&&((r.GlobalData.GlowCount>0||r.GlobalData.BloomCount>0)&&this.rendererManager.renderer.composer.removeGlowEffectById(e,t),r.GlobalData.HighLightOutlineCount>0&&null!=this.rendererManager.renderer.composer.highlightoutlinePass&&this.rendererManager.renderer.composer.highlightoutlinePass.removeHighLightOutlineById(e,t))}snowOpt(e){var t=this;if(t.rendererManager&&t.rendererManager.renderer&&t.rendererManager.renderer instanceof r.BatchedRenderer){null==t.rendererManager.renderer.composer&&t.rendererManager.renderer._createComposer();var i=t.rendererManager.renderer.composer;if(null==e)return i.snowEffectOpt();i.snowEffectOpt(e)}}rainOpt(e){var t=this;if(t.rendererManager&&t.rendererManager.renderer&&t.rendererManager.renderer instanceof r.BatchedRenderer){null==t.rendererManager.renderer.composer&&t.rendererManager.renderer._createComposer();var i=t.rendererManager.renderer.composer;if(null==e)return i.rainEffectOpt();i.rainEffectOpt(e)}}fogOpt(e){var t=this;if(t.rendererManager&&t.rendererManager.renderer&&t.rendererManager.renderer instanceof r.BatchedRenderer){null==t.rendererManager.renderer.composer&&t.rendererManager.renderer._createComposer();var i=t.rendererManager.renderer.composer;if(null==e)return i.fogEffectOpt();i.fogEffectOpt(e)}}skylineOpt(e){var t=this;if(t.rendererManager&&t.rendererManager.renderer&&t.rendererManager.renderer instanceof r.BatchedRenderer){null==t.rendererManager.renderer.composer&&t.rendererManager.renderer._createComposer();var i=t.rendererManager.renderer.composer;if(null==e)return i.skylineOpt();i.skylineOpt(e)}}getSkyline3D(){return r.GroundPrimitiveManager.getInstance().getSkyline3D()}updateDemMaterialsSide(){var e;this.modelManager.modelCollection.traverse((t=>{t.isDemLayer&&(e=t.tileManager)})),e&&e.updateMaterialsSide()}addRingScanEffect(e){var t=this;if(t.rendererManager&&t.rendererManager.renderer&&t.rendererManager.renderer instanceof r.BatchedRenderer){null==t.rendererManager.renderer.composer&&t.rendererManager.renderer._createComposer();var i=t.rendererManager.renderer.composer;r.GlobalData.ScanRingCount++;var a=i.addRingScanEffect(e);return t.render(),a}console.warn("请在场景加载成功后,添加环状扫描特效.")}deleteRingScanEffect(e){var t=this;t.rendererManager&&t.rendererManager.renderer&&t.rendererManager.renderer instanceof r.BatchedRenderer&&null!=t.rendererManager.renderer.composer&&(t.rendererManager.renderer.composer.removeRingScanEffect(e)&&r.GlobalData.ScanRingCount--,t.render())}addFanScanEffect(e){const t=this;if(t.rendererManager&&t.rendererManager.renderer&&t.rendererManager.renderer instanceof r.BatchedRenderer){null==t.rendererManager.renderer.composer&&t.rendererManager.renderer._createComposer();const i=t.rendererManager.renderer.composer;r.GlobalData.FanScanCount++;const a=i.addFanScanEffect(e);return t.render(),a}console.warn("请在场景加载成功后,添加扇形扫描特效.")}deleteFanScanEffect(e){const t=this;t.rendererManager&&t.rendererManager.renderer&&t.rendererManager.renderer instanceof r.BatchedRenderer&&null!=t.rendererManager.renderer.composer&&(t.rendererManager.renderer.composer.removeFanScanEffect(e)&&r.GlobalData.FanScanCount--,t.render())}ssaoOpt(e){var t=this;if(t.rendererManager&&t.rendererManager.renderer&&t.rendererManager.renderer instanceof r.BatchedRenderer){null==t.rendererManager.renderer.composer&&t.rendererManager.renderer._createComposer();var i=t.rendererManager.renderer.composer;if(null==e)return i.ssaoEffectOpt();i.ssaoEffectOpt(e)}}createAreaInfo(e,t){var i=new r.AreaInfo(e);return i.checkRoomBoundary(t)?i:null}createAreaInfoWithHoles(e,t,i){var a=new r.AreaInfo(e);return a.checkRoomBoundaryWithHoles(t,i)?a:null}enableBlinkComponents(e){this.modelManager.blinkManager.isBlinkPermited()||(this.modelManager.blinkManager.enableBlink(e),this.render())}setBlinkComponentsById(e,t,i){this.modelManager.blinkManager.isBlinkPermited()||this.modelManager.sceneState.setBlinkComponentsById(e,t,i)}addBlinkComponentsById(e,t,i){this.modelManager.blinkManager.isBlinkPermited()||this.modelManager.sceneState.addBlinkComponentsById(e,t,i)}addBlinkComponentsByDetail(e,t,i,r){this.modelManager.blinkManager.isBlinkPermited()||this.modelManager.sceneState.addBlinkComponentsByDetail(e,t,i,r)}clearBlinkComponentsById(e,t){this.modelManager.blinkManager.isBlinkPermited()||this.modelManager.sceneState.clearBlinkComponentsById(e,t)}clearBlinkComponentsByDetail(e){this.modelManager.blinkManager.isBlinkPermited()||this.modelManager.sceneState.clearBlinkComponentsByDetail(e)}enableBlinkComponentsByDetail(e,t){this.modelManager.blinkManager.isBlinkPermited()||this.modelManager.sceneState.enableBlinkComponentsByDetail(e,t)}clearAllBlinkComponents(e){this.modelManager.blinkManager.isBlinkPermited()||this.modelManager.sceneState.clearAllBlinkComponents(e)}getBlinkComponents(e){return this.modelManager.blinkManager.isBlinkPermited()?null:this.modelManager.sceneState.getBlinkComponents(e)}setBlinkColor(e,t){this.modelManager.blinkManager.isBlinkPermited()||this.modelManager.blinkManager.setBlinkColor(e.color,e.opacity,t)}setBlinkIntervalTime(e,t){this.modelManager.blinkManager.isBlinkPermited()||this.modelManager.blinkManager.setBlinkIntervalTime(e,t)}enableSnap(e){this.editorManager.getToolByName("pickByRect").enableSnap(e)}pickToPoint(e,t){return this.editorManager.editor.pickHelper.pickToPoint(e,t)}getViewportSize(){return this.rendererManager.getRendererSize()}getRenderer(){return this.rendererManager.getRenderer()}getModelManager(){return this.modelManager}getReceivingPlane(){return this.getScene().getReceivingPlane()}enableShadow(e){var t=e?4:3;t!=r.GlobalData.LightPreset&&(this.setLightPreset(t),this.enableShadowForObjects(e))}enableShadowForObjects(e){let t=this.getScene();e?t.lightManager.shadowLightNum++:t.lightManager.shadowLightNum--;let i=this.getRenderer();if(i.shadowMap.needsUpdate=!0,(!(t.lightManager.shadowLightNum>0)||e)&&r.GlobalData.EnableShadowMap!=e){r.GlobalData.EnableShadowMap=e,i.shadowMap.enabled=e,i.shadowMap.type=THREE.PCFSoftShadowMap,i.shadowMap.autoUpdate=!1;for(var a=this.getScene().getObjectGroups(),n=0;n<a.length;n++){var s=t.getObjectGroupType(a[n].name);if(s.groupType!=r.ObjectGroupType.IBLCUBE){var o,l=!0,d=!0;s.databagId?o=this.modelManager.getModel(s.databagId):s.groupType==r.GlobalData.TilePlaneGroupName&&(o=this.modelManager.getModel(r.ObjectGroupType.TILEGROUP)),o&&(l=o.castShadow,d=o.receiveShadow),this.traverseGroupEnableShadow(a[n],l,d)}}}}traverseGroupEnableShadow(e,t,i){var a=this;!function(e){if(e instanceof THREE.Mesh){var n=e.material;if(n instanceof Array){if("PhongLightingMaterial"==n[0].type)return;e.castShadow=n[0].opacity>.8&&t,e.receiveShadow=i;for(var s=0;s<n.length;s++)n[s]&&(n[s].needsUpdate=!0,o=n[s].defines);r.GlobalData.EnableShadowMap&&o&&o.hasOwnProperty("USE_INSTANCE")&&(e.customDepthMaterial=a.getInstanceDepthMaterial())}else{if("PhongLightingMaterial"==n.type)return;e.castShadow=n.opacity>.8&&t,e.receiveShadow=i,n.needsUpdate=!0;var o=n.defines;r.GlobalData.EnableShadowMap&&o&&o.hasOwnProperty("USE_INSTANCE")&&(e.customDepthMaterial=a.getInstanceDepthMaterial())}}}(e);for(var n=e.children,s=0,o=n.length;s<o;s++)this.traverseGroupEnableShadow(n[s],t,i)}getInstanceDepthMaterial(){return this.modelManager.getInstanceDepthMaterial()}updateShadowMap(){r.GlobalData.EnableShadowMap&&(this.getRenderer().shadowMap.needsUpdate=!0)}enableVR(e){this.rendererManager.enableVR(e)}enableDamping(e){(e=r.Utils.defaultValue(e,!1))?this.cameraControl.enableDamping():this.cameraControl.disableDamping()}setDampingFactor(e){(e=r.Utils.defaultValue(e,10))>=10&&(e=10),e<=1&&(e=1),e=11-e,this.cameraControl.dynamicDampingFactor(e/10)}calcShadowDirection(e,t){var i=r.JulianDate.fromDate(t),a=r.GIS.Transforms.computeTemeToPseudoFixedMatrix(i),n=r.Simon1994PlanetaryPositions.computeSunPositionInEarthInertialFrame(i);n.applyMatrix3(a);var s=r.Tile.TileMath.fromDegrees(e[0],e[1],0),o=r.GIS.Transforms.eastNorthUpToFixedFrame(s);o.invert();var l=new THREE.Vector4(n.x,n.y,n.z,1);l.applyMatrix4(o);var d=new THREE.Vector3;return d.set(l.x,l.y,l.z),d.normalize(),(d=this.worldToDrawing(d)).normalize(),d}getMaterialsByComponentId(e,t){const i=this.getModelManager().getModel(e),r=i.getFilter()._getOverrideMaterialById(t);if(r)return[r];const a=i.getNodeInfosByUserId(t);let n={};for(let e=0,t=a.length;e<t;e++){const t=a[e].materialId;if(n[t])continue;let r=i.getMaterialByMaterialId(t,a[e]);r&&(n[t]=r.clone(),n[t].name=n[t].name.toString())}return Object.values(n)}cloneModel(e,t){const i=this.getModelManager().getModel(e);return r.Utils.isDefined(i)?i.clone({modelId:t}):(console.log(`can not find model with id ${e}`),null)}getHeightLimitManager(){return this.heightLimitManager||(this.heightLimitManager=new r.HeightLimitManager(this)),this.heightLimitManager}getClipCapsManager(){return this.clipCapsManager||(this.clipCapsManager=new r.ClipCapsManager(this)),this.clipCapsManager}enableEmbeddedView(e){null!=this.scissorViewportManager&&(e?this.scissorViewportManager.show():this.scissorViewportManager.hide())}setEmbeddedView(e){null!=this.scissorViewportManager&&this.scissorViewportManager.effectOpt(e)}setSceneUnit(e){this.modelManager.setSceneUnit(e)}getSceneUnit(){return this.modelManager.getSceneUnit()}getClientSize(){var e=this.domElement===document?this.domElement.body:this.domElement;return this.clientSize.set(e.clientWidth,e.clientHeight),this.clientSize}enableOIT(e){this.webgl2Support&&(this.rendererManager.enableOIT(e),this.rendererManager._isSupportOIT()?this.modelManager.updateAlphaMapProperties(!0):this.modelManager.updateAlphaMapProperties(!1))}enableOITAlphaMask(e){this.rendererManager.enableOITAlphaMask(e)}setOITCustomizedAlpha(e){this.rendererManager.setOITCustomizedAlpha(e)}restoreMaterialByMaterialId(e,t){let i=this.modelManager.getModel(e).materialManager,r=i.materialIdMap;if(!r)return!1;let a=r[t];if(null==a)return!1;let n=i.materials[a];i.restoreMaterialParam(n);let s=i.instanceMaterials[a];if(!s)return!0;for(let e=0;e<s.length;e++)i.restoreMaterialParam(s[e]);return!0}overrideMaterialByMaterialId(e,t,i,r){function a(e){if(n.storeMaterialParam(e),i.diffuse_color){var t=i.diffuse_color.split(",");e.color.setRGB(parseFloat(t[0]),parseFloat(t[1]),parseFloat(t[2])),e.opacity=parseFloat(t[3])}var a=e.opacity<1;e.transparent=a,e.map=r,e.needsUpdate=!0}let n=this.modelManager.getModel(e).materialManager,s=n.materialIdMap[t];if(null==s)return!1;a(n.materials[s]);let o=n.instanceMaterials[s];if(!o)return!0;for(let e=0;e<o.length;e++)a(o[e]);return!0}loadMaterialIds(e,t,i){let a=this.modelManager.getModel(e);if(!(a instanceof r.Model))return console.log("ERROR:only support BMD now"),void(i&&i());let n=a.materialManager.materialIdMap;n?t&&t(Object.keys(n)):a._getHandler().loader._loadMaterialId(t,i)}setSelectionByMaterialId(e,t){let i=this;this.loadMaterialIds(e,(function(r){let a=i.modelManager.getModel(e),n=a.materialManager.materialIdMap[t];i.clearSelection();let s=i.rendererManager.getPickingEffecter();if(null!=n){if(!a.materialIdUserIdMap){let e=a.getAllNodeInfos(),t=Object.keys(e),i={};for(let r=0;r<t.length;r++){let a=e[t[r]],n={};for(let e=0;e<a.length;e++){let t=a[e].materialId;n[t]||(n[t]=!0,i[t]||(i[t]=[]),i[t].push(a[e].userId))}}a.materialIdUserIdMap=i}s.selectedMaterialId=n,i.addToSelection(a.materialIdUserIdMap[n])}else s.selectedMaterialId=void 0}))}hasBimtilesModel(){if(void 0!==this.hasBimtile)return this.hasBimtile;return this.modelManager.traverseModels(void 0,(e=>{e instanceof r.BimTilesModel&&(this.hasBimtile=!0)})),this.hasBimtile}setFoveatedConePriorityEnabled(e){this._foveatedConeLimit.priorityEnabled=e}setDegradedFactor(e){this._foveatedConeLimit.degradedFactor=r.Math.clamp(e,0,1)}setFoveatedConeFactor(e){this._foveatedConeLimit.foveatedConeFactor=r.Math.clamp(e,0,1)}setFoveatedSseRelaxation(e){this._foveatedConeLimit.foveatedSseRelaxation=e}getComponentsByRaycaster(e,t,i){e=new THREE.Vector3(e.x,e.y,e.z),t=new THREE.Vector3(t.x,t.y,t.z);const a=this.worldToDrawing(e),n=this.worldToDrawing(t).normalize(),s=new r.Raycaster(a,n),o=new r.IntersectHelper(this),l=this.cameraControl.getIntersectContext(null);s.viewportSize=l.viewportSize,s.camera=l.camera;const d=o.getObjectsByRaycaster(l,s,!0);let h=[];const c=this.getFilter();for(const t of d){const a=this.drawingToWorld(t.point);let n={id:t.userId,modelId:t.modelId,distance:e.distanceTo(a),position:a,normal:t.face?t.face.normal:void 0};const s=t.modelId;if(!r.Utils.defined(s)){n.isMap=!0,h.push(n);continue}let o=this.getUserdataByUserId(t.userId,s);null===o&&(o={}),o.modelId=s,o.userId=t.userId;const l=i.length;let d=[];for(let e=0;e<l;e++){const t=i[e];t.modelId&&t.modelId!==s||(t.modelId&&1===Object.keys(t)||d.push(Object.assign({},t)))}0===d.length&&0!==l||c.isMatchConditions(o,d,s)&&h.push(n)}return h}getComponentsByRaycasterConditions(e,t,i){const a=this.getComponentsByRaycaster(e,t,[]),n=this.getFilter();let s=[];for(const e of a){const t=e.modelId;if(!r.Utils.defined(t)){e.isMap=!0,s.push(e);continue}const a=e.id;let o=this.getUserdataByUserId(a,t);null===o&&(o={});let l=!1;for(const e of i)if(t==e.modelId){if(void 0===e.userId&&void 0===e.objectData){l=!0;break}if(e.userId&&e.userId.indexOf(a)>-1){l=!0;break}if(e.objectData&&n.isMatchConditions(o,e.objectData,t)){l=!0;break}}!0!==l&&0!==i.length||s.push(e)}return s}setShowTileType(e){e!=this.showTileType&&(this.showTileType=e,this.render())}getAllModelUserIds(){let e={};return this.modelManager.traverseValidModels((t=>{if(!t.getFilter())return;const i=t.getAllUserIds();e[t.id]=i})),e}_enableStopUpdateScene(e){this.inputStatusMonitor.enableStopUpdateScene(e)}getTerrainHeightRange(){return this.getScene().getTerrainHeightRange()}getSceneHeightRangeWorld(){const e=this.getBoundingBoxWorld();return{max:e.max.z,min:e.min.z}}getSceneHeightRange(){const e=this.getBoundingBox();return{max:e.max.y,min:e.min.y}}}})()}();